<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Fixed obscure miscalculation when a client is closed. - tabbed - tab interface for application supporting Xembed
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="tabbed Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>tabbed</h1><span class="desc">tab interface for application supporting Xembed
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/14beaabe6ccbdf12546f31edf931e30cbe9c0c82.html">14beaabe6ccbdf12546f31edf931e30cbe9c0c82</a>
<b>parent</b> <a href="../commit/361ddc85d506c058562ccba7c68370d49733c928.html">361ddc85d506c058562ccba7c68370d49733c928</a>
<b>Author:</b> Alexander Sedov &lt;<a href="mailto:alex0player@gmail.com">alex0player@gmail.com</a>&gt;
<b>Date:</b>   Mon, 29 Jul 2013 11:11:33 +0400

Fixed obscure miscalculation when a client is closed.

This crops up whenever you just switched from tab # N+1 to tab # N
and close current tab. unmanage() first decreases lastsel
(so it becomes N) then erroneously tests it against sel and focuses first tab
instead. One can see that focus() would never set lastsel == sel,
so I took liberty to fix this annoying behaviour which happens to frequently
with newposition = 0 and npisrelative = True settings.

Signed-off-by: Christoph Lohmann &lt;20h@r-36.net&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">tabbed.c</a></td><td> | </td><td class="num">16</td><td><span class="i">+++++++++++++</span><span class="d">---</span></td></tr>
</table></pre><pre>1 file changed, 13 insertions(+), 3 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/tabbed.c.html">tabbed.c</a> b/<a href="../file/tabbed.c.html">tabbed.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -171,12 +171,18 @@ void
</a> buttonpress(const XEvent *e) {
 	const XButtonPressedEvent *ev = &amp;e-&gt;xbutton;
 	int i;
<a href="#h0-0-3" id="h0-0-3" class="i">+	int fc;
</a> 	Arg arg;
 
<a href="#h0-0-6" id="h0-0-6" class="d">-	if((getfirsttab() != 0 &amp;&amp; ev-&gt;x &lt; TEXTW(before)) || ev-&gt;x &lt; 0)
</a><a href="#h0-0-7" id="h0-0-7" class="i">+	fc = getfirsttab();
</a><a href="#h0-0-8" id="h0-0-8" class="i">+
</a><a href="#h0-0-9" id="h0-0-9" class="i">+	if((fc &gt; 0 &amp;&amp; ev-&gt;x &lt; TEXTW(before)) || ev-&gt;x &lt; 0)
</a> 		return;
 
<a href="#h0-0-12" id="h0-0-12" class="d">-	for(i = 0; i &lt; nclients; i++) {
</a><a href="#h0-0-13" id="h0-0-13" class="i">+	if(ev-&gt;y &lt; 0 || ev-&gt; y &gt; bh)
</a><a href="#h0-0-14" id="h0-0-14" class="i">+		return;
</a><a href="#h0-0-15" id="h0-0-15" class="i">+
</a><a href="#h0-0-16" id="h0-0-16" class="i">+	for(i = (fc &gt; 0) ? fc : 0; i &lt; nclients; i++) {
</a> 		if(clients[i]-&gt;tabx &gt; ev-&gt;x) {
 			switch(ev-&gt;button) {
 			case Button1:
<a href="#h0-1" id="h0-1" class="h">@@ -1053,7 +1059,11 @@ unmanage(int c) {
</a> 		}
 
 		if(c == sel) {
<a href="#h0-1-3" id="h0-1-3" class="d">-			if(lastsel &gt; 0 &amp;&amp; lastsel != sel) {
</a><a href="#h0-1-4" id="h0-1-4" class="i">+			/* Note that focus() will never set lastsel == sel,
</a><a href="#h0-1-5" id="h0-1-5" class="i">+			 * so if here lastsel == sel, it was decreased by above if() clause
</a><a href="#h0-1-6" id="h0-1-6" class="i">+			 * and was actually (sel + 1) before.
</a><a href="#h0-1-7" id="h0-1-7" class="i">+			 */
</a><a href="#h0-1-8" id="h0-1-8" class="i">+			if(lastsel &gt; 0) {
</a> 				focus(lastsel);
 			} else {
 				focus(0);
</pre>
</div>
</body>
</html>
