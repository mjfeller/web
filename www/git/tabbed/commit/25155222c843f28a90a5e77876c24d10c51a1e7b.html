<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>better download handling. - tabbed - tab interface for application supporting Xembed
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="tabbed Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>tabbed</h1><span class="desc">tab interface for application supporting Xembed
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/25155222c843f28a90a5e77876c24d10c51a1e7b.html">25155222c843f28a90a5e77876c24d10c51a1e7b</a>
<b>parent</b> <a href="../commit/a4ca2f7aaddbfe9e03b727156df90fbe3dae0d76.html">a4ca2f7aaddbfe9e03b727156df90fbe3dae0d76</a>
<b>Author:</b> Enno Boland (Gottox) &lt;<a href="mailto:gottox@s01.de">gottox@s01.de</a>&gt;
<b>Date:</b>   Mon,  8 Jun 2009 16:34:46 +0200

better download handling.
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">config.mk</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">surf.c</a></td><td> | </td><td class="num">144</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------</span></td></tr>
</table></pre><pre>2 files changed, 89 insertions(+), 63 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config.mk.html">config.mk</a> b/<a href="../file/config.mk.html">config.mk</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -17,10 +17,10 @@ LIBS = -L/usr/lib -lc ${GTKLIB}
</a> 
 # flags
 CPPFLAGS = -DVERSION=\&quot;${VERSION}\&quot;
<a href="#h0-0-3" id="h0-0-3" class="d">-CFLAGS = -std=c99 -pedantic -Wall -Os ${INCS} ${CPPFLAGS}
</a><a href="#h0-0-4" id="h0-0-4" class="d">-#CFLAGS = -std=c99 -pedantic -Wall -O0 ${INCS} ${CPPFLAGS}
</a><a href="#h0-0-5" id="h0-0-5" class="d">-LDFLAGS = -s ${LIBS}
</a><a href="#h0-0-6" id="h0-0-6" class="d">-#LDFLAGS = ${LIBS}
</a><a href="#h0-0-7" id="h0-0-7" class="i">+#CFLAGS = -std=c99 -pedantic -Wall -Os ${INCS} ${CPPFLAGS}
</a><a href="#h0-0-8" id="h0-0-8" class="i">+CFLAGS = -std=c99 -pedantic -Wall -O0 ${INCS} ${CPPFLAGS}
</a><a href="#h0-0-9" id="h0-0-9" class="i">+#LDFLAGS = -s ${LIBS}
</a><a href="#h0-0-10" id="h0-0-10" class="i">+LDFLAGS = ${LIBS}
</a> 
 # Solaris
 #CFLAGS = -fast ${INCS} -DVERSION=\&quot;${VERSION}\&quot;
<b>diff --git a/<a id="h1" href="../file/surf.c.html">surf.c</a> b/<a href="../file/surf.c.html">surf.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -21,15 +21,15 @@
</a> Display *dpy;
 Atom urlprop;
 typedef struct Client {
<a href="#h1-0-3" id="h1-0-3" class="d">-	GtkWidget *win, *scroll, *vbox, *pbar, *urlbar, *searchbar;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+	GtkWidget *win, *scroll, *vbox, *urlbar, *searchbar;
</a> 	WebKitWebView *view;
<a href="#h1-0-6" id="h1-0-6" class="i">+	WebKitDownload *download;
</a> 	gchar *title;
 	gint progress;
 	struct Client *next;
 } Client;
 SoupCookieJar *cookiejar;
 Client *clients = NULL;
<a href="#h1-0-13" id="h1-0-13" class="d">-GSList *downloads = NULL;
</a> gboolean embed = FALSE;
 gboolean showxid = FALSE;
 gboolean ignore_once = FALSE;
<a href="#h1-1" id="h1-1" class="h">@@ -48,8 +48,9 @@ static void hideurl(Client *c);
</a> static gboolean keypress(GtkWidget* w, GdkEventKey *ev, gpointer d);
 static void linkhover(WebKitWebView* page, const gchar* t, const gchar* l, gpointer d);
 static void loadcommit(WebKitWebView *view, WebKitWebFrame *f, gpointer d);
<a href="#h1-1-3" id="h1-1-3" class="d">-static void loadfile(const Client *c, const gchar *f);
</a><a href="#h1-1-4" id="h1-1-4" class="d">-static void loaduri(const Client *c, const gchar *uri);
</a><a href="#h1-1-5" id="h1-1-5" class="i">+static void loadstart(WebKitWebView *view, WebKitWebFrame *f, gpointer d);
</a><a href="#h1-1-6" id="h1-1-6" class="i">+static void loadfile(Client *c, const gchar *f);
</a><a href="#h1-1-7" id="h1-1-7" class="i">+static void loaduri(Client *c, const gchar *uri);
</a> static Client *newclient();
 static WebKitWebView *newwindow(WebKitWebView  *v, WebKitWebFrame *f, gpointer d);
 static void progresschange(WebKitWebView *view, gint p, gpointer d);
<a href="#h1-2" id="h1-2" class="h">@@ -57,14 +58,14 @@ static GdkFilterReturn processx(GdkXEvent *xevent, GdkEvent *event, gpointer dat
</a> static void setup(void);
 static void showsearch(Client *c);
 static void showurl(Client *c);
<a href="#h1-2-3" id="h1-2-3" class="i">+static void stop(Client *c);
</a> static void titlechange(WebKitWebView* view, WebKitWebFrame* frame, const gchar* title, gpointer d);
<a href="#h1-2-5" id="h1-2-5" class="d">-static void updatetitle(Client *c);
</a><a href="#h1-2-6" id="h1-2-6" class="i">+static void updatetitle(Client *c, const gchar *title);
</a> 
 void
 cleanup(void) {
 	while(clients)
 		destroyclient(clients);
<a href="#h1-2-12" id="h1-2-12" class="d">-	g_slist_free(downloads);
</a> }
 
 void
<a href="#h1-3" id="h1-3" class="h">@@ -74,7 +75,6 @@ destroyclient(Client *c) {
</a> 	gtk_widget_destroy(GTK_WIDGET(webkit_web_view_new()));
 	gtk_widget_destroy(c-&gt;scroll);
 	gtk_widget_destroy(c-&gt;urlbar);
<a href="#h1-3-3" id="h1-3-3" class="d">-	gtk_widget_destroy(c-&gt;pbar);
</a> 	gtk_widget_destroy(c-&gt;searchbar);
 	gtk_widget_destroy(c-&gt;vbox);
 	gtk_widget_destroy(c-&gt;win);
<a href="#h1-4" id="h1-4" class="h">@@ -103,50 +103,44 @@ void die(char *str) {
</a> void
 download(WebKitDownload *o, GParamSpec *pspec, gpointer d) {
 	Client *c = (Client *) d;
<a href="#h1-4-3" id="h1-4-3" class="d">-	GSList *i;
</a><a href="#h1-4-4" id="h1-4-4" class="d">-	WebKitDownload *dl;
</a><a href="#h1-4-5" id="h1-4-5" class="d">-	GString *text;
</a><a href="#h1-4-6" id="h1-4-6" class="d">-	
</a><a href="#h1-4-7" id="h1-4-7" class="d">-	text = g_string_new(&quot;&quot;);
</a><a href="#h1-4-8" id="h1-4-8" class="d">-	for (i = downloads; i != NULL; i = i-&gt;next) {
</a><a href="#h1-4-9" id="h1-4-9" class="d">-		dl = i-&gt;data;
</a><a href="#h1-4-10" id="h1-4-10" class="d">-		if (webkit_download_get_status(dl) == WEBKIT_DOWNLOAD_STATUS_STARTED
</a><a href="#h1-4-11" id="h1-4-11" class="d">-		|| webkit_download_get_status(dl) == WEBKIT_DOWNLOAD_STATUS_CREATED) {
</a><a href="#h1-4-12" id="h1-4-12" class="d">-			g_string_append_printf(text, &quot;%s[%.0f%%] &quot;,
</a><a href="#h1-4-13" id="h1-4-13" class="d">-			webkit_download_get_suggested_filename(dl),
</a><a href="#h1-4-14" id="h1-4-14" class="d">-			webkit_download_get_progress(dl)*100);
</a><a href="#h1-4-15" id="h1-4-15" class="d">-		} else {
</a><a href="#h1-4-16" id="h1-4-16" class="d">-			downloads = g_slist_remove(downloads, dl);
</a><a href="#h1-4-17" id="h1-4-17" class="d">-		}
</a><a href="#h1-4-18" id="h1-4-18" class="i">+	WebKitDownloadStatus status;
</a><a href="#h1-4-19" id="h1-4-19" class="i">+
</a><a href="#h1-4-20" id="h1-4-20" class="i">+	status = webkit_download_get_status(c-&gt;download);
</a><a href="#h1-4-21" id="h1-4-21" class="i">+	if(status == WEBKIT_DOWNLOAD_STATUS_STARTED || status == WEBKIT_DOWNLOAD_STATUS_CREATED) {
</a><a href="#h1-4-22" id="h1-4-22" class="i">+		c-&gt;progress = (int)(webkit_download_get_progress(c-&gt;download)*100);
</a> 	}
<a href="#h1-4-24" id="h1-4-24" class="d">-	if (downloads == NULL) {
</a><a href="#h1-4-25" id="h1-4-25" class="d">-		gtk_label_set_text((GtkLabel *) c-&gt;pbar, &quot;&quot;);
</a><a href="#h1-4-26" id="h1-4-26" class="d">-		gtk_widget_hide(c-&gt;pbar);
</a><a href="#h1-4-27" id="h1-4-27" class="d">-	} else {
</a><a href="#h1-4-28" id="h1-4-28" class="d">-		gtk_label_set_text((GtkLabel *) c-&gt;pbar, text-&gt;str);
</a><a href="#h1-4-29" id="h1-4-29" class="i">+	else {
</a><a href="#h1-4-30" id="h1-4-30" class="i">+		stop(c);
</a> 	}
<a href="#h1-4-32" id="h1-4-32" class="d">-	g_string_free(text, TRUE);
</a><a href="#h1-4-33" id="h1-4-33" class="i">+	updatetitle(c, NULL);
</a> }
 
 gboolean
 initdownload(WebKitWebView *view, WebKitDownload *o, gpointer d) {
<a href="#h1-4-38" id="h1-4-38" class="d">-	/* TODO */
</a> 	Client *c = (Client *) d;
<a href="#h1-4-40" id="h1-4-40" class="d">-	const gchar *home;
</a><a href="#h1-4-41" id="h1-4-41" class="d">-	gchar *uri, *filename;
</a><a href="#h1-4-42" id="h1-4-42" class="i">+	const gchar *home, *filename;
</a><a href="#h1-4-43" id="h1-4-43" class="i">+	gchar *uri, *path;
</a><a href="#h1-4-44" id="h1-4-44" class="i">+	GString *html = g_string_new(&quot;&quot;);
</a> 
<a href="#h1-4-46" id="h1-4-46" class="i">+	stop(c);
</a><a href="#h1-4-47" id="h1-4-47" class="i">+	c-&gt;download = o;
</a> 	home = g_get_home_dir();
<a href="#h1-4-49" id="h1-4-49" class="d">-	filename = g_build_filename(home, &quot;.surf&quot;, &quot;dl&quot;, 
</a><a href="#h1-4-50" id="h1-4-50" class="d">-			webkit_download_get_suggested_filename(o), NULL);
</a><a href="#h1-4-51" id="h1-4-51" class="d">-	uri = g_strconcat(&quot;file://&quot;, filename, NULL);
</a><a href="#h1-4-52" id="h1-4-52" class="d">-	webkit_download_set_destination_uri(o, uri);
</a><a href="#h1-4-53" id="h1-4-53" class="d">-	g_free(filename);
</a><a href="#h1-4-54" id="h1-4-54" class="i">+	filename = webkit_download_get_suggested_filename(o);
</a><a href="#h1-4-55" id="h1-4-55" class="i">+	path = g_build_filename(home, &quot;.surf&quot;, &quot;dl&quot;, 
</a><a href="#h1-4-56" id="h1-4-56" class="i">+			filename, NULL);
</a><a href="#h1-4-57" id="h1-4-57" class="i">+	uri = g_strconcat(&quot;file://&quot;, path, NULL);
</a><a href="#h1-4-58" id="h1-4-58" class="i">+	webkit_download_set_destination_uri(c-&gt;download, uri);
</a><a href="#h1-4-59" id="h1-4-59" class="i">+	c-&gt;progress = 0;
</a> 	g_free(uri);
<a href="#h1-4-61" id="h1-4-61" class="d">-	downloads = g_slist_append(downloads, o);
</a><a href="#h1-4-62" id="h1-4-62" class="d">-	gtk_widget_show(c-&gt;pbar);
</a><a href="#h1-4-63" id="h1-4-63" class="d">-	g_signal_connect(o, &quot;notify::progress&quot;, G_CALLBACK(download), d);
</a><a href="#h1-4-64" id="h1-4-64" class="d">-	g_signal_connect(o, &quot;notify::status&quot;, G_CALLBACK(download), d);
</a><a href="#h1-4-65" id="h1-4-65" class="d">-	webkit_download_start(o);
</a><a href="#h1-4-66" id="h1-4-66" class="i">+	html = g_string_append(html, &quot;Downloading &lt;b&gt;&quot;);
</a><a href="#h1-4-67" id="h1-4-67" class="i">+	html = g_string_append(html, filename);
</a><a href="#h1-4-68" id="h1-4-68" class="i">+	html = g_string_append(html, &quot;&lt;/b&gt;...&quot;);
</a><a href="#h1-4-69" id="h1-4-69" class="i">+	webkit_web_view_load_html_string(c-&gt;view, html-&gt;str,
</a><a href="#h1-4-70" id="h1-4-70" class="i">+			webkit_download_get_uri(c-&gt;download));
</a><a href="#h1-4-71" id="h1-4-71" class="i">+	g_signal_connect(c-&gt;download, &quot;notify::progress&quot;, G_CALLBACK(download), c);
</a><a href="#h1-4-72" id="h1-4-72" class="i">+	g_signal_connect(c-&gt;download, &quot;notify::status&quot;, G_CALLBACK(download), c);
</a><a href="#h1-4-73" id="h1-4-73" class="i">+	webkit_download_start(c-&gt;download);
</a><a href="#h1-4-74" id="h1-4-74" class="i">+	updatetitle(c, filename);
</a> 	return TRUE;
 }
 
<a href="#h1-5" id="h1-5" class="h">@@ -191,7 +185,6 @@ keypress(GtkWidget* w, GdkEventKey *ev, gpointer d) {
</a> 			return TRUE;
 		case GDK_Left:
 		case GDK_Right:
<a href="#h1-5-3" id="h1-5-3" class="d">-		case GDK_r:
</a> 			return FALSE;
 		}
 	}
<a href="#h1-6" id="h1-6" class="h">@@ -206,7 +199,6 @@ keypress(GtkWidget* w, GdkEventKey *ev, gpointer d) {
</a> 			return TRUE;
 		case GDK_Left:
 		case GDK_Right:
<a href="#h1-6-3" id="h1-6-3" class="d">-		case GDK_r:
</a> 			return FALSE;
 		}
 	}
<a href="#h1-7" id="h1-7" class="h">@@ -227,6 +219,14 @@ keypress(GtkWidget* w, GdkEventKey *ev, gpointer d) {
</a> 		case GDK_slash:
 			showsearch(c);
 			return TRUE;
<a href="#h1-7-3" id="h1-7-3" class="i">+		case GDK_n:
</a><a href="#h1-7-4" id="h1-7-4" class="i">+		case GDK_N:
</a><a href="#h1-7-5" id="h1-7-5" class="i">+			webkit_web_view_search_text(c-&gt;view,
</a><a href="#h1-7-6" id="h1-7-6" class="i">+					gtk_entry_get_text(GTK_ENTRY(c-&gt;searchbar)),
</a><a href="#h1-7-7" id="h1-7-7" class="i">+					FALSE,
</a><a href="#h1-7-8" id="h1-7-8" class="i">+					!(ev-&gt;state &amp; GDK_SHIFT_MASK),
</a><a href="#h1-7-9" id="h1-7-9" class="i">+					TRUE);
</a><a href="#h1-7-10" id="h1-7-10" class="i">+			return TRUE;
</a> 		case GDK_Left:
 			webkit_web_view_go_back(c-&gt;view);
 			return TRUE;
<a href="#h1-8" id="h1-8" class="h">@@ -235,6 +235,13 @@ keypress(GtkWidget* w, GdkEventKey *ev, gpointer d) {
</a> 			return TRUE;
 		}
 	}
<a href="#h1-8-3" id="h1-8-3" class="i">+	else {
</a><a href="#h1-8-4" id="h1-8-4" class="i">+		switch(ev-&gt;keyval) {
</a><a href="#h1-8-5" id="h1-8-5" class="i">+		case GDK_Escape:
</a><a href="#h1-8-6" id="h1-8-6" class="i">+			stop(c);
</a><a href="#h1-8-7" id="h1-8-7" class="i">+			return TRUE;
</a><a href="#h1-8-8" id="h1-8-8" class="i">+		}
</a><a href="#h1-8-9" id="h1-8-9" class="i">+	}
</a> 	return FALSE;
 }
 
<a href="#h1-9" id="h1-9" class="h">@@ -245,7 +252,7 @@ linkhover(WebKitWebView* page, const gchar* t, const gchar* l, gpointer d) {
</a> 	if(l)
 		gtk_window_set_title(GTK_WINDOW(c-&gt;win), l);
 	else
<a href="#h1-9-3" id="h1-9-3" class="d">-		updatetitle(c);
</a><a href="#h1-9-4" id="h1-9-4" class="i">+		updatetitle(c, NULL);
</a> }
 
 void
<a href="#h1-10" id="h1-10" class="h">@@ -261,7 +268,16 @@ loadcommit(WebKitWebView *view, WebKitWebFrame *f, gpointer d) {
</a> }
 
 void
<a href="#h1-10-3" id="h1-10-3" class="d">-loadfile(const Client *c, const gchar *f) {
</a><a href="#h1-10-4" id="h1-10-4" class="i">+loadstart(WebKitWebView *view, WebKitWebFrame *f, gpointer d) {
</a><a href="#h1-10-5" id="h1-10-5" class="i">+	Client *c = (Client *)d;
</a><a href="#h1-10-6" id="h1-10-6" class="i">+	gchar *uri;
</a><a href="#h1-10-7" id="h1-10-7" class="i">+
</a><a href="#h1-10-8" id="h1-10-8" class="i">+	if(c-&gt;download)
</a><a href="#h1-10-9" id="h1-10-9" class="i">+		stop(c);
</a><a href="#h1-10-10" id="h1-10-10" class="i">+}
</a><a href="#h1-10-11" id="h1-10-11" class="i">+
</a><a href="#h1-10-12" id="h1-10-12" class="i">+void
</a><a href="#h1-10-13" id="h1-10-13" class="i">+loadfile(Client *c, const gchar *f) {
</a> 	GIOChannel *chan = NULL;
 	GError *e = NULL;
 	GString *code = g_string_new(&quot;&quot;);
<a href="#h1-11" id="h1-11" class="h">@@ -285,15 +301,17 @@ loadfile(const Client *c, const gchar *f) {
</a> 		g_string_prepend(uri, &quot;file://&quot;);
 		loaduri(c, uri-&gt;str);
 	}
<a href="#h1-11-3" id="h1-11-3" class="d">-
</a><a href="#h1-11-4" id="h1-11-4" class="i">+	updatetitle(c, uri-&gt;str);
</a> }
 
 void
<a href="#h1-11-8" id="h1-11-8" class="d">-loaduri(const Client *c, const gchar *uri) {
</a><a href="#h1-11-9" id="h1-11-9" class="i">+loaduri(Client *c, const gchar *uri) {
</a> 	GString* u = g_string_new(uri);
 	if(g_strrstr(u-&gt;str, &quot;:&quot;) == NULL)
 		g_string_prepend(u, &quot;http://&quot;);
 	webkit_web_view_load_uri(c-&gt;view, u-&gt;str);
<a href="#h1-11-14" id="h1-11-14" class="i">+	c-&gt;progress = 0;
</a><a href="#h1-11-15" id="h1-11-15" class="i">+	updatetitle(c, u-&gt;str);
</a> 	g_string_free(u, TRUE);
 }
 
<a href="#h1-12" id="h1-12" class="h">@@ -313,6 +331,7 @@ newclient(void) {
</a> 	gtk_window_set_default_size(GTK_WINDOW(c-&gt;win), 800, 600);
 	g_signal_connect(G_OBJECT(c-&gt;win), &quot;destroy&quot;, G_CALLBACK(destroywin), c);
 	g_signal_connect(G_OBJECT(c-&gt;win), &quot;key-press-event&quot;, G_CALLBACK(keypress), c);
<a href="#h1-12-3" id="h1-12-3" class="i">+	c-&gt;download = NULL;
</a> 
 	/* VBox */
 	c-&gt;vbox = gtk_vbox_new(FALSE, 0);
<a href="#h1-13" id="h1-13" class="h">@@ -327,6 +346,7 @@ newclient(void) {
</a> 	g_signal_connect(G_OBJECT(c-&gt;view), &quot;title-changed&quot;, G_CALLBACK(titlechange), c);
 	g_signal_connect(G_OBJECT(c-&gt;view), &quot;load-progress-changed&quot;, G_CALLBACK(progresschange), c);
 	g_signal_connect(G_OBJECT(c-&gt;view), &quot;load-committed&quot;, G_CALLBACK(loadcommit), c);
<a href="#h1-13-3" id="h1-13-3" class="i">+	g_signal_connect(G_OBJECT(c-&gt;view), &quot;load-started&quot;, G_CALLBACK(loadstart), c);
</a> 	g_signal_connect(G_OBJECT(c-&gt;view), &quot;hovering-over-link&quot;, G_CALLBACK(linkhover), c);
 	g_signal_connect(G_OBJECT(c-&gt;view), &quot;create-web-view&quot;, G_CALLBACK(newwindow), c);
 	g_signal_connect(G_OBJECT(c-&gt;view), &quot;download-requested&quot;, G_CALLBACK(initdownload), c);
<a href="#h1-14" id="h1-14" class="h">@@ -340,7 +360,6 @@ newclient(void) {
</a> 	gtk_entry_set_has_frame(GTK_ENTRY(c-&gt;searchbar), FALSE);
 
 	/* downloadbar */
<a href="#h1-14-3" id="h1-14-3" class="d">-	c-&gt;pbar = gtk_label_new(&quot;&quot;);
</a> 
 	/* Arranging */
 	gtk_container_add(GTK_CONTAINER(c-&gt;scroll), GTK_WIDGET(c-&gt;view));
<a href="#h1-15" id="h1-15" class="h">@@ -348,17 +367,14 @@ newclient(void) {
</a> 	gtk_container_add(GTK_CONTAINER(c-&gt;vbox), c-&gt;scroll);
 	gtk_container_add(GTK_CONTAINER(c-&gt;vbox), c-&gt;searchbar);
 	gtk_container_add(GTK_CONTAINER(c-&gt;vbox), c-&gt;urlbar);
<a href="#h1-15-3" id="h1-15-3" class="d">-	gtk_container_add(GTK_CONTAINER(c-&gt;vbox), c-&gt;pbar);
</a> 
 	/* Setup */
 	gtk_box_set_child_packing(GTK_BOX(c-&gt;vbox), c-&gt;urlbar, FALSE, FALSE, 0, GTK_PACK_START);
 	gtk_box_set_child_packing(GTK_BOX(c-&gt;vbox), c-&gt;searchbar, FALSE, FALSE, 0, GTK_PACK_START);
<a href="#h1-15-8" id="h1-15-8" class="d">-	gtk_box_set_child_packing(GTK_BOX(c-&gt;vbox), c-&gt;pbar, FALSE, FALSE, 0, GTK_PACK_START);
</a> 	gtk_box_set_child_packing(GTK_BOX(c-&gt;vbox), c-&gt;scroll, TRUE, TRUE, 0, GTK_PACK_START);
 	gtk_widget_grab_focus(GTK_WIDGET(c-&gt;view));
 	gtk_widget_hide_all(c-&gt;searchbar);
 	gtk_widget_hide_all(c-&gt;urlbar);
<a href="#h1-15-13" id="h1-15-13" class="d">-	gtk_widget_hide_all(c-&gt;pbar);
</a> 	gtk_widget_show(c-&gt;vbox);
 	gtk_widget_show(c-&gt;scroll);
 	gtk_widget_show(GTK_WIDGET(c-&gt;view));
<a href="#h1-16" id="h1-16" class="h">@@ -383,7 +399,7 @@ progresschange(WebKitWebView* view, gint p, gpointer d) {
</a> 	Client *c = (Client *)d;
 
 	c-&gt;progress = p;
<a href="#h1-16-3" id="h1-16-3" class="d">-	updatetitle(c);
</a><a href="#h1-16-4" id="h1-16-4" class="i">+	updatetitle(c, NULL);
</a> }
 
 GdkFilterReturn
<a href="#h1-17" id="h1-17" class="h">@@ -431,18 +447,30 @@ showurl(Client *c) {
</a> }
 
 void
<a href="#h1-17-3" id="h1-17-3" class="i">+stop(Client *c) {
</a><a href="#h1-17-4" id="h1-17-4" class="i">+	if(c-&gt;download)
</a><a href="#h1-17-5" id="h1-17-5" class="i">+		webkit_download_cancel(c-&gt;download);
</a><a href="#h1-17-6" id="h1-17-6" class="i">+	else
</a><a href="#h1-17-7" id="h1-17-7" class="i">+		webkit_web_view_stop_loading(c-&gt;view);
</a><a href="#h1-17-8" id="h1-17-8" class="i">+	c-&gt;download = NULL;
</a><a href="#h1-17-9" id="h1-17-9" class="i">+}
</a><a href="#h1-17-10" id="h1-17-10" class="i">+
</a><a href="#h1-17-11" id="h1-17-11" class="i">+void
</a> titlechange(WebKitWebView *v, WebKitWebFrame *f, const gchar *t, gpointer d) {
 	Client *c = (Client *)d;
 
<a href="#h1-17-15" id="h1-17-15" class="d">-	if(c-&gt;title)
</a><a href="#h1-17-16" id="h1-17-16" class="d">-		g_free(c-&gt;title);
</a><a href="#h1-17-17" id="h1-17-17" class="d">-	c-&gt;title = g_strdup(t);
</a><a href="#h1-17-18" id="h1-17-18" class="d">-	updatetitle(c);
</a><a href="#h1-17-19" id="h1-17-19" class="i">+	updatetitle(c, t);
</a> }
 
 void
<a href="#h1-17-23" id="h1-17-23" class="d">-updatetitle(Client *c) {
</a><a href="#h1-17-24" id="h1-17-24" class="i">+updatetitle(Client *c, const char *title) {
</a> 	char t[512];
<a href="#h1-17-26" id="h1-17-26" class="i">+
</a><a href="#h1-17-27" id="h1-17-27" class="i">+	if(title) {
</a><a href="#h1-17-28" id="h1-17-28" class="i">+		if(c-&gt;title)
</a><a href="#h1-17-29" id="h1-17-29" class="i">+			g_free(c-&gt;title);
</a><a href="#h1-17-30" id="h1-17-30" class="i">+		c-&gt;title = g_strdup(title);
</a><a href="#h1-17-31" id="h1-17-31" class="i">+	}
</a> 	if(c-&gt;progress == 100)
 		snprintf(t, LENGTH(t), &quot;%s&quot;, c-&gt;title);
 	else
<a href="#h1-18" id="h1-18" class="h">@@ -475,14 +503,12 @@ int main(int argc, char *argv[]) {
</a> 				goto argerr;
 			c = newclient();
 			loaduri(c, uri);
<a href="#h1-18-3" id="h1-18-3" class="d">-			updatetitle(c);
</a> 			break;
 		case &#39;f&#39;:
 			if(!(file = optarg))
 				goto argerr;
 			c = newclient();
 			loadfile(c, file);
<a href="#h1-18-10" id="h1-18-10" class="d">-			updatetitle(c);
</a> 			break;
 		case &#39;v&#39;:
 			die(&quot;surf-&quot;VERSION&quot;, Â© 2009 surf engineers, see LICENSE for details\n&quot;);
</pre>
</div>
</body>
</html>
