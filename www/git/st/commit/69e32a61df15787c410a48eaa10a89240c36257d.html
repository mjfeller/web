<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Move opt_* into same file as main()/run() - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/69e32a61df15787c410a48eaa10a89240c36257d.html">69e32a61df15787c410a48eaa10a89240c36257d</a>
<b>parent</b> <a href="../commit/ed132e11271d18a5d8aa163096bc6192c694bc47.html">ed132e11271d18a5d8aa163096bc6192c694bc47</a>
<b>Author:</b> Devin J. Pohly &lt;<a href="mailto:djpohly@gmail.com">djpohly@gmail.com</a>&gt;
<b>Date:</b>   Thu, 12 Oct 2017 22:25:49 -0500

Move opt_* into same file as main()/run()

This commit is purely about reducing externs and LOC.  If the main and
run functions ever move elsewhere (which will probably make sense
eventually), these should come along with them.

Signed-off-by: Devin J. Pohly &lt;djpohly@gmail.com&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">50</td><td><span class="i">++++++++++++++++++++</span><span class="d">------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">st.h</a></td><td> | </td><td class="num">11</td><td><span class="i">++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">x.c</a></td><td> | </td><td class="num">12</td><td><span class="i">+++++++++++</span><span class="d">-</span></td></tr>
</table></pre><pre>3 files changed, 33 insertions(+), 40 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -48,7 +48,6 @@
</a> 
 /* macros */
 #define NUMMAXLEN(x)		((int)(sizeof(x) * 2.56 + 0.5) + 1)
<a href="#h0-0-3" id="h0-0-3" class="d">-#define DEFAULT(a, b)		(a) = (a) ? (a) : (b)
</a> #define ISCONTROLC0(c)		(BETWEEN(c, 0, 0x1f) || (c) == &#39;\177&#39;)
 #define ISCONTROLC1(c)		(BETWEEN(c, 0x80, 0x9f))
 #define ISCONTROL(c)		(ISCONTROLC0(c) || ISCONTROLC1(c))
<a href="#h0-1" id="h0-1" class="h">@@ -124,8 +123,8 @@ static void sendbreak(const Arg *);
</a> /* config.h for applying patches and the configuration. */
 #include &quot;config.h&quot;
 
<a href="#h0-1-3" id="h0-1-3" class="d">-static void execsh(void);
</a><a href="#h0-1-4" id="h0-1-4" class="d">-static void stty(void);
</a><a href="#h0-1-5" id="h0-1-5" class="i">+static void execsh(char **);
</a><a href="#h0-1-6" id="h0-1-6" class="i">+static void stty(char **);
</a> static void sigchld(int);
 
 static void csidump(void);
<a href="#h0-2" id="h0-2" class="h">@@ -189,14 +188,6 @@ Term term;
</a> Selection sel;
 int cmdfd;
 pid_t pid;
<a href="#h0-2-3" id="h0-2-3" class="d">-char **opt_cmd  = NULL;
</a><a href="#h0-2-4" id="h0-2-4" class="d">-char *opt_class = NULL;
</a><a href="#h0-2-5" id="h0-2-5" class="d">-char *opt_embed = NULL;
</a><a href="#h0-2-6" id="h0-2-6" class="d">-char *opt_font  = NULL;
</a><a href="#h0-2-7" id="h0-2-7" class="d">-char *opt_io    = NULL;
</a><a href="#h0-2-8" id="h0-2-8" class="d">-char *opt_line  = NULL;
</a><a href="#h0-2-9" id="h0-2-9" class="d">-char *opt_name  = NULL;
</a><a href="#h0-2-10" id="h0-2-10" class="d">-char *opt_title = NULL;
</a> int oldbutton   = 3; /* button event on startup: 3 = release */
 
 static CSIEscape csiescseq;
<a href="#h0-3" id="h0-3" class="h">@@ -634,9 +625,9 @@ die(const char *errstr, ...)
</a> }
 
 void
<a href="#h0-3-3" id="h0-3-3" class="d">-execsh(void)
</a><a href="#h0-3-4" id="h0-3-4" class="i">+execsh(char **args)
</a> {
<a href="#h0-3-6" id="h0-3-6" class="d">-	char **args, *sh, *prog;
</a><a href="#h0-3-7" id="h0-3-7" class="i">+	char *sh, *prog;
</a> 	const struct passwd *pw;
 
 	errno = 0;
<a href="#h0-4" id="h0-4" class="h">@@ -650,13 +641,13 @@ execsh(void)
</a> 	if ((sh = getenv(&quot;SHELL&quot;)) == NULL)
 		sh = (pw-&gt;pw_shell[0]) ? pw-&gt;pw_shell : shell;
 
<a href="#h0-4-3" id="h0-4-3" class="d">-	if (opt_cmd)
</a><a href="#h0-4-4" id="h0-4-4" class="d">-		prog = opt_cmd[0];
</a><a href="#h0-4-5" id="h0-4-5" class="i">+	if (args)
</a><a href="#h0-4-6" id="h0-4-6" class="i">+		prog = args[0];
</a> 	else if (utmp)
 		prog = utmp;
 	else
 		prog = sh;
<a href="#h0-4-11" id="h0-4-11" class="d">-	args = (opt_cmd) ? opt_cmd : (char *[]) {prog, NULL};
</a><a href="#h0-4-12" id="h0-4-12" class="i">+	DEFAULT(args, ((char *[]) {prog, NULL}));
</a> 
 	unsetenv(&quot;COLUMNS&quot;);
 	unsetenv(&quot;LINES&quot;);
<a href="#h0-5" id="h0-5" class="h">@@ -697,7 +688,7 @@ sigchld(int a)
</a> 
 
 void
<a href="#h0-5-3" id="h0-5-3" class="d">-stty(void)
</a><a href="#h0-5-4" id="h0-5-4" class="i">+stty(char **args)
</a> {
 	char cmd[_POSIX_ARG_MAX], **p, *q, *s;
 	size_t n, siz;
<a href="#h0-6" id="h0-6" class="h">@@ -707,7 +698,7 @@ stty(void)
</a> 	memcpy(cmd, stty_args, n);
 	q = cmd + n;
 	siz = sizeof(cmd) - n;
<a href="#h0-6-3" id="h0-6-3" class="d">-	for (p = opt_cmd; p &amp;&amp; (s = *p); ++p) {
</a><a href="#h0-6-4" id="h0-6-4" class="i">+	for (p = args; p &amp;&amp; (s = *p); ++p) {
</a> 		if ((n = strlen(s)) &gt; siz-1)
 			die(&quot;stty parameter length too long\n&quot;);
 		*q++ = &#39; &#39;;
<a href="#h0-7" id="h0-7" class="h">@@ -721,26 +712,26 @@ stty(void)
</a> }
 
 void
<a href="#h0-7-3" id="h0-7-3" class="d">-ttynew(void)
</a><a href="#h0-7-4" id="h0-7-4" class="i">+ttynew(char *line, char *out, char **args)
</a> {
 	int m, s;
 	struct winsize w = {term.row, term.col, 0, 0};
 
<a href="#h0-7-9" id="h0-7-9" class="d">-	if (opt_io) {
</a><a href="#h0-7-10" id="h0-7-10" class="i">+	if (out) {
</a> 		term.mode |= MODE_PRINT;
<a href="#h0-7-12" id="h0-7-12" class="d">-		iofd = (!strcmp(opt_io, &quot;-&quot;)) ?
</a><a href="#h0-7-13" id="h0-7-13" class="d">-			  1 : open(opt_io, O_WRONLY | O_CREAT, 0666);
</a><a href="#h0-7-14" id="h0-7-14" class="i">+		iofd = (!strcmp(out, &quot;-&quot;)) ?
</a><a href="#h0-7-15" id="h0-7-15" class="i">+			  1 : open(out, O_WRONLY | O_CREAT, 0666);
</a> 		if (iofd &lt; 0) {
 			fprintf(stderr, &quot;Error opening %s:%s\n&quot;,
<a href="#h0-7-18" id="h0-7-18" class="d">-				opt_io, strerror(errno));
</a><a href="#h0-7-19" id="h0-7-19" class="i">+				out, strerror(errno));
</a> 		}
 	}
 
<a href="#h0-7-23" id="h0-7-23" class="d">-	if (opt_line) {
</a><a href="#h0-7-24" id="h0-7-24" class="d">-		if ((cmdfd = open(opt_line, O_RDWR)) &lt; 0)
</a><a href="#h0-7-25" id="h0-7-25" class="i">+	if (line) {
</a><a href="#h0-7-26" id="h0-7-26" class="i">+		if ((cmdfd = open(line, O_RDWR)) &lt; 0)
</a> 			die(&quot;open line failed: %s\n&quot;, strerror(errno));
 		dup2(cmdfd, 0);
<a href="#h0-7-29" id="h0-7-29" class="d">-		stty();
</a><a href="#h0-7-30" id="h0-7-30" class="i">+		stty(args);
</a> 		return;
 	}
 
<a href="#h0-8" id="h0-8" class="h">@@ -762,7 +753,7 @@ ttynew(void)
</a> 			die(&quot;ioctl TIOCSCTTY failed: %s\n&quot;, strerror(errno));
 		close(s);
 		close(m);
<a href="#h0-8-3" id="h0-8-3" class="d">-		execsh();
</a><a href="#h0-8-4" id="h0-8-4" class="i">+		execsh(args);
</a> 		break;
 	default:
 		close(s);
<a href="#h0-9" id="h0-9" class="h">@@ -1942,8 +1933,7 @@ void
</a> tprinter(char *s, size_t len)
 {
 	if (iofd != -1 &amp;&amp; xwrite(iofd, s, len) &lt; 0) {
<a href="#h0-9-3" id="h0-9-3" class="d">-		fprintf(stderr, &quot;Error writing in %s:%s\n&quot;,
</a><a href="#h0-9-4" id="h0-9-4" class="d">-			opt_io, strerror(errno));
</a><a href="#h0-9-5" id="h0-9-5" class="i">+		perror(&quot;Error writing to output file&quot;);
</a> 		close(iofd);
 		iofd = -1;
 	}
<a href="#h0-10" id="h0-10" class="h">@@ -2532,7 +2522,7 @@ tresize(int col, int row)
</a> void
 resettitle(void)
 {
<a href="#h0-10-3" id="h0-10-3" class="d">-	xsettitle(opt_title ? opt_title : &quot;st&quot;);
</a><a href="#h0-10-4" id="h0-10-4" class="i">+	xsettitle(NULL);
</a> }
 
 void
<b>diff --git a/<a id="h1" href="../file/st.h.html">st.h</a> b/<a href="../file/st.h.html">st.h</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -9,6 +9,7 @@
</a> #define LEN(a)			(sizeof(a) / sizeof(a)[0])
 #define BETWEEN(x, a, b)	((a) &lt;= (x) &amp;&amp; (x) &lt;= (b))
 #define DIVCEIL(n, d)		(((n) + ((d) - 1)) / (d))
<a href="#h1-0-3" id="h1-0-3" class="i">+#define DEFAULT(a, b)		(a) = (a) ? (a) : (b)
</a> #define LIMIT(x, a, b)		(x) = (x) &lt; (a) ? (a) : (x) &gt; (b) ? (b) : (x)
 #define ATTRCMP(a, b)		((a).mode != (b).mode || (a).fg != (b).fg || \
 				(a).bg != (b).bg)
<a href="#h1-1" id="h1-1" class="h">@@ -194,7 +195,7 @@ void tnew(int, int);
</a> void tresize(int, int);
 void tsetdirt(int, int);
 void tsetdirtattr(int);
<a href="#h1-1-3" id="h1-1-3" class="d">-void ttynew(void);
</a><a href="#h1-1-4" id="h1-1-4" class="i">+void ttynew(char *, char *, char **);
</a> size_t ttyread(void);
 void ttyresize(int, int);
 void ttysend(char *, size_t);
<a href="#h1-2" id="h1-2" class="h">@@ -221,14 +222,6 @@ extern Term term;
</a> extern Selection sel;
 extern int cmdfd;
 extern pid_t pid;
<a href="#h1-2-3" id="h1-2-3" class="d">-extern char **opt_cmd;
</a><a href="#h1-2-4" id="h1-2-4" class="d">-extern char *opt_class;
</a><a href="#h1-2-5" id="h1-2-5" class="d">-extern char *opt_embed;
</a><a href="#h1-2-6" id="h1-2-6" class="d">-extern char *opt_font;
</a><a href="#h1-2-7" id="h1-2-7" class="d">-extern char *opt_io;
</a><a href="#h1-2-8" id="h1-2-8" class="d">-extern char *opt_line;
</a><a href="#h1-2-9" id="h1-2-9" class="d">-extern char *opt_name;
</a><a href="#h1-2-10" id="h1-2-10" class="d">-extern char *opt_title;
</a> extern int oldbutton;
 
 /* config.h globals */
<b>diff --git a/<a id="h2" href="../file/x.c.html">x.c</a> b/<a href="../file/x.c.html">x.c</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -179,6 +179,15 @@ static char *usedfont = NULL;
</a> static double usedfontsize = 0;
 static double defaultfontsize = 0;
 
<a href="#h2-0-3" id="h2-0-3" class="i">+static char *opt_class = NULL;
</a><a href="#h2-0-4" id="h2-0-4" class="i">+static char **opt_cmd  = NULL;
</a><a href="#h2-0-5" id="h2-0-5" class="i">+static char *opt_embed = NULL;
</a><a href="#h2-0-6" id="h2-0-6" class="i">+static char *opt_font  = NULL;
</a><a href="#h2-0-7" id="h2-0-7" class="i">+static char *opt_io    = NULL;
</a><a href="#h2-0-8" id="h2-0-8" class="i">+static char *opt_line  = NULL;
</a><a href="#h2-0-9" id="h2-0-9" class="i">+static char *opt_name  = NULL;
</a><a href="#h2-0-10" id="h2-0-10" class="i">+static char *opt_title = NULL;
</a><a href="#h2-0-11" id="h2-0-11" class="i">+
</a> void
 zoom(const Arg *arg)
 {
<a href="#h2-1" id="h2-1" class="h">@@ -1473,6 +1482,7 @@ void
</a> xsettitle(char *p)
 {
 	XTextProperty prop;
<a href="#h2-1-3" id="h2-1-3" class="i">+	DEFAULT(p, &quot;st&quot;);
</a> 
 	Xutf8TextListToTextProperty(xw.dpy, &amp;p, 1, XUTF8StringStyle,
 			&amp;prop);
<a href="#h2-2" id="h2-2" class="h">@@ -1757,7 +1767,7 @@ run(void)
</a> 	} while (ev.type != MapNotify);
 
 	cresize(w, h);
<a href="#h2-2-3" id="h2-2-3" class="d">-	ttynew();
</a><a href="#h2-2-4" id="h2-2-4" class="i">+	ttynew(opt_line, opt_io, opt_cmd);
</a> 	ttyresize(win.tw, win.th);
 
 	clock_gettime(CLOCK_MONOTONIC, &amp;last);
</pre>
</div>
</body>
</html>
