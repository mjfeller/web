<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>fix: consistent usage of bitmask operations on unicode functions - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/6fc471ccc660b305cf836dcb8d57cdbffb4ed017.html">6fc471ccc660b305cf836dcb8d57cdbffb4ed017</a>
<b>parent</b> <a href="../commit/8b602a37a65a3c001bd9334d8b1cfc17fc5dd45c.html">8b602a37a65a3c001bd9334d8b1cfc17fc5dd45c</a>
<b>Author:</b> Markus Teich &lt;<a href="mailto:markus.teich@stusta.mhn.de">markus.teich@stusta.mhn.de</a>&gt;
<b>Date:</b>   Sat, 22 Jun 2013 23:06:49 +0200

fix: consistent usage of bitmask operations on unicode functions

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">50</td><td><span class="i">+++++++++++++++++++++++</span><span class="d">---------------------------</span></td></tr>
</table></pre><pre>1 file changed, 23 insertions(+), 27 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -150,10 +150,6 @@ enum selection_snap {
</a> 	SNAP_LINE = 2
 };
 
<a href="#h0-0-3" id="h0-0-3" class="d">-/* bit macro */
</a><a href="#h0-0-4" id="h0-0-4" class="d">-#undef B0
</a><a href="#h0-0-5" id="h0-0-5" class="d">-enum { B0=1, B1=2, B2=4, B3=8, B4=16, B5=32, B6=64, B7=128 };
</a><a href="#h0-0-6" id="h0-0-6" class="d">-
</a> typedef unsigned char uchar;
 typedef unsigned int uint;
 typedef unsigned long ulong;
<a href="#h0-1" id="h0-1" class="h">@@ -527,17 +523,17 @@ utf8decode(char *s, long *u) {
</a> 
 	rtn = 1;
 	c = *s;
<a href="#h0-1-3" id="h0-1-3" class="d">-	if(~c &amp; B7) { /* 0xxxxxxx */
</a><a href="#h0-1-4" id="h0-1-4" class="i">+	if(~c &amp; 0x80) { /* 0xxxxxxx */
</a> 		*u = c;
 		return rtn;
<a href="#h0-1-7" id="h0-1-7" class="d">-	} else if((c &amp; (B7|B6|B5)) == (B7|B6)) { /* 110xxxxx */
</a><a href="#h0-1-8" id="h0-1-8" class="d">-		*u = c&amp;(B4|B3|B2|B1|B0);
</a><a href="#h0-1-9" id="h0-1-9" class="i">+	} else if((c &amp; 0xE0) == 0xC0) { /* 110xxxxx */
</a><a href="#h0-1-10" id="h0-1-10" class="i">+		*u = c &amp; 0x1F;
</a> 		n = 1;
<a href="#h0-1-12" id="h0-1-12" class="d">-	} else if((c &amp; (B7|B6|B5|B4)) == (B7|B6|B5)) { /* 1110xxxx */
</a><a href="#h0-1-13" id="h0-1-13" class="d">-		*u = c&amp;(B3|B2|B1|B0);
</a><a href="#h0-1-14" id="h0-1-14" class="i">+	} else if((c &amp; 0xF0) == 0xE0) { /* 1110xxxx */
</a><a href="#h0-1-15" id="h0-1-15" class="i">+		*u = c &amp; 0x0F;
</a> 		n = 2;
<a href="#h0-1-17" id="h0-1-17" class="d">-	} else if((c &amp; (B7|B6|B5|B4|B3)) == (B7|B6|B5|B4)) { /* 11110xxx */
</a><a href="#h0-1-18" id="h0-1-18" class="d">-		*u = c &amp; (B2|B1|B0);
</a><a href="#h0-1-19" id="h0-1-19" class="i">+	} else if((c &amp; 0xF8) == 0xF0) { /* 11110xxx */
</a><a href="#h0-1-20" id="h0-1-20" class="i">+		*u = c &amp; 0x07;
</a> 		n = 3;
 	} else {
 		goto invalid;
<a href="#h0-2" id="h0-2" class="h">@@ -545,10 +541,10 @@ utf8decode(char *s, long *u) {
</a> 
 	for(i = n, ++s; i &gt; 0; --i, ++rtn, ++s) {
 		c = *s;
<a href="#h0-2-3" id="h0-2-3" class="d">-		if((c &amp; (B7|B6)) != B7) /* 10xxxxxx */
</a><a href="#h0-2-4" id="h0-2-4" class="i">+		if((c &amp; 0xC0) != 0x80) /* 10xxxxxx */
</a> 			goto invalid;
 		*u &lt;&lt;= 6;
<a href="#h0-2-7" id="h0-2-7" class="d">-		*u |= c &amp; (B5|B4|B3|B2|B1|B0);
</a><a href="#h0-2-8" id="h0-2-8" class="i">+		*u |= c &amp; 0x3F;
</a> 	}
 
 	if((n == 1 &amp;&amp; *u &lt; 0x80) ||
<a href="#h0-3" id="h0-3" class="h">@@ -577,20 +573,20 @@ utf8encode(long *u, char *s) {
</a> 		*sp = uc; /* 0xxxxxxx */
 		return 1;
 	} else if(*u &lt; 0x800) {
<a href="#h0-3-3" id="h0-3-3" class="d">-		*sp = (uc &gt;&gt; 6) | (B7|B6); /* 110xxxxx */
</a><a href="#h0-3-4" id="h0-3-4" class="i">+		*sp = (uc &gt;&gt; 6) | 0xC0; /* 110xxxxx */
</a> 		n = 1;
 	} else if(uc &lt; 0x10000) {
<a href="#h0-3-7" id="h0-3-7" class="d">-		*sp = (uc &gt;&gt; 12) | (B7|B6|B5); /* 1110xxxx */
</a><a href="#h0-3-8" id="h0-3-8" class="i">+		*sp = (uc &gt;&gt; 12) | 0xE0; /* 1110xxxx */
</a> 		n = 2;
 	} else if(uc &lt;= 0x10FFFF) {
<a href="#h0-3-11" id="h0-3-11" class="d">-		*sp = (uc &gt;&gt; 18) | (B7|B6|B5|B4); /* 11110xxx */
</a><a href="#h0-3-12" id="h0-3-12" class="i">+		*sp = (uc &gt;&gt; 18) | 0xF0; /* 11110xxx */
</a> 		n = 3;
 	} else {
 		goto invalid;
 	}
 
 	for(i=n,++sp; i&gt;0; --i,++sp)
<a href="#h0-3-19" id="h0-3-19" class="d">-		*sp = ((uc &gt;&gt; 6*(i-1)) &amp; (B5|B4|B3|B2|B1|B0)) | B7; /* 10xxxxxx */
</a><a href="#h0-3-20" id="h0-3-20" class="i">+		*sp = ((uc &gt;&gt; 6*(i-1)) &amp; 0x3F) | 0x80; /* 10xxxxxx */
</a> 
 	return n+1;
 invalid:
<a href="#h0-4" id="h0-4" class="h">@@ -613,16 +609,16 @@ isfullutf8(char *s, int b) {
</a> 	c3 = (uchar *)++s;
 	if(b &lt; 1) {
 		return 0;
<a href="#h0-4-3" id="h0-4-3" class="d">-	} else if((*c1&amp;(B7|B6|B5)) == (B7|B6) &amp;&amp; b == 1) {
</a><a href="#h0-4-4" id="h0-4-4" class="i">+	} else if((*c1 &amp; 0xE0) == 0xC0 &amp;&amp; b == 1) {
</a> 		return 0;
<a href="#h0-4-6" id="h0-4-6" class="d">-	} else if((*c1&amp;(B7|B6|B5|B4)) == (B7|B6|B5) &amp;&amp;
</a><a href="#h0-4-7" id="h0-4-7" class="i">+	} else if((*c1 &amp; 0xF0) == 0xE0 &amp;&amp;
</a> 	    ((b == 1) ||
<a href="#h0-4-9" id="h0-4-9" class="d">-	    ((b == 2) &amp;&amp; (*c2&amp;(B7|B6)) == B7))) {
</a><a href="#h0-4-10" id="h0-4-10" class="i">+	    ((b == 2) &amp;&amp; (*c2 &amp; 0xC0) == 0x80))) {
</a> 		return 0;
<a href="#h0-4-12" id="h0-4-12" class="d">-	} else if((*c1&amp;(B7|B6|B5|B4|B3)) == (B7|B6|B5|B4) &amp;&amp;
</a><a href="#h0-4-13" id="h0-4-13" class="i">+	} else if((*c1 &amp; 0xF8) == 0xF0 &amp;&amp;
</a> 	    ((b == 1) ||
<a href="#h0-4-15" id="h0-4-15" class="d">-	    ((b == 2) &amp;&amp; (*c2&amp;(B7|B6)) == B7) ||
</a><a href="#h0-4-16" id="h0-4-16" class="d">-	    ((b == 3) &amp;&amp; (*c2&amp;(B7|B6)) == B7 &amp;&amp; (*c3&amp;(B7|B6)) == B7))) {
</a><a href="#h0-4-17" id="h0-4-17" class="i">+	    ((b == 2) &amp;&amp; (*c2 &amp; 0xC0) == 0x80) ||
</a><a href="#h0-4-18" id="h0-4-18" class="i">+	    ((b == 3) &amp;&amp; (*c2 &amp; 0xC0) == 0x80 &amp;&amp; (*c3 &amp; 0xC0) == 0x80))) {
</a> 		return 0;
 	} else {
 		return 1;
<a href="#h0-5" id="h0-5" class="h">@@ -633,11 +629,11 @@ int
</a> utf8size(char *s) {
 	uchar c = *s;
 
<a href="#h0-5-3" id="h0-5-3" class="d">-	if(~c&amp;B7) {
</a><a href="#h0-5-4" id="h0-5-4" class="i">+	if(~c &amp; 0x80) {
</a> 		return 1;
<a href="#h0-5-6" id="h0-5-6" class="d">-	} else if((c&amp;(B7|B6|B5)) == (B7|B6)) {
</a><a href="#h0-5-7" id="h0-5-7" class="i">+	} else if((c &amp; 0xE0) == 0xC0) {
</a> 		return 2;
<a href="#h0-5-9" id="h0-5-9" class="d">-	} else if((c&amp;(B7|B6|B5|B4)) == (B7|B6|B5)) {
</a><a href="#h0-5-10" id="h0-5-10" class="i">+	} else if((c &amp; 0xF0) == 0xE0) {
</a> 		return 3;
 	} else {
 		return 4;
<a href="#h0-6" id="h0-6" class="h">@@ -3456,7 +3452,7 @@ kpress(XEvent *ev) {
</a> 		if(len == 1 &amp;&amp; e-&gt;state &amp; Mod1Mask) {
 			if(IS_SET(MODE_8BIT)) {
 				if(*xstr &lt; 0177) {
<a href="#h0-6-3" id="h0-6-3" class="d">-					c = *xstr | B7;
</a><a href="#h0-6-4" id="h0-6-4" class="i">+					c = *xstr | 0x80;
</a> 					ret = utf8encode(&amp;c, cp);
 					cp += ret;
 					len = 0;
</pre>
</div>
</body>
</html>
