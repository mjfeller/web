<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Add a hack to handle unknown chars in fontconfig. - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/b0bddc694a79dd24edb8f997acadecbff356a9e0.html">b0bddc694a79dd24edb8f997acadecbff356a9e0</a>
<b>parent</b> <a href="../commit/487bbb24d02190efa3d18093cadfa376f816d7fa.html">487bbb24d02190efa3d18093cadfa376f816d7fa</a>
<b>Author:</b> Christoph Lohmann &lt;<a href="mailto:20h@r-36.net">20h@r-36.net</a>&gt;
<b>Date:</b>   Mon,  9 Mar 2015 23:16:03 +0100

Add a hack to handle unknown chars in fontconfig.

The unicode long is added to the cache. So when fontconfig does fall back to
the default font (where there is no easy way to find this out from the
pattern) it isn&#39;t reloaded.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">19</td><td><span class="i">++++++++++++++</span><span class="d">-----</span></td></tr>
</table></pre><pre>1 file changed, 14 insertions(+), 5 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -522,6 +522,7 @@ enum {
</a> typedef struct {
 	XftFont *font;
 	int flags;
<a href="#h0-0-3" id="h0-0-3" class="i">+	long unicodep;
</a> } Fontcache;
 
 /* Fontcache is an array now. A new font will be appended to the array. */
<a href="#h0-1" id="h0-1" class="h">@@ -3208,7 +3209,7 @@ void
</a> xdraws(char *s, Glyph base, int x, int y, int charlen, int bytelen) {
 	int winx = borderpx + x * xw.cw, winy = borderpx + y * xw.ch,
 	    width = charlen * xw.cw, xp, i;
<a href="#h0-1-3" id="h0-1-3" class="d">-	int frcflags;
</a><a href="#h0-1-4" id="h0-1-4" class="i">+	int frcflags, charexists;
</a> 	int u8fl, u8fblen, u8cblen, doesexist;
 	char *u8c, *u8fs;
 	long unicodep;
<a href="#h0-2" id="h0-2" class="h">@@ -3391,8 +3392,13 @@ xdraws(char *s, Glyph base, int x, int y, int charlen, int bytelen) {
</a> 
 		/* Search the font cache. */
 		for(i = 0; i &lt; frclen; i++) {
<a href="#h0-2-3" id="h0-2-3" class="d">-			if(XftCharExists(xw.dpy, frc[i].font, unicodep)
</a><a href="#h0-2-4" id="h0-2-4" class="d">-					&amp;&amp; frc[i].flags == frcflags) {
</a><a href="#h0-2-5" id="h0-2-5" class="i">+			charexists = XftCharExists(xw.dpy, frc[i].font, unicodep);
</a><a href="#h0-2-6" id="h0-2-6" class="i">+			/* Everything correct. */
</a><a href="#h0-2-7" id="h0-2-7" class="i">+			if(charexists &amp;&amp; frc[i].flags == frcflags)
</a><a href="#h0-2-8" id="h0-2-8" class="i">+				break;
</a><a href="#h0-2-9" id="h0-2-9" class="i">+			/* We got a default font for a not found glyph. */
</a><a href="#h0-2-10" id="h0-2-10" class="i">+			if(!charexists &amp;&amp; frc[i].flags == frcflags \
</a><a href="#h0-2-11" id="h0-2-11" class="i">+					&amp;&amp; unicodep == unicodep) {
</a> 				break;
 			}
 		}
<a href="#h0-3" id="h0-3" class="h">@@ -3421,10 +3427,11 @@ xdraws(char *s, Glyph base, int x, int y, int charlen, int bytelen) {
</a> 
 			FcConfigSubstitute(0, fcpattern,
 					FcMatchPattern);
<a href="#h0-3-3" id="h0-3-3" class="i">+			FcPatternPrint(fcpattern);
</a> 			FcDefaultSubstitute(fcpattern);
 
<a href="#h0-3-6" id="h0-3-6" class="d">-			fontpattern = FcFontSetMatch(0, fcsets,
</a><a href="#h0-3-7" id="h0-3-7" class="d">-					FcTrue, fcpattern, &amp;fcres);
</a><a href="#h0-3-8" id="h0-3-8" class="i">+			fontpattern = FcFontSetMatch(0, fcsets, 1,
</a><a href="#h0-3-9" id="h0-3-9" class="i">+					fcpattern, &amp;fcres);
</a> 
 			/*
 			 * Overwrite or create the new cache entry.
<a href="#h0-4" id="h0-4" class="h">@@ -3432,11 +3439,13 @@ xdraws(char *s, Glyph base, int x, int y, int charlen, int bytelen) {
</a> 			if(frclen &gt;= LEN(frc)) {
 				frclen = LEN(frc) - 1;
 				XftFontClose(xw.dpy, frc[frclen].font);
<a href="#h0-4-3" id="h0-4-3" class="i">+				frc[frclen].unicodep = 0;
</a> 			}
 
 			frc[frclen].font = XftFontOpenPattern(xw.dpy,
 					fontpattern);
 			frc[frclen].flags = frcflags;
<a href="#h0-4-9" id="h0-4-9" class="i">+			frc[frclen].unicodep = unicodep;
</a> 
 			i = frclen;
 			frclen++;
</pre>
</div>
</body>
</html>
