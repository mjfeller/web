<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Render only once in each main loop iteration - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/c5a9b799d44be9c0fa4264dc34d9dd61321be795.html">c5a9b799d44be9c0fa4264dc34d9dd61321be795</a>
<b>parent</b> <a href="../commit/85849ce72aa4e9cee307a031b97777e9eba2d453.html">85849ce72aa4e9cee307a031b97777e9eba2d453</a>
<b>Author:</b> Roberto E. Vargas Caballero &lt;<a href="mailto:k0ga@shike2.com">k0ga@shike2.com</a>&gt;
<b>Date:</b>   Sun, 16 Sep 2012 10:48:38 +0200

Render only once in each main loop iteration

draw() runs over all lines of the screen and renders only the dirty lines,
this avoids render lines which are not modified since last draw() call. In
this moment the main loop is something like:

     - Wait something to read from file descriptors
     - Read from pseudo tty
     - Call draw() for rending
     - Read X events

This cause the problem that all the X events that have to update the screen
have to call draw() (because draw() is called before of X events handling),
so you can have multiples renderings in only one iteration, that will waste
a lot of resources.

This patch change the main loop to:

     - Wait something to read from file descriptors
     - Read from pseudo tty
     - Read X events
     - Call draw() for rending

So X events don&#39;t have to worry about rendering, because draw() is called
after them.

The only place where draw is called outside of the main loop is in redraw(),
but it is necessary for getting a good tput flash.
---
 st.c |   29 ++++++-----------------------
 1 file changed, 6 insertions(+), 23 deletions(-)
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">29</td><td><span class="i">++++++</span><span class="d">-----------------------</span></td></tr>
</table></pre><pre>1 file changed, 6 insertions(+), 23 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -288,7 +288,6 @@ static void ttywrite(const char *, size_t);
</a> static void xdraws(char *, Glyph, int, int, int, int);
 static void xhints(void);
 static void xclear(int, int, int, int);
<a href="#h0-0-3" id="h0-0-3" class="d">-static void xcopy(void);
</a> static void xdrawcursor(void);
 static void xinit(void);
 static void xloadcols(void);
<a href="#h0-1" id="h0-1" class="h">@@ -635,7 +634,6 @@ void selclear(XEvent *e) {
</a> 		return;
 	sel.bx = -1;
 	tsetdirt(sel.b.y, sel.e.y);
<a href="#h0-1-3" id="h0-1-3" class="d">-	draw();
</a> }
 
 void
<a href="#h0-2" id="h0-2" class="h">@@ -685,8 +683,6 @@ xsetsel(char *str) {
</a> 
 	clipboard = XInternAtom(xw.dpy, &quot;CLIPBOARD&quot;, 0);
 	XSetSelectionOwner(xw.dpy, clipboard, xw.win, CurrentTime);
<a href="#h0-2-3" id="h0-2-3" class="d">-
</a><a href="#h0-2-4" id="h0-2-4" class="d">-	XFlush(xw.dpy);
</a> }
 
 void
<a href="#h0-3" id="h0-3" class="h">@@ -729,7 +725,6 @@ brelease(XEvent *e) {
</a> 	}
 	memcpy(&amp;sel.tclick2, &amp;sel.tclick1, sizeof(struct timeval));
 	gettimeofday(&amp;sel.tclick1, NULL);
<a href="#h0-3-3" id="h0-3-3" class="d">-	draw();
</a> }
 
 void
<a href="#h0-4" id="h0-4" class="h">@@ -746,7 +741,6 @@ bmotion(XEvent *e) {
</a> 			int starty = MIN(oldey, sel.ey);
 			int endy = MAX(oldey, sel.ey);
 			tsetdirt(starty, endy);
<a href="#h0-4-3" id="h0-4-3" class="d">-			draw();
</a> 		}
 	}
 }
<a href="#h0-5" id="h0-5" class="h">@@ -2091,13 +2085,6 @@ xdraws(char *s, Glyph base, int x, int y, int charlen, int bytelen) {
</a> 		XDrawLine(xw.dpy, xw.buf, dc.gc, winx, winy+1, winx+width-1, winy+1);
 }
 
<a href="#h0-5-3" id="h0-5-3" class="d">-/* copy buffer pixmap to screen pixmap */
</a><a href="#h0-5-4" id="h0-5-4" class="d">-void
</a><a href="#h0-5-5" id="h0-5-5" class="d">-xcopy() {
</a><a href="#h0-5-6" id="h0-5-6" class="d">-	XdbeSwapInfo swpinfo[1] = {{xw.win, XdbeCopied}};
</a><a href="#h0-5-7" id="h0-5-7" class="d">-	XdbeSwapBuffers(xw.dpy, swpinfo, 1);
</a><a href="#h0-5-8" id="h0-5-8" class="d">-}
</a><a href="#h0-5-9" id="h0-5-9" class="d">-
</a> void
 xdrawcursor(void) {
 	static int oldx = 0;
<a href="#h0-6" id="h0-6" class="h">@@ -2118,8 +2105,6 @@ xdrawcursor(void) {
</a> 	} else
 		xclear(oldx, oldy, oldx, oldy);
 
<a href="#h0-6-3" id="h0-6-3" class="d">-	xcopy();
</a><a href="#h0-6-4" id="h0-6-4" class="d">-
</a> 	/* draw the new one */
 	if(!(term.c.state &amp; CURSOR_HIDE)) {
 		if(!(xw.state &amp; WIN_FOCUSED))
<a href="#h0-7" id="h0-7" class="h">@@ -2132,8 +2117,6 @@ xdrawcursor(void) {
</a> 		xdraws(g.c, g, term.c.x, term.c.y, 1, sl);
 		oldx = term.c.x, oldy = term.c.y;
 	}
<a href="#h0-7-3" id="h0-7-3" class="d">-
</a><a href="#h0-7-4" id="h0-7-4" class="d">-	xcopy();
</a> }
 
 void
<a href="#h0-8" id="h0-8" class="h">@@ -2152,8 +2135,10 @@ redraw(void) {
</a> 
 void
 draw() {
<a href="#h0-8-3" id="h0-8-3" class="i">+	XdbeSwapInfo swpinfo[1] = {{xw.win, XdbeCopied}};
</a><a href="#h0-8-4" id="h0-8-4" class="i">+
</a> 	drawregion(0, 0, term.col, term.row);
<a href="#h0-8-6" id="h0-8-6" class="d">-	xcopy();
</a><a href="#h0-8-7" id="h0-8-7" class="i">+	XdbeSwapBuffers(xw.dpy, swpinfo, 1);
</a> }
 
 void
<a href="#h0-9" id="h0-9" class="h">@@ -2208,7 +2193,6 @@ expose(XEvent *ev) {
</a> 		if(!e-&gt;count)
 			xw.state &amp;= ~WIN_REDRAW;
 	}
<a href="#h0-9-3" id="h0-9-3" class="d">-	xcopy();
</a> }
 
 void
<a href="#h0-10" id="h0-10" class="h">@@ -2241,7 +2225,6 @@ focus(XEvent *ev) {
</a> 		xseturgency(0);
 	} else
 		xw.state &amp;= ~WIN_FOCUSED;
<a href="#h0-10-3" id="h0-10-3" class="d">-	draw();
</a> }
 
 char*
<a href="#h0-11" id="h0-11" class="h">@@ -2317,7 +2300,6 @@ cmessage(XEvent *e) {
</a> 		} else if(e-&gt;xclient.data.l[1] == XEMBED_FOCUS_OUT) {
 			xw.state &amp;= ~WIN_FOCUSED;
 		}
<a href="#h0-11-3" id="h0-11-3" class="d">-		draw();
</a> 	}
 }
 
<a href="#h0-12" id="h0-12" class="h">@@ -2358,8 +2340,6 @@ run(void) {
</a> 		if(FD_ISSET(cmdfd, &amp;rfd))
 			ttyread();
 
<a href="#h0-12-3" id="h0-12-3" class="d">-		draw();
</a><a href="#h0-12-4" id="h0-12-4" class="d">-
</a> 		while(XPending(xw.dpy)) {
 			XNextEvent(xw.dpy, &amp;ev);
 			if(XFilterEvent(&amp;ev, xw.win))
<a href="#h0-13" id="h0-13" class="h">@@ -2367,6 +2347,9 @@ run(void) {
</a> 			if(handler[ev.type])
 				(handler[ev.type])(&amp;ev);
 		}
<a href="#h0-13-3" id="h0-13-3" class="i">+
</a><a href="#h0-13-4" id="h0-13-4" class="i">+		draw();
</a><a href="#h0-13-5" id="h0-13-5" class="i">+		XFlush(xw.dpy);
</a> 	}
 }
 
</pre>
</div>
</body>
</html>
