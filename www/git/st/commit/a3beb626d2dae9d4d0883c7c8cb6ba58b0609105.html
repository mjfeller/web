<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Remove x.c dependency on term - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/a3beb626d2dae9d4d0883c7c8cb6ba58b0609105.html">a3beb626d2dae9d4d0883c7c8cb6ba58b0609105</a>
<b>parent</b> <a href="../commit/a5dc1b46976b2252f9d7bb68f126c4b0f351dd1a.html">a5dc1b46976b2252f9d7bb68f126c4b0f351dd1a</a>
<b>Author:</b> Devin J. Pohly &lt;<a href="mailto:djpohly@gmail.com">djpohly@gmail.com</a>&gt;
<b>Date:</b>   Sat, 24 Feb 2018 15:32:48 -0600

Remove x.c dependency on term

The xinit function only needs to the rows/cols, so pass those in rather
than accessing term directly.  With a bit of arithmetic, we are able to
avoid the need for term.row and term.col in x2col, y2row, and
xdrawglyphfontspecs as well, completing the removal.

Term is now fully internal to st.c.

Signed-off-by: Devin J. Pohly &lt;djpohly@gmail.com&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">22</td><td><span class="i">+++++++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">st.h</a></td><td> | </td><td class="num">21</td><td><span class="i"></span><span class="d">---------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">x.c</a></td><td> | </td><td class="num">35</td><td><span class="i">++++++++++++++++++</span><span class="d">-----------------</span></td></tr>
</table></pre><pre>3 files changed, 39 insertions(+), 39 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -95,6 +95,26 @@ enum escape_state {
</a> 	ESC_DCS        =128,
 };
 
<a href="#h0-0-3" id="h0-0-3" class="i">+/* Internal representation of the screen */
</a><a href="#h0-0-4" id="h0-0-4" class="i">+typedef struct {
</a><a href="#h0-0-5" id="h0-0-5" class="i">+	int row;      /* nb row */
</a><a href="#h0-0-6" id="h0-0-6" class="i">+	int col;      /* nb col */
</a><a href="#h0-0-7" id="h0-0-7" class="i">+	Line *line;   /* screen */
</a><a href="#h0-0-8" id="h0-0-8" class="i">+	Line *alt;    /* alternate screen */
</a><a href="#h0-0-9" id="h0-0-9" class="i">+	int *dirty;   /* dirtyness of lines */
</a><a href="#h0-0-10" id="h0-0-10" class="i">+	TCursor c;    /* cursor */
</a><a href="#h0-0-11" id="h0-0-11" class="i">+	int ocx;      /* old cursor col */
</a><a href="#h0-0-12" id="h0-0-12" class="i">+	int ocy;      /* old cursor row */
</a><a href="#h0-0-13" id="h0-0-13" class="i">+	int top;      /* top    scroll limit */
</a><a href="#h0-0-14" id="h0-0-14" class="i">+	int bot;      /* bottom scroll limit */
</a><a href="#h0-0-15" id="h0-0-15" class="i">+	int mode;     /* terminal mode flags */
</a><a href="#h0-0-16" id="h0-0-16" class="i">+	int esc;      /* escape state flags */
</a><a href="#h0-0-17" id="h0-0-17" class="i">+	char trantbl[4]; /* charset table translation */
</a><a href="#h0-0-18" id="h0-0-18" class="i">+	int charset;  /* current charset */
</a><a href="#h0-0-19" id="h0-0-19" class="i">+	int icharset; /* selected charset for sequence */
</a><a href="#h0-0-20" id="h0-0-20" class="i">+	int *tabs;
</a><a href="#h0-0-21" id="h0-0-21" class="i">+} Term;
</a><a href="#h0-0-22" id="h0-0-22" class="i">+
</a> /* CSI Escape sequence structs */
 /* ESC &#39;[&#39; [[ [&lt;priv&gt;] &lt;arg&gt; [;]] &lt;mode&gt; [&lt;mode&gt;]] */
 typedef struct {
<a href="#h0-1" id="h0-1" class="h">@@ -181,11 +201,11 @@ static char *base64dec(const char *);
</a> static ssize_t xwrite(int, const char *, size_t);
 
 /* Globals */
<a href="#h0-1-3" id="h0-1-3" class="d">-Term term;
</a> int cmdfd;
 pid_t pid;
 int oldbutton   = 3; /* button event on startup: 3 = release */
 
<a href="#h0-1-8" id="h0-1-8" class="i">+static Term term;
</a> static Selection sel;
 static CSIEscape csiescseq;
 static STREscape strescseq;
<b>diff --git a/<a id="h1" href="../file/st.h.html">st.h</a> b/<a href="../file/st.h.html">st.h</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -76,26 +76,6 @@ typedef struct {
</a> 	char state;
 } TCursor;
 
<a href="#h1-0-3" id="h1-0-3" class="d">-/* Internal representation of the screen */
</a><a href="#h1-0-4" id="h1-0-4" class="d">-typedef struct {
</a><a href="#h1-0-5" id="h1-0-5" class="d">-	int row;      /* nb row */
</a><a href="#h1-0-6" id="h1-0-6" class="d">-	int col;      /* nb col */
</a><a href="#h1-0-7" id="h1-0-7" class="d">-	Line *line;   /* screen */
</a><a href="#h1-0-8" id="h1-0-8" class="d">-	Line *alt;    /* alternate screen */
</a><a href="#h1-0-9" id="h1-0-9" class="d">-	int *dirty;   /* dirtyness of lines */
</a><a href="#h1-0-10" id="h1-0-10" class="d">-	TCursor c;    /* cursor */
</a><a href="#h1-0-11" id="h1-0-11" class="d">-	int ocx;      /* old cursor col */
</a><a href="#h1-0-12" id="h1-0-12" class="d">-	int ocy;      /* old cursor row */
</a><a href="#h1-0-13" id="h1-0-13" class="d">-	int top;      /* top    scroll limit */
</a><a href="#h1-0-14" id="h1-0-14" class="d">-	int bot;      /* bottom scroll limit */
</a><a href="#h1-0-15" id="h1-0-15" class="d">-	int mode;     /* terminal mode flags */
</a><a href="#h1-0-16" id="h1-0-16" class="d">-	int esc;      /* escape state flags */
</a><a href="#h1-0-17" id="h1-0-17" class="d">-	char trantbl[4]; /* charset table translation */
</a><a href="#h1-0-18" id="h1-0-18" class="d">-	int charset;  /* current charset */
</a><a href="#h1-0-19" id="h1-0-19" class="d">-	int icharset; /* selected charset for sequence */
</a><a href="#h1-0-20" id="h1-0-20" class="d">-	int *tabs;
</a><a href="#h1-0-21" id="h1-0-21" class="d">-} Term;
</a><a href="#h1-0-22" id="h1-0-22" class="d">-
</a> /* Purely graphic info */
 typedef struct {
 	int tw, th; /* tty width and height */
<a href="#h1-1" id="h1-1" class="h">@@ -168,7 +148,6 @@ void *xrealloc(void *, size_t);
</a> char *xstrdup(char *);
 
 /* Globals */
<a href="#h1-1-3" id="h1-1-3" class="d">-extern Term term;
</a> extern int cmdfd;
 extern pid_t pid;
 extern int oldbutton;
<b>diff --git a/<a id="h2" href="../file/x.c.html">x.c</a> b/<a href="../file/x.c.html">x.c</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -130,7 +130,7 @@ static void xdrawglyphfontspecs(const XftGlyphFontSpec *, Glyph, int, int, int);
</a> static void xdrawglyph(Glyph, int, int);
 static void xclear(int, int, int, int);
 static int xgeommasktogravity(int);
<a href="#h2-0-3" id="h2-0-3" class="d">-static void xinit(void);
</a><a href="#h2-0-4" id="h2-0-4" class="i">+static void xinit(int, int);
</a> static void cresize(int, int);
 static void xresize(int, int);
 static int xloadfont(Font *, FcPattern *);
<a href="#h2-1" id="h2-1" class="h">@@ -299,18 +299,16 @@ int
</a> x2col(int x)
 {
 	x -= borderpx;
<a href="#h2-1-3" id="h2-1-3" class="d">-	x /= win.cw;
</a><a href="#h2-1-4" id="h2-1-4" class="d">-
</a><a href="#h2-1-5" id="h2-1-5" class="d">-	return LIMIT(x, 0, term.col-1);
</a><a href="#h2-1-6" id="h2-1-6" class="i">+	LIMIT(x, 0, win.tw - 1);
</a><a href="#h2-1-7" id="h2-1-7" class="i">+	return x / win.cw;
</a> }
 
 int
 y2row(int y)
 {
 	y -= borderpx;
<a href="#h2-1-14" id="h2-1-14" class="d">-	y /= win.ch;
</a><a href="#h2-1-15" id="h2-1-15" class="d">-
</a><a href="#h2-1-16" id="h2-1-16" class="d">-	return LIMIT(y, 0, term.row-1);
</a><a href="#h2-1-17" id="h2-1-17" class="i">+	LIMIT(y, 0, win.th - 1);
</a><a href="#h2-1-18" id="h2-1-18" class="i">+	return y / win.ch;
</a> }
 
 void
<a href="#h2-2" id="h2-2" class="h">@@ -984,7 +982,7 @@ xunloadfonts(void)
</a> }
 
 void
<a href="#h2-2-3" id="h2-2-3" class="d">-xinit(void)
</a><a href="#h2-2-4" id="h2-2-4" class="i">+xinit(int cols, int rows)
</a> {
 	XGCValues gcvalues;
 	Cursor cursor;
<a href="#h2-3" id="h2-3" class="h">@@ -1009,8 +1007,8 @@ xinit(void)
</a> 	xloadcols();
 
 	/* adjust fixed window geometry */
<a href="#h2-3-3" id="h2-3-3" class="d">-	win.w = 2 * borderpx + term.col * win.cw;
</a><a href="#h2-3-4" id="h2-3-4" class="d">-	win.h = 2 * borderpx + term.row * win.ch;
</a><a href="#h2-3-5" id="h2-3-5" class="i">+	win.w = 2 * borderpx + cols * win.cw;
</a><a href="#h2-3-6" id="h2-3-6" class="i">+	win.h = 2 * borderpx + rows * win.ch;
</a> 	if (xw.gm &amp; XNegative)
 		xw.l += DisplayWidth(xw.dpy, xw.scr) - win.w - 2;
 	if (xw.gm &amp; YNegative)
<a href="#h2-4" id="h2-4" class="h">@@ -1042,7 +1040,7 @@ xinit(void)
</a> 	XFillRectangle(xw.dpy, xw.buf, dc.gc, 0, 0, win.w, win.h);
 
 	/* font spec buffer */
<a href="#h2-4-3" id="h2-4-3" class="d">-	xw.specbuf = xmalloc(term.col * sizeof(GlyphFontSpec));
</a><a href="#h2-4-4" id="h2-4-4" class="i">+	xw.specbuf = xmalloc(cols * sizeof(GlyphFontSpec));
</a> 
 	/* Xft rendering context */
 	xw.draw = XftDrawCreate(xw.dpy, xw.buf, xw.vis, xw.cmap);
<a href="#h2-5" id="h2-5" class="h">@@ -1337,15 +1335,16 @@ xdrawglyphfontspecs(const XftGlyphFontSpec *specs, Glyph base, int len, int x, i
</a> 	/* Intelligent cleaning up of the borders. */
 	if (x == 0) {
 		xclear(0, (y == 0)? 0 : winy, borderpx,
<a href="#h2-5-3" id="h2-5-3" class="d">-			winy + win.ch + ((y &gt;= term.row-1)? win.h : 0));
</a><a href="#h2-5-4" id="h2-5-4" class="i">+			winy + win.ch +
</a><a href="#h2-5-5" id="h2-5-5" class="i">+			((winy + win.ch &gt;= borderpx + win.th)? win.h : 0));
</a> 	}
<a href="#h2-5-7" id="h2-5-7" class="d">-	if (x + charlen &gt;= term.col) {
</a><a href="#h2-5-8" id="h2-5-8" class="i">+	if (winx + width &gt;= borderpx + win.tw) {
</a> 		xclear(winx + width, (y == 0)? 0 : winy, win.w,
<a href="#h2-5-10" id="h2-5-10" class="d">-			((y &gt;= term.row-1)? win.h : (winy + win.ch)));
</a><a href="#h2-5-11" id="h2-5-11" class="i">+			((winy + win.ch &gt;= borderpx + win.th)? win.h : (winy + win.ch)));
</a> 	}
 	if (y == 0)
 		xclear(winx, 0, winx + width, borderpx);
<a href="#h2-5-15" id="h2-5-15" class="d">-	if (y == term.row-1)
</a><a href="#h2-5-16" id="h2-5-16" class="i">+	if (winy + win.ch &gt;= borderpx + win.th)
</a> 		xclear(winx, winy + win.ch, winx + width, win.h);
 
 	/* Clean up the region we want to draw to. */
<a href="#h2-6" id="h2-6" class="h">@@ -1930,8 +1929,10 @@ run:
</a> 	}
 	setlocale(LC_CTYPE, &quot;&quot;);
 	XSetLocaleModifiers(&quot;&quot;);
<a href="#h2-6-3" id="h2-6-3" class="d">-	tnew(MAX(cols, 1), MAX(rows, 1));
</a><a href="#h2-6-4" id="h2-6-4" class="d">-	xinit();
</a><a href="#h2-6-5" id="h2-6-5" class="i">+	cols = MAX(cols, 1);
</a><a href="#h2-6-6" id="h2-6-6" class="i">+	rows = MAX(rows, 1);
</a><a href="#h2-6-7" id="h2-6-7" class="i">+	tnew(cols, rows);
</a><a href="#h2-6-8" id="h2-6-8" class="i">+	xinit(cols, rows);
</a> 	xsetenv();
 	selinit();
 	run();
</pre>
</div>
</body>
</html>
