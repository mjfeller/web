<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>OSC 52 - copy to clipboard: don&#39;t limit to 382 bytes - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/2e54a21b5ae249a6bcedab9db611ea86037a018b.html">2e54a21b5ae249a6bcedab9db611ea86037a018b</a>
<b>parent</b> <a href="../commit/289c52b7aa9b0e826bbea6f956755b3199b3ccac.html">289c52b7aa9b0e826bbea6f956755b3199b3ccac</a>
<b>Author:</b> Avi Halachmi (:avih) &lt;<a href="mailto:avihpit@yahoo.com">avihpit@yahoo.com</a>&gt;
<b>Date:</b>   Wed, 16 Oct 2019 12:55:53 +0300

OSC 52 - copy to clipboard: don&#39;t limit to 382 bytes

Strings which an application sends to the terminal in OSC, DCS, etc
are typically small (title, colors, etc) but one exception is OSC 52
which copies text to the clipboard, and is used for instance by tmux.

Previously st cropped these strings at 512 bytes, which for OSC 52
limited the copied text to 382 bytes (remaining buffer space before
base64). This made it less useful than it can be.

Now it&#39;s a dynamic growing buffer. It remains allocated after use,
resets to 512 when a new string starts, or leaked on exit.

Resetting/deallocating the buffer right after use (at strhandle) is
possible with some more code, however, it doesn&#39;t always end up used,
and to cover those cases too will require even more code, so resetting
only on new string is good enough for now.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++</span><span class="d">----</span></td></tr>
</table></pre><pre>1 file changed, 11 insertions(+), 4 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -146,7 +146,8 @@ typedef struct {
</a> /* ESC type [[ [&lt;priv&gt;] &lt;arg&gt; [;]] &lt;mode&gt;] ESC &#39;\&#39; */
 typedef struct {
 	char type;             /* ESC type ... */
<a href="#h0-0-3" id="h0-0-3" class="d">-	char buf[STR_BUF_SIZ]; /* raw string */
</a><a href="#h0-0-4" id="h0-0-4" class="i">+	char *buf;             /* allocated raw string */
</a><a href="#h0-0-5" id="h0-0-5" class="i">+	size_t siz;            /* allocation size */
</a> 	size_t len;            /* raw string length */
 	char *args[STR_ARG_SIZ];
 	int narg;              /* nb of args */
<a href="#h0-1" id="h0-1" class="h">@@ -1948,7 +1949,10 @@ strdump(void)
</a> void
 strreset(void)
 {
<a href="#h0-1-3" id="h0-1-3" class="d">-	memset(&amp;strescseq, 0, sizeof(strescseq));
</a><a href="#h0-1-4" id="h0-1-4" class="i">+	strescseq = (STREscape){
</a><a href="#h0-1-5" id="h0-1-5" class="i">+		.buf = xrealloc(strescseq.buf, STR_BUF_SIZ),
</a><a href="#h0-1-6" id="h0-1-6" class="i">+		.siz = STR_BUF_SIZ,
</a><a href="#h0-1-7" id="h0-1-7" class="i">+	};
</a> }
 
 void
<a href="#h0-2" id="h0-2" class="h">@@ -2330,7 +2334,7 @@ tputc(Rune u)
</a> 		if (term.esc&amp;ESC_DCS &amp;&amp; strescseq.len == 0 &amp;&amp; u == &#39;q&#39;)
 			term.mode |= MODE_SIXEL;
 
<a href="#h0-2-3" id="h0-2-3" class="d">-		if (strescseq.len+len &gt;= sizeof(strescseq.buf)) {
</a><a href="#h0-2-4" id="h0-2-4" class="i">+		if (strescseq.len+len &gt;= strescseq.siz) {
</a> 			/*
 			 * Here is a bug in terminals. If the user never sends
 			 * some code to stop the str or esc command, then st
<a href="#h0-3" id="h0-3" class="h">@@ -2344,7 +2348,10 @@ tputc(Rune u)
</a> 			 * term.esc = 0;
 			 * strhandle();
 			 */
<a href="#h0-3-3" id="h0-3-3" class="d">-			return;
</a><a href="#h0-3-4" id="h0-3-4" class="i">+			if (strescseq.siz &gt; (SIZE_MAX - UTF_SIZ) / 2)
</a><a href="#h0-3-5" id="h0-3-5" class="i">+				return;
</a><a href="#h0-3-6" id="h0-3-6" class="i">+			strescseq.siz *= 2;
</a><a href="#h0-3-7" id="h0-3-7" class="i">+			strescseq.buf = xrealloc(strescseq.buf, strescseq.siz);
</a> 		}
 
 		memmove(&amp;strescseq.buf[strescseq.len], c, len);
</pre>
</div>
</body>
</html>
