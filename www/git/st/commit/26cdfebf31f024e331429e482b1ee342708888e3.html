<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>x: fix XIM handling - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/26cdfebf31f024e331429e482b1ee342708888e3.html">26cdfebf31f024e331429e482b1ee342708888e3</a>
<b>parent</b> <a href="../commit/cd785755f2e3e3305c7d2556a04423a40bce060a.html">cd785755f2e3e3305c7d2556a04423a40bce060a</a>
<b>Author:</b> Quentin Rameau &lt;<a href="mailto:quinq@fifth.space">quinq@fifth.space</a>&gt;
<b>Date:</b>   Sun,  2 Feb 2020 21:47:19 +0100

x: fix XIM handling

Do not try to set specific IM method, let the user specify it with
XMODIFIERS.

If the requested method is not available or opening fails, fallback to
the default input handler and register a handler on the new IM server
availability signal.

Do the same when the input server is closed and (re)started.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">x.c</a></td><td> | </td><td class="num">68</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------</span></td></tr>
</table></pre><pre>1 file changed, 44 insertions(+), 24 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/x.c.html">x.c</a> b/<a href="../file/x.c.html">x.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -146,9 +146,10 @@ static void xdrawglyphfontspecs(const XftGlyphFontSpec *, Glyph, int, int, int);
</a> static void xdrawglyph(Glyph, int, int);
 static void xclear(int, int, int, int);
 static int xgeommasktogravity(int);
<a href="#h0-0-3" id="h0-0-3" class="d">-static void ximopen(Display *);
</a><a href="#h0-0-4" id="h0-0-4" class="i">+static int ximopen(Display *);
</a> static void ximinstantiate(Display *, XPointer, XPointer);
 static void ximdestroy(XIM, XPointer, XPointer);
<a href="#h0-0-7" id="h0-0-7" class="i">+static int xicdestroy(XIC, XPointer, XPointer);
</a> static void xinit(int, int);
 static void cresize(int, int);
 static void xresize(int, int);
<a href="#h0-1" id="h0-1" class="h">@@ -1025,48 +1026,61 @@ xunloadfonts(void)
</a> 	xunloadfont(&amp;dc.ibfont);
 }
 
<a href="#h0-1-3" id="h0-1-3" class="d">-void
</a><a href="#h0-1-4" id="h0-1-4" class="i">+int
</a> ximopen(Display *dpy)
 {
<a href="#h0-1-7" id="h0-1-7" class="d">-	XIMCallback destroy = { .client_data = NULL, .callback = ximdestroy };
</a><a href="#h0-1-8" id="h0-1-8" class="i">+	XIMCallback imdestroy = { .client_data = NULL, .callback = ximdestroy };
</a><a href="#h0-1-9" id="h0-1-9" class="i">+	XICCallback icdestroy = { .client_data = NULL, .callback = xicdestroy };
</a> 
<a href="#h0-1-11" id="h0-1-11" class="d">-	if ((xw.ime.xim = XOpenIM(xw.dpy, NULL, NULL, NULL)) == NULL) {
</a><a href="#h0-1-12" id="h0-1-12" class="d">-		XSetLocaleModifiers(&quot;@im=local&quot;);
</a><a href="#h0-1-13" id="h0-1-13" class="d">-		if ((xw.ime.xim = XOpenIM(xw.dpy, NULL, NULL, NULL)) == NULL) {
</a><a href="#h0-1-14" id="h0-1-14" class="d">-			XSetLocaleModifiers(&quot;@im=&quot;);
</a><a href="#h0-1-15" id="h0-1-15" class="d">-			if ((xw.ime.xim = XOpenIM(xw.dpy, NULL, NULL, NULL)) == NULL)
</a><a href="#h0-1-16" id="h0-1-16" class="d">-				die(&quot;XOpenIM failed. Could not open input device.\n&quot;);
</a><a href="#h0-1-17" id="h0-1-17" class="d">-		}
</a><a href="#h0-1-18" id="h0-1-18" class="d">-	}
</a><a href="#h0-1-19" id="h0-1-19" class="d">-	if (XSetIMValues(xw.ime.xim, XNDestroyCallback, &amp;destroy, NULL) != NULL)
</a><a href="#h0-1-20" id="h0-1-20" class="d">-		die(&quot;XSetIMValues failed. Could not set input method value.\n&quot;);
</a><a href="#h0-1-21" id="h0-1-21" class="d">-	xw.xic = XCreateIC(xw.ime.xim, XNInputStyle, XIMPreeditNothing | XIMStatusNothing,
</a><a href="#h0-1-22" id="h0-1-22" class="d">-	                   XNClientWindow, xw.win, XNFocusWindow, xw.win, NULL);
</a><a href="#h0-1-23" id="h0-1-23" class="d">-	if (xw.xic == NULL)
</a><a href="#h0-1-24" id="h0-1-24" class="d">-		die(&quot;XCreateIC failed. Could not obtain input method.\n&quot;);
</a><a href="#h0-1-25" id="h0-1-25" class="i">+	xw.ime.xim = XOpenIM(xw.dpy, NULL, NULL, NULL);
</a><a href="#h0-1-26" id="h0-1-26" class="i">+	if (xw.ime.xim == NULL)
</a><a href="#h0-1-27" id="h0-1-27" class="i">+		return 0;
</a><a href="#h0-1-28" id="h0-1-28" class="i">+
</a><a href="#h0-1-29" id="h0-1-29" class="i">+	if (XSetIMValues(xw.ime.xim, XNDestroyCallback, &amp;imdestroy, NULL))
</a><a href="#h0-1-30" id="h0-1-30" class="i">+		fprintf(stderr, &quot;XSetIMValues: &quot;
</a><a href="#h0-1-31" id="h0-1-31" class="i">+		                &quot;Could not set XNDestroyCallback.\n&quot;);
</a> 
 	xw.ime.spotlist = XVaCreateNestedList(0, XNSpotLocation, &amp;xw.ime.spot,
 	                                      NULL);
<a href="#h0-1-35" id="h0-1-35" class="i">+
</a><a href="#h0-1-36" id="h0-1-36" class="i">+	if (xw.ime.xic == NULL) {
</a><a href="#h0-1-37" id="h0-1-37" class="i">+		xw.ime.xic = XCreateIC(xw.ime.xim, XNInputStyle,
</a><a href="#h0-1-38" id="h0-1-38" class="i">+		                       XIMPreeditNothing | XIMStatusNothing,
</a><a href="#h0-1-39" id="h0-1-39" class="i">+		                       XNClientWindow, xw.win,
</a><a href="#h0-1-40" id="h0-1-40" class="i">+		                       XNFocusWindow, xw.win,
</a><a href="#h0-1-41" id="h0-1-41" class="i">+		                       XNDestroyCallback, &amp;icdestroy,
</a><a href="#h0-1-42" id="h0-1-42" class="i">+		                       NULL);
</a><a href="#h0-1-43" id="h0-1-43" class="i">+	}
</a><a href="#h0-1-44" id="h0-1-44" class="i">+	if (xw.ime.xic == NULL)
</a><a href="#h0-1-45" id="h0-1-45" class="i">+		fprintf(stderr, &quot;XCreateIC: Could not create input context.\n&quot;);
</a><a href="#h0-1-46" id="h0-1-46" class="i">+
</a><a href="#h0-1-47" id="h0-1-47" class="i">+	return 1;
</a> }
 
 void
 ximinstantiate(Display *dpy, XPointer client, XPointer call)
 {
<a href="#h0-1-53" id="h0-1-53" class="d">-	ximopen(dpy);
</a><a href="#h0-1-54" id="h0-1-54" class="d">-	XUnregisterIMInstantiateCallback(xw.dpy, NULL, NULL, NULL,
</a><a href="#h0-1-55" id="h0-1-55" class="d">-					ximinstantiate, NULL);
</a><a href="#h0-1-56" id="h0-1-56" class="i">+	if (ximopen(dpy))
</a><a href="#h0-1-57" id="h0-1-57" class="i">+		XUnregisterIMInstantiateCallback(xw.dpy, NULL, NULL, NULL,
</a><a href="#h0-1-58" id="h0-1-58" class="i">+		                                 ximinstantiate, NULL);
</a> }
 
 void
 ximdestroy(XIM xim, XPointer client, XPointer call)
 {
 	xw.ime.xim = NULL;
<a href="#h0-1-65" id="h0-1-65" class="d">-	xw.ime.xic = NULL;
</a> 	XRegisterIMInstantiateCallback(xw.dpy, NULL, NULL, NULL,
<a href="#h0-1-67" id="h0-1-67" class="d">-					ximinstantiate, NULL);
</a><a href="#h0-1-68" id="h0-1-68" class="i">+	                               ximinstantiate, NULL);
</a> 	XFree(xw.ime.spotlist);
 }
 
<a href="#h0-1-72" id="h0-1-72" class="i">+int
</a><a href="#h0-1-73" id="h0-1-73" class="i">+xicdestroy(XIC xim, XPointer client, XPointer call)
</a><a href="#h0-1-74" id="h0-1-74" class="i">+{
</a><a href="#h0-1-75" id="h0-1-75" class="i">+	xw.ime.xic = NULL;
</a><a href="#h0-1-76" id="h0-1-76" class="i">+	return 1;
</a><a href="#h0-1-77" id="h0-1-77" class="i">+}
</a><a href="#h0-1-78" id="h0-1-78" class="i">+
</a> void
 xinit(int cols, int rows)
 {
<a href="#h0-2" id="h0-2" class="h">@@ -1132,7 +1146,10 @@ xinit(int cols, int rows)
</a> 	xw.draw = XftDrawCreate(xw.dpy, xw.buf, xw.vis, xw.cmap);
 
 	/* input methods */
<a href="#h0-2-3" id="h0-2-3" class="d">-	ximopen(xw.dpy);
</a><a href="#h0-2-4" id="h0-2-4" class="i">+	if (!ximopen(xw.dpy)) {
</a><a href="#h0-2-5" id="h0-2-5" class="i">+		XRegisterIMInstantiateCallback(xw.dpy, NULL, NULL, NULL,
</a><a href="#h0-2-6" id="h0-2-6" class="i">+	                                       ximinstantiate, NULL);
</a><a href="#h0-2-7" id="h0-2-7" class="i">+	}
</a> 
 	/* white cursor, black outline */
 	cursor = XCreateFontCursor(xw.dpy, mouseshape);
<a href="#h0-3" id="h0-3" class="h">@@ -1765,7 +1782,10 @@ kpress(XEvent *ev)
</a> 	if (IS_SET(MODE_KBDLOCK))
 		return;
 
<a href="#h0-3-3" id="h0-3-3" class="d">-	len = XmbLookupString(xw.ime.xic, e, buf, sizeof buf, &amp;ksym, &amp;status);
</a><a href="#h0-3-4" id="h0-3-4" class="i">+	if (xw.ime.xic)
</a><a href="#h0-3-5" id="h0-3-5" class="i">+		len = XmbLookupString(xw.ime.xic, e, buf, sizeof buf, &amp;ksym, &amp;status);
</a><a href="#h0-3-6" id="h0-3-6" class="i">+	else
</a><a href="#h0-3-7" id="h0-3-7" class="i">+		len = XLookupString(e, buf, sizeof buf, &amp;ksym, NULL);
</a> 	/* 1. shortcuts */
 	for (bp = shortcuts; bp &lt; shortcuts + LEN(shortcuts); bp++) {
 		if (ksym == bp-&gt;keysym &amp;&amp; match(bp-&gt;mod, e-&gt;state)) {
</pre>
</div>
</body>
</html>
