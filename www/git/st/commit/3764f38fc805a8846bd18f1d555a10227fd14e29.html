<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Fix tputc control code handling - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/3764f38fc805a8846bd18f1d555a10227fd14e29.html">3764f38fc805a8846bd18f1d555a10227fd14e29</a>
<b>parent</b> <a href="../commit/53105cf74fde46229912275c073f8c0f219b05bb.html">53105cf74fde46229912275c073f8c0f219b05bb</a>
<b>Author:</b> Roberto E. Vargas Caballero &lt;<a href="mailto:k0ga@shike2.com">k0ga@shike2.com</a>&gt;
<b>Date:</b>   Mon, 28 Apr 2014 18:32:09 +0200

Fix tputc control code handling

The patch 53105cf modified how control codes were detected, because
it tried to handle also C1 control codes (0x80-0x9f), that have
upper bit to 1, so they are multi byte character in utf8.
Code was checking the value of width in order to known that after
decoding the unicode point had a width of 1 byte, but it as incorrect
because this width is the columnb width.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++</span><span class="d">------------</span></td></tr>
</table></pre><pre>1 file changed, 8 insertions(+), 12 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -70,8 +70,9 @@ char *argv0;
</a> #define LEN(a)     (sizeof(a) / sizeof(a)[0])
 #define DEFAULT(a, b)     (a) = (a) ? (a) : (b)
 #define BETWEEN(x, a, b)  ((a) &lt;= (x) &amp;&amp; (x) &lt;= (b))
<a href="#h0-0-3" id="h0-0-3" class="d">-#define ISCONTROLC0(c) (BETWEEN((uchar) (c), 0, 0x1f))
</a><a href="#h0-0-4" id="h0-0-4" class="d">-#define ISCONTROLC1(c) (BETWEEN((uchar) (c), 0x80, 0x9f))
</a><a href="#h0-0-5" id="h0-0-5" class="i">+#define ISCONTROLC0(c) (BETWEEN(c, 0, 0x1f))
</a><a href="#h0-0-6" id="h0-0-6" class="i">+#define ISCONTROLC1(c) (BETWEEN(c, 0x80, 0x9f))
</a><a href="#h0-0-7" id="h0-0-7" class="i">+#define ISCONTROL(c) (ISCONTROLC0(c) || ISCONTROLC1(c))
</a> #define LIMIT(x, a, b)    (x) = (x) &lt; (a) ? (a) : (x) &gt; (b) ? (b) : (x)
 #define ATTRCMP(a, b) ((a).mode != (b).mode || (a).fg != (b).fg || (a).bg != (b).bg)
 #define IS_SET(flag) ((term.mode &amp; (flag)) != 0)
<a href="#h0-1" id="h0-1" class="h">@@ -402,7 +403,6 @@ static void ttyread(void);
</a> static void ttyresize(void);
 static void ttysend(char *, size_t);
 static void ttywrite(const char *, size_t);
<a href="#h0-1-3" id="h0-1-3" class="d">-static inline bool iscontrol(char);
</a> 
 static void xdraws(char *, Glyph, int, int, int, int);
 static void xhints(void);
<a href="#h0-2" id="h0-2" class="h">@@ -2300,17 +2300,12 @@ tputtab(int n) {
</a> 	tmoveto(x, term.c.y);
 }
 
<a href="#h0-2-3" id="h0-2-3" class="d">-static inline bool
</a><a href="#h0-2-4" id="h0-2-4" class="d">-iscontrol(char c) {
</a><a href="#h0-2-5" id="h0-2-5" class="d">-	return ISCONTROLC0(c) || ISCONTROLC1(c);
</a><a href="#h0-2-6" id="h0-2-6" class="d">-}
</a><a href="#h0-2-7" id="h0-2-7" class="d">-
</a> void
 techo(char *buf, int len) {
 	for(; len &gt; 0; buf++, len--) {
 		char c = *buf;
 
<a href="#h0-2-13" id="h0-2-13" class="d">-		if(iscontrol(c)) { /* control code */
</a><a href="#h0-2-14" id="h0-2-14" class="i">+		if(ISCONTROL(c)) { /* control code */
</a> 			if(c &amp; 0x80) {
 				c &amp;= 0x7f;
 				tputc(&quot;^&quot;, 1);
<a href="#h0-3" id="h0-3" class="h">@@ -2439,16 +2434,17 @@ tputc(char *c, int len) {
</a> 
 	if(len == 1) {
 		width = 1;
<a href="#h0-3-3" id="h0-3-3" class="d">-		ascii = *c;
</a><a href="#h0-3-4" id="h0-3-4" class="i">+		unicodep = ascii = *c;
</a> 	} else {
 		utf8decode(c, &amp;unicodep, UTF_SIZ);
 		width = wcwidth(unicodep);
<a href="#h0-3-8" id="h0-3-8" class="i">+		control = ISCONTROLC1(unicodep);
</a> 		ascii = unicodep;
 	}
 
<a href="#h0-3-12" id="h0-3-12" class="d">-	control = iscontrol(ascii) &amp;&amp; width == 1;
</a> 	if(IS_SET(MODE_PRINT))
 		tprinter(c, len);
<a href="#h0-3-15" id="h0-3-15" class="i">+	control = ISCONTROL(unicodep);
</a> 
 	/*
 	 * STR sequence must be checked before anything else
<a href="#h0-4" id="h0-4" class="h">@@ -2460,7 +2456,7 @@ tputc(char *c, int len) {
</a> 		if(width == 1 &amp;&amp;
 		   (ascii == &#39;\a&#39; || ascii == 030 ||
 		    ascii == 032  || ascii == 033 ||
<a href="#h0-4-3" id="h0-4-3" class="d">-		    ISCONTROLC1(ascii))) {
</a><a href="#h0-4-4" id="h0-4-4" class="i">+		    ISCONTROLC1(unicodep))) {
</a> 			term.esc &amp;= ~ESC_STR;
 			term.esc |= ESC_STR_END;
 		} else if(strescseq.len + len &lt; sizeof(strescseq.buf) - 1) {
</pre>
</div>
</body>
</html>
