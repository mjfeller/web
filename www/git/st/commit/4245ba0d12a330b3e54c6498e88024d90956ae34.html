<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Correctly initialize altscreen when defaultbg is not 0. - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/4245ba0d12a330b3e54c6498e88024d90956ae34.html">4245ba0d12a330b3e54c6498e88024d90956ae34</a>
<b>parent</b> <a href="../commit/f3d438b1015a031bc543bb2d65c81cc2329787d4.html">f3d438b1015a031bc543bb2d65c81cc2329787d4</a>
<b>Author:</b> Mark Edgar &lt;<a href="mailto:medgar123@gmail.com">medgar123@gmail.com</a>&gt;
<b>Date:</b>   Mon, 26 Aug 2013 00:10:47 +0200

Correctly initialize altscreen when defaultbg is not 0.

The alternate screen is not properly initialized when st starts. To see
this, set defaultbg in config.h to anything other than 0 (for example, swap
defaultfg and defaultbg), and run:

./st -e sh -c &#39;tput smcup; read&#39;

You should see that the top-left 80x24 rectangle is black (or whatever
colorname[0] is), while the rest of the screen (if any) has the desired
colorname[defaultbg] color.

The attached patch fixes this by initializing term.c.attr in tnew() before
calling tresize(). It also removes the unnecessary xcalloc() calls, which
misled me on this bug hunt since it is really tclearregion() which
initializes term.lines and term.alt in tresize().

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">config.def.h</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">st.c</a></td><td> | </td><td class="num">17</td><td><span class="i">+++</span><span class="d">--------------</span></td></tr>
</table></pre><pre>2 files changed, 6 insertions(+), 17 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config.def.h.html">config.def.h</a> b/<a href="../file/config.def.h.html">config.def.h</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -129,13 +129,13 @@ static Shortcut shortcuts[] = {
</a>  * * &lt; 0: crlf mode is disabled
  *
  * Be careful with the order of the definitons because st searchs in
<a href="#h0-0-3" id="h0-0-3" class="d">- * this table sequencially, so any XK_ANY_MOD must be in the last
</a><a href="#h0-0-4" id="h0-0-4" class="i">+ * this table sequentially, so any XK_ANY_MOD must be in the last
</a>  * position for a key.
  */
 
 /*
<a href="#h0-0-9" id="h0-0-9" class="d">- * If you want something else but the function keys of X11 (0xFF00 - 0xFFFF)
</a><a href="#h0-0-10" id="h0-0-10" class="d">- * mapped below, add them to this array.
</a><a href="#h0-0-11" id="h0-0-11" class="i">+ * If you want keys other than the X11 function keys (0xFD00 - 0xFFFF)
</a><a href="#h0-0-12" id="h0-0-12" class="i">+ * to be mapped below, add them to this array.
</a>  */
 static KeySym mappedkeys[] = { -1 };
 
<b>diff --git a/<a id="h1" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -420,7 +420,6 @@ static int isfullutf8(char *, int);
</a> static ssize_t xwrite(int, char *, size_t);
 static void *xmalloc(size_t);
 static void *xrealloc(void *, size_t);
<a href="#h1-0-3" id="h1-0-3" class="d">-static void *xcalloc(size_t, size_t);
</a> 
 static void (*handler[LASTEvent])(XEvent *) = {
 	[KeyPress] = kpress,
<a href="#h1-1" id="h1-1" class="h">@@ -509,16 +508,6 @@ xrealloc(void *p, size_t len) {
</a> 	return p;
 }
 
<a href="#h1-1-3" id="h1-1-3" class="d">-void *
</a><a href="#h1-1-4" id="h1-1-4" class="d">-xcalloc(size_t nmemb, size_t size) {
</a><a href="#h1-1-5" id="h1-1-5" class="d">-	void *p = calloc(nmemb, size);
</a><a href="#h1-1-6" id="h1-1-6" class="d">-
</a><a href="#h1-1-7" id="h1-1-7" class="d">-	if(!p)
</a><a href="#h1-1-8" id="h1-1-8" class="d">-		die(&quot;Out of memory\n&quot;);
</a><a href="#h1-1-9" id="h1-1-9" class="d">-
</a><a href="#h1-1-10" id="h1-1-10" class="d">-	return p;
</a><a href="#h1-1-11" id="h1-1-11" class="d">-}
</a><a href="#h1-1-12" id="h1-1-12" class="d">-
</a> int
 utf8decode(char *s, long *u) {
 	uchar c;
<a href="#h1-2" id="h1-2" class="h">@@ -1370,7 +1359,7 @@ treset(void) {
</a> 
 void
 tnew(int col, int row) {
<a href="#h1-2-3" id="h1-2-3" class="d">-	memset(&amp;term, 0, sizeof(Term));
</a><a href="#h1-2-4" id="h1-2-4" class="i">+	term = (Term){ .c = { .attr = { .fg = defaultfg, .bg = defaultbg } } };
</a> 	tresize(col, row);
 	term.numlock = 1;
 
<a href="#h1-3" id="h1-3" class="h">@@ -2536,8 +2525,8 @@ tresize(int col, int row) {
</a> 	/* allocate any new rows */
 	for(/* i == minrow */; i &lt; row; i++) {
 		term.dirty[i] = 1;
<a href="#h1-3-3" id="h1-3-3" class="d">-		term.line[i] = xcalloc(col, sizeof(Glyph));
</a><a href="#h1-3-4" id="h1-3-4" class="d">-		term.alt [i] = xcalloc(col, sizeof(Glyph));
</a><a href="#h1-3-5" id="h1-3-5" class="i">+		term.line[i] = xmalloc(col * sizeof(Glyph));
</a><a href="#h1-3-6" id="h1-3-6" class="i">+		term.alt[i] = xmalloc(col * sizeof(Glyph));
</a> 	}
 	if(col &gt; term.col) {
 		bp = term.tabs + term.col;
</pre>
</div>
</body>
</html>
