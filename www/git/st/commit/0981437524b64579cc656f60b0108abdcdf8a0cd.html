<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>TERM set to xterm by default (which broke a lot of stuff), better escape handling (title), and a little clean up. - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/0981437524b64579cc656f60b0108abdcdf8a0cd.html">0981437524b64579cc656f60b0108abdcdf8a0cd</a>
<b>parent</b> <a href="../commit/f2dff29a16ef0eb1a0b680cdd753471ba406e4f5.html">f2dff29a16ef0eb1a0b680cdd753471ba406e4f5</a>
<b>Author:</b> Aur√©lien Aptel &lt;<a href="mailto:aurelien.aptel@gmail.com">aurelien.aptel@gmail.com</a>&gt;
<b>Date:</b>   Wed,  3 Feb 2010 03:25:35 +0100

TERM set to xterm by default (which broke a lot of stuff), better escape handling (title), and a little clean up.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">389</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
</table></pre><pre>1 file changed, 190 insertions(+), 199 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -20,11 +20,12 @@
</a> #include &lt;X11/keysym.h&gt;
 #include &lt;X11/Xutil.h&gt;
 
<a href="#h0-0-3" id="h0-0-3" class="d">-#define TNAME &quot;st&quot;
</a><a href="#h0-0-4" id="h0-0-4" class="i">+#define TNAME &quot;xterm&quot;
</a> 
 /* Arbitrary sizes */
<a href="#h0-0-7" id="h0-0-7" class="i">+#define TITLESIZ 256
</a> #define ESCSIZ 256
<a href="#h0-0-9" id="h0-0-9" class="d">-#define ESCARG 16
</a><a href="#h0-0-10" id="h0-0-10" class="i">+#define ESCARGSIZ 16
</a> #define MAXDRAWBUF 1024
 
 #define SERRNO strerror(errno)
<a href="#h0-1" id="h0-1" class="h">@@ -40,7 +41,8 @@
</a> enum { ATnone=0 , ATreverse=1 , ATunderline=2, ATbold=4 };
 enum { CSup, CSdown, CSright, CSleft, CShide, CSdraw, CSwrap, CSsave, CSload };
 enum { CRset=1, CRupdate=2 };
<a href="#h0-1-3" id="h0-1-3" class="d">-enum { TMwrap=1, TMinsert=2 };
</a><a href="#h0-1-4" id="h0-1-4" class="i">+enum { TMwrap=1, TMinsert=2, TMtitle=4 };
</a><a href="#h0-1-5" id="h0-1-5" class="i">+enum { ESCin = 1, ESCcsi = 2, ESCosc = 4, ESCtitle = 8 };
</a> enum { SCupdate, SCredraw };
 
 typedef int Color;
<a href="#h0-2" id="h0-2" class="h">@@ -62,17 +64,16 @@ typedef struct {
</a> 	int y;
 } TCursor;
 
<a href="#h0-2-3" id="h0-2-3" class="d">-/* Escape sequence structs */
</a><a href="#h0-2-4" id="h0-2-4" class="d">-/* ESC &lt;pre&gt; [[ [&lt;priv&gt;] &lt;arg&gt; [;]] &lt;mode&gt;] */
</a><a href="#h0-2-5" id="h0-2-5" class="i">+/* CSI Escape sequence structs */
</a><a href="#h0-2-6" id="h0-2-6" class="i">+/* ESC &#39;[&#39; [[ [&lt;priv&gt;] &lt;arg&gt; [;]] &lt;mode&gt;] */
</a> typedef struct {
<a href="#h0-2-8" id="h0-2-8" class="d">-	char buf[ESCSIZ+1]; /* raw string */
</a><a href="#h0-2-9" id="h0-2-9" class="i">+	char buf[ESCSIZ]; /* raw string */
</a> 	int len;            /* raw string length */
<a href="#h0-2-11" id="h0-2-11" class="d">-	char pre;           
</a> 	char priv;
<a href="#h0-2-13" id="h0-2-13" class="d">-	int arg[ESCARG+1];
</a><a href="#h0-2-14" id="h0-2-14" class="i">+	int arg[ESCARGSIZ];
</a> 	int narg;           /* nb of args */
 	char mode;
<a href="#h0-2-17" id="h0-2-17" class="d">-} Escseq;
</a><a href="#h0-2-18" id="h0-2-18" class="i">+} CSIEscape;
</a> 
 /* Internal representation of the screen */
 typedef struct {
<a href="#h0-3" id="h0-3" class="h">@@ -83,6 +84,9 @@ typedef struct {
</a> 	int top;    /* top    scroll limit */
 	int bot;    /* bottom scroll limit */
 	int mode;   /* terminal mode */
<a href="#h0-3-3" id="h0-3-3" class="i">+	int esc;
</a><a href="#h0-3-4" id="h0-3-4" class="i">+	char title[TITLESIZ];
</a><a href="#h0-3-5" id="h0-3-5" class="i">+	int titlelen;
</a> } Term;
 
 /* Purely graphic info */
<a href="#h0-4" id="h0-4" class="h">@@ -116,12 +120,10 @@ static void execsh(void);
</a> static void sigchld(int);
 static void run(void);
 
<a href="#h0-4-3" id="h0-4-3" class="d">-static int escaddc(char);
</a><a href="#h0-4-4" id="h0-4-4" class="d">-static int escfinal(char);
</a><a href="#h0-4-5" id="h0-4-5" class="d">-static void escdump(void);
</a><a href="#h0-4-6" id="h0-4-6" class="d">-static void eschandle(void);
</a><a href="#h0-4-7" id="h0-4-7" class="d">-static void escparse(void);
</a><a href="#h0-4-8" id="h0-4-8" class="d">-static void escreset(void);
</a><a href="#h0-4-9" id="h0-4-9" class="i">+static void csidump(void);
</a><a href="#h0-4-10" id="h0-4-10" class="i">+static void csihandle(void);
</a><a href="#h0-4-11" id="h0-4-11" class="i">+static void csiparse(void);
</a><a href="#h0-4-12" id="h0-4-12" class="i">+static void csireset(void);
</a> 
 static void tclearregion(int, int, int, int);
 static void tcpos(int);
<a href="#h0-5" id="h0-5" class="h">@@ -168,7 +170,7 @@ static void (*handler[LASTEvent])(XEvent *) = {
</a> static DC dc;
 static XWindow xw;
 static Term term;
<a href="#h0-5-3" id="h0-5-3" class="d">-static Escseq escseq;
</a><a href="#h0-5-4" id="h0-5-4" class="i">+static CSIEscape escseq;
</a> static int cmdfd;
 static pid_t pid;
 static int running;
<a href="#h0-6" id="h0-6" class="h">@@ -269,7 +271,7 @@ ttynew(void) {
</a> void
 dump(char c) {
 	static int col;
<a href="#h0-6-3" id="h0-6-3" class="d">-	fprintf(stderr, &quot; %02x %c &quot;, c, isprint(c)?c:&#39;.&#39;);
</a><a href="#h0-6-4" id="h0-6-4" class="i">+	fprintf(stderr, &quot; %02x &#39;%c&#39; &quot;, c, isprint(c)?c:&#39;.&#39;);
</a> 	if(++col % 10 == 0)
 		fprintf(stderr, &quot;\n&quot;);
 }
<a href="#h0-7" id="h0-7" class="h">@@ -305,24 +307,6 @@ ttyresize(int x, int y) {
</a> 		fprintf(stderr, &quot;Couldn&#39;t set window size: %s\n&quot;, SERRNO);
 }
 
<a href="#h0-7-3" id="h0-7-3" class="d">-int
</a><a href="#h0-7-4" id="h0-7-4" class="d">-escfinal(char c) {
</a><a href="#h0-7-5" id="h0-7-5" class="d">-	if(escseq.len == 1)
</a><a href="#h0-7-6" id="h0-7-6" class="d">-		switch(c) {
</a><a href="#h0-7-7" id="h0-7-7" class="d">-		case &#39;[&#39;:
</a><a href="#h0-7-8" id="h0-7-8" class="d">-		case &#39;]&#39;:
</a><a href="#h0-7-9" id="h0-7-9" class="d">-		case &#39;(&#39;:
</a><a href="#h0-7-10" id="h0-7-10" class="d">-			return 0;
</a><a href="#h0-7-11" id="h0-7-11" class="d">-		case &#39;=&#39;:
</a><a href="#h0-7-12" id="h0-7-12" class="d">-		case &#39;&gt;&#39;:
</a><a href="#h0-7-13" id="h0-7-13" class="d">-		default:
</a><a href="#h0-7-14" id="h0-7-14" class="d">-			return 1;
</a><a href="#h0-7-15" id="h0-7-15" class="d">-		}
</a><a href="#h0-7-16" id="h0-7-16" class="d">-	else if(BETWEEN(c, 0x40, 0x7E))
</a><a href="#h0-7-17" id="h0-7-17" class="d">-		return 1;
</a><a href="#h0-7-18" id="h0-7-18" class="d">-	return 0;	  
</a><a href="#h0-7-19" id="h0-7-19" class="d">-}
</a><a href="#h0-7-20" id="h0-7-20" class="d">-
</a> void
 tcpos(int mode) {
 	static int x = 0;
<a href="#h0-8" id="h0-8" class="h">@@ -372,44 +356,27 @@ tnewline(void) {
</a> 	tmoveto(0, y);
 }
 
<a href="#h0-8-3" id="h0-8-3" class="d">-int
</a><a href="#h0-8-4" id="h0-8-4" class="d">-escaddc(char c) {
</a><a href="#h0-8-5" id="h0-8-5" class="d">-	escseq.buf[escseq.len++] = c;
</a><a href="#h0-8-6" id="h0-8-6" class="d">-	if(escfinal(c) || escseq.len &gt;= ESCSIZ) {
</a><a href="#h0-8-7" id="h0-8-7" class="d">-		escparse(), eschandle();
</a><a href="#h0-8-8" id="h0-8-8" class="d">-		return 0;
</a><a href="#h0-8-9" id="h0-8-9" class="d">-	}
</a><a href="#h0-8-10" id="h0-8-10" class="d">-	return 1;
</a><a href="#h0-8-11" id="h0-8-11" class="d">-}
</a><a href="#h0-8-12" id="h0-8-12" class="d">-
</a> void
<a href="#h0-8-14" id="h0-8-14" class="d">-escparse(void) {
</a><a href="#h0-8-15" id="h0-8-15" class="i">+csiparse(void) {
</a> 	/* int noarg = 1; */
 	char *p = escseq.buf;
 
 	escseq.narg = 0;
<a href="#h0-8-20" id="h0-8-20" class="d">-	switch(escseq.pre = *p++) {
</a><a href="#h0-8-21" id="h0-8-21" class="d">-	case &#39;[&#39;: /* CSI */
</a><a href="#h0-8-22" id="h0-8-22" class="d">-		if(*p == &#39;?&#39;)
</a><a href="#h0-8-23" id="h0-8-23" class="d">-			escseq.priv = 1, p++;
</a><a href="#h0-8-24" id="h0-8-24" class="d">-
</a><a href="#h0-8-25" id="h0-8-25" class="d">-		while(p &lt; escseq.buf+escseq.len) {
</a><a href="#h0-8-26" id="h0-8-26" class="d">-			while(isdigit(*p)) {
</a><a href="#h0-8-27" id="h0-8-27" class="d">-				escseq.arg[escseq.narg] *= 10;
</a><a href="#h0-8-28" id="h0-8-28" class="d">-				escseq.arg[escseq.narg] += *(p++) - &#39;0&#39;/*, noarg = 0 */;
</a><a href="#h0-8-29" id="h0-8-29" class="d">-			}
</a><a href="#h0-8-30" id="h0-8-30" class="d">-			if(*p == &#39;;&#39;)
</a><a href="#h0-8-31" id="h0-8-31" class="d">-				escseq.narg++, p++;
</a><a href="#h0-8-32" id="h0-8-32" class="d">-			else {
</a><a href="#h0-8-33" id="h0-8-33" class="d">-				escseq.mode = *p;
</a><a href="#h0-8-34" id="h0-8-34" class="d">-				escseq.narg++;
</a><a href="#h0-8-35" id="h0-8-35" class="d">-				return;
</a><a href="#h0-8-36" id="h0-8-36" class="d">-			}
</a><a href="#h0-8-37" id="h0-8-37" class="i">+	if(*p == &#39;?&#39;)
</a><a href="#h0-8-38" id="h0-8-38" class="i">+		escseq.priv = 1, p++;
</a><a href="#h0-8-39" id="h0-8-39" class="i">+	
</a><a href="#h0-8-40" id="h0-8-40" class="i">+	while(p &lt; escseq.buf+escseq.len) {
</a><a href="#h0-8-41" id="h0-8-41" class="i">+		while(isdigit(*p)) {
</a><a href="#h0-8-42" id="h0-8-42" class="i">+			escseq.arg[escseq.narg] *= 10;
</a><a href="#h0-8-43" id="h0-8-43" class="i">+			escseq.arg[escseq.narg] += *p++ - &#39;0&#39;/*, noarg = 0 */;
</a><a href="#h0-8-44" id="h0-8-44" class="i">+		}
</a><a href="#h0-8-45" id="h0-8-45" class="i">+		if(*p == &#39;;&#39; &amp;&amp; escseq.narg+1 &lt; ESCARGSIZ)
</a><a href="#h0-8-46" id="h0-8-46" class="i">+			escseq.narg++, p++;
</a><a href="#h0-8-47" id="h0-8-47" class="i">+		else {
</a><a href="#h0-8-48" id="h0-8-48" class="i">+			escseq.mode = *p;
</a><a href="#h0-8-49" id="h0-8-49" class="i">+			escseq.narg++;
</a><a href="#h0-8-50" id="h0-8-50" class="i">+			return;
</a> 		}
<a href="#h0-8-52" id="h0-8-52" class="d">-		break;
</a><a href="#h0-8-53" id="h0-8-53" class="d">-	case &#39;(&#39;:
</a><a href="#h0-8-54" id="h0-8-54" class="d">-		/* XXX: graphic character set */
</a><a href="#h0-8-55" id="h0-8-55" class="d">-		break;
</a> 	}
 }
 
<a href="#h0-9" id="h0-9" class="h">@@ -625,146 +592,141 @@ tsetscroll(int t, int b) {
</a> }
 
 void
<a href="#h0-9-3" id="h0-9-3" class="d">-eschandle(void) {
</a><a href="#h0-9-4" id="h0-9-4" class="d">-	switch(escseq.pre) {
</a><a href="#h0-9-5" id="h0-9-5" class="i">+csihandle(void) {
</a><a href="#h0-9-6" id="h0-9-6" class="i">+	switch(escseq.mode) {
</a> 	default:
<a href="#h0-9-8" id="h0-9-8" class="d">-		goto unknown_seq;
</a><a href="#h0-9-9" id="h0-9-9" class="d">-	case &#39;[&#39;:
</a><a href="#h0-9-10" id="h0-9-10" class="d">-		switch(escseq.mode) {
</a><a href="#h0-9-11" id="h0-9-11" class="d">-		default:
</a><a href="#h0-9-12" id="h0-9-12" class="d">-		unknown_seq:
</a><a href="#h0-9-13" id="h0-9-13" class="d">-			fprintf(stderr, &quot;erresc: unknown sequence\n&quot;);
</a><a href="#h0-9-14" id="h0-9-14" class="d">-			escdump();
</a><a href="#h0-9-15" id="h0-9-15" class="d">-			break;
</a><a href="#h0-9-16" id="h0-9-16" class="d">-		case &#39;@&#39;: /* Insert &lt;n&gt; blank char */
</a><a href="#h0-9-17" id="h0-9-17" class="d">-			DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-18" id="h0-9-18" class="d">-			tinsertblank(escseq.arg[0]);
</a><a href="#h0-9-19" id="h0-9-19" class="d">-			break;
</a><a href="#h0-9-20" id="h0-9-20" class="d">-		case &#39;A&#39;: /* Cursor &lt;n&gt; Up */
</a><a href="#h0-9-21" id="h0-9-21" class="d">-		case &#39;e&#39;:
</a><a href="#h0-9-22" id="h0-9-22" class="d">-			DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-23" id="h0-9-23" class="d">-			tmoveto(term.c.x, term.c.y-escseq.arg[0]);
</a><a href="#h0-9-24" id="h0-9-24" class="d">-			break;
</a><a href="#h0-9-25" id="h0-9-25" class="d">-		case &#39;B&#39;: /* Cursor &lt;n&gt; Down */
</a><a href="#h0-9-26" id="h0-9-26" class="d">-			DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-27" id="h0-9-27" class="d">-			tmoveto(term.c.x, term.c.y+escseq.arg[0]);
</a><a href="#h0-9-28" id="h0-9-28" class="d">-			break;
</a><a href="#h0-9-29" id="h0-9-29" class="d">-		case &#39;C&#39;: /* Cursor &lt;n&gt; Forward */
</a><a href="#h0-9-30" id="h0-9-30" class="d">-		case &#39;a&#39;:
</a><a href="#h0-9-31" id="h0-9-31" class="d">-			DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-32" id="h0-9-32" class="d">-			tmoveto(term.c.x+escseq.arg[0], term.c.y);
</a><a href="#h0-9-33" id="h0-9-33" class="d">-			break;
</a><a href="#h0-9-34" id="h0-9-34" class="d">-		case &#39;D&#39;: /* Cursor &lt;n&gt; Backward */
</a><a href="#h0-9-35" id="h0-9-35" class="d">-			DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-36" id="h0-9-36" class="d">-			tmoveto(term.c.x-escseq.arg[0], term.c.y);
</a><a href="#h0-9-37" id="h0-9-37" class="d">-			break;
</a><a href="#h0-9-38" id="h0-9-38" class="d">-		case &#39;E&#39;: /* Cursor &lt;n&gt; Down and first col */
</a><a href="#h0-9-39" id="h0-9-39" class="d">-			DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-40" id="h0-9-40" class="d">-			tmoveto(0, term.c.y+escseq.arg[0]);
</a><a href="#h0-9-41" id="h0-9-41" class="d">-			break;
</a><a href="#h0-9-42" id="h0-9-42" class="d">-		case &#39;F&#39;: /* Cursor &lt;n&gt; Up and first col */
</a><a href="#h0-9-43" id="h0-9-43" class="d">-			DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-44" id="h0-9-44" class="d">-			tmoveto(0, term.c.y-escseq.arg[0]);
</a><a href="#h0-9-45" id="h0-9-45" class="d">-			break;
</a><a href="#h0-9-46" id="h0-9-46" class="d">-		case &#39;G&#39;: /* Move to &lt;col&gt; */
</a><a href="#h0-9-47" id="h0-9-47" class="d">-		case &#39;`&#39;:
</a><a href="#h0-9-48" id="h0-9-48" class="d">-			DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-49" id="h0-9-49" class="d">-			tmoveto(escseq.arg[0]-1, term.c.y);
</a><a href="#h0-9-50" id="h0-9-50" class="i">+		fprintf(stderr, &quot;erresc: unknown sequence\n&quot;);
</a><a href="#h0-9-51" id="h0-9-51" class="i">+		csidump();
</a><a href="#h0-9-52" id="h0-9-52" class="i">+		/* die(&quot;&quot;); */
</a><a href="#h0-9-53" id="h0-9-53" class="i">+		break;
</a><a href="#h0-9-54" id="h0-9-54" class="i">+	case &#39;@&#39;: /* Insert &lt;n&gt; blank char */
</a><a href="#h0-9-55" id="h0-9-55" class="i">+		DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-56" id="h0-9-56" class="i">+		tinsertblank(escseq.arg[0]);
</a><a href="#h0-9-57" id="h0-9-57" class="i">+		break;
</a><a href="#h0-9-58" id="h0-9-58" class="i">+	case &#39;A&#39;: /* Cursor &lt;n&gt; Up */
</a><a href="#h0-9-59" id="h0-9-59" class="i">+	case &#39;e&#39;:
</a><a href="#h0-9-60" id="h0-9-60" class="i">+		DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-61" id="h0-9-61" class="i">+		tmoveto(term.c.x, term.c.y-escseq.arg[0]);
</a><a href="#h0-9-62" id="h0-9-62" class="i">+		break;
</a><a href="#h0-9-63" id="h0-9-63" class="i">+	case &#39;B&#39;: /* Cursor &lt;n&gt; Down */
</a><a href="#h0-9-64" id="h0-9-64" class="i">+		DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-65" id="h0-9-65" class="i">+		tmoveto(term.c.x, term.c.y+escseq.arg[0]);
</a><a href="#h0-9-66" id="h0-9-66" class="i">+		break;
</a><a href="#h0-9-67" id="h0-9-67" class="i">+	case &#39;C&#39;: /* Cursor &lt;n&gt; Forward */
</a><a href="#h0-9-68" id="h0-9-68" class="i">+	case &#39;a&#39;:
</a><a href="#h0-9-69" id="h0-9-69" class="i">+		DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-70" id="h0-9-70" class="i">+		tmoveto(term.c.x+escseq.arg[0], term.c.y);
</a><a href="#h0-9-71" id="h0-9-71" class="i">+		break;
</a><a href="#h0-9-72" id="h0-9-72" class="i">+	case &#39;D&#39;: /* Cursor &lt;n&gt; Backward */
</a><a href="#h0-9-73" id="h0-9-73" class="i">+		DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-74" id="h0-9-74" class="i">+		tmoveto(term.c.x-escseq.arg[0], term.c.y);
</a><a href="#h0-9-75" id="h0-9-75" class="i">+		break;
</a><a href="#h0-9-76" id="h0-9-76" class="i">+	case &#39;E&#39;: /* Cursor &lt;n&gt; Down and first col */
</a><a href="#h0-9-77" id="h0-9-77" class="i">+		DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-78" id="h0-9-78" class="i">+		tmoveto(0, term.c.y+escseq.arg[0]);
</a><a href="#h0-9-79" id="h0-9-79" class="i">+		break;
</a><a href="#h0-9-80" id="h0-9-80" class="i">+	case &#39;F&#39;: /* Cursor &lt;n&gt; Up and first col */
</a><a href="#h0-9-81" id="h0-9-81" class="i">+		DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-82" id="h0-9-82" class="i">+		tmoveto(0, term.c.y-escseq.arg[0]);
</a><a href="#h0-9-83" id="h0-9-83" class="i">+		break;
</a><a href="#h0-9-84" id="h0-9-84" class="i">+	case &#39;G&#39;: /* Move to &lt;col&gt; */
</a><a href="#h0-9-85" id="h0-9-85" class="i">+	case &#39;`&#39;:
</a><a href="#h0-9-86" id="h0-9-86" class="i">+		DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-87" id="h0-9-87" class="i">+     	tmoveto(escseq.arg[0]-1, term.c.y);
</a><a href="#h0-9-88" id="h0-9-88" class="i">+		break;
</a><a href="#h0-9-89" id="h0-9-89" class="i">+	case &#39;H&#39;: /* Move to &lt;row&gt; &lt;col&gt; */
</a><a href="#h0-9-90" id="h0-9-90" class="i">+	case &#39;f&#39;:
</a><a href="#h0-9-91" id="h0-9-91" class="i">+		DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-92" id="h0-9-92" class="i">+		DEFAULT(escseq.arg[1], 1);
</a><a href="#h0-9-93" id="h0-9-93" class="i">+		tmoveto(escseq.arg[1]-1, escseq.arg[0]-1);
</a><a href="#h0-9-94" id="h0-9-94" class="i">+		break;
</a><a href="#h0-9-95" id="h0-9-95" class="i">+	case &#39;J&#39;: /* Clear screen */
</a><a href="#h0-9-96" id="h0-9-96" class="i">+		switch(escseq.arg[0]) {
</a><a href="#h0-9-97" id="h0-9-97" class="i">+		case 0: /* below */
</a><a href="#h0-9-98" id="h0-9-98" class="i">+			tclearregion(term.c.x, term.c.y, term.col-1, term.row-1);
</a> 			break;
<a href="#h0-9-100" id="h0-9-100" class="d">-		case &#39;H&#39;: /* Move to &lt;row&gt; &lt;col&gt; */
</a><a href="#h0-9-101" id="h0-9-101" class="d">-		case &#39;f&#39;:
</a><a href="#h0-9-102" id="h0-9-102" class="d">-			DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-103" id="h0-9-103" class="d">-			DEFAULT(escseq.arg[1], 1);
</a><a href="#h0-9-104" id="h0-9-104" class="d">-			tmoveto(escseq.arg[1]-1, escseq.arg[0]-1);
</a><a href="#h0-9-105" id="h0-9-105" class="i">+		case 1: /* above */
</a><a href="#h0-9-106" id="h0-9-106" class="i">+			tclearregion(0, 0, term.c.x, term.c.y);
</a> 			break;
<a href="#h0-9-108" id="h0-9-108" class="d">-		case &#39;J&#39;: /* Clear screen */
</a><a href="#h0-9-109" id="h0-9-109" class="d">-			switch(escseq.arg[0]) {
</a><a href="#h0-9-110" id="h0-9-110" class="d">-			case 0: /* below */
</a><a href="#h0-9-111" id="h0-9-111" class="d">-				tclearregion(term.c.x, term.c.y, term.col-1, term.row-1);
</a><a href="#h0-9-112" id="h0-9-112" class="d">-				break;
</a><a href="#h0-9-113" id="h0-9-113" class="d">-			case 1: /* above */
</a><a href="#h0-9-114" id="h0-9-114" class="d">-				tclearregion(0, 0, term.c.x, term.c.y);
</a><a href="#h0-9-115" id="h0-9-115" class="d">-				break;
</a><a href="#h0-9-116" id="h0-9-116" class="d">-			case 2: /* all */
</a><a href="#h0-9-117" id="h0-9-117" class="d">-				tclearregion(0, 0, term.col-1, term.row-1);
</a><a href="#h0-9-118" id="h0-9-118" class="d">-				break;				  
</a><a href="#h0-9-119" id="h0-9-119" class="d">-			}
</a><a href="#h0-9-120" id="h0-9-120" class="i">+		case 2: /* all */
</a><a href="#h0-9-121" id="h0-9-121" class="i">+			tclearregion(0, 0, term.col-1, term.row-1);
</a><a href="#h0-9-122" id="h0-9-122" class="i">+			break;				  
</a><a href="#h0-9-123" id="h0-9-123" class="i">+		}
</a><a href="#h0-9-124" id="h0-9-124" class="i">+		break;
</a><a href="#h0-9-125" id="h0-9-125" class="i">+	case &#39;K&#39;: /* Clear line */
</a><a href="#h0-9-126" id="h0-9-126" class="i">+		switch(escseq.arg[0]) {
</a><a href="#h0-9-127" id="h0-9-127" class="i">+		case 0: /* right */
</a><a href="#h0-9-128" id="h0-9-128" class="i">+			tclearregion(term.c.x, term.c.y, term.col-1, term.c.y);
</a> 			break;
<a href="#h0-9-130" id="h0-9-130" class="d">-		case &#39;K&#39;: /* Clear line */
</a><a href="#h0-9-131" id="h0-9-131" class="d">-			switch(escseq.arg[0]) {
</a><a href="#h0-9-132" id="h0-9-132" class="d">-			case 0: /* right */
</a><a href="#h0-9-133" id="h0-9-133" class="d">-				tclearregion(term.c.x, term.c.y, term.col-1, term.c.y);
</a><a href="#h0-9-134" id="h0-9-134" class="d">-				break;
</a><a href="#h0-9-135" id="h0-9-135" class="d">-			case 1: /* left */
</a><a href="#h0-9-136" id="h0-9-136" class="d">-				tclearregion(0, term.c.y, term.c.x, term.c.y);
</a><a href="#h0-9-137" id="h0-9-137" class="d">-				break;
</a><a href="#h0-9-138" id="h0-9-138" class="d">-			case 2: /* all */
</a><a href="#h0-9-139" id="h0-9-139" class="d">-				tclearregion(0, term.c.y, term.col-1, term.c.y);
</a><a href="#h0-9-140" id="h0-9-140" class="d">-				break;
</a><a href="#h0-9-141" id="h0-9-141" class="d">-			}
</a><a href="#h0-9-142" id="h0-9-142" class="i">+		case 1: /* left */
</a><a href="#h0-9-143" id="h0-9-143" class="i">+			tclearregion(0, term.c.y, term.c.x, term.c.y);
</a> 			break;
<a href="#h0-9-145" id="h0-9-145" class="d">-		case &#39;L&#39;: /* Insert &lt;n&gt; blank lines */
</a><a href="#h0-9-146" id="h0-9-146" class="d">-			DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-147" id="h0-9-147" class="d">-			tinsertblankline(escseq.arg[0]);
</a><a href="#h0-9-148" id="h0-9-148" class="i">+		case 2: /* all */
</a><a href="#h0-9-149" id="h0-9-149" class="i">+			tclearregion(0, term.c.y, term.col-1, term.c.y);
</a> 			break;
<a href="#h0-9-151" id="h0-9-151" class="d">-		case &#39;l&#39;:
</a><a href="#h0-9-152" id="h0-9-152" class="d">-			if(escseq.priv &amp;&amp; escseq.arg[0] == 25)
</a><a href="#h0-9-153" id="h0-9-153" class="i">+		}
</a><a href="#h0-9-154" id="h0-9-154" class="i">+		break;
</a><a href="#h0-9-155" id="h0-9-155" class="i">+	case &#39;S&#39;:
</a><a href="#h0-9-156" id="h0-9-156" class="i">+	case &#39;L&#39;: /* Insert &lt;n&gt; blank lines */
</a><a href="#h0-9-157" id="h0-9-157" class="i">+		DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-158" id="h0-9-158" class="i">+		tinsertblankline(escseq.arg[0]);
</a><a href="#h0-9-159" id="h0-9-159" class="i">+		break;
</a><a href="#h0-9-160" id="h0-9-160" class="i">+	case &#39;l&#39;:
</a><a href="#h0-9-161" id="h0-9-161" class="i">+		if(escseq.priv &amp;&amp; escseq.arg[0] == 25)
</a> 				term.c.hidden = 1;
<a href="#h0-9-163" id="h0-9-163" class="d">-			break;
</a><a href="#h0-9-164" id="h0-9-164" class="d">-		case &#39;M&#39;: /* Delete &lt;n&gt; lines */
</a><a href="#h0-9-165" id="h0-9-165" class="d">-			DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-166" id="h0-9-166" class="d">-			tdeleteline(escseq.arg[0]);
</a><a href="#h0-9-167" id="h0-9-167" class="d">-			break;
</a><a href="#h0-9-168" id="h0-9-168" class="d">-		case &#39;P&#39;: /* Delete &lt;n&gt; char */
</a><a href="#h0-9-169" id="h0-9-169" class="d">-			DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-170" id="h0-9-170" class="d">-			tdeletechar(escseq.arg[0]);
</a><a href="#h0-9-171" id="h0-9-171" class="d">-			break;
</a><a href="#h0-9-172" id="h0-9-172" class="d">-		case &#39;d&#39;: /* Move to &lt;row&gt; */
</a><a href="#h0-9-173" id="h0-9-173" class="i">+		break;
</a><a href="#h0-9-174" id="h0-9-174" class="i">+	case &#39;M&#39;: /* Delete &lt;n&gt; lines */
</a><a href="#h0-9-175" id="h0-9-175" class="i">+		DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-176" id="h0-9-176" class="i">+		tdeleteline(escseq.arg[0]);
</a><a href="#h0-9-177" id="h0-9-177" class="i">+		break;
</a><a href="#h0-9-178" id="h0-9-178" class="i">+	case &#39;X&#39;:
</a><a href="#h0-9-179" id="h0-9-179" class="i">+	case &#39;P&#39;: /* Delete &lt;n&gt; char */
</a><a href="#h0-9-180" id="h0-9-180" class="i">+		DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-181" id="h0-9-181" class="i">+		tdeletechar(escseq.arg[0]);
</a><a href="#h0-9-182" id="h0-9-182" class="i">+		break;
</a><a href="#h0-9-183" id="h0-9-183" class="i">+	case &#39;d&#39;: /* Move to &lt;row&gt; */
</a><a href="#h0-9-184" id="h0-9-184" class="i">+		DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-185" id="h0-9-185" class="i">+		tmoveto(term.c.x, escseq.arg[0]-1);
</a><a href="#h0-9-186" id="h0-9-186" class="i">+		break;
</a><a href="#h0-9-187" id="h0-9-187" class="i">+	case &#39;h&#39;: /* Set terminal mode */
</a><a href="#h0-9-188" id="h0-9-188" class="i">+		if(escseq.priv &amp;&amp; escseq.arg[0] == 25)
</a><a href="#h0-9-189" id="h0-9-189" class="i">+			term.c.hidden = 0;
</a><a href="#h0-9-190" id="h0-9-190" class="i">+		break;
</a><a href="#h0-9-191" id="h0-9-191" class="i">+	case &#39;m&#39;: /* Terminal attribute (color) */
</a><a href="#h0-9-192" id="h0-9-192" class="i">+		tsetattr(escseq.arg, escseq.narg);
</a><a href="#h0-9-193" id="h0-9-193" class="i">+		break;
</a><a href="#h0-9-194" id="h0-9-194" class="i">+	case &#39;r&#39;:
</a><a href="#h0-9-195" id="h0-9-195" class="i">+		if(escseq.priv)
</a><a href="#h0-9-196" id="h0-9-196" class="i">+			;
</a><a href="#h0-9-197" id="h0-9-197" class="i">+		else {
</a> 			DEFAULT(escseq.arg[0], 1);
<a href="#h0-9-199" id="h0-9-199" class="d">-			tmoveto(term.c.x, escseq.arg[0]-1);
</a><a href="#h0-9-200" id="h0-9-200" class="d">-			break;
</a><a href="#h0-9-201" id="h0-9-201" class="d">-		case &#39;h&#39;: /* Set terminal mode */
</a><a href="#h0-9-202" id="h0-9-202" class="d">-			if(escseq.priv &amp;&amp; escseq.arg[0] == 25)
</a><a href="#h0-9-203" id="h0-9-203" class="d">-				term.c.hidden = 0;
</a><a href="#h0-9-204" id="h0-9-204" class="d">-			break;
</a><a href="#h0-9-205" id="h0-9-205" class="d">-		case &#39;m&#39;: /* Terminal attribute (color) */
</a><a href="#h0-9-206" id="h0-9-206" class="d">-			tsetattr(escseq.arg, escseq.narg);
</a><a href="#h0-9-207" id="h0-9-207" class="d">-			break;
</a><a href="#h0-9-208" id="h0-9-208" class="d">-		case &#39;r&#39;:
</a><a href="#h0-9-209" id="h0-9-209" class="d">-			if(escseq.priv)
</a><a href="#h0-9-210" id="h0-9-210" class="d">-				;
</a><a href="#h0-9-211" id="h0-9-211" class="d">-			else {
</a><a href="#h0-9-212" id="h0-9-212" class="d">-				DEFAULT(escseq.arg[0], 1);
</a><a href="#h0-9-213" id="h0-9-213" class="d">-				DEFAULT(escseq.arg[1], term.row);
</a><a href="#h0-9-214" id="h0-9-214" class="d">-				tsetscroll(escseq.arg[0]-1, escseq.arg[1]-1);
</a><a href="#h0-9-215" id="h0-9-215" class="d">-			}
</a><a href="#h0-9-216" id="h0-9-216" class="d">-			break;
</a><a href="#h0-9-217" id="h0-9-217" class="d">-		case &#39;s&#39;: /* Save cursor position */
</a><a href="#h0-9-218" id="h0-9-218" class="d">-			tcpos(CSsave);
</a><a href="#h0-9-219" id="h0-9-219" class="d">-			break;
</a><a href="#h0-9-220" id="h0-9-220" class="d">-		case &#39;u&#39;: /* Load cursor position */
</a><a href="#h0-9-221" id="h0-9-221" class="d">-			tcpos(CSload);
</a><a href="#h0-9-222" id="h0-9-222" class="d">-			break;
</a><a href="#h0-9-223" id="h0-9-223" class="i">+			DEFAULT(escseq.arg[1], term.row);
</a><a href="#h0-9-224" id="h0-9-224" class="i">+			tsetscroll(escseq.arg[0]-1, escseq.arg[1]-1);
</a> 		}
 		break;
<a href="#h0-9-227" id="h0-9-227" class="i">+	case &#39;s&#39;: /* Save cursor position */
</a><a href="#h0-9-228" id="h0-9-228" class="i">+		tcpos(CSsave);
</a><a href="#h0-9-229" id="h0-9-229" class="i">+		break;
</a><a href="#h0-9-230" id="h0-9-230" class="i">+	case &#39;u&#39;: /* Load cursor position */
</a><a href="#h0-9-231" id="h0-9-231" class="i">+		tcpos(CSload);
</a><a href="#h0-9-232" id="h0-9-232" class="i">+		break;
</a> 	}
 }
 
 void
<a href="#h0-9-237" id="h0-9-237" class="d">-escdump(void) { 
</a><a href="#h0-9-238" id="h0-9-238" class="i">+csidump(void) { 
</a> 	int i;
<a href="#h0-9-240" id="h0-9-240" class="d">-	printf(&quot;rawbuf	: %s\n&quot;, escseq.buf);
</a><a href="#h0-9-241" id="h0-9-241" class="d">-	printf(&quot;prechar : %c\n&quot;, escseq.pre);
</a><a href="#h0-9-242" id="h0-9-242" class="d">-	printf(&quot;private : %c\n&quot;, escseq.priv ? &#39;?&#39; : &#39; &#39;);
</a><a href="#h0-9-243" id="h0-9-243" class="d">-	printf(&quot;narg	: %d\n&quot;, escseq.narg);
</a><a href="#h0-9-244" id="h0-9-244" class="i">+	printf(&quot;ESC [ %s&quot;, escseq.priv ? &quot;? &quot; : &quot;&quot;);
</a> 	if(escseq.narg)
 		for(i = 0; i &lt; escseq.narg; i++)
<a href="#h0-9-247" id="h0-9-247" class="d">-			printf(&quot;\targ %d = %d\n&quot;, i, escseq.arg[i]);
</a><a href="#h0-9-248" id="h0-9-248" class="d">-	printf(&quot;mode	: %c\n&quot;, escseq.mode);
</a><a href="#h0-9-249" id="h0-9-249" class="i">+			printf(&quot;%d &quot;, escseq.arg[i]);
</a><a href="#h0-9-250" id="h0-9-250" class="i">+	if(escseq.mode)
</a><a href="#h0-9-251" id="h0-9-251" class="i">+		putchar(escseq.mode);
</a><a href="#h0-9-252" id="h0-9-252" class="i">+	putchar(&#39;\n&#39;);
</a> }
 
 void
<a href="#h0-9-256" id="h0-9-256" class="d">-escreset(void) {
</a><a href="#h0-9-257" id="h0-9-257" class="i">+csireset(void) {
</a> 	memset(&amp;escseq, 0, sizeof(escseq));
 }
 
<a href="#h0-10" id="h0-10" class="h">@@ -781,21 +743,41 @@ tputtab(void) {
</a> 
 void
 tputc(char c) {
<a href="#h0-10-3" id="h0-10-3" class="d">-	static int inesc = 0;
</a> #if 0
 	dump(c);
 #endif	
<a href="#h0-10-7" id="h0-10-7" class="d">-	/* start of escseq */
</a><a href="#h0-10-8" id="h0-10-8" class="d">-	if(c == &#39;\033&#39;)
</a><a href="#h0-10-9" id="h0-10-9" class="d">-		escreset(), inesc = 1;
</a><a href="#h0-10-10" id="h0-10-10" class="d">-	else if(inesc) {
</a><a href="#h0-10-11" id="h0-10-11" class="d">-		inesc = escaddc(c);
</a><a href="#h0-10-12" id="h0-10-12" class="d">-	} /* normal char */ 
</a><a href="#h0-10-13" id="h0-10-13" class="d">-	else switch(c) { 
</a><a href="#h0-10-14" id="h0-10-14" class="d">-		default:
</a><a href="#h0-10-15" id="h0-10-15" class="d">-			tsetchar(c);
</a><a href="#h0-10-16" id="h0-10-16" class="d">-			tcursor(CSright);
</a><a href="#h0-10-17" id="h0-10-17" class="d">-			break;
</a><a href="#h0-10-18" id="h0-10-18" class="i">+	if(term.esc &amp; ESCin) {
</a><a href="#h0-10-19" id="h0-10-19" class="i">+		if(term.esc &amp; ESCcsi) {
</a><a href="#h0-10-20" id="h0-10-20" class="i">+			escseq.buf[escseq.len++] = c;
</a><a href="#h0-10-21" id="h0-10-21" class="i">+			if(BETWEEN(c, 0x40, 0x7E) || escseq.len &gt;= ESCSIZ) {
</a><a href="#h0-10-22" id="h0-10-22" class="i">+				term.esc = 0;
</a><a href="#h0-10-23" id="h0-10-23" class="i">+				csiparse(), csihandle();
</a><a href="#h0-10-24" id="h0-10-24" class="i">+			}
</a><a href="#h0-10-25" id="h0-10-25" class="i">+		} else if (term.esc &amp; ESCosc) {
</a><a href="#h0-10-26" id="h0-10-26" class="i">+			if(c == &#39;;&#39;) {
</a><a href="#h0-10-27" id="h0-10-27" class="i">+				term.titlelen = 0;
</a><a href="#h0-10-28" id="h0-10-28" class="i">+				term.esc = ESCin | ESCtitle;
</a><a href="#h0-10-29" id="h0-10-29" class="i">+			}
</a><a href="#h0-10-30" id="h0-10-30" class="i">+		} else if(term.esc &amp; ESCtitle) {
</a><a href="#h0-10-31" id="h0-10-31" class="i">+			if(c == &#39;\a&#39; || term.titlelen+1 &gt;= TITLESIZ) {
</a><a href="#h0-10-32" id="h0-10-32" class="i">+				term.esc = 0;
</a><a href="#h0-10-33" id="h0-10-33" class="i">+				term.title[term.titlelen] = &#39;\0&#39;;
</a><a href="#h0-10-34" id="h0-10-34" class="i">+				XStoreName(xw.dis, xw.win, term.title);
</a><a href="#h0-10-35" id="h0-10-35" class="i">+			} else {
</a><a href="#h0-10-36" id="h0-10-36" class="i">+				term.title[term.titlelen++] = c;
</a><a href="#h0-10-37" id="h0-10-37" class="i">+			}
</a><a href="#h0-10-38" id="h0-10-38" class="i">+		} else {		
</a><a href="#h0-10-39" id="h0-10-39" class="i">+			switch(c) {
</a><a href="#h0-10-40" id="h0-10-40" class="i">+			case &#39;[&#39;:
</a><a href="#h0-10-41" id="h0-10-41" class="i">+				term.esc |= ESCcsi;
</a><a href="#h0-10-42" id="h0-10-42" class="i">+				break;
</a><a href="#h0-10-43" id="h0-10-43" class="i">+			case &#39;]&#39;:
</a><a href="#h0-10-44" id="h0-10-44" class="i">+				term.esc |= ESCosc;
</a><a href="#h0-10-45" id="h0-10-45" class="i">+				break;
</a><a href="#h0-10-46" id="h0-10-46" class="i">+			}
</a><a href="#h0-10-47" id="h0-10-47" class="i">+		}
</a><a href="#h0-10-48" id="h0-10-48" class="i">+	} else {
</a><a href="#h0-10-49" id="h0-10-49" class="i">+		switch(c) {
</a> 		case &#39;\t&#39;:
 			tputtab();
 			break;
<a href="#h0-11" id="h0-11" class="h">@@ -811,6 +793,15 @@ tputc(char c) {
</a> 		case &#39;\a&#39;:
 			xbell();
 			break;
<a href="#h0-11-3" id="h0-11-3" class="i">+		case &#39;\033&#39;:
</a><a href="#h0-11-4" id="h0-11-4" class="i">+			csireset();
</a><a href="#h0-11-5" id="h0-11-5" class="i">+			term.esc = ESCin;
</a><a href="#h0-11-6" id="h0-11-6" class="i">+			break;
</a><a href="#h0-11-7" id="h0-11-7" class="i">+		default:
</a><a href="#h0-11-8" id="h0-11-8" class="i">+			tsetchar(c);
</a><a href="#h0-11-9" id="h0-11-9" class="i">+			tcursor(CSright);
</a><a href="#h0-11-10" id="h0-11-10" class="i">+			break;
</a><a href="#h0-11-11" id="h0-11-11" class="i">+		}
</a> 	}
 }
 
</pre>
</div>
</body>
</html>
