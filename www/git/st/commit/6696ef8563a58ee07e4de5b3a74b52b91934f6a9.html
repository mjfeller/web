<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Add OSC, DSC, PM, APC and settitle. - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/6696ef8563a58ee07e4de5b3a74b52b91934f6a9.html">6696ef8563a58ee07e4de5b3a74b52b91934f6a9</a>
<b>parent</b> <a href="../commit/ff040e9894f62fe28bf100488211d0a407740668.html">ff040e9894f62fe28bf100488211d0a407740668</a>
<b>Author:</b> Christoph Lohmann &lt;<a href="mailto:20h@r-36.net">20h@r-36.net</a>&gt;
<b>Date:</b>   Wed, 29 Aug 2012 23:14:20 +0200

Add OSC, DSC, PM, APC and settitle.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">TODO</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">st.c</a></td><td> | </td><td class="num">279</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-------------------------</span></td></tr>
</table></pre><pre>2 files changed, 191 insertions(+), 89 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/TODO.html">TODO</a> b/<a href="../file/TODO.html">TODO</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -20,6 +20,7 @@ bugs
</a> * fix shift up/down (shift selection in emacs)
 * fix selection click
 * fix selection paste for xatom STRING
<a href="#h0-0-3" id="h0-0-3" class="i">+* fix umlaut handling in settitle
</a> 
 misc
 ----
<b>diff --git a/<a id="h1" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -43,9 +43,10 @@
</a> #define XEMBED_FOCUS_OUT 5
 
 /* Arbitrary sizes */
<a href="#h1-0-3" id="h1-0-3" class="d">-#define ESC_TITLE_SIZ 256
</a> #define ESC_BUF_SIZ   256
 #define ESC_ARG_SIZ   16
<a href="#h1-0-6" id="h1-0-6" class="i">+#define STR_BUF_SIZ   256
</a><a href="#h1-0-7" id="h1-0-7" class="i">+#define STR_ARG_SIZ   16
</a> #define DRAW_BUF_SIZ  1024
 #define UTF_SIZ       4
 #define XK_NO_MOD     UINT_MAX
<a href="#h1-1" id="h1-1" class="h">@@ -110,9 +111,9 @@ enum term_mode {
</a> enum escape_state {
 	ESC_START      = 1,
 	ESC_CSI        = 2,
<a href="#h1-1-3" id="h1-1-3" class="d">-	ESC_OSC        = 4,
</a><a href="#h1-1-4" id="h1-1-4" class="d">-	ESC_TITLE      = 8,
</a><a href="#h1-1-5" id="h1-1-5" class="d">-	ESC_ALTCHARSET = 16
</a><a href="#h1-1-6" id="h1-1-6" class="i">+	ESC_STR        = 4, /* DSC, OSC, PM, APC */
</a><a href="#h1-1-7" id="h1-1-7" class="i">+	ESC_ALTCHARSET = 8,
</a><a href="#h1-1-8" id="h1-1-8" class="i">+	ESC_STR_END    = 16, /* a final string was encountered */
</a> };
 
 enum window_state {
<a href="#h1-2" id="h1-2" class="h">@@ -158,6 +159,16 @@ typedef struct {
</a> 	char mode;
 } CSIEscape;
 
<a href="#h1-2-3" id="h1-2-3" class="i">+/* STR Escape sequence structs */
</a><a href="#h1-2-4" id="h1-2-4" class="i">+/* ESC type [[ [&lt;priv&gt;] &lt;arg&gt; [;]] &lt;mode&gt;] ESC &#39;\&#39; */
</a><a href="#h1-2-5" id="h1-2-5" class="i">+typedef struct {
</a><a href="#h1-2-6" id="h1-2-6" class="i">+	char type;             /* ESC type ... */
</a><a href="#h1-2-7" id="h1-2-7" class="i">+	char buf[STR_BUF_SIZ]; /* raw string */
</a><a href="#h1-2-8" id="h1-2-8" class="i">+	int len;               /* raw string length */
</a><a href="#h1-2-9" id="h1-2-9" class="i">+	char *args[STR_ARG_SIZ];
</a><a href="#h1-2-10" id="h1-2-10" class="i">+	int narg;              /* nb of args */
</a><a href="#h1-2-11" id="h1-2-11" class="i">+} STREscape;
</a><a href="#h1-2-12" id="h1-2-12" class="i">+
</a> /* Internal representation of the screen */
 typedef struct {
 	int row;	/* nb row */
<a href="#h1-3" id="h1-3" class="h">@@ -170,8 +181,6 @@ typedef struct {
</a> 	int bot;	/* bottom scroll limit */
 	int mode;	/* terminal mode flags */
 	int esc;	/* escape state flags */
<a href="#h1-3-3" id="h1-3-3" class="d">-	char title[ESC_TITLE_SIZ];
</a><a href="#h1-3-4" id="h1-3-4" class="d">-	int titlelen;
</a> 	bool *tabs;
 } Term;
 
<a href="#h1-4" id="h1-4" class="h">@@ -239,6 +248,10 @@ static void csidump(void);
</a> static void csihandle(void);
 static void csiparse(void);
 static void csireset(void);
<a href="#h1-4-3" id="h1-4-3" class="i">+static void strdump(void);
</a><a href="#h1-4-4" id="h1-4-4" class="i">+static void strhandle(void);
</a><a href="#h1-4-5" id="h1-4-5" class="i">+static void strparse(void);
</a><a href="#h1-4-6" id="h1-4-6" class="i">+static void strreset(void);
</a> 
 static void tclearregion(int, int, int, int);
 static void tcursor(int);
<a href="#h1-5" id="h1-5" class="h">@@ -323,7 +336,8 @@ static void (*handler[LASTEvent])(XEvent *) = {
</a> static DC dc;
 static XWindow xw;
 static Term term;
<a href="#h1-5-3" id="h1-5-3" class="d">-static CSIEscape escseq;
</a><a href="#h1-5-4" id="h1-5-4" class="i">+static CSIEscape csiescseq;
</a><a href="#h1-5-5" id="h1-5-5" class="i">+static STREscape strescseq;
</a> static int cmdfd;
 static pid_t pid;
 static Selection sel;
<a href="#h1-6" id="h1-6" class="h">@@ -968,22 +982,22 @@ tnewline(int first_col) {
</a> void
 csiparse(void) {
 	/* int noarg = 1; */
<a href="#h1-6-3" id="h1-6-3" class="d">-	char *p = escseq.buf;
</a><a href="#h1-6-4" id="h1-6-4" class="i">+	char *p = csiescseq.buf;
</a> 
<a href="#h1-6-6" id="h1-6-6" class="d">-	escseq.narg = 0;
</a><a href="#h1-6-7" id="h1-6-7" class="i">+	csiescseq.narg = 0;
</a> 	if(*p == &#39;?&#39;)
<a href="#h1-6-9" id="h1-6-9" class="d">-		escseq.priv = 1, p++;
</a><a href="#h1-6-10" id="h1-6-10" class="i">+		csiescseq.priv = 1, p++;
</a> 	
<a href="#h1-6-12" id="h1-6-12" class="d">-	while(p &lt; escseq.buf+escseq.len) {
</a><a href="#h1-6-13" id="h1-6-13" class="i">+	while(p &lt; csiescseq.buf+csiescseq.len) {
</a> 		while(isdigit(*p)) {
<a href="#h1-6-15" id="h1-6-15" class="d">-			escseq.arg[escseq.narg] *= 10;
</a><a href="#h1-6-16" id="h1-6-16" class="d">-			escseq.arg[escseq.narg] += *p++ - &#39;0&#39;/*, noarg = 0 */;
</a><a href="#h1-6-17" id="h1-6-17" class="i">+			csiescseq.arg[csiescseq.narg] *= 10;
</a><a href="#h1-6-18" id="h1-6-18" class="i">+			csiescseq.arg[csiescseq.narg] += *p++ - &#39;0&#39;/*, noarg = 0 */;
</a> 		}
<a href="#h1-6-20" id="h1-6-20" class="d">-		if(*p == &#39;;&#39; &amp;&amp; escseq.narg+1 &lt; ESC_ARG_SIZ)
</a><a href="#h1-6-21" id="h1-6-21" class="d">-			escseq.narg++, p++;
</a><a href="#h1-6-22" id="h1-6-22" class="i">+		if(*p == &#39;;&#39; &amp;&amp; csiescseq.narg+1 &lt; ESC_ARG_SIZ)
</a><a href="#h1-6-23" id="h1-6-23" class="i">+			csiescseq.narg++, p++;
</a> 		else {
<a href="#h1-6-25" id="h1-6-25" class="d">-			escseq.mode = *p;
</a><a href="#h1-6-26" id="h1-6-26" class="d">-			escseq.narg++;
</a><a href="#h1-6-27" id="h1-6-27" class="i">+			csiescseq.mode = *p;
</a><a href="#h1-6-28" id="h1-6-28" class="i">+			csiescseq.narg++;
</a> 			return;
 		}
 	}
<a href="#h1-7" id="h1-7" class="h">@@ -1166,7 +1180,7 @@ tsetscroll(int t, int b) {
</a> 
 void
 csihandle(void) {
<a href="#h1-7-3" id="h1-7-3" class="d">-	switch(escseq.mode) {
</a><a href="#h1-7-4" id="h1-7-4" class="i">+	switch(csiescseq.mode) {
</a> 	default:
 	unknown:
 		fprintf(stderr, &quot;erresc: unknown csi &quot;);
<a href="#h1-8" id="h1-8" class="h">@@ -1174,37 +1188,37 @@ csihandle(void) {
</a> 		/* die(&quot;&quot;); */
 		break;
 	case &#39;@&#39;: /* ICH -- Insert &lt;n&gt; blank char */
<a href="#h1-8-3" id="h1-8-3" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-8-4" id="h1-8-4" class="d">-		tinsertblank(escseq.arg[0]);
</a><a href="#h1-8-5" id="h1-8-5" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-8-6" id="h1-8-6" class="i">+		tinsertblank(csiescseq.arg[0]);
</a> 		break;
 	case &#39;A&#39;: /* CUU -- Cursor &lt;n&gt; Up */
 	case &#39;e&#39;:
<a href="#h1-8-10" id="h1-8-10" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-8-11" id="h1-8-11" class="d">-		tmoveto(term.c.x, term.c.y-escseq.arg[0]);
</a><a href="#h1-8-12" id="h1-8-12" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-8-13" id="h1-8-13" class="i">+		tmoveto(term.c.x, term.c.y-csiescseq.arg[0]);
</a> 		break;
 	case &#39;B&#39;: /* CUD -- Cursor &lt;n&gt; Down */
<a href="#h1-8-16" id="h1-8-16" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-8-17" id="h1-8-17" class="d">-		tmoveto(term.c.x, term.c.y+escseq.arg[0]);
</a><a href="#h1-8-18" id="h1-8-18" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-8-19" id="h1-8-19" class="i">+		tmoveto(term.c.x, term.c.y+csiescseq.arg[0]);
</a> 		break;
 	case &#39;C&#39;: /* CUF -- Cursor &lt;n&gt; Forward */
 	case &#39;a&#39;:
<a href="#h1-8-23" id="h1-8-23" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-8-24" id="h1-8-24" class="d">-		tmoveto(term.c.x+escseq.arg[0], term.c.y);
</a><a href="#h1-8-25" id="h1-8-25" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-8-26" id="h1-8-26" class="i">+		tmoveto(term.c.x+csiescseq.arg[0], term.c.y);
</a> 		break;
 	case &#39;D&#39;: /* CUB -- Cursor &lt;n&gt; Backward */
<a href="#h1-8-29" id="h1-8-29" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-8-30" id="h1-8-30" class="d">-		tmoveto(term.c.x-escseq.arg[0], term.c.y);
</a><a href="#h1-8-31" id="h1-8-31" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-8-32" id="h1-8-32" class="i">+		tmoveto(term.c.x-csiescseq.arg[0], term.c.y);
</a> 		break;
 	case &#39;E&#39;: /* CNL -- Cursor &lt;n&gt; Down and first col */
<a href="#h1-8-35" id="h1-8-35" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-8-36" id="h1-8-36" class="d">-		tmoveto(0, term.c.y+escseq.arg[0]);
</a><a href="#h1-8-37" id="h1-8-37" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-8-38" id="h1-8-38" class="i">+		tmoveto(0, term.c.y+csiescseq.arg[0]);
</a> 		break;
 	case &#39;F&#39;: /* CPL -- Cursor &lt;n&gt; Up and first col */
<a href="#h1-8-41" id="h1-8-41" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-8-42" id="h1-8-42" class="d">-		tmoveto(0, term.c.y-escseq.arg[0]);
</a><a href="#h1-8-43" id="h1-8-43" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-8-44" id="h1-8-44" class="i">+		tmoveto(0, term.c.y-csiescseq.arg[0]);
</a> 		break;
 	case &#39;g&#39;: /* TBC -- Tabulation clear */
<a href="#h1-8-47" id="h1-8-47" class="d">-		switch (escseq.arg[0]) {
</a><a href="#h1-8-48" id="h1-8-48" class="i">+		switch (csiescseq.arg[0]) {
</a> 		case 0: /* clear current tab stop */
 			term.tabs[term.c.x] = 0;
 			break;
<a href="#h1-9" id="h1-9" class="h">@@ -1217,23 +1231,23 @@ csihandle(void) {
</a> 		break;
 	case &#39;G&#39;: /* CHA -- Move to &lt;col&gt; */
 	case &#39;`&#39;: /* XXX: HPA -- same? */
<a href="#h1-9-3" id="h1-9-3" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-9-4" id="h1-9-4" class="d">-		tmoveto(escseq.arg[0]-1, term.c.y);
</a><a href="#h1-9-5" id="h1-9-5" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-9-6" id="h1-9-6" class="i">+		tmoveto(csiescseq.arg[0]-1, term.c.y);
</a> 		break;
 	case &#39;H&#39;: /* CUP -- Move to &lt;row&gt; &lt;col&gt; */
 	case &#39;f&#39;: /* XXX: HVP -- same? */
<a href="#h1-9-10" id="h1-9-10" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-9-11" id="h1-9-11" class="d">-		DEFAULT(escseq.arg[1], 1);
</a><a href="#h1-9-12" id="h1-9-12" class="d">-		tmoveto(escseq.arg[1]-1, escseq.arg[0]-1);
</a><a href="#h1-9-13" id="h1-9-13" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-9-14" id="h1-9-14" class="i">+		DEFAULT(csiescseq.arg[1], 1);
</a><a href="#h1-9-15" id="h1-9-15" class="i">+		tmoveto(csiescseq.arg[1]-1, csiescseq.arg[0]-1);
</a> 		break;
 	case &#39;I&#39;: /* CHT -- Cursor Forward Tabulation &lt;n&gt; tab stops */
<a href="#h1-9-18" id="h1-9-18" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-9-19" id="h1-9-19" class="d">-		while (escseq.arg[0]--)
</a><a href="#h1-9-20" id="h1-9-20" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-9-21" id="h1-9-21" class="i">+		while (csiescseq.arg[0]--)
</a> 			tputtab();
 		break;
 	case &#39;J&#39;: /* ED -- Clear screen */
 		sel.bx = -1;
<a href="#h1-9-26" id="h1-9-26" class="d">-		switch(escseq.arg[0]) {
</a><a href="#h1-9-27" id="h1-9-27" class="i">+		switch(csiescseq.arg[0]) {
</a> 		case 0: /* below */
 			tclearregion(term.c.x, term.c.y, term.col-1, term.c.y);
 			if(term.c.y &lt; term.row-1)
<a href="#h1-10" id="h1-10" class="h">@@ -1252,7 +1266,7 @@ csihandle(void) {
</a> 		}
 		break;
 	case &#39;K&#39;: /* EL -- Clear line */
<a href="#h1-10-3" id="h1-10-3" class="d">-		switch(escseq.arg[0]) {
</a><a href="#h1-10-4" id="h1-10-4" class="i">+		switch(csiescseq.arg[0]) {
</a> 		case 0: /* right */
 			tclearregion(term.c.x, term.c.y, term.col-1, term.c.y);
 			break;
<a href="#h1-11" id="h1-11" class="h">@@ -1265,20 +1279,20 @@ csihandle(void) {
</a> 		}
 		break;
 	case &#39;S&#39;: /* SU -- Scroll &lt;n&gt; line up */
<a href="#h1-11-3" id="h1-11-3" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-11-4" id="h1-11-4" class="d">-		tscrollup(term.top, escseq.arg[0]);
</a><a href="#h1-11-5" id="h1-11-5" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-11-6" id="h1-11-6" class="i">+		tscrollup(term.top, csiescseq.arg[0]);
</a> 		break;
 	case &#39;T&#39;: /* SD -- Scroll &lt;n&gt; line down */
<a href="#h1-11-9" id="h1-11-9" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-11-10" id="h1-11-10" class="d">-		tscrolldown(term.top, escseq.arg[0]);
</a><a href="#h1-11-11" id="h1-11-11" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-11-12" id="h1-11-12" class="i">+		tscrolldown(term.top, csiescseq.arg[0]);
</a> 		break;
 	case &#39;L&#39;: /* IL -- Insert &lt;n&gt; blank lines */
<a href="#h1-11-15" id="h1-11-15" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-11-16" id="h1-11-16" class="d">-		tinsertblankline(escseq.arg[0]);
</a><a href="#h1-11-17" id="h1-11-17" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-11-18" id="h1-11-18" class="i">+		tinsertblankline(csiescseq.arg[0]);
</a> 		break;
 	case &#39;l&#39;: /* RM -- Reset Mode */
<a href="#h1-11-21" id="h1-11-21" class="d">-		if(escseq.priv) {
</a><a href="#h1-11-22" id="h1-11-22" class="d">-			switch(escseq.arg[0]) {
</a><a href="#h1-11-23" id="h1-11-23" class="i">+		if(csiescseq.priv) {
</a><a href="#h1-11-24" id="h1-11-24" class="i">+			switch(csiescseq.arg[0]) {
</a> 			case 1:
 				term.mode &amp;= ~MODE_APPKEYPAD;
 				break;
<a href="#h1-12" id="h1-12" class="h">@@ -1312,7 +1326,7 @@ csihandle(void) {
</a> 					tclearregion(0, 0, term.col-1, term.row-1);
 					tswapscreen();
 				}
<a href="#h1-12-3" id="h1-12-3" class="d">-				if(escseq.arg[0] != 1049)
</a><a href="#h1-12-4" id="h1-12-4" class="i">+				if(csiescseq.arg[0] != 1049)
</a> 					break;
 			case 1048:
 				tcursor(CURSOR_LOAD);
<a href="#h1-13" id="h1-13" class="h">@@ -1321,7 +1335,7 @@ csihandle(void) {
</a> 				goto unknown;
 			}
 		} else {
<a href="#h1-13-3" id="h1-13-3" class="d">-			switch(escseq.arg[0]) {
</a><a href="#h1-13-4" id="h1-13-4" class="i">+			switch(csiescseq.arg[0]) {
</a> 			case 4:
 				term.mode &amp;= ~MODE_INSERT;
 				break;
<a href="#h1-14" id="h1-14" class="h">@@ -1331,25 +1345,25 @@ csihandle(void) {
</a> 		}
 		break;
 	case &#39;M&#39;: /* DL -- Delete &lt;n&gt; lines */
<a href="#h1-14-3" id="h1-14-3" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-14-4" id="h1-14-4" class="d">-		tdeleteline(escseq.arg[0]);
</a><a href="#h1-14-5" id="h1-14-5" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-14-6" id="h1-14-6" class="i">+		tdeleteline(csiescseq.arg[0]);
</a> 		break;
 	case &#39;X&#39;: /* ECH -- Erase &lt;n&gt; char */
<a href="#h1-14-9" id="h1-14-9" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-14-10" id="h1-14-10" class="d">-		tclearregion(term.c.x, term.c.y, term.c.x + escseq.arg[0], term.c.y);
</a><a href="#h1-14-11" id="h1-14-11" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-14-12" id="h1-14-12" class="i">+		tclearregion(term.c.x, term.c.y, term.c.x + csiescseq.arg[0], term.c.y);
</a> 		break;
 	case &#39;P&#39;: /* DCH -- Delete &lt;n&gt; char */
<a href="#h1-14-15" id="h1-14-15" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-14-16" id="h1-14-16" class="d">-		tdeletechar(escseq.arg[0]);
</a><a href="#h1-14-17" id="h1-14-17" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-14-18" id="h1-14-18" class="i">+		tdeletechar(csiescseq.arg[0]);
</a> 		break;
 	/* XXX: (CSI n Z) CBT -- Cursor Backward Tabulation &lt;n&gt; tab stops */
 	case &#39;d&#39;: /* VPA -- Move to &lt;row&gt; */
<a href="#h1-14-22" id="h1-14-22" class="d">-		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-14-23" id="h1-14-23" class="d">-		tmoveto(term.c.x, escseq.arg[0]-1);
</a><a href="#h1-14-24" id="h1-14-24" class="i">+		DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-14-25" id="h1-14-25" class="i">+		tmoveto(term.c.x, csiescseq.arg[0]-1);
</a> 		break;
 	case &#39;h&#39;: /* SM -- Set terminal mode */
<a href="#h1-14-28" id="h1-14-28" class="d">-		if(escseq.priv) {
</a><a href="#h1-14-29" id="h1-14-29" class="d">-			switch(escseq.arg[0]) {
</a><a href="#h1-14-30" id="h1-14-30" class="i">+		if(csiescseq.priv) {
</a><a href="#h1-14-31" id="h1-14-31" class="i">+			switch(csiescseq.arg[0]) {
</a> 			case 1:
 				term.mode |= MODE_APPKEYPAD;
 				break;
<a href="#h1-15" id="h1-15" class="h">@@ -1367,7 +1381,7 @@ csihandle(void) {
</a> 				break;
 			case 12: /* att610 -- Start blinking cursor (IGNORED) */
 				 /* fallthrough for xterm cvvis = CSI [ ? 12 ; 25 h */
<a href="#h1-15-3" id="h1-15-3" class="d">-				if(escseq.narg &gt; 1 &amp;&amp; escseq.arg[1] != 25)
</a><a href="#h1-15-4" id="h1-15-4" class="i">+				if(csiescseq.narg &gt; 1 &amp;&amp; csiescseq.arg[1] != 25)
</a> 					break;
 			case 25:
 				term.c.state &amp;= ~CURSOR_HIDE;
<a href="#h1-16" id="h1-16" class="h">@@ -1385,7 +1399,7 @@ csihandle(void) {
</a> 					tclearregion(0, 0, term.col-1, term.row-1);
 				else
 					tswapscreen();
<a href="#h1-16-3" id="h1-16-3" class="d">-				if(escseq.arg[0] != 1049)
</a><a href="#h1-16-4" id="h1-16-4" class="i">+				if(csiescseq.arg[0] != 1049)
</a> 					break;
 			case 1048:
 				tcursor(CURSOR_SAVE);
<a href="#h1-17" id="h1-17" class="h">@@ -1393,7 +1407,7 @@ csihandle(void) {
</a> 			default: goto unknown;
 			}
 		} else {
<a href="#h1-17-3" id="h1-17-3" class="d">-			switch(escseq.arg[0]) {
</a><a href="#h1-17-4" id="h1-17-4" class="i">+			switch(csiescseq.arg[0]) {
</a> 			case 4:
 				term.mode |= MODE_INSERT;
 				break;
<a href="#h1-18" id="h1-18" class="h">@@ -1402,15 +1416,15 @@ csihandle(void) {
</a> 		};
 		break;
 	case &#39;m&#39;: /* SGR -- Terminal attribute (color) */
<a href="#h1-18-3" id="h1-18-3" class="d">-		tsetattr(escseq.arg, escseq.narg);
</a><a href="#h1-18-4" id="h1-18-4" class="i">+		tsetattr(csiescseq.arg, csiescseq.narg);
</a> 		break;
 	case &#39;r&#39;: /* DECSTBM -- Set Scrolling Region */
<a href="#h1-18-7" id="h1-18-7" class="d">-		if(escseq.priv)
</a><a href="#h1-18-8" id="h1-18-8" class="i">+		if(csiescseq.priv)
</a> 			goto unknown;
 		else {
<a href="#h1-18-11" id="h1-18-11" class="d">-			DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-18-12" id="h1-18-12" class="d">-			DEFAULT(escseq.arg[1], term.row);
</a><a href="#h1-18-13" id="h1-18-13" class="d">-			tsetscroll(escseq.arg[0]-1, escseq.arg[1]-1);
</a><a href="#h1-18-14" id="h1-18-14" class="i">+			DEFAULT(csiescseq.arg[0], 1);
</a><a href="#h1-18-15" id="h1-18-15" class="i">+			DEFAULT(csiescseq.arg[1], term.row);
</a><a href="#h1-18-16" id="h1-18-16" class="i">+			tsetscroll(csiescseq.arg[0]-1, csiescseq.arg[1]-1);
</a> 			tmoveto(0, 0);
 		}
 		break;
<a href="#h1-19" id="h1-19" class="h">@@ -1427,8 +1441,8 @@ void
</a> csidump(void) {
 	int i;
 	printf(&quot;ESC[&quot;);
<a href="#h1-19-3" id="h1-19-3" class="d">-	for(i = 0; i &lt; escseq.len; i++) {
</a><a href="#h1-19-4" id="h1-19-4" class="d">-		uint c = escseq.buf[i] &amp; 0xff;
</a><a href="#h1-19-5" id="h1-19-5" class="i">+	for(i = 0; i &lt; csiescseq.len; i++) {
</a><a href="#h1-19-6" id="h1-19-6" class="i">+		uint c = csiescseq.buf[i] &amp; 0xff;
</a> 		if(isprint(c)) putchar(c);
 		else if(c == &#39;\n&#39;) printf(&quot;(\\n)&quot;);
 		else if(c == &#39;\r&#39;) printf(&quot;(\\r)&quot;);
<a href="#h1-20" id="h1-20" class="h">@@ -1440,7 +1454,80 @@ csidump(void) {
</a> 
 void
 csireset(void) {
<a href="#h1-20-3" id="h1-20-3" class="d">-	memset(&amp;escseq, 0, sizeof(escseq));
</a><a href="#h1-20-4" id="h1-20-4" class="i">+	memset(&amp;csiescseq, 0, sizeof(csiescseq));
</a><a href="#h1-20-5" id="h1-20-5" class="i">+}
</a><a href="#h1-20-6" id="h1-20-6" class="i">+
</a><a href="#h1-20-7" id="h1-20-7" class="i">+void
</a><a href="#h1-20-8" id="h1-20-8" class="i">+strhandle(void) {
</a><a href="#h1-20-9" id="h1-20-9" class="i">+	char *p;
</a><a href="#h1-20-10" id="h1-20-10" class="i">+
</a><a href="#h1-20-11" id="h1-20-11" class="i">+	p = strescseq.buf; 
</a><a href="#h1-20-12" id="h1-20-12" class="i">+
</a><a href="#h1-20-13" id="h1-20-13" class="i">+	switch(strescseq.type) {
</a><a href="#h1-20-14" id="h1-20-14" class="i">+	case &#39;]&#39;: /* OSC -- Operating System Command */
</a><a href="#h1-20-15" id="h1-20-15" class="i">+		switch(p[0]) {
</a><a href="#h1-20-16" id="h1-20-16" class="i">+		case &#39;0&#39;:
</a><a href="#h1-20-17" id="h1-20-17" class="i">+		case &#39;2&#39;:
</a><a href="#h1-20-18" id="h1-20-18" class="i">+			/*
</a><a href="#h1-20-19" id="h1-20-19" class="i">+			 * TODO: Handle special chars in string, like umlauts.
</a><a href="#h1-20-20" id="h1-20-20" class="i">+			 */
</a><a href="#h1-20-21" id="h1-20-21" class="i">+			if(p[1] == &#39;;&#39;) {
</a><a href="#h1-20-22" id="h1-20-22" class="i">+				if(!strncmp(strescseq.buf, &quot;settitle &quot;, 9)) {
</a><a href="#h1-20-23" id="h1-20-23" class="i">+					XStoreName(xw.dpy, xw.win, strescseq.buf+11);	
</a><a href="#h1-20-24" id="h1-20-24" class="i">+				} else {
</a><a href="#h1-20-25" id="h1-20-25" class="i">+					XStoreName(xw.dpy, xw.win, strescseq.buf+2);
</a><a href="#h1-20-26" id="h1-20-26" class="i">+				}
</a><a href="#h1-20-27" id="h1-20-27" class="i">+			}
</a><a href="#h1-20-28" id="h1-20-28" class="i">+			break;
</a><a href="#h1-20-29" id="h1-20-29" class="i">+		case &#39;;&#39;:
</a><a href="#h1-20-30" id="h1-20-30" class="i">+			XStoreName(xw.dpy, xw.win, strescseq.buf+1);
</a><a href="#h1-20-31" id="h1-20-31" class="i">+			break;
</a><a href="#h1-20-32" id="h1-20-32" class="i">+		case &#39;4&#39;: /* TODO: Set color (arg0) to &quot;rgb:%hexr/$hexg/$hexb&quot; (arg1) */
</a><a href="#h1-20-33" id="h1-20-33" class="i">+			break;
</a><a href="#h1-20-34" id="h1-20-34" class="i">+		default:
</a><a href="#h1-20-35" id="h1-20-35" class="i">+			fprintf(stderr, &quot;erresc: unknown str &quot;);
</a><a href="#h1-20-36" id="h1-20-36" class="i">+			strdump();
</a><a href="#h1-20-37" id="h1-20-37" class="i">+			break;
</a><a href="#h1-20-38" id="h1-20-38" class="i">+		}
</a><a href="#h1-20-39" id="h1-20-39" class="i">+		break;
</a><a href="#h1-20-40" id="h1-20-40" class="i">+	case &#39;P&#39;: /* DSC -- Device Control String */
</a><a href="#h1-20-41" id="h1-20-41" class="i">+	case &#39;_&#39;: /* APC -- Application Program Command */
</a><a href="#h1-20-42" id="h1-20-42" class="i">+	case &#39;^&#39;: /* PM -- Privacy Message */
</a><a href="#h1-20-43" id="h1-20-43" class="i">+	default:
</a><a href="#h1-20-44" id="h1-20-44" class="i">+		fprintf(stderr, &quot;erresc: unknown str &quot;);
</a><a href="#h1-20-45" id="h1-20-45" class="i">+		strdump();
</a><a href="#h1-20-46" id="h1-20-46" class="i">+		/* die(&quot;&quot;); */
</a><a href="#h1-20-47" id="h1-20-47" class="i">+		break;
</a><a href="#h1-20-48" id="h1-20-48" class="i">+	}
</a><a href="#h1-20-49" id="h1-20-49" class="i">+}
</a><a href="#h1-20-50" id="h1-20-50" class="i">+
</a><a href="#h1-20-51" id="h1-20-51" class="i">+void
</a><a href="#h1-20-52" id="h1-20-52" class="i">+strparse(void) {
</a><a href="#h1-20-53" id="h1-20-53" class="i">+	/*
</a><a href="#h1-20-54" id="h1-20-54" class="i">+	 * TODO: Implement parsing like for CSI when required.
</a><a href="#h1-20-55" id="h1-20-55" class="i">+	 * Format: ESC type cmd &#39;;&#39; arg0 [&#39;;&#39; argn] ESC \
</a><a href="#h1-20-56" id="h1-20-56" class="i">+	 */
</a><a href="#h1-20-57" id="h1-20-57" class="i">+	return;
</a><a href="#h1-20-58" id="h1-20-58" class="i">+}
</a><a href="#h1-20-59" id="h1-20-59" class="i">+
</a><a href="#h1-20-60" id="h1-20-60" class="i">+void
</a><a href="#h1-20-61" id="h1-20-61" class="i">+strdump(void) {
</a><a href="#h1-20-62" id="h1-20-62" class="i">+	int i;
</a><a href="#h1-20-63" id="h1-20-63" class="i">+	printf(&quot;ESC%c&quot;, strescseq.type);
</a><a href="#h1-20-64" id="h1-20-64" class="i">+	for(i = 0; i &lt; strescseq.len; i++) {
</a><a href="#h1-20-65" id="h1-20-65" class="i">+		uint c = strescseq.buf[i] &amp; 0xff;
</a><a href="#h1-20-66" id="h1-20-66" class="i">+		if(isprint(c)) putchar(c);
</a><a href="#h1-20-67" id="h1-20-67" class="i">+		else if(c == &#39;\n&#39;) printf(&quot;(\\n)&quot;);
</a><a href="#h1-20-68" id="h1-20-68" class="i">+		else if(c == &#39;\r&#39;) printf(&quot;(\\r)&quot;);
</a><a href="#h1-20-69" id="h1-20-69" class="i">+		else if(c == 0x1b) printf(&quot;(\\e)&quot;);
</a><a href="#h1-20-70" id="h1-20-70" class="i">+		else printf(&quot;(%02x)&quot;, c);
</a><a href="#h1-20-71" id="h1-20-71" class="i">+	}
</a><a href="#h1-20-72" id="h1-20-72" class="i">+	printf(&quot;ESC\\\n&quot;);
</a><a href="#h1-20-73" id="h1-20-73" class="i">+}
</a><a href="#h1-20-74" id="h1-20-74" class="i">+
</a><a href="#h1-20-75" id="h1-20-75" class="i">+void
</a><a href="#h1-20-76" id="h1-20-76" class="i">+strreset(void) {
</a><a href="#h1-20-77" id="h1-20-77" class="i">+	memset(&amp;strescseq, 0, sizeof(strescseq));
</a> }
 
 void
<a href="#h1-21" id="h1-21" class="h">@@ -1457,25 +1544,31 @@ tputc(char *c) {
</a> 	char ascii = *c;
 	if(term.esc &amp; ESC_START) {
 		if(term.esc &amp; ESC_CSI) {
<a href="#h1-21-3" id="h1-21-3" class="d">-			escseq.buf[escseq.len++] = ascii;
</a><a href="#h1-21-4" id="h1-21-4" class="d">-			if(BETWEEN(ascii, 0x40, 0x7E) || escseq.len &gt;= ESC_BUF_SIZ) {
</a><a href="#h1-21-5" id="h1-21-5" class="i">+			csiescseq.buf[csiescseq.len++] = ascii;
</a><a href="#h1-21-6" id="h1-21-6" class="i">+			if(BETWEEN(ascii, 0x40, 0x7E) || csiescseq.len &gt;= ESC_BUF_SIZ) {
</a> 				term.esc = 0;
 				csiparse(), csihandle();
 			}
<a href="#h1-21-10" id="h1-21-10" class="d">-			/* TODO: handle other OSC */
</a><a href="#h1-21-11" id="h1-21-11" class="d">-		} else if(term.esc &amp; ESC_OSC) {
</a><a href="#h1-21-12" id="h1-21-12" class="d">-			if(ascii == &#39;;&#39;) {
</a><a href="#h1-21-13" id="h1-21-13" class="d">-				term.titlelen = 0;
</a><a href="#h1-21-14" id="h1-21-14" class="d">-				term.esc = ESC_START | ESC_TITLE;
</a><a href="#h1-21-15" id="h1-21-15" class="d">-			}
</a><a href="#h1-21-16" id="h1-21-16" class="d">-		} else if(term.esc &amp; ESC_TITLE) {
</a><a href="#h1-21-17" id="h1-21-17" class="d">-			if(ascii == &#39;\a&#39; || term.titlelen+1 &gt;= ESC_TITLE_SIZ) {
</a><a href="#h1-21-18" id="h1-21-18" class="i">+		} else if(term.esc &amp; ESC_STR) {
</a><a href="#h1-21-19" id="h1-21-19" class="i">+			switch(ascii) {
</a><a href="#h1-21-20" id="h1-21-20" class="i">+			case &#39;\033&#39;:
</a><a href="#h1-21-21" id="h1-21-21" class="i">+				term.esc = ESC_START | ESC_STR_END;
</a><a href="#h1-21-22" id="h1-21-22" class="i">+				break;
</a><a href="#h1-21-23" id="h1-21-23" class="i">+			case &#39;\a&#39;: /* backwards compatibility to xterm */
</a> 				term.esc = 0;
<a href="#h1-21-25" id="h1-21-25" class="d">-				term.title[term.titlelen] = &#39;\0&#39;;
</a><a href="#h1-21-26" id="h1-21-26" class="d">-				XStoreName(xw.dpy, xw.win, term.title);
</a><a href="#h1-21-27" id="h1-21-27" class="d">-			} else {
</a><a href="#h1-21-28" id="h1-21-28" class="d">-				term.title[term.titlelen++] = ascii;
</a><a href="#h1-21-29" id="h1-21-29" class="i">+				strhandle();
</a><a href="#h1-21-30" id="h1-21-30" class="i">+				break;
</a><a href="#h1-21-31" id="h1-21-31" class="i">+			default:
</a><a href="#h1-21-32" id="h1-21-32" class="i">+				strescseq.buf[strescseq.len++] = ascii;
</a><a href="#h1-21-33" id="h1-21-33" class="i">+				if (strescseq.len+1 &gt;= STR_BUF_SIZ) {
</a><a href="#h1-21-34" id="h1-21-34" class="i">+					term.esc = 0;
</a><a href="#h1-21-35" id="h1-21-35" class="i">+					strhandle();
</a><a href="#h1-21-36" id="h1-21-36" class="i">+				}
</a> 			}
<a href="#h1-21-38" id="h1-21-38" class="i">+		} else if(term.esc &amp; ESC_STR_END) {
</a><a href="#h1-21-39" id="h1-21-39" class="i">+			term.esc = 0;
</a><a href="#h1-21-40" id="h1-21-40" class="i">+			if(ascii == &#39;\\&#39;)
</a><a href="#h1-21-41" id="h1-21-41" class="i">+				strhandle();
</a> 		} else if(term.esc &amp; ESC_ALTCHARSET) {
 			switch(ascii) {
 			case &#39;0&#39;: /* Line drawing crap */
<a href="#h1-22" id="h1-22" class="h">@@ -1493,8 +1586,13 @@ tputc(char *c) {
</a> 			case &#39;[&#39;:
 				term.esc |= ESC_CSI;
 				break;
<a href="#h1-22-3" id="h1-22-3" class="d">-			case &#39;]&#39;:
</a><a href="#h1-22-4" id="h1-22-4" class="d">-				term.esc |= ESC_OSC;
</a><a href="#h1-22-5" id="h1-22-5" class="i">+			case &#39;P&#39;: /* DCS -- Device Control String */
</a><a href="#h1-22-6" id="h1-22-6" class="i">+			case &#39;_&#39;: /* APC -- Application Program Command */
</a><a href="#h1-22-7" id="h1-22-7" class="i">+			case &#39;^&#39;: /* PM -- Privacy Message */
</a><a href="#h1-22-8" id="h1-22-8" class="i">+			case &#39;]&#39;: /* OSC -- Operating System Command */
</a><a href="#h1-22-9" id="h1-22-9" class="i">+				strreset();
</a><a href="#h1-22-10" id="h1-22-10" class="i">+				strescseq.type = ascii;
</a><a href="#h1-22-11" id="h1-22-11" class="i">+				term.esc |= ESC_STR;
</a> 				break;
 			case &#39;(&#39;:
 				term.esc |= ESC_ALTCHARSET;
<a href="#h1-23" id="h1-23" class="h">@@ -1541,6 +1639,9 @@ tputc(char *c) {
</a> 				tcursor(CURSOR_LOAD);
 				term.esc = 0;
 				break;
<a href="#h1-23-3" id="h1-23-3" class="i">+			case &#39;\\&#39;: /* ST -- Stop */
</a><a href="#h1-23-4" id="h1-23-4" class="i">+				term.esc = 0;
</a><a href="#h1-23-5" id="h1-23-5" class="i">+				break;
</a> 			default:
 				fprintf(stderr, &quot;erresc: unknown sequence ESC 0x%02X &#39;%c&#39;\n&quot;,
 				    (uchar) ascii, isprint(ascii)?ascii:&#39;.&#39;);
</pre>
</div>
</body>
</html>
