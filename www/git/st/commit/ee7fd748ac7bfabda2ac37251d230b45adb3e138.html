<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Add tabs field into Term struct - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/ee7fd748ac7bfabda2ac37251d230b45adb3e138.html">ee7fd748ac7bfabda2ac37251d230b45adb3e138</a>
<b>parent</b> <a href="../commit/c6853fe18564437fe0a4cb06565a0a7d63d40b5a.html">c6853fe18564437fe0a4cb06565a0a7d63d40b5a</a>
<b>Author:</b> Roberto E. Vargas Caballero &lt;<a href="mailto:k0ga@shike2.com">k0ga@shike2.com</a>&gt;
<b>Date:</b>   Wed, 29 Aug 2012 19:59:37 +0200

Add tabs field into Term struct

Tabs stop are simulated in st using a fixed size of 8, always, without be
worried about sequences changing the tab stops. A user can put a tab stop in
each horizontal position of the screen, so we need at least one flag for
each column of the screen. In the same way as dirty flags is used for the
rows, it is used a bool dinamic array.

Signed-off-by: Roberto E. Vargas Caballero &lt;k0ga@shike2.com&gt;
---
 st.c |   22 +++++++++++++++++++---
 1 file changed, 19 insertions(+), 3 deletions(-)
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">22</td><td><span class="i">+++++++++++++++++++</span><span class="d">---</span></td></tr>
</table></pre><pre>1 file changed, 19 insertions(+), 3 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -164,7 +164,7 @@ typedef struct {
</a> 	int col;	/* nb col */
 	Line* line;	/* screen */
 	Line* alt;	/* alternate screen */
<a href="#h0-0-3" id="h0-0-3" class="d">-	bool* dirty; /* dirtyness of lines */
</a><a href="#h0-0-4" id="h0-0-4" class="i">+	bool* dirty;	/* dirtyness of lines */
</a> 	TCursor c;	/* cursor */
 	int top;	/* top    scroll limit */
 	int bot;	/* bottom scroll limit */
<a href="#h0-1" id="h0-1" class="h">@@ -172,6 +172,7 @@ typedef struct {
</a> 	int esc;	/* escape state flags */
 	char title[ESC_TITLE_SIZ];
 	int titlelen;
<a href="#h0-1-3" id="h0-1-3" class="i">+	bool *tabs;
</a> } Term;
 
 /* Purely graphic info */
<a href="#h0-2" id="h0-2" class="h">@@ -847,12 +848,16 @@ tcursor(int mode) {
</a> 
 void
 treset(void) {
<a href="#h0-2-3" id="h0-2-3" class="i">+	unsigned i;
</a> 	term.c = (TCursor){{
 		.mode = ATTR_NULL,
 		.fg = DefaultFG,
 		.bg = DefaultBG
 	}, .x = 0, .y = 0, .state = CURSOR_DEFAULT};
<a href="#h0-2-9" id="h0-2-9" class="d">-	
</a><a href="#h0-2-10" id="h0-2-10" class="i">+
</a><a href="#h0-2-11" id="h0-2-11" class="i">+	memset(term.tabs, 0, term.col * sizeof(*term.tabs));
</a><a href="#h0-2-12" id="h0-2-12" class="i">+	for (i = TAB; i &lt; term.col; i += TAB)
</a><a href="#h0-2-13" id="h0-2-13" class="i">+		term.tabs[i] = 1;
</a> 	term.top = 0, term.bot = term.row - 1;
 	term.mode = MODE_WRAP;
 	tclearregion(0, 0, term.col-1, term.row-1);
<a href="#h0-3" id="h0-3" class="h">@@ -865,12 +870,14 @@ tnew(int col, int row) {
</a> 	term.line = malloc(term.row * sizeof(Line));
 	term.alt  = malloc(term.row * sizeof(Line));
 	term.dirty = malloc(term.row * sizeof(*term.dirty));
<a href="#h0-3-3" id="h0-3-3" class="i">+	term.tabs = malloc(term.col * sizeof(*term.tabs));
</a> 
 	for(row = 0; row &lt; term.row; row++) {
 		term.line[row] = malloc(term.col * sizeof(Glyph));
 		term.alt [row] = malloc(term.col * sizeof(Glyph));
 		term.dirty[row] = 0;
 	}
<a href="#h0-3-10" id="h0-3-10" class="i">+	memset(term.tabs, 0, term.col * sizeof(*term.tabs));
</a> 	/* setup screen */
 	treset();
 }
<a href="#h0-4" id="h0-4" class="h">@@ -1588,6 +1595,7 @@ tresize(int col, int row) {
</a> 	term.line = realloc(term.line, row * sizeof(Line));
 	term.alt  = realloc(term.alt,  row * sizeof(Line));
 	term.dirty = realloc(term.dirty, row * sizeof(*term.dirty));
<a href="#h0-4-3" id="h0-4-3" class="i">+	term.tabs = realloc(term.tabs, col * sizeof(*term.tabs));
</a> 
 	/* resize each row to new width, zero-pad if needed */
 	for(i = 0; i &lt; minrow; i++) {
<a href="#h0-5" id="h0-5" class="h">@@ -1606,7 +1614,15 @@ tresize(int col, int row) {
</a> 		term.line[i] = calloc(col, sizeof(Glyph));
 		term.alt [i] = calloc(col, sizeof(Glyph));
 	}
<a href="#h0-5-3" id="h0-5-3" class="d">-	
</a><a href="#h0-5-4" id="h0-5-4" class="i">+	if (col &gt; term.col) {
</a><a href="#h0-5-5" id="h0-5-5" class="i">+		bool *bp = term.tabs + term.col;
</a><a href="#h0-5-6" id="h0-5-6" class="i">+
</a><a href="#h0-5-7" id="h0-5-7" class="i">+		memset(bp, 0, sizeof(*term.tabs) * (col - term.col));
</a><a href="#h0-5-8" id="h0-5-8" class="i">+		while (--bp &gt; term.tabs &amp;&amp; !*bp)
</a><a href="#h0-5-9" id="h0-5-9" class="i">+			/* nothing */ ;
</a><a href="#h0-5-10" id="h0-5-10" class="i">+		for (bp += TAB; bp &lt; term.tabs + col; bp += TAB)
</a><a href="#h0-5-11" id="h0-5-11" class="i">+			*bp = 1;
</a><a href="#h0-5-12" id="h0-5-12" class="i">+	}
</a> 	/* update terminal size */
 	term.col = col, term.row = row;
 	/* make use of the LIMIT in tmoveto */
</pre>
</div>
</body>
</html>
