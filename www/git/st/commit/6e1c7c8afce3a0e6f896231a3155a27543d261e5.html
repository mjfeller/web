<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Fix match function bugs - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/6e1c7c8afce3a0e6f896231a3155a27543d261e5.html">6e1c7c8afce3a0e6f896231a3155a27543d261e5</a>
<b>parent</b> <a href="../commit/90c6f055b637a58da0381a21b4a290ce26f56d8f.html">90c6f055b637a58da0381a21b4a290ce26f56d8f</a>
<b>Author:</b> Roberto E. Vargas Caballero &lt;<a href="mailto:k0ga@shike2.com">k0ga@shike2.com</a>&gt;
<b>Date:</b>   Sun, 23 Jun 2013 10:33:53 +0200

Fix match function bugs

There were two problems with match denfinition.

1) There was a forward declaration in the form:

	static inline bool match(uint, uint);

but later the function was defined as:

	inline bool
	match(uint mask, uint state) {

This causes that there were two different functions in the code, one local
and inline, and other inline but extern. All was working without problems
due to we were using -Os, and the compiler was using the extern definition
and it was no expanding the static declaration. If you removed the -Os flag,
then you got linker errors due it was no able to find the static definition
of the static declaration.

2) The mask checking was incorrect because we were doing the test:

	(state &amp; mask) != state

and this test only was saying that at least all the enabled bits of state
were enabled also in mask, but no all the possible bits in mask. This was
the origin of the bug reported by Xavier Cartron, where he said it was
possible activated some shortcuts with some of the modifiers defined in the
config.h file.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
</table></pre><pre>1 file changed, 5 insertions(+), 5 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -3355,17 +3355,17 @@ focus(XEvent *ev) {
</a> 	}
 }
 
<a href="#h0-0-3" id="h0-0-3" class="d">-inline bool
</a><a href="#h0-0-4" id="h0-0-4" class="i">+static inline bool
</a> match(uint mask, uint state) {
<a href="#h0-0-6" id="h0-0-6" class="d">-	state &amp;= ~(ignoremod);
</a><a href="#h0-0-7" id="h0-0-7" class="i">+	state &amp;= ~ignoremod;
</a> 
 	if(mask == XK_NO_MOD &amp;&amp; state)
 		return false;
 	if(mask != XK_ANY_MOD &amp;&amp; mask != XK_NO_MOD &amp;&amp; !state)
 		return false;
<a href="#h0-0-13" id="h0-0-13" class="d">-	if((state &amp; mask) != state)
</a><a href="#h0-0-14" id="h0-0-14" class="d">-		return false;
</a><a href="#h0-0-15" id="h0-0-15" class="d">-	return true;
</a><a href="#h0-0-16" id="h0-0-16" class="i">+	if(mask == XK_ANY_MOD)
</a><a href="#h0-0-17" id="h0-0-17" class="i">+		return true;
</a><a href="#h0-0-18" id="h0-0-18" class="i">+	return state == mask;
</a> }
 
 void
</pre>
</div>
</body>
</html>
