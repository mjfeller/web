<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Split mode bits between Term and TermWindow - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/05c66cb37d9ff278a3e0c45682c4b5e7945deb42.html">05c66cb37d9ff278a3e0c45682c4b5e7945deb42</a>
<b>parent</b> <a href="../commit/33201ac65f74e45b4fa60822ba9a538c3cfa9b25.html">33201ac65f74e45b4fa60822ba9a538c3cfa9b25</a>
<b>Author:</b> Devin J. Pohly &lt;<a href="mailto:djpohly@gmail.com">djpohly@gmail.com</a>&gt;
<b>Date:</b>   Fri, 23 Feb 2018 14:16:52 -0600

Split mode bits between Term and TermWindow

Moves the mode bits used by x.c from Term to TermWindow, absorbing
UI/input-related mode bits (visible/focused/numlock) along the way.

This is gradually reducing external references to Term.  Since
TermWindow is already internal to x.c, we add xsetmode() to allow st to
modify window bits in accordance with escape sequences.

IS_SET() is redefined accordingly (term.mode in st.c, win.mode in x.c).

Signed-off-by: Devin J. Pohly &lt;djpohly@gmail.com&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">64</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">st.h</a></td><td> | </td><td class="num">33</td><td><span class="i">+</span><span class="d">--------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">win.h</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">x.c</a></td><td> | </td><td class="num">50</td><td><span class="i">+++++++++++++++++++++++++++++++</span><span class="d">-------------------</span></td></tr>
</table></pre><pre>4 files changed, 88 insertions(+), 83 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -42,6 +42,7 @@
</a> #define STR_ARG_SIZ   ESC_ARG_SIZ
 
 /* macros */
<a href="#h0-0-3" id="h0-0-3" class="i">+#define IS_SET(flag)		((term.mode &amp; (flag)) != 0)
</a> #define NUMMAXLEN(x)		((int)(sizeof(x) * 2.56 + 0.5) + 1)
 #define ISCONTROLC0(c)		(BETWEEN(c, 0, 0x1f) || (c) == &#39;\177&#39;)
 #define ISCONTROLC1(c)		(BETWEEN(c, 0x80, 0x9f))
<a href="#h0-1" id="h0-1" class="h">@@ -51,6 +52,17 @@
</a> /* constants */
 #define ISO14755CMD		&quot;dmenu -w \&quot;$WINDOWID\&quot; -p codepoint: &lt;/dev/null&quot;
 
<a href="#h0-1-3" id="h0-1-3" class="i">+enum term_mode {
</a><a href="#h0-1-4" id="h0-1-4" class="i">+	MODE_WRAP        = 1 &lt;&lt; 0,
</a><a href="#h0-1-5" id="h0-1-5" class="i">+	MODE_INSERT      = 1 &lt;&lt; 1,
</a><a href="#h0-1-6" id="h0-1-6" class="i">+	MODE_ALTSCREEN   = 1 &lt;&lt; 2,
</a><a href="#h0-1-7" id="h0-1-7" class="i">+	MODE_CRLF        = 1 &lt;&lt; 3,
</a><a href="#h0-1-8" id="h0-1-8" class="i">+	MODE_ECHO        = 1 &lt;&lt; 4,
</a><a href="#h0-1-9" id="h0-1-9" class="i">+	MODE_PRINT       = 1 &lt;&lt; 5,
</a><a href="#h0-1-10" id="h0-1-10" class="i">+	MODE_UTF8        = 1 &lt;&lt; 6,
</a><a href="#h0-1-11" id="h0-1-11" class="i">+	MODE_SIXEL       = 1 &lt;&lt; 7,
</a><a href="#h0-1-12" id="h0-1-12" class="i">+};
</a><a href="#h0-1-13" id="h0-1-13" class="i">+
</a> enum cursor_movement {
 	CURSOR_SAVE,
 	CURSOR_LOAD
<a href="#h0-2" id="h0-2" class="h">@@ -977,8 +989,6 @@ tnew(int col, int row)
</a> {
 	term = (Term){ .c = { .attr = { .fg = defaultfg, .bg = defaultbg } } };
 	tresize(col, row);
<a href="#h0-2-3" id="h0-2-3" class="d">-	term.numlock = 1;
</a><a href="#h0-2-4" id="h0-2-4" class="d">-
</a> 	treset();
 }
 
<a href="#h0-3" id="h0-3" class="h">@@ -1414,20 +1424,16 @@ tsetscroll(int t, int b)
</a> void
 tsetmode(int priv, int set, int *args, int narg)
 {
<a href="#h0-3-3" id="h0-3-3" class="d">-	int *lim, mode;
</a><a href="#h0-3-4" id="h0-3-4" class="d">-	int alt;
</a><a href="#h0-3-5" id="h0-3-5" class="i">+	int alt, *lim;
</a> 
 	for (lim = args + narg; args &lt; lim; ++args) {
 		if (priv) {
 			switch (*args) {
 			case 1: /* DECCKM -- Cursor key */
<a href="#h0-3-11" id="h0-3-11" class="d">-				MODBIT(term.mode, set, MODE_APPCURSOR);
</a><a href="#h0-3-12" id="h0-3-12" class="i">+				xsetmode(set, MODE_APPCURSOR);
</a> 				break;
 			case 5: /* DECSCNM -- Reverse video */
<a href="#h0-3-15" id="h0-3-15" class="d">-				mode = term.mode;
</a><a href="#h0-3-16" id="h0-3-16" class="d">-				MODBIT(term.mode, set, MODE_REVERSE);
</a><a href="#h0-3-17" id="h0-3-17" class="d">-				if (mode != term.mode)
</a><a href="#h0-3-18" id="h0-3-18" class="d">-					redraw();
</a><a href="#h0-3-19" id="h0-3-19" class="i">+				xsetmode(set, MODE_REVERSE);
</a> 				break;
 			case 6: /* DECOM -- Origin */
 				MODBIT(term.c.state, set, CURSOR_ORIGIN);
<a href="#h0-4" id="h0-4" class="h">@@ -1447,36 +1453,36 @@ tsetmode(int priv, int set, int *args, int narg)
</a> 			case 12: /* att610 -- Start blinking cursor (IGNORED) */
 				break;
 			case 25: /* DECTCEM -- Text Cursor Enable Mode */
<a href="#h0-4-3" id="h0-4-3" class="d">-				MODBIT(term.mode, !set, MODE_HIDE);
</a><a href="#h0-4-4" id="h0-4-4" class="i">+				xsetmode(!set, MODE_HIDE);
</a> 				break;
 			case 9:    /* X10 mouse compatibility mode */
 				xsetpointermotion(0);
<a href="#h0-4-8" id="h0-4-8" class="d">-				MODBIT(term.mode, 0, MODE_MOUSE);
</a><a href="#h0-4-9" id="h0-4-9" class="d">-				MODBIT(term.mode, set, MODE_MOUSEX10);
</a><a href="#h0-4-10" id="h0-4-10" class="i">+				xsetmode(0, MODE_MOUSE);
</a><a href="#h0-4-11" id="h0-4-11" class="i">+				xsetmode(set, MODE_MOUSEX10);
</a> 				break;
 			case 1000: /* 1000: report button press */
 				xsetpointermotion(0);
<a href="#h0-4-15" id="h0-4-15" class="d">-				MODBIT(term.mode, 0, MODE_MOUSE);
</a><a href="#h0-4-16" id="h0-4-16" class="d">-				MODBIT(term.mode, set, MODE_MOUSEBTN);
</a><a href="#h0-4-17" id="h0-4-17" class="i">+				xsetmode(0, MODE_MOUSE);
</a><a href="#h0-4-18" id="h0-4-18" class="i">+				xsetmode(set, MODE_MOUSEBTN);
</a> 				break;
 			case 1002: /* 1002: report motion on button press */
 				xsetpointermotion(0);
<a href="#h0-4-22" id="h0-4-22" class="d">-				MODBIT(term.mode, 0, MODE_MOUSE);
</a><a href="#h0-4-23" id="h0-4-23" class="d">-				MODBIT(term.mode, set, MODE_MOUSEMOTION);
</a><a href="#h0-4-24" id="h0-4-24" class="i">+				xsetmode(0, MODE_MOUSE);
</a><a href="#h0-4-25" id="h0-4-25" class="i">+				xsetmode(set, MODE_MOUSEMOTION);
</a> 				break;
 			case 1003: /* 1003: enable all mouse motions */
 				xsetpointermotion(set);
<a href="#h0-4-29" id="h0-4-29" class="d">-				MODBIT(term.mode, 0, MODE_MOUSE);
</a><a href="#h0-4-30" id="h0-4-30" class="d">-				MODBIT(term.mode, set, MODE_MOUSEMANY);
</a><a href="#h0-4-31" id="h0-4-31" class="i">+				xsetmode(0, MODE_MOUSE);
</a><a href="#h0-4-32" id="h0-4-32" class="i">+				xsetmode(set, MODE_MOUSEMANY);
</a> 				break;
 			case 1004: /* 1004: send focus events to tty */
<a href="#h0-4-35" id="h0-4-35" class="d">-				MODBIT(term.mode, set, MODE_FOCUS);
</a><a href="#h0-4-36" id="h0-4-36" class="i">+				xsetmode(set, MODE_FOCUS);
</a> 				break;
 			case 1006: /* 1006: extended reporting mode */
<a href="#h0-4-39" id="h0-4-39" class="d">-				MODBIT(term.mode, set, MODE_MOUSESGR);
</a><a href="#h0-4-40" id="h0-4-40" class="i">+				xsetmode(set, MODE_MOUSESGR);
</a> 				break;
 			case 1034:
<a href="#h0-4-43" id="h0-4-43" class="d">-				MODBIT(term.mode, set, MODE_8BIT);
</a><a href="#h0-4-44" id="h0-4-44" class="i">+				xsetmode(set, MODE_8BIT);
</a> 				break;
 			case 1049: /* swap screen &amp; set/restore cursor as xterm */
 				if (!allowaltscreen)
<a href="#h0-5" id="h0-5" class="h">@@ -1501,7 +1507,7 @@ tsetmode(int priv, int set, int *args, int narg)
</a> 				tcursor((set) ? CURSOR_SAVE : CURSOR_LOAD);
 				break;
 			case 2004: /* 2004: bracketed paste mode */
<a href="#h0-5-3" id="h0-5-3" class="d">-				MODBIT(term.mode, set, MODE_BRCKTPASTE);
</a><a href="#h0-5-4" id="h0-5-4" class="i">+				xsetmode(set, MODE_BRCKTPASTE);
</a> 				break;
 			/* Not implemented mouse modes. See comments there. */
 			case 1001: /* mouse highlight mode; can hang the
<a href="#h0-6" id="h0-6" class="h">@@ -1522,8 +1528,8 @@ tsetmode(int priv, int set, int *args, int narg)
</a> 			switch (*args) {
 			case 0:  /* Error (IGNORED) */
 				break;
<a href="#h0-6-3" id="h0-6-3" class="d">-			case 2:  /* KAM -- keyboard action */
</a><a href="#h0-6-4" id="h0-6-4" class="d">-				MODBIT(term.mode, set, MODE_KBDLOCK);
</a><a href="#h0-6-5" id="h0-6-5" class="i">+			case 2:
</a><a href="#h0-6-6" id="h0-6-6" class="i">+				xsetmode(set, MODE_KBDLOCK);
</a> 				break;
 			case 4:  /* IRM -- Insertion-replacement */
 				MODBIT(term.mode, set, MODE_INSERT);
<a href="#h0-7" id="h0-7" class="h">@@ -2230,10 +2236,10 @@ eschandle(uchar ascii)
</a> 		xloadcols();
 		break;
 	case &#39;=&#39;: /* DECPAM -- Application keypad */
<a href="#h0-7-3" id="h0-7-3" class="d">-		term.mode |= MODE_APPKEYPAD;
</a><a href="#h0-7-4" id="h0-7-4" class="i">+		xsetmode(1, MODE_APPKEYPAD);
</a> 		break;
 	case &#39;&gt;&#39;: /* DECPNM -- Normal keypad */
<a href="#h0-7-7" id="h0-7-7" class="d">-		term.mode &amp;= ~MODE_APPKEYPAD;
</a><a href="#h0-7-8" id="h0-7-8" class="i">+		xsetmode(0, MODE_APPKEYPAD);
</a> 		break;
 	case &#39;7&#39;: /* DECSC -- Save Cursor */
 		tcursor(CURSOR_SAVE);
<a href="#h0-8" id="h0-8" class="h">@@ -2526,9 +2532,3 @@ redraw(void)
</a> 	tfulldirt();
 	draw();
 }
<a href="#h0-8-3" id="h0-8-3" class="d">-
</a><a href="#h0-8-4" id="h0-8-4" class="d">-void
</a><a href="#h0-8-5" id="h0-8-5" class="d">-numlock(const Arg *dummy)
</a><a href="#h0-8-6" id="h0-8-6" class="d">-{
</a><a href="#h0-8-7" id="h0-8-7" class="d">-	term.numlock ^= 1;
</a><a href="#h0-8-8" id="h0-8-8" class="d">-}
</a><b>diff --git a/<a id="h1" href="../file/st.h.html">st.h</a> b/<a href="../file/st.h.html">st.h</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -13,7 +13,6 @@
</a> #define LIMIT(x, a, b)		(x) = (x) &lt; (a) ? (a) : (x) &gt; (b) ? (b) : (x)
 #define ATTRCMP(a, b)		((a).mode != (b).mode || (a).fg != (b).fg || \
 				(a).bg != (b).bg)
<a href="#h1-0-3" id="h1-0-3" class="d">-#define IS_SET(flag)		((term.mode &amp; (flag)) != 0)
</a> #define TIMEDIFF(t1, t2)	((t1.tv_sec-t2.tv_sec)*1000 + \
 				(t1.tv_nsec-t2.tv_nsec)/1E6)
 #define MODBIT(x, set, bit)	((set) ? ((x) |= (bit)) : ((x) &amp;= ~(bit)))
<a href="#h1-1" id="h1-1" class="h">@@ -37,34 +36,6 @@ enum glyph_attribute {
</a> 	ATTR_BOLD_FAINT = ATTR_BOLD | ATTR_FAINT,
 };
 
<a href="#h1-1-3" id="h1-1-3" class="d">-enum term_mode {
</a><a href="#h1-1-4" id="h1-1-4" class="d">-	MODE_WRAP        = 1 &lt;&lt; 0,
</a><a href="#h1-1-5" id="h1-1-5" class="d">-	MODE_INSERT      = 1 &lt;&lt; 1,
</a><a href="#h1-1-6" id="h1-1-6" class="d">-	MODE_APPKEYPAD   = 1 &lt;&lt; 2,
</a><a href="#h1-1-7" id="h1-1-7" class="d">-	MODE_ALTSCREEN   = 1 &lt;&lt; 3,
</a><a href="#h1-1-8" id="h1-1-8" class="d">-	MODE_CRLF        = 1 &lt;&lt; 4,
</a><a href="#h1-1-9" id="h1-1-9" class="d">-	MODE_MOUSEBTN    = 1 &lt;&lt; 5,
</a><a href="#h1-1-10" id="h1-1-10" class="d">-	MODE_MOUSEMOTION = 1 &lt;&lt; 6,
</a><a href="#h1-1-11" id="h1-1-11" class="d">-	MODE_REVERSE     = 1 &lt;&lt; 7,
</a><a href="#h1-1-12" id="h1-1-12" class="d">-	MODE_KBDLOCK     = 1 &lt;&lt; 8,
</a><a href="#h1-1-13" id="h1-1-13" class="d">-	MODE_HIDE        = 1 &lt;&lt; 9,
</a><a href="#h1-1-14" id="h1-1-14" class="d">-	MODE_ECHO        = 1 &lt;&lt; 10,
</a><a href="#h1-1-15" id="h1-1-15" class="d">-	MODE_APPCURSOR   = 1 &lt;&lt; 11,
</a><a href="#h1-1-16" id="h1-1-16" class="d">-	MODE_MOUSESGR    = 1 &lt;&lt; 12,
</a><a href="#h1-1-17" id="h1-1-17" class="d">-	MODE_8BIT        = 1 &lt;&lt; 13,
</a><a href="#h1-1-18" id="h1-1-18" class="d">-	MODE_BLINK       = 1 &lt;&lt; 14,
</a><a href="#h1-1-19" id="h1-1-19" class="d">-	MODE_FBLINK      = 1 &lt;&lt; 15,
</a><a href="#h1-1-20" id="h1-1-20" class="d">-	MODE_FOCUS       = 1 &lt;&lt; 16,
</a><a href="#h1-1-21" id="h1-1-21" class="d">-	MODE_MOUSEX10    = 1 &lt;&lt; 17,
</a><a href="#h1-1-22" id="h1-1-22" class="d">-	MODE_MOUSEMANY   = 1 &lt;&lt; 18,
</a><a href="#h1-1-23" id="h1-1-23" class="d">-	MODE_BRCKTPASTE  = 1 &lt;&lt; 19,
</a><a href="#h1-1-24" id="h1-1-24" class="d">-	MODE_PRINT       = 1 &lt;&lt; 20,
</a><a href="#h1-1-25" id="h1-1-25" class="d">-	MODE_UTF8        = 1 &lt;&lt; 21,
</a><a href="#h1-1-26" id="h1-1-26" class="d">-	MODE_SIXEL       = 1 &lt;&lt; 22,
</a><a href="#h1-1-27" id="h1-1-27" class="d">-	MODE_MOUSE       = MODE_MOUSEBTN|MODE_MOUSEMOTION|MODE_MOUSEX10\
</a><a href="#h1-1-28" id="h1-1-28" class="d">-	                  |MODE_MOUSEMANY,
</a><a href="#h1-1-29" id="h1-1-29" class="d">-};
</a><a href="#h1-1-30" id="h1-1-30" class="d">-
</a> enum selection_mode {
 	SEL_IDLE = 0,
 	SEL_EMPTY = 1,
<a href="#h1-2" id="h1-2" class="h">@@ -120,7 +91,6 @@ typedef struct {
</a> 	char trantbl[4]; /* charset table translation */
 	int charset;  /* current charset */
 	int icharset; /* selected charset for sequence */
<a href="#h1-2-3" id="h1-2-3" class="d">-	int numlock; /* lock numbers in keyboard */
</a> 	int *tabs;
 } Term;
 
<a href="#h1-3" id="h1-3" class="h">@@ -130,7 +100,7 @@ typedef struct {
</a> 	int w, h; /* window width and height */
 	int ch; /* char height */
 	int cw; /* char width  */
<a href="#h1-3-3" id="h1-3-3" class="d">-	char state; /* focus, redraw, visible */
</a><a href="#h1-3-4" id="h1-3-4" class="i">+	int mode; /* window state/mode flags */
</a> 	int cursor; /* cursor style */
 } TermWindow;
 
<a href="#h1-4" id="h1-4" class="h">@@ -163,7 +133,6 @@ void die(const char *, ...);
</a> void redraw(void);
 
 void iso14755(const Arg *);
<a href="#h1-4-3" id="h1-4-3" class="d">-void numlock(const Arg *);
</a> void printscreen(const Arg *);
 void printsel(const Arg *);
 void sendbreak(const Arg *);
<b>diff --git a/<a id="h2" href="../file/win.h.html">win.h</a> b/<a href="../file/win.h.html">win.h</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,5 +1,28 @@
</a> /* See LICENSE for license details. */
 
<a href="#h2-0-2" id="h2-0-2" class="i">+enum win_mode {
</a><a href="#h2-0-3" id="h2-0-3" class="i">+	MODE_VISIBLE     = 1 &lt;&lt; 0,
</a><a href="#h2-0-4" id="h2-0-4" class="i">+	MODE_FOCUSED     = 1 &lt;&lt; 1,
</a><a href="#h2-0-5" id="h2-0-5" class="i">+	MODE_APPKEYPAD   = 1 &lt;&lt; 2,
</a><a href="#h2-0-6" id="h2-0-6" class="i">+	MODE_MOUSEBTN    = 1 &lt;&lt; 3,
</a><a href="#h2-0-7" id="h2-0-7" class="i">+	MODE_MOUSEMOTION = 1 &lt;&lt; 4,
</a><a href="#h2-0-8" id="h2-0-8" class="i">+	MODE_REVERSE     = 1 &lt;&lt; 5,
</a><a href="#h2-0-9" id="h2-0-9" class="i">+	MODE_KBDLOCK     = 1 &lt;&lt; 6,
</a><a href="#h2-0-10" id="h2-0-10" class="i">+	MODE_HIDE        = 1 &lt;&lt; 7,
</a><a href="#h2-0-11" id="h2-0-11" class="i">+	MODE_APPCURSOR   = 1 &lt;&lt; 8,
</a><a href="#h2-0-12" id="h2-0-12" class="i">+	MODE_MOUSESGR    = 1 &lt;&lt; 9,
</a><a href="#h2-0-13" id="h2-0-13" class="i">+	MODE_8BIT        = 1 &lt;&lt; 10,
</a><a href="#h2-0-14" id="h2-0-14" class="i">+	MODE_BLINK       = 1 &lt;&lt; 11,
</a><a href="#h2-0-15" id="h2-0-15" class="i">+	MODE_FBLINK      = 1 &lt;&lt; 12,
</a><a href="#h2-0-16" id="h2-0-16" class="i">+	MODE_FOCUS       = 1 &lt;&lt; 13,
</a><a href="#h2-0-17" id="h2-0-17" class="i">+	MODE_MOUSEX10    = 1 &lt;&lt; 14,
</a><a href="#h2-0-18" id="h2-0-18" class="i">+	MODE_MOUSEMANY   = 1 &lt;&lt; 15,
</a><a href="#h2-0-19" id="h2-0-19" class="i">+	MODE_BRCKTPASTE  = 1 &lt;&lt; 16,
</a><a href="#h2-0-20" id="h2-0-20" class="i">+	MODE_NUMLOCK     = 1 &lt;&lt; 17,
</a><a href="#h2-0-21" id="h2-0-21" class="i">+	MODE_MOUSE       = MODE_MOUSEBTN|MODE_MOUSEMOTION|MODE_MOUSEX10\
</a><a href="#h2-0-22" id="h2-0-22" class="i">+	                  |MODE_MOUSEMANY,
</a><a href="#h2-0-23" id="h2-0-23" class="i">+};
</a><a href="#h2-0-24" id="h2-0-24" class="i">+
</a> void draw(void);
 void drawregion(int, int, int, int);
 
<a href="#h2-1" id="h2-1" class="h">@@ -10,5 +33,6 @@ void xloadcols(void);
</a> int xsetcolorname(int, const char *);
 void xsettitle(char *);
 int xsetcursor(int);
<a href="#h2-1-3" id="h2-1-3" class="i">+void xsetmode(int, unsigned int);
</a> void xsetpointermotion(int);
 void xsetsel(char *);
<b>diff --git a/<a id="h3" href="../file/x.c.html">x.c</a> b/<a href="../file/x.c.html">x.c</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -51,6 +51,7 @@ typedef struct {
</a> /* function definitions used in config.h */
 static void clipcopy(const Arg *);
 static void clippaste(const Arg *);
<a href="#h3-0-3" id="h3-0-3" class="i">+static void numlock(const Arg *);
</a> static void selpaste(const Arg *);
 static void zoom(const Arg *);
 static void zoomabs(const Arg *);
<a href="#h3-1" id="h3-1" class="h">@@ -64,6 +65,7 @@ static void zoomreset(const Arg *);
</a> #define XEMBED_FOCUS_OUT 5
 
 /* macros */
<a href="#h3-1-3" id="h3-1-3" class="i">+#define IS_SET(flag)		((win.mode &amp; (flag)) != 0)
</a> #define TRUERED(x)		(((x) &amp; 0xff0000) &gt;&gt; 8)
 #define TRUEGREEN(x)		(((x) &amp; 0xff00))
 #define TRUEBLUE(x)		(((x) &amp; 0xff) &lt;&lt; 8)
<a href="#h3-2" id="h3-2" class="h">@@ -196,11 +198,6 @@ static XWindow xw;
</a> static XSelection xsel;
 static TermWindow win;
 
<a href="#h3-2-3" id="h3-2-3" class="d">-enum window_state {
</a><a href="#h3-2-4" id="h3-2-4" class="d">-	WIN_VISIBLE = 1,
</a><a href="#h3-2-5" id="h3-2-5" class="d">-	WIN_FOCUSED = 2
</a><a href="#h3-2-6" id="h3-2-6" class="d">-};
</a><a href="#h3-2-7" id="h3-2-7" class="d">-
</a> /* Font Ring Cache */
 enum {
 	FRC_NORMAL,
<a href="#h3-3" id="h3-3" class="h">@@ -264,6 +261,12 @@ selpaste(const Arg *dummy)
</a> }
 
 void
<a href="#h3-3-3" id="h3-3-3" class="i">+numlock(const Arg *dummy)
</a><a href="#h3-3-4" id="h3-3-4" class="i">+{
</a><a href="#h3-3-5" id="h3-3-5" class="i">+	win.mode ^= MODE_NUMLOCK;
</a><a href="#h3-3-6" id="h3-3-6" class="i">+}
</a><a href="#h3-3-7" id="h3-3-7" class="i">+
</a><a href="#h3-3-8" id="h3-3-8" class="i">+void
</a> zoom(const Arg *arg)
 {
 	Arg larg;
<a href="#h3-4" id="h3-4" class="h">@@ -1090,6 +1093,7 @@ xinit(void)
</a> 	XChangeProperty(xw.dpy, xw.win, xw.netwmpid, XA_CARDINAL, 32,
 			PropModeReplace, (uchar *)&amp;thispid, 1);
 
<a href="#h3-4-3" id="h3-4-3" class="i">+	win.mode = MODE_NUMLOCK;
</a> 	resettitle();
 	XMapWindow(xw.dpy, xw.win);
 	xhints();
<a href="#h3-5" id="h3-5" class="h">@@ -1319,14 +1323,13 @@ xdrawglyphfontspecs(const XftGlyphFontSpec *specs, Glyph base, int len, int x, i
</a> 		fg = &amp;revfg;
 	}
 
<a href="#h3-5-3" id="h3-5-3" class="d">-
</a> 	if (base.mode &amp; ATTR_REVERSE) {
 		temp = fg;
 		fg = bg;
 		bg = temp;
 	}
 
<a href="#h3-5-10" id="h3-5-10" class="d">-	if (base.mode &amp; ATTR_BLINK &amp;&amp; term.mode &amp; MODE_BLINK)
</a><a href="#h3-5-11" id="h3-5-11" class="i">+	if (base.mode &amp; ATTR_BLINK &amp;&amp; win.mode &amp; MODE_BLINK)
</a> 		fg = bg;
 
 	if (base.mode &amp; ATTR_INVISIBLE)
<a href="#h3-6" id="h3-6" class="h">@@ -1440,7 +1443,7 @@ xdrawcursor(void)
</a> 		return;
 
 	/* draw the new one */
<a href="#h3-6-3" id="h3-6-3" class="d">-	if (win.state &amp; WIN_FOCUSED) {
</a><a href="#h3-6-4" id="h3-6-4" class="i">+	if (IS_SET(MODE_FOCUSED)) {
</a> 		switch (win.cursor) {
 		case 7: /* st extension: snowman */
 			utf8decode(&quot;â˜ƒ&quot;, &amp;g.u, UTF_SIZ);
<a href="#h3-7" id="h3-7" class="h">@@ -1527,7 +1530,7 @@ drawregion(int x1, int y1, int x2, int y2)
</a> 	Glyph base, new;
 	XftGlyphFontSpec *specs;
 
<a href="#h3-7-3" id="h3-7-3" class="d">-	if (!(win.state &amp; WIN_VISIBLE))
</a><a href="#h3-7-4" id="h3-7-4" class="i">+	if (!(IS_SET(MODE_VISIBLE)))
</a> 		return;
 
 	for (y = y1; y &lt; y2; y++) {
<a href="#h3-8" id="h3-8" class="h">@@ -1575,13 +1578,13 @@ visibility(XEvent *ev)
</a> {
 	XVisibilityEvent *e = &amp;ev-&gt;xvisibility;
 
<a href="#h3-8-3" id="h3-8-3" class="d">-	MODBIT(win.state, e-&gt;state != VisibilityFullyObscured, WIN_VISIBLE);
</a><a href="#h3-8-4" id="h3-8-4" class="i">+	MODBIT(win.mode, e-&gt;state != VisibilityFullyObscured, MODE_VISIBLE);
</a> }
 
 void
 unmap(XEvent *ev)
 {
<a href="#h3-8-10" id="h3-8-10" class="d">-	win.state &amp;= ~WIN_VISIBLE;
</a><a href="#h3-8-11" id="h3-8-11" class="i">+	win.mode &amp;= ~MODE_VISIBLE;
</a> }
 
 void
<a href="#h3-9" id="h3-9" class="h">@@ -1591,6 +1594,15 @@ xsetpointermotion(int set)
</a> 	XChangeWindowAttributes(xw.dpy, xw.win, CWEventMask, &amp;xw.attrs);
 }
 
<a href="#h3-9-3" id="h3-9-3" class="i">+void
</a><a href="#h3-9-4" id="h3-9-4" class="i">+xsetmode(int set, unsigned int flags)
</a><a href="#h3-9-5" id="h3-9-5" class="i">+{
</a><a href="#h3-9-6" id="h3-9-6" class="i">+	int mode = win.mode;
</a><a href="#h3-9-7" id="h3-9-7" class="i">+	MODBIT(win.mode, set, flags);
</a><a href="#h3-9-8" id="h3-9-8" class="i">+	if ((win.mode &amp; MODE_REVERSE) != (mode &amp; MODE_REVERSE))
</a><a href="#h3-9-9" id="h3-9-9" class="i">+		redraw();
</a><a href="#h3-9-10" id="h3-9-10" class="i">+}
</a><a href="#h3-9-11" id="h3-9-11" class="i">+
</a> int
 xsetcursor(int cursor)
 {
<a href="#h3-10" id="h3-10" class="h">@@ -1614,7 +1626,7 @@ xseturgency(int add)
</a> void
 xbell(void)
 {
<a href="#h3-10-3" id="h3-10-3" class="d">-	if (!(win.state &amp; WIN_FOCUSED))
</a><a href="#h3-10-4" id="h3-10-4" class="i">+	if (!(IS_SET(MODE_FOCUSED)))
</a> 		xseturgency(1);
 	if (bellvolume)
 		XkbBell(xw.dpy, xw.win, bellvolume, (Atom)NULL);
<a href="#h3-11" id="h3-11" class="h">@@ -1630,13 +1642,13 @@ focus(XEvent *ev)
</a> 
 	if (ev-&gt;type == FocusIn) {
 		XSetICFocus(xw.xic);
<a href="#h3-11-3" id="h3-11-3" class="d">-		win.state |= WIN_FOCUSED;
</a><a href="#h3-11-4" id="h3-11-4" class="i">+		win.mode |= MODE_FOCUSED;
</a> 		xseturgency(0);
 		if (IS_SET(MODE_FOCUS))
 			ttywrite(&quot;\033[I&quot;, 3, 0);
 	} else {
 		XUnsetICFocus(xw.xic);
<a href="#h3-11-10" id="h3-11-10" class="d">-		win.state &amp;= ~WIN_FOCUSED;
</a><a href="#h3-11-11" id="h3-11-11" class="i">+		win.mode &amp;= ~MODE_FOCUSED;
</a> 		if (IS_SET(MODE_FOCUS))
 			ttywrite(&quot;\033[O&quot;, 3, 0);
 	}
<a href="#h3-12" id="h3-12" class="h">@@ -1673,7 +1685,7 @@ kmap(KeySym k, uint state)
</a> 
 		if (IS_SET(MODE_APPKEYPAD) ? kp-&gt;appkey &lt; 0 : kp-&gt;appkey &gt; 0)
 			continue;
<a href="#h3-12-3" id="h3-12-3" class="d">-		if (term.numlock &amp;&amp; kp-&gt;appkey == 2)
</a><a href="#h3-12-4" id="h3-12-4" class="i">+		if (IS_SET(MODE_NUMLOCK) &amp;&amp; kp-&gt;appkey == 2)
</a> 			continue;
 
 		if (IS_SET(MODE_APPCURSOR) ? kp-&gt;appcursor &lt; 0 : kp-&gt;appcursor &gt; 0)
<a href="#h3-13" id="h3-13" class="h">@@ -1742,10 +1754,10 @@ cmessage(XEvent *e)
</a> 	 */
 	if (e-&gt;xclient.message_type == xw.xembed &amp;&amp; e-&gt;xclient.format == 32) {
 		if (e-&gt;xclient.data.l[1] == XEMBED_FOCUS_IN) {
<a href="#h3-13-3" id="h3-13-3" class="d">-			win.state |= WIN_FOCUSED;
</a><a href="#h3-13-4" id="h3-13-4" class="i">+			win.mode |= MODE_FOCUSED;
</a> 			xseturgency(0);
 		} else if (e-&gt;xclient.data.l[1] == XEMBED_FOCUS_OUT) {
<a href="#h3-13-7" id="h3-13-7" class="d">-			win.state &amp;= ~WIN_FOCUSED;
</a><a href="#h3-13-8" id="h3-13-8" class="i">+			win.mode &amp;= ~MODE_FOCUSED;
</a> 		}
 	} else if (e-&gt;xclient.data.l[0] == xw.wmdeletewin) {
 		/* Send SIGHUP to shell */
<a href="#h3-14" id="h3-14" class="h">@@ -1810,7 +1822,7 @@ run(void)
</a> 			if (blinktimeout) {
 				blinkset = tattrset(ATTR_BLINK);
 				if (!blinkset)
<a href="#h3-14-3" id="h3-14-3" class="d">-					MODBIT(term.mode, 0, MODE_BLINK);
</a><a href="#h3-14-4" id="h3-14-4" class="i">+					MODBIT(win.mode, 0, MODE_BLINK);
</a> 			}
 		}
 
<a href="#h3-15" id="h3-15" class="h">@@ -1825,7 +1837,7 @@ run(void)
</a> 		dodraw = 0;
 		if (blinktimeout &amp;&amp; TIMEDIFF(now, lastblink) &gt; blinktimeout) {
 			tsetdirtattr(ATTR_BLINK);
<a href="#h3-15-3" id="h3-15-3" class="d">-			term.mode ^= MODE_BLINK;
</a><a href="#h3-15-4" id="h3-15-4" class="i">+			win.mode ^= MODE_BLINK;
</a> 			lastblink = now;
 			dodraw = 1;
 		}
</pre>
</div>
</body>
</html>
