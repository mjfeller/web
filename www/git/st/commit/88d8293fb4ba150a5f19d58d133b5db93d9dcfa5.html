<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Move win-agnostic parts of draw/drawregion to st.c - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/88d8293fb4ba150a5f19d58d133b5db93d9dcfa5.html">88d8293fb4ba150a5f19d58d133b5db93d9dcfa5</a>
<b>parent</b> <a href="../commit/05c66cb37d9ff278a3e0c45682c4b5e7945deb42.html">05c66cb37d9ff278a3e0c45682c4b5e7945deb42</a>
<b>Author:</b> Devin J. Pohly &lt;<a href="mailto:djpohly@gmail.com">djpohly@gmail.com</a>&gt;
<b>Date:</b>   Sat, 24 Feb 2018 14:53:23 -0600

Move win-agnostic parts of draw/drawregion to st.c

Introduces three functions to encapsulate X-specific behavior:
 * xdrawline: draws a portion of a single line (used by drawregion)
 * xbegindraw: called to prepare for drawing (will be useful for e.g.
   Wayland) and returns true if drawing should happen
 * xfinishdraw: called to finish drawing (used by draw)

Signed-off-by: Devin J. Pohly &lt;djpohly@gmail.com&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">st.h</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">win.h</a></td><td> | </td><td class="num">7</td><td><span class="i">++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">x.c</a></td><td> | </td><td class="num">79</td><td><span class="i">+++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------------------</span></td></tr>
</table></pre><pre>4 files changed, 65 insertions(+), 47 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -166,6 +166,8 @@ static int32_t tdefcolor(int *, int *, int);
</a> static void tdeftran(char);
 static void tstrsequence(uchar);
 
<a href="#h0-0-3" id="h0-0-3" class="i">+static void drawregion(int, int, int, int);
</a><a href="#h0-0-4" id="h0-0-4" class="i">+
</a> static void selscroll(int, int);
 static void selsnap(int *, int *, int);
 
<a href="#h0-1" id="h0-1" class="h">@@ -2527,6 +2529,29 @@ resettitle(void)
</a> }
 
 void
<a href="#h0-1-3" id="h0-1-3" class="i">+drawregion(int x1, int y1, int x2, int y2)
</a><a href="#h0-1-4" id="h0-1-4" class="i">+{
</a><a href="#h0-1-5" id="h0-1-5" class="i">+	int y;
</a><a href="#h0-1-6" id="h0-1-6" class="i">+	for (y = y1; y &lt; y2; y++) {
</a><a href="#h0-1-7" id="h0-1-7" class="i">+		if (!term.dirty[y])
</a><a href="#h0-1-8" id="h0-1-8" class="i">+			continue;
</a><a href="#h0-1-9" id="h0-1-9" class="i">+
</a><a href="#h0-1-10" id="h0-1-10" class="i">+		term.dirty[y] = 0;
</a><a href="#h0-1-11" id="h0-1-11" class="i">+		xdrawline(term.line[y], x1, y, x2);
</a><a href="#h0-1-12" id="h0-1-12" class="i">+	}
</a><a href="#h0-1-13" id="h0-1-13" class="i">+}
</a><a href="#h0-1-14" id="h0-1-14" class="i">+
</a><a href="#h0-1-15" id="h0-1-15" class="i">+void
</a><a href="#h0-1-16" id="h0-1-16" class="i">+draw(void)
</a><a href="#h0-1-17" id="h0-1-17" class="i">+{
</a><a href="#h0-1-18" id="h0-1-18" class="i">+	if (!xstartdraw())
</a><a href="#h0-1-19" id="h0-1-19" class="i">+		return;
</a><a href="#h0-1-20" id="h0-1-20" class="i">+	drawregion(0, 0, term.col, term.row);
</a><a href="#h0-1-21" id="h0-1-21" class="i">+	xdrawcursor();
</a><a href="#h0-1-22" id="h0-1-22" class="i">+	xfinishdraw();
</a><a href="#h0-1-23" id="h0-1-23" class="i">+}
</a><a href="#h0-1-24" id="h0-1-24" class="i">+
</a><a href="#h0-1-25" id="h0-1-25" class="i">+void
</a> redraw(void)
 {
 	tfulldirt();
<b>diff --git a/<a id="h1" href="../file/st.h.html">st.h</a> b/<a href="../file/st.h.html">st.h</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -131,6 +131,7 @@ typedef union {
</a> 
 void die(const char *, ...);
 void redraw(void);
<a href="#h1-0-3" id="h1-0-3" class="i">+void draw(void);
</a> 
 void iso14755(const Arg *);
 void printscreen(const Arg *);
<b>diff --git a/<a id="h2" href="../file/win.h.html">win.h</a> b/<a href="../file/win.h.html">win.h</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -23,12 +23,12 @@ enum win_mode {
</a> 	                  |MODE_MOUSEMANY,
 };
 
<a href="#h2-0-3" id="h2-0-3" class="d">-void draw(void);
</a><a href="#h2-0-4" id="h2-0-4" class="d">-void drawregion(int, int, int, int);
</a><a href="#h2-0-5" id="h2-0-5" class="d">-
</a> void xbell(void);
 void xclipcopy(void);
<a href="#h2-0-8" id="h2-0-8" class="i">+void xdrawcursor(void);
</a><a href="#h2-0-9" id="h2-0-9" class="i">+void xdrawline(Line, int, int, int);
</a> void xhints(void);
<a href="#h2-0-11" id="h2-0-11" class="i">+void xfinishdraw(void);
</a> void xloadcols(void);
 int xsetcolorname(int, const char *);
 void xsettitle(char *);
<a href="#h2-1" id="h2-1" class="h">@@ -36,3 +36,4 @@ int xsetcursor(int);
</a> void xsetmode(int, unsigned int);
 void xsetpointermotion(int);
 void xsetsel(char *);
<a href="#h2-1-3" id="h2-1-3" class="i">+int xstartdraw(void);
</a><b>diff --git a/<a id="h3" href="../file/x.c.html">x.c</a> b/<a href="../file/x.c.html">x.c</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -129,7 +129,6 @@ static int xmakeglyphfontspecs(XftGlyphFontSpec *, const Glyph *, int, int, int)
</a> static void xdrawglyphfontspecs(const XftGlyphFontSpec *, Glyph, int, int, int);
 static void xdrawglyph(Glyph, int, int);
 static void xclear(int, int, int, int);
<a href="#h3-0-3" id="h3-0-3" class="d">-static void xdrawcursor(void);
</a> static int xgeommasktogravity(int);
 static void xinit(void);
 static void cresize(int, int);
<a href="#h3-1" id="h3-1" class="h">@@ -1512,59 +1511,51 @@ xsettitle(char *p)
</a> 	XFree(prop.value);
 }
 
<a href="#h3-1-3" id="h3-1-3" class="d">-void
</a><a href="#h3-1-4" id="h3-1-4" class="d">-draw(void)
</a><a href="#h3-1-5" id="h3-1-5" class="i">+int
</a><a href="#h3-1-6" id="h3-1-6" class="i">+xstartdraw(void)
</a> {
<a href="#h3-1-8" id="h3-1-8" class="d">-	drawregion(0, 0, term.col, term.row);
</a><a href="#h3-1-9" id="h3-1-9" class="d">-	XCopyArea(xw.dpy, xw.buf, xw.win, dc.gc, 0, 0, win.w,
</a><a href="#h3-1-10" id="h3-1-10" class="d">-			win.h, 0, 0);
</a><a href="#h3-1-11" id="h3-1-11" class="d">-	XSetForeground(xw.dpy, dc.gc,
</a><a href="#h3-1-12" id="h3-1-12" class="d">-			dc.col[IS_SET(MODE_REVERSE)?
</a><a href="#h3-1-13" id="h3-1-13" class="d">-				defaultfg : defaultbg].pixel);
</a><a href="#h3-1-14" id="h3-1-14" class="i">+	return IS_SET(MODE_VISIBLE);
</a> }
 
 void
<a href="#h3-1-18" id="h3-1-18" class="d">-drawregion(int x1, int y1, int x2, int y2)
</a><a href="#h3-1-19" id="h3-1-19" class="i">+xdrawline(Line line, int x1, int y1, int x2)
</a> {
<a href="#h3-1-21" id="h3-1-21" class="d">-	int i, x, y, ox, numspecs;
</a><a href="#h3-1-22" id="h3-1-22" class="i">+	int i, x, ox, numspecs;
</a> 	Glyph base, new;
<a href="#h3-1-24" id="h3-1-24" class="d">-	XftGlyphFontSpec *specs;
</a><a href="#h3-1-25" id="h3-1-25" class="i">+	XftGlyphFontSpec *specs = xw.specbuf;
</a> 
<a href="#h3-1-27" id="h3-1-27" class="d">-	if (!(IS_SET(MODE_VISIBLE)))
</a><a href="#h3-1-28" id="h3-1-28" class="d">-		return;
</a><a href="#h3-1-29" id="h3-1-29" class="d">-
</a><a href="#h3-1-30" id="h3-1-30" class="d">-	for (y = y1; y &lt; y2; y++) {
</a><a href="#h3-1-31" id="h3-1-31" class="d">-		if (!term.dirty[y])
</a><a href="#h3-1-32" id="h3-1-32" class="i">+	numspecs = xmakeglyphfontspecs(specs, &amp;line[x1], x2 - x1, x1, y1);
</a><a href="#h3-1-33" id="h3-1-33" class="i">+	i = ox = 0;
</a><a href="#h3-1-34" id="h3-1-34" class="i">+	for (x = x1; x &lt; x2 &amp;&amp; i &lt; numspecs; x++) {
</a><a href="#h3-1-35" id="h3-1-35" class="i">+		new = line[x];
</a><a href="#h3-1-36" id="h3-1-36" class="i">+		if (new.mode == ATTR_WDUMMY)
</a> 			continue;
<a href="#h3-1-38" id="h3-1-38" class="d">-
</a><a href="#h3-1-39" id="h3-1-39" class="d">-		term.dirty[y] = 0;
</a><a href="#h3-1-40" id="h3-1-40" class="d">-
</a><a href="#h3-1-41" id="h3-1-41" class="d">-		specs = xw.specbuf;
</a><a href="#h3-1-42" id="h3-1-42" class="d">-		numspecs = xmakeglyphfontspecs(specs, &amp;term.line[y][x1], x2 - x1, x1, y);
</a><a href="#h3-1-43" id="h3-1-43" class="d">-
</a><a href="#h3-1-44" id="h3-1-44" class="d">-		i = ox = 0;
</a><a href="#h3-1-45" id="h3-1-45" class="d">-		for (x = x1; x &lt; x2 &amp;&amp; i &lt; numspecs; x++) {
</a><a href="#h3-1-46" id="h3-1-46" class="d">-			new = term.line[y][x];
</a><a href="#h3-1-47" id="h3-1-47" class="d">-			if (new.mode == ATTR_WDUMMY)
</a><a href="#h3-1-48" id="h3-1-48" class="d">-				continue;
</a><a href="#h3-1-49" id="h3-1-49" class="d">-			if (selected(x, y))
</a><a href="#h3-1-50" id="h3-1-50" class="d">-				new.mode ^= ATTR_REVERSE;
</a><a href="#h3-1-51" id="h3-1-51" class="d">-			if (i &gt; 0 &amp;&amp; ATTRCMP(base, new)) {
</a><a href="#h3-1-52" id="h3-1-52" class="d">-				xdrawglyphfontspecs(specs, base, i, ox, y);
</a><a href="#h3-1-53" id="h3-1-53" class="d">-				specs += i;
</a><a href="#h3-1-54" id="h3-1-54" class="d">-				numspecs -= i;
</a><a href="#h3-1-55" id="h3-1-55" class="d">-				i = 0;
</a><a href="#h3-1-56" id="h3-1-56" class="d">-			}
</a><a href="#h3-1-57" id="h3-1-57" class="d">-			if (i == 0) {
</a><a href="#h3-1-58" id="h3-1-58" class="d">-				ox = x;
</a><a href="#h3-1-59" id="h3-1-59" class="d">-				base = new;
</a><a href="#h3-1-60" id="h3-1-60" class="d">-			}
</a><a href="#h3-1-61" id="h3-1-61" class="d">-			i++;
</a><a href="#h3-1-62" id="h3-1-62" class="i">+		if (selected(x, y1))
</a><a href="#h3-1-63" id="h3-1-63" class="i">+			new.mode ^= ATTR_REVERSE;
</a><a href="#h3-1-64" id="h3-1-64" class="i">+		if (i &gt; 0 &amp;&amp; ATTRCMP(base, new)) {
</a><a href="#h3-1-65" id="h3-1-65" class="i">+			xdrawglyphfontspecs(specs, base, i, ox, y1);
</a><a href="#h3-1-66" id="h3-1-66" class="i">+			specs += i;
</a><a href="#h3-1-67" id="h3-1-67" class="i">+			numspecs -= i;
</a><a href="#h3-1-68" id="h3-1-68" class="i">+			i = 0;
</a><a href="#h3-1-69" id="h3-1-69" class="i">+		}
</a><a href="#h3-1-70" id="h3-1-70" class="i">+		if (i == 0) {
</a><a href="#h3-1-71" id="h3-1-71" class="i">+			ox = x;
</a><a href="#h3-1-72" id="h3-1-72" class="i">+			base = new;
</a> 		}
<a href="#h3-1-74" id="h3-1-74" class="d">-		if (i &gt; 0)
</a><a href="#h3-1-75" id="h3-1-75" class="d">-			xdrawglyphfontspecs(specs, base, i, ox, y);
</a><a href="#h3-1-76" id="h3-1-76" class="i">+		i++;
</a> 	}
<a href="#h3-1-78" id="h3-1-78" class="d">-	xdrawcursor();
</a><a href="#h3-1-79" id="h3-1-79" class="i">+	if (i &gt; 0)
</a><a href="#h3-1-80" id="h3-1-80" class="i">+		xdrawglyphfontspecs(specs, base, i, ox, y1);
</a><a href="#h3-1-81" id="h3-1-81" class="i">+}
</a><a href="#h3-1-82" id="h3-1-82" class="i">+
</a><a href="#h3-1-83" id="h3-1-83" class="i">+void
</a><a href="#h3-1-84" id="h3-1-84" class="i">+xfinishdraw(void)
</a><a href="#h3-1-85" id="h3-1-85" class="i">+{
</a><a href="#h3-1-86" id="h3-1-86" class="i">+	XCopyArea(xw.dpy, xw.buf, xw.win, dc.gc, 0, 0, win.w,
</a><a href="#h3-1-87" id="h3-1-87" class="i">+			win.h, 0, 0);
</a><a href="#h3-1-88" id="h3-1-88" class="i">+	XSetForeground(xw.dpy, dc.gc,
</a><a href="#h3-1-89" id="h3-1-89" class="i">+			dc.col[IS_SET(MODE_REVERSE)?
</a><a href="#h3-1-90" id="h3-1-90" class="i">+				defaultfg : defaultbg].pixel);
</a> }
 
 void
</pre>
</div>
</body>
</html>
