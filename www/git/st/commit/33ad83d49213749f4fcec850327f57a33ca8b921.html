<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Improved font caching - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/33ad83d49213749f4fcec850327f57a33ca8b921.html">33ad83d49213749f4fcec850327f57a33ca8b921</a>
<b>parent</b> <a href="../commit/40e4d76d227d9c517054036f546acd49431bca42.html">40e4d76d227d9c517054036f546acd49431bca42</a>
<b>Author:</b> Eon S. Jeon &lt;<a href="mailto:esjeon@lavabit.com">esjeon@lavabit.com</a>&gt;
<b>Date:</b>   Fri, 19 Jul 2013 01:07:02 -0400

Improved font caching

I made a patch that improves the performance of font caching mechanism.
This is based on a funny behaviour of FontConfig: it was handling
FcCharSet in a somewhat unexpected way.

So, we are currently adding &quot;a character&quot; to a new FcCharSet, and then
add it to a FcPattern. However, if we toss the FcPattern to FontConfig,
it loads the entire language(charset) that contains the character we
gave. That is, we don&#39;t always have to load a new font for each unknown
character. Instead, we can reused cached fonts, and this significantly
reduces the number of calls to extremely slow FontConfig matching
functions.

One more thing. I found that, in libXft, there&#39;s a function called
XftCharExists. XftCharIndex internally calls this function, and
does more stuffs if the character does exist. Since the returned index
is never used in st, we should call XftCharExists instead of
XftCharIndex. Please note that I already made this change in the patch.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">63</td><td><span class="i">++++++++++++++++++++++</span><span class="d">-----------------------------------------</span></td></tr>
</table></pre><pre>1 file changed, 22 insertions(+), 41 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -462,17 +462,12 @@ enum {
</a> 
 typedef struct {
 	XftFont *font;
<a href="#h0-0-3" id="h0-0-3" class="d">-	long c;
</a> 	int flags;
 } Fontcache;
 
<a href="#h0-0-7" id="h0-0-7" class="d">-/*
</a><a href="#h0-0-8" id="h0-0-8" class="d">- * Fontcache is a ring buffer, with frccur as current position and frclen as
</a><a href="#h0-0-9" id="h0-0-9" class="d">- * the current length of used elements.
</a><a href="#h0-0-10" id="h0-0-10" class="d">- */
</a><a href="#h0-0-11" id="h0-0-11" class="d">-
</a><a href="#h0-0-12" id="h0-0-12" class="d">-static Fontcache frc[1024];
</a><a href="#h0-0-13" id="h0-0-13" class="d">-static int frccur = -1, frclen = 0;
</a><a href="#h0-0-14" id="h0-0-14" class="i">+/* Fontcache is an array now. A new font will be appended to the array. */
</a><a href="#h0-0-15" id="h0-0-15" class="i">+static Fontcache frc[16];
</a><a href="#h0-0-16" id="h0-0-16" class="i">+static int frclen = 0;
</a> 
 ssize_t
 xwrite(int fd, char *s, size_t len) {
<a href="#h0-1" id="h0-1" class="h">@@ -2781,18 +2776,12 @@ xunloadfont(Font *f) {
</a> 
 void
 xunloadfonts(void) {
<a href="#h0-1-3" id="h0-1-3" class="d">-	int i, ip;
</a><a href="#h0-1-4" id="h0-1-4" class="i">+	int i;
</a> 
<a href="#h0-1-6" id="h0-1-6" class="d">-	/*
</a><a href="#h0-1-7" id="h0-1-7" class="d">-	 * Free the loaded fonts in the font cache. This is done backwards
</a><a href="#h0-1-8" id="h0-1-8" class="d">-	 * from the frccur.
</a><a href="#h0-1-9" id="h0-1-9" class="d">-	 */
</a><a href="#h0-1-10" id="h0-1-10" class="d">-	for(i = 0, ip = frccur; i &lt; frclen; i++, ip--) {
</a><a href="#h0-1-11" id="h0-1-11" class="d">-		if(ip &lt; 0)
</a><a href="#h0-1-12" id="h0-1-12" class="d">-			ip = LEN(frc) - 1;
</a><a href="#h0-1-13" id="h0-1-13" class="d">-		XftFontClose(xw.dpy, frc[ip].font);
</a><a href="#h0-1-14" id="h0-1-14" class="i">+	/* Free the loaded fonts in the font cache.  */
</a><a href="#h0-1-15" id="h0-1-15" class="i">+	for(i = 0; i &lt; frclen; i++) {
</a><a href="#h0-1-16" id="h0-1-16" class="i">+		XftFontClose(xw.dpy, frc[i].font);
</a> 	}
<a href="#h0-1-18" id="h0-1-18" class="d">-	frccur = -1;
</a> 	frclen = 0;
 
 	xunloadfont(&amp;dc.font);
<a href="#h0-2" id="h0-2" class="h">@@ -2918,7 +2907,7 @@ void
</a> xdraws(char *s, Glyph base, int x, int y, int charlen, int bytelen) {
 	int winx = borderpx + x * xw.cw, winy = borderpx + y * xw.ch,
 	    width = charlen * xw.cw, xp, i;
<a href="#h0-2-3" id="h0-2-3" class="d">-	int frp, frcflags;
</a><a href="#h0-2-4" id="h0-2-4" class="i">+	int frcflags;
</a> 	int u8fl, u8fblen, u8cblen, doesexist;
 	char *u8c, *u8fs;
 	long u8char;
<a href="#h0-3" id="h0-3" class="h">@@ -3044,7 +3033,7 @@ xdraws(char *s, Glyph base, int x, int y, int charlen, int bytelen) {
</a> 			s += u8cblen;
 			bytelen -= u8cblen;
 
<a href="#h0-3-3" id="h0-3-3" class="d">-			doesexist = XftCharIndex(xw.dpy, font-&gt;match, u8char);
</a><a href="#h0-3-4" id="h0-3-4" class="i">+			doesexist = XftCharExists(xw.dpy, font-&gt;match, u8char);
</a> 			if(!doesexist || bytelen &lt;= 0) {
 				if(bytelen &lt;= 0) {
 					if(doesexist) {
<a href="#h0-4" id="h0-4" class="h">@@ -3071,14 +3060,10 @@ xdraws(char *s, Glyph base, int x, int y, int charlen, int bytelen) {
</a> 		if(doesexist)
 			break;
 
<a href="#h0-4-3" id="h0-4-3" class="d">-		frp = frccur;
</a> 		/* Search the font cache. */
<a href="#h0-4-5" id="h0-4-5" class="d">-		for(i = 0; i &lt; frclen; i++, frp--) {
</a><a href="#h0-4-6" id="h0-4-6" class="d">-			if(frp &lt;= 0)
</a><a href="#h0-4-7" id="h0-4-7" class="d">-				frp = LEN(frc) - 1;
</a><a href="#h0-4-8" id="h0-4-8" class="d">-
</a><a href="#h0-4-9" id="h0-4-9" class="d">-			if(frc[frp].c == u8char
</a><a href="#h0-4-10" id="h0-4-10" class="d">-					&amp;&amp; frc[frp].flags == frcflags) {
</a><a href="#h0-4-11" id="h0-4-11" class="i">+		for(i = 0; i &lt; frclen; i++) {
</a><a href="#h0-4-12" id="h0-4-12" class="i">+			if(XftCharExists(xw.dpy, frc[i].font, u8char)
</a><a href="#h0-4-13" id="h0-4-13" class="i">+					&amp;&amp; frc[i].flags == frcflags) {
</a> 				break;
 			}
 		}
<a href="#h0-5" id="h0-5" class="h">@@ -3113,28 +3098,24 @@ xdraws(char *s, Glyph base, int x, int y, int charlen, int bytelen) {
</a> 			/*
 			 * Overwrite or create the new cache entry.
 			 */
<a href="#h0-5-3" id="h0-5-3" class="d">-			frccur++;
</a><a href="#h0-5-4" id="h0-5-4" class="d">-			frclen++;
</a><a href="#h0-5-5" id="h0-5-5" class="d">-			if(frccur &gt;= LEN(frc))
</a><a href="#h0-5-6" id="h0-5-6" class="d">-				frccur = 0;
</a><a href="#h0-5-7" id="h0-5-7" class="d">-			if(frclen &gt; LEN(frc)) {
</a><a href="#h0-5-8" id="h0-5-8" class="d">-				frclen = LEN(frc);
</a><a href="#h0-5-9" id="h0-5-9" class="d">-				XftFontClose(xw.dpy, frc[frccur].font);
</a><a href="#h0-5-10" id="h0-5-10" class="i">+			if(frclen &gt;= LEN(frc)) {
</a><a href="#h0-5-11" id="h0-5-11" class="i">+				frclen = LEN(frc) - 1;
</a><a href="#h0-5-12" id="h0-5-12" class="i">+				XftFontClose(xw.dpy, frc[frclen].font);
</a> 			}
 
<a href="#h0-5-15" id="h0-5-15" class="d">-			frc[frccur].font = XftFontOpenPattern(xw.dpy,
</a><a href="#h0-5-16" id="h0-5-16" class="i">+			frc[frclen].font = XftFontOpenPattern(xw.dpy,
</a> 					fontpattern);
<a href="#h0-5-18" id="h0-5-18" class="d">-			frc[frccur].c = u8char;
</a><a href="#h0-5-19" id="h0-5-19" class="d">-			frc[frccur].flags = frcflags;
</a><a href="#h0-5-20" id="h0-5-20" class="i">+			frc[frclen].flags = frcflags;
</a><a href="#h0-5-21" id="h0-5-21" class="i">+
</a><a href="#h0-5-22" id="h0-5-22" class="i">+			i = frclen;
</a><a href="#h0-5-23" id="h0-5-23" class="i">+			frclen++;
</a> 
 			FcPatternDestroy(fcpattern);
 			FcCharSetDestroy(fccharset);
<a href="#h0-5-27" id="h0-5-27" class="d">-
</a><a href="#h0-5-28" id="h0-5-28" class="d">-			frp = frccur;
</a> 		}
 
<a href="#h0-5-31" id="h0-5-31" class="d">-		XftDrawStringUtf8(xw.draw, fg, frc[frp].font,
</a><a href="#h0-5-32" id="h0-5-32" class="d">-				xp, winy + frc[frp].font-&gt;ascent,
</a><a href="#h0-5-33" id="h0-5-33" class="i">+		XftDrawStringUtf8(xw.draw, fg, frc[i].font,
</a><a href="#h0-5-34" id="h0-5-34" class="i">+				xp, winy + frc[i].font-&gt;ascent,
</a> 				(FcChar8 *)u8c, u8cblen);
 
 		xp += font-&gt;width;
</pre>
</div>
</body>
</html>
