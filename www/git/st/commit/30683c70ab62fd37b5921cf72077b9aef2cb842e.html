<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Limit usage of extern to config.h globals - st - simple terminal
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st</h1><span class="desc">simple terminal
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/30683c70ab62fd37b5921cf72077b9aef2cb842e.html">30683c70ab62fd37b5921cf72077b9aef2cb842e</a>
<b>parent</b> <a href="../commit/a3beb626d2dae9d4d0883c7c8cb6ba58b0609105.html">a3beb626d2dae9d4d0883c7c8cb6ba58b0609105</a>
<b>Author:</b> Devin J. Pohly &lt;<a href="mailto:djpohly@gmail.com">djpohly@gmail.com</a>&gt;
<b>Date:</b>   Sat, 24 Feb 2018 16:16:12 -0600

Limit usage of extern to config.h globals

Prefer passing arguments to declaring external global variables.  The
only remaining usage of extern is for config.h variables which are
needed in st.c instead of x.c (where it is now included).

Signed-off-by: Devin J. Pohly &lt;djpohly@gmail.com&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">config.def.h</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">st.c</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">st.h</a></td><td> | </td><td class="num">9</td><td><span class="i">++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">x.c</a></td><td> | </td><td class="num">16</td><td><span class="i">+++++++++</span><span class="d">-------</span></td></tr>
</table></pre><pre>4 files changed, 29 insertions(+), 27 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config.def.h.html">config.def.h</a> b/<a href="../file/config.def.h.html">config.def.h</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -16,7 +16,7 @@ static int borderpx = 2;
</a>  * 4: value of shell in /etc/passwd
  * 5: value of shell in config.h
  */
<a href="#h0-0-3" id="h0-0-3" class="d">-char *shell = &quot;/bin/sh&quot;;
</a><a href="#h0-0-4" id="h0-0-4" class="i">+static char *shell = &quot;/bin/sh&quot;;
</a> char *utmp = NULL;
 char *stty_args = &quot;stty raw pass8 nl -echo -iexten -cstopb 38400&quot;;
 
<b>diff --git a/<a id="h1" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -136,8 +136,7 @@ typedef struct {
</a> 	int narg;              /* nb of args */
 } STREscape;
 
<a href="#h1-0-3" id="h1-0-3" class="d">-
</a><a href="#h1-0-4" id="h1-0-4" class="d">-static void execsh(char **);
</a><a href="#h1-0-5" id="h1-0-5" class="i">+static void execsh(char *, char **);
</a> static void stty(char **);
 static void sigchld(int);
 static void ttywriteraw(const char *, size_t);
<a href="#h1-1" id="h1-1" class="h">@@ -201,15 +200,13 @@ static char *base64dec(const char *);
</a> static ssize_t xwrite(int, const char *, size_t);
 
 /* Globals */
<a href="#h1-1-3" id="h1-1-3" class="d">-int cmdfd;
</a><a href="#h1-1-4" id="h1-1-4" class="d">-pid_t pid;
</a><a href="#h1-1-5" id="h1-1-5" class="d">-int oldbutton   = 3; /* button event on startup: 3 = release */
</a><a href="#h1-1-6" id="h1-1-6" class="d">-
</a> static Term term;
 static Selection sel;
 static CSIEscape csiescseq;
 static STREscape strescseq;
 static int iofd = 1;
<a href="#h1-1-12" id="h1-1-12" class="i">+static int cmdfd;
</a><a href="#h1-1-13" id="h1-1-13" class="i">+static pid_t pid;
</a> 
 static uchar utfbyte[UTF_SIZ + 1] = {0x80,    0, 0xC0, 0xE0, 0xF0};
 static uchar utfmask[UTF_SIZ + 1] = {0xC0, 0x80, 0xE0, 0xF0, 0xF8};
<a href="#h1-2" id="h1-2" class="h">@@ -659,7 +656,7 @@ die(const char *errstr, ...)
</a> }
 
 void
<a href="#h1-2-3" id="h1-2-3" class="d">-execsh(char **args)
</a><a href="#h1-2-4" id="h1-2-4" class="i">+execsh(char *cmd, char **args)
</a> {
 	char *sh, *prog;
 	const struct passwd *pw;
<a href="#h1-3" id="h1-3" class="h">@@ -673,7 +670,7 @@ execsh(char **args)
</a> 	}
 
 	if ((sh = getenv(&quot;SHELL&quot;)) == NULL)
<a href="#h1-3-3" id="h1-3-3" class="d">-		sh = (pw-&gt;pw_shell[0]) ? pw-&gt;pw_shell : shell;
</a><a href="#h1-3-4" id="h1-3-4" class="i">+		sh = (pw-&gt;pw_shell[0]) ? pw-&gt;pw_shell : cmd;
</a> 
 	if (args)
 		prog = args[0];
<a href="#h1-4" id="h1-4" class="h">@@ -745,8 +742,8 @@ stty(char **args)
</a> 	    perror(&quot;Couldn&#39;t call stty&quot;);
 }
 
<a href="#h1-4-3" id="h1-4-3" class="d">-void
</a><a href="#h1-4-4" id="h1-4-4" class="d">-ttynew(char *line, char *out, char **args)
</a><a href="#h1-4-5" id="h1-4-5" class="i">+int
</a><a href="#h1-4-6" id="h1-4-6" class="i">+ttynew(char *line, char *cmd, char *out, char **args)
</a> {
 	int m, s;
 
<a href="#h1-5" id="h1-5" class="h">@@ -765,7 +762,7 @@ ttynew(char *line, char *out, char **args)
</a> 			die(&quot;open line failed: %s\n&quot;, strerror(errno));
 		dup2(cmdfd, 0);
 		stty(args);
<a href="#h1-5-3" id="h1-5-3" class="d">-		return;
</a><a href="#h1-5-4" id="h1-5-4" class="i">+		return cmdfd;
</a> 	}
 
 	/* seems to work fine on linux, openbsd and freebsd */
<a href="#h1-6" id="h1-6" class="h">@@ -786,7 +783,7 @@ ttynew(char *line, char *out, char **args)
</a> 			die(&quot;ioctl TIOCSCTTY failed: %s\n&quot;, strerror(errno));
 		close(s);
 		close(m);
<a href="#h1-6-3" id="h1-6-3" class="d">-		execsh(args);
</a><a href="#h1-6-4" id="h1-6-4" class="i">+		execsh(cmd, args);
</a> 		break;
 	default:
 		close(s);
<a href="#h1-7" id="h1-7" class="h">@@ -794,6 +791,7 @@ ttynew(char *line, char *out, char **args)
</a> 		signal(SIGCHLD, sigchld);
 		break;
 	}
<a href="#h1-7-3" id="h1-7-3" class="i">+	return cmdfd;
</a> }
 
 size_t
<a href="#h1-8" id="h1-8" class="h">@@ -916,6 +914,13 @@ ttyresize(int tw, int th)
</a> 		fprintf(stderr, &quot;Couldn&#39;t set window size: %s\n&quot;, strerror(errno));
 }
 
<a href="#h1-8-3" id="h1-8-3" class="i">+void
</a><a href="#h1-8-4" id="h1-8-4" class="i">+ttyhangup()
</a><a href="#h1-8-5" id="h1-8-5" class="i">+{
</a><a href="#h1-8-6" id="h1-8-6" class="i">+	/* Send SIGHUP to shell */
</a><a href="#h1-8-7" id="h1-8-7" class="i">+	kill(pid, SIGHUP);
</a><a href="#h1-8-8" id="h1-8-8" class="i">+}
</a><a href="#h1-8-9" id="h1-8-9" class="i">+
</a> int
 tattrset(int attr)
 {
<b>diff --git a/<a id="h2" href="../file/st.h.html">st.h</a> b/<a href="../file/st.h.html">st.h</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -125,7 +125,8 @@ int tattrset(int);
</a> void tnew(int, int);
 void tresize(int, int);
 void tsetdirtattr(int);
<a href="#h2-0-3" id="h2-0-3" class="d">-void ttynew(char *, char *, char **);
</a><a href="#h2-0-4" id="h2-0-4" class="i">+void ttyhangup(void);
</a><a href="#h2-0-5" id="h2-0-5" class="i">+int ttynew(char *, char *, char *, char **);
</a> size_t ttyread(void);
 void ttyresize(int, int);
 void ttywrite(const char *, size_t, int);
<a href="#h2-1" id="h2-1" class="h">@@ -147,13 +148,7 @@ void *xmalloc(size_t);
</a> void *xrealloc(void *, size_t);
 char *xstrdup(char *);
 
<a href="#h2-1-3" id="h2-1-3" class="d">-/* Globals */
</a><a href="#h2-1-4" id="h2-1-4" class="d">-extern int cmdfd;
</a><a href="#h2-1-5" id="h2-1-5" class="d">-extern pid_t pid;
</a><a href="#h2-1-6" id="h2-1-6" class="d">-extern int oldbutton;
</a><a href="#h2-1-7" id="h2-1-7" class="d">-
</a> /* config.h globals */
<a href="#h2-1-9" id="h2-1-9" class="d">-extern char *shell;
</a> extern char *utmp;
 extern char *stty_args;
 extern char *vtiden;
<b>diff --git a/<a id="h3" href="../file/x.c.html">x.c</a> b/<a href="../file/x.c.html">x.c</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -227,6 +227,8 @@ static char *opt_line  = NULL;
</a> static char *opt_name  = NULL;
 static char *opt_title = NULL;
 
<a href="#h3-0-3" id="h3-0-3" class="i">+static int oldbutton = 3; /* button event on startup: 3 = release */
</a><a href="#h3-0-4" id="h3-0-4" class="i">+
</a> void
 clipcopy(const Arg *dummy)
 {
<a href="#h3-1" id="h3-1" class="h">@@ -1733,8 +1735,7 @@ cmessage(XEvent *e)
</a> 			win.mode &amp;= ~MODE_FOCUSED;
 		}
 	} else if (e-&gt;xclient.data.l[0] == xw.wmdeletewin) {
<a href="#h3-1-3" id="h3-1-3" class="d">-		/* Send SIGHUP to shell */
</a><a href="#h3-1-4" id="h3-1-4" class="d">-		kill(pid, SIGHUP);
</a><a href="#h3-1-5" id="h3-1-5" class="i">+		ttyhangup();
</a> 		exit(0);
 	}
 }
<a href="#h3-2" id="h3-2" class="h">@@ -1755,6 +1756,7 @@ run(void)
</a> 	int w = win.w, h = win.h;
 	fd_set rfd;
 	int xfd = XConnectionNumber(xw.dpy), xev, blinkset = 0, dodraw = 0;
<a href="#h3-2-3" id="h3-2-3" class="i">+	int ttyfd;
</a> 	struct timespec drawtimeout, *tv = NULL, now, last, lastblink;
 	long deltatime;
 
<a href="#h3-3" id="h3-3" class="h">@@ -1774,7 +1776,7 @@ run(void)
</a> 		}
 	} while (ev.type != MapNotify);
 
<a href="#h3-3-3" id="h3-3-3" class="d">-	ttynew(opt_line, opt_io, opt_cmd);
</a><a href="#h3-3-4" id="h3-3-4" class="i">+	ttyfd = ttynew(opt_line, shell, opt_io, opt_cmd);
</a> 	cresize(w, h);
 
 	clock_gettime(CLOCK_MONOTONIC, &amp;last);
<a href="#h3-4" id="h3-4" class="h">@@ -1782,15 +1784,15 @@ run(void)
</a> 
 	for (xev = actionfps;;) {
 		FD_ZERO(&amp;rfd);
<a href="#h3-4-3" id="h3-4-3" class="d">-		FD_SET(cmdfd, &amp;rfd);
</a><a href="#h3-4-4" id="h3-4-4" class="i">+		FD_SET(ttyfd, &amp;rfd);
</a> 		FD_SET(xfd, &amp;rfd);
 
<a href="#h3-4-7" id="h3-4-7" class="d">-		if (pselect(MAX(xfd, cmdfd)+1, &amp;rfd, NULL, NULL, tv, NULL) &lt; 0) {
</a><a href="#h3-4-8" id="h3-4-8" class="i">+		if (pselect(MAX(xfd, ttyfd)+1, &amp;rfd, NULL, NULL, tv, NULL) &lt; 0) {
</a> 			if (errno == EINTR)
 				continue;
 			die(&quot;select failed: %s\n&quot;, strerror(errno));
 		}
<a href="#h3-4-13" id="h3-4-13" class="d">-		if (FD_ISSET(cmdfd, &amp;rfd)) {
</a><a href="#h3-4-14" id="h3-4-14" class="i">+		if (FD_ISSET(ttyfd, &amp;rfd)) {
</a> 			ttyread();
 			if (blinktimeout) {
 				blinkset = tattrset(ATTR_BLINK);
<a href="#h3-5" id="h3-5" class="h">@@ -1834,7 +1836,7 @@ run(void)
</a> 
 			if (xev &amp;&amp; !FD_ISSET(xfd, &amp;rfd))
 				xev--;
<a href="#h3-5-3" id="h3-5-3" class="d">-			if (!FD_ISSET(cmdfd, &amp;rfd) &amp;&amp; !FD_ISSET(xfd, &amp;rfd)) {
</a><a href="#h3-5-4" id="h3-5-4" class="i">+			if (!FD_ISSET(ttyfd, &amp;rfd) &amp;&amp; !FD_ISSET(xfd, &amp;rfd)) {
</a> 				if (blinkset) {
 					if (TIMEDIFF(now, lastblink) \
 							&gt; blinktimeout) {
</pre>
</div>
</body>
</html>
