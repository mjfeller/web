<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>several new changes, made gridmenu working - dwm - dynamic window manager
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="dwm Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>dwm</h1><span class="desc">dynamic window manager
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/39677ec76616fe4165ef92afb14db2bef2488e30.html">39677ec76616fe4165ef92afb14db2bef2488e30</a>
<b>parent</b> <a href="../commit/8a34fa50f75f4d6d8af234ac0c4f6d40b988d700.html">8a34fa50f75f4d6d8af234ac0c4f6d40b988d700</a>
<b>Author:</b> Anselm R. Garbe &lt;<a href="mailto:garbeam@wmii.de">garbeam@wmii.de</a>&gt;
<b>Date:</b>   Mon, 10 Jul 2006 19:46:24 +0200

several new changes, made gridmenu working

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">Makefile</a></td><td> | </td><td class="num">14</td><td><span class="i">++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">config.h</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">draw.c</a></td><td> | </td><td class="num">41</td><td><span class="i">+++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">draw.h</a></td><td> | </td><td class="num">31</td><td><span class="i">++++++++++++++++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">gridmenu.c</a></td><td> | </td><td class="num">239</td><td><span class="i">++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">util.c</a></td><td> | </td><td class="num">59</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">util.h</a></td><td> | </td><td class="num">47</td><td><span class="i">+++++++++++</span><span class="d">------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">wm.c</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">wm.h</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++</span><span class="d">--</span></td></tr>
</table></pre><pre>9 files changed, 256 insertions(+), 206 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/Makefile.html">Makefile</a> b/<a href="../file/Makefile.html">Makefile</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -5,10 +5,12 @@ include config.mk
</a> 
 WMSRC = wm.c draw.c util.c
 WMOBJ = ${WMSRC:.c=.o}
<a href="#h0-0-3" id="h0-0-3" class="i">+MENSRC = gridmenu.c draw.c util.c
</a><a href="#h0-0-4" id="h0-0-4" class="i">+MENOBJ = ${MENSRC:.c=.o}
</a> MAN = gridwm.1
 BIN = gridwm gridmenu     
 
<a href="#h0-0-8" id="h0-0-8" class="d">-all: config gridwm
</a><a href="#h0-0-9" id="h0-0-9" class="i">+all: config gridwm gridmenu
</a> 	@echo finished
 
 config:
<a href="#h0-1" id="h0-1" class="h">@@ -22,18 +24,22 @@ config:
</a> 	@echo CC $&lt;
 	@${CC} -c ${CFLAGS} $&lt;
 
<a href="#h0-1-3" id="h0-1-3" class="d">-${WMOBJ}: wm.h draw.h config.h
</a><a href="#h0-1-4" id="h0-1-4" class="i">+${WMOBJ}: wm.h draw.h config.h util.h
</a><a href="#h0-1-5" id="h0-1-5" class="i">+
</a><a href="#h0-1-6" id="h0-1-6" class="i">+gridmenu: ${MENOBJ}
</a><a href="#h0-1-7" id="h0-1-7" class="i">+	@echo LD $@
</a><a href="#h0-1-8" id="h0-1-8" class="i">+	@${CC} -o $@ ${MENOBJ} ${LDFLAGS}
</a> 
 gridwm: ${WMOBJ}
 	@echo LD $@
 	@${CC} -o $@ ${WMOBJ} ${LDFLAGS}
 
 clean:
<a href="#h0-1-15" id="h0-1-15" class="d">-	rm -f gridwm *.o
</a><a href="#h0-1-16" id="h0-1-16" class="i">+	rm -f gridwm gridmenu *.o core
</a> 
 dist: clean
 	mkdir -p gridwm-${VERSION}
<a href="#h0-1-20" id="h0-1-20" class="d">-	cp -R Makefile README LICENSE config.mk ${WMSRC} ${MAN} gridwm-${VERSION}
</a><a href="#h0-1-21" id="h0-1-21" class="i">+	cp -R Makefile README LICENSE config.mk *.h *.c ${MAN} gridwm-${VERSION}
</a> 	tar -cf gridwm-${VERSION}.tar gridwm-${VERSION}
 	gzip gridwm-${VERSION}.tar
 	rm -rf gridwm-${VERSION}
<b>diff --git a/<a id="h1" href="../file/config.h.html">config.h</a> b/<a href="../file/config.h.html">config.h</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -3,7 +3,7 @@
</a>  * See LICENSE file for license details.
  */
 
<a href="#h1-0-3" id="h1-0-3" class="d">-#define FONT	&quot;fixed&quot;
</a><a href="#h1-0-4" id="h1-0-4" class="d">-#define FGCOLOR	&quot;#000000&quot;
</a><a href="#h1-0-5" id="h1-0-5" class="d">-#define BGCOLOR	&quot;#ffaa00&quot;
</a><a href="#h1-0-6" id="h1-0-6" class="d">-#define BOCOLOR	&quot;#000000&quot;
</a><a href="#h1-0-7" id="h1-0-7" class="i">+#define FONT		&quot;-*-terminus-medium-*-*-*-14-*-*-*-*-*-iso10646-*&quot;
</a><a href="#h1-0-8" id="h1-0-8" class="i">+#define FGCOLOR		&quot;#000000&quot;
</a><a href="#h1-0-9" id="h1-0-9" class="i">+#define BGCOLOR		&quot;#ffaa00&quot;
</a><a href="#h1-0-10" id="h1-0-10" class="i">+#define BORDERCOLOR	&quot;#000000&quot;
</a><b>diff --git a/<a id="h2" href="../file/draw.c.html">draw.c</a> b/<a href="../file/draw.c.html">draw.c</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -14,7 +14,7 @@ drawborder(Display *dpy, Brush *b)
</a> {
 	XPoint points[5];
 	XSetLineAttributes(dpy, b-&gt;gc, 1, LineSolid, CapButt, JoinMiter);
<a href="#h2-0-3" id="h2-0-3" class="d">-	XSetForeground(dpy, b-&gt;gc, b-&gt;color.border);
</a><a href="#h2-0-4" id="h2-0-4" class="i">+	XSetForeground(dpy, b-&gt;gc, b-&gt;border);
</a> 	points[0].x = b-&gt;rect.x;
 	points[0].y = b-&gt;rect.y;
 	points[1].x = b-&gt;rect.width - 1;
<a href="#h2-1" id="h2-1" class="h">@@ -29,54 +29,54 @@ drawborder(Display *dpy, Brush *b)
</a> }
 
 void
<a href="#h2-1-3" id="h2-1-3" class="d">-draw(Display *dpy, Brush *b)
</a><a href="#h2-1-4" id="h2-1-4" class="i">+draw(Display *dpy, Brush *b, Bool border, const char *text)
</a> {
 	unsigned int x, y, w, h, len;
 	static char buf[256];
 	XGCValues gcv;
 
<a href="#h2-1-10" id="h2-1-10" class="d">-	XSetForeground(dpy, b-&gt;gc, b-&gt;color.bg);
</a><a href="#h2-1-11" id="h2-1-11" class="i">+	XSetForeground(dpy, b-&gt;gc, b-&gt;bg);
</a> 	XFillRectangles(dpy, b-&gt;drawable, b-&gt;gc, &amp;b-&gt;rect, 1);
 
<a href="#h2-1-14" id="h2-1-14" class="d">-	if(b-&gt;border)
</a><a href="#h2-1-15" id="h2-1-15" class="i">+	if(border)
</a> 		drawborder(dpy, b);
 
<a href="#h2-1-18" id="h2-1-18" class="d">-	if(!b-&gt;text)
</a><a href="#h2-1-19" id="h2-1-19" class="i">+	if(!text)
</a> 		return;
 
<a href="#h2-1-22" id="h2-1-22" class="d">-	len = strlen(b-&gt;text);
</a><a href="#h2-1-23" id="h2-1-23" class="i">+	len = strlen(text);
</a> 	if(len &gt;= sizeof(buf))
 		len = sizeof(buf) - 1;
<a href="#h2-1-26" id="h2-1-26" class="d">-	memcpy(buf, b-&gt;text, len);
</a><a href="#h2-1-27" id="h2-1-27" class="i">+	memcpy(buf, text, len);
</a> 	buf[len] = 0;
 
<a href="#h2-1-30" id="h2-1-30" class="d">-	h = b-&gt;font-&gt;ascent + b-&gt;font-&gt;descent;
</a><a href="#h2-1-31" id="h2-1-31" class="d">-	y = b-&gt;rect.y + (b-&gt;rect.height / 2) - (h / 2) + b-&gt;font-&gt;ascent;
</a><a href="#h2-1-32" id="h2-1-32" class="i">+	h = b-&gt;font.ascent + b-&gt;font.descent;
</a><a href="#h2-1-33" id="h2-1-33" class="i">+	y = b-&gt;rect.y + (b-&gt;rect.height / 2) - (h / 2) + b-&gt;font.ascent;
</a> 	x = b-&gt;rect.x + (h / 2);
 
 	/* shorten text if necessary */
<a href="#h2-1-37" id="h2-1-37" class="d">-	while(len &amp;&amp; (w = textwidth_l(b-&gt;font, buf, len)) &gt; b-&gt;rect.width - h)
</a><a href="#h2-1-38" id="h2-1-38" class="i">+	while(len &amp;&amp; (w = textwidth_l(&amp;b-&gt;font, buf, len)) &gt; b-&gt;rect.width - h)
</a> 		buf[--len] = 0;
 
 	if(w &gt; b-&gt;rect.width)
 		return; /* too long */
 
<a href="#h2-1-44" id="h2-1-44" class="d">-	gcv.foreground = b-&gt;color.fg;
</a><a href="#h2-1-45" id="h2-1-45" class="d">-	gcv.background = b-&gt;color.bg;
</a><a href="#h2-1-46" id="h2-1-46" class="d">-	if(b-&gt;font-&gt;set) {
</a><a href="#h2-1-47" id="h2-1-47" class="i">+	gcv.foreground = b-&gt;fg;
</a><a href="#h2-1-48" id="h2-1-48" class="i">+	gcv.background = b-&gt;bg;
</a><a href="#h2-1-49" id="h2-1-49" class="i">+	if(b-&gt;font.set) {
</a> 		XChangeGC(dpy, b-&gt;gc, GCForeground | GCBackground, &amp;gcv);
<a href="#h2-1-51" id="h2-1-51" class="d">-		XmbDrawImageString(dpy, b-&gt;drawable, b-&gt;font-&gt;set, b-&gt;gc,
</a><a href="#h2-1-52" id="h2-1-52" class="i">+		XmbDrawImageString(dpy, b-&gt;drawable, b-&gt;font.set, b-&gt;gc,
</a> 				x, y, buf, len);
 	}
 	else {
<a href="#h2-1-56" id="h2-1-56" class="d">-		gcv.font = b-&gt;font-&gt;xfont-&gt;fid;
</a><a href="#h2-1-57" id="h2-1-57" class="i">+		gcv.font = b-&gt;font.xfont-&gt;fid;
</a> 		XChangeGC(dpy, b-&gt;gc, GCForeground | GCBackground | GCFont, &amp;gcv);
 		XDrawImageString(dpy, b-&gt;drawable, b-&gt;gc, x, y, buf, len);
 	}
 }
 
 static unsigned long
<a href="#h2-1-64" id="h2-1-64" class="d">-xloadcolor(Display *dpy, Colormap cmap, const char *colstr)
</a><a href="#h2-1-65" id="h2-1-65" class="i">+xloadcolors(Display *dpy, Colormap cmap, const char *colstr)
</a> {
 	XColor color;
 	XAllocNamedColor(dpy, cmap, colstr, &amp;color, &amp;color);
<a href="#h2-2" id="h2-2" class="h">@@ -84,13 +84,13 @@ xloadcolor(Display *dpy, Colormap cmap, const char *colstr)
</a> }
 
 void
<a href="#h2-2-3" id="h2-2-3" class="d">-loadcolor(Display *dpy, int screen, Color *c,
</a><a href="#h2-2-4" id="h2-2-4" class="i">+loadcolors(Display *dpy, int screen, Brush *b,
</a> 		const char *bg, const char *fg, const char *border)
 {
 	Colormap cmap = DefaultColormap(dpy, screen);
<a href="#h2-2-8" id="h2-2-8" class="d">-	c-&gt;bg = xloadcolor(dpy, cmap, bg);
</a><a href="#h2-2-9" id="h2-2-9" class="d">-	c-&gt;fg = xloadcolor(dpy, cmap, fg);
</a><a href="#h2-2-10" id="h2-2-10" class="d">-	c-&gt;border = xloadcolor(dpy, cmap, border);
</a><a href="#h2-2-11" id="h2-2-11" class="i">+	b-&gt;bg = xloadcolors(dpy, cmap, bg);
</a><a href="#h2-2-12" id="h2-2-12" class="i">+	b-&gt;fg = xloadcolors(dpy, cmap, fg);
</a><a href="#h2-2-13" id="h2-2-13" class="i">+	b-&gt;border = xloadcolors(dpy, cmap, border);
</a> }
 
 unsigned int
<a href="#h2-3" id="h2-3" class="h">@@ -160,4 +160,5 @@ loadfont(Display *dpy, Fnt *font, const char *fontstr)
</a> 		font-&gt;ascent = font-&gt;xfont-&gt;ascent;
 		font-&gt;descent = font-&gt;xfont-&gt;descent;
 	}
<a href="#h2-3-3" id="h2-3-3" class="i">+	font-&gt;height = font-&gt;ascent + font-&gt;descent;
</a> }
<b>diff --git a/<a id="h3" href="../file/draw.h.html">draw.h</a> b/<a href="../file/draw.h.html">draw.h</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -3,4 +3,33 @@
</a>  * See LICENSE file for license details.
  */
 
<a href="#h3-0-3" id="h3-0-3" class="d">-extern void error(char *errstr, ...);
</a><a href="#h3-0-4" id="h3-0-4" class="i">+#include &lt;X11/Xlib.h&gt;
</a><a href="#h3-0-5" id="h3-0-5" class="i">+#include &lt;X11/Xlocale.h&gt;
</a><a href="#h3-0-6" id="h3-0-6" class="i">+
</a><a href="#h3-0-7" id="h3-0-7" class="i">+typedef struct Brush Brush;
</a><a href="#h3-0-8" id="h3-0-8" class="i">+typedef struct Fnt Fnt;
</a><a href="#h3-0-9" id="h3-0-9" class="i">+
</a><a href="#h3-0-10" id="h3-0-10" class="i">+struct Fnt {
</a><a href="#h3-0-11" id="h3-0-11" class="i">+	XFontStruct *xfont;
</a><a href="#h3-0-12" id="h3-0-12" class="i">+	XFontSet set;
</a><a href="#h3-0-13" id="h3-0-13" class="i">+	int ascent;
</a><a href="#h3-0-14" id="h3-0-14" class="i">+	int descent;
</a><a href="#h3-0-15" id="h3-0-15" class="i">+	int height;
</a><a href="#h3-0-16" id="h3-0-16" class="i">+};
</a><a href="#h3-0-17" id="h3-0-17" class="i">+
</a><a href="#h3-0-18" id="h3-0-18" class="i">+struct Brush {
</a><a href="#h3-0-19" id="h3-0-19" class="i">+	GC gc;
</a><a href="#h3-0-20" id="h3-0-20" class="i">+	Drawable drawable;
</a><a href="#h3-0-21" id="h3-0-21" class="i">+	XRectangle rect;
</a><a href="#h3-0-22" id="h3-0-22" class="i">+	Fnt font;
</a><a href="#h3-0-23" id="h3-0-23" class="i">+	unsigned long bg;
</a><a href="#h3-0-24" id="h3-0-24" class="i">+	unsigned long fg;
</a><a href="#h3-0-25" id="h3-0-25" class="i">+	unsigned long border;
</a><a href="#h3-0-26" id="h3-0-26" class="i">+};
</a><a href="#h3-0-27" id="h3-0-27" class="i">+
</a><a href="#h3-0-28" id="h3-0-28" class="i">+extern void draw(Display *dpy, Brush *b, Bool border, const char *text);
</a><a href="#h3-0-29" id="h3-0-29" class="i">+extern void loadcolors(Display *dpy, int screen, Brush *b,
</a><a href="#h3-0-30" id="h3-0-30" class="i">+		const char *bg, const char *fg, const char *bo);
</a><a href="#h3-0-31" id="h3-0-31" class="i">+extern void loadfont(Display *dpy, Fnt *font, const char *fontstr);
</a><a href="#h3-0-32" id="h3-0-32" class="i">+extern unsigned int textwidth_l(Fnt *font, char *text, unsigned int len);
</a><a href="#h3-0-33" id="h3-0-33" class="i">+extern unsigned int textwidth(Fnt *font, char *text);
</a><b>diff --git a/<a id="h4" href="../file/gridmenu.c.html">gridmenu.c</a> b/<a href="../file/gridmenu.c.html">gridmenu.c</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -4,6 +4,10 @@
</a>  * See LICENSE file for license details.
  */
 
<a href="#h4-0-3" id="h4-0-3" class="i">+#include &quot;config.h&quot;
</a><a href="#h4-0-4" id="h4-0-4" class="i">+#include &quot;draw.h&quot;
</a><a href="#h4-0-5" id="h4-0-5" class="i">+#include &quot;util.h&quot;
</a><a href="#h4-0-6" id="h4-0-6" class="i">+
</a> #include &lt;ctype.h&gt;
 #include &lt;stdlib.h&gt;
 #include &lt;stdio.h&gt;
<a href="#h4-1" id="h4-1" class="h">@@ -12,14 +16,10 @@
</a> #include &lt;sys/wait.h&gt;
 #include &lt;time.h&gt;
 #include &lt;unistd.h&gt;
<a href="#h4-1-3" id="h4-1-3" class="d">-#include &lt;X11/Xlib.h&gt;
</a> #include &lt;X11/cursorfont.h&gt;
 #include &lt;X11/Xutil.h&gt;
 #include &lt;X11/keysym.h&gt;
 
<a href="#h4-1-8" id="h4-1-8" class="d">-#include &lt;blitz.h&gt;
</a><a href="#h4-1-9" id="h4-1-9" class="d">-#include &lt;cext.h&gt;
</a><a href="#h4-1-10" id="h4-1-10" class="d">-
</a> typedef struct Item Item;
 
 struct Item {
<a href="#h4-2" id="h4-2" class="h">@@ -28,37 +28,40 @@ struct Item {
</a> 	char *text;
 };
 
<a href="#h4-2-3" id="h4-2-3" class="d">-static char *title = nil;
</a><a href="#h4-2-4" id="h4-2-4" class="i">+static Display *dpy;
</a><a href="#h4-2-5" id="h4-2-5" class="i">+static Window root;
</a><a href="#h4-2-6" id="h4-2-6" class="i">+static Window win;
</a><a href="#h4-2-7" id="h4-2-7" class="i">+static XRectangle rect;
</a> static Bool done = False;
<a href="#h4-2-9" id="h4-2-9" class="d">-static int ret = 0;
</a><a href="#h4-2-10" id="h4-2-10" class="i">+
</a><a href="#h4-2-11" id="h4-2-11" class="i">+static Item *allitem = 0;	/* first of all items */
</a><a href="#h4-2-12" id="h4-2-12" class="i">+static Item *item = 0;	/* first of pattern matching items */
</a><a href="#h4-2-13" id="h4-2-13" class="i">+static Item *sel = 0;
</a><a href="#h4-2-14" id="h4-2-14" class="i">+static Item *nextoff = 0;
</a><a href="#h4-2-15" id="h4-2-15" class="i">+static Item *prevoff = 0;
</a><a href="#h4-2-16" id="h4-2-16" class="i">+static Item *curroff = 0;
</a><a href="#h4-2-17" id="h4-2-17" class="i">+
</a><a href="#h4-2-18" id="h4-2-18" class="i">+static int screen;
</a><a href="#h4-2-19" id="h4-2-19" class="i">+static char *title = 0;
</a> static char text[4096];
<a href="#h4-2-21" id="h4-2-21" class="d">-static BlitzColor selcolor;
</a><a href="#h4-2-22" id="h4-2-22" class="d">-static BlitzColor normcolor;
</a><a href="#h4-2-23" id="h4-2-23" class="d">-static Window win;
</a><a href="#h4-2-24" id="h4-2-24" class="d">-static XRectangle mrect;
</a><a href="#h4-2-25" id="h4-2-25" class="d">-static Item *allitem = nil;	/* first of all items */
</a><a href="#h4-2-26" id="h4-2-26" class="d">-static Item *item = nil;	/* first of pattern matching items */
</a><a href="#h4-2-27" id="h4-2-27" class="d">-static Item *sel = nil;
</a><a href="#h4-2-28" id="h4-2-28" class="d">-static Item *nextoff = nil;
</a><a href="#h4-2-29" id="h4-2-29" class="d">-static Item *prevoff = nil;
</a><a href="#h4-2-30" id="h4-2-30" class="d">-static Item *curroff = nil;
</a><a href="#h4-2-31" id="h4-2-31" class="i">+static int ret = 0;
</a> static int nitem = 0;
 static unsigned int cmdw = 0;
 static unsigned int twidth = 0;
 static unsigned int cwidth = 0;
<a href="#h4-2-36" id="h4-2-36" class="d">-static Blitz blz = {0};
</a><a href="#h4-2-37" id="h4-2-37" class="d">-static BlitzBrush brush = {0};
</a> static const int seek = 30;		/* 30px */
 
<a href="#h4-2-40" id="h4-2-40" class="i">+static Brush brush = {0};
</a><a href="#h4-2-41" id="h4-2-41" class="i">+
</a> static void draw_menu(void);
<a href="#h4-2-43" id="h4-2-43" class="d">-static void handle_kpress(XKeyEvent * e);
</a><a href="#h4-2-44" id="h4-2-44" class="i">+static void kpress(XKeyEvent * e);
</a> 
<a href="#h4-2-46" id="h4-2-46" class="d">-static char version[] = &quot;wmiimenu - &quot; VERSION &quot;, (C)opyright MMIV-MMVI Anselm R. Garbe\n&quot;;
</a><a href="#h4-2-47" id="h4-2-47" class="i">+static char version[] = &quot;gridmenu - &quot; VERSION &quot;, (C)opyright MMVI Anselm R. Garbe\n&quot;;
</a> 
 static void
 usage()
 {
<a href="#h4-2-52" id="h4-2-52" class="d">-	fprintf(stderr, &quot;%s&quot;, &quot;usage: wmiimenu [-v] [-t &lt;title&gt;]\n&quot;);
</a><a href="#h4-2-53" id="h4-2-53" class="i">+	fprintf(stderr, &quot;%s&quot;, &quot;usage: gridmenu [-v] [-t &lt;title&gt;]\n&quot;);
</a> 	exit(1);
 }
 
<a href="#h4-3" id="h4-3" class="h">@@ -71,21 +74,21 @@ update_offsets()
</a> 		return;
 
 	for(nextoff = curroff; nextoff; nextoff=nextoff-&gt;right) {
<a href="#h4-3-3" id="h4-3-3" class="d">-		tw = blitz_textwidth(brush.font, nextoff-&gt;text);
</a><a href="#h4-3-4" id="h4-3-4" class="d">-		if(tw &gt; mrect.width / 3)
</a><a href="#h4-3-5" id="h4-3-5" class="d">-			tw = mrect.width / 3;
</a><a href="#h4-3-6" id="h4-3-6" class="d">-		w += tw + mrect.height;
</a><a href="#h4-3-7" id="h4-3-7" class="d">-		if(w &gt; mrect.width)
</a><a href="#h4-3-8" id="h4-3-8" class="i">+		tw = textwidth(&amp;brush.font, nextoff-&gt;text);
</a><a href="#h4-3-9" id="h4-3-9" class="i">+		if(tw &gt; rect.width / 3)
</a><a href="#h4-3-10" id="h4-3-10" class="i">+			tw = rect.width / 3;
</a><a href="#h4-3-11" id="h4-3-11" class="i">+		w += tw + brush.font.height;
</a><a href="#h4-3-12" id="h4-3-12" class="i">+		if(w &gt; rect.width)
</a> 			break;
 	}
 
 	w = cmdw + 2 * seek;
 	for(prevoff = curroff; prevoff &amp;&amp; prevoff-&gt;left; prevoff=prevoff-&gt;left) {
<a href="#h4-3-18" id="h4-3-18" class="d">-		tw = blitz_textwidth(brush.font, prevoff-&gt;left-&gt;text);
</a><a href="#h4-3-19" id="h4-3-19" class="d">-		if(tw &gt; mrect.width / 3)
</a><a href="#h4-3-20" id="h4-3-20" class="d">-			tw = mrect.width / 3;
</a><a href="#h4-3-21" id="h4-3-21" class="d">-		w += tw + mrect.height;
</a><a href="#h4-3-22" id="h4-3-22" class="d">-		if(w &gt; mrect.width)
</a><a href="#h4-3-23" id="h4-3-23" class="i">+		tw = textwidth(&amp;brush.font, prevoff-&gt;left-&gt;text);
</a><a href="#h4-3-24" id="h4-3-24" class="i">+		if(tw &gt; rect.width / 3)
</a><a href="#h4-3-25" id="h4-3-25" class="i">+			tw = rect.width / 3;
</a><a href="#h4-3-26" id="h4-3-26" class="i">+		w += tw + brush.font.height;
</a><a href="#h4-3-27" id="h4-3-27" class="i">+		if(w &gt; rect.width)
</a> 			break;
 	}
 }
<a href="#h4-4" id="h4-4" class="h">@@ -104,7 +107,7 @@ update_items(char *pattern)
</a> 	else
 		cmdw = twidth;
 
<a href="#h4-4-3" id="h4-4-3" class="d">-	item = j = nil;
</a><a href="#h4-4-4" id="h4-4-4" class="i">+	item = j = 0;
</a> 	nitem = 0;
 
 	for(i = allitem; i; i=i-&gt;next)
<a href="#h4-5" id="h4-5" class="h">@@ -114,7 +117,7 @@ update_items(char *pattern)
</a> 			else
 				j-&gt;right = i;
 			i-&gt;left = j;
<a href="#h4-5-3" id="h4-5-3" class="d">-			i-&gt;right = nil;
</a><a href="#h4-5-4" id="h4-5-4" class="i">+			i-&gt;right = 0;
</a> 			j = i;
 			nitem++;
 		}
<a href="#h4-6" id="h4-6" class="h">@@ -126,7 +129,7 @@ update_items(char *pattern)
</a> 			else
 				j-&gt;right = i;
 			i-&gt;left = j;
<a href="#h4-6-3" id="h4-6-3" class="d">-			i-&gt;right = nil;
</a><a href="#h4-6-4" id="h4-6-4" class="i">+			i-&gt;right = 0;
</a> 			j = i;
 			nitem++;
 		}
<a href="#h4-7" id="h4-7" class="h">@@ -141,72 +144,62 @@ static void
</a> draw_menu()
 {
 	unsigned int offx = 0;
<a href="#h4-7-3" id="h4-7-3" class="d">-
</a> 	Item *i;
 
<a href="#h4-7-6" id="h4-7-6" class="d">-	brush.align = WEST;
</a><a href="#h4-7-7" id="h4-7-7" class="d">-
</a><a href="#h4-7-8" id="h4-7-8" class="d">-	brush.rect = mrect;
</a><a href="#h4-7-9" id="h4-7-9" class="i">+	brush.rect = rect;
</a> 	brush.rect.x = 0;
 	brush.rect.y = 0;
<a href="#h4-7-12" id="h4-7-12" class="d">-	brush.color = normcolor;
</a><a href="#h4-7-13" id="h4-7-13" class="d">-	brush.border = False;
</a><a href="#h4-7-14" id="h4-7-14" class="d">-	blitz_draw_tile(&amp;brush);
</a><a href="#h4-7-15" id="h4-7-15" class="i">+	draw(dpy, &amp;brush, False, 0);
</a> 
 	/* print command */
 	if(!title || text[0]) {
<a href="#h4-7-19" id="h4-7-19" class="d">-		brush.color = normcolor;
</a> 		cmdw = cwidth;
 		if(cmdw &amp;&amp; item)
 			brush.rect.width = cmdw;
<a href="#h4-7-23" id="h4-7-23" class="d">-		blitz_draw_label(&amp;brush, text);
</a><a href="#h4-7-24" id="h4-7-24" class="i">+		draw(dpy, &amp;brush, False, text);
</a> 	}
 	else {
 		cmdw = twidth;
<a href="#h4-7-28" id="h4-7-28" class="d">-		brush.color = selcolor;
</a> 		brush.rect.width = cmdw;
<a href="#h4-7-30" id="h4-7-30" class="d">-		blitz_draw_label(&amp;brush, title);
</a><a href="#h4-7-31" id="h4-7-31" class="i">+		draw(dpy, &amp;brush, False, title);
</a> 	}
 	offx += brush.rect.width;
 
<a href="#h4-7-35" id="h4-7-35" class="d">-	brush.align = CENTER;
</a> 	if(curroff) {
<a href="#h4-7-37" id="h4-7-37" class="d">-		brush.color = normcolor;
</a> 		brush.rect.x = offx;
 		brush.rect.width = seek;
 		offx += brush.rect.width;
<a href="#h4-7-41" id="h4-7-41" class="d">-		blitz_draw_label(&amp;brush, (curroff &amp;&amp; curroff-&gt;left) ? &quot;&lt;&quot; : nil);
</a><a href="#h4-7-42" id="h4-7-42" class="i">+		draw(dpy, &amp;brush, False, (curroff &amp;&amp; curroff-&gt;left) ? &quot;&lt;&quot; : 0);
</a> 
 		/* determine maximum items */
 		for(i = curroff; i != nextoff; i=i-&gt;right) {
<a href="#h4-7-46" id="h4-7-46" class="d">-			brush.color = normcolor;
</a> 			brush.border = False;
 			brush.rect.x = offx;
<a href="#h4-7-49" id="h4-7-49" class="d">-			brush.rect.width = blitz_textwidth(brush.font, i-&gt;text);
</a><a href="#h4-7-50" id="h4-7-50" class="d">-			if(brush.rect.width &gt; mrect.width / 3)
</a><a href="#h4-7-51" id="h4-7-51" class="d">-				brush.rect.width = mrect.width / 3;
</a><a href="#h4-7-52" id="h4-7-52" class="d">-			brush.rect.width += mrect.height;
</a><a href="#h4-7-53" id="h4-7-53" class="i">+			brush.rect.width = textwidth(&amp;brush.font, i-&gt;text);
</a><a href="#h4-7-54" id="h4-7-54" class="i">+			if(brush.rect.width &gt; rect.width / 3)
</a><a href="#h4-7-55" id="h4-7-55" class="i">+				brush.rect.width = rect.width / 3;
</a><a href="#h4-7-56" id="h4-7-56" class="i">+			brush.rect.width += brush.font.height;
</a> 			if(sel == i) {
<a href="#h4-7-58" id="h4-7-58" class="d">-				brush.color = selcolor;
</a><a href="#h4-7-59" id="h4-7-59" class="d">-				brush.border = True;
</a><a href="#h4-7-60" id="h4-7-60" class="i">+				swap((void **)&amp;brush.fg, (void **)&amp;brush.bg);
</a><a href="#h4-7-61" id="h4-7-61" class="i">+				draw(dpy, &amp;brush, True, i-&gt;text);
</a><a href="#h4-7-62" id="h4-7-62" class="i">+				swap((void **)&amp;brush.fg, (void **)&amp;brush.bg);
</a> 			}
<a href="#h4-7-64" id="h4-7-64" class="d">-			blitz_draw_label(&amp;brush, i-&gt;text);
</a><a href="#h4-7-65" id="h4-7-65" class="i">+			else
</a><a href="#h4-7-66" id="h4-7-66" class="i">+				draw(dpy, &amp;brush, False, i-&gt;text);
</a> 			offx += brush.rect.width;
 		}
 
<a href="#h4-7-70" id="h4-7-70" class="d">-		brush.color = normcolor;
</a><a href="#h4-7-71" id="h4-7-71" class="d">-		brush.border = False;
</a><a href="#h4-7-72" id="h4-7-72" class="d">-		brush.rect.x = mrect.width - seek;
</a><a href="#h4-7-73" id="h4-7-73" class="i">+		brush.rect.x = rect.width - seek;
</a> 		brush.rect.width = seek;
<a href="#h4-7-75" id="h4-7-75" class="d">-		blitz_draw_label(&amp;brush, nextoff ? &quot;&gt;&quot; : nil);
</a><a href="#h4-7-76" id="h4-7-76" class="i">+		draw(dpy, &amp;brush, False, nextoff ? &quot;&gt;&quot; : 0);
</a> 	}
<a href="#h4-7-78" id="h4-7-78" class="d">-	XCopyArea(blz.dpy, brush.drawable, win, brush.gc, 0, 0, mrect.width,
</a><a href="#h4-7-79" id="h4-7-79" class="d">-			mrect.height, 0, 0);
</a><a href="#h4-7-80" id="h4-7-80" class="d">-	XSync(blz.dpy, False);
</a><a href="#h4-7-81" id="h4-7-81" class="i">+	XCopyArea(dpy, brush.drawable, win, brush.gc, 0, 0, rect.width,
</a><a href="#h4-7-82" id="h4-7-82" class="i">+			rect.height, 0, 0);
</a><a href="#h4-7-83" id="h4-7-83" class="i">+	XFlush(dpy);
</a> }
 
 static void
<a href="#h4-7-87" id="h4-7-87" class="d">-handle_kpress(XKeyEvent * e)
</a><a href="#h4-7-88" id="h4-7-88" class="i">+kpress(XKeyEvent * e)
</a> {
 	KeySym ksym;
 	char buf[32];
<a href="#h4-8" id="h4-8" class="h">@@ -272,7 +265,7 @@ handle_kpress(XKeyEvent * e)
</a> 	case XK_Tab:
 		if(!sel)
 			return;
<a href="#h4-8-3" id="h4-8-3" class="d">-		cext_strlcpy(text, sel-&gt;text, sizeof(text));
</a><a href="#h4-8-4" id="h4-8-4" class="i">+		strncpy(text, sel-&gt;text, sizeof(text));
</a> 		update_items(text);
 		break;
 	case XK_Right:
<a href="#h4-9" id="h4-9" class="h">@@ -314,9 +307,9 @@ handle_kpress(XKeyEvent * e)
</a> 		if((num == 1) &amp;&amp; !iscntrl((int) buf[0])) {
 			buf[num] = 0;
 			if(len &gt; 0)
<a href="#h4-9-3" id="h4-9-3" class="d">-				cext_strlcat(text, buf, sizeof(text));
</a><a href="#h4-9-4" id="h4-9-4" class="i">+				strncat(text, buf, sizeof(text));
</a> 			else
<a href="#h4-9-6" id="h4-9-6" class="d">-				cext_strlcpy(text, buf, sizeof(text));
</a><a href="#h4-9-7" id="h4-9-7" class="i">+				strncpy(text, buf, sizeof(text));
</a> 			update_items(text);
 		}
 	}
<a href="#h4-10" id="h4-10" class="h">@@ -326,24 +319,24 @@ handle_kpress(XKeyEvent * e)
</a> static char *
 read_allitems()
 {
<a href="#h4-10-3" id="h4-10-3" class="d">-	static char *maxname = nil;
</a><a href="#h4-10-4" id="h4-10-4" class="i">+	static char *maxname = 0;
</a> 	char *p, buf[1024];
 	unsigned int len = 0, max = 0;
 	Item *i, *new;
 
<a href="#h4-10-9" id="h4-10-9" class="d">-	i = nil;
</a><a href="#h4-10-10" id="h4-10-10" class="i">+	i = 0;
</a> 	while(fgets(buf, sizeof(buf), stdin)) {
 		len = strlen(buf);
 		if (buf[len - 1] == &#39;\n&#39;)
 			buf[len - 1] = 0;
<a href="#h4-10-15" id="h4-10-15" class="d">-		p = cext_estrdup(buf);
</a><a href="#h4-10-16" id="h4-10-16" class="i">+		p = estrdup(buf);
</a> 		if(max &lt; len) {
 			maxname = p;
 			max = len;
 		}
 
<a href="#h4-10-22" id="h4-10-22" class="d">-		new = cext_emalloc(sizeof(Item));
</a><a href="#h4-10-23" id="h4-10-23" class="d">-		new-&gt;next = new-&gt;left = new-&gt;right = nil;
</a><a href="#h4-10-24" id="h4-10-24" class="i">+		new = emalloc(sizeof(Item));
</a><a href="#h4-10-25" id="h4-10-25" class="i">+		new-&gt;next = new-&gt;left = new-&gt;right = 0;
</a> 		new-&gt;text = p;
 		if(!i)
 			allitem = new;
<a href="#h4-11" id="h4-11" class="h">@@ -360,10 +353,7 @@ main(int argc, char *argv[])
</a> {
 	int i;
 	XSetWindowAttributes wa;
<a href="#h4-11-3" id="h4-11-3" class="d">-	char *maxname, *p;
</a><a href="#h4-11-4" id="h4-11-4" class="d">-	BlitzFont font = {0};
</a><a href="#h4-11-5" id="h4-11-5" class="d">-	GC gc;
</a><a href="#h4-11-6" id="h4-11-6" class="d">-	Drawable pmap;
</a><a href="#h4-11-7" id="h4-11-7" class="i">+	char *maxname;
</a> 	XEvent ev;
 
 	/* command line args */
<a href="#h4-12" id="h4-12" class="h">@@ -388,93 +378,70 @@ main(int argc, char *argv[])
</a> 			usage();
 	}
 
<a href="#h4-12-3" id="h4-12-3" class="d">-	blz.dpy = XOpenDisplay(0);
</a><a href="#h4-12-4" id="h4-12-4" class="d">-	if(!blz.dpy) {
</a><a href="#h4-12-5" id="h4-12-5" class="d">-		fprintf(stderr, &quot;%s&quot;, &quot;wmiimenu: cannot open dpy\n&quot;);
</a><a href="#h4-12-6" id="h4-12-6" class="d">-		exit(1);
</a><a href="#h4-12-7" id="h4-12-7" class="d">-	}
</a><a href="#h4-12-8" id="h4-12-8" class="d">-	blz.screen = DefaultScreen(blz.dpy);
</a><a href="#h4-12-9" id="h4-12-9" class="d">-	blz.root = RootWindow(blz.dpy, blz.screen);
</a><a href="#h4-12-10" id="h4-12-10" class="i">+	dpy = XOpenDisplay(0);
</a><a href="#h4-12-11" id="h4-12-11" class="i">+	if(!dpy)
</a><a href="#h4-12-12" id="h4-12-12" class="i">+		error(&quot;gridmenu: cannot open dpy\n&quot;);
</a><a href="#h4-12-13" id="h4-12-13" class="i">+	screen = DefaultScreen(dpy);
</a><a href="#h4-12-14" id="h4-12-14" class="i">+	root = RootWindow(dpy, screen);
</a> 
 	maxname = read_allitems();
 
 	/* grab as early as possible, but after reading all items!!! */
<a href="#h4-12-19" id="h4-12-19" class="d">-	while(XGrabKeyboard
</a><a href="#h4-12-20" id="h4-12-20" class="d">-			(blz.dpy, blz.root, True, GrabModeAsync,
</a><a href="#h4-12-21" id="h4-12-21" class="i">+	while(XGrabKeyboard(dpy, root, True, GrabModeAsync,
</a> 			 GrabModeAsync, CurrentTime) != GrabSuccess)
 		usleep(1000);
 
<a href="#h4-12-25" id="h4-12-25" class="d">-	font.fontstr = getenv(&quot;WMII_FONT&quot;);
</a><a href="#h4-12-26" id="h4-12-26" class="d">-	if (!font.fontstr)
</a><a href="#h4-12-27" id="h4-12-27" class="d">-		font.fontstr = cext_estrdup(BLITZ_FONT);
</a><a href="#h4-12-28" id="h4-12-28" class="d">-	blitz_loadfont(&amp;blz, &amp;font);
</a><a href="#h4-12-29" id="h4-12-29" class="d">-
</a><a href="#h4-12-30" id="h4-12-30" class="d">-	if((p = getenv(&quot;WMII_NORMCOLORS&quot;)))
</a><a href="#h4-12-31" id="h4-12-31" class="d">-		cext_strlcpy(normcolor.colstr, p, sizeof(normcolor.colstr));
</a><a href="#h4-12-32" id="h4-12-32" class="d">-	if(strlen(normcolor.colstr) != 23)
</a><a href="#h4-12-33" id="h4-12-33" class="d">-		cext_strlcpy(normcolor.colstr, BLITZ_NORMCOLORS, sizeof(normcolor.colstr));
</a><a href="#h4-12-34" id="h4-12-34" class="d">-	blitz_loadcolor(&amp;blz, &amp;normcolor);
</a><a href="#h4-12-35" id="h4-12-35" class="d">-
</a><a href="#h4-12-36" id="h4-12-36" class="d">-	if((p = getenv(&quot;WMII_SELCOLORS&quot;)))
</a><a href="#h4-12-37" id="h4-12-37" class="d">-		cext_strlcpy(selcolor.colstr, p, sizeof(selcolor.colstr));
</a><a href="#h4-12-38" id="h4-12-38" class="d">-	if(strlen(selcolor.colstr) != 23)
</a><a href="#h4-12-39" id="h4-12-39" class="d">-		cext_strlcpy(selcolor.colstr, BLITZ_SELCOLORS, sizeof(selcolor.colstr));
</a><a href="#h4-12-40" id="h4-12-40" class="d">-	blitz_loadcolor(&amp;blz, &amp;selcolor);
</a><a href="#h4-12-41" id="h4-12-41" class="i">+	/* style */
</a><a href="#h4-12-42" id="h4-12-42" class="i">+	loadcolors(dpy, screen, &amp;brush, BGCOLOR, FGCOLOR, BORDERCOLOR);
</a><a href="#h4-12-43" id="h4-12-43" class="i">+	loadfont(dpy, &amp;brush.font, FONT);
</a> 
 	wa.override_redirect = 1;
 	wa.background_pixmap = ParentRelative;
 	wa.event_mask = ExposureMask | ButtonPressMask | KeyPressMask
 		| SubstructureRedirectMask | SubstructureNotifyMask;
 
<a href="#h4-12-50" id="h4-12-50" class="d">-	mrect.width = DisplayWidth(blz.dpy, blz.screen);
</a><a href="#h4-12-51" id="h4-12-51" class="d">-	mrect.height = font.ascent + font.descent + 4;
</a><a href="#h4-12-52" id="h4-12-52" class="d">-	mrect.y = DisplayHeight(blz.dpy, blz.screen) - mrect.height;
</a><a href="#h4-12-53" id="h4-12-53" class="d">-	mrect.x = 0;
</a><a href="#h4-12-54" id="h4-12-54" class="i">+	rect.width = DisplayWidth(dpy, screen);
</a><a href="#h4-12-55" id="h4-12-55" class="i">+	rect.height = brush.font.height + 4;
</a><a href="#h4-12-56" id="h4-12-56" class="i">+	rect.y = DisplayHeight(dpy, screen) - rect.height;
</a><a href="#h4-12-57" id="h4-12-57" class="i">+	rect.x = 0;
</a> 
<a href="#h4-12-59" id="h4-12-59" class="d">-	win = XCreateWindow(blz.dpy, blz.root, mrect.x, mrect.y,
</a><a href="#h4-12-60" id="h4-12-60" class="d">-			mrect.width, mrect.height, 0, DefaultDepth(blz.dpy, blz.screen),
</a><a href="#h4-12-61" id="h4-12-61" class="d">-			CopyFromParent, DefaultVisual(blz.dpy, blz.screen),
</a><a href="#h4-12-62" id="h4-12-62" class="i">+	win = XCreateWindow(dpy, root, rect.x, rect.y,
</a><a href="#h4-12-63" id="h4-12-63" class="i">+			rect.width, rect.height, 0, DefaultDepth(dpy, screen),
</a><a href="#h4-12-64" id="h4-12-64" class="i">+			CopyFromParent, DefaultVisual(dpy, screen),
</a> 			CWOverrideRedirect | CWBackPixmap | CWEventMask, &amp;wa);
<a href="#h4-12-66" id="h4-12-66" class="d">-	XDefineCursor(blz.dpy, win, XCreateFontCursor(blz.dpy, XC_xterm));
</a><a href="#h4-12-67" id="h4-12-67" class="d">-	XSync(blz.dpy, False);
</a><a href="#h4-12-68" id="h4-12-68" class="i">+	XDefineCursor(dpy, win, XCreateFontCursor(dpy, XC_xterm));
</a><a href="#h4-12-69" id="h4-12-69" class="i">+	XFlush(dpy);
</a> 
 	/* pixmap */
<a href="#h4-12-72" id="h4-12-72" class="d">-	gc = XCreateGC(blz.dpy, win, 0, 0);
</a><a href="#h4-12-73" id="h4-12-73" class="d">-	pmap = XCreatePixmap(blz.dpy, win, mrect.width, mrect.height,
</a><a href="#h4-12-74" id="h4-12-74" class="d">-			DefaultDepth(blz.dpy, blz.screen));
</a><a href="#h4-12-75" id="h4-12-75" class="d">-
</a><a href="#h4-12-76" id="h4-12-76" class="d">-	XSync(blz.dpy, False);
</a><a href="#h4-12-77" id="h4-12-77" class="d">-
</a><a href="#h4-12-78" id="h4-12-78" class="d">-	brush.blitz = &amp;blz;
</a><a href="#h4-12-79" id="h4-12-79" class="d">-	brush.color = normcolor;
</a><a href="#h4-12-80" id="h4-12-80" class="d">-	brush.drawable = pmap;
</a><a href="#h4-12-81" id="h4-12-81" class="d">-	brush.gc = gc;
</a><a href="#h4-12-82" id="h4-12-82" class="d">-	brush.font = &amp;font;
</a><a href="#h4-12-83" id="h4-12-83" class="i">+	brush.gc = XCreateGC(dpy, win, 0, 0);
</a><a href="#h4-12-84" id="h4-12-84" class="i">+	brush.drawable = XCreatePixmap(dpy, win, rect.width, rect.height,
</a><a href="#h4-12-85" id="h4-12-85" class="i">+			DefaultDepth(dpy, screen));
</a><a href="#h4-12-86" id="h4-12-86" class="i">+	XFlush(dpy);
</a> 
 	if(maxname)
<a href="#h4-12-89" id="h4-12-89" class="d">-		cwidth = blitz_textwidth(brush.font, maxname) + mrect.height;
</a><a href="#h4-12-90" id="h4-12-90" class="d">-	if(cwidth &gt; mrect.width / 3)
</a><a href="#h4-12-91" id="h4-12-91" class="d">-		cwidth = mrect.width / 3;
</a><a href="#h4-12-92" id="h4-12-92" class="i">+		cwidth = textwidth(&amp;brush.font, maxname) + brush.font.height;
</a><a href="#h4-12-93" id="h4-12-93" class="i">+	if(cwidth &gt; rect.width / 3)
</a><a href="#h4-12-94" id="h4-12-94" class="i">+		cwidth = rect.width / 3;
</a> 
 	if(title) {
<a href="#h4-12-97" id="h4-12-97" class="d">-		twidth = blitz_textwidth(brush.font, title) + mrect.height;
</a><a href="#h4-12-98" id="h4-12-98" class="d">-		if(twidth &gt; mrect.width / 3)
</a><a href="#h4-12-99" id="h4-12-99" class="d">-			twidth = mrect.width / 3;
</a><a href="#h4-12-100" id="h4-12-100" class="i">+		twidth = textwidth(&amp;brush.font, title) + brush.font.height;
</a><a href="#h4-12-101" id="h4-12-101" class="i">+		if(twidth &gt; rect.width / 3)
</a><a href="#h4-12-102" id="h4-12-102" class="i">+			twidth = rect.width / 3;
</a> 	}
 
 	cmdw = title ? twidth : cwidth;
 
 	text[0] = 0;
 	update_items(text);
<a href="#h4-12-109" id="h4-12-109" class="d">-	XMapRaised(blz.dpy, win);
</a><a href="#h4-12-110" id="h4-12-110" class="i">+	XMapRaised(dpy, win);
</a> 	draw_menu();
<a href="#h4-12-112" id="h4-12-112" class="d">-	XSync(blz.dpy, False);
</a><a href="#h4-12-113" id="h4-12-113" class="i">+	XFlush(dpy);
</a> 
 	/* main event loop */
<a href="#h4-12-116" id="h4-12-116" class="d">-	while(!XNextEvent(blz.dpy, &amp;ev)) {
</a><a href="#h4-12-117" id="h4-12-117" class="i">+	while(!XNextEvent(dpy, &amp;ev)) {
</a> 		switch (ev.type) {
 			case KeyPress:
<a href="#h4-12-120" id="h4-12-120" class="d">-				handle_kpress(&amp;ev.xkey);
</a><a href="#h4-12-121" id="h4-12-121" class="i">+				kpress(&amp;ev.xkey);
</a> 				break;
 			case Expose:
 				if(ev.xexpose.count == 0) {
<a href="#h4-13" id="h4-13" class="h">@@ -488,11 +455,11 @@ main(int argc, char *argv[])
</a> 			break;
 	}
 
<a href="#h4-13-3" id="h4-13-3" class="d">-	XUngrabKeyboard(blz.dpy, CurrentTime);
</a><a href="#h4-13-4" id="h4-13-4" class="d">-	XFreePixmap(blz.dpy, pmap);
</a><a href="#h4-13-5" id="h4-13-5" class="d">-	XFreeGC(blz.dpy, gc);
</a><a href="#h4-13-6" id="h4-13-6" class="d">-	XDestroyWindow(blz.dpy, win);
</a><a href="#h4-13-7" id="h4-13-7" class="d">-	XCloseDisplay(blz.dpy);
</a><a href="#h4-13-8" id="h4-13-8" class="i">+	XUngrabKeyboard(dpy, CurrentTime);
</a><a href="#h4-13-9" id="h4-13-9" class="i">+	XFreePixmap(dpy, brush.drawable);
</a><a href="#h4-13-10" id="h4-13-10" class="i">+	XFreeGC(dpy, brush.gc);
</a><a href="#h4-13-11" id="h4-13-11" class="i">+	XDestroyWindow(dpy, win);
</a><a href="#h4-13-12" id="h4-13-12" class="i">+	XCloseDisplay(dpy);
</a> 
 	return ret;
 }
<b>diff --git a/<a id="h5" href="../file/util.c.html">util.c</a> b/<a href="../file/util.c.html">util.c</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -6,6 +6,7 @@
</a> #include &lt;stdarg.h&gt;
 #include &lt;stdio.h&gt;
 #include &lt;stdlib.h&gt;
<a href="#h5-0-3" id="h5-0-3" class="i">+#include &lt;string.h&gt;
</a> 
 void
 error(char *errstr, ...) {
<a href="#h5-1" id="h5-1" class="h">@@ -16,3 +17,61 @@ error(char *errstr, ...) {
</a> 	exit(1);
 }
 
<a href="#h5-1-3" id="h5-1-3" class="i">+static void
</a><a href="#h5-1-4" id="h5-1-4" class="i">+bad_malloc(unsigned int size)
</a><a href="#h5-1-5" id="h5-1-5" class="i">+{
</a><a href="#h5-1-6" id="h5-1-6" class="i">+	fprintf(stderr, &quot;fatal: could not malloc() %d bytes\n&quot;,
</a><a href="#h5-1-7" id="h5-1-7" class="i">+			(int) size);
</a><a href="#h5-1-8" id="h5-1-8" class="i">+	exit(1);
</a><a href="#h5-1-9" id="h5-1-9" class="i">+}
</a><a href="#h5-1-10" id="h5-1-10" class="i">+
</a><a href="#h5-1-11" id="h5-1-11" class="i">+void *
</a><a href="#h5-1-12" id="h5-1-12" class="i">+emallocz(unsigned int size)
</a><a href="#h5-1-13" id="h5-1-13" class="i">+{
</a><a href="#h5-1-14" id="h5-1-14" class="i">+	void *res = calloc(1, size);
</a><a href="#h5-1-15" id="h5-1-15" class="i">+	if(!res)
</a><a href="#h5-1-16" id="h5-1-16" class="i">+		bad_malloc(size);
</a><a href="#h5-1-17" id="h5-1-17" class="i">+	return res;
</a><a href="#h5-1-18" id="h5-1-18" class="i">+}
</a><a href="#h5-1-19" id="h5-1-19" class="i">+
</a><a href="#h5-1-20" id="h5-1-20" class="i">+void *
</a><a href="#h5-1-21" id="h5-1-21" class="i">+emalloc(unsigned int size)
</a><a href="#h5-1-22" id="h5-1-22" class="i">+{
</a><a href="#h5-1-23" id="h5-1-23" class="i">+	void *res = malloc(size);
</a><a href="#h5-1-24" id="h5-1-24" class="i">+	if(!res)
</a><a href="#h5-1-25" id="h5-1-25" class="i">+		bad_malloc(size);
</a><a href="#h5-1-26" id="h5-1-26" class="i">+	return res;
</a><a href="#h5-1-27" id="h5-1-27" class="i">+}
</a><a href="#h5-1-28" id="h5-1-28" class="i">+
</a><a href="#h5-1-29" id="h5-1-29" class="i">+void *
</a><a href="#h5-1-30" id="h5-1-30" class="i">+erealloc(void *ptr, unsigned int size)
</a><a href="#h5-1-31" id="h5-1-31" class="i">+{
</a><a href="#h5-1-32" id="h5-1-32" class="i">+	void *res = realloc(ptr, size);
</a><a href="#h5-1-33" id="h5-1-33" class="i">+	if(!res)
</a><a href="#h5-1-34" id="h5-1-34" class="i">+		bad_malloc(size);
</a><a href="#h5-1-35" id="h5-1-35" class="i">+	return res;
</a><a href="#h5-1-36" id="h5-1-36" class="i">+}
</a><a href="#h5-1-37" id="h5-1-37" class="i">+
</a><a href="#h5-1-38" id="h5-1-38" class="i">+char *
</a><a href="#h5-1-39" id="h5-1-39" class="i">+estrdup(const char *str)
</a><a href="#h5-1-40" id="h5-1-40" class="i">+{
</a><a href="#h5-1-41" id="h5-1-41" class="i">+	void *res = strdup(str);
</a><a href="#h5-1-42" id="h5-1-42" class="i">+	if(!res)
</a><a href="#h5-1-43" id="h5-1-43" class="i">+		bad_malloc(strlen(str));
</a><a href="#h5-1-44" id="h5-1-44" class="i">+	return res;
</a><a href="#h5-1-45" id="h5-1-45" class="i">+}
</a><a href="#h5-1-46" id="h5-1-46" class="i">+
</a><a href="#h5-1-47" id="h5-1-47" class="i">+void
</a><a href="#h5-1-48" id="h5-1-48" class="i">+failed_assert(char *a, char *file, int line)
</a><a href="#h5-1-49" id="h5-1-49" class="i">+{
</a><a href="#h5-1-50" id="h5-1-50" class="i">+	fprintf(stderr, &quot;Assertion \&quot;%s\&quot; failed at %s:%d\n&quot;, a, file, line);
</a><a href="#h5-1-51" id="h5-1-51" class="i">+	abort();
</a><a href="#h5-1-52" id="h5-1-52" class="i">+}
</a><a href="#h5-1-53" id="h5-1-53" class="i">+
</a><a href="#h5-1-54" id="h5-1-54" class="i">+void
</a><a href="#h5-1-55" id="h5-1-55" class="i">+swap(void **p1, void **p2)
</a><a href="#h5-1-56" id="h5-1-56" class="i">+{
</a><a href="#h5-1-57" id="h5-1-57" class="i">+	void *tmp = *p1;
</a><a href="#h5-1-58" id="h5-1-58" class="i">+	*p1 = *p2;
</a><a href="#h5-1-59" id="h5-1-59" class="i">+	*p2 = tmp;
</a><a href="#h5-1-60" id="h5-1-60" class="i">+}
</a><b>diff --git a/<a id="h6" href="../file/util.h.html">util.h</a> b/<a href="../file/util.h.html">util.h</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -3,39 +3,14 @@
</a>  * See LICENSE file for license details.
  */
 
<a href="#h6-0-3" id="h6-0-3" class="d">-#include &lt;X11/Xlib.h&gt;
</a><a href="#h6-0-4" id="h6-0-4" class="d">-#include &lt;X11/Xlocale.h&gt;
</a><a href="#h6-0-5" id="h6-0-5" class="d">-
</a><a href="#h6-0-6" id="h6-0-6" class="d">-typedef struct Brush Brush;
</a><a href="#h6-0-7" id="h6-0-7" class="d">-typedef struct Color Color;
</a><a href="#h6-0-8" id="h6-0-8" class="d">-typedef struct Fnt Fnt;
</a><a href="#h6-0-9" id="h6-0-9" class="d">-
</a><a href="#h6-0-10" id="h6-0-10" class="d">-struct Color {
</a><a href="#h6-0-11" id="h6-0-11" class="d">-	unsigned long bg;
</a><a href="#h6-0-12" id="h6-0-12" class="d">-	unsigned long fg;
</a><a href="#h6-0-13" id="h6-0-13" class="d">-	unsigned long border;
</a><a href="#h6-0-14" id="h6-0-14" class="d">-};
</a><a href="#h6-0-15" id="h6-0-15" class="d">-
</a><a href="#h6-0-16" id="h6-0-16" class="d">-struct Fnt {
</a><a href="#h6-0-17" id="h6-0-17" class="d">-	XFontStruct *xfont;
</a><a href="#h6-0-18" id="h6-0-18" class="d">-	XFontSet set;
</a><a href="#h6-0-19" id="h6-0-19" class="d">-	int ascent;
</a><a href="#h6-0-20" id="h6-0-20" class="d">-	int descent;
</a><a href="#h6-0-21" id="h6-0-21" class="d">-};
</a><a href="#h6-0-22" id="h6-0-22" class="d">-
</a><a href="#h6-0-23" id="h6-0-23" class="d">-struct Brush {
</a><a href="#h6-0-24" id="h6-0-24" class="d">-	GC gc;
</a><a href="#h6-0-25" id="h6-0-25" class="d">-	Drawable drawable;
</a><a href="#h6-0-26" id="h6-0-26" class="d">-	XRectangle rect;
</a><a href="#h6-0-27" id="h6-0-27" class="d">-	Bool border;
</a><a href="#h6-0-28" id="h6-0-28" class="d">-	Fnt *font;
</a><a href="#h6-0-29" id="h6-0-29" class="d">-	Color color;
</a><a href="#h6-0-30" id="h6-0-30" class="d">-	const char *text;
</a><a href="#h6-0-31" id="h6-0-31" class="d">-};
</a><a href="#h6-0-32" id="h6-0-32" class="d">-
</a><a href="#h6-0-33" id="h6-0-33" class="d">-extern void draw(Display *dpy, Brush *b);
</a><a href="#h6-0-34" id="h6-0-34" class="d">-extern void loadcolor(Display *dpy, int screen, Color *c,
</a><a href="#h6-0-35" id="h6-0-35" class="d">-		const char *bg, const char *fg, const char *bo);
</a><a href="#h6-0-36" id="h6-0-36" class="d">-extern unsigned int textwidth_l(Fnt *font, char *text, unsigned int len);
</a><a href="#h6-0-37" id="h6-0-37" class="d">-extern unsigned int textwidth(Fnt *font, char *text);
</a><a href="#h6-0-38" id="h6-0-38" class="d">-extern void loadfont(Display *dpy, Fnt *font, const char *fontstr);
</a><a href="#h6-0-39" id="h6-0-39" class="i">+extern void error(char *errstr, ...);
</a><a href="#h6-0-40" id="h6-0-40" class="i">+extern void *emallocz(unsigned int size);
</a><a href="#h6-0-41" id="h6-0-41" class="i">+extern void *emalloc(unsigned int size);
</a><a href="#h6-0-42" id="h6-0-42" class="i">+extern void *erealloc(void *ptr, unsigned int size);
</a><a href="#h6-0-43" id="h6-0-43" class="i">+extern char *estrdup(const char *str);
</a><a href="#h6-0-44" id="h6-0-44" class="i">+#define eassert(a) do { \
</a><a href="#h6-0-45" id="h6-0-45" class="i">+		if(!(a)) \
</a><a href="#h6-0-46" id="h6-0-46" class="i">+			failed_assert(#a, __FILE__, __LINE__); \
</a><a href="#h6-0-47" id="h6-0-47" class="i">+	} while (0)
</a><a href="#h6-0-48" id="h6-0-48" class="i">+void failed_assert(char *a, char *file, int line);
</a><a href="#h6-0-49" id="h6-0-49" class="i">+void swap(void **p1, void **p2);
</a><b>diff --git a/<a id="h7" href="../file/wm.c.html">wm.c</a> b/<a href="../file/wm.c.html">wm.c</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -13,15 +13,20 @@
</a> 
 #include &quot;wm.h&quot;
 
<a href="#h7-0-3" id="h7-0-3" class="i">+/* X structs */
</a> Display *dpy;
 Window root;
 XRectangle rect;
<a href="#h7-0-7" id="h7-0-7" class="d">-int screen, sel_screen;
</a><a href="#h7-0-8" id="h7-0-8" class="i">+Pixmap pmap;
</a> Atom wm_atom[WMLast];
 Atom net_atom[NetLast];
 Cursor cursor[CurLast];
<a href="#h7-0-12" id="h7-0-12" class="i">+
</a><a href="#h7-0-13" id="h7-0-13" class="i">+int screen, sel_screen;
</a> unsigned int kmask, numlock_mask;
<a href="#h7-0-15" id="h7-0-15" class="d">-Pixmap pmap;
</a><a href="#h7-0-16" id="h7-0-16" class="i">+
</a><a href="#h7-0-17" id="h7-0-17" class="i">+/* draw structs */
</a><a href="#h7-0-18" id="h7-0-18" class="i">+Brush brush = {0};
</a> 
 enum { WM_PROTOCOL_DELWIN = 1 };
 
<a href="#h7-1" id="h7-1" class="h">@@ -208,7 +213,7 @@ main(int argc, char *argv[])
</a> 	XSetErrorHandler(startup_error_handler);
 	/* this causes an error if some other WM is running */
 	XSelectInput(dpy, root, SubstructureRedirectMask);
<a href="#h7-1-3" id="h7-1-3" class="d">-	XSync(dpy, False);
</a><a href="#h7-1-4" id="h7-1-4" class="i">+	XFlush(dpy);
</a> 
 	if(other_wm_running)
 		error(&quot;gridwm: another window manager is already running\n&quot;);
<a href="#h7-2" id="h7-2" class="h">@@ -246,6 +251,10 @@ main(int argc, char *argv[])
</a> 	wa.cursor = cursor[CurNormal];
 	XChangeWindowAttributes(dpy, root, CWEventMask | CWCursor, &amp;wa);
 
<a href="#h7-2-3" id="h7-2-3" class="i">+	/* style */
</a><a href="#h7-2-4" id="h7-2-4" class="i">+	loadcolors(dpy, screen, &amp;brush, BGCOLOR, FGCOLOR, BORDERCOLOR);
</a><a href="#h7-2-5" id="h7-2-5" class="i">+	loadfont(dpy, &amp;brush.font, FONT);
</a><a href="#h7-2-6" id="h7-2-6" class="i">+
</a> 	scan_wins();
 
 	cleanup();
<b>diff --git a/<a id="h8" href="../file/wm.h.html">wm.h</a> b/<a href="../file/wm.h.html">wm.h</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -3,6 +3,7 @@
</a>  * See LICENSE file for license details.
  */
 
<a href="#h8-0-3" id="h8-0-3" class="i">+#include &quot;config.h&quot;
</a> #include &quot;draw.h&quot;
 #include &quot;util.h&quot;
 
<a href="#h8-1" id="h8-1" class="h">@@ -48,11 +49,14 @@ struct Tag {
</a> extern Display *dpy;
 extern Window root;
 extern XRectangle rect;
<a href="#h8-1-3" id="h8-1-3" class="d">-extern int screen, sel_screen;
</a><a href="#h8-1-4" id="h8-1-4" class="d">-extern unsigned int kmask, numlock_mask;
</a> extern Atom wm_atom[WMLast];
 extern Atom net_atom[NetLast];
 extern Cursor cursor[CurLast];
 extern Pixmap pmap;
 
<a href="#h8-1-10" id="h8-1-10" class="i">+extern int screen, sel_screen;
</a><a href="#h8-1-11" id="h8-1-11" class="i">+extern unsigned int kmask, numlock_mask;
</a><a href="#h8-1-12" id="h8-1-12" class="i">+
</a><a href="#h8-1-13" id="h8-1-13" class="i">+extern Brush brush;
</a><a href="#h8-1-14" id="h8-1-14" class="i">+
</a> /* wm.c */
</pre>
</div>
</body>
</html>
