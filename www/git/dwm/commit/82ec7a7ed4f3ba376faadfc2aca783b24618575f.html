<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>new experimental updategeom() additions that should avoid several problems with Xinerama, this is EXPERIMENTAL and might break something, the algorithms in use are quite complex and cumbersome, patches and comments welcome - dwm - dynamic window manager
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="dwm Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>dwm</h1><span class="desc">dynamic window manager
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/82ec7a7ed4f3ba376faadfc2aca783b24618575f.html">82ec7a7ed4f3ba376faadfc2aca783b24618575f</a>
<b>parent</b> <a href="../commit/e7300e0f6f10900b50d15ea3ae8949049431e38b.html">e7300e0f6f10900b50d15ea3ae8949049431e38b</a>
<b>Author:</b> Anselm R Garbe &lt;<a href="mailto:anselm@garbe.us">anselm@garbe.us</a>&gt;
<b>Date:</b>   Fri, 18 Sep 2009 21:18:00 +0100

new experimental updategeom() additions that should avoid several problems with Xinerama, this is EXPERIMENTAL and might break something, the algorithms in use are quite complex and cumbersome, patches and comments welcome
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">dwm.c</a></td><td> | </td><td class="num">101</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-------------------</span></td></tr>
</table></pre><pre>1 file changed, 77 insertions(+), 24 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/dwm.c.html">dwm.c</a> b/<a href="../file/dwm.c.html">dwm.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -221,7 +221,7 @@ static void toggleview(const Arg *arg);
</a> static void unfocus(Client *c);
 static void unmanage(Client *c, Bool destroyed);
 static void unmapnotify(XEvent *e);
<a href="#h0-0-3" id="h0-0-3" class="d">-static void updategeom(void);
</a><a href="#h0-0-4" id="h0-0-4" class="i">+static Bool updategeom(void);
</a> static void updatebarpos(Monitor *m);
 static void updatebars(void);
 static void updatenumlockmask(void);
<a href="#h0-1" id="h0-1" class="h">@@ -535,14 +535,15 @@ configurenotify(XEvent *e) {
</a> 	if(ev-&gt;window == root) {
 		sw = ev-&gt;width;
 		sh = ev-&gt;height;
<a href="#h0-1-3" id="h0-1-3" class="d">-		updategeom();
</a><a href="#h0-1-4" id="h0-1-4" class="d">-		if(dc.drawable != 0)
</a><a href="#h0-1-5" id="h0-1-5" class="d">-			XFreePixmap(dpy, dc.drawable);
</a><a href="#h0-1-6" id="h0-1-6" class="d">-		dc.drawable = XCreatePixmap(dpy, root, sw, bh, DefaultDepth(dpy, screen));
</a><a href="#h0-1-7" id="h0-1-7" class="d">-		updatebars();
</a><a href="#h0-1-8" id="h0-1-8" class="d">-		for(m = mons; m; m = m-&gt;next)
</a><a href="#h0-1-9" id="h0-1-9" class="d">-			XMoveResizeWindow(dpy, m-&gt;barwin, m-&gt;wx, m-&gt;by, m-&gt;ww, bh);
</a><a href="#h0-1-10" id="h0-1-10" class="d">-		arrange();
</a><a href="#h0-1-11" id="h0-1-11" class="i">+		if(updategeom()) {
</a><a href="#h0-1-12" id="h0-1-12" class="i">+			if(dc.drawable != 0)
</a><a href="#h0-1-13" id="h0-1-13" class="i">+				XFreePixmap(dpy, dc.drawable);
</a><a href="#h0-1-14" id="h0-1-14" class="i">+			dc.drawable = XCreatePixmap(dpy, root, sw, bh, DefaultDepth(dpy, screen));
</a><a href="#h0-1-15" id="h0-1-15" class="i">+			updatebars();
</a><a href="#h0-1-16" id="h0-1-16" class="i">+			for(m = mons; m; m = m-&gt;next)
</a><a href="#h0-1-17" id="h0-1-17" class="i">+				XMoveResizeWindow(dpy, m-&gt;barwin, m-&gt;wx, m-&gt;by, m-&gt;ww, bh);
</a><a href="#h0-1-18" id="h0-1-18" class="i">+			arrange();
</a><a href="#h0-1-19" id="h0-1-19" class="i">+		}
</a> 	}
 }
 
<a href="#h0-2" id="h0-2" class="h">@@ -1692,26 +1693,73 @@ updatebarpos(Monitor *m) {
</a> 		m-&gt;by = -bh;
 }
 
<a href="#h0-2-3" id="h0-2-3" class="d">-void
</a><a href="#h0-2-4" id="h0-2-4" class="i">+Bool
</a> updategeom(void) {
<a href="#h0-2-6" id="h0-2-6" class="d">-	int i, n = 1;
</a><a href="#h0-2-7" id="h0-2-7" class="i">+	int i, j, nn = 1, n = 1;
</a> 	Client *c;
 	Monitor *newmons = NULL, *m = NULL, *tm;
 
 #ifdef XINERAMA
<a href="#h0-2-12" id="h0-2-12" class="d">-	int nn;
</a> 	XineramaScreenInfo *info = NULL;
<a href="#h0-2-14" id="h0-2-14" class="i">+	Bool *flags = NULL;
</a> 
 	if(XineramaIsActive(dpy))
 		info = XineramaQueryScreens(dpy, &amp;n);
<a href="#h0-2-18" id="h0-2-18" class="d">-	for(i = 1, nn = n; i &lt; n; i++)
</a><a href="#h0-2-19" id="h0-2-19" class="d">-		if(info[i - 1].x_org == info[i].x_org &amp;&amp; info[i - 1].y_org == info[i].y_org
</a><a href="#h0-2-20" id="h0-2-20" class="d">-		&amp;&amp; info[i - 1].width == info[i].width &amp;&amp; info[i - 1].height == info[i].height)
</a><a href="#h0-2-21" id="h0-2-21" class="d">-			--nn;
</a><a href="#h0-2-22" id="h0-2-22" class="d">-	n = nn; /* we only consider unique geometries as separate screens */
</a><a href="#h0-2-23" id="h0-2-23" class="i">+	flags = (Bool *)malloc(sizeof(Bool) * n);
</a><a href="#h0-2-24" id="h0-2-24" class="i">+	for(i = 0; i &lt; n; i++)
</a><a href="#h0-2-25" id="h0-2-25" class="i">+		flags[i] = False;
</a><a href="#h0-2-26" id="h0-2-26" class="i">+	/* next double-loop seeks any combination of retrieved Xinerama info
</a><a href="#h0-2-27" id="h0-2-27" class="i">+	 * with existing monitors, this is used to avoid unnecessary
</a><a href="#h0-2-28" id="h0-2-28" class="i">+	 * re-allocations of monitor structs */
</a><a href="#h0-2-29" id="h0-2-29" class="i">+	for(i = 0, nn = n; i &lt; n; i++)
</a><a href="#h0-2-30" id="h0-2-30" class="i">+		for(j = 0, m = mons; m; m = m-&gt;next, j++)
</a><a href="#h0-2-31" id="h0-2-31" class="i">+			if(!flags[j]) {
</a><a href="#h0-2-32" id="h0-2-32" class="i">+				if((flags[j] = (
</a><a href="#h0-2-33" id="h0-2-33" class="i">+					info[i].x_org == m-&gt;mx
</a><a href="#h0-2-34" id="h0-2-34" class="i">+					&amp;&amp; info[i].y_org == m-&gt;my
</a><a href="#h0-2-35" id="h0-2-35" class="i">+					&amp;&amp; info[i].width == m-&gt;mw
</a><a href="#h0-2-36" id="h0-2-36" class="i">+					&amp;&amp; info[i].height == m-&gt;mh)
</a><a href="#h0-2-37" id="h0-2-37" class="i">+				))
</a><a href="#h0-2-38" id="h0-2-38" class="i">+					--nn;
</a><a href="#h0-2-39" id="h0-2-39" class="i">+			}
</a><a href="#h0-2-40" id="h0-2-40" class="i">+	if(nn == 0) { /* no need to re-allocate monitors */
</a><a href="#h0-2-41" id="h0-2-41" class="i">+		j = 0;
</a><a href="#h0-2-42" id="h0-2-42" class="i">+		for(i = 0, m = mons; m; m = m-&gt;next, i++) {
</a><a href="#h0-2-43" id="h0-2-43" class="i">+			m-&gt;num = info[i].screen_number;
</a><a href="#h0-2-44" id="h0-2-44" class="i">+			if(info[i].x_org != m-&gt;mx
</a><a href="#h0-2-45" id="h0-2-45" class="i">+			|| info[i].y_org != m-&gt;my
</a><a href="#h0-2-46" id="h0-2-46" class="i">+			|| info[i].width != m-&gt;mw
</a><a href="#h0-2-47" id="h0-2-47" class="i">+			|| info[i].height != m-&gt;mh)
</a><a href="#h0-2-48" id="h0-2-48" class="i">+			{
</a><a href="#h0-2-49" id="h0-2-49" class="i">+				m-&gt;mx = m-&gt;wx = info[i].x_org;
</a><a href="#h0-2-50" id="h0-2-50" class="i">+				m-&gt;my = m-&gt;wy = info[i].y_org;
</a><a href="#h0-2-51" id="h0-2-51" class="i">+				m-&gt;mw = m-&gt;ww = info[i].width;
</a><a href="#h0-2-52" id="h0-2-52" class="i">+				m-&gt;mh = m-&gt;wh = info[i].height;
</a><a href="#h0-2-53" id="h0-2-53" class="i">+				updatebarpos(m);
</a><a href="#h0-2-54" id="h0-2-54" class="i">+				j++;
</a><a href="#h0-2-55" id="h0-2-55" class="i">+			}
</a><a href="#h0-2-56" id="h0-2-56" class="i">+		}
</a><a href="#h0-2-57" id="h0-2-57" class="i">+		XFree(info);
</a><a href="#h0-2-58" id="h0-2-58" class="i">+		free(flags);
</a><a href="#h0-2-59" id="h0-2-59" class="i">+		return j &gt; 0;
</a><a href="#h0-2-60" id="h0-2-60" class="i">+	}
</a><a href="#h0-2-61" id="h0-2-61" class="i">+	/* next algorithm only considers unique geometries as separate screens */
</a><a href="#h0-2-62" id="h0-2-62" class="i">+	for(i = 0; i &lt; n; i++)
</a><a href="#h0-2-63" id="h0-2-63" class="i">+		flags[i] = False; /* used for ignoring certain monitors */
</a><a href="#h0-2-64" id="h0-2-64" class="i">+	for(i = 0, nn = n; i &lt; n; i++)
</a><a href="#h0-2-65" id="h0-2-65" class="i">+		for(j = 0; j &lt; n; j++)
</a><a href="#h0-2-66" id="h0-2-66" class="i">+			if(i != j &amp;&amp; !flags[i]) {
</a><a href="#h0-2-67" id="h0-2-67" class="i">+				if((flags[i] = (
</a><a href="#h0-2-68" id="h0-2-68" class="i">+					info[i].x_org == info[j].x_org
</a><a href="#h0-2-69" id="h0-2-69" class="i">+					&amp;&amp; info[i].y_org == info[j].y_org
</a><a href="#h0-2-70" id="h0-2-70" class="i">+					&amp;&amp; info[i].width == info[j].width
</a><a href="#h0-2-71" id="h0-2-71" class="i">+					&amp;&amp; info[i].height == info[j].height)
</a><a href="#h0-2-72" id="h0-2-72" class="i">+				))
</a><a href="#h0-2-73" id="h0-2-73" class="i">+					--nn;
</a><a href="#h0-2-74" id="h0-2-74" class="i">+			}
</a> #endif /* XINERAMA */
 	/* allocate monitor(s) for the new geometry setup */
<a href="#h0-2-77" id="h0-2-77" class="d">-	for(i = 0; i &lt; n; i++) {
</a><a href="#h0-2-78" id="h0-2-78" class="i">+	for(i = 0; i &lt; nn; i++) {
</a> 		if(!(m = (Monitor *)malloc(sizeof(Monitor))))
 			die(&quot;fatal: could not malloc() %u bytes\n&quot;, sizeof(Monitor));
 		m-&gt;next = newmons;
<a href="#h0-3" id="h0-3" class="h">@@ -1720,14 +1768,18 @@ updategeom(void) {
</a> 	/* initialise monitor(s) */
 #ifdef XINERAMA
 	if(XineramaIsActive(dpy)) {
<a href="#h0-3-3" id="h0-3-3" class="d">-		for(i = 0, m = newmons; m; m = m-&gt;next, i++) {
</a><a href="#h0-3-4" id="h0-3-4" class="d">-			m-&gt;num = info[i].screen_number;
</a><a href="#h0-3-5" id="h0-3-5" class="d">-			m-&gt;mx = m-&gt;wx = info[i].x_org;
</a><a href="#h0-3-6" id="h0-3-6" class="d">-			m-&gt;my = m-&gt;wy = info[i].y_org;
</a><a href="#h0-3-7" id="h0-3-7" class="d">-			m-&gt;mw = m-&gt;ww = info[i].width;
</a><a href="#h0-3-8" id="h0-3-8" class="d">-			m-&gt;mh = m-&gt;wh = info[i].height;
</a><a href="#h0-3-9" id="h0-3-9" class="i">+		for(i = 0, m = newmons; m &amp;&amp; i &lt; n; i++) {
</a><a href="#h0-3-10" id="h0-3-10" class="i">+			if(!flags[i]) { /* only use screens that aren&#39;t dublettes */
</a><a href="#h0-3-11" id="h0-3-11" class="i">+				m-&gt;num = info[i].screen_number;
</a><a href="#h0-3-12" id="h0-3-12" class="i">+				m-&gt;mx = m-&gt;wx = info[i].x_org;
</a><a href="#h0-3-13" id="h0-3-13" class="i">+				m-&gt;my = m-&gt;wy = info[i].y_org;
</a><a href="#h0-3-14" id="h0-3-14" class="i">+				m-&gt;mw = m-&gt;ww = info[i].width;
</a><a href="#h0-3-15" id="h0-3-15" class="i">+				m-&gt;mh = m-&gt;wh = info[i].height;
</a><a href="#h0-3-16" id="h0-3-16" class="i">+				m = m-&gt;next;
</a><a href="#h0-3-17" id="h0-3-17" class="i">+			}
</a> 		}
 		XFree(info);
<a href="#h0-3-20" id="h0-3-20" class="i">+		free(flags);
</a> 	}
 	else
 #endif /* XINERAMA */
<a href="#h0-4" id="h0-4" class="h">@@ -1767,6 +1819,7 @@ updategeom(void) {
</a> 	cleanupmons();
 	selmon = mons = newmons;
 	selmon = wintomon(root);
<a href="#h0-4-3" id="h0-4-3" class="i">+	return True;
</a> }
 
 void
</pre>
</div>
</body>
</html>
