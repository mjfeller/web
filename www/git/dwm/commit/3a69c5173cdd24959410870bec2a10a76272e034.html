<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>implemented pipe_spawn - dwm - dynamic window manager
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="dwm Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>dwm</h1><span class="desc">dynamic window manager
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/3a69c5173cdd24959410870bec2a10a76272e034.html">3a69c5173cdd24959410870bec2a10a76272e034</a>
<b>parent</b> <a href="../commit/439e15d09f6fa9271d3b49ef97194f0c80ebe161.html">439e15d09f6fa9271d3b49ef97194f0c80ebe161</a>
<b>Author:</b> Anselm R. Garbe &lt;<a href="mailto:garbeam@wmii.de">garbeam@wmii.de</a>&gt;
<b>Date:</b>   Tue, 11 Jul 2006 11:10:05 +0200

implemented pipe_spawn

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">config.h</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">event.c</a></td><td> | </td><td class="num">6</td><td><span class="i">++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">menu.c</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">util.c</a></td><td> | </td><td class="num">56</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">util.h</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">wm.c</a></td><td> | </td><td class="num">7</td><td><span class="i">++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">wm.h</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
</table></pre><pre>7 files changed, 70 insertions(+), 15 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config.h.html">config.h</a> b/<a href="../file/config.h.html">config.h</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -7,3 +7,5 @@
</a> #define BGCOLOR		&quot;#000000&quot;
 #define FGCOLOR		&quot;#ffaa00&quot;
 #define BORDERCOLOR	&quot;#000000&quot;
<a href="#h0-0-3" id="h0-0-3" class="i">+#define STATUSCMD	&quot;echo -n `date` `uptime | sed &#39;s/.*://; s/,//g&#39;`&quot; \
</a><a href="#h0-0-4" id="h0-0-4" class="i">+					&quot; `acpi | awk &#39;{print $4}&#39; | sed &#39;s/,//&#39;`&quot;
</a><b>diff --git a/<a id="h1" href="../file/event.c.html">event.c</a> b/<a href="../file/event.c.html">event.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -218,7 +218,6 @@ keymapnotify(XEvent *e)
</a> static void
 maprequest(XEvent *e)
 {
<a href="#h1-0-3" id="h1-0-3" class="d">-#if 0
</a> 	XMapRequestEvent *ev = &amp;e-&gt;xmaprequest;
 	static XWindowAttributes wa;
 
<a href="#h1-1" id="h1-1" class="h">@@ -231,9 +230,8 @@ maprequest(XEvent *e)
</a> 		return;
 	}
 
<a href="#h1-1-3" id="h1-1-3" class="d">-	if(!client_of_win(ev-&gt;window))
</a><a href="#h1-1-4" id="h1-1-4" class="d">-		manage_client(create_client(ev-&gt;window, &amp;wa));
</a><a href="#h1-1-5" id="h1-1-5" class="d">-#endif
</a><a href="#h1-1-6" id="h1-1-6" class="i">+	/*if(!client_of_win(ev-&gt;window))*/
</a><a href="#h1-1-7" id="h1-1-7" class="i">+		manage(create_client(ev-&gt;window, &amp;wa));
</a> }
 
 static void
<b>diff --git a/<a id="h2" href="../file/menu.c.html">menu.c</a> b/<a href="../file/menu.c.html">menu.c</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -356,6 +356,15 @@ main(int argc, char *argv[])
</a> 	char *maxname;
 	XEvent ev;
 
<a href="#h2-0-3" id="h2-0-3" class="i">+	char buf[256];
</a><a href="#h2-0-4" id="h2-0-4" class="i">+
</a><a href="#h2-0-5" id="h2-0-5" class="i">+	fputs(STATUSCMD, stdout);
</a><a href="#h2-0-6" id="h2-0-6" class="i">+	fputs(&quot;\n&quot;, stdout);
</a><a href="#h2-0-7" id="h2-0-7" class="i">+	pipe_spawn(buf, sizeof(buf), NULL, STATUSCMD);
</a><a href="#h2-0-8" id="h2-0-8" class="i">+	fputs(buf, stderr);
</a><a href="#h2-0-9" id="h2-0-9" class="i">+
</a><a href="#h2-0-10" id="h2-0-10" class="i">+	return 0;
</a><a href="#h2-0-11" id="h2-0-11" class="i">+
</a> 	/* command line args */
 	for(i = 1; i &lt; argc; i++) {
 		if (argv[i][0] == &#39;-&#39;)
<b>diff --git a/<a id="h3" href="../file/util.c.html">util.c</a> b/<a href="../file/util.c.html">util.c</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -13,6 +13,8 @@
</a> 
 #include &quot;util.h&quot;
 
<a href="#h3-0-3" id="h3-0-3" class="i">+static char *shell = NULL;
</a><a href="#h3-0-4" id="h3-0-4" class="i">+
</a> void
 error(char *errstr, ...) {
 	va_list ap;
<a href="#h3-1" id="h3-1" class="h">@@ -82,19 +84,65 @@ swap(void **p1, void **p2)
</a> }
 
 void
<a href="#h3-1-3" id="h3-1-3" class="d">-spawn(Display *dpy, const char *shell, const char *cmd)
</a><a href="#h3-1-4" id="h3-1-4" class="i">+spawn(Display *dpy, const char *cmd)
</a> {
<a href="#h3-1-6" id="h3-1-6" class="d">-	if(!cmd || !shell)
</a><a href="#h3-1-7" id="h3-1-7" class="i">+	if(!shell &amp;&amp; !(shell = getenv(&quot;SHELL&quot;)))
</a><a href="#h3-1-8" id="h3-1-8" class="i">+		shell = &quot;/bin/sh&quot;;
</a><a href="#h3-1-9" id="h3-1-9" class="i">+
</a><a href="#h3-1-10" id="h3-1-10" class="i">+	if(!cmd)
</a> 		return;
 	if(fork() == 0) {
 		if(fork() == 0) {
<a href="#h3-1-14" id="h3-1-14" class="i">+			setsid();
</a> 			if(dpy)
 				close(ConnectionNumber(dpy));
<a href="#h3-1-17" id="h3-1-17" class="d">-			execl(shell, shell, &quot;-c&quot;, cmd, (const char *)0);
</a><a href="#h3-1-18" id="h3-1-18" class="d">-			fprintf(stderr, &quot;gridwm: execl %s&quot;, shell);
</a><a href="#h3-1-19" id="h3-1-19" class="i">+			execlp(shell, &quot;shell&quot;, &quot;-c&quot;, cmd, NULL);
</a><a href="#h3-1-20" id="h3-1-20" class="i">+			fprintf(stderr, &quot;gridwm: execvp %s&quot;, cmd);
</a> 			perror(&quot; failed&quot;);
 		}
 		exit (0);
 	}
 	wait(0);
 }
<a href="#h3-1-27" id="h3-1-27" class="i">+
</a><a href="#h3-1-28" id="h3-1-28" class="i">+void
</a><a href="#h3-1-29" id="h3-1-29" class="i">+pipe_spawn(char *buf, unsigned int len, Display *dpy, const char *cmd)
</a><a href="#h3-1-30" id="h3-1-30" class="i">+{
</a><a href="#h3-1-31" id="h3-1-31" class="i">+	unsigned int l, n;
</a><a href="#h3-1-32" id="h3-1-32" class="i">+	int pfd[2];
</a><a href="#h3-1-33" id="h3-1-33" class="i">+
</a><a href="#h3-1-34" id="h3-1-34" class="i">+	if(!shell &amp;&amp; !(shell = getenv(&quot;SHELL&quot;)))
</a><a href="#h3-1-35" id="h3-1-35" class="i">+		shell = &quot;/bin/sh&quot;;
</a><a href="#h3-1-36" id="h3-1-36" class="i">+
</a><a href="#h3-1-37" id="h3-1-37" class="i">+	if(!cmd)
</a><a href="#h3-1-38" id="h3-1-38" class="i">+		return;
</a><a href="#h3-1-39" id="h3-1-39" class="i">+
</a><a href="#h3-1-40" id="h3-1-40" class="i">+	if(pipe(pfd) == -1) {
</a><a href="#h3-1-41" id="h3-1-41" class="i">+		perror(&quot;pipe&quot;);
</a><a href="#h3-1-42" id="h3-1-42" class="i">+		exit(1);
</a><a href="#h3-1-43" id="h3-1-43" class="i">+	}
</a><a href="#h3-1-44" id="h3-1-44" class="i">+
</a><a href="#h3-1-45" id="h3-1-45" class="i">+	if(fork() == 0) {
</a><a href="#h3-1-46" id="h3-1-46" class="i">+		setsid();
</a><a href="#h3-1-47" id="h3-1-47" class="i">+		if(dpy)
</a><a href="#h3-1-48" id="h3-1-48" class="i">+			close(ConnectionNumber(dpy));
</a><a href="#h3-1-49" id="h3-1-49" class="i">+		dup2(pfd[1], STDOUT_FILENO);
</a><a href="#h3-1-50" id="h3-1-50" class="i">+		close(pfd[0]);
</a><a href="#h3-1-51" id="h3-1-51" class="i">+		close(pfd[1]);
</a><a href="#h3-1-52" id="h3-1-52" class="i">+		execlp(shell, &quot;shell&quot;, &quot;-c&quot;, cmd, NULL);
</a><a href="#h3-1-53" id="h3-1-53" class="i">+		fprintf(stderr, &quot;gridwm: execvp %s&quot;, cmd);
</a><a href="#h3-1-54" id="h3-1-54" class="i">+		perror(&quot; failed&quot;);
</a><a href="#h3-1-55" id="h3-1-55" class="i">+	}
</a><a href="#h3-1-56" id="h3-1-56" class="i">+	else {
</a><a href="#h3-1-57" id="h3-1-57" class="i">+		n = 0;
</a><a href="#h3-1-58" id="h3-1-58" class="i">+		close(pfd[1]);
</a><a href="#h3-1-59" id="h3-1-59" class="i">+		while(l &gt; n) {
</a><a href="#h3-1-60" id="h3-1-60" class="i">+			if((l = read(pfd[0], buf + n, len - n)) &lt; 1)
</a><a href="#h3-1-61" id="h3-1-61" class="i">+				break;
</a><a href="#h3-1-62" id="h3-1-62" class="i">+			n += l;
</a><a href="#h3-1-63" id="h3-1-63" class="i">+		}
</a><a href="#h3-1-64" id="h3-1-64" class="i">+		close(pfd[0]);
</a><a href="#h3-1-65" id="h3-1-65" class="i">+		buf[n - 1] = 0;
</a><a href="#h3-1-66" id="h3-1-66" class="i">+	}
</a><a href="#h3-1-67" id="h3-1-67" class="i">+	wait(0);
</a><a href="#h3-1-68" id="h3-1-68" class="i">+}
</a><b>diff --git a/<a id="h4" href="../file/util.h.html">util.h</a> b/<a href="../file/util.h.html">util.h</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -14,5 +14,6 @@ extern char *estrdup(const char *str);
</a> 			failed_assert(#a, __FILE__, __LINE__); \
 	} while (0)
 extern void failed_assert(char *a, char *file, int line);
<a href="#h4-0-3" id="h4-0-3" class="i">+void pipe_spawn(char *buf, unsigned int len, Display *dpy, const char *cmd);
</a><a href="#h4-0-4" id="h4-0-4" class="i">+extern void spawn(Display *dpy, const char *cmd);
</a> extern void swap(void **p1, void **p2);
<a href="#h4-0-6" id="h4-0-6" class="d">-extern void spawn(Display *dpy, const char *shell, const char *cmd);
</a><b>diff --git a/<a id="h5" href="../file/wm.c.html">wm.c</a> b/<a href="../file/wm.c.html">wm.c</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -21,7 +21,7 @@ Cursor cursor[CurLast];
</a> XRectangle rect, barrect;
 Bool running = True;
 
<a href="#h5-0-3" id="h5-0-3" class="d">-char *bartext, *shell;
</a><a href="#h5-0-4" id="h5-0-4" class="i">+char *bartext;
</a> int screen, sel_screen;
 unsigned int lock_mask, numlock_mask;
 
<a href="#h5-1" id="h5-1" class="h">@@ -56,7 +56,7 @@ scan_wins()
</a> 			if(wa.override_redirect || XGetTransientForHint(dpy, wins[i], &amp;d1))
 				continue;
 			if(wa.map_state == IsViewable)
<a href="#h5-1-3" id="h5-1-3" class="d">-				/*manage*/;
</a><a href="#h5-1-4" id="h5-1-4" class="i">+				manage(create_client(wins[i], &amp;wa));
</a> 		}
 	}
 	if(wins)
<a href="#h5-2" id="h5-2" class="h">@@ -219,9 +219,6 @@ main(int argc, char *argv[])
</a> 	if(other_wm_running)
 		error(&quot;gridwm: another window manager is already running\n&quot;);
 
<a href="#h5-2-3" id="h5-2-3" class="d">-	if(!(shell = getenv(&quot;SHELL&quot;)))
</a><a href="#h5-2-4" id="h5-2-4" class="d">-		shell = &quot;/bin/sh&quot;;
</a><a href="#h5-2-5" id="h5-2-5" class="d">-
</a> 	rect.x = rect.y = 0;
 	rect.width = DisplayWidth(dpy, screen);
 	rect.height = DisplayHeight(dpy, screen);
<b>diff --git a/<a id="h6" href="../file/wm.h.html">wm.h</a> b/<a href="../file/wm.h.html">wm.h</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -55,7 +55,7 @@ extern void (*handler[LASTEvent]) (XEvent *);
</a> 
 extern int screen, sel_screen;
 extern unsigned int lock_mask, numlock_mask;
<a href="#h6-0-3" id="h6-0-3" class="d">-extern char *bartext, *shell;
</a><a href="#h6-0-4" id="h6-0-4" class="i">+extern char *bartext;
</a> 
 extern Brush brush;
 
</pre>
</div>
</body>
</html>
