<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>fixed several issues with focus handling via mouse, also added sending clients to the right monitor they belong to after mouse moves/resizals - dwm - dynamic window manager
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="dwm Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>dwm</h1><span class="desc">dynamic window manager
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/176408afa895adf133a437038466ddc74e326a0c.html">176408afa895adf133a437038466ddc74e326a0c</a>
<b>parent</b> <a href="../commit/64674c395b89f8d9640163cdcf9c8f4e25ba0e9c.html">64674c395b89f8d9640163cdcf9c8f4e25ba0e9c</a>
<b>Author:</b> Anselm R Garbe &lt;<a href="mailto:anselm@garbe.us">anselm@garbe.us</a>&gt;
<b>Date:</b>   Sat, 27 Jun 2009 18:39:03 +0100

fixed several issues with focus handling via mouse, also added sending clients to the right monitor they belong to after mouse moves/resizals
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">dwm.c</a></td><td> | </td><td class="num">122</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------</span></td></tr>
</table></pre><pre>1 file changed, 79 insertions(+), 43 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/dwm.c.html">dwm.c</a> b/<a href="../file/dwm.c.html">dwm.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -166,7 +166,7 @@ static void detach(Client *c);
</a> static void detachstack(Client *c);
 static void die(const char *errstr, ...);
 static void drawbar(Monitor *m);
<a href="#h0-0-3" id="h0-0-3" class="d">-static void drawbars();
</a><a href="#h0-0-4" id="h0-0-4" class="i">+static void drawbars(void);
</a> static void drawsquare(Bool filled, Bool empty, Bool invert, unsigned long col[ColLast]);
 static void drawtext(const char *text, unsigned long col[ColLast], Bool invert);
 static void enternotify(XEvent *e);
<a href="#h0-1" id="h0-1" class="h">@@ -176,6 +176,9 @@ static void focusin(XEvent *e);
</a> static void focusstack(const Arg *arg);
 static Client *getclient(Window w);
 static unsigned long getcolor(const char *colstr);
<a href="#h0-1-3" id="h0-1-3" class="i">+static Monitor *getmonitor(Window w);
</a><a href="#h0-1-4" id="h0-1-4" class="i">+static Monitor *getmonitorxy(int x, int y);
</a><a href="#h0-1-5" id="h0-1-5" class="i">+static Bool getrootpointer(int *x, int *y);
</a> static long getstate(Window w);
 static Bool gettextprop(Window w, Atom atom, char *text, unsigned int size);
 static void grabbuttons(Client *c, Bool focused);
<a href="#h0-2" id="h0-2" class="h">@@ -197,6 +200,7 @@ static void resizemouse(const Arg *arg);
</a> static void restack(Monitor *m);
 static void run(void);
 static void scan(void);
<a href="#h0-2-3" id="h0-2-3" class="i">+static void sendmon(Client *c, Monitor *m);
</a> static void setclientstate(Client *c, long state);
 static void setlayout(const Arg *arg);
 static void setmfact(const Arg *arg);
<a href="#h0-3" id="h0-3" class="h">@@ -397,15 +401,11 @@ buttonpress(XEvent *e) {
</a> 
 	click = ClkRootWin;
 	/* focus monitor if necessary */
<a href="#h0-3-3" id="h0-3-3" class="d">-	for(m = mons; m; m = m-&gt;next)
</a><a href="#h0-3-4" id="h0-3-4" class="d">-		if(ev-&gt;window == m-&gt;barwin) {
</a><a href="#h0-3-5" id="h0-3-5" class="d">-			if(m != selmon) {
</a><a href="#h0-3-6" id="h0-3-6" class="d">-				unfocus(selmon-&gt;stack);
</a><a href="#h0-3-7" id="h0-3-7" class="d">-				selmon = m;
</a><a href="#h0-3-8" id="h0-3-8" class="d">-				focus(NULL);
</a><a href="#h0-3-9" id="h0-3-9" class="d">-			}
</a><a href="#h0-3-10" id="h0-3-10" class="d">-			break;
</a><a href="#h0-3-11" id="h0-3-11" class="d">-		}
</a><a href="#h0-3-12" id="h0-3-12" class="i">+	if((m = getmonitor(ev-&gt;window)) &amp;&amp; m != selmon) {
</a><a href="#h0-3-13" id="h0-3-13" class="i">+		unfocus(selmon-&gt;sel);
</a><a href="#h0-3-14" id="h0-3-14" class="i">+		selmon = m;
</a><a href="#h0-3-15" id="h0-3-15" class="i">+		focus(NULL);
</a><a href="#h0-3-16" id="h0-3-16" class="i">+	}
</a> 	if(ev-&gt;window == selmon-&gt;barwin &amp;&amp; ev-&gt;x &gt;= selmon-&gt;btx) {
 		i = 0;
 		x = selmon-&gt;btx;
<a href="#h0-4" id="h0-4" class="h">@@ -683,7 +683,7 @@ drawbar(Monitor *m) {
</a> }
 
 void
<a href="#h0-4-3" id="h0-4-3" class="d">-drawbars() {
</a><a href="#h0-4-4" id="h0-4-4" class="i">+drawbars(void) {
</a> 	Monitor *m;
 
 	for(m = mons; m; m = m-&gt;next)
<a href="#h0-5" id="h0-5" class="h">@@ -742,10 +742,15 @@ drawtext(const char *text, unsigned long col[ColLast], Bool invert) {
</a> void
 enternotify(XEvent *e) {
 	Client *c;
<a href="#h0-5-3" id="h0-5-3" class="i">+	Monitor *m;
</a> 	XCrossingEvent *ev = &amp;e-&gt;xcrossing;
 
 	if((ev-&gt;mode != NotifyNormal || ev-&gt;detail == NotifyInferior) &amp;&amp; ev-&gt;window != root)
 		return;
<a href="#h0-5-8" id="h0-5-8" class="i">+	if((m = getmonitor(ev-&gt;window)) &amp;&amp; m != selmon) {
</a><a href="#h0-5-9" id="h0-5-9" class="i">+		unfocus(selmon-&gt;sel);
</a><a href="#h0-5-10" id="h0-5-10" class="i">+		selmon = m;
</a><a href="#h0-5-11" id="h0-5-11" class="i">+	}
</a> 	if((c = getclient(ev-&gt;window)))
 		focus(c);
 	else
<a href="#h0-6" id="h0-6" class="h">@@ -757,12 +762,8 @@ expose(XEvent *e) {
</a> 	Monitor *m;
 	XExposeEvent *ev = &amp;e-&gt;xexpose;
 
<a href="#h0-6-3" id="h0-6-3" class="d">-	if(ev-&gt;count == 0)
</a><a href="#h0-6-4" id="h0-6-4" class="d">-		for(m = mons; m; m = m-&gt;next)
</a><a href="#h0-6-5" id="h0-6-5" class="d">-			if(ev-&gt;window == m-&gt;barwin) {
</a><a href="#h0-6-6" id="h0-6-6" class="d">-				drawbar(m);
</a><a href="#h0-6-7" id="h0-6-7" class="d">-				break;
</a><a href="#h0-6-8" id="h0-6-8" class="d">-			}
</a><a href="#h0-6-9" id="h0-6-9" class="i">+	if(ev-&gt;count == 0 &amp;&amp; (m = getmonitor(ev-&gt;window)))
</a><a href="#h0-6-10" id="h0-6-10" class="i">+		drawbar(m);
</a> }
 
 void
<a href="#h0-7" id="h0-7" class="h">@@ -809,7 +810,6 @@ focusmon(const Arg *arg) {
</a> 			unfocus(selmon-&gt;sel);
 			selmon = m;
 			focus(NULL);
<a href="#h0-7-3" id="h0-7-3" class="d">-			drawbars();
</a> 			break;
 		}
 }
<a href="#h0-8" id="h0-8" class="h">@@ -863,6 +863,40 @@ getcolor(const char *colstr) {
</a> 	return color.pixel;
 }
 
<a href="#h0-8-3" id="h0-8-3" class="i">+Monitor *
</a><a href="#h0-8-4" id="h0-8-4" class="i">+getmonitor(Window w) {
</a><a href="#h0-8-5" id="h0-8-5" class="i">+	int x, y;
</a><a href="#h0-8-6" id="h0-8-6" class="i">+	Client *c;
</a><a href="#h0-8-7" id="h0-8-7" class="i">+	Monitor *m;
</a><a href="#h0-8-8" id="h0-8-8" class="i">+
</a><a href="#h0-8-9" id="h0-8-9" class="i">+	if(w == root &amp;&amp; getrootpointer(&amp;x, &amp;y))
</a><a href="#h0-8-10" id="h0-8-10" class="i">+		return getmonitorxy(x, y);
</a><a href="#h0-8-11" id="h0-8-11" class="i">+	for(m = mons; m; m = m-&gt;next)
</a><a href="#h0-8-12" id="h0-8-12" class="i">+		if(w == m-&gt;barwin)
</a><a href="#h0-8-13" id="h0-8-13" class="i">+			return m;
</a><a href="#h0-8-14" id="h0-8-14" class="i">+	if((c = getclient(w)))
</a><a href="#h0-8-15" id="h0-8-15" class="i">+		return c-&gt;mon;
</a><a href="#h0-8-16" id="h0-8-16" class="i">+	return NULL;
</a><a href="#h0-8-17" id="h0-8-17" class="i">+}
</a><a href="#h0-8-18" id="h0-8-18" class="i">+
</a><a href="#h0-8-19" id="h0-8-19" class="i">+Monitor *
</a><a href="#h0-8-20" id="h0-8-20" class="i">+getmonitorxy(int x, int y) {
</a><a href="#h0-8-21" id="h0-8-21" class="i">+	Monitor *m;
</a><a href="#h0-8-22" id="h0-8-22" class="i">+
</a><a href="#h0-8-23" id="h0-8-23" class="i">+	for(m = mons; m; m = m-&gt;next)
</a><a href="#h0-8-24" id="h0-8-24" class="i">+		if(INRECT(x, y, m-&gt;wx, m-&gt;wy, m-&gt;ww, m-&gt;wh))
</a><a href="#h0-8-25" id="h0-8-25" class="i">+			return m;
</a><a href="#h0-8-26" id="h0-8-26" class="i">+	return NULL;
</a><a href="#h0-8-27" id="h0-8-27" class="i">+}
</a><a href="#h0-8-28" id="h0-8-28" class="i">+
</a><a href="#h0-8-29" id="h0-8-29" class="i">+Bool
</a><a href="#h0-8-30" id="h0-8-30" class="i">+getrootpointer(int *x, int *y) {
</a><a href="#h0-8-31" id="h0-8-31" class="i">+	int di;
</a><a href="#h0-8-32" id="h0-8-32" class="i">+	unsigned int dui;
</a><a href="#h0-8-33" id="h0-8-33" class="i">+	Window dummy;
</a><a href="#h0-8-34" id="h0-8-34" class="i">+	return XQueryPointer(dpy, root, &amp;dummy, &amp;dummy, x, y, &amp;di, &amp;di, &amp;dui);
</a><a href="#h0-8-35" id="h0-8-35" class="i">+}
</a><a href="#h0-8-36" id="h0-8-36" class="i">+
</a> long
 getstate(Window w) {
 	int format, status;
<a href="#h0-9" id="h0-9" class="h">@@ -1124,10 +1158,9 @@ monocle(Monitor *m) {
</a> 
 void
 movemouse(const Arg *arg) {
<a href="#h0-9-3" id="h0-9-3" class="d">-	int x, y, ocx, ocy, di, nx, ny;
</a><a href="#h0-9-4" id="h0-9-4" class="d">-	unsigned int dui;
</a><a href="#h0-9-5" id="h0-9-5" class="i">+	int x, y, ocx, ocy, nx, ny;
</a> 	Client *c;
<a href="#h0-9-7" id="h0-9-7" class="d">-	Window dummy;
</a><a href="#h0-9-8" id="h0-9-8" class="i">+	Monitor *m;
</a> 	XEvent ev;
 
 	if(!(c = selmon-&gt;sel))
<a href="#h0-10" id="h0-10" class="h">@@ -1138,7 +1171,8 @@ movemouse(const Arg *arg) {
</a> 	if(XGrabPointer(dpy, root, False, MOUSEMASK, GrabModeAsync, GrabModeAsync,
 	None, cursor[CurMove], CurrentTime) != GrabSuccess)
 		return;
<a href="#h0-10-3" id="h0-10-3" class="d">-	XQueryPointer(dpy, root, &amp;dummy, &amp;dummy, &amp;x, &amp;y, &amp;di, &amp;di, &amp;dui);
</a><a href="#h0-10-4" id="h0-10-4" class="i">+	if(!getrootpointer(&amp;x, &amp;y))
</a><a href="#h0-10-5" id="h0-10-5" class="i">+		return;
</a> 	do {
 		XMaskEvent(dpy, MOUSEMASK|ExposureMask|SubstructureRedirectMask, &amp;ev);
 		switch (ev.type) {
<a href="#h0-11" id="h0-11" class="h">@@ -1171,6 +1205,8 @@ movemouse(const Arg *arg) {
</a> 	}
 	while(ev.type != ButtonRelease);
 	XUngrabPointer(dpy, CurrentTime);
<a href="#h0-11-3" id="h0-11-3" class="i">+	if((m = getmonitorxy(c-&gt;x + c-&gt;w / 2, c-&gt;y + c-&gt;h / 2)) != selmon)
</a><a href="#h0-11-4" id="h0-11-4" class="i">+		sendmon(c, m);
</a> }
 
 Client *
<a href="#h0-12" id="h0-12" class="h">@@ -1239,6 +1275,7 @@ resizemouse(const Arg *arg) {
</a> 	int ocx, ocy;
 	int nw, nh;
 	Client *c;
<a href="#h0-12-3" id="h0-12-3" class="i">+	Monitor *m;
</a> 	XEvent ev;
 
 	if(!(c = selmon-&gt;sel))
<a href="#h0-13" id="h0-13" class="h">@@ -1277,6 +1314,8 @@ resizemouse(const Arg *arg) {
</a> 	XWarpPointer(dpy, None, c-&gt;win, 0, 0, 0, 0, c-&gt;w + c-&gt;bw - 1, c-&gt;h + c-&gt;bw - 1);
 	XUngrabPointer(dpy, CurrentTime);
 	while(XCheckMaskEvent(dpy, EnterWindowMask, &amp;ev));
<a href="#h0-13-3" id="h0-13-3" class="i">+	if((m = getmonitorxy(c-&gt;x + c-&gt;w / 2, c-&gt;y + c-&gt;h / 2)) != selmon)
</a><a href="#h0-13-4" id="h0-13-4" class="i">+		sendmon(c, m);
</a> }
 
 void
<a href="#h0-14" id="h0-14" class="h">@@ -1342,6 +1381,20 @@ scan(void) {
</a> }
 
 void
<a href="#h0-14-3" id="h0-14-3" class="i">+sendmon(Client *c, Monitor *m) {
</a><a href="#h0-14-4" id="h0-14-4" class="i">+	if(c-&gt;mon == m)
</a><a href="#h0-14-5" id="h0-14-5" class="i">+		return;
</a><a href="#h0-14-6" id="h0-14-6" class="i">+	detach(c);
</a><a href="#h0-14-7" id="h0-14-7" class="i">+	detachstack(c);
</a><a href="#h0-14-8" id="h0-14-8" class="i">+	c-&gt;mon = m;
</a><a href="#h0-14-9" id="h0-14-9" class="i">+	c-&gt;tags = m-&gt;tagset[m-&gt;seltags]; /* assign tags of target monitor */
</a><a href="#h0-14-10" id="h0-14-10" class="i">+	attach(c);
</a><a href="#h0-14-11" id="h0-14-11" class="i">+	attachstack(c);
</a><a href="#h0-14-12" id="h0-14-12" class="i">+	focus(NULL);
</a><a href="#h0-14-13" id="h0-14-13" class="i">+	arrange();
</a><a href="#h0-14-14" id="h0-14-14" class="i">+}
</a><a href="#h0-14-15" id="h0-14-15" class="i">+
</a><a href="#h0-14-16" id="h0-14-16" class="i">+void
</a> setclientstate(Client *c, long state) {
 	long data[] = {state, None};
 
<a href="#h0-15" id="h0-15" class="h">@@ -1497,14 +1550,7 @@ tagmon(const Arg *arg) {
</a> 		return;
 	for(i = 0, m = mons; m; m = m-&gt;next, i++)
 		if(i == arg-&gt;ui) {
<a href="#h0-15-3" id="h0-15-3" class="d">-			detach(c);
</a><a href="#h0-15-4" id="h0-15-4" class="d">-			detachstack(c);
</a><a href="#h0-15-5" id="h0-15-5" class="d">-			c-&gt;mon = m;
</a><a href="#h0-15-6" id="h0-15-6" class="d">-			c-&gt;tags = m-&gt;tagset[m-&gt;seltags]; /* assign tags of target monitor */
</a><a href="#h0-15-7" id="h0-15-7" class="d">-			attach(c);
</a><a href="#h0-15-8" id="h0-15-8" class="d">-			attachstack(c);
</a><a href="#h0-15-9" id="h0-15-9" class="d">-			focus(NULL);
</a><a href="#h0-15-10" id="h0-15-10" class="d">-			arrange();
</a><a href="#h0-15-11" id="h0-15-11" class="i">+			sendmon(c, m);
</a> 			break;
 		}
 }
<a href="#h0-16" id="h0-16" class="h">@@ -1676,11 +1722,9 @@ updatebarpos(Monitor *m) {
</a> 
 void
 updategeom(void) {
<a href="#h0-16-3" id="h0-16-3" class="d">-	int i, di, n = 1, x, y;
</a><a href="#h0-16-4" id="h0-16-4" class="d">-	unsigned int dui;
</a><a href="#h0-16-5" id="h0-16-5" class="i">+	int i, n = 1;
</a> 	Client *c;
 	Monitor *newmons = NULL, *m, *tm;
<a href="#h0-16-8" id="h0-16-8" class="d">-	Window dummy;
</a> 
 #ifdef XINULATOR
 	n = 2;
<a href="#h0-17" id="h0-17" class="h">@@ -1763,17 +1807,9 @@ updategeom(void) {
</a> 		}
 
 	/* select focused monitor */
<a href="#h0-17-3" id="h0-17-3" class="d">-	selmon = newmons;
</a><a href="#h0-17-4" id="h0-17-4" class="d">-	if(XQueryPointer(dpy, root, &amp;dummy, &amp;dummy, &amp;x, &amp;y, &amp;di, &amp;di, &amp;dui)) 
</a><a href="#h0-17-5" id="h0-17-5" class="d">-		for(m = newmons; m; m = m-&gt;next)
</a><a href="#h0-17-6" id="h0-17-6" class="d">-			if(INRECT(x, y, m-&gt;wx, m-&gt;wy, m-&gt;ww, m-&gt;wh)) {
</a><a href="#h0-17-7" id="h0-17-7" class="d">-				selmon = m;
</a><a href="#h0-17-8" id="h0-17-8" class="d">-				break;
</a><a href="#h0-17-9" id="h0-17-9" class="d">-			}
</a><a href="#h0-17-10" id="h0-17-10" class="d">-
</a><a href="#h0-17-11" id="h0-17-11" class="d">-	/* final assignment of new monitors */
</a> 	cleanupmons();
 	mons = newmons;
<a href="#h0-17-14" id="h0-17-14" class="i">+	selmon = getmonitor(root);
</a> }
 
 void
<a href="#h0-18" id="h0-18" class="h">@@ -1848,7 +1884,7 @@ updatetitle(Client *c) {
</a> }
 
 void
<a href="#h0-18-3" id="h0-18-3" class="d">-updatestatus() {
</a><a href="#h0-18-4" id="h0-18-4" class="i">+updatestatus(void) {
</a> 	if(!gettextprop(root, XA_WM_NAME, stext, sizeof(stext)))
 		strcpy(stext, &quot;dwm-&quot;VERSION);
 	drawbar(selmon);
</pre>
</div>
</body>
</html>
