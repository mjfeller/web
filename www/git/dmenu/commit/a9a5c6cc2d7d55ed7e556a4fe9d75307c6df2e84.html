<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>add embedding support with -w option - dmenu - dynamic menu
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="dmenu Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>dmenu</h1><span class="desc">dynamic menu
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/a9a5c6cc2d7d55ed7e556a4fe9d75307c6df2e84.html">a9a5c6cc2d7d55ed7e556a4fe9d75307c6df2e84</a>
<b>parent</b> <a href="../commit/a97f550aa7b81d2add1d2a99e594c038da01fc19.html">a97f550aa7b81d2add1d2a99e594c038da01fc19</a>
<b>Author:</b> Quentin Rameau &lt;<a href="mailto:quinq@fifth.space">quinq@fifth.space</a>&gt;
<b>Date:</b>   Sat,  8 Oct 2016 14:08:28 +0200

add embedding support with -w option

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">dmenu.1</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">dmenu.c</a></td><td> | </td><td class="num">65</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------</span></td></tr>
</table></pre><pre>2 files changed, 58 insertions(+), 12 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/dmenu.1.html">dmenu.1</a> b/<a href="../file/dmenu.1.html">dmenu.1</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -20,6 +20,8 @@ dmenu \- dynamic menu
</a> .IR color ]
 .RB [ \-sf
 .IR color ]
<a href="#h0-0-3" id="h0-0-3" class="i">+.RB [ \-w
</a><a href="#h0-0-4" id="h0-0-4" class="i">+.IR windowid ]
</a> .P
 .BR dmenu_run &quot; ...&quot;
 .SH DESCRIPTION
<a href="#h0-1" id="h0-1" class="h">@@ -75,6 +77,9 @@ defines the selected foreground color.
</a> .TP
 .B \-v
 prints version information to stdout, then exits.
<a href="#h0-1-3" id="h0-1-3" class="i">+.TP
</a><a href="#h0-1-4" id="h0-1-4" class="i">+.BI \-w &quot; windowid&quot;
</a><a href="#h0-1-5" id="h0-1-5" class="i">+embed into windowid.
</a> .SH USAGE
 dmenu is completely controlled by the keyboard.  Items are selected using the
 arrow keys, page up, page down, home, and end.
<b>diff --git a/<a id="h1" href="../file/dmenu.c.html">dmenu.c</a> b/<a href="../file/dmenu.c.html">dmenu.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -34,8 +34,8 @@ struct item {
</a> };
 
 static char text[BUFSIZ] = &quot;&quot;;
<a href="#h1-0-3" id="h1-0-3" class="i">+static char *embed;
</a> static int bh, mw, mh;
<a href="#h1-0-5" id="h1-0-5" class="d">-static int sw, sh; /* X display screen geometry width, height */
</a> static int inputw = 0, promptw;
 static int lrpad; /* sum of left and right padding */
 static size_t cursor;
<a href="#h1-1" id="h1-1" class="h">@@ -46,7 +46,7 @@ static int mon = -1, screen;
</a> 
 static Atom clip, utf8;
 static Display *dpy;
<a href="#h1-1-3" id="h1-1-3" class="d">-static Window root, win;
</a><a href="#h1-1-4" id="h1-1-4" class="i">+static Window root, parentwin, win;
</a> static XIC xic;
 
 static Drw *drw;
<a href="#h1-2" id="h1-2" class="h">@@ -175,11 +175,30 @@ drawmenu(void)
</a> }
 
 static void
<a href="#h1-2-3" id="h1-2-3" class="i">+grabfocus(void)
</a><a href="#h1-2-4" id="h1-2-4" class="i">+{
</a><a href="#h1-2-5" id="h1-2-5" class="i">+	struct timespec ts = { .tv_sec = 0, .tv_nsec = 10000000  };
</a><a href="#h1-2-6" id="h1-2-6" class="i">+	Window focuswin;
</a><a href="#h1-2-7" id="h1-2-7" class="i">+	int i, revertwin;
</a><a href="#h1-2-8" id="h1-2-8" class="i">+
</a><a href="#h1-2-9" id="h1-2-9" class="i">+	for (i = 0; i &lt; 100; ++i) {
</a><a href="#h1-2-10" id="h1-2-10" class="i">+		XGetInputFocus(dpy, &amp;focuswin, &amp;revertwin);
</a><a href="#h1-2-11" id="h1-2-11" class="i">+		if (focuswin == win)
</a><a href="#h1-2-12" id="h1-2-12" class="i">+			return;
</a><a href="#h1-2-13" id="h1-2-13" class="i">+		XSetInputFocus(dpy, win, RevertToParent, CurrentTime);
</a><a href="#h1-2-14" id="h1-2-14" class="i">+		nanosleep(&amp;ts, NULL);
</a><a href="#h1-2-15" id="h1-2-15" class="i">+	}
</a><a href="#h1-2-16" id="h1-2-16" class="i">+	die(&quot;cannot grab focus&quot;);
</a><a href="#h1-2-17" id="h1-2-17" class="i">+}
</a><a href="#h1-2-18" id="h1-2-18" class="i">+
</a><a href="#h1-2-19" id="h1-2-19" class="i">+static void
</a> grabkeyboard(void)
 {
 	struct timespec ts = { .tv_sec = 0, .tv_nsec = 1000000  };
 	int i;
 
<a href="#h1-2-25" id="h1-2-25" class="i">+	if (embed)
</a><a href="#h1-2-26" id="h1-2-26" class="i">+		return;
</a> 	/* try to grab keyboard, we may have to wait for another process to ungrab */
 	for (i = 0; i &lt; 1000; i++) {
 		if (XGrabKeyboard(dpy, DefaultRootWindow(dpy), True, GrabModeAsync,
<a href="#h1-3" id="h1-3" class="h">@@ -497,6 +516,11 @@ run(void)
</a> 			if (ev.xexpose.count == 0)
 				drw_map(drw, win, 0, 0, mw, mh);
 			break;
<a href="#h1-3-3" id="h1-3-3" class="i">+		case FocusIn:
</a><a href="#h1-3-4" id="h1-3-4" class="i">+			/* regrab focus from parent window */
</a><a href="#h1-3-5" id="h1-3-5" class="i">+			if (ev.xfocus.window != win)
</a><a href="#h1-3-6" id="h1-3-6" class="i">+				grabfocus();
</a><a href="#h1-3-7" id="h1-3-7" class="i">+			break;
</a> 		case KeyPress:
 			keypress(&amp;ev.xkey);
 			break;
<a href="#h1-4" id="h1-4" class="h">@@ -539,7 +563,7 @@ setup(void)
</a> 	lines = MAX(lines, 0);
 	mh = (lines + 1) * bh;
 #ifdef XINERAMA
<a href="#h1-4-3" id="h1-4-3" class="d">-	if ((info = XineramaQueryScreens(dpy, &amp;n))) {
</a><a href="#h1-4-4" id="h1-4-4" class="i">+	if (parentwin == root &amp;&amp; (info = XineramaQueryScreens(dpy, &amp;n))) {
</a> 		XGetInputFocus(dpy, &amp;w, &amp;di);
 		if (mon &gt;= 0 &amp;&amp; mon &lt; n)
 			i = mon;
<a href="#h1-5" id="h1-5" class="h">@@ -570,9 +594,12 @@ setup(void)
</a> 	} else
 #endif
 	{
<a href="#h1-5-3" id="h1-5-3" class="i">+		if (!XGetWindowAttributes(dpy, parentwin, &amp;wa))
</a><a href="#h1-5-4" id="h1-5-4" class="i">+			die(&quot;could not get embedding window attributes: 0x%lx&quot;,
</a><a href="#h1-5-5" id="h1-5-5" class="i">+			    parentwin);
</a> 		x = 0;
<a href="#h1-5-7" id="h1-5-7" class="d">-		y = topbar ? 0 : sh - mh;
</a><a href="#h1-5-8" id="h1-5-8" class="d">-		mw = sw;
</a><a href="#h1-5-9" id="h1-5-9" class="i">+		y = topbar ? 0 : wa.height - mh;
</a><a href="#h1-5-10" id="h1-5-10" class="i">+		mw = wa.width;
</a> 	}
 	promptw = (prompt &amp;&amp; *prompt) ? TEXTW(prompt) - lrpad / 4 : 0;
 	inputw = MIN(inputw, mw/3);
<a href="#h1-6" id="h1-6" class="h">@@ -582,9 +609,8 @@ setup(void)
</a> 	swa.override_redirect = True;
 	swa.background_pixel = scheme[SchemeNorm][ColBg].pixel;
 	swa.event_mask = ExposureMask | KeyPressMask | VisibilityChangeMask;
<a href="#h1-6-3" id="h1-6-3" class="d">-	win = XCreateWindow(dpy, root, x, y, mw, mh, 0,
</a><a href="#h1-6-4" id="h1-6-4" class="d">-	                    DefaultDepth(dpy, screen), CopyFromParent,
</a><a href="#h1-6-5" id="h1-6-5" class="d">-	                    DefaultVisual(dpy, screen),
</a><a href="#h1-6-6" id="h1-6-6" class="i">+	win = XCreateWindow(dpy, parentwin, x, y, mw, mh, 0,
</a><a href="#h1-6-7" id="h1-6-7" class="i">+	                    CopyFromParent, CopyFromParent, CopyFromParent,
</a> 	                    CWOverrideRedirect | CWBackPixel | CWEventMask, &amp;swa);
 
 	/* open input methods */
<a href="#h1-7" id="h1-7" class="h">@@ -593,6 +619,15 @@ setup(void)
</a> 	                XNClientWindow, win, XNFocusWindow, win, NULL);
 
 	XMapRaised(dpy, win);
<a href="#h1-7-3" id="h1-7-3" class="i">+	if (embed) {
</a><a href="#h1-7-4" id="h1-7-4" class="i">+		XSelectInput(dpy, parentwin, FocusChangeMask);
</a><a href="#h1-7-5" id="h1-7-5" class="i">+		if (XQueryTree(dpy, parentwin, &amp;dw, &amp;w, &amp;dws, &amp;du) &amp;&amp; dws) {
</a><a href="#h1-7-6" id="h1-7-6" class="i">+			for (i = 0; i &lt; du &amp;&amp; dws[i] != win; ++i)
</a><a href="#h1-7-7" id="h1-7-7" class="i">+				XSelectInput(dpy, dws[i], FocusChangeMask);
</a><a href="#h1-7-8" id="h1-7-8" class="i">+			XFree(dws);
</a><a href="#h1-7-9" id="h1-7-9" class="i">+		}
</a><a href="#h1-7-10" id="h1-7-10" class="i">+		grabfocus();
</a><a href="#h1-7-11" id="h1-7-11" class="i">+	}
</a> 	drw_resize(drw, mw, mh);
 	drawmenu();
 }
<a href="#h1-8" id="h1-8" class="h">@@ -601,13 +636,14 @@ static void
</a> usage(void)
 {
 	fputs(&quot;usage: dmenu [-bfiv] [-l lines] [-p prompt] [-fn font] [-m monitor]\n&quot;
<a href="#h1-8-3" id="h1-8-3" class="d">-	      &quot;             [-nb color] [-nf color] [-sb color] [-sf color]\n&quot;, stderr);
</a><a href="#h1-8-4" id="h1-8-4" class="i">+	      &quot;             [-nb color] [-nf color] [-sb color] [-sf color] [-w windowid]\n&quot;, stderr);
</a> 	exit(1);
 }
 
 int
 main(int argc, char *argv[])
 {
<a href="#h1-8-11" id="h1-8-11" class="i">+	XWindowAttributes wa;
</a> 	int i, fast = 0;
 
 	for (i = 1; i &lt; argc; i++)
<a href="#h1-9" id="h1-9" class="h">@@ -641,6 +677,8 @@ main(int argc, char *argv[])
</a> 			colors[SchemeSel][ColBg] = argv[++i];
 		else if (!strcmp(argv[i], &quot;-sf&quot;))  /* selected foreground color */
 			colors[SchemeSel][ColFg] = argv[++i];
<a href="#h1-9-3" id="h1-9-3" class="i">+		else if (!strcmp(argv[i], &quot;-w&quot;))   /* embedding window id */
</a><a href="#h1-9-4" id="h1-9-4" class="i">+			embed = argv[++i];
</a> 		else
 			usage();
 
<a href="#h1-10" id="h1-10" class="h">@@ -650,9 +688,12 @@ main(int argc, char *argv[])
</a> 		die(&quot;cannot open display&quot;);
 	screen = DefaultScreen(dpy);
 	root = RootWindow(dpy, screen);
<a href="#h1-10-3" id="h1-10-3" class="d">-	sw = DisplayWidth(dpy, screen);
</a><a href="#h1-10-4" id="h1-10-4" class="d">-	sh = DisplayHeight(dpy, screen);
</a><a href="#h1-10-5" id="h1-10-5" class="d">-	drw = drw_create(dpy, screen, root, sw, sh);
</a><a href="#h1-10-6" id="h1-10-6" class="i">+	if (!embed || !(parentwin = strtol(embed, NULL, 0)))
</a><a href="#h1-10-7" id="h1-10-7" class="i">+		parentwin = root;
</a><a href="#h1-10-8" id="h1-10-8" class="i">+	if (!XGetWindowAttributes(dpy, parentwin, &amp;wa))
</a><a href="#h1-10-9" id="h1-10-9" class="i">+		die(&quot;could not get embedding window attributes: 0x%lx&quot;,
</a><a href="#h1-10-10" id="h1-10-10" class="i">+		    parentwin);
</a><a href="#h1-10-11" id="h1-10-11" class="i">+	drw = drw_create(dpy, screen, root, wa.width, wa.height);
</a> 	if (!drw_fontset_create(drw, fonts, LENGTH(fonts)))
 		die(&quot;no fonts could be loaded.&quot;);
 	lrpad = drw-&gt;fonts-&gt;h;
</pre>
</div>
</body>
</html>
