<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>add lots of comments - dmenu - dynamic menu
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="dmenu Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>dmenu</h1><span class="desc">dynamic menu
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/7b1493a63162875ba591883e480bd36a063cf222.html">7b1493a63162875ba591883e480bd36a063cf222</a>
<b>parent</b> <a href="../commit/dd29c5d48084ae0f61a43bfbd5119fb480d83fb7.html">dd29c5d48084ae0f61a43bfbd5119fb480d83fb7</a>
<b>Author:</b> Connor Lane Smith &lt;<a href="mailto:cls@lubutu.com">cls@lubutu.com</a>&gt;
<b>Date:</b>   Wed, 26 Oct 2011 13:20:14 +0100

add lots of comments
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">dmenu.c</a></td><td> | </td><td class="num">51</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d">------------------</span></td></tr>
</table></pre><pre>1 file changed, 33 insertions(+), 18 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/dmenu.c.html">dmenu.c</a> b/<a href="../file/dmenu.c.html">dmenu.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -70,35 +70,35 @@ main(int argc, char *argv[]) {
</a> 	int i;
 
 	for(i = 1; i &lt; argc; i++)
<a href="#h0-0-3" id="h0-0-3" class="d">-		/* single flags */
</a><a href="#h0-0-4" id="h0-0-4" class="d">-		if(!strcmp(argv[i], &quot;-v&quot;)) {
</a><a href="#h0-0-5" id="h0-0-5" class="i">+		/* these options take no arguments */
</a><a href="#h0-0-6" id="h0-0-6" class="i">+		if(!strcmp(argv[i], &quot;-v&quot;)) {      /* prints version information */
</a> 			puts(&quot;dmenu-&quot;VERSION&quot;, Â© 2006-2011 dmenu engineers, see LICENSE for details&quot;);
 			exit(EXIT_SUCCESS);
 		}
<a href="#h0-0-10" id="h0-0-10" class="d">-		else if(!strcmp(argv[i], &quot;-b&quot;))
</a><a href="#h0-0-11" id="h0-0-11" class="i">+		else if(!strcmp(argv[i], &quot;-b&quot;))   /* appears at the bottom of the screen */
</a> 			topbar = False;
<a href="#h0-0-13" id="h0-0-13" class="d">-		else if(!strcmp(argv[i], &quot;-f&quot;))
</a><a href="#h0-0-14" id="h0-0-14" class="i">+		else if(!strcmp(argv[i], &quot;-f&quot;))   /* grabs keyboard before reading stdin */
</a> 			fast = True;
<a href="#h0-0-16" id="h0-0-16" class="d">-		else if(!strcmp(argv[i], &quot;-i&quot;)) {
</a><a href="#h0-0-17" id="h0-0-17" class="i">+		else if(!strcmp(argv[i], &quot;-i&quot;)) { /* case-insensitive item matching */
</a> 			fstrncmp = strncasecmp;
 			fstrstr = cistrstr;
 		}
 		else if(i+1 == argc)
 			usage();
<a href="#h0-0-23" id="h0-0-23" class="d">-		/* double flags */
</a><a href="#h0-0-24" id="h0-0-24" class="d">-		else if(!strcmp(argv[i], &quot;-l&quot;))
</a><a href="#h0-0-25" id="h0-0-25" class="i">+		/* these options take one argument */
</a><a href="#h0-0-26" id="h0-0-26" class="i">+		else if(!strcmp(argv[i], &quot;-l&quot;))   /* number of lines in vertical list */
</a> 			lines = atoi(argv[++i]);
<a href="#h0-0-28" id="h0-0-28" class="d">-		else if(!strcmp(argv[i], &quot;-p&quot;))
</a><a href="#h0-0-29" id="h0-0-29" class="i">+		else if(!strcmp(argv[i], &quot;-p&quot;))   /* adds prompt to left of input field */
</a> 			prompt = argv[++i];
<a href="#h0-0-31" id="h0-0-31" class="d">-		else if(!strcmp(argv[i], &quot;-fn&quot;))
</a><a href="#h0-0-32" id="h0-0-32" class="i">+		else if(!strcmp(argv[i], &quot;-fn&quot;))  /* font or font set */
</a> 			font = argv[++i];
<a href="#h0-0-34" id="h0-0-34" class="d">-		else if(!strcmp(argv[i], &quot;-nb&quot;))
</a><a href="#h0-0-35" id="h0-0-35" class="i">+		else if(!strcmp(argv[i], &quot;-nb&quot;))  /* normal background color */
</a> 			normbgcolor = argv[++i];
<a href="#h0-0-37" id="h0-0-37" class="d">-		else if(!strcmp(argv[i], &quot;-nf&quot;))
</a><a href="#h0-0-38" id="h0-0-38" class="i">+		else if(!strcmp(argv[i], &quot;-nf&quot;))  /* normal foreground color */
</a> 			normfgcolor = argv[++i];
<a href="#h0-0-40" id="h0-0-40" class="d">-		else if(!strcmp(argv[i], &quot;-sb&quot;))
</a><a href="#h0-0-41" id="h0-0-41" class="i">+		else if(!strcmp(argv[i], &quot;-sb&quot;))  /* selected background color */
</a> 			selbgcolor = argv[++i];
<a href="#h0-0-43" id="h0-0-43" class="d">-		else if(!strcmp(argv[i], &quot;-sf&quot;))
</a><a href="#h0-0-44" id="h0-0-44" class="i">+		else if(!strcmp(argv[i], &quot;-sf&quot;))  /* selected foreground color */
</a> 			selfgcolor = argv[++i];
 		else
 			usage();
<a href="#h0-1" id="h0-1" class="h">@@ -140,7 +140,7 @@ calcoffsets(void) {
</a> 		n = lines * bh;
 	else
 		n = mw - (promptw + inputw + textw(dc, &quot;&lt;&quot;) + textw(dc, &quot;&gt;&quot;));
<a href="#h0-1-3" id="h0-1-3" class="d">-
</a><a href="#h0-1-4" id="h0-1-4" class="i">+	/* calculate which items will begin the next page and previous page */
</a> 	for(i = 0, next = curr; next; next = next-&gt;right)
 		if((i += (lines &gt; 0) ? bh : MIN(textw(dc, next-&gt;text), n)) &gt; n)
 			break;
<a href="#h0-2" id="h0-2" class="h">@@ -174,12 +174,14 @@ drawmenu(void) {
</a> 		drawtext(dc, prompt, selcol);
 		dc-&gt;x = dc-&gt;w;
 	}
<a href="#h0-2-3" id="h0-2-3" class="i">+	/* draw input field */
</a> 	dc-&gt;w = (lines &gt; 0 || !matches) ? mw - dc-&gt;x : inputw;
 	drawtext(dc, text, normcol);
 	if((curpos = textnw(dc, text, cursor) + dc-&gt;h/2 - 2) &lt; dc-&gt;w)
 		drawrect(dc, curpos, 2, 1, dc-&gt;h - 4, True, FG(dc, normcol));
 
 	if(lines &gt; 0) {
<a href="#h0-2-10" id="h0-2-10" class="i">+		/* draw vertical list */
</a> 		dc-&gt;w = mw - dc-&gt;x;
 		for(item = curr; item != next; item = item-&gt;right) {
 			dc-&gt;y += dc-&gt;h;
<a href="#h0-3" id="h0-3" class="h">@@ -187,6 +189,7 @@ drawmenu(void) {
</a> 		}
 	}
 	else if(matches) {
<a href="#h0-3-3" id="h0-3-3" class="i">+		/* draw horizontal list */
</a> 		dc-&gt;x += inputw;
 		dc-&gt;w = textw(dc, &quot;&lt;&quot;);
 		if(curr-&gt;left)
<a href="#h0-4" id="h0-4" class="h">@@ -208,6 +211,7 @@ void
</a> grabkeyboard(void) {
 	int i;
 
<a href="#h0-4-3" id="h0-4-3" class="i">+	/* try to grab keyboard, we may have to wait for another process to ungrab */
</a> 	for(i = 0; i &lt; 1000; i++) {
 		if(XGrabKeyboard(dc-&gt;dpy, DefaultRootWindow(dc-&gt;dpy), True,
 		                 GrabModeAsync, GrabModeAsync, CurrentTime) == GrabSuccess)
<a href="#h0-5" id="h0-5" class="h">@@ -221,6 +225,7 @@ void
</a> insert(const char *str, ssize_t n) {
 	if(strlen(text) + n &gt; sizeof text - 1)
 		return;
<a href="#h0-5-3" id="h0-5-3" class="i">+	/* move existing text out of the way, insert new text, and update cursor */
</a> 	memmove(&amp;text[cursor + n], &amp;text[cursor], sizeof text - cursor - MAX(n, 0));
 	if(n &gt; 0)
 		memcpy(&amp;text[cursor], str, n);
<a href="#h0-6" id="h0-6" class="h">@@ -297,6 +302,7 @@ keypress(XKeyEvent *ev) {
</a> 			break;
 		}
 		if(next) {
<a href="#h0-6-3" id="h0-6-3" class="i">+			/* jump to end of list and position items in reverse */
</a> 			curr = matchend;
 			calcoffsets();
 			curr = prev;
<a href="#h0-7" id="h0-7" class="h">@@ -378,6 +384,7 @@ match(void) {
</a> 	Item *item, *lprefix, *lsubstr, *prefixend, *substrend;
 
 	strcpy(buf, text);
<a href="#h0-7-3" id="h0-7-3" class="i">+	/* separate input text into tokens to be matched individually */
</a> 	for(s = strtok(buf, &quot; &quot;); s; tokv[tokc-1] = s, s = strtok(NULL, &quot; &quot;))
 		if(++tokc &gt; tokn &amp;&amp; !(tokv = realloc(tokv, ++tokn * sizeof *tokv)))
 			eprintf(&quot;cannot realloc %u bytes\n&quot;, tokn * sizeof *tokv);
<a href="#h0-8" id="h0-8" class="h">@@ -388,8 +395,9 @@ match(void) {
</a> 		for(i = 0; i &lt; tokc; i++)
 			if(!fstrstr(item-&gt;text, tokv[i]))
 				break;
<a href="#h0-8-3" id="h0-8-3" class="d">-		if(i != tokc)
</a><a href="#h0-8-4" id="h0-8-4" class="i">+		if(i != tokc) /* not all tokens match */
</a> 			continue;
<a href="#h0-8-6" id="h0-8-6" class="i">+		/* exact matches go first, then prefixes, then substrings */
</a> 		if(!tokc || !fstrncmp(tokv[0], item-&gt;text, len+1))
 			appenditem(item, &amp;matches, &amp;matchend);
 		else if(!fstrncmp(tokv[0], item-&gt;text, len))
<a href="#h0-9" id="h0-9" class="h">@@ -423,6 +431,7 @@ size_t
</a> nextrune(int inc) {
 	ssize_t n;
 
<a href="#h0-9-3" id="h0-9-3" class="i">+	/* return location of next utf8 rune in the given direction (+1 or -1) */
</a> 	for(n = cursor + inc; n + inc &gt;= 0 &amp;&amp; (text[n] &amp; 0xc0) == 0x80; n += inc);
 	return n;
 }
<a href="#h0-10" id="h0-10" class="h">@@ -434,6 +443,7 @@ paste(void) {
</a> 	unsigned long dl;
 	Atom da;
 
<a href="#h0-10-3" id="h0-10-3" class="i">+	/* we have been given the current selection, now insert it into input */
</a> 	XGetWindowProperty(dc-&gt;dpy, win, utf8, 0, (sizeof text / 4) + 1, False,
 	                   utf8, &amp;da, &amp;di, &amp;dl, &amp;dl, (unsigned char **)&amp;p);
 	insert(p, (q = strchr(p, &#39;\n&#39;)) ? q-p : (ssize_t)strlen(p));
<a href="#h0-11" id="h0-11" class="h">@@ -446,6 +456,7 @@ readstdin(void) {
</a> 	char buf[sizeof text], *p, *maxstr = NULL;
 	size_t i, max = 0, size = 0;
 
<a href="#h0-11-3" id="h0-11-3" class="i">+	/* read each line from stdin and add it to the item list */
</a> 	for(i = 0; fgets(buf, sizeof buf, stdin); i++) {
 		if(i+1 &gt;= size / sizeof *items)
 			if(!(items = realloc(items, (size += BUFSIZ))))
<a href="#h0-12" id="h0-12" class="h">@@ -508,7 +519,7 @@ setup(void) {
</a> 
 	utf8 = XInternAtom(dc-&gt;dpy, &quot;UTF8_STRING&quot;, False);
 
<a href="#h0-12-3" id="h0-12-3" class="d">-	/* menu geometry */
</a><a href="#h0-12-4" id="h0-12-4" class="i">+	/* calculate menu geometry */
</a> 	bh = dc-&gt;font.height + 2;
 	lines = MAX(lines, 0);
 	mh = (lines + 1) * bh;
<a href="#h0-13" id="h0-13" class="h">@@ -521,10 +532,12 @@ setup(void) {
</a> 
 		XGetInputFocus(dc-&gt;dpy, &amp;w, &amp;di);
 		if(w != root &amp;&amp; w != PointerRoot &amp;&amp; w != None) {
<a href="#h0-13-3" id="h0-13-3" class="i">+			/* find top-level window containing current input focus */
</a> 			do {
 				if(XQueryTree(dc-&gt;dpy, (pw = w), &amp;dw, &amp;w, &amp;dws, &amp;du) &amp;&amp; dws)
 					XFree(dws);
 			} while(w != root &amp;&amp; w != pw);
<a href="#h0-13-8" id="h0-13-8" class="i">+			/* find xinerama screen with which the window intersects most */
</a> 			if(XGetWindowAttributes(dc-&gt;dpy, pw, &amp;wa))
 				for(j = 0; j &lt; n; j++)
 					if((a = INTERSECT(wa.x, wa.y, wa.width, wa.height, info[j])) &gt; area) {
<a href="#h0-14" id="h0-14" class="h">@@ -532,10 +545,12 @@ setup(void) {
</a> 						i = j;
 					}
 		}
<a href="#h0-14-3" id="h0-14-3" class="i">+		/* no focused window is on screen, so use pointer location instead */
</a> 		if(!area &amp;&amp; XQueryPointer(dc-&gt;dpy, root, &amp;dw, &amp;dw, &amp;x, &amp;y, &amp;di, &amp;di, &amp;du))
 			for(i = 0; i &lt; n; i++)
 				if(INTERSECT(x, y, 1, 1, info[i]))
 					break;
<a href="#h0-14-8" id="h0-14-8" class="i">+
</a> 		x = info[i].x_org;
 		y = info[i].y_org + (topbar ? 0 : info[i].height - mh);
 		mw = info[i].width;
<a href="#h0-15" id="h0-15" class="h">@@ -552,7 +567,7 @@ setup(void) {
</a> 	inputw = MIN(inputw, mw/3);
 	match();
 
<a href="#h0-15-3" id="h0-15-3" class="d">-	/* menu window */
</a><a href="#h0-15-4" id="h0-15-4" class="i">+	/* create menu window */
</a> 	swa.override_redirect = True;
 	swa.background_pixmap = ParentRelative;
 	swa.event_mask = ExposureMask | KeyPressMask | VisibilityChangeMask;
<a href="#h0-16" id="h0-16" class="h">@@ -561,7 +576,7 @@ setup(void) {
</a> 	                    DefaultVisual(dc-&gt;dpy, screen),
 	                    CWOverrideRedirect | CWBackPixmap | CWEventMask, &amp;swa);
 
<a href="#h0-16-3" id="h0-16-3" class="d">-	/* input methods */
</a><a href="#h0-16-4" id="h0-16-4" class="i">+	/* open input methods */
</a> 	xim = XOpenIM(dc-&gt;dpy, NULL, NULL, NULL);
 	xic = XCreateIC(xim, XNInputStyle, XIMPreeditNothing | XIMStatusNothing,
 	                XNClientWindow, win, XNFocusWindow, win, NULL);
</pre>
</div>
</body>
</html>
