<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>micromizing dmenu step 1 - dmenu - dynamic menu
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="dmenu Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>dmenu</h1><span class="desc">dynamic menu
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/06ae8944344cd6f7d0aa007b7b036e77cb87fdf1.html">06ae8944344cd6f7d0aa007b7b036e77cb87fdf1</a>
<b>parent</b> <a href="../commit/b97783b07feae30f9df12c1a720d17a2dc877018.html">b97783b07feae30f9df12c1a720d17a2dc877018</a>
<b>Author:</b> Anselm R. Garbe &lt;<a href="mailto:garbeam@gmail.com">garbeam@gmail.com</a>&gt;
<b>Date:</b>   Sun, 16 Sep 2007 20:14:09 +0200

micromizing dmenu step 1
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">Makefile</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="A">A</td><td><a href="#h1">config.h</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h2">dmenu.c</a></td><td> | </td><td class="num">701</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h3">dmenu.h</a></td><td> | </td><td class="num">41</td><td><span class="i"></span><span class="d">-----------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h4">draw.c</a></td><td> | </td><td class="num">61</td><td><span class="i"></span><span class="d">-------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h5">main.c</a></td><td> | </td><td class="num">578</td><td><span class="i"></span><span class="d">------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h6">util.c</a></td><td> | </td><td class="num">34</td><td><span class="i"></span><span class="d">----------------------------------</span></td></tr>
</table></pre><pre>7 files changed, 714 insertions(+), 717 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/Makefile.html">Makefile</a> b/<a href="../file/Makefile.html">Makefile</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -3,7 +3,7 @@
</a> 
 include config.mk
 
<a href="#h0-0-3" id="h0-0-3" class="d">-SRC = draw.c main.c util.c
</a><a href="#h0-0-4" id="h0-0-4" class="i">+SRC = dmenu.c
</a> OBJ = ${SRC:.c=.o}
 
 all: options dmenu
<a href="#h0-1" id="h0-1" class="h">@@ -18,7 +18,7 @@ options:
</a> 	@echo CC $&lt;
 	@${CC} -c ${CFLAGS} $&lt;
 
<a href="#h0-1-3" id="h0-1-3" class="d">-${OBJ}: dmenu.h config.mk
</a><a href="#h0-1-4" id="h0-1-4" class="i">+${OBJ}: config.h config.mk
</a> 
 dmenu: ${OBJ}
 	@echo CC -o $@
<a href="#h0-2" id="h0-2" class="h">@@ -31,7 +31,7 @@ clean:
</a> dist: clean
 	@echo creating dist tarball
 	@mkdir -p dmenu-${VERSION}
<a href="#h0-2-3" id="h0-2-3" class="d">-	@cp -R LICENSE Makefile README config.mk dmenu.1 dmenu.h dmenu_path ${SRC} dmenu-${VERSION}
</a><a href="#h0-2-4" id="h0-2-4" class="i">+	@cp -R LICENSE Makefile README config.mk dmenu.1 config.h dmenu_path ${SRC} dmenu-${VERSION}
</a> 	@tar -cf dmenu-${VERSION}.tar dmenu-${VERSION}
 	@gzip dmenu-${VERSION}.tar
 	@rm -rf dmenu-${VERSION}
<b>diff --git a/<a id="h1" href="../file/config.h.html">config.h</a> b/<a href="../file/config.h.html">config.h</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -0,0 +1,10 @@
</a><a href="#h1-0-0" id="h1-0-0" class="i">+/* See LICENSE file for copyright and license details. */
</a><a href="#h1-0-1" id="h1-0-1" class="i">+
</a><a href="#h1-0-2" id="h1-0-2" class="i">+/* appearance */
</a><a href="#h1-0-3" id="h1-0-3" class="i">+#define FONT			&quot;-*-terminus-medium-r-*-*-12-*-*-*-*-*-iso10646-*&quot;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+#define NORMBGCOLOR		&quot;#000&quot;
</a><a href="#h1-0-5" id="h1-0-5" class="i">+#define NORMFGCOLOR		&quot;#ccc&quot;
</a><a href="#h1-0-6" id="h1-0-6" class="i">+#define SELBGCOLOR		&quot;#00f&quot;
</a><a href="#h1-0-7" id="h1-0-7" class="i">+#define SELFGCOLOR		&quot;#fff&quot;
</a><a href="#h1-0-8" id="h1-0-8" class="i">+/* next macro defines the space between menu items */
</a><a href="#h1-0-9" id="h1-0-9" class="i">+#define SPACE			30 /* px */
</a><b>diff --git a/<a id="h2" href="../file/dmenu.c.html">dmenu.c</a> b/<a href="../file/dmenu.c.html">dmenu.c</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -0,0 +1,701 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+/* See LICENSE file for copyright and license details. */
</a><a href="#h2-0-1" id="h2-0-1" class="i">+#include &lt;ctype.h&gt;
</a><a href="#h2-0-2" id="h2-0-2" class="i">+#include &lt;locale.h&gt;
</a><a href="#h2-0-3" id="h2-0-3" class="i">+#include &lt;stdarg.h&gt;
</a><a href="#h2-0-4" id="h2-0-4" class="i">+#include &lt;stdlib.h&gt;
</a><a href="#h2-0-5" id="h2-0-5" class="i">+#include &lt;stdio.h&gt;
</a><a href="#h2-0-6" id="h2-0-6" class="i">+#include &lt;string.h&gt;
</a><a href="#h2-0-7" id="h2-0-7" class="i">+#include &lt;unistd.h&gt;
</a><a href="#h2-0-8" id="h2-0-8" class="i">+#include &lt;X11/Xlib.h&gt;
</a><a href="#h2-0-9" id="h2-0-9" class="i">+#include &lt;X11/Xutil.h&gt;
</a><a href="#h2-0-10" id="h2-0-10" class="i">+#include &lt;X11/keysym.h&gt;
</a><a href="#h2-0-11" id="h2-0-11" class="i">+
</a><a href="#h2-0-12" id="h2-0-12" class="i">+/* macros */
</a><a href="#h2-0-13" id="h2-0-13" class="i">+#define CLEANMASK(mask) (mask &amp; ~(numlockmask | LockMask))
</a><a href="#h2-0-14" id="h2-0-14" class="i">+
</a><a href="#h2-0-15" id="h2-0-15" class="i">+/* enums */
</a><a href="#h2-0-16" id="h2-0-16" class="i">+enum { ColFG, ColBG, ColLast };
</a><a href="#h2-0-17" id="h2-0-17" class="i">+
</a><a href="#h2-0-18" id="h2-0-18" class="i">+/* typedefs */
</a><a href="#h2-0-19" id="h2-0-19" class="i">+typedef struct {
</a><a href="#h2-0-20" id="h2-0-20" class="i">+	int x, y, w, h;
</a><a href="#h2-0-21" id="h2-0-21" class="i">+	unsigned long norm[ColLast];
</a><a href="#h2-0-22" id="h2-0-22" class="i">+	unsigned long sel[ColLast];
</a><a href="#h2-0-23" id="h2-0-23" class="i">+	Drawable drawable;
</a><a href="#h2-0-24" id="h2-0-24" class="i">+	GC gc;
</a><a href="#h2-0-25" id="h2-0-25" class="i">+	struct {
</a><a href="#h2-0-26" id="h2-0-26" class="i">+		XFontStruct *xfont;
</a><a href="#h2-0-27" id="h2-0-27" class="i">+		XFontSet set;
</a><a href="#h2-0-28" id="h2-0-28" class="i">+		int ascent;
</a><a href="#h2-0-29" id="h2-0-29" class="i">+		int descent;
</a><a href="#h2-0-30" id="h2-0-30" class="i">+		int height;
</a><a href="#h2-0-31" id="h2-0-31" class="i">+	} font;
</a><a href="#h2-0-32" id="h2-0-32" class="i">+} DC; /* draw context */
</a><a href="#h2-0-33" id="h2-0-33" class="i">+
</a><a href="#h2-0-34" id="h2-0-34" class="i">+typedef struct Item Item;
</a><a href="#h2-0-35" id="h2-0-35" class="i">+struct Item {
</a><a href="#h2-0-36" id="h2-0-36" class="i">+	Item *next;		/* traverses all items */
</a><a href="#h2-0-37" id="h2-0-37" class="i">+	Item *left, *right;	/* traverses items matching current search pattern */
</a><a href="#h2-0-38" id="h2-0-38" class="i">+	char *text;
</a><a href="#h2-0-39" id="h2-0-39" class="i">+};
</a><a href="#h2-0-40" id="h2-0-40" class="i">+
</a><a href="#h2-0-41" id="h2-0-41" class="i">+/* forward declarations */
</a><a href="#h2-0-42" id="h2-0-42" class="i">+static void *emalloc(unsigned int size);
</a><a href="#h2-0-43" id="h2-0-43" class="i">+static void eprint(const char *errstr, ...);
</a><a href="#h2-0-44" id="h2-0-44" class="i">+static char *estrdup(const char *str);
</a><a href="#h2-0-45" id="h2-0-45" class="i">+static void drawtext(const char *text, unsigned long col[ColLast]);
</a><a href="#h2-0-46" id="h2-0-46" class="i">+static unsigned int textw(const char *text);
</a><a href="#h2-0-47" id="h2-0-47" class="i">+static unsigned int textnw(const char *text, unsigned int len);
</a><a href="#h2-0-48" id="h2-0-48" class="i">+static void calcoffsets(void);
</a><a href="#h2-0-49" id="h2-0-49" class="i">+static void drawmenu(void);
</a><a href="#h2-0-50" id="h2-0-50" class="i">+static Bool grabkeyboard(void);
</a><a href="#h2-0-51" id="h2-0-51" class="i">+static unsigned long getcolor(const char *colstr);
</a><a href="#h2-0-52" id="h2-0-52" class="i">+static void initfont(const char *fontstr);
</a><a href="#h2-0-53" id="h2-0-53" class="i">+static int strido(const char *text, const char *pattern);
</a><a href="#h2-0-54" id="h2-0-54" class="i">+static void match(char *pattern);
</a><a href="#h2-0-55" id="h2-0-55" class="i">+static void kpress(XKeyEvent * e);
</a><a href="#h2-0-56" id="h2-0-56" class="i">+static char *readstdin(void);
</a><a href="#h2-0-57" id="h2-0-57" class="i">+static void usage(void);
</a><a href="#h2-0-58" id="h2-0-58" class="i">+
</a><a href="#h2-0-59" id="h2-0-59" class="i">+
</a><a href="#h2-0-60" id="h2-0-60" class="i">+/* variables */
</a><a href="#h2-0-61" id="h2-0-61" class="i">+static int screen;
</a><a href="#h2-0-62" id="h2-0-62" class="i">+static Display *dpy;
</a><a href="#h2-0-63" id="h2-0-63" class="i">+static DC dc = {0};
</a><a href="#h2-0-64" id="h2-0-64" class="i">+static char text[4096];
</a><a href="#h2-0-65" id="h2-0-65" class="i">+static char *prompt = NULL;
</a><a href="#h2-0-66" id="h2-0-66" class="i">+static int mw, mh;
</a><a href="#h2-0-67" id="h2-0-67" class="i">+static int ret = 0;
</a><a href="#h2-0-68" id="h2-0-68" class="i">+static int nitem = 0;
</a><a href="#h2-0-69" id="h2-0-69" class="i">+static unsigned int cmdw = 0;
</a><a href="#h2-0-70" id="h2-0-70" class="i">+static unsigned int promptw = 0;
</a><a href="#h2-0-71" id="h2-0-71" class="i">+static unsigned int numlockmask = 0;
</a><a href="#h2-0-72" id="h2-0-72" class="i">+static Bool running = True;
</a><a href="#h2-0-73" id="h2-0-73" class="i">+static Item *allitems = NULL;	/* first of all items */
</a><a href="#h2-0-74" id="h2-0-74" class="i">+static Item *item = NULL;	/* first of pattern matching items */
</a><a href="#h2-0-75" id="h2-0-75" class="i">+static Item *sel = NULL;
</a><a href="#h2-0-76" id="h2-0-76" class="i">+static Item *next = NULL;
</a><a href="#h2-0-77" id="h2-0-77" class="i">+static Item *prev = NULL;
</a><a href="#h2-0-78" id="h2-0-78" class="i">+static Item *curr = NULL;
</a><a href="#h2-0-79" id="h2-0-79" class="i">+static Window root;
</a><a href="#h2-0-80" id="h2-0-80" class="i">+static Window win;
</a><a href="#h2-0-81" id="h2-0-81" class="i">+
</a><a href="#h2-0-82" id="h2-0-82" class="i">+#include &quot;config.h&quot;
</a><a href="#h2-0-83" id="h2-0-83" class="i">+
</a><a href="#h2-0-84" id="h2-0-84" class="i">+static void *
</a><a href="#h2-0-85" id="h2-0-85" class="i">+emalloc(unsigned int size) {
</a><a href="#h2-0-86" id="h2-0-86" class="i">+	void *res = malloc(size);
</a><a href="#h2-0-87" id="h2-0-87" class="i">+
</a><a href="#h2-0-88" id="h2-0-88" class="i">+	if(!res)
</a><a href="#h2-0-89" id="h2-0-89" class="i">+		eprint(&quot;fatal: could not malloc() %u bytes\n&quot;, size);
</a><a href="#h2-0-90" id="h2-0-90" class="i">+	return res;
</a><a href="#h2-0-91" id="h2-0-91" class="i">+}
</a><a href="#h2-0-92" id="h2-0-92" class="i">+
</a><a href="#h2-0-93" id="h2-0-93" class="i">+static void
</a><a href="#h2-0-94" id="h2-0-94" class="i">+eprint(const char *errstr, ...) {
</a><a href="#h2-0-95" id="h2-0-95" class="i">+	va_list ap;
</a><a href="#h2-0-96" id="h2-0-96" class="i">+
</a><a href="#h2-0-97" id="h2-0-97" class="i">+	va_start(ap, errstr);
</a><a href="#h2-0-98" id="h2-0-98" class="i">+	vfprintf(stderr, errstr, ap);
</a><a href="#h2-0-99" id="h2-0-99" class="i">+	va_end(ap);
</a><a href="#h2-0-100" id="h2-0-100" class="i">+	exit(EXIT_FAILURE);
</a><a href="#h2-0-101" id="h2-0-101" class="i">+}
</a><a href="#h2-0-102" id="h2-0-102" class="i">+
</a><a href="#h2-0-103" id="h2-0-103" class="i">+static char *
</a><a href="#h2-0-104" id="h2-0-104" class="i">+estrdup(const char *str) {
</a><a href="#h2-0-105" id="h2-0-105" class="i">+	void *res = strdup(str);
</a><a href="#h2-0-106" id="h2-0-106" class="i">+
</a><a href="#h2-0-107" id="h2-0-107" class="i">+	if(!res)
</a><a href="#h2-0-108" id="h2-0-108" class="i">+		eprint(&quot;fatal: could not malloc() %u bytes\n&quot;, strlen(str));
</a><a href="#h2-0-109" id="h2-0-109" class="i">+	return res;
</a><a href="#h2-0-110" id="h2-0-110" class="i">+}
</a><a href="#h2-0-111" id="h2-0-111" class="i">+
</a><a href="#h2-0-112" id="h2-0-112" class="i">+
</a><a href="#h2-0-113" id="h2-0-113" class="i">+static void
</a><a href="#h2-0-114" id="h2-0-114" class="i">+drawtext(const char *text, unsigned long col[ColLast]) {
</a><a href="#h2-0-115" id="h2-0-115" class="i">+	int x, y, w, h;
</a><a href="#h2-0-116" id="h2-0-116" class="i">+	static char buf[256];
</a><a href="#h2-0-117" id="h2-0-117" class="i">+	unsigned int len, olen;
</a><a href="#h2-0-118" id="h2-0-118" class="i">+	XRectangle r = { dc.x, dc.y, dc.w, dc.h };
</a><a href="#h2-0-119" id="h2-0-119" class="i">+
</a><a href="#h2-0-120" id="h2-0-120" class="i">+	XSetForeground(dpy, dc.gc, col[ColBG]);
</a><a href="#h2-0-121" id="h2-0-121" class="i">+	XFillRectangles(dpy, dc.drawable, dc.gc, &amp;r, 1);
</a><a href="#h2-0-122" id="h2-0-122" class="i">+	if(!text)
</a><a href="#h2-0-123" id="h2-0-123" class="i">+		return;
</a><a href="#h2-0-124" id="h2-0-124" class="i">+	w = 0;
</a><a href="#h2-0-125" id="h2-0-125" class="i">+	olen = len = strlen(text);
</a><a href="#h2-0-126" id="h2-0-126" class="i">+	if(len &gt;= sizeof buf)
</a><a href="#h2-0-127" id="h2-0-127" class="i">+		len = sizeof buf - 1;
</a><a href="#h2-0-128" id="h2-0-128" class="i">+	memcpy(buf, text, len);
</a><a href="#h2-0-129" id="h2-0-129" class="i">+	buf[len] = 0;
</a><a href="#h2-0-130" id="h2-0-130" class="i">+	h = dc.font.ascent + dc.font.descent;
</a><a href="#h2-0-131" id="h2-0-131" class="i">+	y = dc.y + (dc.h / 2) - (h / 2) + dc.font.ascent;
</a><a href="#h2-0-132" id="h2-0-132" class="i">+	x = dc.x + (h / 2);
</a><a href="#h2-0-133" id="h2-0-133" class="i">+	/* shorten text if necessary */
</a><a href="#h2-0-134" id="h2-0-134" class="i">+	while(len &amp;&amp; (w = textnw(buf, len)) &gt; dc.w - h)
</a><a href="#h2-0-135" id="h2-0-135" class="i">+		buf[--len] = 0;
</a><a href="#h2-0-136" id="h2-0-136" class="i">+	if(len &lt; olen) {
</a><a href="#h2-0-137" id="h2-0-137" class="i">+		if(len &gt; 1)
</a><a href="#h2-0-138" id="h2-0-138" class="i">+			buf[len - 1] = &#39;.&#39;;
</a><a href="#h2-0-139" id="h2-0-139" class="i">+		if(len &gt; 2)
</a><a href="#h2-0-140" id="h2-0-140" class="i">+			buf[len - 2] = &#39;.&#39;;
</a><a href="#h2-0-141" id="h2-0-141" class="i">+		if(len &gt; 3)
</a><a href="#h2-0-142" id="h2-0-142" class="i">+			buf[len - 3] = &#39;.&#39;;
</a><a href="#h2-0-143" id="h2-0-143" class="i">+	}
</a><a href="#h2-0-144" id="h2-0-144" class="i">+	if(w &gt; dc.w)
</a><a href="#h2-0-145" id="h2-0-145" class="i">+		return; /* too long */
</a><a href="#h2-0-146" id="h2-0-146" class="i">+	XSetForeground(dpy, dc.gc, col[ColFG]);
</a><a href="#h2-0-147" id="h2-0-147" class="i">+	if(dc.font.set)
</a><a href="#h2-0-148" id="h2-0-148" class="i">+		XmbDrawString(dpy, dc.drawable, dc.font.set, dc.gc, x, y, buf, len);
</a><a href="#h2-0-149" id="h2-0-149" class="i">+	else
</a><a href="#h2-0-150" id="h2-0-150" class="i">+		XDrawString(dpy, dc.drawable, dc.gc, x, y, buf, len);
</a><a href="#h2-0-151" id="h2-0-151" class="i">+}
</a><a href="#h2-0-152" id="h2-0-152" class="i">+
</a><a href="#h2-0-153" id="h2-0-153" class="i">+static unsigned int
</a><a href="#h2-0-154" id="h2-0-154" class="i">+textw(const char *text) {
</a><a href="#h2-0-155" id="h2-0-155" class="i">+	return textnw(text, strlen(text)) + dc.font.height;
</a><a href="#h2-0-156" id="h2-0-156" class="i">+}
</a><a href="#h2-0-157" id="h2-0-157" class="i">+
</a><a href="#h2-0-158" id="h2-0-158" class="i">+static unsigned int
</a><a href="#h2-0-159" id="h2-0-159" class="i">+textnw(const char *text, unsigned int len) {
</a><a href="#h2-0-160" id="h2-0-160" class="i">+	XRectangle r;
</a><a href="#h2-0-161" id="h2-0-161" class="i">+
</a><a href="#h2-0-162" id="h2-0-162" class="i">+	if(dc.font.set) {
</a><a href="#h2-0-163" id="h2-0-163" class="i">+		XmbTextExtents(dc.font.set, text, len, NULL, &amp;r);
</a><a href="#h2-0-164" id="h2-0-164" class="i">+		return r.width;
</a><a href="#h2-0-165" id="h2-0-165" class="i">+	}
</a><a href="#h2-0-166" id="h2-0-166" class="i">+	return XTextWidth(dc.font.xfont, text, len);
</a><a href="#h2-0-167" id="h2-0-167" class="i">+}
</a><a href="#h2-0-168" id="h2-0-168" class="i">+
</a><a href="#h2-0-169" id="h2-0-169" class="i">+static void
</a><a href="#h2-0-170" id="h2-0-170" class="i">+calcoffsets(void) {
</a><a href="#h2-0-171" id="h2-0-171" class="i">+	unsigned int tw, w;
</a><a href="#h2-0-172" id="h2-0-172" class="i">+
</a><a href="#h2-0-173" id="h2-0-173" class="i">+	if(!curr)
</a><a href="#h2-0-174" id="h2-0-174" class="i">+		return;
</a><a href="#h2-0-175" id="h2-0-175" class="i">+	w = promptw + cmdw + 2 * SPACE;
</a><a href="#h2-0-176" id="h2-0-176" class="i">+	for(next = curr; next; next=next-&gt;right) {
</a><a href="#h2-0-177" id="h2-0-177" class="i">+		tw = textw(next-&gt;text);
</a><a href="#h2-0-178" id="h2-0-178" class="i">+		if(tw &gt; mw / 3)
</a><a href="#h2-0-179" id="h2-0-179" class="i">+			tw = mw / 3;
</a><a href="#h2-0-180" id="h2-0-180" class="i">+		w += tw;
</a><a href="#h2-0-181" id="h2-0-181" class="i">+		if(w &gt; mw)
</a><a href="#h2-0-182" id="h2-0-182" class="i">+			break;
</a><a href="#h2-0-183" id="h2-0-183" class="i">+	}
</a><a href="#h2-0-184" id="h2-0-184" class="i">+	w = promptw + cmdw + 2 * SPACE;
</a><a href="#h2-0-185" id="h2-0-185" class="i">+	for(prev = curr; prev &amp;&amp; prev-&gt;left; prev=prev-&gt;left) {
</a><a href="#h2-0-186" id="h2-0-186" class="i">+		tw = textw(prev-&gt;left-&gt;text);
</a><a href="#h2-0-187" id="h2-0-187" class="i">+		if(tw &gt; mw / 3)
</a><a href="#h2-0-188" id="h2-0-188" class="i">+			tw = mw / 3;
</a><a href="#h2-0-189" id="h2-0-189" class="i">+		w += tw;
</a><a href="#h2-0-190" id="h2-0-190" class="i">+		if(w &gt; mw)
</a><a href="#h2-0-191" id="h2-0-191" class="i">+			break;
</a><a href="#h2-0-192" id="h2-0-192" class="i">+	}
</a><a href="#h2-0-193" id="h2-0-193" class="i">+}
</a><a href="#h2-0-194" id="h2-0-194" class="i">+
</a><a href="#h2-0-195" id="h2-0-195" class="i">+static void
</a><a href="#h2-0-196" id="h2-0-196" class="i">+drawmenu(void) {
</a><a href="#h2-0-197" id="h2-0-197" class="i">+	Item *i;
</a><a href="#h2-0-198" id="h2-0-198" class="i">+
</a><a href="#h2-0-199" id="h2-0-199" class="i">+	dc.x = 0;
</a><a href="#h2-0-200" id="h2-0-200" class="i">+	dc.y = 0;
</a><a href="#h2-0-201" id="h2-0-201" class="i">+	dc.w = mw;
</a><a href="#h2-0-202" id="h2-0-202" class="i">+	dc.h = mh;
</a><a href="#h2-0-203" id="h2-0-203" class="i">+	drawtext(NULL, dc.norm);
</a><a href="#h2-0-204" id="h2-0-204" class="i">+	/* print prompt? */
</a><a href="#h2-0-205" id="h2-0-205" class="i">+	if(promptw) {
</a><a href="#h2-0-206" id="h2-0-206" class="i">+		dc.w = promptw;
</a><a href="#h2-0-207" id="h2-0-207" class="i">+		drawtext(prompt, dc.sel);
</a><a href="#h2-0-208" id="h2-0-208" class="i">+	}
</a><a href="#h2-0-209" id="h2-0-209" class="i">+	dc.x += promptw;
</a><a href="#h2-0-210" id="h2-0-210" class="i">+	dc.w = mw - promptw;
</a><a href="#h2-0-211" id="h2-0-211" class="i">+	/* print command */
</a><a href="#h2-0-212" id="h2-0-212" class="i">+	if(cmdw &amp;&amp; item)
</a><a href="#h2-0-213" id="h2-0-213" class="i">+		dc.w = cmdw;
</a><a href="#h2-0-214" id="h2-0-214" class="i">+	drawtext(text[0] ? text : NULL, dc.norm);
</a><a href="#h2-0-215" id="h2-0-215" class="i">+	dc.x += cmdw;
</a><a href="#h2-0-216" id="h2-0-216" class="i">+	if(curr) {
</a><a href="#h2-0-217" id="h2-0-217" class="i">+		dc.w = SPACE;
</a><a href="#h2-0-218" id="h2-0-218" class="i">+		drawtext((curr &amp;&amp; curr-&gt;left) ? &quot;&lt;&quot; : NULL, dc.norm);
</a><a href="#h2-0-219" id="h2-0-219" class="i">+		dc.x += dc.w;
</a><a href="#h2-0-220" id="h2-0-220" class="i">+		/* determine maximum items */
</a><a href="#h2-0-221" id="h2-0-221" class="i">+		for(i = curr; i != next; i=i-&gt;right) {
</a><a href="#h2-0-222" id="h2-0-222" class="i">+			dc.w = textw(i-&gt;text);
</a><a href="#h2-0-223" id="h2-0-223" class="i">+			if(dc.w &gt; mw / 3)
</a><a href="#h2-0-224" id="h2-0-224" class="i">+				dc.w = mw / 3;
</a><a href="#h2-0-225" id="h2-0-225" class="i">+			drawtext(i-&gt;text, (sel == i) ? dc.sel : dc.norm);
</a><a href="#h2-0-226" id="h2-0-226" class="i">+			dc.x += dc.w;
</a><a href="#h2-0-227" id="h2-0-227" class="i">+		}
</a><a href="#h2-0-228" id="h2-0-228" class="i">+		dc.x = mw - SPACE;
</a><a href="#h2-0-229" id="h2-0-229" class="i">+		dc.w = SPACE;
</a><a href="#h2-0-230" id="h2-0-230" class="i">+		drawtext(next ? &quot;&gt;&quot; : NULL, dc.norm);
</a><a href="#h2-0-231" id="h2-0-231" class="i">+	}
</a><a href="#h2-0-232" id="h2-0-232" class="i">+	XCopyArea(dpy, dc.drawable, win, dc.gc, 0, 0, mw, mh, 0, 0);
</a><a href="#h2-0-233" id="h2-0-233" class="i">+	XFlush(dpy);
</a><a href="#h2-0-234" id="h2-0-234" class="i">+}
</a><a href="#h2-0-235" id="h2-0-235" class="i">+
</a><a href="#h2-0-236" id="h2-0-236" class="i">+static Bool
</a><a href="#h2-0-237" id="h2-0-237" class="i">+grabkeyboard(void) {
</a><a href="#h2-0-238" id="h2-0-238" class="i">+	unsigned int len;
</a><a href="#h2-0-239" id="h2-0-239" class="i">+
</a><a href="#h2-0-240" id="h2-0-240" class="i">+	for(len = 1000; len; len--) {
</a><a href="#h2-0-241" id="h2-0-241" class="i">+		if(XGrabKeyboard(dpy, root, True, GrabModeAsync, GrabModeAsync, CurrentTime)
</a><a href="#h2-0-242" id="h2-0-242" class="i">+			== GrabSuccess)
</a><a href="#h2-0-243" id="h2-0-243" class="i">+			break;
</a><a href="#h2-0-244" id="h2-0-244" class="i">+		usleep(1000);
</a><a href="#h2-0-245" id="h2-0-245" class="i">+	}
</a><a href="#h2-0-246" id="h2-0-246" class="i">+	return len &gt; 0;
</a><a href="#h2-0-247" id="h2-0-247" class="i">+}
</a><a href="#h2-0-248" id="h2-0-248" class="i">+
</a><a href="#h2-0-249" id="h2-0-249" class="i">+static unsigned long
</a><a href="#h2-0-250" id="h2-0-250" class="i">+getcolor(const char *colstr) {
</a><a href="#h2-0-251" id="h2-0-251" class="i">+	Colormap cmap = DefaultColormap(dpy, screen);
</a><a href="#h2-0-252" id="h2-0-252" class="i">+	XColor color;
</a><a href="#h2-0-253" id="h2-0-253" class="i">+
</a><a href="#h2-0-254" id="h2-0-254" class="i">+	if(!XAllocNamedColor(dpy, cmap, colstr, &amp;color, &amp;color))
</a><a href="#h2-0-255" id="h2-0-255" class="i">+		eprint(&quot;error, cannot allocate color &#39;%s&#39;\n&quot;, colstr);
</a><a href="#h2-0-256" id="h2-0-256" class="i">+	return color.pixel;
</a><a href="#h2-0-257" id="h2-0-257" class="i">+}
</a><a href="#h2-0-258" id="h2-0-258" class="i">+
</a><a href="#h2-0-259" id="h2-0-259" class="i">+static void
</a><a href="#h2-0-260" id="h2-0-260" class="i">+initfont(const char *fontstr) {
</a><a href="#h2-0-261" id="h2-0-261" class="i">+	char *def, **missing;
</a><a href="#h2-0-262" id="h2-0-262" class="i">+	int i, n;
</a><a href="#h2-0-263" id="h2-0-263" class="i">+
</a><a href="#h2-0-264" id="h2-0-264" class="i">+	if(!fontstr || fontstr[0] == &#39;\0&#39;)
</a><a href="#h2-0-265" id="h2-0-265" class="i">+		eprint(&quot;error, cannot load font: &#39;%s&#39;\n&quot;, fontstr);
</a><a href="#h2-0-266" id="h2-0-266" class="i">+	missing = NULL;
</a><a href="#h2-0-267" id="h2-0-267" class="i">+	if(dc.font.set)
</a><a href="#h2-0-268" id="h2-0-268" class="i">+		XFreeFontSet(dpy, dc.font.set);
</a><a href="#h2-0-269" id="h2-0-269" class="i">+	dc.font.set = XCreateFontSet(dpy, fontstr, &amp;missing, &amp;n, &amp;def);
</a><a href="#h2-0-270" id="h2-0-270" class="i">+	if(missing)
</a><a href="#h2-0-271" id="h2-0-271" class="i">+		XFreeStringList(missing);
</a><a href="#h2-0-272" id="h2-0-272" class="i">+	if(dc.font.set) {
</a><a href="#h2-0-273" id="h2-0-273" class="i">+		XFontSetExtents *font_extents;
</a><a href="#h2-0-274" id="h2-0-274" class="i">+		XFontStruct **xfonts;
</a><a href="#h2-0-275" id="h2-0-275" class="i">+		char **font_names;
</a><a href="#h2-0-276" id="h2-0-276" class="i">+		dc.font.ascent = dc.font.descent = 0;
</a><a href="#h2-0-277" id="h2-0-277" class="i">+		font_extents = XExtentsOfFontSet(dc.font.set);
</a><a href="#h2-0-278" id="h2-0-278" class="i">+		n = XFontsOfFontSet(dc.font.set, &amp;xfonts, &amp;font_names);
</a><a href="#h2-0-279" id="h2-0-279" class="i">+		for(i = 0, dc.font.ascent = 0, dc.font.descent = 0; i &lt; n; i++) {
</a><a href="#h2-0-280" id="h2-0-280" class="i">+			if(dc.font.ascent &lt; (*xfonts)-&gt;ascent)
</a><a href="#h2-0-281" id="h2-0-281" class="i">+				dc.font.ascent = (*xfonts)-&gt;ascent;
</a><a href="#h2-0-282" id="h2-0-282" class="i">+			if(dc.font.descent &lt; (*xfonts)-&gt;descent)
</a><a href="#h2-0-283" id="h2-0-283" class="i">+				dc.font.descent = (*xfonts)-&gt;descent;
</a><a href="#h2-0-284" id="h2-0-284" class="i">+			xfonts++;
</a><a href="#h2-0-285" id="h2-0-285" class="i">+		}
</a><a href="#h2-0-286" id="h2-0-286" class="i">+	}
</a><a href="#h2-0-287" id="h2-0-287" class="i">+	else {
</a><a href="#h2-0-288" id="h2-0-288" class="i">+		if(dc.font.xfont)
</a><a href="#h2-0-289" id="h2-0-289" class="i">+			XFreeFont(dpy, dc.font.xfont);
</a><a href="#h2-0-290" id="h2-0-290" class="i">+		dc.font.xfont = NULL;
</a><a href="#h2-0-291" id="h2-0-291" class="i">+		if(!(dc.font.xfont = XLoadQueryFont(dpy, fontstr))) {
</a><a href="#h2-0-292" id="h2-0-292" class="i">+			if(!(dc.font.xfont = XLoadQueryFont(dpy, &quot;fixed&quot;)))
</a><a href="#h2-0-293" id="h2-0-293" class="i">+				eprint(&quot;error, cannot load font: &#39;%s&#39;\n&quot;, fontstr);
</a><a href="#h2-0-294" id="h2-0-294" class="i">+		}
</a><a href="#h2-0-295" id="h2-0-295" class="i">+		dc.font.ascent = dc.font.xfont-&gt;ascent;
</a><a href="#h2-0-296" id="h2-0-296" class="i">+		dc.font.descent = dc.font.xfont-&gt;descent;
</a><a href="#h2-0-297" id="h2-0-297" class="i">+	}
</a><a href="#h2-0-298" id="h2-0-298" class="i">+	dc.font.height = dc.font.ascent + dc.font.descent;
</a><a href="#h2-0-299" id="h2-0-299" class="i">+}
</a><a href="#h2-0-300" id="h2-0-300" class="i">+
</a><a href="#h2-0-301" id="h2-0-301" class="i">+static int
</a><a href="#h2-0-302" id="h2-0-302" class="i">+strido(const char *text, const char *pattern) {
</a><a href="#h2-0-303" id="h2-0-303" class="i">+	for(; *text &amp;&amp; *pattern; text++)
</a><a href="#h2-0-304" id="h2-0-304" class="i">+		if (*text == *pattern)
</a><a href="#h2-0-305" id="h2-0-305" class="i">+			pattern++;
</a><a href="#h2-0-306" id="h2-0-306" class="i">+	return !*pattern;
</a><a href="#h2-0-307" id="h2-0-307" class="i">+}                                  
</a><a href="#h2-0-308" id="h2-0-308" class="i">+
</a><a href="#h2-0-309" id="h2-0-309" class="i">+static void
</a><a href="#h2-0-310" id="h2-0-310" class="i">+match(char *pattern) {
</a><a href="#h2-0-311" id="h2-0-311" class="i">+	unsigned int plen;
</a><a href="#h2-0-312" id="h2-0-312" class="i">+	Item *i, *j;
</a><a href="#h2-0-313" id="h2-0-313" class="i">+
</a><a href="#h2-0-314" id="h2-0-314" class="i">+	if(!pattern)
</a><a href="#h2-0-315" id="h2-0-315" class="i">+		return;
</a><a href="#h2-0-316" id="h2-0-316" class="i">+	plen = strlen(pattern);
</a><a href="#h2-0-317" id="h2-0-317" class="i">+	item = j = NULL;
</a><a href="#h2-0-318" id="h2-0-318" class="i">+	nitem = 0;
</a><a href="#h2-0-319" id="h2-0-319" class="i">+	for(i = allitems; i; i=i-&gt;next)
</a><a href="#h2-0-320" id="h2-0-320" class="i">+		if(!plen || !strncmp(pattern, i-&gt;text, plen)) {
</a><a href="#h2-0-321" id="h2-0-321" class="i">+			if(!j)
</a><a href="#h2-0-322" id="h2-0-322" class="i">+				item = i;
</a><a href="#h2-0-323" id="h2-0-323" class="i">+			else
</a><a href="#h2-0-324" id="h2-0-324" class="i">+				j-&gt;right = i;
</a><a href="#h2-0-325" id="h2-0-325" class="i">+			i-&gt;left = j;
</a><a href="#h2-0-326" id="h2-0-326" class="i">+			i-&gt;right = NULL;
</a><a href="#h2-0-327" id="h2-0-327" class="i">+			j = i;
</a><a href="#h2-0-328" id="h2-0-328" class="i">+			nitem++;
</a><a href="#h2-0-329" id="h2-0-329" class="i">+		}
</a><a href="#h2-0-330" id="h2-0-330" class="i">+	for(i = allitems; i; i=i-&gt;next)
</a><a href="#h2-0-331" id="h2-0-331" class="i">+		if(plen &amp;&amp; strncmp(pattern, i-&gt;text, plen)
</a><a href="#h2-0-332" id="h2-0-332" class="i">+				&amp;&amp; strstr(i-&gt;text, pattern)) {
</a><a href="#h2-0-333" id="h2-0-333" class="i">+			if(!j)                               
</a><a href="#h2-0-334" id="h2-0-334" class="i">+				item = i;                              
</a><a href="#h2-0-335" id="h2-0-335" class="i">+			else                                     
</a><a href="#h2-0-336" id="h2-0-336" class="i">+				j-&gt;right = i;                          
</a><a href="#h2-0-337" id="h2-0-337" class="i">+			i-&gt;left = j;      
</a><a href="#h2-0-338" id="h2-0-338" class="i">+			i-&gt;right = NULL;                         
</a><a href="#h2-0-339" id="h2-0-339" class="i">+			j = i;                                      
</a><a href="#h2-0-340" id="h2-0-340" class="i">+			nitem++;                                       
</a><a href="#h2-0-341" id="h2-0-341" class="i">+		}                                              
</a><a href="#h2-0-342" id="h2-0-342" class="i">+	for(i = allitems; i; i=i-&gt;next)                            
</a><a href="#h2-0-343" id="h2-0-343" class="i">+		if(plen &amp;&amp; strncmp(pattern, i-&gt;text, plen)             
</a><a href="#h2-0-344" id="h2-0-344" class="i">+				&amp;&amp; !strstr(i-&gt;text, pattern)          
</a><a href="#h2-0-345" id="h2-0-345" class="i">+				&amp;&amp; strido(i-&gt;text,pattern)) { 
</a><a href="#h2-0-346" id="h2-0-346" class="i">+			if(!j)
</a><a href="#h2-0-347" id="h2-0-347" class="i">+				item = i;
</a><a href="#h2-0-348" id="h2-0-348" class="i">+			else
</a><a href="#h2-0-349" id="h2-0-349" class="i">+				j-&gt;right = i;
</a><a href="#h2-0-350" id="h2-0-350" class="i">+			i-&gt;left = j;
</a><a href="#h2-0-351" id="h2-0-351" class="i">+			i-&gt;right = NULL;
</a><a href="#h2-0-352" id="h2-0-352" class="i">+			j = i;
</a><a href="#h2-0-353" id="h2-0-353" class="i">+			nitem++;
</a><a href="#h2-0-354" id="h2-0-354" class="i">+		}
</a><a href="#h2-0-355" id="h2-0-355" class="i">+	curr = prev = next = sel = item;
</a><a href="#h2-0-356" id="h2-0-356" class="i">+	calcoffsets();
</a><a href="#h2-0-357" id="h2-0-357" class="i">+}
</a><a href="#h2-0-358" id="h2-0-358" class="i">+
</a><a href="#h2-0-359" id="h2-0-359" class="i">+static void
</a><a href="#h2-0-360" id="h2-0-360" class="i">+kpress(XKeyEvent * e) {
</a><a href="#h2-0-361" id="h2-0-361" class="i">+	char buf[32];
</a><a href="#h2-0-362" id="h2-0-362" class="i">+	int i, num;
</a><a href="#h2-0-363" id="h2-0-363" class="i">+	unsigned int len;
</a><a href="#h2-0-364" id="h2-0-364" class="i">+	KeySym ksym;
</a><a href="#h2-0-365" id="h2-0-365" class="i">+
</a><a href="#h2-0-366" id="h2-0-366" class="i">+	len = strlen(text);
</a><a href="#h2-0-367" id="h2-0-367" class="i">+	buf[0] = 0;
</a><a href="#h2-0-368" id="h2-0-368" class="i">+	num = XLookupString(e, buf, sizeof buf, &amp;ksym, 0);
</a><a href="#h2-0-369" id="h2-0-369" class="i">+	if(IsKeypadKey(ksym)) { 
</a><a href="#h2-0-370" id="h2-0-370" class="i">+		if(ksym == XK_KP_Enter) {
</a><a href="#h2-0-371" id="h2-0-371" class="i">+			ksym = XK_Return;
</a><a href="#h2-0-372" id="h2-0-372" class="i">+		} else if(ksym &gt;= XK_KP_0 &amp;&amp; ksym &lt;= XK_KP_9) {
</a><a href="#h2-0-373" id="h2-0-373" class="i">+			ksym = (ksym - XK_KP_0) + XK_0;
</a><a href="#h2-0-374" id="h2-0-374" class="i">+		}
</a><a href="#h2-0-375" id="h2-0-375" class="i">+	}
</a><a href="#h2-0-376" id="h2-0-376" class="i">+	if(IsFunctionKey(ksym) || IsKeypadKey(ksym)
</a><a href="#h2-0-377" id="h2-0-377" class="i">+			|| IsMiscFunctionKey(ksym) || IsPFKey(ksym)
</a><a href="#h2-0-378" id="h2-0-378" class="i">+			|| IsPrivateKeypadKey(ksym))
</a><a href="#h2-0-379" id="h2-0-379" class="i">+		return;
</a><a href="#h2-0-380" id="h2-0-380" class="i">+	/* first check if a control mask is omitted */
</a><a href="#h2-0-381" id="h2-0-381" class="i">+	if(e-&gt;state &amp; ControlMask) {
</a><a href="#h2-0-382" id="h2-0-382" class="i">+		switch (ksym) {
</a><a href="#h2-0-383" id="h2-0-383" class="i">+		default:	/* ignore other control sequences */
</a><a href="#h2-0-384" id="h2-0-384" class="i">+			return;
</a><a href="#h2-0-385" id="h2-0-385" class="i">+		case XK_bracketleft:
</a><a href="#h2-0-386" id="h2-0-386" class="i">+			ksym = XK_Escape;
</a><a href="#h2-0-387" id="h2-0-387" class="i">+			break;
</a><a href="#h2-0-388" id="h2-0-388" class="i">+		case XK_h:
</a><a href="#h2-0-389" id="h2-0-389" class="i">+		case XK_H:
</a><a href="#h2-0-390" id="h2-0-390" class="i">+			ksym = XK_BackSpace;
</a><a href="#h2-0-391" id="h2-0-391" class="i">+			break;
</a><a href="#h2-0-392" id="h2-0-392" class="i">+		case XK_i:
</a><a href="#h2-0-393" id="h2-0-393" class="i">+		case XK_I:
</a><a href="#h2-0-394" id="h2-0-394" class="i">+			ksym = XK_Tab;
</a><a href="#h2-0-395" id="h2-0-395" class="i">+			break;
</a><a href="#h2-0-396" id="h2-0-396" class="i">+		case XK_j:
</a><a href="#h2-0-397" id="h2-0-397" class="i">+		case XK_J:
</a><a href="#h2-0-398" id="h2-0-398" class="i">+			ksym = XK_Return;
</a><a href="#h2-0-399" id="h2-0-399" class="i">+			break;
</a><a href="#h2-0-400" id="h2-0-400" class="i">+		case XK_u:
</a><a href="#h2-0-401" id="h2-0-401" class="i">+		case XK_U:
</a><a href="#h2-0-402" id="h2-0-402" class="i">+			text[0] = 0;
</a><a href="#h2-0-403" id="h2-0-403" class="i">+			match(text);
</a><a href="#h2-0-404" id="h2-0-404" class="i">+			drawmenu();
</a><a href="#h2-0-405" id="h2-0-405" class="i">+			return;
</a><a href="#h2-0-406" id="h2-0-406" class="i">+		case XK_w:
</a><a href="#h2-0-407" id="h2-0-407" class="i">+		case XK_W:
</a><a href="#h2-0-408" id="h2-0-408" class="i">+			if(len) {
</a><a href="#h2-0-409" id="h2-0-409" class="i">+				i = len - 1;
</a><a href="#h2-0-410" id="h2-0-410" class="i">+				while(i &gt;= 0 &amp;&amp; text[i] == &#39; &#39;)
</a><a href="#h2-0-411" id="h2-0-411" class="i">+					text[i--] = 0;
</a><a href="#h2-0-412" id="h2-0-412" class="i">+				while(i &gt;= 0 &amp;&amp; text[i] != &#39; &#39;)
</a><a href="#h2-0-413" id="h2-0-413" class="i">+					text[i--] = 0;
</a><a href="#h2-0-414" id="h2-0-414" class="i">+				match(text);
</a><a href="#h2-0-415" id="h2-0-415" class="i">+				drawmenu();
</a><a href="#h2-0-416" id="h2-0-416" class="i">+			}
</a><a href="#h2-0-417" id="h2-0-417" class="i">+			return;
</a><a href="#h2-0-418" id="h2-0-418" class="i">+		}
</a><a href="#h2-0-419" id="h2-0-419" class="i">+	}
</a><a href="#h2-0-420" id="h2-0-420" class="i">+	if(CLEANMASK(e-&gt;state) &amp; Mod1Mask) {
</a><a href="#h2-0-421" id="h2-0-421" class="i">+		switch(ksym) {
</a><a href="#h2-0-422" id="h2-0-422" class="i">+		default: return;
</a><a href="#h2-0-423" id="h2-0-423" class="i">+		case XK_h:
</a><a href="#h2-0-424" id="h2-0-424" class="i">+			ksym = XK_Left;
</a><a href="#h2-0-425" id="h2-0-425" class="i">+			break;
</a><a href="#h2-0-426" id="h2-0-426" class="i">+		case XK_l:
</a><a href="#h2-0-427" id="h2-0-427" class="i">+			ksym = XK_Right;
</a><a href="#h2-0-428" id="h2-0-428" class="i">+			break;
</a><a href="#h2-0-429" id="h2-0-429" class="i">+		case XK_j:
</a><a href="#h2-0-430" id="h2-0-430" class="i">+			ksym = XK_Next;
</a><a href="#h2-0-431" id="h2-0-431" class="i">+			break;
</a><a href="#h2-0-432" id="h2-0-432" class="i">+		case XK_k:
</a><a href="#h2-0-433" id="h2-0-433" class="i">+			ksym = XK_Prior;
</a><a href="#h2-0-434" id="h2-0-434" class="i">+			break;
</a><a href="#h2-0-435" id="h2-0-435" class="i">+		case XK_g:
</a><a href="#h2-0-436" id="h2-0-436" class="i">+			ksym = XK_Home;
</a><a href="#h2-0-437" id="h2-0-437" class="i">+			break;
</a><a href="#h2-0-438" id="h2-0-438" class="i">+		case XK_G:
</a><a href="#h2-0-439" id="h2-0-439" class="i">+			ksym = XK_End;
</a><a href="#h2-0-440" id="h2-0-440" class="i">+			break;
</a><a href="#h2-0-441" id="h2-0-441" class="i">+		}
</a><a href="#h2-0-442" id="h2-0-442" class="i">+	}
</a><a href="#h2-0-443" id="h2-0-443" class="i">+	switch(ksym) {
</a><a href="#h2-0-444" id="h2-0-444" class="i">+	default:
</a><a href="#h2-0-445" id="h2-0-445" class="i">+		if(num &amp;&amp; !iscntrl((int) buf[0])) {
</a><a href="#h2-0-446" id="h2-0-446" class="i">+			buf[num] = 0;
</a><a href="#h2-0-447" id="h2-0-447" class="i">+			if(len &gt; 0)
</a><a href="#h2-0-448" id="h2-0-448" class="i">+				strncat(text, buf, sizeof text);
</a><a href="#h2-0-449" id="h2-0-449" class="i">+			else
</a><a href="#h2-0-450" id="h2-0-450" class="i">+				strncpy(text, buf, sizeof text);
</a><a href="#h2-0-451" id="h2-0-451" class="i">+			match(text);
</a><a href="#h2-0-452" id="h2-0-452" class="i">+		}
</a><a href="#h2-0-453" id="h2-0-453" class="i">+		break;
</a><a href="#h2-0-454" id="h2-0-454" class="i">+	case XK_BackSpace:
</a><a href="#h2-0-455" id="h2-0-455" class="i">+		if(len) {
</a><a href="#h2-0-456" id="h2-0-456" class="i">+			text[--len] = 0;
</a><a href="#h2-0-457" id="h2-0-457" class="i">+			match(text);
</a><a href="#h2-0-458" id="h2-0-458" class="i">+		}
</a><a href="#h2-0-459" id="h2-0-459" class="i">+		break;
</a><a href="#h2-0-460" id="h2-0-460" class="i">+	case XK_End:
</a><a href="#h2-0-461" id="h2-0-461" class="i">+		if(!item)
</a><a href="#h2-0-462" id="h2-0-462" class="i">+			return;
</a><a href="#h2-0-463" id="h2-0-463" class="i">+		while(next) {
</a><a href="#h2-0-464" id="h2-0-464" class="i">+			sel = curr = next;
</a><a href="#h2-0-465" id="h2-0-465" class="i">+			calcoffsets();
</a><a href="#h2-0-466" id="h2-0-466" class="i">+		}
</a><a href="#h2-0-467" id="h2-0-467" class="i">+		while(sel &amp;&amp; sel-&gt;right)
</a><a href="#h2-0-468" id="h2-0-468" class="i">+			sel = sel-&gt;right;
</a><a href="#h2-0-469" id="h2-0-469" class="i">+		break;
</a><a href="#h2-0-470" id="h2-0-470" class="i">+	case XK_Escape:
</a><a href="#h2-0-471" id="h2-0-471" class="i">+		ret = 1;
</a><a href="#h2-0-472" id="h2-0-472" class="i">+		running = False;
</a><a href="#h2-0-473" id="h2-0-473" class="i">+		break;
</a><a href="#h2-0-474" id="h2-0-474" class="i">+	case XK_Home:
</a><a href="#h2-0-475" id="h2-0-475" class="i">+		if(!item)
</a><a href="#h2-0-476" id="h2-0-476" class="i">+			return;
</a><a href="#h2-0-477" id="h2-0-477" class="i">+		sel = curr = item;
</a><a href="#h2-0-478" id="h2-0-478" class="i">+		calcoffsets();
</a><a href="#h2-0-479" id="h2-0-479" class="i">+		break;
</a><a href="#h2-0-480" id="h2-0-480" class="i">+	case XK_Left:
</a><a href="#h2-0-481" id="h2-0-481" class="i">+		if(!(sel &amp;&amp; sel-&gt;left))
</a><a href="#h2-0-482" id="h2-0-482" class="i">+			return;
</a><a href="#h2-0-483" id="h2-0-483" class="i">+		sel=sel-&gt;left;
</a><a href="#h2-0-484" id="h2-0-484" class="i">+		if(sel-&gt;right == curr) {
</a><a href="#h2-0-485" id="h2-0-485" class="i">+			curr = prev;
</a><a href="#h2-0-486" id="h2-0-486" class="i">+			calcoffsets();
</a><a href="#h2-0-487" id="h2-0-487" class="i">+		}
</a><a href="#h2-0-488" id="h2-0-488" class="i">+		break;
</a><a href="#h2-0-489" id="h2-0-489" class="i">+	case XK_Next:
</a><a href="#h2-0-490" id="h2-0-490" class="i">+		if(!next)
</a><a href="#h2-0-491" id="h2-0-491" class="i">+			return;
</a><a href="#h2-0-492" id="h2-0-492" class="i">+		sel = curr = next;
</a><a href="#h2-0-493" id="h2-0-493" class="i">+		calcoffsets();
</a><a href="#h2-0-494" id="h2-0-494" class="i">+		break;
</a><a href="#h2-0-495" id="h2-0-495" class="i">+	case XK_Prior:
</a><a href="#h2-0-496" id="h2-0-496" class="i">+		if(!prev)
</a><a href="#h2-0-497" id="h2-0-497" class="i">+			return;
</a><a href="#h2-0-498" id="h2-0-498" class="i">+		sel = curr = prev;
</a><a href="#h2-0-499" id="h2-0-499" class="i">+		calcoffsets();
</a><a href="#h2-0-500" id="h2-0-500" class="i">+		break;
</a><a href="#h2-0-501" id="h2-0-501" class="i">+	case XK_Return:
</a><a href="#h2-0-502" id="h2-0-502" class="i">+		if((e-&gt;state &amp; ShiftMask) &amp;&amp; text)
</a><a href="#h2-0-503" id="h2-0-503" class="i">+			fprintf(stdout, &quot;%s&quot;, text);
</a><a href="#h2-0-504" id="h2-0-504" class="i">+		else if(sel)
</a><a href="#h2-0-505" id="h2-0-505" class="i">+			fprintf(stdout, &quot;%s&quot;, sel-&gt;text);
</a><a href="#h2-0-506" id="h2-0-506" class="i">+		else if(text)
</a><a href="#h2-0-507" id="h2-0-507" class="i">+			fprintf(stdout, &quot;%s&quot;, text);
</a><a href="#h2-0-508" id="h2-0-508" class="i">+		fflush(stdout);
</a><a href="#h2-0-509" id="h2-0-509" class="i">+		running = False;
</a><a href="#h2-0-510" id="h2-0-510" class="i">+		break;
</a><a href="#h2-0-511" id="h2-0-511" class="i">+	case XK_Right:
</a><a href="#h2-0-512" id="h2-0-512" class="i">+		if(!(sel &amp;&amp; sel-&gt;right))
</a><a href="#h2-0-513" id="h2-0-513" class="i">+			return;
</a><a href="#h2-0-514" id="h2-0-514" class="i">+		sel=sel-&gt;right;
</a><a href="#h2-0-515" id="h2-0-515" class="i">+		if(sel == next) {
</a><a href="#h2-0-516" id="h2-0-516" class="i">+			curr = next;
</a><a href="#h2-0-517" id="h2-0-517" class="i">+			calcoffsets();
</a><a href="#h2-0-518" id="h2-0-518" class="i">+		}
</a><a href="#h2-0-519" id="h2-0-519" class="i">+		break;
</a><a href="#h2-0-520" id="h2-0-520" class="i">+	case XK_Tab:
</a><a href="#h2-0-521" id="h2-0-521" class="i">+		if(!sel)
</a><a href="#h2-0-522" id="h2-0-522" class="i">+			return;
</a><a href="#h2-0-523" id="h2-0-523" class="i">+		strncpy(text, sel-&gt;text, sizeof text);
</a><a href="#h2-0-524" id="h2-0-524" class="i">+		match(text);
</a><a href="#h2-0-525" id="h2-0-525" class="i">+		break;
</a><a href="#h2-0-526" id="h2-0-526" class="i">+	}
</a><a href="#h2-0-527" id="h2-0-527" class="i">+	drawmenu();
</a><a href="#h2-0-528" id="h2-0-528" class="i">+}
</a><a href="#h2-0-529" id="h2-0-529" class="i">+
</a><a href="#h2-0-530" id="h2-0-530" class="i">+static char *
</a><a href="#h2-0-531" id="h2-0-531" class="i">+readstdin(void) {
</a><a href="#h2-0-532" id="h2-0-532" class="i">+	static char *maxname = NULL;
</a><a href="#h2-0-533" id="h2-0-533" class="i">+	char *p, buf[1024];
</a><a href="#h2-0-534" id="h2-0-534" class="i">+	unsigned int len = 0, max = 0;
</a><a href="#h2-0-535" id="h2-0-535" class="i">+	Item *i, *new;
</a><a href="#h2-0-536" id="h2-0-536" class="i">+
</a><a href="#h2-0-537" id="h2-0-537" class="i">+	i = 0;
</a><a href="#h2-0-538" id="h2-0-538" class="i">+	while(fgets(buf, sizeof buf, stdin)) {
</a><a href="#h2-0-539" id="h2-0-539" class="i">+		len = strlen(buf);
</a><a href="#h2-0-540" id="h2-0-540" class="i">+		if (buf[len - 1] == &#39;\n&#39;)
</a><a href="#h2-0-541" id="h2-0-541" class="i">+			buf[len - 1] = 0;
</a><a href="#h2-0-542" id="h2-0-542" class="i">+		p = estrdup(buf);
</a><a href="#h2-0-543" id="h2-0-543" class="i">+		if(max &lt; len) {
</a><a href="#h2-0-544" id="h2-0-544" class="i">+			maxname = p;
</a><a href="#h2-0-545" id="h2-0-545" class="i">+			max = len;
</a><a href="#h2-0-546" id="h2-0-546" class="i">+		}
</a><a href="#h2-0-547" id="h2-0-547" class="i">+		new = emalloc(sizeof(Item));
</a><a href="#h2-0-548" id="h2-0-548" class="i">+		new-&gt;next = new-&gt;left = new-&gt;right = NULL;
</a><a href="#h2-0-549" id="h2-0-549" class="i">+		new-&gt;text = p;
</a><a href="#h2-0-550" id="h2-0-550" class="i">+		if(!i)
</a><a href="#h2-0-551" id="h2-0-551" class="i">+			allitems = new;
</a><a href="#h2-0-552" id="h2-0-552" class="i">+		else 
</a><a href="#h2-0-553" id="h2-0-553" class="i">+			i-&gt;next = new;
</a><a href="#h2-0-554" id="h2-0-554" class="i">+		i = new;
</a><a href="#h2-0-555" id="h2-0-555" class="i">+	}
</a><a href="#h2-0-556" id="h2-0-556" class="i">+
</a><a href="#h2-0-557" id="h2-0-557" class="i">+	return maxname;
</a><a href="#h2-0-558" id="h2-0-558" class="i">+}
</a><a href="#h2-0-559" id="h2-0-559" class="i">+
</a><a href="#h2-0-560" id="h2-0-560" class="i">+static void
</a><a href="#h2-0-561" id="h2-0-561" class="i">+usage(void) {
</a><a href="#h2-0-562" id="h2-0-562" class="i">+	eprint(&quot;usage: dmenu [-b] [-fn &lt;font&gt;] [-nb &lt;color&gt;] [-nf &lt;color&gt;]\n&quot;
</a><a href="#h2-0-563" id="h2-0-563" class="i">+		&quot;             [-p &lt;prompt&gt;] [-sb &lt;color&gt;] [-sf &lt;color&gt;] [-v]\n&quot;);
</a><a href="#h2-0-564" id="h2-0-564" class="i">+}
</a><a href="#h2-0-565" id="h2-0-565" class="i">+
</a><a href="#h2-0-566" id="h2-0-566" class="i">+int
</a><a href="#h2-0-567" id="h2-0-567" class="i">+main(int argc, char *argv[]) {
</a><a href="#h2-0-568" id="h2-0-568" class="i">+	Bool bottom = False;
</a><a href="#h2-0-569" id="h2-0-569" class="i">+	char *font = FONT;
</a><a href="#h2-0-570" id="h2-0-570" class="i">+	char *maxname;
</a><a href="#h2-0-571" id="h2-0-571" class="i">+	char *normbg = NORMBGCOLOR;
</a><a href="#h2-0-572" id="h2-0-572" class="i">+	char *normfg = NORMFGCOLOR;
</a><a href="#h2-0-573" id="h2-0-573" class="i">+	char *selbg = SELBGCOLOR;
</a><a href="#h2-0-574" id="h2-0-574" class="i">+	char *selfg = SELFGCOLOR;
</a><a href="#h2-0-575" id="h2-0-575" class="i">+	int i, j;
</a><a href="#h2-0-576" id="h2-0-576" class="i">+	Item *itm;
</a><a href="#h2-0-577" id="h2-0-577" class="i">+	XEvent ev;
</a><a href="#h2-0-578" id="h2-0-578" class="i">+	XModifierKeymap *modmap;
</a><a href="#h2-0-579" id="h2-0-579" class="i">+	XSetWindowAttributes wa;
</a><a href="#h2-0-580" id="h2-0-580" class="i">+
</a><a href="#h2-0-581" id="h2-0-581" class="i">+	/* command line args */
</a><a href="#h2-0-582" id="h2-0-582" class="i">+	for(i = 1; i &lt; argc; i++)
</a><a href="#h2-0-583" id="h2-0-583" class="i">+		if(!strcmp(argv[i], &quot;-b&quot;)) {
</a><a href="#h2-0-584" id="h2-0-584" class="i">+			bottom = True;
</a><a href="#h2-0-585" id="h2-0-585" class="i">+		}
</a><a href="#h2-0-586" id="h2-0-586" class="i">+		else if(!strcmp(argv[i], &quot;-fn&quot;)) {
</a><a href="#h2-0-587" id="h2-0-587" class="i">+			if(++i &lt; argc) font = argv[i];
</a><a href="#h2-0-588" id="h2-0-588" class="i">+		}
</a><a href="#h2-0-589" id="h2-0-589" class="i">+		else if(!strcmp(argv[i], &quot;-nb&quot;)) {
</a><a href="#h2-0-590" id="h2-0-590" class="i">+			if(++i &lt; argc) normbg = argv[i];
</a><a href="#h2-0-591" id="h2-0-591" class="i">+		}
</a><a href="#h2-0-592" id="h2-0-592" class="i">+		else if(!strcmp(argv[i], &quot;-nf&quot;)) {
</a><a href="#h2-0-593" id="h2-0-593" class="i">+			if(++i &lt; argc) normfg = argv[i];
</a><a href="#h2-0-594" id="h2-0-594" class="i">+		}
</a><a href="#h2-0-595" id="h2-0-595" class="i">+		else if(!strcmp(argv[i], &quot;-p&quot;)) {
</a><a href="#h2-0-596" id="h2-0-596" class="i">+			if(++i &lt; argc) prompt = argv[i];
</a><a href="#h2-0-597" id="h2-0-597" class="i">+		}
</a><a href="#h2-0-598" id="h2-0-598" class="i">+		else if(!strcmp(argv[i], &quot;-sb&quot;)) {
</a><a href="#h2-0-599" id="h2-0-599" class="i">+			if(++i &lt; argc) selbg = argv[i];
</a><a href="#h2-0-600" id="h2-0-600" class="i">+		}
</a><a href="#h2-0-601" id="h2-0-601" class="i">+		else if(!strcmp(argv[i], &quot;-sf&quot;)) {
</a><a href="#h2-0-602" id="h2-0-602" class="i">+			if(++i &lt; argc) selfg = argv[i];
</a><a href="#h2-0-603" id="h2-0-603" class="i">+		}
</a><a href="#h2-0-604" id="h2-0-604" class="i">+		else if(!strcmp(argv[i], &quot;-v&quot;))
</a><a href="#h2-0-605" id="h2-0-605" class="i">+			eprint(&quot;dmenu-&quot;VERSION&quot;, © 2006-2007 Anselm R. Garbe, Sander van Dijk\n&quot;);
</a><a href="#h2-0-606" id="h2-0-606" class="i">+		else
</a><a href="#h2-0-607" id="h2-0-607" class="i">+			usage();
</a><a href="#h2-0-608" id="h2-0-608" class="i">+	setlocale(LC_CTYPE, &quot;&quot;);
</a><a href="#h2-0-609" id="h2-0-609" class="i">+	dpy = XOpenDisplay(0);
</a><a href="#h2-0-610" id="h2-0-610" class="i">+	if(!dpy)
</a><a href="#h2-0-611" id="h2-0-611" class="i">+		eprint(&quot;dmenu: cannot open display\n&quot;);
</a><a href="#h2-0-612" id="h2-0-612" class="i">+	screen = DefaultScreen(dpy);
</a><a href="#h2-0-613" id="h2-0-613" class="i">+	root = RootWindow(dpy, screen);
</a><a href="#h2-0-614" id="h2-0-614" class="i">+	if(isatty(STDIN_FILENO)) {
</a><a href="#h2-0-615" id="h2-0-615" class="i">+		maxname = readstdin();
</a><a href="#h2-0-616" id="h2-0-616" class="i">+		running = grabkeyboard();
</a><a href="#h2-0-617" id="h2-0-617" class="i">+	}
</a><a href="#h2-0-618" id="h2-0-618" class="i">+	else { /* prevent keypress loss */
</a><a href="#h2-0-619" id="h2-0-619" class="i">+		running = grabkeyboard();
</a><a href="#h2-0-620" id="h2-0-620" class="i">+		maxname = readstdin();
</a><a href="#h2-0-621" id="h2-0-621" class="i">+	}
</a><a href="#h2-0-622" id="h2-0-622" class="i">+	/* init modifier map */
</a><a href="#h2-0-623" id="h2-0-623" class="i">+	modmap = XGetModifierMapping(dpy);
</a><a href="#h2-0-624" id="h2-0-624" class="i">+	for (i = 0; i &lt; 8; i++) {
</a><a href="#h2-0-625" id="h2-0-625" class="i">+		for (j = 0; j &lt; modmap-&gt;max_keypermod; j++) {
</a><a href="#h2-0-626" id="h2-0-626" class="i">+			if(modmap-&gt;modifiermap[i * modmap-&gt;max_keypermod + j]
</a><a href="#h2-0-627" id="h2-0-627" class="i">+			== XKeysymToKeycode(dpy, XK_Num_Lock))
</a><a href="#h2-0-628" id="h2-0-628" class="i">+				numlockmask = (1 &lt;&lt; i);
</a><a href="#h2-0-629" id="h2-0-629" class="i">+		}
</a><a href="#h2-0-630" id="h2-0-630" class="i">+	}
</a><a href="#h2-0-631" id="h2-0-631" class="i">+	XFreeModifiermap(modmap);
</a><a href="#h2-0-632" id="h2-0-632" class="i">+	/* style */
</a><a href="#h2-0-633" id="h2-0-633" class="i">+	dc.norm[ColBG] = getcolor(normbg);
</a><a href="#h2-0-634" id="h2-0-634" class="i">+	dc.norm[ColFG] = getcolor(normfg);
</a><a href="#h2-0-635" id="h2-0-635" class="i">+	dc.sel[ColBG] = getcolor(selbg);
</a><a href="#h2-0-636" id="h2-0-636" class="i">+	dc.sel[ColFG] = getcolor(selfg);
</a><a href="#h2-0-637" id="h2-0-637" class="i">+	initfont(font);
</a><a href="#h2-0-638" id="h2-0-638" class="i">+	/* menu window */
</a><a href="#h2-0-639" id="h2-0-639" class="i">+	wa.override_redirect = 1;
</a><a href="#h2-0-640" id="h2-0-640" class="i">+	wa.background_pixmap = ParentRelative;
</a><a href="#h2-0-641" id="h2-0-641" class="i">+	wa.event_mask = ExposureMask | ButtonPressMask | KeyPressMask;
</a><a href="#h2-0-642" id="h2-0-642" class="i">+	mw = DisplayWidth(dpy, screen);
</a><a href="#h2-0-643" id="h2-0-643" class="i">+	mh = dc.font.height + 2;
</a><a href="#h2-0-644" id="h2-0-644" class="i">+	win = XCreateWindow(dpy, root, 0,
</a><a href="#h2-0-645" id="h2-0-645" class="i">+			bottom ? DisplayHeight(dpy, screen) - mh : 0, mw, mh, 0,
</a><a href="#h2-0-646" id="h2-0-646" class="i">+			DefaultDepth(dpy, screen), CopyFromParent,
</a><a href="#h2-0-647" id="h2-0-647" class="i">+			DefaultVisual(dpy, screen),
</a><a href="#h2-0-648" id="h2-0-648" class="i">+			CWOverrideRedirect | CWBackPixmap | CWEventMask, &amp;wa);
</a><a href="#h2-0-649" id="h2-0-649" class="i">+	/* pixmap */
</a><a href="#h2-0-650" id="h2-0-650" class="i">+	dc.drawable = XCreatePixmap(dpy, root, mw, mh, DefaultDepth(dpy, screen));
</a><a href="#h2-0-651" id="h2-0-651" class="i">+	dc.gc = XCreateGC(dpy, root, 0, 0);
</a><a href="#h2-0-652" id="h2-0-652" class="i">+	XSetLineAttributes(dpy, dc.gc, 1, LineSolid, CapButt, JoinMiter);
</a><a href="#h2-0-653" id="h2-0-653" class="i">+	if(!dc.font.set)
</a><a href="#h2-0-654" id="h2-0-654" class="i">+		XSetFont(dpy, dc.gc, dc.font.xfont-&gt;fid);
</a><a href="#h2-0-655" id="h2-0-655" class="i">+	if(maxname)
</a><a href="#h2-0-656" id="h2-0-656" class="i">+		cmdw = textw(maxname);
</a><a href="#h2-0-657" id="h2-0-657" class="i">+	if(cmdw &gt; mw / 3)
</a><a href="#h2-0-658" id="h2-0-658" class="i">+		cmdw = mw / 3;
</a><a href="#h2-0-659" id="h2-0-659" class="i">+	if(prompt)
</a><a href="#h2-0-660" id="h2-0-660" class="i">+		promptw = textw(prompt);
</a><a href="#h2-0-661" id="h2-0-661" class="i">+	if(promptw &gt; mw / 5)
</a><a href="#h2-0-662" id="h2-0-662" class="i">+		promptw = mw / 5;
</a><a href="#h2-0-663" id="h2-0-663" class="i">+	text[0] = 0;
</a><a href="#h2-0-664" id="h2-0-664" class="i">+	match(text);
</a><a href="#h2-0-665" id="h2-0-665" class="i">+	XMapRaised(dpy, win);
</a><a href="#h2-0-666" id="h2-0-666" class="i">+	drawmenu();
</a><a href="#h2-0-667" id="h2-0-667" class="i">+	XSync(dpy, False);
</a><a href="#h2-0-668" id="h2-0-668" class="i">+
</a><a href="#h2-0-669" id="h2-0-669" class="i">+	/* main event loop */
</a><a href="#h2-0-670" id="h2-0-670" class="i">+	while(running &amp;&amp; !XNextEvent(dpy, &amp;ev))
</a><a href="#h2-0-671" id="h2-0-671" class="i">+		switch (ev.type) {
</a><a href="#h2-0-672" id="h2-0-672" class="i">+		default:	/* ignore all crap */
</a><a href="#h2-0-673" id="h2-0-673" class="i">+			break;
</a><a href="#h2-0-674" id="h2-0-674" class="i">+		case KeyPress:
</a><a href="#h2-0-675" id="h2-0-675" class="i">+			kpress(&amp;ev.xkey);
</a><a href="#h2-0-676" id="h2-0-676" class="i">+			break;
</a><a href="#h2-0-677" id="h2-0-677" class="i">+		case Expose:
</a><a href="#h2-0-678" id="h2-0-678" class="i">+			if(ev.xexpose.count == 0)
</a><a href="#h2-0-679" id="h2-0-679" class="i">+				drawmenu();
</a><a href="#h2-0-680" id="h2-0-680" class="i">+			break;
</a><a href="#h2-0-681" id="h2-0-681" class="i">+		}
</a><a href="#h2-0-682" id="h2-0-682" class="i">+
</a><a href="#h2-0-683" id="h2-0-683" class="i">+	/* cleanup */
</a><a href="#h2-0-684" id="h2-0-684" class="i">+	while(allitems) {
</a><a href="#h2-0-685" id="h2-0-685" class="i">+		itm = allitems-&gt;next;
</a><a href="#h2-0-686" id="h2-0-686" class="i">+		free(allitems-&gt;text);
</a><a href="#h2-0-687" id="h2-0-687" class="i">+		free(allitems);
</a><a href="#h2-0-688" id="h2-0-688" class="i">+		allitems = itm;
</a><a href="#h2-0-689" id="h2-0-689" class="i">+	}
</a><a href="#h2-0-690" id="h2-0-690" class="i">+	if(dc.font.set)
</a><a href="#h2-0-691" id="h2-0-691" class="i">+		XFreeFontSet(dpy, dc.font.set);
</a><a href="#h2-0-692" id="h2-0-692" class="i">+	else
</a><a href="#h2-0-693" id="h2-0-693" class="i">+		XFreeFont(dpy, dc.font.xfont);
</a><a href="#h2-0-694" id="h2-0-694" class="i">+	XFreePixmap(dpy, dc.drawable);
</a><a href="#h2-0-695" id="h2-0-695" class="i">+	XFreeGC(dpy, dc.gc);
</a><a href="#h2-0-696" id="h2-0-696" class="i">+	XDestroyWindow(dpy, win);
</a><a href="#h2-0-697" id="h2-0-697" class="i">+	XUngrabKeyboard(dpy, CurrentTime);
</a><a href="#h2-0-698" id="h2-0-698" class="i">+	XCloseDisplay(dpy);
</a><a href="#h2-0-699" id="h2-0-699" class="i">+	return ret;
</a><a href="#h2-0-700" id="h2-0-700" class="i">+}
</a><b>diff --git a/<a id="h3" href="../file/dmenu.h.html">dmenu.h</a> b/<a href="../file/dmenu.h.html">dmenu.h</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,41 +0,0 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-/* See LICENSE file for copyright and license details. */
</a><a href="#h3-0-1" id="h3-0-1" class="d">-#include &lt;X11/Xlib.h&gt;
</a><a href="#h3-0-2" id="h3-0-2" class="d">-
</a><a href="#h3-0-3" id="h3-0-3" class="d">-#define FONT			&quot;-*-fixed-medium-r-normal-*-13-*-*-*-*-*-*-*&quot;
</a><a href="#h3-0-4" id="h3-0-4" class="d">-#define NORMBGCOLOR		&quot;#eeeeee&quot;
</a><a href="#h3-0-5" id="h3-0-5" class="d">-#define NORMFGCOLOR		&quot;#222222&quot;
</a><a href="#h3-0-6" id="h3-0-6" class="d">-#define SELBGCOLOR		&quot;#006699&quot;
</a><a href="#h3-0-7" id="h3-0-7" class="d">-#define SELFGCOLOR		&quot;#ffffff&quot;
</a><a href="#h3-0-8" id="h3-0-8" class="d">-#define SPACE			30 /* px */
</a><a href="#h3-0-9" id="h3-0-9" class="d">-
</a><a href="#h3-0-10" id="h3-0-10" class="d">-/* color */
</a><a href="#h3-0-11" id="h3-0-11" class="d">-enum { ColFG, ColBG, ColLast };
</a><a href="#h3-0-12" id="h3-0-12" class="d">-
</a><a href="#h3-0-13" id="h3-0-13" class="d">-typedef struct {
</a><a href="#h3-0-14" id="h3-0-14" class="d">-	int x, y, w, h;
</a><a href="#h3-0-15" id="h3-0-15" class="d">-	unsigned long norm[ColLast];
</a><a href="#h3-0-16" id="h3-0-16" class="d">-	unsigned long sel[ColLast];
</a><a href="#h3-0-17" id="h3-0-17" class="d">-	Drawable drawable;
</a><a href="#h3-0-18" id="h3-0-18" class="d">-	GC gc;
</a><a href="#h3-0-19" id="h3-0-19" class="d">-	struct {
</a><a href="#h3-0-20" id="h3-0-20" class="d">-		XFontStruct *xfont;
</a><a href="#h3-0-21" id="h3-0-21" class="d">-		XFontSet set;
</a><a href="#h3-0-22" id="h3-0-22" class="d">-		int ascent;
</a><a href="#h3-0-23" id="h3-0-23" class="d">-		int descent;
</a><a href="#h3-0-24" id="h3-0-24" class="d">-		int height;
</a><a href="#h3-0-25" id="h3-0-25" class="d">-	} font;
</a><a href="#h3-0-26" id="h3-0-26" class="d">-} DC; /* draw context */
</a><a href="#h3-0-27" id="h3-0-27" class="d">-
</a><a href="#h3-0-28" id="h3-0-28" class="d">-extern int screen;
</a><a href="#h3-0-29" id="h3-0-29" class="d">-extern Display *dpy;
</a><a href="#h3-0-30" id="h3-0-30" class="d">-extern DC dc;				/* global drawing context */
</a><a href="#h3-0-31" id="h3-0-31" class="d">-
</a><a href="#h3-0-32" id="h3-0-32" class="d">-/* draw.c */
</a><a href="#h3-0-33" id="h3-0-33" class="d">-void drawtext(const char *text, unsigned long col[ColLast]);
</a><a href="#h3-0-34" id="h3-0-34" class="d">-unsigned int textw(const char *text);
</a><a href="#h3-0-35" id="h3-0-35" class="d">-unsigned int textnw(const char *text, unsigned int len);
</a><a href="#h3-0-36" id="h3-0-36" class="d">-
</a><a href="#h3-0-37" id="h3-0-37" class="d">-/* util.c */
</a><a href="#h3-0-38" id="h3-0-38" class="d">-void *emalloc(unsigned int size);	/* allocates memory, exits on error */
</a><a href="#h3-0-39" id="h3-0-39" class="d">-void eprint(const char *errstr, ...);	/* prints errstr and exits with 1 */
</a><a href="#h3-0-40" id="h3-0-40" class="d">-char *estrdup(const char *str);		/* duplicates str, exits on allocation error */
</a><b>diff --git a/<a id="h4" href="../file/draw.c.html">draw.c</a> b/<a href="../file/draw.c.html">draw.c</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,61 +0,0 @@
</a><a href="#h4-0-0" id="h4-0-0" class="d">-/* See LICENSE file for copyright and license details. */
</a><a href="#h4-0-1" id="h4-0-1" class="d">-#include &quot;dmenu.h&quot;
</a><a href="#h4-0-2" id="h4-0-2" class="d">-#include &lt;string.h&gt;
</a><a href="#h4-0-3" id="h4-0-3" class="d">-
</a><a href="#h4-0-4" id="h4-0-4" class="d">-/* extern */
</a><a href="#h4-0-5" id="h4-0-5" class="d">-
</a><a href="#h4-0-6" id="h4-0-6" class="d">-void
</a><a href="#h4-0-7" id="h4-0-7" class="d">-drawtext(const char *text, unsigned long col[ColLast]) {
</a><a href="#h4-0-8" id="h4-0-8" class="d">-	int x, y, w, h;
</a><a href="#h4-0-9" id="h4-0-9" class="d">-	static char buf[256];
</a><a href="#h4-0-10" id="h4-0-10" class="d">-	unsigned int len, olen;
</a><a href="#h4-0-11" id="h4-0-11" class="d">-	XRectangle r = { dc.x, dc.y, dc.w, dc.h };
</a><a href="#h4-0-12" id="h4-0-12" class="d">-
</a><a href="#h4-0-13" id="h4-0-13" class="d">-	XSetForeground(dpy, dc.gc, col[ColBG]);
</a><a href="#h4-0-14" id="h4-0-14" class="d">-	XFillRectangles(dpy, dc.drawable, dc.gc, &amp;r, 1);
</a><a href="#h4-0-15" id="h4-0-15" class="d">-	if(!text)
</a><a href="#h4-0-16" id="h4-0-16" class="d">-		return;
</a><a href="#h4-0-17" id="h4-0-17" class="d">-	w = 0;
</a><a href="#h4-0-18" id="h4-0-18" class="d">-	olen = len = strlen(text);
</a><a href="#h4-0-19" id="h4-0-19" class="d">-	if(len &gt;= sizeof buf)
</a><a href="#h4-0-20" id="h4-0-20" class="d">-		len = sizeof buf - 1;
</a><a href="#h4-0-21" id="h4-0-21" class="d">-	memcpy(buf, text, len);
</a><a href="#h4-0-22" id="h4-0-22" class="d">-	buf[len] = 0;
</a><a href="#h4-0-23" id="h4-0-23" class="d">-	h = dc.font.ascent + dc.font.descent;
</a><a href="#h4-0-24" id="h4-0-24" class="d">-	y = dc.y + (dc.h / 2) - (h / 2) + dc.font.ascent;
</a><a href="#h4-0-25" id="h4-0-25" class="d">-	x = dc.x + (h / 2);
</a><a href="#h4-0-26" id="h4-0-26" class="d">-	/* shorten text if necessary */
</a><a href="#h4-0-27" id="h4-0-27" class="d">-	while(len &amp;&amp; (w = textnw(buf, len)) &gt; dc.w - h)
</a><a href="#h4-0-28" id="h4-0-28" class="d">-		buf[--len] = 0;
</a><a href="#h4-0-29" id="h4-0-29" class="d">-	if(len &lt; olen) {
</a><a href="#h4-0-30" id="h4-0-30" class="d">-		if(len &gt; 1)
</a><a href="#h4-0-31" id="h4-0-31" class="d">-			buf[len - 1] = &#39;.&#39;;
</a><a href="#h4-0-32" id="h4-0-32" class="d">-		if(len &gt; 2)
</a><a href="#h4-0-33" id="h4-0-33" class="d">-			buf[len - 2] = &#39;.&#39;;
</a><a href="#h4-0-34" id="h4-0-34" class="d">-		if(len &gt; 3)
</a><a href="#h4-0-35" id="h4-0-35" class="d">-			buf[len - 3] = &#39;.&#39;;
</a><a href="#h4-0-36" id="h4-0-36" class="d">-	}
</a><a href="#h4-0-37" id="h4-0-37" class="d">-	if(w &gt; dc.w)
</a><a href="#h4-0-38" id="h4-0-38" class="d">-		return; /* too long */
</a><a href="#h4-0-39" id="h4-0-39" class="d">-	XSetForeground(dpy, dc.gc, col[ColFG]);
</a><a href="#h4-0-40" id="h4-0-40" class="d">-	if(dc.font.set)
</a><a href="#h4-0-41" id="h4-0-41" class="d">-		XmbDrawString(dpy, dc.drawable, dc.font.set, dc.gc, x, y, buf, len);
</a><a href="#h4-0-42" id="h4-0-42" class="d">-	else
</a><a href="#h4-0-43" id="h4-0-43" class="d">-		XDrawString(dpy, dc.drawable, dc.gc, x, y, buf, len);
</a><a href="#h4-0-44" id="h4-0-44" class="d">-}
</a><a href="#h4-0-45" id="h4-0-45" class="d">-
</a><a href="#h4-0-46" id="h4-0-46" class="d">-unsigned int
</a><a href="#h4-0-47" id="h4-0-47" class="d">-textw(const char *text) {
</a><a href="#h4-0-48" id="h4-0-48" class="d">-	return textnw(text, strlen(text)) + dc.font.height;
</a><a href="#h4-0-49" id="h4-0-49" class="d">-}
</a><a href="#h4-0-50" id="h4-0-50" class="d">-
</a><a href="#h4-0-51" id="h4-0-51" class="d">-unsigned int
</a><a href="#h4-0-52" id="h4-0-52" class="d">-textnw(const char *text, unsigned int len) {
</a><a href="#h4-0-53" id="h4-0-53" class="d">-	XRectangle r;
</a><a href="#h4-0-54" id="h4-0-54" class="d">-
</a><a href="#h4-0-55" id="h4-0-55" class="d">-	if(dc.font.set) {
</a><a href="#h4-0-56" id="h4-0-56" class="d">-		XmbTextExtents(dc.font.set, text, len, NULL, &amp;r);
</a><a href="#h4-0-57" id="h4-0-57" class="d">-		return r.width;
</a><a href="#h4-0-58" id="h4-0-58" class="d">-	}
</a><a href="#h4-0-59" id="h4-0-59" class="d">-	return XTextWidth(dc.font.xfont, text, len);
</a><a href="#h4-0-60" id="h4-0-60" class="d">-}
</a><b>diff --git a/<a id="h5" href="../file/main.c.html">main.c</a> b/<a href="../file/main.c.html">main.c</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,578 +0,0 @@
</a><a href="#h5-0-0" id="h5-0-0" class="d">-/* See LICENSE file for copyright and license details. */
</a><a href="#h5-0-1" id="h5-0-1" class="d">-#include &quot;dmenu.h&quot;
</a><a href="#h5-0-2" id="h5-0-2" class="d">-#include &lt;ctype.h&gt;
</a><a href="#h5-0-3" id="h5-0-3" class="d">-#include &lt;locale.h&gt;
</a><a href="#h5-0-4" id="h5-0-4" class="d">-#include &lt;stdlib.h&gt;
</a><a href="#h5-0-5" id="h5-0-5" class="d">-#include &lt;stdio.h&gt;
</a><a href="#h5-0-6" id="h5-0-6" class="d">-#include &lt;string.h&gt;
</a><a href="#h5-0-7" id="h5-0-7" class="d">-#include &lt;unistd.h&gt;
</a><a href="#h5-0-8" id="h5-0-8" class="d">-#include &lt;X11/Xutil.h&gt;
</a><a href="#h5-0-9" id="h5-0-9" class="d">-#include &lt;X11/keysym.h&gt;
</a><a href="#h5-0-10" id="h5-0-10" class="d">-
</a><a href="#h5-0-11" id="h5-0-11" class="d">-#define CLEANMASK(mask) (mask &amp; ~(numlockmask | LockMask))
</a><a href="#h5-0-12" id="h5-0-12" class="d">-
</a><a href="#h5-0-13" id="h5-0-13" class="d">-typedef struct Item Item;
</a><a href="#h5-0-14" id="h5-0-14" class="d">-struct Item {
</a><a href="#h5-0-15" id="h5-0-15" class="d">-	Item *next;		/* traverses all items */
</a><a href="#h5-0-16" id="h5-0-16" class="d">-	Item *left, *right;	/* traverses items matching current search pattern */
</a><a href="#h5-0-17" id="h5-0-17" class="d">-	char *text;
</a><a href="#h5-0-18" id="h5-0-18" class="d">-};
</a><a href="#h5-0-19" id="h5-0-19" class="d">-
</a><a href="#h5-0-20" id="h5-0-20" class="d">-/* static */
</a><a href="#h5-0-21" id="h5-0-21" class="d">-
</a><a href="#h5-0-22" id="h5-0-22" class="d">-static char text[4096];
</a><a href="#h5-0-23" id="h5-0-23" class="d">-static char *prompt = NULL;
</a><a href="#h5-0-24" id="h5-0-24" class="d">-static int mw, mh;
</a><a href="#h5-0-25" id="h5-0-25" class="d">-static int ret = 0;
</a><a href="#h5-0-26" id="h5-0-26" class="d">-static int nitem = 0;
</a><a href="#h5-0-27" id="h5-0-27" class="d">-static unsigned int cmdw = 0;
</a><a href="#h5-0-28" id="h5-0-28" class="d">-static unsigned int promptw = 0;
</a><a href="#h5-0-29" id="h5-0-29" class="d">-static unsigned int numlockmask = 0;
</a><a href="#h5-0-30" id="h5-0-30" class="d">-static Bool running = True;
</a><a href="#h5-0-31" id="h5-0-31" class="d">-static Item *allitems = NULL;	/* first of all items */
</a><a href="#h5-0-32" id="h5-0-32" class="d">-static Item *item = NULL;	/* first of pattern matching items */
</a><a href="#h5-0-33" id="h5-0-33" class="d">-static Item *sel = NULL;
</a><a href="#h5-0-34" id="h5-0-34" class="d">-static Item *next = NULL;
</a><a href="#h5-0-35" id="h5-0-35" class="d">-static Item *prev = NULL;
</a><a href="#h5-0-36" id="h5-0-36" class="d">-static Item *curr = NULL;
</a><a href="#h5-0-37" id="h5-0-37" class="d">-static Window root;
</a><a href="#h5-0-38" id="h5-0-38" class="d">-static Window win;
</a><a href="#h5-0-39" id="h5-0-39" class="d">-
</a><a href="#h5-0-40" id="h5-0-40" class="d">-static void
</a><a href="#h5-0-41" id="h5-0-41" class="d">-calcoffsets(void) {
</a><a href="#h5-0-42" id="h5-0-42" class="d">-	unsigned int tw, w;
</a><a href="#h5-0-43" id="h5-0-43" class="d">-
</a><a href="#h5-0-44" id="h5-0-44" class="d">-	if(!curr)
</a><a href="#h5-0-45" id="h5-0-45" class="d">-		return;
</a><a href="#h5-0-46" id="h5-0-46" class="d">-	w = promptw + cmdw + 2 * SPACE;
</a><a href="#h5-0-47" id="h5-0-47" class="d">-	for(next = curr; next; next=next-&gt;right) {
</a><a href="#h5-0-48" id="h5-0-48" class="d">-		tw = textw(next-&gt;text);
</a><a href="#h5-0-49" id="h5-0-49" class="d">-		if(tw &gt; mw / 3)
</a><a href="#h5-0-50" id="h5-0-50" class="d">-			tw = mw / 3;
</a><a href="#h5-0-51" id="h5-0-51" class="d">-		w += tw;
</a><a href="#h5-0-52" id="h5-0-52" class="d">-		if(w &gt; mw)
</a><a href="#h5-0-53" id="h5-0-53" class="d">-			break;
</a><a href="#h5-0-54" id="h5-0-54" class="d">-	}
</a><a href="#h5-0-55" id="h5-0-55" class="d">-	w = promptw + cmdw + 2 * SPACE;
</a><a href="#h5-0-56" id="h5-0-56" class="d">-	for(prev = curr; prev &amp;&amp; prev-&gt;left; prev=prev-&gt;left) {
</a><a href="#h5-0-57" id="h5-0-57" class="d">-		tw = textw(prev-&gt;left-&gt;text);
</a><a href="#h5-0-58" id="h5-0-58" class="d">-		if(tw &gt; mw / 3)
</a><a href="#h5-0-59" id="h5-0-59" class="d">-			tw = mw / 3;
</a><a href="#h5-0-60" id="h5-0-60" class="d">-		w += tw;
</a><a href="#h5-0-61" id="h5-0-61" class="d">-		if(w &gt; mw)
</a><a href="#h5-0-62" id="h5-0-62" class="d">-			break;
</a><a href="#h5-0-63" id="h5-0-63" class="d">-	}
</a><a href="#h5-0-64" id="h5-0-64" class="d">-}
</a><a href="#h5-0-65" id="h5-0-65" class="d">-
</a><a href="#h5-0-66" id="h5-0-66" class="d">-static void
</a><a href="#h5-0-67" id="h5-0-67" class="d">-drawmenu(void) {
</a><a href="#h5-0-68" id="h5-0-68" class="d">-	Item *i;
</a><a href="#h5-0-69" id="h5-0-69" class="d">-
</a><a href="#h5-0-70" id="h5-0-70" class="d">-	dc.x = 0;
</a><a href="#h5-0-71" id="h5-0-71" class="d">-	dc.y = 0;
</a><a href="#h5-0-72" id="h5-0-72" class="d">-	dc.w = mw;
</a><a href="#h5-0-73" id="h5-0-73" class="d">-	dc.h = mh;
</a><a href="#h5-0-74" id="h5-0-74" class="d">-	drawtext(NULL, dc.norm);
</a><a href="#h5-0-75" id="h5-0-75" class="d">-	/* print prompt? */
</a><a href="#h5-0-76" id="h5-0-76" class="d">-	if(promptw) {
</a><a href="#h5-0-77" id="h5-0-77" class="d">-		dc.w = promptw;
</a><a href="#h5-0-78" id="h5-0-78" class="d">-		drawtext(prompt, dc.sel);
</a><a href="#h5-0-79" id="h5-0-79" class="d">-	}
</a><a href="#h5-0-80" id="h5-0-80" class="d">-	dc.x += promptw;
</a><a href="#h5-0-81" id="h5-0-81" class="d">-	dc.w = mw - promptw;
</a><a href="#h5-0-82" id="h5-0-82" class="d">-	/* print command */
</a><a href="#h5-0-83" id="h5-0-83" class="d">-	if(cmdw &amp;&amp; item)
</a><a href="#h5-0-84" id="h5-0-84" class="d">-		dc.w = cmdw;
</a><a href="#h5-0-85" id="h5-0-85" class="d">-	drawtext(text[0] ? text : NULL, dc.norm);
</a><a href="#h5-0-86" id="h5-0-86" class="d">-	dc.x += cmdw;
</a><a href="#h5-0-87" id="h5-0-87" class="d">-	if(curr) {
</a><a href="#h5-0-88" id="h5-0-88" class="d">-		dc.w = SPACE;
</a><a href="#h5-0-89" id="h5-0-89" class="d">-		drawtext((curr &amp;&amp; curr-&gt;left) ? &quot;&lt;&quot; : NULL, dc.norm);
</a><a href="#h5-0-90" id="h5-0-90" class="d">-		dc.x += dc.w;
</a><a href="#h5-0-91" id="h5-0-91" class="d">-		/* determine maximum items */
</a><a href="#h5-0-92" id="h5-0-92" class="d">-		for(i = curr; i != next; i=i-&gt;right) {
</a><a href="#h5-0-93" id="h5-0-93" class="d">-			dc.w = textw(i-&gt;text);
</a><a href="#h5-0-94" id="h5-0-94" class="d">-			if(dc.w &gt; mw / 3)
</a><a href="#h5-0-95" id="h5-0-95" class="d">-				dc.w = mw / 3;
</a><a href="#h5-0-96" id="h5-0-96" class="d">-			drawtext(i-&gt;text, (sel == i) ? dc.sel : dc.norm);
</a><a href="#h5-0-97" id="h5-0-97" class="d">-			dc.x += dc.w;
</a><a href="#h5-0-98" id="h5-0-98" class="d">-		}
</a><a href="#h5-0-99" id="h5-0-99" class="d">-		dc.x = mw - SPACE;
</a><a href="#h5-0-100" id="h5-0-100" class="d">-		dc.w = SPACE;
</a><a href="#h5-0-101" id="h5-0-101" class="d">-		drawtext(next ? &quot;&gt;&quot; : NULL, dc.norm);
</a><a href="#h5-0-102" id="h5-0-102" class="d">-	}
</a><a href="#h5-0-103" id="h5-0-103" class="d">-	XCopyArea(dpy, dc.drawable, win, dc.gc, 0, 0, mw, mh, 0, 0);
</a><a href="#h5-0-104" id="h5-0-104" class="d">-	XFlush(dpy);
</a><a href="#h5-0-105" id="h5-0-105" class="d">-}
</a><a href="#h5-0-106" id="h5-0-106" class="d">-
</a><a href="#h5-0-107" id="h5-0-107" class="d">-static Bool
</a><a href="#h5-0-108" id="h5-0-108" class="d">-grabkeyboard(void) {
</a><a href="#h5-0-109" id="h5-0-109" class="d">-	unsigned int len;
</a><a href="#h5-0-110" id="h5-0-110" class="d">-
</a><a href="#h5-0-111" id="h5-0-111" class="d">-	for(len = 1000; len; len--) {
</a><a href="#h5-0-112" id="h5-0-112" class="d">-		if(XGrabKeyboard(dpy, root, True, GrabModeAsync, GrabModeAsync, CurrentTime)
</a><a href="#h5-0-113" id="h5-0-113" class="d">-			== GrabSuccess)
</a><a href="#h5-0-114" id="h5-0-114" class="d">-			break;
</a><a href="#h5-0-115" id="h5-0-115" class="d">-		usleep(1000);
</a><a href="#h5-0-116" id="h5-0-116" class="d">-	}
</a><a href="#h5-0-117" id="h5-0-117" class="d">-	return len &gt; 0;
</a><a href="#h5-0-118" id="h5-0-118" class="d">-}
</a><a href="#h5-0-119" id="h5-0-119" class="d">-
</a><a href="#h5-0-120" id="h5-0-120" class="d">-static unsigned long
</a><a href="#h5-0-121" id="h5-0-121" class="d">-initcolor(const char *colstr) {
</a><a href="#h5-0-122" id="h5-0-122" class="d">-	Colormap cmap = DefaultColormap(dpy, screen);
</a><a href="#h5-0-123" id="h5-0-123" class="d">-	XColor color;
</a><a href="#h5-0-124" id="h5-0-124" class="d">-
</a><a href="#h5-0-125" id="h5-0-125" class="d">-	if(!XAllocNamedColor(dpy, cmap, colstr, &amp;color, &amp;color))
</a><a href="#h5-0-126" id="h5-0-126" class="d">-		eprint(&quot;error, cannot allocate color &#39;%s&#39;\n&quot;, colstr);
</a><a href="#h5-0-127" id="h5-0-127" class="d">-	return color.pixel;
</a><a href="#h5-0-128" id="h5-0-128" class="d">-}
</a><a href="#h5-0-129" id="h5-0-129" class="d">-
</a><a href="#h5-0-130" id="h5-0-130" class="d">-static void
</a><a href="#h5-0-131" id="h5-0-131" class="d">-initfont(const char *fontstr) {
</a><a href="#h5-0-132" id="h5-0-132" class="d">-	char *def, **missing;
</a><a href="#h5-0-133" id="h5-0-133" class="d">-	int i, n;
</a><a href="#h5-0-134" id="h5-0-134" class="d">-
</a><a href="#h5-0-135" id="h5-0-135" class="d">-	if(!fontstr || fontstr[0] == &#39;\0&#39;)
</a><a href="#h5-0-136" id="h5-0-136" class="d">-		eprint(&quot;error, cannot load font: &#39;%s&#39;\n&quot;, fontstr);
</a><a href="#h5-0-137" id="h5-0-137" class="d">-	missing = NULL;
</a><a href="#h5-0-138" id="h5-0-138" class="d">-	if(dc.font.set)
</a><a href="#h5-0-139" id="h5-0-139" class="d">-		XFreeFontSet(dpy, dc.font.set);
</a><a href="#h5-0-140" id="h5-0-140" class="d">-	dc.font.set = XCreateFontSet(dpy, fontstr, &amp;missing, &amp;n, &amp;def);
</a><a href="#h5-0-141" id="h5-0-141" class="d">-	if(missing)
</a><a href="#h5-0-142" id="h5-0-142" class="d">-		XFreeStringList(missing);
</a><a href="#h5-0-143" id="h5-0-143" class="d">-	if(dc.font.set) {
</a><a href="#h5-0-144" id="h5-0-144" class="d">-		XFontSetExtents *font_extents;
</a><a href="#h5-0-145" id="h5-0-145" class="d">-		XFontStruct **xfonts;
</a><a href="#h5-0-146" id="h5-0-146" class="d">-		char **font_names;
</a><a href="#h5-0-147" id="h5-0-147" class="d">-		dc.font.ascent = dc.font.descent = 0;
</a><a href="#h5-0-148" id="h5-0-148" class="d">-		font_extents = XExtentsOfFontSet(dc.font.set);
</a><a href="#h5-0-149" id="h5-0-149" class="d">-		n = XFontsOfFontSet(dc.font.set, &amp;xfonts, &amp;font_names);
</a><a href="#h5-0-150" id="h5-0-150" class="d">-		for(i = 0, dc.font.ascent = 0, dc.font.descent = 0; i &lt; n; i++) {
</a><a href="#h5-0-151" id="h5-0-151" class="d">-			if(dc.font.ascent &lt; (*xfonts)-&gt;ascent)
</a><a href="#h5-0-152" id="h5-0-152" class="d">-				dc.font.ascent = (*xfonts)-&gt;ascent;
</a><a href="#h5-0-153" id="h5-0-153" class="d">-			if(dc.font.descent &lt; (*xfonts)-&gt;descent)
</a><a href="#h5-0-154" id="h5-0-154" class="d">-				dc.font.descent = (*xfonts)-&gt;descent;
</a><a href="#h5-0-155" id="h5-0-155" class="d">-			xfonts++;
</a><a href="#h5-0-156" id="h5-0-156" class="d">-		}
</a><a href="#h5-0-157" id="h5-0-157" class="d">-	}
</a><a href="#h5-0-158" id="h5-0-158" class="d">-	else {
</a><a href="#h5-0-159" id="h5-0-159" class="d">-		if(dc.font.xfont)
</a><a href="#h5-0-160" id="h5-0-160" class="d">-			XFreeFont(dpy, dc.font.xfont);
</a><a href="#h5-0-161" id="h5-0-161" class="d">-		dc.font.xfont = NULL;
</a><a href="#h5-0-162" id="h5-0-162" class="d">-		if(!(dc.font.xfont = XLoadQueryFont(dpy, fontstr))) {
</a><a href="#h5-0-163" id="h5-0-163" class="d">-			if(!(dc.font.xfont = XLoadQueryFont(dpy, &quot;fixed&quot;)))
</a><a href="#h5-0-164" id="h5-0-164" class="d">-				eprint(&quot;error, cannot load font: &#39;%s&#39;\n&quot;, fontstr);
</a><a href="#h5-0-165" id="h5-0-165" class="d">-		}
</a><a href="#h5-0-166" id="h5-0-166" class="d">-		dc.font.ascent = dc.font.xfont-&gt;ascent;
</a><a href="#h5-0-167" id="h5-0-167" class="d">-		dc.font.descent = dc.font.xfont-&gt;descent;
</a><a href="#h5-0-168" id="h5-0-168" class="d">-	}
</a><a href="#h5-0-169" id="h5-0-169" class="d">-	dc.font.height = dc.font.ascent + dc.font.descent;
</a><a href="#h5-0-170" id="h5-0-170" class="d">-}
</a><a href="#h5-0-171" id="h5-0-171" class="d">-
</a><a href="#h5-0-172" id="h5-0-172" class="d">-static int
</a><a href="#h5-0-173" id="h5-0-173" class="d">-strido(const char *text, const char *pattern) {
</a><a href="#h5-0-174" id="h5-0-174" class="d">-	for(; *text &amp;&amp; *pattern; text++)
</a><a href="#h5-0-175" id="h5-0-175" class="d">-		if (*text == *pattern)
</a><a href="#h5-0-176" id="h5-0-176" class="d">-			pattern++;
</a><a href="#h5-0-177" id="h5-0-177" class="d">-	return !*pattern;
</a><a href="#h5-0-178" id="h5-0-178" class="d">-}                                  
</a><a href="#h5-0-179" id="h5-0-179" class="d">-
</a><a href="#h5-0-180" id="h5-0-180" class="d">-static void
</a><a href="#h5-0-181" id="h5-0-181" class="d">-match(char *pattern) {
</a><a href="#h5-0-182" id="h5-0-182" class="d">-	unsigned int plen;
</a><a href="#h5-0-183" id="h5-0-183" class="d">-	Item *i, *j;
</a><a href="#h5-0-184" id="h5-0-184" class="d">-
</a><a href="#h5-0-185" id="h5-0-185" class="d">-	if(!pattern)
</a><a href="#h5-0-186" id="h5-0-186" class="d">-		return;
</a><a href="#h5-0-187" id="h5-0-187" class="d">-	plen = strlen(pattern);
</a><a href="#h5-0-188" id="h5-0-188" class="d">-	item = j = NULL;
</a><a href="#h5-0-189" id="h5-0-189" class="d">-	nitem = 0;
</a><a href="#h5-0-190" id="h5-0-190" class="d">-	for(i = allitems; i; i=i-&gt;next)
</a><a href="#h5-0-191" id="h5-0-191" class="d">-		if(!plen || !strncmp(pattern, i-&gt;text, plen)) {
</a><a href="#h5-0-192" id="h5-0-192" class="d">-			if(!j)
</a><a href="#h5-0-193" id="h5-0-193" class="d">-				item = i;
</a><a href="#h5-0-194" id="h5-0-194" class="d">-			else
</a><a href="#h5-0-195" id="h5-0-195" class="d">-				j-&gt;right = i;
</a><a href="#h5-0-196" id="h5-0-196" class="d">-			i-&gt;left = j;
</a><a href="#h5-0-197" id="h5-0-197" class="d">-			i-&gt;right = NULL;
</a><a href="#h5-0-198" id="h5-0-198" class="d">-			j = i;
</a><a href="#h5-0-199" id="h5-0-199" class="d">-			nitem++;
</a><a href="#h5-0-200" id="h5-0-200" class="d">-		}
</a><a href="#h5-0-201" id="h5-0-201" class="d">-	for(i = allitems; i; i=i-&gt;next)
</a><a href="#h5-0-202" id="h5-0-202" class="d">-		if(plen &amp;&amp; strncmp(pattern, i-&gt;text, plen)
</a><a href="#h5-0-203" id="h5-0-203" class="d">-				&amp;&amp; strstr(i-&gt;text, pattern)) {
</a><a href="#h5-0-204" id="h5-0-204" class="d">-			if(!j)                               
</a><a href="#h5-0-205" id="h5-0-205" class="d">-				item = i;                              
</a><a href="#h5-0-206" id="h5-0-206" class="d">-			else                                     
</a><a href="#h5-0-207" id="h5-0-207" class="d">-				j-&gt;right = i;                          
</a><a href="#h5-0-208" id="h5-0-208" class="d">-			i-&gt;left = j;      
</a><a href="#h5-0-209" id="h5-0-209" class="d">-			i-&gt;right = NULL;                         
</a><a href="#h5-0-210" id="h5-0-210" class="d">-			j = i;                                      
</a><a href="#h5-0-211" id="h5-0-211" class="d">-			nitem++;                                       
</a><a href="#h5-0-212" id="h5-0-212" class="d">-		}                                              
</a><a href="#h5-0-213" id="h5-0-213" class="d">-	for(i = allitems; i; i=i-&gt;next)                            
</a><a href="#h5-0-214" id="h5-0-214" class="d">-		if(plen &amp;&amp; strncmp(pattern, i-&gt;text, plen)             
</a><a href="#h5-0-215" id="h5-0-215" class="d">-				&amp;&amp; !strstr(i-&gt;text, pattern)          
</a><a href="#h5-0-216" id="h5-0-216" class="d">-				&amp;&amp; strido(i-&gt;text,pattern)) { 
</a><a href="#h5-0-217" id="h5-0-217" class="d">-			if(!j)
</a><a href="#h5-0-218" id="h5-0-218" class="d">-				item = i;
</a><a href="#h5-0-219" id="h5-0-219" class="d">-			else
</a><a href="#h5-0-220" id="h5-0-220" class="d">-				j-&gt;right = i;
</a><a href="#h5-0-221" id="h5-0-221" class="d">-			i-&gt;left = j;
</a><a href="#h5-0-222" id="h5-0-222" class="d">-			i-&gt;right = NULL;
</a><a href="#h5-0-223" id="h5-0-223" class="d">-			j = i;
</a><a href="#h5-0-224" id="h5-0-224" class="d">-			nitem++;
</a><a href="#h5-0-225" id="h5-0-225" class="d">-		}
</a><a href="#h5-0-226" id="h5-0-226" class="d">-	curr = prev = next = sel = item;
</a><a href="#h5-0-227" id="h5-0-227" class="d">-	calcoffsets();
</a><a href="#h5-0-228" id="h5-0-228" class="d">-}
</a><a href="#h5-0-229" id="h5-0-229" class="d">-
</a><a href="#h5-0-230" id="h5-0-230" class="d">-static void
</a><a href="#h5-0-231" id="h5-0-231" class="d">-kpress(XKeyEvent * e) {
</a><a href="#h5-0-232" id="h5-0-232" class="d">-	char buf[32];
</a><a href="#h5-0-233" id="h5-0-233" class="d">-	int i, num;
</a><a href="#h5-0-234" id="h5-0-234" class="d">-	unsigned int len;
</a><a href="#h5-0-235" id="h5-0-235" class="d">-	KeySym ksym;
</a><a href="#h5-0-236" id="h5-0-236" class="d">-
</a><a href="#h5-0-237" id="h5-0-237" class="d">-	len = strlen(text);
</a><a href="#h5-0-238" id="h5-0-238" class="d">-	buf[0] = 0;
</a><a href="#h5-0-239" id="h5-0-239" class="d">-	num = XLookupString(e, buf, sizeof buf, &amp;ksym, 0);
</a><a href="#h5-0-240" id="h5-0-240" class="d">-	if(IsKeypadKey(ksym)) { 
</a><a href="#h5-0-241" id="h5-0-241" class="d">-		if(ksym == XK_KP_Enter) {
</a><a href="#h5-0-242" id="h5-0-242" class="d">-			ksym = XK_Return;
</a><a href="#h5-0-243" id="h5-0-243" class="d">-		} else if(ksym &gt;= XK_KP_0 &amp;&amp; ksym &lt;= XK_KP_9) {
</a><a href="#h5-0-244" id="h5-0-244" class="d">-			ksym = (ksym - XK_KP_0) + XK_0;
</a><a href="#h5-0-245" id="h5-0-245" class="d">-		}
</a><a href="#h5-0-246" id="h5-0-246" class="d">-	}
</a><a href="#h5-0-247" id="h5-0-247" class="d">-	if(IsFunctionKey(ksym) || IsKeypadKey(ksym)
</a><a href="#h5-0-248" id="h5-0-248" class="d">-			|| IsMiscFunctionKey(ksym) || IsPFKey(ksym)
</a><a href="#h5-0-249" id="h5-0-249" class="d">-			|| IsPrivateKeypadKey(ksym))
</a><a href="#h5-0-250" id="h5-0-250" class="d">-		return;
</a><a href="#h5-0-251" id="h5-0-251" class="d">-	/* first check if a control mask is omitted */
</a><a href="#h5-0-252" id="h5-0-252" class="d">-	if(e-&gt;state &amp; ControlMask) {
</a><a href="#h5-0-253" id="h5-0-253" class="d">-		switch (ksym) {
</a><a href="#h5-0-254" id="h5-0-254" class="d">-		default:	/* ignore other control sequences */
</a><a href="#h5-0-255" id="h5-0-255" class="d">-			return;
</a><a href="#h5-0-256" id="h5-0-256" class="d">-		case XK_bracketleft:
</a><a href="#h5-0-257" id="h5-0-257" class="d">-			ksym = XK_Escape;
</a><a href="#h5-0-258" id="h5-0-258" class="d">-			break;
</a><a href="#h5-0-259" id="h5-0-259" class="d">-		case XK_h:
</a><a href="#h5-0-260" id="h5-0-260" class="d">-		case XK_H:
</a><a href="#h5-0-261" id="h5-0-261" class="d">-			ksym = XK_BackSpace;
</a><a href="#h5-0-262" id="h5-0-262" class="d">-			break;
</a><a href="#h5-0-263" id="h5-0-263" class="d">-		case XK_i:
</a><a href="#h5-0-264" id="h5-0-264" class="d">-		case XK_I:
</a><a href="#h5-0-265" id="h5-0-265" class="d">-			ksym = XK_Tab;
</a><a href="#h5-0-266" id="h5-0-266" class="d">-			break;
</a><a href="#h5-0-267" id="h5-0-267" class="d">-		case XK_j:
</a><a href="#h5-0-268" id="h5-0-268" class="d">-		case XK_J:
</a><a href="#h5-0-269" id="h5-0-269" class="d">-			ksym = XK_Return;
</a><a href="#h5-0-270" id="h5-0-270" class="d">-			break;
</a><a href="#h5-0-271" id="h5-0-271" class="d">-		case XK_u:
</a><a href="#h5-0-272" id="h5-0-272" class="d">-		case XK_U:
</a><a href="#h5-0-273" id="h5-0-273" class="d">-			text[0] = 0;
</a><a href="#h5-0-274" id="h5-0-274" class="d">-			match(text);
</a><a href="#h5-0-275" id="h5-0-275" class="d">-			drawmenu();
</a><a href="#h5-0-276" id="h5-0-276" class="d">-			return;
</a><a href="#h5-0-277" id="h5-0-277" class="d">-		case XK_w:
</a><a href="#h5-0-278" id="h5-0-278" class="d">-		case XK_W:
</a><a href="#h5-0-279" id="h5-0-279" class="d">-			if(len) {
</a><a href="#h5-0-280" id="h5-0-280" class="d">-				i = len - 1;
</a><a href="#h5-0-281" id="h5-0-281" class="d">-				while(i &gt;= 0 &amp;&amp; text[i] == &#39; &#39;)
</a><a href="#h5-0-282" id="h5-0-282" class="d">-					text[i--] = 0;
</a><a href="#h5-0-283" id="h5-0-283" class="d">-				while(i &gt;= 0 &amp;&amp; text[i] != &#39; &#39;)
</a><a href="#h5-0-284" id="h5-0-284" class="d">-					text[i--] = 0;
</a><a href="#h5-0-285" id="h5-0-285" class="d">-				match(text);
</a><a href="#h5-0-286" id="h5-0-286" class="d">-				drawmenu();
</a><a href="#h5-0-287" id="h5-0-287" class="d">-			}
</a><a href="#h5-0-288" id="h5-0-288" class="d">-			return;
</a><a href="#h5-0-289" id="h5-0-289" class="d">-		}
</a><a href="#h5-0-290" id="h5-0-290" class="d">-	}
</a><a href="#h5-0-291" id="h5-0-291" class="d">-	if(CLEANMASK(e-&gt;state) &amp; Mod1Mask) {
</a><a href="#h5-0-292" id="h5-0-292" class="d">-		switch(ksym) {
</a><a href="#h5-0-293" id="h5-0-293" class="d">-		default: return;
</a><a href="#h5-0-294" id="h5-0-294" class="d">-		case XK_h:
</a><a href="#h5-0-295" id="h5-0-295" class="d">-			ksym = XK_Left;
</a><a href="#h5-0-296" id="h5-0-296" class="d">-			break;
</a><a href="#h5-0-297" id="h5-0-297" class="d">-		case XK_l:
</a><a href="#h5-0-298" id="h5-0-298" class="d">-			ksym = XK_Right;
</a><a href="#h5-0-299" id="h5-0-299" class="d">-			break;
</a><a href="#h5-0-300" id="h5-0-300" class="d">-		case XK_j:
</a><a href="#h5-0-301" id="h5-0-301" class="d">-			ksym = XK_Next;
</a><a href="#h5-0-302" id="h5-0-302" class="d">-			break;
</a><a href="#h5-0-303" id="h5-0-303" class="d">-		case XK_k:
</a><a href="#h5-0-304" id="h5-0-304" class="d">-			ksym = XK_Prior;
</a><a href="#h5-0-305" id="h5-0-305" class="d">-			break;
</a><a href="#h5-0-306" id="h5-0-306" class="d">-		case XK_g:
</a><a href="#h5-0-307" id="h5-0-307" class="d">-			ksym = XK_Home;
</a><a href="#h5-0-308" id="h5-0-308" class="d">-			break;
</a><a href="#h5-0-309" id="h5-0-309" class="d">-		case XK_G:
</a><a href="#h5-0-310" id="h5-0-310" class="d">-			ksym = XK_End;
</a><a href="#h5-0-311" id="h5-0-311" class="d">-			break;
</a><a href="#h5-0-312" id="h5-0-312" class="d">-		}
</a><a href="#h5-0-313" id="h5-0-313" class="d">-	}
</a><a href="#h5-0-314" id="h5-0-314" class="d">-	switch(ksym) {
</a><a href="#h5-0-315" id="h5-0-315" class="d">-	default:
</a><a href="#h5-0-316" id="h5-0-316" class="d">-		if(num &amp;&amp; !iscntrl((int) buf[0])) {
</a><a href="#h5-0-317" id="h5-0-317" class="d">-			buf[num] = 0;
</a><a href="#h5-0-318" id="h5-0-318" class="d">-			if(len &gt; 0)
</a><a href="#h5-0-319" id="h5-0-319" class="d">-				strncat(text, buf, sizeof text);
</a><a href="#h5-0-320" id="h5-0-320" class="d">-			else
</a><a href="#h5-0-321" id="h5-0-321" class="d">-				strncpy(text, buf, sizeof text);
</a><a href="#h5-0-322" id="h5-0-322" class="d">-			match(text);
</a><a href="#h5-0-323" id="h5-0-323" class="d">-		}
</a><a href="#h5-0-324" id="h5-0-324" class="d">-		break;
</a><a href="#h5-0-325" id="h5-0-325" class="d">-	case XK_BackSpace:
</a><a href="#h5-0-326" id="h5-0-326" class="d">-		if(len) {
</a><a href="#h5-0-327" id="h5-0-327" class="d">-			text[--len] = 0;
</a><a href="#h5-0-328" id="h5-0-328" class="d">-			match(text);
</a><a href="#h5-0-329" id="h5-0-329" class="d">-		}
</a><a href="#h5-0-330" id="h5-0-330" class="d">-		break;
</a><a href="#h5-0-331" id="h5-0-331" class="d">-	case XK_End:
</a><a href="#h5-0-332" id="h5-0-332" class="d">-		if(!item)
</a><a href="#h5-0-333" id="h5-0-333" class="d">-			return;
</a><a href="#h5-0-334" id="h5-0-334" class="d">-		while(next) {
</a><a href="#h5-0-335" id="h5-0-335" class="d">-			sel = curr = next;
</a><a href="#h5-0-336" id="h5-0-336" class="d">-			calcoffsets();
</a><a href="#h5-0-337" id="h5-0-337" class="d">-		}
</a><a href="#h5-0-338" id="h5-0-338" class="d">-		while(sel &amp;&amp; sel-&gt;right)
</a><a href="#h5-0-339" id="h5-0-339" class="d">-			sel = sel-&gt;right;
</a><a href="#h5-0-340" id="h5-0-340" class="d">-		break;
</a><a href="#h5-0-341" id="h5-0-341" class="d">-	case XK_Escape:
</a><a href="#h5-0-342" id="h5-0-342" class="d">-		ret = 1;
</a><a href="#h5-0-343" id="h5-0-343" class="d">-		running = False;
</a><a href="#h5-0-344" id="h5-0-344" class="d">-		break;
</a><a href="#h5-0-345" id="h5-0-345" class="d">-	case XK_Home:
</a><a href="#h5-0-346" id="h5-0-346" class="d">-		if(!item)
</a><a href="#h5-0-347" id="h5-0-347" class="d">-			return;
</a><a href="#h5-0-348" id="h5-0-348" class="d">-		sel = curr = item;
</a><a href="#h5-0-349" id="h5-0-349" class="d">-		calcoffsets();
</a><a href="#h5-0-350" id="h5-0-350" class="d">-		break;
</a><a href="#h5-0-351" id="h5-0-351" class="d">-	case XK_Left:
</a><a href="#h5-0-352" id="h5-0-352" class="d">-		if(!(sel &amp;&amp; sel-&gt;left))
</a><a href="#h5-0-353" id="h5-0-353" class="d">-			return;
</a><a href="#h5-0-354" id="h5-0-354" class="d">-		sel=sel-&gt;left;
</a><a href="#h5-0-355" id="h5-0-355" class="d">-		if(sel-&gt;right == curr) {
</a><a href="#h5-0-356" id="h5-0-356" class="d">-			curr = prev;
</a><a href="#h5-0-357" id="h5-0-357" class="d">-			calcoffsets();
</a><a href="#h5-0-358" id="h5-0-358" class="d">-		}
</a><a href="#h5-0-359" id="h5-0-359" class="d">-		break;
</a><a href="#h5-0-360" id="h5-0-360" class="d">-	case XK_Next:
</a><a href="#h5-0-361" id="h5-0-361" class="d">-		if(!next)
</a><a href="#h5-0-362" id="h5-0-362" class="d">-			return;
</a><a href="#h5-0-363" id="h5-0-363" class="d">-		sel = curr = next;
</a><a href="#h5-0-364" id="h5-0-364" class="d">-		calcoffsets();
</a><a href="#h5-0-365" id="h5-0-365" class="d">-		break;
</a><a href="#h5-0-366" id="h5-0-366" class="d">-	case XK_Prior:
</a><a href="#h5-0-367" id="h5-0-367" class="d">-		if(!prev)
</a><a href="#h5-0-368" id="h5-0-368" class="d">-			return;
</a><a href="#h5-0-369" id="h5-0-369" class="d">-		sel = curr = prev;
</a><a href="#h5-0-370" id="h5-0-370" class="d">-		calcoffsets();
</a><a href="#h5-0-371" id="h5-0-371" class="d">-		break;
</a><a href="#h5-0-372" id="h5-0-372" class="d">-	case XK_Return:
</a><a href="#h5-0-373" id="h5-0-373" class="d">-		if((e-&gt;state &amp; ShiftMask) &amp;&amp; text)
</a><a href="#h5-0-374" id="h5-0-374" class="d">-			fprintf(stdout, &quot;%s&quot;, text);
</a><a href="#h5-0-375" id="h5-0-375" class="d">-		else if(sel)
</a><a href="#h5-0-376" id="h5-0-376" class="d">-			fprintf(stdout, &quot;%s&quot;, sel-&gt;text);
</a><a href="#h5-0-377" id="h5-0-377" class="d">-		else if(text)
</a><a href="#h5-0-378" id="h5-0-378" class="d">-			fprintf(stdout, &quot;%s&quot;, text);
</a><a href="#h5-0-379" id="h5-0-379" class="d">-		fflush(stdout);
</a><a href="#h5-0-380" id="h5-0-380" class="d">-		running = False;
</a><a href="#h5-0-381" id="h5-0-381" class="d">-		break;
</a><a href="#h5-0-382" id="h5-0-382" class="d">-	case XK_Right:
</a><a href="#h5-0-383" id="h5-0-383" class="d">-		if(!(sel &amp;&amp; sel-&gt;right))
</a><a href="#h5-0-384" id="h5-0-384" class="d">-			return;
</a><a href="#h5-0-385" id="h5-0-385" class="d">-		sel=sel-&gt;right;
</a><a href="#h5-0-386" id="h5-0-386" class="d">-		if(sel == next) {
</a><a href="#h5-0-387" id="h5-0-387" class="d">-			curr = next;
</a><a href="#h5-0-388" id="h5-0-388" class="d">-			calcoffsets();
</a><a href="#h5-0-389" id="h5-0-389" class="d">-		}
</a><a href="#h5-0-390" id="h5-0-390" class="d">-		break;
</a><a href="#h5-0-391" id="h5-0-391" class="d">-	case XK_Tab:
</a><a href="#h5-0-392" id="h5-0-392" class="d">-		if(!sel)
</a><a href="#h5-0-393" id="h5-0-393" class="d">-			return;
</a><a href="#h5-0-394" id="h5-0-394" class="d">-		strncpy(text, sel-&gt;text, sizeof text);
</a><a href="#h5-0-395" id="h5-0-395" class="d">-		match(text);
</a><a href="#h5-0-396" id="h5-0-396" class="d">-		break;
</a><a href="#h5-0-397" id="h5-0-397" class="d">-	}
</a><a href="#h5-0-398" id="h5-0-398" class="d">-	drawmenu();
</a><a href="#h5-0-399" id="h5-0-399" class="d">-}
</a><a href="#h5-0-400" id="h5-0-400" class="d">-
</a><a href="#h5-0-401" id="h5-0-401" class="d">-static char *
</a><a href="#h5-0-402" id="h5-0-402" class="d">-readstdin(void) {
</a><a href="#h5-0-403" id="h5-0-403" class="d">-	static char *maxname = NULL;
</a><a href="#h5-0-404" id="h5-0-404" class="d">-	char *p, buf[1024];
</a><a href="#h5-0-405" id="h5-0-405" class="d">-	unsigned int len = 0, max = 0;
</a><a href="#h5-0-406" id="h5-0-406" class="d">-	Item *i, *new;
</a><a href="#h5-0-407" id="h5-0-407" class="d">-
</a><a href="#h5-0-408" id="h5-0-408" class="d">-	i = 0;
</a><a href="#h5-0-409" id="h5-0-409" class="d">-	while(fgets(buf, sizeof buf, stdin)) {
</a><a href="#h5-0-410" id="h5-0-410" class="d">-		len = strlen(buf);
</a><a href="#h5-0-411" id="h5-0-411" class="d">-		if (buf[len - 1] == &#39;\n&#39;)
</a><a href="#h5-0-412" id="h5-0-412" class="d">-			buf[len - 1] = 0;
</a><a href="#h5-0-413" id="h5-0-413" class="d">-		p = estrdup(buf);
</a><a href="#h5-0-414" id="h5-0-414" class="d">-		if(max &lt; len) {
</a><a href="#h5-0-415" id="h5-0-415" class="d">-			maxname = p;
</a><a href="#h5-0-416" id="h5-0-416" class="d">-			max = len;
</a><a href="#h5-0-417" id="h5-0-417" class="d">-		}
</a><a href="#h5-0-418" id="h5-0-418" class="d">-		new = emalloc(sizeof(Item));
</a><a href="#h5-0-419" id="h5-0-419" class="d">-		new-&gt;next = new-&gt;left = new-&gt;right = NULL;
</a><a href="#h5-0-420" id="h5-0-420" class="d">-		new-&gt;text = p;
</a><a href="#h5-0-421" id="h5-0-421" class="d">-		if(!i)
</a><a href="#h5-0-422" id="h5-0-422" class="d">-			allitems = new;
</a><a href="#h5-0-423" id="h5-0-423" class="d">-		else 
</a><a href="#h5-0-424" id="h5-0-424" class="d">-			i-&gt;next = new;
</a><a href="#h5-0-425" id="h5-0-425" class="d">-		i = new;
</a><a href="#h5-0-426" id="h5-0-426" class="d">-	}
</a><a href="#h5-0-427" id="h5-0-427" class="d">-
</a><a href="#h5-0-428" id="h5-0-428" class="d">-	return maxname;
</a><a href="#h5-0-429" id="h5-0-429" class="d">-}
</a><a href="#h5-0-430" id="h5-0-430" class="d">-
</a><a href="#h5-0-431" id="h5-0-431" class="d">-static void
</a><a href="#h5-0-432" id="h5-0-432" class="d">-usage(void) {
</a><a href="#h5-0-433" id="h5-0-433" class="d">-	eprint(&quot;usage: dmenu [-b] [-fn &lt;font&gt;] [-nb &lt;color&gt;] [-nf &lt;color&gt;]\n&quot;
</a><a href="#h5-0-434" id="h5-0-434" class="d">-		&quot;             [-p &lt;prompt&gt;] [-sb &lt;color&gt;] [-sf &lt;color&gt;] [-v]\n&quot;);
</a><a href="#h5-0-435" id="h5-0-435" class="d">-}
</a><a href="#h5-0-436" id="h5-0-436" class="d">-
</a><a href="#h5-0-437" id="h5-0-437" class="d">-/* extern */
</a><a href="#h5-0-438" id="h5-0-438" class="d">-
</a><a href="#h5-0-439" id="h5-0-439" class="d">-int screen;
</a><a href="#h5-0-440" id="h5-0-440" class="d">-Display *dpy;
</a><a href="#h5-0-441" id="h5-0-441" class="d">-DC dc = {0};
</a><a href="#h5-0-442" id="h5-0-442" class="d">-
</a><a href="#h5-0-443" id="h5-0-443" class="d">-int
</a><a href="#h5-0-444" id="h5-0-444" class="d">-main(int argc, char *argv[]) {
</a><a href="#h5-0-445" id="h5-0-445" class="d">-	Bool bottom = False;
</a><a href="#h5-0-446" id="h5-0-446" class="d">-	char *font = FONT;
</a><a href="#h5-0-447" id="h5-0-447" class="d">-	char *maxname;
</a><a href="#h5-0-448" id="h5-0-448" class="d">-	char *normbg = NORMBGCOLOR;
</a><a href="#h5-0-449" id="h5-0-449" class="d">-	char *normfg = NORMFGCOLOR;
</a><a href="#h5-0-450" id="h5-0-450" class="d">-	char *selbg = SELBGCOLOR;
</a><a href="#h5-0-451" id="h5-0-451" class="d">-	char *selfg = SELFGCOLOR;
</a><a href="#h5-0-452" id="h5-0-452" class="d">-	int i, j;
</a><a href="#h5-0-453" id="h5-0-453" class="d">-	Item *itm;
</a><a href="#h5-0-454" id="h5-0-454" class="d">-	XEvent ev;
</a><a href="#h5-0-455" id="h5-0-455" class="d">-	XModifierKeymap *modmap;
</a><a href="#h5-0-456" id="h5-0-456" class="d">-	XSetWindowAttributes wa;
</a><a href="#h5-0-457" id="h5-0-457" class="d">-
</a><a href="#h5-0-458" id="h5-0-458" class="d">-	/* command line args */
</a><a href="#h5-0-459" id="h5-0-459" class="d">-	for(i = 1; i &lt; argc; i++)
</a><a href="#h5-0-460" id="h5-0-460" class="d">-		if(!strcmp(argv[i], &quot;-b&quot;)) {
</a><a href="#h5-0-461" id="h5-0-461" class="d">-			bottom = True;
</a><a href="#h5-0-462" id="h5-0-462" class="d">-		}
</a><a href="#h5-0-463" id="h5-0-463" class="d">-		else if(!strcmp(argv[i], &quot;-fn&quot;)) {
</a><a href="#h5-0-464" id="h5-0-464" class="d">-			if(++i &lt; argc) font = argv[i];
</a><a href="#h5-0-465" id="h5-0-465" class="d">-		}
</a><a href="#h5-0-466" id="h5-0-466" class="d">-		else if(!strcmp(argv[i], &quot;-nb&quot;)) {
</a><a href="#h5-0-467" id="h5-0-467" class="d">-			if(++i &lt; argc) normbg = argv[i];
</a><a href="#h5-0-468" id="h5-0-468" class="d">-		}
</a><a href="#h5-0-469" id="h5-0-469" class="d">-		else if(!strcmp(argv[i], &quot;-nf&quot;)) {
</a><a href="#h5-0-470" id="h5-0-470" class="d">-			if(++i &lt; argc) normfg = argv[i];
</a><a href="#h5-0-471" id="h5-0-471" class="d">-		}
</a><a href="#h5-0-472" id="h5-0-472" class="d">-		else if(!strcmp(argv[i], &quot;-p&quot;)) {
</a><a href="#h5-0-473" id="h5-0-473" class="d">-			if(++i &lt; argc) prompt = argv[i];
</a><a href="#h5-0-474" id="h5-0-474" class="d">-		}
</a><a href="#h5-0-475" id="h5-0-475" class="d">-		else if(!strcmp(argv[i], &quot;-sb&quot;)) {
</a><a href="#h5-0-476" id="h5-0-476" class="d">-			if(++i &lt; argc) selbg = argv[i];
</a><a href="#h5-0-477" id="h5-0-477" class="d">-		}
</a><a href="#h5-0-478" id="h5-0-478" class="d">-		else if(!strcmp(argv[i], &quot;-sf&quot;)) {
</a><a href="#h5-0-479" id="h5-0-479" class="d">-			if(++i &lt; argc) selfg = argv[i];
</a><a href="#h5-0-480" id="h5-0-480" class="d">-		}
</a><a href="#h5-0-481" id="h5-0-481" class="d">-		else if(!strcmp(argv[i], &quot;-v&quot;))
</a><a href="#h5-0-482" id="h5-0-482" class="d">-			eprint(&quot;dmenu-&quot;VERSION&quot;, © 2006-2007 Anselm R. Garbe, Sander van Dijk\n&quot;);
</a><a href="#h5-0-483" id="h5-0-483" class="d">-		else
</a><a href="#h5-0-484" id="h5-0-484" class="d">-			usage();
</a><a href="#h5-0-485" id="h5-0-485" class="d">-	setlocale(LC_CTYPE, &quot;&quot;);
</a><a href="#h5-0-486" id="h5-0-486" class="d">-	dpy = XOpenDisplay(0);
</a><a href="#h5-0-487" id="h5-0-487" class="d">-	if(!dpy)
</a><a href="#h5-0-488" id="h5-0-488" class="d">-		eprint(&quot;dmenu: cannot open display\n&quot;);
</a><a href="#h5-0-489" id="h5-0-489" class="d">-	screen = DefaultScreen(dpy);
</a><a href="#h5-0-490" id="h5-0-490" class="d">-	root = RootWindow(dpy, screen);
</a><a href="#h5-0-491" id="h5-0-491" class="d">-	if(isatty(STDIN_FILENO)) {
</a><a href="#h5-0-492" id="h5-0-492" class="d">-		maxname = readstdin();
</a><a href="#h5-0-493" id="h5-0-493" class="d">-		running = grabkeyboard();
</a><a href="#h5-0-494" id="h5-0-494" class="d">-	}
</a><a href="#h5-0-495" id="h5-0-495" class="d">-	else { /* prevent keypress loss */
</a><a href="#h5-0-496" id="h5-0-496" class="d">-		running = grabkeyboard();
</a><a href="#h5-0-497" id="h5-0-497" class="d">-		maxname = readstdin();
</a><a href="#h5-0-498" id="h5-0-498" class="d">-	}
</a><a href="#h5-0-499" id="h5-0-499" class="d">-	/* init modifier map */
</a><a href="#h5-0-500" id="h5-0-500" class="d">-	modmap = XGetModifierMapping(dpy);
</a><a href="#h5-0-501" id="h5-0-501" class="d">-	for (i = 0; i &lt; 8; i++) {
</a><a href="#h5-0-502" id="h5-0-502" class="d">-		for (j = 0; j &lt; modmap-&gt;max_keypermod; j++) {
</a><a href="#h5-0-503" id="h5-0-503" class="d">-			if(modmap-&gt;modifiermap[i * modmap-&gt;max_keypermod + j]
</a><a href="#h5-0-504" id="h5-0-504" class="d">-			== XKeysymToKeycode(dpy, XK_Num_Lock))
</a><a href="#h5-0-505" id="h5-0-505" class="d">-				numlockmask = (1 &lt;&lt; i);
</a><a href="#h5-0-506" id="h5-0-506" class="d">-		}
</a><a href="#h5-0-507" id="h5-0-507" class="d">-	}
</a><a href="#h5-0-508" id="h5-0-508" class="d">-	XFreeModifiermap(modmap);
</a><a href="#h5-0-509" id="h5-0-509" class="d">-	/* style */
</a><a href="#h5-0-510" id="h5-0-510" class="d">-	dc.norm[ColBG] = initcolor(normbg);
</a><a href="#h5-0-511" id="h5-0-511" class="d">-	dc.norm[ColFG] = initcolor(normfg);
</a><a href="#h5-0-512" id="h5-0-512" class="d">-	dc.sel[ColBG] = initcolor(selbg);
</a><a href="#h5-0-513" id="h5-0-513" class="d">-	dc.sel[ColFG] = initcolor(selfg);
</a><a href="#h5-0-514" id="h5-0-514" class="d">-	initfont(font);
</a><a href="#h5-0-515" id="h5-0-515" class="d">-	/* menu window */
</a><a href="#h5-0-516" id="h5-0-516" class="d">-	wa.override_redirect = 1;
</a><a href="#h5-0-517" id="h5-0-517" class="d">-	wa.background_pixmap = ParentRelative;
</a><a href="#h5-0-518" id="h5-0-518" class="d">-	wa.event_mask = ExposureMask | ButtonPressMask | KeyPressMask;
</a><a href="#h5-0-519" id="h5-0-519" class="d">-	mw = DisplayWidth(dpy, screen);
</a><a href="#h5-0-520" id="h5-0-520" class="d">-	mh = dc.font.height + 2;
</a><a href="#h5-0-521" id="h5-0-521" class="d">-	win = XCreateWindow(dpy, root, 0,
</a><a href="#h5-0-522" id="h5-0-522" class="d">-			bottom ? DisplayHeight(dpy, screen) - mh : 0, mw, mh, 0,
</a><a href="#h5-0-523" id="h5-0-523" class="d">-			DefaultDepth(dpy, screen), CopyFromParent,
</a><a href="#h5-0-524" id="h5-0-524" class="d">-			DefaultVisual(dpy, screen),
</a><a href="#h5-0-525" id="h5-0-525" class="d">-			CWOverrideRedirect | CWBackPixmap | CWEventMask, &amp;wa);
</a><a href="#h5-0-526" id="h5-0-526" class="d">-	/* pixmap */
</a><a href="#h5-0-527" id="h5-0-527" class="d">-	dc.drawable = XCreatePixmap(dpy, root, mw, mh, DefaultDepth(dpy, screen));
</a><a href="#h5-0-528" id="h5-0-528" class="d">-	dc.gc = XCreateGC(dpy, root, 0, 0);
</a><a href="#h5-0-529" id="h5-0-529" class="d">-	XSetLineAttributes(dpy, dc.gc, 1, LineSolid, CapButt, JoinMiter);
</a><a href="#h5-0-530" id="h5-0-530" class="d">-	if(!dc.font.set)
</a><a href="#h5-0-531" id="h5-0-531" class="d">-		XSetFont(dpy, dc.gc, dc.font.xfont-&gt;fid);
</a><a href="#h5-0-532" id="h5-0-532" class="d">-	if(maxname)
</a><a href="#h5-0-533" id="h5-0-533" class="d">-		cmdw = textw(maxname);
</a><a href="#h5-0-534" id="h5-0-534" class="d">-	if(cmdw &gt; mw / 3)
</a><a href="#h5-0-535" id="h5-0-535" class="d">-		cmdw = mw / 3;
</a><a href="#h5-0-536" id="h5-0-536" class="d">-	if(prompt)
</a><a href="#h5-0-537" id="h5-0-537" class="d">-		promptw = textw(prompt);
</a><a href="#h5-0-538" id="h5-0-538" class="d">-	if(promptw &gt; mw / 5)
</a><a href="#h5-0-539" id="h5-0-539" class="d">-		promptw = mw / 5;
</a><a href="#h5-0-540" id="h5-0-540" class="d">-	text[0] = 0;
</a><a href="#h5-0-541" id="h5-0-541" class="d">-	match(text);
</a><a href="#h5-0-542" id="h5-0-542" class="d">-	XMapRaised(dpy, win);
</a><a href="#h5-0-543" id="h5-0-543" class="d">-	drawmenu();
</a><a href="#h5-0-544" id="h5-0-544" class="d">-	XSync(dpy, False);
</a><a href="#h5-0-545" id="h5-0-545" class="d">-
</a><a href="#h5-0-546" id="h5-0-546" class="d">-	/* main event loop */
</a><a href="#h5-0-547" id="h5-0-547" class="d">-	while(running &amp;&amp; !XNextEvent(dpy, &amp;ev))
</a><a href="#h5-0-548" id="h5-0-548" class="d">-		switch (ev.type) {
</a><a href="#h5-0-549" id="h5-0-549" class="d">-		default:	/* ignore all crap */
</a><a href="#h5-0-550" id="h5-0-550" class="d">-			break;
</a><a href="#h5-0-551" id="h5-0-551" class="d">-		case KeyPress:
</a><a href="#h5-0-552" id="h5-0-552" class="d">-			kpress(&amp;ev.xkey);
</a><a href="#h5-0-553" id="h5-0-553" class="d">-			break;
</a><a href="#h5-0-554" id="h5-0-554" class="d">-		case Expose:
</a><a href="#h5-0-555" id="h5-0-555" class="d">-			if(ev.xexpose.count == 0)
</a><a href="#h5-0-556" id="h5-0-556" class="d">-				drawmenu();
</a><a href="#h5-0-557" id="h5-0-557" class="d">-			break;
</a><a href="#h5-0-558" id="h5-0-558" class="d">-		}
</a><a href="#h5-0-559" id="h5-0-559" class="d">-
</a><a href="#h5-0-560" id="h5-0-560" class="d">-	/* cleanup */
</a><a href="#h5-0-561" id="h5-0-561" class="d">-	while(allitems) {
</a><a href="#h5-0-562" id="h5-0-562" class="d">-		itm = allitems-&gt;next;
</a><a href="#h5-0-563" id="h5-0-563" class="d">-		free(allitems-&gt;text);
</a><a href="#h5-0-564" id="h5-0-564" class="d">-		free(allitems);
</a><a href="#h5-0-565" id="h5-0-565" class="d">-		allitems = itm;
</a><a href="#h5-0-566" id="h5-0-566" class="d">-	}
</a><a href="#h5-0-567" id="h5-0-567" class="d">-	if(dc.font.set)
</a><a href="#h5-0-568" id="h5-0-568" class="d">-		XFreeFontSet(dpy, dc.font.set);
</a><a href="#h5-0-569" id="h5-0-569" class="d">-	else
</a><a href="#h5-0-570" id="h5-0-570" class="d">-		XFreeFont(dpy, dc.font.xfont);
</a><a href="#h5-0-571" id="h5-0-571" class="d">-	XFreePixmap(dpy, dc.drawable);
</a><a href="#h5-0-572" id="h5-0-572" class="d">-	XFreeGC(dpy, dc.gc);
</a><a href="#h5-0-573" id="h5-0-573" class="d">-	XDestroyWindow(dpy, win);
</a><a href="#h5-0-574" id="h5-0-574" class="d">-	XUngrabKeyboard(dpy, CurrentTime);
</a><a href="#h5-0-575" id="h5-0-575" class="d">-	XCloseDisplay(dpy);
</a><a href="#h5-0-576" id="h5-0-576" class="d">-	return ret;
</a><a href="#h5-0-577" id="h5-0-577" class="d">-}
</a><b>diff --git a/<a id="h6" href="../file/util.c.html">util.c</a> b/<a href="../file/util.c.html">util.c</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,34 +0,0 @@
</a><a href="#h6-0-0" id="h6-0-0" class="d">-/* See LICENSE file for copyright and license details. */
</a><a href="#h6-0-1" id="h6-0-1" class="d">-#include &quot;dmenu.h&quot;
</a><a href="#h6-0-2" id="h6-0-2" class="d">-#include &lt;stdarg.h&gt;
</a><a href="#h6-0-3" id="h6-0-3" class="d">-#include &lt;stdio.h&gt;
</a><a href="#h6-0-4" id="h6-0-4" class="d">-#include &lt;stdlib.h&gt;
</a><a href="#h6-0-5" id="h6-0-5" class="d">-#include &lt;string.h&gt;
</a><a href="#h6-0-6" id="h6-0-6" class="d">-
</a><a href="#h6-0-7" id="h6-0-7" class="d">-void *
</a><a href="#h6-0-8" id="h6-0-8" class="d">-emalloc(unsigned int size) {
</a><a href="#h6-0-9" id="h6-0-9" class="d">-	void *res = malloc(size);
</a><a href="#h6-0-10" id="h6-0-10" class="d">-
</a><a href="#h6-0-11" id="h6-0-11" class="d">-	if(!res)
</a><a href="#h6-0-12" id="h6-0-12" class="d">-		eprint(&quot;fatal: could not malloc() %u bytes\n&quot;, size);
</a><a href="#h6-0-13" id="h6-0-13" class="d">-	return res;
</a><a href="#h6-0-14" id="h6-0-14" class="d">-}
</a><a href="#h6-0-15" id="h6-0-15" class="d">-
</a><a href="#h6-0-16" id="h6-0-16" class="d">-void
</a><a href="#h6-0-17" id="h6-0-17" class="d">-eprint(const char *errstr, ...) {
</a><a href="#h6-0-18" id="h6-0-18" class="d">-	va_list ap;
</a><a href="#h6-0-19" id="h6-0-19" class="d">-
</a><a href="#h6-0-20" id="h6-0-20" class="d">-	va_start(ap, errstr);
</a><a href="#h6-0-21" id="h6-0-21" class="d">-	vfprintf(stderr, errstr, ap);
</a><a href="#h6-0-22" id="h6-0-22" class="d">-	va_end(ap);
</a><a href="#h6-0-23" id="h6-0-23" class="d">-	exit(EXIT_FAILURE);
</a><a href="#h6-0-24" id="h6-0-24" class="d">-}
</a><a href="#h6-0-25" id="h6-0-25" class="d">-
</a><a href="#h6-0-26" id="h6-0-26" class="d">-char *
</a><a href="#h6-0-27" id="h6-0-27" class="d">-estrdup(const char *str) {
</a><a href="#h6-0-28" id="h6-0-28" class="d">-	void *res = strdup(str);
</a><a href="#h6-0-29" id="h6-0-29" class="d">-
</a><a href="#h6-0-30" id="h6-0-30" class="d">-	if(!res)
</a><a href="#h6-0-31" id="h6-0-31" class="d">-		eprint(&quot;fatal: could not malloc() %u bytes\n&quot;, strlen(str));
</a><a href="#h6-0-32" id="h6-0-32" class="d">-	return res;
</a><a href="#h6-0-33" id="h6-0-33" class="d">-}
</a></pre>
</div>
</body>
</html>
