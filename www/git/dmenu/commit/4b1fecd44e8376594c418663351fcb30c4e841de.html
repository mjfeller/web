<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Use libdraw: add Xft and fallback-fonts support to graphics lib - dmenu - dynamic menu
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="dmenu Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>dmenu</h1><span class="desc">dynamic menu
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/4b1fecd44e8376594c418663351fcb30c4e841de.html">4b1fecd44e8376594c418663351fcb30c4e841de</a>
<b>parent</b> <a href="../commit/13a529ce63364544bdc851dfd5d3aa2ef8740914.html">13a529ce63364544bdc851dfd5d3aa2ef8740914</a>
<b>Author:</b> Hiltjo Posthuma &lt;<a href="mailto:hiltjo@codemadness.org">hiltjo@codemadness.org</a>&gt;
<b>Date:</b>   Mon,  4 May 2015 21:54:46 +0200

Use libdraw: add Xft and fallback-fonts support to graphics lib

- libdraw, util: add drw.{c,h}, util.{c,h} and update code.
- libdraw: fix drw_rect(): use w and h parameter.
- libdraw: print errstr if last character in string was &quot;:&quot; (sbase).
- libdraw: drw_clr_free() allow valid free(NULL).
- config.def.h: set default font to monospace.
- cleanup() on exit.
- LICENSE: update license string for dmenu -v to 2015.
- LICENSE: add myself to LICENSE

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">LICENSE</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">Makefile</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">config.def.h</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">config.mk</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">dmenu.c</a></td><td> | </td><td class="num">241</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h5">draw.c</a></td><td> | </td><td class="num">177</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h6">draw.h</a></td><td> | </td><td class="num">35</td><td><span class="i"></span><span class="d">-----------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">drw.c</a></td><td> | </td><td class="num">413</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">drw.h</a></td><td> | </td><td class="num">74</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">util.c</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">util.h</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
</table></pre><pre>11 files changed, 684 insertions(+), 316 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/LICENSE.html">LICENSE</a> b/<a href="../file/LICENSE.html">LICENSE</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -7,6 +7,7 @@ MIT/X Consortium License
</a> © 2009 Evan Gates &lt;evan.gates@gmail.com&gt;
 © 2006-2008 Sander van Dijk &lt;a dot h dot vandijk at gmail dot com&gt;
 © 2006-2007 Michał Janeczek &lt;janeczek at gmail dot com&gt;
<a href="#h0-0-3" id="h0-0-3" class="i">+© 2014-2015 Hiltjo Posthuma &lt;hiltjo@codemadness.org&gt;
</a> 
 Permission is hereby granted, free of charge, to any person obtaining a
 copy of this software and associated documentation files (the &quot;Software&quot;),
<b>diff --git a/<a id="h1" href="../file/Makefile.html">Makefile</a> b/<a href="../file/Makefile.html">Makefile</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -3,7 +3,7 @@
</a> 
 include config.mk
 
<a href="#h1-0-3" id="h1-0-3" class="d">-SRC = dmenu.c draw.c stest.c
</a><a href="#h1-0-4" id="h1-0-4" class="i">+SRC = drw.c dmenu.c stest.c util.c
</a> OBJ = ${SRC:.c=.o}
 
 all: options dmenu stest
<a href="#h1-1" id="h1-1" class="h">@@ -15,18 +15,18 @@ options:
</a> 	@echo &quot;CC       = ${CC}&quot;
 
 .c.o:
<a href="#h1-1-3" id="h1-1-3" class="d">-	@echo CC -c $&lt;
</a><a href="#h1-1-4" id="h1-1-4" class="d">-	@${CC} -c $&lt; ${CFLAGS}
</a><a href="#h1-1-5" id="h1-1-5" class="i">+	@echo CC $&lt;
</a><a href="#h1-1-6" id="h1-1-6" class="i">+	@${CC} -c ${CFLAGS} $&lt;
</a> 
 config.h:
 	@echo creating $@ from config.def.h
 	@cp config.def.h $@
 
<a href="#h1-1-12" id="h1-1-12" class="d">-${OBJ}: config.h config.mk draw.h
</a><a href="#h1-1-13" id="h1-1-13" class="i">+${OBJ}: config.h config.mk drw.h
</a> 
<a href="#h1-1-15" id="h1-1-15" class="d">-dmenu: dmenu.o draw.o
</a><a href="#h1-1-16" id="h1-1-16" class="i">+dmenu: dmenu.o drw.o util.o
</a> 	@echo CC -o $@
<a href="#h1-1-18" id="h1-1-18" class="d">-	@${CC} -o $@ dmenu.o draw.o ${LDFLAGS}
</a><a href="#h1-1-19" id="h1-1-19" class="i">+	@${CC} -o $@ dmenu.o drw.o util.o ${LDFLAGS}
</a> 
 stest: stest.o
 	@echo CC -o $@
<a href="#h1-2" id="h1-2" class="h">@@ -39,7 +39,8 @@ clean:
</a> dist: clean
 	@echo creating dist tarball
 	@mkdir -p dmenu-${VERSION}
<a href="#h1-2-3" id="h1-2-3" class="d">-	@cp LICENSE Makefile README config.mk dmenu.1 draw.h dmenu_path dmenu_run stest.1 ${SRC} dmenu-${VERSION}
</a><a href="#h1-2-4" id="h1-2-4" class="i">+	@cp LICENSE Makefile README config.mk dmenu.1 drw.h util.h dmenu_path \
</a><a href="#h1-2-5" id="h1-2-5" class="i">+		dmenu_run stest.1 ${SRC} dmenu-${VERSION}
</a> 	@tar -cf dmenu-${VERSION}.tar dmenu-${VERSION}
 	@gzip dmenu-${VERSION}.tar
 	@rm -rf dmenu-${VERSION}
<b>diff --git a/<a id="h2" href="../file/config.def.h.html">config.def.h</a> b/<a href="../file/config.def.h.html">config.def.h</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -4,8 +4,11 @@
</a> /* Default settings; can be overrided by command line. */
 
 static Bool topbar = True;                  /* -b  option; if False, dmenu appears at bottom */
<a href="#h2-0-3" id="h2-0-3" class="d">-static const char *font = NULL;             /* -fn option; default X11 font or font set      */
</a><a href="#h2-0-4" id="h2-0-4" class="d">-static const char *prompt = NULL;           /* -p  option; prompt to the elft of input field */
</a><a href="#h2-0-5" id="h2-0-5" class="i">+/* -fn option overrides fonts[0]; default X11 font or font set */
</a><a href="#h2-0-6" id="h2-0-6" class="i">+static const char *fonts[] = {
</a><a href="#h2-0-7" id="h2-0-7" class="i">+	&quot;monospace:size=10&quot;
</a><a href="#h2-0-8" id="h2-0-8" class="i">+};
</a><a href="#h2-0-9" id="h2-0-9" class="i">+static const char *prompt      = NULL;      /* -p  option; prompt to the elft of input field */
</a> static const char *normbgcolor = &quot;#222222&quot;; /* -nb option; normal background                 */
 static const char *normfgcolor = &quot;#bbbbbb&quot;; /* -nf option; normal foreground                 */
 static const char *selbgcolor  = &quot;#005577&quot;; /* -sb option; selected background               */
<a href="#h2-1" id="h2-1" class="h">@@ -13,5 +16,4 @@ static const char *selfgcolor  = &quot;#eeeeee&quot;; /* -sf option; selected foreground  
</a> static const char *outbgcolor  = &quot;#00ffff&quot;;
 static const char *outfgcolor  = &quot;#000000&quot;;
 /* -l option; if nonzero, dmenu uses vertical list with given number of lines */
<a href="#h2-1-3" id="h2-1-3" class="d">-static unsigned int lines = 0;
</a><a href="#h2-1-4" id="h2-1-4" class="d">-
</a><a href="#h2-1-5" id="h2-1-5" class="i">+static unsigned int lines      = 0;
</a><b>diff --git a/<a id="h3" href="../file/config.mk.html">config.mk</a> b/<a href="../file/config.mk.html">config.mk</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -13,8 +13,8 @@ XINERAMALIBS  = -lXinerama
</a> XINERAMAFLAGS = -DXINERAMA
 
 # includes and libs
<a href="#h3-0-3" id="h3-0-3" class="d">-INCS = -I${X11INC}
</a><a href="#h3-0-4" id="h3-0-4" class="d">-LIBS = -L${X11LIB} -lX11 ${XINERAMALIBS}
</a><a href="#h3-0-5" id="h3-0-5" class="i">+INCS = -I${X11INC} -I/usr/include/freetype2
</a><a href="#h3-0-6" id="h3-0-6" class="i">+LIBS = -L${X11LIB} -lX11 ${XINERAMALIBS} -lfontconfig -lXft
</a> 
 # flags
 CPPFLAGS = -D_BSD_SOURCE -D_POSIX_C_SOURCE=200809L -DVERSION=\&quot;${VERSION}\&quot; ${XINERAMAFLAGS}
<b>diff --git a/<a id="h4" href="../file/dmenu.c.html">dmenu.c</a> b/<a href="../file/dmenu.c.html">dmenu.c</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,5 +1,6 @@
</a> /* See LICENSE file for copyright and license details. */
 #include &lt;ctype.h&gt;
<a href="#h4-0-2" id="h4-0-2" class="i">+#include &lt;locale.h&gt;
</a> #include &lt;stdio.h&gt;
 #include &lt;stdlib.h&gt;
 #include &lt;string.h&gt;
<a href="#h4-1" id="h4-1" class="h">@@ -11,12 +12,20 @@
</a> #ifdef XINERAMA
 #include &lt;X11/extensions/Xinerama.h&gt;
 #endif
<a href="#h4-1-3" id="h4-1-3" class="d">-#include &quot;draw.h&quot;
</a><a href="#h4-1-4" id="h4-1-4" class="i">+#include &lt;X11/Xft/Xft.h&gt;
</a> 
<a href="#h4-1-6" id="h4-1-6" class="i">+#include &quot;drw.h&quot;
</a><a href="#h4-1-7" id="h4-1-7" class="i">+#include &quot;util.h&quot;
</a><a href="#h4-1-8" id="h4-1-8" class="i">+
</a><a href="#h4-1-9" id="h4-1-9" class="i">+/* macros */
</a> #define INTERSECT(x,y,w,h,r)  (MAX(0, MIN((x)+(w),(r).x_org+(r).width)  - MAX((x),(r).x_org)) \
                              * MAX(0, MIN((y)+(h),(r).y_org+(r).height) - MAX((y),(r).y_org)))
<a href="#h4-1-12" id="h4-1-12" class="d">-#define MIN(a,b)              ((a) &lt; (b) ? (a) : (b))
</a><a href="#h4-1-13" id="h4-1-13" class="d">-#define MAX(a,b)              ((a) &gt; (b) ? (a) : (b))
</a><a href="#h4-1-14" id="h4-1-14" class="i">+#define LENGTH(X)             (sizeof X / sizeof X[0])
</a><a href="#h4-1-15" id="h4-1-15" class="i">+#define TEXTNW(X,N)           (drw_font_getexts_width(drw-&gt;fonts[0], (X), (N)))
</a><a href="#h4-1-16" id="h4-1-16" class="i">+#define TEXTW(X)              (drw_text(drw, 0, 0, 0, 0, (X), 0) + drw-&gt;fonts[0]-&gt;h)
</a><a href="#h4-1-17" id="h4-1-17" class="i">+
</a><a href="#h4-1-18" id="h4-1-18" class="i">+/* enums */
</a><a href="#h4-1-19" id="h4-1-19" class="i">+enum { SchemeNorm, SchemeSel, SchemeOut, SchemeLast }; /* color schemes */
</a> 
 typedef struct Item Item;
 struct Item {
<a href="#h4-2" id="h4-2" class="h">@@ -28,6 +37,7 @@ struct Item {
</a> static void appenditem(Item *item, Item **list, Item **last);
 static void calcoffsets(void);
 static char *cistrstr(const char *s, const char *sub);
<a href="#h4-2-3" id="h4-2-3" class="i">+static void cleanup(void);
</a> static void drawmenu(void);
 static void grabkeyboard(void);
 static void insert(const char *str, ssize_t n);
<a href="#h4-3" id="h4-3" class="h">@@ -44,11 +54,7 @@ static char text[BUFSIZ] = &quot;&quot;;
</a> static int bh, mw, mh;
 static int inputw, promptw;
 static size_t cursor = 0;
<a href="#h4-3-3" id="h4-3-3" class="d">-static unsigned long normcol[ColLast];
</a><a href="#h4-3-4" id="h4-3-4" class="d">-static unsigned long selcol[ColLast];
</a><a href="#h4-3-5" id="h4-3-5" class="d">-static unsigned long outcol[ColLast];
</a> static Atom clip, utf8;
<a href="#h4-3-7" id="h4-3-7" class="d">-static DC *dc;
</a> static Item *items = NULL;
 static Item *matches, *matchend;
 static Item *prev, *curr, *next, *sel;
<a href="#h4-4" id="h4-4" class="h">@@ -56,6 +62,13 @@ static Window win;
</a> static XIC xic;
 static int mon = -1;
 
<a href="#h4-4-3" id="h4-4-3" class="i">+static ClrScheme scheme[SchemeLast];
</a><a href="#h4-4-4" id="h4-4-4" class="i">+static Display *dpy;
</a><a href="#h4-4-5" id="h4-4-5" class="i">+static int screen;
</a><a href="#h4-4-6" id="h4-4-6" class="i">+static Window root;
</a><a href="#h4-4-7" id="h4-4-7" class="i">+static Drw *drw;
</a><a href="#h4-4-8" id="h4-4-8" class="i">+static int sw, sh; /* X display screen geometry width, height */
</a><a href="#h4-4-9" id="h4-4-9" class="i">+
</a> #include &quot;config.h&quot;
 
 static int (*fstrncmp)(const char *, const char *, size_t) = strncmp;
<a href="#h4-5" id="h4-5" class="h">@@ -69,8 +82,8 @@ main(int argc, char *argv[]) {
</a> 	for(i = 1; i &lt; argc; i++)
 		/* these options take no arguments */
 		if(!strcmp(argv[i], &quot;-v&quot;)) {      /* prints version information */
<a href="#h4-5-3" id="h4-5-3" class="d">-			puts(&quot;dmenu-&quot;VERSION&quot;, © 2006-2014 dmenu engineers, see LICENSE for details&quot;);
</a><a href="#h4-5-4" id="h4-5-4" class="d">-			exit(EXIT_SUCCESS);
</a><a href="#h4-5-5" id="h4-5-5" class="i">+			puts(&quot;dmenu-&quot;VERSION&quot;, © 2006-2015 dmenu engineers, see LICENSE for details&quot;);
</a><a href="#h4-5-6" id="h4-5-6" class="i">+			exit(0);
</a> 		}
 		else if(!strcmp(argv[i], &quot;-b&quot;))   /* appears at the bottom of the screen */
 			topbar = False;
<a href="#h4-6" id="h4-6" class="h">@@ -90,7 +103,7 @@ main(int argc, char *argv[]) {
</a> 		else if(!strcmp(argv[i], &quot;-p&quot;))   /* adds prompt to left of input field */
 			prompt = argv[++i];
 		else if(!strcmp(argv[i], &quot;-fn&quot;))  /* font or font set */
<a href="#h4-6-3" id="h4-6-3" class="d">-			font = argv[++i];
</a><a href="#h4-6-4" id="h4-6-4" class="i">+			fonts[0] = argv[++i];
</a> 		else if(!strcmp(argv[i], &quot;-nb&quot;))  /* normal background color */
 			normbgcolor = argv[++i];
 		else if(!strcmp(argv[i], &quot;-nf&quot;))  /* normal foreground color */
<a href="#h4-7" id="h4-7" class="h">@@ -102,8 +115,19 @@ main(int argc, char *argv[]) {
</a> 		else
 			usage();
 
<a href="#h4-7-3" id="h4-7-3" class="d">-	dc = initdc();
</a><a href="#h4-7-4" id="h4-7-4" class="d">-	initfont(dc, font);
</a><a href="#h4-7-5" id="h4-7-5" class="i">+	if(!setlocale(LC_CTYPE, &quot;&quot;) || !XSupportsLocale())
</a><a href="#h4-7-6" id="h4-7-6" class="i">+		fputs(&quot;warning: no locale support\n&quot;, stderr);
</a><a href="#h4-7-7" id="h4-7-7" class="i">+	if(!(dpy = XOpenDisplay(NULL)))
</a><a href="#h4-7-8" id="h4-7-8" class="i">+		die(&quot;dwm: cannot open display\n&quot;);
</a><a href="#h4-7-9" id="h4-7-9" class="i">+	screen = DefaultScreen(dpy);
</a><a href="#h4-7-10" id="h4-7-10" class="i">+	root = RootWindow(dpy, screen);
</a><a href="#h4-7-11" id="h4-7-11" class="i">+	sw = DisplayWidth(dpy, screen);
</a><a href="#h4-7-12" id="h4-7-12" class="i">+	sh = DisplayHeight(dpy, screen);
</a><a href="#h4-7-13" id="h4-7-13" class="i">+	drw = drw_create(dpy, screen, root, sw, sh);
</a><a href="#h4-7-14" id="h4-7-14" class="i">+	drw_load_fonts(drw, fonts, LENGTH(fonts));
</a><a href="#h4-7-15" id="h4-7-15" class="i">+	if(!drw-&gt;fontcount)
</a><a href="#h4-7-16" id="h4-7-16" class="i">+		die(&quot;No fonts could be loaded.\n&quot;);
</a><a href="#h4-7-17" id="h4-7-17" class="i">+	drw_setscheme(drw, &amp;scheme[SchemeNorm]);
</a> 
 	if(fast) {
 		grabkeyboard();
<a href="#h4-8" id="h4-8" class="h">@@ -138,16 +162,30 @@ calcoffsets(void) {
</a> 	if(lines &gt; 0)
 		n = lines * bh;
 	else
<a href="#h4-8-3" id="h4-8-3" class="d">-		n = mw - (promptw + inputw + textw(dc, &quot;&lt;&quot;) + textw(dc, &quot;&gt;&quot;));
</a><a href="#h4-8-4" id="h4-8-4" class="i">+		n = mw - (promptw + inputw + TEXTW(&quot;&lt;&quot;) + TEXTW(&quot;&gt;&quot;));
</a> 	/* calculate which items will begin the next page and previous page */
 	for(i = 0, next = curr; next; next = next-&gt;right)
<a href="#h4-8-7" id="h4-8-7" class="d">-		if((i += (lines &gt; 0) ? bh : MIN(textw(dc, next-&gt;text), n)) &gt; n)
</a><a href="#h4-8-8" id="h4-8-8" class="i">+		if((i += (lines &gt; 0) ? bh : MIN(TEXTW(next-&gt;text), n)) &gt; n)
</a> 			break;
 	for(i = 0, prev = curr; prev &amp;&amp; prev-&gt;left; prev = prev-&gt;left)
<a href="#h4-8-11" id="h4-8-11" class="d">-		if((i += (lines &gt; 0) ? bh : MIN(textw(dc, prev-&gt;left-&gt;text), n)) &gt; n)
</a><a href="#h4-8-12" id="h4-8-12" class="i">+		if((i += (lines &gt; 0) ? bh : MIN(TEXTW(prev-&gt;left-&gt;text), n)) &gt; n)
</a> 			break;
 }
 
<a href="#h4-8-16" id="h4-8-16" class="i">+void
</a><a href="#h4-8-17" id="h4-8-17" class="i">+cleanup(void) {
</a><a href="#h4-8-18" id="h4-8-18" class="i">+	XUngrabKey(dpy, AnyKey, AnyModifier, root);
</a><a href="#h4-8-19" id="h4-8-19" class="i">+	drw_clr_free(scheme[SchemeNorm].bg);
</a><a href="#h4-8-20" id="h4-8-20" class="i">+	drw_clr_free(scheme[SchemeNorm].fg);
</a><a href="#h4-8-21" id="h4-8-21" class="i">+	drw_clr_free(scheme[SchemeSel].fg);
</a><a href="#h4-8-22" id="h4-8-22" class="i">+	drw_clr_free(scheme[SchemeSel].bg);
</a><a href="#h4-8-23" id="h4-8-23" class="i">+	drw_clr_free(scheme[SchemeOut].fg);
</a><a href="#h4-8-24" id="h4-8-24" class="i">+	drw_clr_free(scheme[SchemeOut].bg);
</a><a href="#h4-8-25" id="h4-8-25" class="i">+	drw_free(drw);
</a><a href="#h4-8-26" id="h4-8-26" class="i">+	XSync(dpy, False);
</a><a href="#h4-8-27" id="h4-8-27" class="i">+	XCloseDisplay(dpy);
</a><a href="#h4-8-28" id="h4-8-28" class="i">+}
</a><a href="#h4-8-29" id="h4-8-29" class="i">+
</a> char *
 cistrstr(const char *s, const char *sub) {
 	size_t len;
<a href="#h4-9" id="h4-9" class="h">@@ -162,50 +200,69 @@ void
</a> drawmenu(void) {
 	int curpos;
 	Item *item;
<a href="#h4-9-3" id="h4-9-3" class="i">+	int x = 0, y = 0, h = bh, w;
</a> 
<a href="#h4-9-5" id="h4-9-5" class="d">-	dc-&gt;x = 0;
</a><a href="#h4-9-6" id="h4-9-6" class="d">-	dc-&gt;y = 0;
</a><a href="#h4-9-7" id="h4-9-7" class="d">-	dc-&gt;h = bh;
</a><a href="#h4-9-8" id="h4-9-8" class="d">-	drawrect(dc, 0, 0, mw, mh, True, BG(dc, normcol));
</a><a href="#h4-9-9" id="h4-9-9" class="i">+	drw_setscheme(drw, &amp;scheme[SchemeNorm]);
</a><a href="#h4-9-10" id="h4-9-10" class="i">+	drw_rect(drw, 0, 0, mw, mh, True, 1, 1);
</a> 
 	if(prompt &amp;&amp; *prompt) {
<a href="#h4-9-13" id="h4-9-13" class="d">-		dc-&gt;w = promptw;
</a><a href="#h4-9-14" id="h4-9-14" class="d">-		drawtext(dc, prompt, selcol);
</a><a href="#h4-9-15" id="h4-9-15" class="d">-		dc-&gt;x = dc-&gt;w;
</a><a href="#h4-9-16" id="h4-9-16" class="i">+		drw_setscheme(drw, &amp;scheme[SchemeSel]);
</a><a href="#h4-9-17" id="h4-9-17" class="i">+		drw_text(drw, x, 0, promptw, bh, prompt, 1);
</a><a href="#h4-9-18" id="h4-9-18" class="i">+		x += promptw;
</a> 	}
 	/* draw input field */
<a href="#h4-9-21" id="h4-9-21" class="d">-	dc-&gt;w = (lines &gt; 0 || !matches) ? mw - dc-&gt;x : inputw;
</a><a href="#h4-9-22" id="h4-9-22" class="d">-	drawtext(dc, text, normcol);
</a><a href="#h4-9-23" id="h4-9-23" class="d">-	if((curpos = textnw(dc, text, cursor) + dc-&gt;h/2 - 2) &lt; dc-&gt;w)
</a><a href="#h4-9-24" id="h4-9-24" class="d">-		drawrect(dc, curpos, 2, 1, dc-&gt;h - 4, True, FG(dc, normcol));
</a><a href="#h4-9-25" id="h4-9-25" class="i">+	w = (lines &gt; 0 || !matches) ? mw - x : inputw;
</a><a href="#h4-9-26" id="h4-9-26" class="i">+	drw_setscheme(drw, &amp;scheme[SchemeNorm]);
</a><a href="#h4-9-27" id="h4-9-27" class="i">+	drw_text(drw, x, 0, w, bh, text, 0);
</a><a href="#h4-9-28" id="h4-9-28" class="i">+
</a><a href="#h4-9-29" id="h4-9-29" class="i">+	if((curpos = TEXTNW(text, cursor) + bh/2 - 2) &lt; w) {
</a><a href="#h4-9-30" id="h4-9-30" class="i">+		drw_setscheme(drw, &amp;scheme[SchemeNorm]);
</a><a href="#h4-9-31" id="h4-9-31" class="i">+		drw_rect(drw, x + curpos + 2, 2, 1, bh - 4, 1, 1, 0);
</a><a href="#h4-9-32" id="h4-9-32" class="i">+	}
</a> 
 	if(lines &gt; 0) {
 		/* draw vertical list */
<a href="#h4-9-36" id="h4-9-36" class="d">-		dc-&gt;w = mw - dc-&gt;x;
</a><a href="#h4-9-37" id="h4-9-37" class="i">+		w = mw - x;
</a> 		for(item = curr; item != next; item = item-&gt;right) {
<a href="#h4-9-39" id="h4-9-39" class="d">-			dc-&gt;y += dc-&gt;h;
</a><a href="#h4-9-40" id="h4-9-40" class="d">-			drawtext(dc, item-&gt;text, (item == sel) ? selcol :
</a><a href="#h4-9-41" id="h4-9-41" class="d">-			                         (item-&gt;out)   ? outcol : normcol);
</a><a href="#h4-9-42" id="h4-9-42" class="i">+			y += h;
</a><a href="#h4-9-43" id="h4-9-43" class="i">+			if(item == sel)
</a><a href="#h4-9-44" id="h4-9-44" class="i">+				drw_setscheme(drw, &amp;scheme[SchemeSel]);
</a><a href="#h4-9-45" id="h4-9-45" class="i">+			else if(item-&gt;out)
</a><a href="#h4-9-46" id="h4-9-46" class="i">+				drw_setscheme(drw, &amp;scheme[SchemeOut]);
</a><a href="#h4-9-47" id="h4-9-47" class="i">+			else
</a><a href="#h4-9-48" id="h4-9-48" class="i">+				drw_setscheme(drw, &amp;scheme[SchemeNorm]);
</a><a href="#h4-9-49" id="h4-9-49" class="i">+
</a><a href="#h4-9-50" id="h4-9-50" class="i">+			drw_text(drw, x, y, w, bh, item-&gt;text, 0);
</a> 		}
 	}
 	else if(matches) {
 		/* draw horizontal list */
<a href="#h4-9-55" id="h4-9-55" class="d">-		dc-&gt;x += inputw;
</a><a href="#h4-9-56" id="h4-9-56" class="d">-		dc-&gt;w = textw(dc, &quot;&lt;&quot;);
</a><a href="#h4-9-57" id="h4-9-57" class="d">-		if(curr-&gt;left)
</a><a href="#h4-9-58" id="h4-9-58" class="d">-			drawtext(dc, &quot;&lt;&quot;, normcol);
</a><a href="#h4-9-59" id="h4-9-59" class="i">+		x += inputw;
</a><a href="#h4-9-60" id="h4-9-60" class="i">+		w = TEXTW(&quot;&lt;&quot;);
</a><a href="#h4-9-61" id="h4-9-61" class="i">+		if(curr-&gt;left) {
</a><a href="#h4-9-62" id="h4-9-62" class="i">+			drw_setscheme(drw, &amp;scheme[SchemeNorm]);
</a><a href="#h4-9-63" id="h4-9-63" class="i">+			drw_text(drw, x, 0, w, bh, &quot;&lt;&quot;, 0);
</a><a href="#h4-9-64" id="h4-9-64" class="i">+		}
</a> 		for(item = curr; item != next; item = item-&gt;right) {
<a href="#h4-9-66" id="h4-9-66" class="d">-			dc-&gt;x += dc-&gt;w;
</a><a href="#h4-9-67" id="h4-9-67" class="d">-			dc-&gt;w = MIN(textw(dc, item-&gt;text), mw - dc-&gt;x - textw(dc, &quot;&gt;&quot;));
</a><a href="#h4-9-68" id="h4-9-68" class="d">-			drawtext(dc, item-&gt;text, (item == sel) ? selcol :
</a><a href="#h4-9-69" id="h4-9-69" class="d">-			                         (item-&gt;out)   ? outcol : normcol);
</a><a href="#h4-9-70" id="h4-9-70" class="i">+			x += w;
</a><a href="#h4-9-71" id="h4-9-71" class="i">+			w = MIN(TEXTW(item-&gt;text), mw - x - TEXTW(&quot;&gt;&quot;));
</a><a href="#h4-9-72" id="h4-9-72" class="i">+
</a><a href="#h4-9-73" id="h4-9-73" class="i">+			if(item == sel)
</a><a href="#h4-9-74" id="h4-9-74" class="i">+				drw_setscheme(drw, &amp;scheme[SchemeSel]);
</a><a href="#h4-9-75" id="h4-9-75" class="i">+			else if(item-&gt;out)
</a><a href="#h4-9-76" id="h4-9-76" class="i">+				drw_setscheme(drw, &amp;scheme[SchemeOut]);
</a><a href="#h4-9-77" id="h4-9-77" class="i">+			else
</a><a href="#h4-9-78" id="h4-9-78" class="i">+				drw_setscheme(drw, &amp;scheme[SchemeNorm]);
</a><a href="#h4-9-79" id="h4-9-79" class="i">+			drw_text(drw, x, 0, w, bh, item-&gt;text, 0);
</a><a href="#h4-9-80" id="h4-9-80" class="i">+		}
</a><a href="#h4-9-81" id="h4-9-81" class="i">+		w = TEXTW(&quot;&gt;&quot;);
</a><a href="#h4-9-82" id="h4-9-82" class="i">+		x = mw - w;
</a><a href="#h4-9-83" id="h4-9-83" class="i">+		if(next) {
</a><a href="#h4-9-84" id="h4-9-84" class="i">+			drw_setscheme(drw, &amp;scheme[SchemeNorm]);
</a><a href="#h4-9-85" id="h4-9-85" class="i">+			drw_text(drw, x, 0, w, bh, &quot;&gt;&quot;, 0);
</a> 		}
<a href="#h4-9-87" id="h4-9-87" class="d">-		dc-&gt;w = textw(dc, &quot;&gt;&quot;);
</a><a href="#h4-9-88" id="h4-9-88" class="d">-		dc-&gt;x = mw - dc-&gt;w;
</a><a href="#h4-9-89" id="h4-9-89" class="d">-		if(next)
</a><a href="#h4-9-90" id="h4-9-90" class="d">-			drawtext(dc, &quot;&gt;&quot;, normcol);
</a> 	}
<a href="#h4-9-92" id="h4-9-92" class="d">-	mapdc(dc, win, mw, mh);
</a><a href="#h4-9-93" id="h4-9-93" class="i">+	drw_map(drw, win, 0, 0, mw, mh);
</a> }
 
 void
<a href="#h4-10" id="h4-10" class="h">@@ -214,12 +271,12 @@ grabkeyboard(void) {
</a> 
 	/* try to grab keyboard, we may have to wait for another process to ungrab */
 	for(i = 0; i &lt; 1000; i++) {
<a href="#h4-10-3" id="h4-10-3" class="d">-		if(XGrabKeyboard(dc-&gt;dpy, DefaultRootWindow(dc-&gt;dpy), True,
</a><a href="#h4-10-4" id="h4-10-4" class="i">+		if(XGrabKeyboard(dpy, DefaultRootWindow(dpy), True,
</a> 		                 GrabModeAsync, GrabModeAsync, CurrentTime) == GrabSuccess)
 			return;
 		usleep(1000);
 	}
<a href="#h4-10-9" id="h4-10-9" class="d">-	eprintf(&quot;cannot grab keyboard\n&quot;);
</a><a href="#h4-10-10" id="h4-10-10" class="i">+	die(&quot;cannot grab keyboard\n&quot;);
</a> }
 
 void
<a href="#h4-11" id="h4-11" class="h">@@ -276,14 +333,15 @@ keypress(XKeyEvent *ev) {
</a> 				insert(NULL, nextrune(-1) - cursor);
 			break;
 		case XK_y: /* paste selection */
<a href="#h4-11-3" id="h4-11-3" class="d">-			XConvertSelection(dc-&gt;dpy, (ev-&gt;state &amp; ShiftMask) ? clip : XA_PRIMARY,
</a><a href="#h4-11-4" id="h4-11-4" class="i">+			XConvertSelection(dpy, (ev-&gt;state &amp; ShiftMask) ? clip : XA_PRIMARY,
</a> 			                  utf8, utf8, win, CurrentTime);
 			return;
 		case XK_Return:
 		case XK_KP_Enter:
 			break;
 		case XK_bracketleft:
<a href="#h4-11-11" id="h4-11-11" class="d">-			exit(EXIT_FAILURE);
</a><a href="#h4-11-12" id="h4-11-12" class="i">+			cleanup();
</a><a href="#h4-11-13" id="h4-11-13" class="i">+			exit(1);
</a> 		default:
 			return;
 		}
<a href="#h4-12" id="h4-12" class="h">@@ -330,7 +388,8 @@ keypress(XKeyEvent *ev) {
</a> 		sel = matchend;
 		break;
 	case XK_Escape:
<a href="#h4-12-3" id="h4-12-3" class="d">-		exit(EXIT_FAILURE);
</a><a href="#h4-12-4" id="h4-12-4" class="i">+		cleanup();
</a><a href="#h4-12-5" id="h4-12-5" class="i">+		exit(1);
</a> 	case XK_Home:
 		if(sel == matches) {
 			cursor = 0;
<a href="#h4-13" id="h4-13" class="h">@@ -368,8 +427,10 @@ keypress(XKeyEvent *ev) {
</a> 	case XK_Return:
 	case XK_KP_Enter:
 		puts((sel &amp;&amp; !(ev-&gt;state &amp; ShiftMask)) ? sel-&gt;text : text);
<a href="#h4-13-3" id="h4-13-3" class="d">-		if(!(ev-&gt;state &amp; ControlMask))
</a><a href="#h4-13-4" id="h4-13-4" class="d">-			exit(EXIT_SUCCESS);
</a><a href="#h4-13-5" id="h4-13-5" class="i">+		if(!(ev-&gt;state &amp; ControlMask)) {
</a><a href="#h4-13-6" id="h4-13-6" class="i">+			cleanup();
</a><a href="#h4-13-7" id="h4-13-7" class="i">+			exit(0);
</a><a href="#h4-13-8" id="h4-13-8" class="i">+		}
</a> 		if(sel)
 			sel-&gt;out = True;
 		break;
<a href="#h4-14" id="h4-14" class="h">@@ -413,7 +474,7 @@ match(void) {
</a> 	/* separate input text into tokens to be matched individually */
 	for(s = strtok(buf, &quot; &quot;); s; tokv[tokc-1] = s, s = strtok(NULL, &quot; &quot;))
 		if(++tokc &gt; tokn &amp;&amp; !(tokv = realloc(tokv, ++tokn * sizeof *tokv)))
<a href="#h4-14-3" id="h4-14-3" class="d">-			eprintf(&quot;cannot realloc %u bytes\n&quot;, tokn * sizeof *tokv);
</a><a href="#h4-14-4" id="h4-14-4" class="i">+			die(&quot;cannot realloc %u bytes\n&quot;, tokn * sizeof *tokv);
</a> 	len = tokc ? strlen(tokv[0]) : 0;
 
 	matches = lprefix = lsubstr = matchend = prefixend = substrend = NULL;
<a href="#h4-15" id="h4-15" class="h">@@ -470,7 +531,7 @@ paste(void) {
</a> 	Atom da;
 
 	/* we have been given the current selection, now insert it into input */
<a href="#h4-15-3" id="h4-15-3" class="d">-	XGetWindowProperty(dc-&gt;dpy, win, utf8, 0, (sizeof text / 4) + 1, False,
</a><a href="#h4-15-4" id="h4-15-4" class="i">+	XGetWindowProperty(dpy, win, utf8, 0, (sizeof text / 4) + 1, False,
</a> 	                   utf8, &amp;da, &amp;di, &amp;dl, &amp;dl, (unsigned char **)&amp;p);
 	insert(p, (q = strchr(p, &#39;\n&#39;)) ? q-p : (ssize_t)strlen(p));
 	XFree(p);
<a href="#h4-16" id="h4-16" class="h">@@ -486,18 +547,18 @@ readstdin(void) {
</a> 	for(i = 0; fgets(buf, sizeof buf, stdin); i++) {
 		if(i+1 &gt;= size / sizeof *items)
 			if(!(items = realloc(items, (size += BUFSIZ))))
<a href="#h4-16-3" id="h4-16-3" class="d">-				eprintf(&quot;cannot realloc %u bytes:&quot;, size);
</a><a href="#h4-16-4" id="h4-16-4" class="i">+				die(&quot;cannot realloc %u bytes:&quot;, size);
</a> 		if((p = strchr(buf, &#39;\n&#39;)))
 			*p = &#39;\0&#39;;
 		if(!(items[i].text = strdup(buf)))
<a href="#h4-16-8" id="h4-16-8" class="d">-			eprintf(&quot;cannot strdup %u bytes:&quot;, strlen(buf)+1);
</a><a href="#h4-16-9" id="h4-16-9" class="i">+			die(&quot;cannot strdup %u bytes:&quot;, strlen(buf)+1);
</a> 		items[i].out = False;
 		if(strlen(items[i].text) &gt; max)
 			max = strlen(maxstr = items[i].text);
 	}
 	if(items)
 		items[i].text = NULL;
<a href="#h4-16-16" id="h4-16-16" class="d">-	inputw = maxstr ? textw(dc, maxstr) : 0;
</a><a href="#h4-16-17" id="h4-16-17" class="i">+	inputw = maxstr ? TEXTW(maxstr) : 0;
</a> 	lines = MIN(lines, i);
 }
 
<a href="#h4-17" id="h4-17" class="h">@@ -505,13 +566,13 @@ void
</a> run(void) {
 	XEvent ev;
 
<a href="#h4-17-3" id="h4-17-3" class="d">-	while(!XNextEvent(dc-&gt;dpy, &amp;ev)) {
</a><a href="#h4-17-4" id="h4-17-4" class="i">+	while(!XNextEvent(dpy, &amp;ev)) {
</a> 		if(XFilterEvent(&amp;ev, win))
 			continue;
 		switch(ev.type) {
 		case Expose:
 			if(ev.xexpose.count == 0)
<a href="#h4-17-10" id="h4-17-10" class="d">-				mapdc(dc, win, mw, mh);
</a><a href="#h4-17-11" id="h4-17-11" class="i">+				drw_map(drw, win, 0, 0, mw, mh);
</a> 			break;
 		case KeyPress:
 			keypress(&amp;ev.xkey);
<a href="#h4-18" id="h4-18" class="h">@@ -522,7 +583,7 @@ run(void) {
</a> 			break;
 		case VisibilityNotify:
 			if(ev.xvisibility.state != VisibilityUnobscured)
<a href="#h4-18-3" id="h4-18-3" class="d">-				XRaiseWindow(dc-&gt;dpy, win);
</a><a href="#h4-18-4" id="h4-18-4" class="i">+				XRaiseWindow(dpy, win);
</a> 			break;
 		}
 	}
<a href="#h4-19" id="h4-19" class="h">@@ -530,47 +591,45 @@ run(void) {
</a> 
 void
 setup(void) {
<a href="#h4-19-3" id="h4-19-3" class="d">-	int x, y, screen = DefaultScreen(dc-&gt;dpy);
</a><a href="#h4-19-4" id="h4-19-4" class="d">-	Window root = RootWindow(dc-&gt;dpy, screen);
</a><a href="#h4-19-5" id="h4-19-5" class="i">+	int x, y;
</a> 	XSetWindowAttributes swa;
 	XIM xim;
 #ifdef XINERAMA
<a href="#h4-19-9" id="h4-19-9" class="d">-	int n;
</a> 	XineramaScreenInfo *info;
<a href="#h4-19-11" id="h4-19-11" class="i">+	Window w, pw, dw, *dws;
</a><a href="#h4-19-12" id="h4-19-12" class="i">+	XWindowAttributes wa;
</a><a href="#h4-19-13" id="h4-19-13" class="i">+	int a, j, di, n, i = 0, area = 0;
</a><a href="#h4-19-14" id="h4-19-14" class="i">+	unsigned int du;
</a> #endif
 
<a href="#h4-19-17" id="h4-19-17" class="d">-	normcol[ColBG] = getcolor(dc, normbgcolor);
</a><a href="#h4-19-18" id="h4-19-18" class="d">-	normcol[ColFG] = getcolor(dc, normfgcolor);
</a><a href="#h4-19-19" id="h4-19-19" class="d">-	selcol[ColBG]  = getcolor(dc, selbgcolor);
</a><a href="#h4-19-20" id="h4-19-20" class="d">-	selcol[ColFG]  = getcolor(dc, selfgcolor);
</a><a href="#h4-19-21" id="h4-19-21" class="d">-	outcol[ColBG]  = getcolor(dc, outbgcolor);
</a><a href="#h4-19-22" id="h4-19-22" class="d">-	outcol[ColFG]  = getcolor(dc, outfgcolor);
</a><a href="#h4-19-23" id="h4-19-23" class="i">+	/* init appearance */
</a><a href="#h4-19-24" id="h4-19-24" class="i">+	scheme[SchemeNorm].bg = drw_clr_create(drw, normbgcolor);
</a><a href="#h4-19-25" id="h4-19-25" class="i">+	scheme[SchemeNorm].fg = drw_clr_create(drw, normfgcolor);
</a><a href="#h4-19-26" id="h4-19-26" class="i">+	scheme[SchemeSel].bg = drw_clr_create(drw, selbgcolor);
</a><a href="#h4-19-27" id="h4-19-27" class="i">+	scheme[SchemeSel].fg = drw_clr_create(drw, selfgcolor);
</a><a href="#h4-19-28" id="h4-19-28" class="i">+	scheme[SchemeOut].bg = drw_clr_create(drw, outbgcolor);
</a><a href="#h4-19-29" id="h4-19-29" class="i">+	scheme[SchemeOut].fg = drw_clr_create(drw, outfgcolor);
</a> 
<a href="#h4-19-31" id="h4-19-31" class="d">-	clip = XInternAtom(dc-&gt;dpy, &quot;CLIPBOARD&quot;,   False);
</a><a href="#h4-19-32" id="h4-19-32" class="d">-	utf8 = XInternAtom(dc-&gt;dpy, &quot;UTF8_STRING&quot;, False);
</a><a href="#h4-19-33" id="h4-19-33" class="i">+	clip = XInternAtom(dpy, &quot;CLIPBOARD&quot;,   False);
</a><a href="#h4-19-34" id="h4-19-34" class="i">+	utf8 = XInternAtom(dpy, &quot;UTF8_STRING&quot;, False);
</a> 
 	/* calculate menu geometry */
<a href="#h4-19-37" id="h4-19-37" class="d">-	bh = dc-&gt;font.height + 2;
</a><a href="#h4-19-38" id="h4-19-38" class="i">+	bh = drw-&gt;fonts[0]-&gt;h + 2;
</a> 	lines = MAX(lines, 0);
 	mh = (lines + 1) * bh;
 #ifdef XINERAMA
<a href="#h4-19-42" id="h4-19-42" class="d">-	if((info = XineramaQueryScreens(dc-&gt;dpy, &amp;n))) {
</a><a href="#h4-19-43" id="h4-19-43" class="d">-		int a, j, di, i = 0, area = 0;
</a><a href="#h4-19-44" id="h4-19-44" class="d">-		unsigned int du;
</a><a href="#h4-19-45" id="h4-19-45" class="d">-		Window w, pw, dw, *dws;
</a><a href="#h4-19-46" id="h4-19-46" class="d">-		XWindowAttributes wa;
</a><a href="#h4-19-47" id="h4-19-47" class="d">-
</a><a href="#h4-19-48" id="h4-19-48" class="d">-		XGetInputFocus(dc-&gt;dpy, &amp;w, &amp;di);
</a><a href="#h4-19-49" id="h4-19-49" class="i">+	if((info = XineramaQueryScreens(dpy, &amp;n))) {
</a><a href="#h4-19-50" id="h4-19-50" class="i">+		XGetInputFocus(dpy, &amp;w, &amp;di);
</a> 		if(mon != -1 &amp;&amp; mon &lt; n)
 			i = mon;
 		if(!i &amp;&amp; w != root &amp;&amp; w != PointerRoot &amp;&amp; w != None) {
 			/* find top-level window containing current input focus */
 			do {
<a href="#h4-19-56" id="h4-19-56" class="d">-				if(XQueryTree(dc-&gt;dpy, (pw = w), &amp;dw, &amp;w, &amp;dws, &amp;du) &amp;&amp; dws)
</a><a href="#h4-19-57" id="h4-19-57" class="i">+				if(XQueryTree(dpy, (pw = w), &amp;dw, &amp;w, &amp;dws, &amp;du) &amp;&amp; dws)
</a> 					XFree(dws);
 			} while(w != root &amp;&amp; w != pw);
 			/* find xinerama screen with which the window intersects most */
<a href="#h4-19-61" id="h4-19-61" class="d">-			if(XGetWindowAttributes(dc-&gt;dpy, pw, &amp;wa))
</a><a href="#h4-19-62" id="h4-19-62" class="i">+			if(XGetWindowAttributes(dpy, pw, &amp;wa))
</a> 				for(j = 0; j &lt; n; j++)
 					if((a = INTERSECT(wa.x, wa.y, wa.width, wa.height, info[j])) &gt; area) {
 						area = a;
<a href="#h4-20" id="h4-20" class="h">@@ -578,7 +637,7 @@ setup(void) {
</a> 					}
 		}
 		/* no focused window is on screen, so use pointer location instead */
<a href="#h4-20-3" id="h4-20-3" class="d">-		if(mon == -1 &amp;&amp; !area &amp;&amp; XQueryPointer(dc-&gt;dpy, root, &amp;dw, &amp;dw, &amp;x, &amp;y, &amp;di, &amp;di, &amp;du))
</a><a href="#h4-20-4" id="h4-20-4" class="i">+		if(mon == -1 &amp;&amp; !area &amp;&amp; XQueryPointer(dpy, root, &amp;dw, &amp;dw, &amp;x, &amp;y, &amp;di, &amp;di, &amp;du))
</a> 			for(i = 0; i &lt; n; i++)
 				if(INTERSECT(x, y, 1, 1, info[i]))
 					break;
<a href="#h4-21" id="h4-21" class="h">@@ -592,29 +651,29 @@ setup(void) {
</a> #endif
 	{
 		x = 0;
<a href="#h4-21-3" id="h4-21-3" class="d">-		y = topbar ? 0 : DisplayHeight(dc-&gt;dpy, screen) - mh;
</a><a href="#h4-21-4" id="h4-21-4" class="d">-		mw = DisplayWidth(dc-&gt;dpy, screen);
</a><a href="#h4-21-5" id="h4-21-5" class="i">+		y = topbar ? 0 : sh - mh;
</a><a href="#h4-21-6" id="h4-21-6" class="i">+		mw = sw;
</a> 	}
<a href="#h4-21-8" id="h4-21-8" class="d">-	promptw = (prompt &amp;&amp; *prompt) ? textw(dc, prompt) : 0;
</a><a href="#h4-21-9" id="h4-21-9" class="i">+	promptw = (prompt &amp;&amp; *prompt) ? TEXTW(prompt) : 0;
</a> 	inputw = MIN(inputw, mw/3);
 	match();
 
 	/* create menu window */
 	swa.override_redirect = True;
<a href="#h4-21-15" id="h4-21-15" class="d">-	swa.background_pixel = normcol[ColBG];
</a><a href="#h4-21-16" id="h4-21-16" class="i">+	swa.background_pixel = scheme[SchemeNorm].bg-&gt;pix;
</a> 	swa.event_mask = ExposureMask | KeyPressMask | VisibilityChangeMask;
<a href="#h4-21-18" id="h4-21-18" class="d">-	win = XCreateWindow(dc-&gt;dpy, root, x, y, mw, mh, 0,
</a><a href="#h4-21-19" id="h4-21-19" class="d">-	                    DefaultDepth(dc-&gt;dpy, screen), CopyFromParent,
</a><a href="#h4-21-20" id="h4-21-20" class="d">-	                    DefaultVisual(dc-&gt;dpy, screen),
</a><a href="#h4-21-21" id="h4-21-21" class="i">+	win = XCreateWindow(dpy, root, x, y, mw, mh, 0,
</a><a href="#h4-21-22" id="h4-21-22" class="i">+	                    DefaultDepth(dpy, screen), CopyFromParent,
</a><a href="#h4-21-23" id="h4-21-23" class="i">+	                    DefaultVisual(dpy, screen),
</a> 	                    CWOverrideRedirect | CWBackPixel | CWEventMask, &amp;swa);
 
 	/* open input methods */
<a href="#h4-21-27" id="h4-21-27" class="d">-	xim = XOpenIM(dc-&gt;dpy, NULL, NULL, NULL);
</a><a href="#h4-21-28" id="h4-21-28" class="i">+	xim = XOpenIM(dpy, NULL, NULL, NULL);
</a> 	xic = XCreateIC(xim, XNInputStyle, XIMPreeditNothing | XIMStatusNothing,
 	                XNClientWindow, win, XNFocusWindow, win, NULL);
 
<a href="#h4-21-32" id="h4-21-32" class="d">-	XMapRaised(dc-&gt;dpy, win);
</a><a href="#h4-21-33" id="h4-21-33" class="d">-	resizedc(dc, mw, mh);
</a><a href="#h4-21-34" id="h4-21-34" class="i">+	XMapRaised(dpy, win);
</a><a href="#h4-21-35" id="h4-21-35" class="i">+	drw_resize(drw, mw, mh);
</a> 	drawmenu();
 }
 
<a href="#h4-22" id="h4-22" class="h">@@ -622,5 +681,5 @@ void
</a> usage(void) {
 	fputs(&quot;usage: dmenu [-b] [-f] [-i] [-l lines] [-p prompt] [-fn font] [-m monitor]\n&quot;
 	      &quot;             [-nb color] [-nf color] [-sb color] [-sf color] [-v]\n&quot;, stderr);
<a href="#h4-22-3" id="h4-22-3" class="d">-	exit(EXIT_FAILURE);
</a><a href="#h4-22-4" id="h4-22-4" class="i">+	exit(1);
</a> }
<b>diff --git a/<a id="h5" href="../file/draw.c.html">draw.c</a> b/<a href="../file/draw.c.html">draw.c</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,177 +0,0 @@
</a><a href="#h5-0-0" id="h5-0-0" class="d">-/* See LICENSE file for copyright and license details. */
</a><a href="#h5-0-1" id="h5-0-1" class="d">-#include &lt;locale.h&gt;
</a><a href="#h5-0-2" id="h5-0-2" class="d">-#include &lt;stdarg.h&gt;
</a><a href="#h5-0-3" id="h5-0-3" class="d">-#include &lt;stdio.h&gt;
</a><a href="#h5-0-4" id="h5-0-4" class="d">-#include &lt;stdlib.h&gt;
</a><a href="#h5-0-5" id="h5-0-5" class="d">-#include &lt;string.h&gt;
</a><a href="#h5-0-6" id="h5-0-6" class="d">-#include &lt;X11/Xlib.h&gt;
</a><a href="#h5-0-7" id="h5-0-7" class="d">-#include &quot;draw.h&quot;
</a><a href="#h5-0-8" id="h5-0-8" class="d">-
</a><a href="#h5-0-9" id="h5-0-9" class="d">-#define MAX(a, b)  ((a) &gt; (b) ? (a) : (b))
</a><a href="#h5-0-10" id="h5-0-10" class="d">-#define MIN(a, b)  ((a) &lt; (b) ? (a) : (b))
</a><a href="#h5-0-11" id="h5-0-11" class="d">-#define DEFAULTFN  &quot;fixed&quot;
</a><a href="#h5-0-12" id="h5-0-12" class="d">-
</a><a href="#h5-0-13" id="h5-0-13" class="d">-static Bool loadfont(DC *dc, const char *fontstr);
</a><a href="#h5-0-14" id="h5-0-14" class="d">-
</a><a href="#h5-0-15" id="h5-0-15" class="d">-void
</a><a href="#h5-0-16" id="h5-0-16" class="d">-drawrect(DC *dc, int x, int y, unsigned int w, unsigned int h, Bool fill, unsigned long color) {
</a><a href="#h5-0-17" id="h5-0-17" class="d">-	XSetForeground(dc-&gt;dpy, dc-&gt;gc, color);
</a><a href="#h5-0-18" id="h5-0-18" class="d">-	if(fill)
</a><a href="#h5-0-19" id="h5-0-19" class="d">-		XFillRectangle(dc-&gt;dpy, dc-&gt;canvas, dc-&gt;gc, dc-&gt;x + x, dc-&gt;y + y, w, h);
</a><a href="#h5-0-20" id="h5-0-20" class="d">-	else
</a><a href="#h5-0-21" id="h5-0-21" class="d">-		XDrawRectangle(dc-&gt;dpy, dc-&gt;canvas, dc-&gt;gc, dc-&gt;x + x, dc-&gt;y + y, w-1, h-1);
</a><a href="#h5-0-22" id="h5-0-22" class="d">-}
</a><a href="#h5-0-23" id="h5-0-23" class="d">-
</a><a href="#h5-0-24" id="h5-0-24" class="d">-void
</a><a href="#h5-0-25" id="h5-0-25" class="d">-drawtext(DC *dc, const char *text, unsigned long col[ColLast]) {
</a><a href="#h5-0-26" id="h5-0-26" class="d">-	char buf[BUFSIZ];
</a><a href="#h5-0-27" id="h5-0-27" class="d">-	size_t mn, n = strlen(text);
</a><a href="#h5-0-28" id="h5-0-28" class="d">-
</a><a href="#h5-0-29" id="h5-0-29" class="d">-	/* shorten text if necessary */
</a><a href="#h5-0-30" id="h5-0-30" class="d">-	for(mn = MIN(n, sizeof buf); textnw(dc, text, mn) + dc-&gt;font.height/2 &gt; dc-&gt;w; mn--)
</a><a href="#h5-0-31" id="h5-0-31" class="d">-		if(mn == 0)
</a><a href="#h5-0-32" id="h5-0-32" class="d">-			return;
</a><a href="#h5-0-33" id="h5-0-33" class="d">-	memcpy(buf, text, mn);
</a><a href="#h5-0-34" id="h5-0-34" class="d">-	if(mn &lt; n)
</a><a href="#h5-0-35" id="h5-0-35" class="d">-		for(n = MAX(mn-3, 0); n &lt; mn; buf[n++] = &#39;.&#39;);
</a><a href="#h5-0-36" id="h5-0-36" class="d">-
</a><a href="#h5-0-37" id="h5-0-37" class="d">-	drawrect(dc, 0, 0, dc-&gt;w, dc-&gt;h, True, BG(dc, col));
</a><a href="#h5-0-38" id="h5-0-38" class="d">-	drawtextn(dc, buf, mn, col);
</a><a href="#h5-0-39" id="h5-0-39" class="d">-}
</a><a href="#h5-0-40" id="h5-0-40" class="d">-
</a><a href="#h5-0-41" id="h5-0-41" class="d">-void
</a><a href="#h5-0-42" id="h5-0-42" class="d">-drawtextn(DC *dc, const char *text, size_t n, unsigned long col[ColLast]) {
</a><a href="#h5-0-43" id="h5-0-43" class="d">-	int x = dc-&gt;x + dc-&gt;font.height/2;
</a><a href="#h5-0-44" id="h5-0-44" class="d">-	int y = dc-&gt;y + dc-&gt;font.ascent+1;
</a><a href="#h5-0-45" id="h5-0-45" class="d">-
</a><a href="#h5-0-46" id="h5-0-46" class="d">-	XSetForeground(dc-&gt;dpy, dc-&gt;gc, FG(dc, col));
</a><a href="#h5-0-47" id="h5-0-47" class="d">-	if(dc-&gt;font.set)
</a><a href="#h5-0-48" id="h5-0-48" class="d">-		XmbDrawString(dc-&gt;dpy, dc-&gt;canvas, dc-&gt;font.set, dc-&gt;gc, x, y, text, n);
</a><a href="#h5-0-49" id="h5-0-49" class="d">-	else {
</a><a href="#h5-0-50" id="h5-0-50" class="d">-		XSetFont(dc-&gt;dpy, dc-&gt;gc, dc-&gt;font.xfont-&gt;fid);
</a><a href="#h5-0-51" id="h5-0-51" class="d">-		XDrawString(dc-&gt;dpy, dc-&gt;canvas, dc-&gt;gc, x, y, text, n);
</a><a href="#h5-0-52" id="h5-0-52" class="d">-	}
</a><a href="#h5-0-53" id="h5-0-53" class="d">-}
</a><a href="#h5-0-54" id="h5-0-54" class="d">-
</a><a href="#h5-0-55" id="h5-0-55" class="d">-void
</a><a href="#h5-0-56" id="h5-0-56" class="d">-eprintf(const char *fmt, ...) {
</a><a href="#h5-0-57" id="h5-0-57" class="d">-	va_list ap;
</a><a href="#h5-0-58" id="h5-0-58" class="d">-
</a><a href="#h5-0-59" id="h5-0-59" class="d">-	va_start(ap, fmt);
</a><a href="#h5-0-60" id="h5-0-60" class="d">-	vfprintf(stderr, fmt, ap);
</a><a href="#h5-0-61" id="h5-0-61" class="d">-	va_end(ap);
</a><a href="#h5-0-62" id="h5-0-62" class="d">-
</a><a href="#h5-0-63" id="h5-0-63" class="d">-	if(fmt[0] != &#39;\0&#39; &amp;&amp; fmt[strlen(fmt)-1] == &#39;:&#39;) {
</a><a href="#h5-0-64" id="h5-0-64" class="d">-		fputc(&#39; &#39;, stderr);
</a><a href="#h5-0-65" id="h5-0-65" class="d">-		perror(NULL);
</a><a href="#h5-0-66" id="h5-0-66" class="d">-	}
</a><a href="#h5-0-67" id="h5-0-67" class="d">-	exit(EXIT_FAILURE);
</a><a href="#h5-0-68" id="h5-0-68" class="d">-}
</a><a href="#h5-0-69" id="h5-0-69" class="d">-
</a><a href="#h5-0-70" id="h5-0-70" class="d">-void
</a><a href="#h5-0-71" id="h5-0-71" class="d">-freedc(DC *dc) {
</a><a href="#h5-0-72" id="h5-0-72" class="d">-	if(dc-&gt;font.set)
</a><a href="#h5-0-73" id="h5-0-73" class="d">-		XFreeFontSet(dc-&gt;dpy, dc-&gt;font.set);
</a><a href="#h5-0-74" id="h5-0-74" class="d">-	if(dc-&gt;font.xfont)
</a><a href="#h5-0-75" id="h5-0-75" class="d">-		XFreeFont(dc-&gt;dpy, dc-&gt;font.xfont);
</a><a href="#h5-0-76" id="h5-0-76" class="d">-	if(dc-&gt;canvas)
</a><a href="#h5-0-77" id="h5-0-77" class="d">-		XFreePixmap(dc-&gt;dpy, dc-&gt;canvas);
</a><a href="#h5-0-78" id="h5-0-78" class="d">-	XFreeGC(dc-&gt;dpy, dc-&gt;gc);
</a><a href="#h5-0-79" id="h5-0-79" class="d">-	XCloseDisplay(dc-&gt;dpy);
</a><a href="#h5-0-80" id="h5-0-80" class="d">-	free(dc);
</a><a href="#h5-0-81" id="h5-0-81" class="d">-}
</a><a href="#h5-0-82" id="h5-0-82" class="d">-
</a><a href="#h5-0-83" id="h5-0-83" class="d">-unsigned long
</a><a href="#h5-0-84" id="h5-0-84" class="d">-getcolor(DC *dc, const char *colstr) {
</a><a href="#h5-0-85" id="h5-0-85" class="d">-	Colormap cmap = DefaultColormap(dc-&gt;dpy, DefaultScreen(dc-&gt;dpy));
</a><a href="#h5-0-86" id="h5-0-86" class="d">-	XColor color;
</a><a href="#h5-0-87" id="h5-0-87" class="d">-
</a><a href="#h5-0-88" id="h5-0-88" class="d">-	if(!XAllocNamedColor(dc-&gt;dpy, cmap, colstr, &amp;color, &amp;color))
</a><a href="#h5-0-89" id="h5-0-89" class="d">-		eprintf(&quot;cannot allocate color &#39;%s&#39;\n&quot;, colstr);
</a><a href="#h5-0-90" id="h5-0-90" class="d">-	return color.pixel;
</a><a href="#h5-0-91" id="h5-0-91" class="d">-}
</a><a href="#h5-0-92" id="h5-0-92" class="d">-
</a><a href="#h5-0-93" id="h5-0-93" class="d">-DC *
</a><a href="#h5-0-94" id="h5-0-94" class="d">-initdc(void) {
</a><a href="#h5-0-95" id="h5-0-95" class="d">-	DC *dc;
</a><a href="#h5-0-96" id="h5-0-96" class="d">-
</a><a href="#h5-0-97" id="h5-0-97" class="d">-	if(!setlocale(LC_CTYPE, &quot;&quot;) || !XSupportsLocale())
</a><a href="#h5-0-98" id="h5-0-98" class="d">-		fputs(&quot;no locale support\n&quot;, stderr);
</a><a href="#h5-0-99" id="h5-0-99" class="d">-	if(!(dc = calloc(1, sizeof *dc)))
</a><a href="#h5-0-100" id="h5-0-100" class="d">-		eprintf(&quot;cannot malloc %u bytes:&quot;, sizeof *dc);
</a><a href="#h5-0-101" id="h5-0-101" class="d">-	if(!(dc-&gt;dpy = XOpenDisplay(NULL)))
</a><a href="#h5-0-102" id="h5-0-102" class="d">-		eprintf(&quot;cannot open display\n&quot;);
</a><a href="#h5-0-103" id="h5-0-103" class="d">-
</a><a href="#h5-0-104" id="h5-0-104" class="d">-	dc-&gt;gc = XCreateGC(dc-&gt;dpy, DefaultRootWindow(dc-&gt;dpy), 0, NULL);
</a><a href="#h5-0-105" id="h5-0-105" class="d">-	XSetLineAttributes(dc-&gt;dpy, dc-&gt;gc, 1, LineSolid, CapButt, JoinMiter);
</a><a href="#h5-0-106" id="h5-0-106" class="d">-	return dc;
</a><a href="#h5-0-107" id="h5-0-107" class="d">-}
</a><a href="#h5-0-108" id="h5-0-108" class="d">-
</a><a href="#h5-0-109" id="h5-0-109" class="d">-void
</a><a href="#h5-0-110" id="h5-0-110" class="d">-initfont(DC *dc, const char *fontstr) {
</a><a href="#h5-0-111" id="h5-0-111" class="d">-	if(!loadfont(dc, fontstr ? fontstr : DEFAULTFN)) {
</a><a href="#h5-0-112" id="h5-0-112" class="d">-		if(fontstr != NULL)
</a><a href="#h5-0-113" id="h5-0-113" class="d">-			fprintf(stderr, &quot;cannot load font &#39;%s&#39;\n&quot;, fontstr);
</a><a href="#h5-0-114" id="h5-0-114" class="d">-		if(fontstr == NULL || !loadfont(dc, DEFAULTFN))
</a><a href="#h5-0-115" id="h5-0-115" class="d">-			eprintf(&quot;cannot load font &#39;%s&#39;\n&quot;, DEFAULTFN);
</a><a href="#h5-0-116" id="h5-0-116" class="d">-	}
</a><a href="#h5-0-117" id="h5-0-117" class="d">-	dc-&gt;font.height = dc-&gt;font.ascent + dc-&gt;font.descent;
</a><a href="#h5-0-118" id="h5-0-118" class="d">-}
</a><a href="#h5-0-119" id="h5-0-119" class="d">-
</a><a href="#h5-0-120" id="h5-0-120" class="d">-Bool
</a><a href="#h5-0-121" id="h5-0-121" class="d">-loadfont(DC *dc, const char *fontstr) {
</a><a href="#h5-0-122" id="h5-0-122" class="d">-	char *def, **missing, **names;
</a><a href="#h5-0-123" id="h5-0-123" class="d">-	int i, n;
</a><a href="#h5-0-124" id="h5-0-124" class="d">-	XFontStruct **xfonts;
</a><a href="#h5-0-125" id="h5-0-125" class="d">-
</a><a href="#h5-0-126" id="h5-0-126" class="d">-	if(!*fontstr)
</a><a href="#h5-0-127" id="h5-0-127" class="d">-		return False;
</a><a href="#h5-0-128" id="h5-0-128" class="d">-	if((dc-&gt;font.set = XCreateFontSet(dc-&gt;dpy, fontstr, &amp;missing, &amp;n, &amp;def))) {
</a><a href="#h5-0-129" id="h5-0-129" class="d">-		n = XFontsOfFontSet(dc-&gt;font.set, &amp;xfonts, &amp;names);
</a><a href="#h5-0-130" id="h5-0-130" class="d">-		for(i = 0; i &lt; n; i++) {
</a><a href="#h5-0-131" id="h5-0-131" class="d">-			dc-&gt;font.ascent  = MAX(dc-&gt;font.ascent,  xfonts[i]-&gt;ascent);
</a><a href="#h5-0-132" id="h5-0-132" class="d">-			dc-&gt;font.descent = MAX(dc-&gt;font.descent, xfonts[i]-&gt;descent);
</a><a href="#h5-0-133" id="h5-0-133" class="d">-			dc-&gt;font.width   = MAX(dc-&gt;font.width,   xfonts[i]-&gt;max_bounds.width);
</a><a href="#h5-0-134" id="h5-0-134" class="d">-		}
</a><a href="#h5-0-135" id="h5-0-135" class="d">-	}
</a><a href="#h5-0-136" id="h5-0-136" class="d">-	else if((dc-&gt;font.xfont = XLoadQueryFont(dc-&gt;dpy, fontstr))) {
</a><a href="#h5-0-137" id="h5-0-137" class="d">-		dc-&gt;font.ascent  = dc-&gt;font.xfont-&gt;ascent;
</a><a href="#h5-0-138" id="h5-0-138" class="d">-		dc-&gt;font.descent = dc-&gt;font.xfont-&gt;descent;
</a><a href="#h5-0-139" id="h5-0-139" class="d">-		dc-&gt;font.width   = dc-&gt;font.xfont-&gt;max_bounds.width;
</a><a href="#h5-0-140" id="h5-0-140" class="d">-	}
</a><a href="#h5-0-141" id="h5-0-141" class="d">-	if(missing)
</a><a href="#h5-0-142" id="h5-0-142" class="d">-		XFreeStringList(missing);
</a><a href="#h5-0-143" id="h5-0-143" class="d">-	return dc-&gt;font.set || dc-&gt;font.xfont;
</a><a href="#h5-0-144" id="h5-0-144" class="d">-}
</a><a href="#h5-0-145" id="h5-0-145" class="d">-
</a><a href="#h5-0-146" id="h5-0-146" class="d">-void
</a><a href="#h5-0-147" id="h5-0-147" class="d">-mapdc(DC *dc, Window win, unsigned int w, unsigned int h) {
</a><a href="#h5-0-148" id="h5-0-148" class="d">-	XCopyArea(dc-&gt;dpy, dc-&gt;canvas, win, dc-&gt;gc, 0, 0, w, h, 0, 0);
</a><a href="#h5-0-149" id="h5-0-149" class="d">-}
</a><a href="#h5-0-150" id="h5-0-150" class="d">-
</a><a href="#h5-0-151" id="h5-0-151" class="d">-void
</a><a href="#h5-0-152" id="h5-0-152" class="d">-resizedc(DC *dc, unsigned int w, unsigned int h) {
</a><a href="#h5-0-153" id="h5-0-153" class="d">-	if(dc-&gt;canvas)
</a><a href="#h5-0-154" id="h5-0-154" class="d">-		XFreePixmap(dc-&gt;dpy, dc-&gt;canvas);
</a><a href="#h5-0-155" id="h5-0-155" class="d">-
</a><a href="#h5-0-156" id="h5-0-156" class="d">-	dc-&gt;w = w;
</a><a href="#h5-0-157" id="h5-0-157" class="d">-	dc-&gt;h = h;
</a><a href="#h5-0-158" id="h5-0-158" class="d">-	dc-&gt;canvas = XCreatePixmap(dc-&gt;dpy, DefaultRootWindow(dc-&gt;dpy), w, h,
</a><a href="#h5-0-159" id="h5-0-159" class="d">-	                           DefaultDepth(dc-&gt;dpy, DefaultScreen(dc-&gt;dpy)));
</a><a href="#h5-0-160" id="h5-0-160" class="d">-}
</a><a href="#h5-0-161" id="h5-0-161" class="d">-
</a><a href="#h5-0-162" id="h5-0-162" class="d">-int
</a><a href="#h5-0-163" id="h5-0-163" class="d">-textnw(DC *dc, const char *text, size_t len) {
</a><a href="#h5-0-164" id="h5-0-164" class="d">-	if(dc-&gt;font.set) {
</a><a href="#h5-0-165" id="h5-0-165" class="d">-		XRectangle r;
</a><a href="#h5-0-166" id="h5-0-166" class="d">-
</a><a href="#h5-0-167" id="h5-0-167" class="d">-		XmbTextExtents(dc-&gt;font.set, text, len, NULL, &amp;r);
</a><a href="#h5-0-168" id="h5-0-168" class="d">-		return r.width;
</a><a href="#h5-0-169" id="h5-0-169" class="d">-	}
</a><a href="#h5-0-170" id="h5-0-170" class="d">-	return XTextWidth(dc-&gt;font.xfont, text, len);
</a><a href="#h5-0-171" id="h5-0-171" class="d">-}
</a><a href="#h5-0-172" id="h5-0-172" class="d">-
</a><a href="#h5-0-173" id="h5-0-173" class="d">-int
</a><a href="#h5-0-174" id="h5-0-174" class="d">-textw(DC *dc, const char *text) {
</a><a href="#h5-0-175" id="h5-0-175" class="d">-	return textnw(dc, text, strlen(text)) + dc-&gt;font.height;
</a><a href="#h5-0-176" id="h5-0-176" class="d">-}
</a><b>diff --git a/<a id="h6" href="../file/draw.h.html">draw.h</a> b/<a href="../file/draw.h.html">draw.h</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,35 +0,0 @@
</a><a href="#h6-0-0" id="h6-0-0" class="d">-/* See LICENSE file for copyright and license details. */
</a><a href="#h6-0-1" id="h6-0-1" class="d">-
</a><a href="#h6-0-2" id="h6-0-2" class="d">-#define FG(dc, col)  ((col)[(dc)-&gt;invert ? ColBG : ColFG])
</a><a href="#h6-0-3" id="h6-0-3" class="d">-#define BG(dc, col)  ((col)[(dc)-&gt;invert ? ColFG : ColBG])
</a><a href="#h6-0-4" id="h6-0-4" class="d">-
</a><a href="#h6-0-5" id="h6-0-5" class="d">-enum { ColBG, ColFG, ColBorder, ColLast };
</a><a href="#h6-0-6" id="h6-0-6" class="d">-
</a><a href="#h6-0-7" id="h6-0-7" class="d">-typedef struct {
</a><a href="#h6-0-8" id="h6-0-8" class="d">-	int x, y, w, h;
</a><a href="#h6-0-9" id="h6-0-9" class="d">-	Bool invert;
</a><a href="#h6-0-10" id="h6-0-10" class="d">-	Display *dpy;
</a><a href="#h6-0-11" id="h6-0-11" class="d">-	GC gc;
</a><a href="#h6-0-12" id="h6-0-12" class="d">-	Pixmap canvas;
</a><a href="#h6-0-13" id="h6-0-13" class="d">-	struct {
</a><a href="#h6-0-14" id="h6-0-14" class="d">-		int ascent;
</a><a href="#h6-0-15" id="h6-0-15" class="d">-		int descent;
</a><a href="#h6-0-16" id="h6-0-16" class="d">-		int height;
</a><a href="#h6-0-17" id="h6-0-17" class="d">-		int width;
</a><a href="#h6-0-18" id="h6-0-18" class="d">-		XFontSet set;
</a><a href="#h6-0-19" id="h6-0-19" class="d">-		XFontStruct *xfont;
</a><a href="#h6-0-20" id="h6-0-20" class="d">-	} font;
</a><a href="#h6-0-21" id="h6-0-21" class="d">-} DC;  /* draw context */
</a><a href="#h6-0-22" id="h6-0-22" class="d">-
</a><a href="#h6-0-23" id="h6-0-23" class="d">-void drawrect(DC *dc, int x, int y, unsigned int w, unsigned int h, Bool fill, unsigned long color);
</a><a href="#h6-0-24" id="h6-0-24" class="d">-void drawtext(DC *dc, const char *text, unsigned long col[ColLast]);
</a><a href="#h6-0-25" id="h6-0-25" class="d">-void drawtextn(DC *dc, const char *text, size_t n, unsigned long col[ColLast]);
</a><a href="#h6-0-26" id="h6-0-26" class="d">-void eprintf(const char *fmt, ...);
</a><a href="#h6-0-27" id="h6-0-27" class="d">-void freedc(DC *dc);
</a><a href="#h6-0-28" id="h6-0-28" class="d">-unsigned long getcolor(DC *dc, const char *colstr);
</a><a href="#h6-0-29" id="h6-0-29" class="d">-DC *initdc(void);
</a><a href="#h6-0-30" id="h6-0-30" class="d">-void initfont(DC *dc, const char *fontstr);
</a><a href="#h6-0-31" id="h6-0-31" class="d">-void mapdc(DC *dc, Window win, unsigned int w, unsigned int h);
</a><a href="#h6-0-32" id="h6-0-32" class="d">-void resizedc(DC *dc, unsigned int w, unsigned int h);
</a><a href="#h6-0-33" id="h6-0-33" class="d">-int textnw(DC *dc, const char *text, size_t len);
</a><a href="#h6-0-34" id="h6-0-34" class="d">-int textw(DC *dc, const char *text);
</a><b>diff --git a/<a id="h7" href="../file/drw.c.html">drw.c</a> b/<a href="../file/drw.c.html">drw.c</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,413 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+/* See LICENSE file for copyright and license details. */
</a><a href="#h7-0-1" id="h7-0-1" class="i">+#include &lt;stdio.h&gt;
</a><a href="#h7-0-2" id="h7-0-2" class="i">+#include &lt;stdlib.h&gt;
</a><a href="#h7-0-3" id="h7-0-3" class="i">+#include &lt;string.h&gt;
</a><a href="#h7-0-4" id="h7-0-4" class="i">+#include &lt;X11/Xlib.h&gt;
</a><a href="#h7-0-5" id="h7-0-5" class="i">+#include &lt;X11/Xft/Xft.h&gt;
</a><a href="#h7-0-6" id="h7-0-6" class="i">+
</a><a href="#h7-0-7" id="h7-0-7" class="i">+#include &quot;drw.h&quot;
</a><a href="#h7-0-8" id="h7-0-8" class="i">+#include &quot;util.h&quot;
</a><a href="#h7-0-9" id="h7-0-9" class="i">+
</a><a href="#h7-0-10" id="h7-0-10" class="i">+#define UTF_INVALID 0xFFFD
</a><a href="#h7-0-11" id="h7-0-11" class="i">+#define UTF_SIZ 4
</a><a href="#h7-0-12" id="h7-0-12" class="i">+
</a><a href="#h7-0-13" id="h7-0-13" class="i">+static const unsigned char utfbyte[UTF_SIZ + 1] = {0x80,    0, 0xC0, 0xE0, 0xF0};
</a><a href="#h7-0-14" id="h7-0-14" class="i">+static const unsigned char utfmask[UTF_SIZ + 1] = {0xC0, 0x80, 0xE0, 0xF0, 0xF8};
</a><a href="#h7-0-15" id="h7-0-15" class="i">+static const long utfmin[UTF_SIZ + 1] = {       0,    0,  0x80,  0x800,  0x10000};
</a><a href="#h7-0-16" id="h7-0-16" class="i">+static const long utfmax[UTF_SIZ + 1] = {0x10FFFF, 0x7F, 0x7FF, 0xFFFF, 0x10FFFF};
</a><a href="#h7-0-17" id="h7-0-17" class="i">+
</a><a href="#h7-0-18" id="h7-0-18" class="i">+static long
</a><a href="#h7-0-19" id="h7-0-19" class="i">+utf8decodebyte(const char c, size_t *i) {
</a><a href="#h7-0-20" id="h7-0-20" class="i">+	for(*i = 0; *i &lt; (UTF_SIZ + 1); ++(*i))
</a><a href="#h7-0-21" id="h7-0-21" class="i">+		if(((unsigned char)c &amp; utfmask[*i]) == utfbyte[*i])
</a><a href="#h7-0-22" id="h7-0-22" class="i">+			return (unsigned char)c &amp; ~utfmask[*i];
</a><a href="#h7-0-23" id="h7-0-23" class="i">+	return 0;
</a><a href="#h7-0-24" id="h7-0-24" class="i">+}
</a><a href="#h7-0-25" id="h7-0-25" class="i">+
</a><a href="#h7-0-26" id="h7-0-26" class="i">+static size_t
</a><a href="#h7-0-27" id="h7-0-27" class="i">+utf8validate(long *u, size_t i) {
</a><a href="#h7-0-28" id="h7-0-28" class="i">+	if(!BETWEEN(*u, utfmin[i], utfmax[i]) || BETWEEN(*u, 0xD800, 0xDFFF))
</a><a href="#h7-0-29" id="h7-0-29" class="i">+		*u = UTF_INVALID;
</a><a href="#h7-0-30" id="h7-0-30" class="i">+	for(i = 1; *u &gt; utfmax[i]; ++i)
</a><a href="#h7-0-31" id="h7-0-31" class="i">+		;
</a><a href="#h7-0-32" id="h7-0-32" class="i">+	return i;
</a><a href="#h7-0-33" id="h7-0-33" class="i">+}
</a><a href="#h7-0-34" id="h7-0-34" class="i">+
</a><a href="#h7-0-35" id="h7-0-35" class="i">+static size_t
</a><a href="#h7-0-36" id="h7-0-36" class="i">+utf8decode(const char *c, long *u, size_t clen) {
</a><a href="#h7-0-37" id="h7-0-37" class="i">+	size_t i, j, len, type;
</a><a href="#h7-0-38" id="h7-0-38" class="i">+	long udecoded;
</a><a href="#h7-0-39" id="h7-0-39" class="i">+
</a><a href="#h7-0-40" id="h7-0-40" class="i">+	*u = UTF_INVALID;
</a><a href="#h7-0-41" id="h7-0-41" class="i">+	if(!clen)
</a><a href="#h7-0-42" id="h7-0-42" class="i">+		return 0;
</a><a href="#h7-0-43" id="h7-0-43" class="i">+	udecoded = utf8decodebyte(c[0], &amp;len);
</a><a href="#h7-0-44" id="h7-0-44" class="i">+	if(!BETWEEN(len, 1, UTF_SIZ))
</a><a href="#h7-0-45" id="h7-0-45" class="i">+		return 1;
</a><a href="#h7-0-46" id="h7-0-46" class="i">+	for(i = 1, j = 1; i &lt; clen &amp;&amp; j &lt; len; ++i, ++j) {
</a><a href="#h7-0-47" id="h7-0-47" class="i">+		udecoded = (udecoded &lt;&lt; 6) | utf8decodebyte(c[i], &amp;type);
</a><a href="#h7-0-48" id="h7-0-48" class="i">+		if(type != 0)
</a><a href="#h7-0-49" id="h7-0-49" class="i">+			return j;
</a><a href="#h7-0-50" id="h7-0-50" class="i">+	}
</a><a href="#h7-0-51" id="h7-0-51" class="i">+	if(j &lt; len)
</a><a href="#h7-0-52" id="h7-0-52" class="i">+		return 0;
</a><a href="#h7-0-53" id="h7-0-53" class="i">+	*u = udecoded;
</a><a href="#h7-0-54" id="h7-0-54" class="i">+	utf8validate(u, len);
</a><a href="#h7-0-55" id="h7-0-55" class="i">+	return len;
</a><a href="#h7-0-56" id="h7-0-56" class="i">+}
</a><a href="#h7-0-57" id="h7-0-57" class="i">+
</a><a href="#h7-0-58" id="h7-0-58" class="i">+Drw *
</a><a href="#h7-0-59" id="h7-0-59" class="i">+drw_create(Display *dpy, int screen, Window root, unsigned int w, unsigned int h) {
</a><a href="#h7-0-60" id="h7-0-60" class="i">+	Drw *drw = (Drw *)calloc(1, sizeof(Drw));
</a><a href="#h7-0-61" id="h7-0-61" class="i">+	if(!drw)
</a><a href="#h7-0-62" id="h7-0-62" class="i">+		return NULL;
</a><a href="#h7-0-63" id="h7-0-63" class="i">+	drw-&gt;dpy = dpy;
</a><a href="#h7-0-64" id="h7-0-64" class="i">+	drw-&gt;screen = screen;
</a><a href="#h7-0-65" id="h7-0-65" class="i">+	drw-&gt;root = root;
</a><a href="#h7-0-66" id="h7-0-66" class="i">+	drw-&gt;w = w;
</a><a href="#h7-0-67" id="h7-0-67" class="i">+	drw-&gt;h = h;
</a><a href="#h7-0-68" id="h7-0-68" class="i">+	drw-&gt;drawable = XCreatePixmap(dpy, root, w, h, DefaultDepth(dpy, screen));
</a><a href="#h7-0-69" id="h7-0-69" class="i">+	drw-&gt;gc = XCreateGC(dpy, root, 0, NULL);
</a><a href="#h7-0-70" id="h7-0-70" class="i">+	drw-&gt;fontcount = 0;
</a><a href="#h7-0-71" id="h7-0-71" class="i">+	XSetLineAttributes(dpy, drw-&gt;gc, 1, LineSolid, CapButt, JoinMiter);
</a><a href="#h7-0-72" id="h7-0-72" class="i">+	return drw;
</a><a href="#h7-0-73" id="h7-0-73" class="i">+}
</a><a href="#h7-0-74" id="h7-0-74" class="i">+
</a><a href="#h7-0-75" id="h7-0-75" class="i">+void
</a><a href="#h7-0-76" id="h7-0-76" class="i">+drw_resize(Drw *drw, unsigned int w, unsigned int h) {
</a><a href="#h7-0-77" id="h7-0-77" class="i">+	if(!drw)
</a><a href="#h7-0-78" id="h7-0-78" class="i">+		return;
</a><a href="#h7-0-79" id="h7-0-79" class="i">+	drw-&gt;w = w;
</a><a href="#h7-0-80" id="h7-0-80" class="i">+	drw-&gt;h = h;
</a><a href="#h7-0-81" id="h7-0-81" class="i">+	if(drw-&gt;drawable != 0)
</a><a href="#h7-0-82" id="h7-0-82" class="i">+		XFreePixmap(drw-&gt;dpy, drw-&gt;drawable);
</a><a href="#h7-0-83" id="h7-0-83" class="i">+	drw-&gt;drawable = XCreatePixmap(drw-&gt;dpy, drw-&gt;root, w, h, DefaultDepth(drw-&gt;dpy, drw-&gt;screen));
</a><a href="#h7-0-84" id="h7-0-84" class="i">+}
</a><a href="#h7-0-85" id="h7-0-85" class="i">+
</a><a href="#h7-0-86" id="h7-0-86" class="i">+void
</a><a href="#h7-0-87" id="h7-0-87" class="i">+drw_free(Drw *drw) {
</a><a href="#h7-0-88" id="h7-0-88" class="i">+	size_t i;
</a><a href="#h7-0-89" id="h7-0-89" class="i">+
</a><a href="#h7-0-90" id="h7-0-90" class="i">+	for (i = 0; i &lt; drw-&gt;fontcount; i++) {
</a><a href="#h7-0-91" id="h7-0-91" class="i">+		drw_font_free(drw-&gt;fonts[i]);
</a><a href="#h7-0-92" id="h7-0-92" class="i">+	}
</a><a href="#h7-0-93" id="h7-0-93" class="i">+	XFreePixmap(drw-&gt;dpy, drw-&gt;drawable);
</a><a href="#h7-0-94" id="h7-0-94" class="i">+	XFreeGC(drw-&gt;dpy, drw-&gt;gc);
</a><a href="#h7-0-95" id="h7-0-95" class="i">+	free(drw);
</a><a href="#h7-0-96" id="h7-0-96" class="i">+}
</a><a href="#h7-0-97" id="h7-0-97" class="i">+
</a><a href="#h7-0-98" id="h7-0-98" class="i">+/* This function is an implementation detail. Library users should use
</a><a href="#h7-0-99" id="h7-0-99" class="i">+ * drw_font_create instead.
</a><a href="#h7-0-100" id="h7-0-100" class="i">+ */
</a><a href="#h7-0-101" id="h7-0-101" class="i">+static Fnt *
</a><a href="#h7-0-102" id="h7-0-102" class="i">+drw_font_xcreate(Drw *drw, const char *fontname, FcPattern *fontpattern) {
</a><a href="#h7-0-103" id="h7-0-103" class="i">+	Fnt *font;
</a><a href="#h7-0-104" id="h7-0-104" class="i">+
</a><a href="#h7-0-105" id="h7-0-105" class="i">+	if (!(fontname || fontpattern))
</a><a href="#h7-0-106" id="h7-0-106" class="i">+		die(&quot;No font specified.\n&quot;);
</a><a href="#h7-0-107" id="h7-0-107" class="i">+
</a><a href="#h7-0-108" id="h7-0-108" class="i">+	if (!(font = (Fnt *)calloc(1, sizeof(Fnt))))
</a><a href="#h7-0-109" id="h7-0-109" class="i">+		return NULL;
</a><a href="#h7-0-110" id="h7-0-110" class="i">+
</a><a href="#h7-0-111" id="h7-0-111" class="i">+	if (fontname) {
</a><a href="#h7-0-112" id="h7-0-112" class="i">+		/* Using the pattern found at font-&gt;xfont-&gt;pattern does not yield same
</a><a href="#h7-0-113" id="h7-0-113" class="i">+		 * the same substitution results as using the pattern returned by
</a><a href="#h7-0-114" id="h7-0-114" class="i">+		 * FcNameParse; using the latter results in the desired fallback
</a><a href="#h7-0-115" id="h7-0-115" class="i">+		 * behaviour whereas the former just results in
</a><a href="#h7-0-116" id="h7-0-116" class="i">+		 * missing-character-rectangles being drawn, at least with some fonts.
</a><a href="#h7-0-117" id="h7-0-117" class="i">+		 */
</a><a href="#h7-0-118" id="h7-0-118" class="i">+		if (!(font-&gt;xfont = XftFontOpenName(drw-&gt;dpy, drw-&gt;screen, fontname)) ||
</a><a href="#h7-0-119" id="h7-0-119" class="i">+		    !(font-&gt;pattern = FcNameParse((FcChar8 *) fontname))) {
</a><a href="#h7-0-120" id="h7-0-120" class="i">+			if (font-&gt;xfont) {
</a><a href="#h7-0-121" id="h7-0-121" class="i">+				XftFontClose(drw-&gt;dpy, font-&gt;xfont);
</a><a href="#h7-0-122" id="h7-0-122" class="i">+				font-&gt;xfont = NULL;
</a><a href="#h7-0-123" id="h7-0-123" class="i">+			}
</a><a href="#h7-0-124" id="h7-0-124" class="i">+			fprintf(stderr, &quot;error, cannot load font: &#39;%s&#39;\n&quot;, fontname);
</a><a href="#h7-0-125" id="h7-0-125" class="i">+		}
</a><a href="#h7-0-126" id="h7-0-126" class="i">+	} else if (fontpattern) {
</a><a href="#h7-0-127" id="h7-0-127" class="i">+		if (!(font-&gt;xfont = XftFontOpenPattern(drw-&gt;dpy, fontpattern))) {
</a><a href="#h7-0-128" id="h7-0-128" class="i">+			fprintf(stderr, &quot;error, cannot load font pattern.\n&quot;);
</a><a href="#h7-0-129" id="h7-0-129" class="i">+		} else {
</a><a href="#h7-0-130" id="h7-0-130" class="i">+			font-&gt;pattern = NULL;
</a><a href="#h7-0-131" id="h7-0-131" class="i">+		}
</a><a href="#h7-0-132" id="h7-0-132" class="i">+	}
</a><a href="#h7-0-133" id="h7-0-133" class="i">+
</a><a href="#h7-0-134" id="h7-0-134" class="i">+	if (!font-&gt;xfont) {
</a><a href="#h7-0-135" id="h7-0-135" class="i">+		free(font);
</a><a href="#h7-0-136" id="h7-0-136" class="i">+		return NULL;
</a><a href="#h7-0-137" id="h7-0-137" class="i">+	}
</a><a href="#h7-0-138" id="h7-0-138" class="i">+
</a><a href="#h7-0-139" id="h7-0-139" class="i">+	font-&gt;ascent = font-&gt;xfont-&gt;ascent;
</a><a href="#h7-0-140" id="h7-0-140" class="i">+	font-&gt;descent = font-&gt;xfont-&gt;descent;
</a><a href="#h7-0-141" id="h7-0-141" class="i">+	font-&gt;h = font-&gt;ascent + font-&gt;descent;
</a><a href="#h7-0-142" id="h7-0-142" class="i">+	font-&gt;dpy = drw-&gt;dpy;
</a><a href="#h7-0-143" id="h7-0-143" class="i">+	return font;
</a><a href="#h7-0-144" id="h7-0-144" class="i">+}
</a><a href="#h7-0-145" id="h7-0-145" class="i">+
</a><a href="#h7-0-146" id="h7-0-146" class="i">+Fnt*
</a><a href="#h7-0-147" id="h7-0-147" class="i">+drw_font_create(Drw *drw, const char *fontname) {
</a><a href="#h7-0-148" id="h7-0-148" class="i">+	return drw_font_xcreate(drw, fontname, NULL);
</a><a href="#h7-0-149" id="h7-0-149" class="i">+}
</a><a href="#h7-0-150" id="h7-0-150" class="i">+
</a><a href="#h7-0-151" id="h7-0-151" class="i">+void
</a><a href="#h7-0-152" id="h7-0-152" class="i">+drw_load_fonts(Drw* drw, const char *fonts[], size_t fontcount) {
</a><a href="#h7-0-153" id="h7-0-153" class="i">+	size_t i;
</a><a href="#h7-0-154" id="h7-0-154" class="i">+	Fnt *font;
</a><a href="#h7-0-155" id="h7-0-155" class="i">+
</a><a href="#h7-0-156" id="h7-0-156" class="i">+	for (i = 0; i &lt; fontcount; i++) {
</a><a href="#h7-0-157" id="h7-0-157" class="i">+		if (drw-&gt;fontcount &gt;= DRW_FONT_CACHE_SIZE) {
</a><a href="#h7-0-158" id="h7-0-158" class="i">+			die(&quot;Font cache exhausted.\n&quot;);
</a><a href="#h7-0-159" id="h7-0-159" class="i">+		} else if ((font = drw_font_xcreate(drw, fonts[i], NULL))) {
</a><a href="#h7-0-160" id="h7-0-160" class="i">+			drw-&gt;fonts[drw-&gt;fontcount++] = font;
</a><a href="#h7-0-161" id="h7-0-161" class="i">+		}
</a><a href="#h7-0-162" id="h7-0-162" class="i">+	}
</a><a href="#h7-0-163" id="h7-0-163" class="i">+}
</a><a href="#h7-0-164" id="h7-0-164" class="i">+
</a><a href="#h7-0-165" id="h7-0-165" class="i">+void
</a><a href="#h7-0-166" id="h7-0-166" class="i">+drw_font_free(Fnt *font) {
</a><a href="#h7-0-167" id="h7-0-167" class="i">+	if(!font)
</a><a href="#h7-0-168" id="h7-0-168" class="i">+		return;
</a><a href="#h7-0-169" id="h7-0-169" class="i">+	if(font-&gt;pattern)
</a><a href="#h7-0-170" id="h7-0-170" class="i">+		FcPatternDestroy(font-&gt;pattern);
</a><a href="#h7-0-171" id="h7-0-171" class="i">+	XftFontClose(font-&gt;dpy, font-&gt;xfont);
</a><a href="#h7-0-172" id="h7-0-172" class="i">+	free(font);
</a><a href="#h7-0-173" id="h7-0-173" class="i">+}
</a><a href="#h7-0-174" id="h7-0-174" class="i">+
</a><a href="#h7-0-175" id="h7-0-175" class="i">+Clr *
</a><a href="#h7-0-176" id="h7-0-176" class="i">+drw_clr_create(Drw *drw, const char *clrname) {
</a><a href="#h7-0-177" id="h7-0-177" class="i">+	Clr *clr;
</a><a href="#h7-0-178" id="h7-0-178" class="i">+	Colormap cmap;
</a><a href="#h7-0-179" id="h7-0-179" class="i">+	Visual *vis;
</a><a href="#h7-0-180" id="h7-0-180" class="i">+
</a><a href="#h7-0-181" id="h7-0-181" class="i">+	if(!drw)
</a><a href="#h7-0-182" id="h7-0-182" class="i">+		return NULL;
</a><a href="#h7-0-183" id="h7-0-183" class="i">+	clr = (Clr *)calloc(1, sizeof(Clr));
</a><a href="#h7-0-184" id="h7-0-184" class="i">+	if(!clr)
</a><a href="#h7-0-185" id="h7-0-185" class="i">+		return NULL;
</a><a href="#h7-0-186" id="h7-0-186" class="i">+	cmap = DefaultColormap(drw-&gt;dpy, drw-&gt;screen);
</a><a href="#h7-0-187" id="h7-0-187" class="i">+	vis = DefaultVisual(drw-&gt;dpy, drw-&gt;screen);
</a><a href="#h7-0-188" id="h7-0-188" class="i">+	if(!XftColorAllocName(drw-&gt;dpy, vis, cmap, clrname, &amp;clr-&gt;rgb))
</a><a href="#h7-0-189" id="h7-0-189" class="i">+		die(&quot;error, cannot allocate color &#39;%s&#39;\n&quot;, clrname);
</a><a href="#h7-0-190" id="h7-0-190" class="i">+	clr-&gt;pix = clr-&gt;rgb.pixel;
</a><a href="#h7-0-191" id="h7-0-191" class="i">+	return clr;
</a><a href="#h7-0-192" id="h7-0-192" class="i">+}
</a><a href="#h7-0-193" id="h7-0-193" class="i">+
</a><a href="#h7-0-194" id="h7-0-194" class="i">+void
</a><a href="#h7-0-195" id="h7-0-195" class="i">+drw_clr_free(Clr *clr) {
</a><a href="#h7-0-196" id="h7-0-196" class="i">+	free(clr);
</a><a href="#h7-0-197" id="h7-0-197" class="i">+}
</a><a href="#h7-0-198" id="h7-0-198" class="i">+
</a><a href="#h7-0-199" id="h7-0-199" class="i">+void
</a><a href="#h7-0-200" id="h7-0-200" class="i">+drw_setscheme(Drw *drw, ClrScheme *scheme) {
</a><a href="#h7-0-201" id="h7-0-201" class="i">+	if(!drw)
</a><a href="#h7-0-202" id="h7-0-202" class="i">+		return;
</a><a href="#h7-0-203" id="h7-0-203" class="i">+	drw-&gt;scheme = scheme;
</a><a href="#h7-0-204" id="h7-0-204" class="i">+}
</a><a href="#h7-0-205" id="h7-0-205" class="i">+
</a><a href="#h7-0-206" id="h7-0-206" class="i">+void
</a><a href="#h7-0-207" id="h7-0-207" class="i">+drw_rect(Drw *drw, int x, int y, unsigned int w, unsigned int h, int filled, int empty, int invert) {
</a><a href="#h7-0-208" id="h7-0-208" class="i">+	if(!drw || !drw-&gt;scheme)
</a><a href="#h7-0-209" id="h7-0-209" class="i">+		return;
</a><a href="#h7-0-210" id="h7-0-210" class="i">+	XSetForeground(drw-&gt;dpy, drw-&gt;gc, invert ? drw-&gt;scheme-&gt;bg-&gt;pix : drw-&gt;scheme-&gt;fg-&gt;pix);
</a><a href="#h7-0-211" id="h7-0-211" class="i">+	if(filled)
</a><a href="#h7-0-212" id="h7-0-212" class="i">+		XFillRectangle(drw-&gt;dpy, drw-&gt;drawable, drw-&gt;gc, x, y, w + 1, h + 1);
</a><a href="#h7-0-213" id="h7-0-213" class="i">+	else if(empty)
</a><a href="#h7-0-214" id="h7-0-214" class="i">+		XDrawRectangle(drw-&gt;dpy, drw-&gt;drawable, drw-&gt;gc, x, y, w, h);
</a><a href="#h7-0-215" id="h7-0-215" class="i">+}
</a><a href="#h7-0-216" id="h7-0-216" class="i">+
</a><a href="#h7-0-217" id="h7-0-217" class="i">+int
</a><a href="#h7-0-218" id="h7-0-218" class="i">+drw_text(Drw *drw, int x, int y, unsigned int w, unsigned int h, const char *text, int invert) {
</a><a href="#h7-0-219" id="h7-0-219" class="i">+	char buf[1024];
</a><a href="#h7-0-220" id="h7-0-220" class="i">+	int tx, ty, th;
</a><a href="#h7-0-221" id="h7-0-221" class="i">+	Extnts tex;
</a><a href="#h7-0-222" id="h7-0-222" class="i">+	Colormap cmap;
</a><a href="#h7-0-223" id="h7-0-223" class="i">+	Visual *vis;
</a><a href="#h7-0-224" id="h7-0-224" class="i">+	XftDraw *d;
</a><a href="#h7-0-225" id="h7-0-225" class="i">+	Fnt *curfont, *nextfont;
</a><a href="#h7-0-226" id="h7-0-226" class="i">+	size_t i, len;
</a><a href="#h7-0-227" id="h7-0-227" class="i">+	int utf8strlen, utf8charlen, render;
</a><a href="#h7-0-228" id="h7-0-228" class="i">+	long utf8codepoint = 0;
</a><a href="#h7-0-229" id="h7-0-229" class="i">+	const char *utf8str;
</a><a href="#h7-0-230" id="h7-0-230" class="i">+	FcCharSet *fccharset;
</a><a href="#h7-0-231" id="h7-0-231" class="i">+	FcPattern *fcpattern;
</a><a href="#h7-0-232" id="h7-0-232" class="i">+	FcPattern *match;
</a><a href="#h7-0-233" id="h7-0-233" class="i">+	XftResult result;
</a><a href="#h7-0-234" id="h7-0-234" class="i">+	int charexists = 0;
</a><a href="#h7-0-235" id="h7-0-235" class="i">+
</a><a href="#h7-0-236" id="h7-0-236" class="i">+	if (!(render = x || y || w || h)) {
</a><a href="#h7-0-237" id="h7-0-237" class="i">+		w = ~w;
</a><a href="#h7-0-238" id="h7-0-238" class="i">+	}
</a><a href="#h7-0-239" id="h7-0-239" class="i">+
</a><a href="#h7-0-240" id="h7-0-240" class="i">+	if (!drw || !drw-&gt;scheme) {
</a><a href="#h7-0-241" id="h7-0-241" class="i">+		return 0;
</a><a href="#h7-0-242" id="h7-0-242" class="i">+	} else if (render) {
</a><a href="#h7-0-243" id="h7-0-243" class="i">+		XSetForeground(drw-&gt;dpy, drw-&gt;gc, invert ? drw-&gt;scheme-&gt;fg-&gt;pix : drw-&gt;scheme-&gt;bg-&gt;pix);
</a><a href="#h7-0-244" id="h7-0-244" class="i">+		XFillRectangle(drw-&gt;dpy, drw-&gt;drawable, drw-&gt;gc, x, y, w, h);
</a><a href="#h7-0-245" id="h7-0-245" class="i">+	}
</a><a href="#h7-0-246" id="h7-0-246" class="i">+
</a><a href="#h7-0-247" id="h7-0-247" class="i">+	if (!text || !drw-&gt;fontcount) {
</a><a href="#h7-0-248" id="h7-0-248" class="i">+		return 0;
</a><a href="#h7-0-249" id="h7-0-249" class="i">+	} else if (render) {
</a><a href="#h7-0-250" id="h7-0-250" class="i">+		cmap = DefaultColormap(drw-&gt;dpy, drw-&gt;screen);
</a><a href="#h7-0-251" id="h7-0-251" class="i">+		vis = DefaultVisual(drw-&gt;dpy, drw-&gt;screen);
</a><a href="#h7-0-252" id="h7-0-252" class="i">+		d = XftDrawCreate(drw-&gt;dpy, drw-&gt;drawable, vis, cmap);
</a><a href="#h7-0-253" id="h7-0-253" class="i">+	}
</a><a href="#h7-0-254" id="h7-0-254" class="i">+
</a><a href="#h7-0-255" id="h7-0-255" class="i">+	curfont = drw-&gt;fonts[0];
</a><a href="#h7-0-256" id="h7-0-256" class="i">+	while (1) {
</a><a href="#h7-0-257" id="h7-0-257" class="i">+		utf8strlen = 0;
</a><a href="#h7-0-258" id="h7-0-258" class="i">+		utf8str = text;
</a><a href="#h7-0-259" id="h7-0-259" class="i">+		nextfont = NULL;
</a><a href="#h7-0-260" id="h7-0-260" class="i">+		while (*text) {
</a><a href="#h7-0-261" id="h7-0-261" class="i">+			utf8charlen = utf8decode(text, &amp;utf8codepoint, UTF_SIZ);
</a><a href="#h7-0-262" id="h7-0-262" class="i">+			for (i = 0; i &lt; drw-&gt;fontcount; i++) {
</a><a href="#h7-0-263" id="h7-0-263" class="i">+				charexists = charexists || XftCharExists(drw-&gt;dpy, drw-&gt;fonts[i]-&gt;xfont, utf8codepoint);
</a><a href="#h7-0-264" id="h7-0-264" class="i">+				if (charexists) {
</a><a href="#h7-0-265" id="h7-0-265" class="i">+					if (drw-&gt;fonts[i] == curfont) {
</a><a href="#h7-0-266" id="h7-0-266" class="i">+						utf8strlen += utf8charlen;
</a><a href="#h7-0-267" id="h7-0-267" class="i">+						text += utf8charlen;
</a><a href="#h7-0-268" id="h7-0-268" class="i">+					} else {
</a><a href="#h7-0-269" id="h7-0-269" class="i">+						nextfont = drw-&gt;fonts[i];
</a><a href="#h7-0-270" id="h7-0-270" class="i">+					}
</a><a href="#h7-0-271" id="h7-0-271" class="i">+					break;
</a><a href="#h7-0-272" id="h7-0-272" class="i">+				}
</a><a href="#h7-0-273" id="h7-0-273" class="i">+			}
</a><a href="#h7-0-274" id="h7-0-274" class="i">+
</a><a href="#h7-0-275" id="h7-0-275" class="i">+			if (!charexists || (nextfont &amp;&amp; nextfont != curfont)) {
</a><a href="#h7-0-276" id="h7-0-276" class="i">+				break;
</a><a href="#h7-0-277" id="h7-0-277" class="i">+			} else {
</a><a href="#h7-0-278" id="h7-0-278" class="i">+				charexists = 0;
</a><a href="#h7-0-279" id="h7-0-279" class="i">+			}
</a><a href="#h7-0-280" id="h7-0-280" class="i">+		}
</a><a href="#h7-0-281" id="h7-0-281" class="i">+
</a><a href="#h7-0-282" id="h7-0-282" class="i">+		if (utf8strlen) {
</a><a href="#h7-0-283" id="h7-0-283" class="i">+			drw_font_getexts(curfont, utf8str, utf8strlen, &amp;tex);
</a><a href="#h7-0-284" id="h7-0-284" class="i">+			/* shorten text if necessary */
</a><a href="#h7-0-285" id="h7-0-285" class="i">+			for(len = MIN(utf8strlen, (sizeof buf) - 1); len &amp;&amp; (tex.w &gt; w - drw-&gt;fonts[0]-&gt;h || w &lt; drw-&gt;fonts[0]-&gt;h); len--)
</a><a href="#h7-0-286" id="h7-0-286" class="i">+				drw_font_getexts(curfont, utf8str, len, &amp;tex);
</a><a href="#h7-0-287" id="h7-0-287" class="i">+
</a><a href="#h7-0-288" id="h7-0-288" class="i">+			if (len) {
</a><a href="#h7-0-289" id="h7-0-289" class="i">+				memcpy(buf, utf8str, len);
</a><a href="#h7-0-290" id="h7-0-290" class="i">+				buf[len] = &#39;\0&#39;;
</a><a href="#h7-0-291" id="h7-0-291" class="i">+				if(len &lt; utf8strlen)
</a><a href="#h7-0-292" id="h7-0-292" class="i">+					for(i = len; i &amp;&amp; i &gt; len - 3; buf[--i] = &#39;.&#39;);
</a><a href="#h7-0-293" id="h7-0-293" class="i">+
</a><a href="#h7-0-294" id="h7-0-294" class="i">+				if (render) {
</a><a href="#h7-0-295" id="h7-0-295" class="i">+					th = curfont-&gt;ascent + curfont-&gt;descent;
</a><a href="#h7-0-296" id="h7-0-296" class="i">+					ty = y + (h / 2) - (th / 2) + curfont-&gt;ascent;
</a><a href="#h7-0-297" id="h7-0-297" class="i">+					tx = x + (h / 2);
</a><a href="#h7-0-298" id="h7-0-298" class="i">+					XftDrawStringUtf8(d, invert ? &amp;drw-&gt;scheme-&gt;bg-&gt;rgb : &amp;drw-&gt;scheme-&gt;fg-&gt;rgb, curfont-&gt;xfont, tx, ty, (XftChar8 *)buf, len);
</a><a href="#h7-0-299" id="h7-0-299" class="i">+				}
</a><a href="#h7-0-300" id="h7-0-300" class="i">+
</a><a href="#h7-0-301" id="h7-0-301" class="i">+				x += tex.w;
</a><a href="#h7-0-302" id="h7-0-302" class="i">+				w -= tex.w;
</a><a href="#h7-0-303" id="h7-0-303" class="i">+			}
</a><a href="#h7-0-304" id="h7-0-304" class="i">+		}
</a><a href="#h7-0-305" id="h7-0-305" class="i">+
</a><a href="#h7-0-306" id="h7-0-306" class="i">+		if (!*text) {
</a><a href="#h7-0-307" id="h7-0-307" class="i">+			break;
</a><a href="#h7-0-308" id="h7-0-308" class="i">+		} else if (nextfont) {
</a><a href="#h7-0-309" id="h7-0-309" class="i">+			charexists = 0;
</a><a href="#h7-0-310" id="h7-0-310" class="i">+			curfont = nextfont;
</a><a href="#h7-0-311" id="h7-0-311" class="i">+		} else {
</a><a href="#h7-0-312" id="h7-0-312" class="i">+			/* Regardless of whether or not a fallback font is found, the
</a><a href="#h7-0-313" id="h7-0-313" class="i">+			 * character must be drawn.
</a><a href="#h7-0-314" id="h7-0-314" class="i">+			 */
</a><a href="#h7-0-315" id="h7-0-315" class="i">+			charexists = 1;
</a><a href="#h7-0-316" id="h7-0-316" class="i">+
</a><a href="#h7-0-317" id="h7-0-317" class="i">+			if (drw-&gt;fontcount &gt;= DRW_FONT_CACHE_SIZE) {
</a><a href="#h7-0-318" id="h7-0-318" class="i">+				continue;
</a><a href="#h7-0-319" id="h7-0-319" class="i">+			}
</a><a href="#h7-0-320" id="h7-0-320" class="i">+
</a><a href="#h7-0-321" id="h7-0-321" class="i">+			fccharset = FcCharSetCreate();
</a><a href="#h7-0-322" id="h7-0-322" class="i">+			FcCharSetAddChar(fccharset, utf8codepoint);
</a><a href="#h7-0-323" id="h7-0-323" class="i">+
</a><a href="#h7-0-324" id="h7-0-324" class="i">+			if (!drw-&gt;fonts[0]-&gt;pattern) {
</a><a href="#h7-0-325" id="h7-0-325" class="i">+				/* Refer to the comment in drw_font_xcreate for more
</a><a href="#h7-0-326" id="h7-0-326" class="i">+				 * information.
</a><a href="#h7-0-327" id="h7-0-327" class="i">+				 */
</a><a href="#h7-0-328" id="h7-0-328" class="i">+				die(&quot;The first font in the cache must be loaded from a font string.\n&quot;);
</a><a href="#h7-0-329" id="h7-0-329" class="i">+			}
</a><a href="#h7-0-330" id="h7-0-330" class="i">+
</a><a href="#h7-0-331" id="h7-0-331" class="i">+			fcpattern = FcPatternDuplicate(drw-&gt;fonts[0]-&gt;pattern);
</a><a href="#h7-0-332" id="h7-0-332" class="i">+			FcPatternAddCharSet(fcpattern, FC_CHARSET, fccharset);
</a><a href="#h7-0-333" id="h7-0-333" class="i">+			FcPatternAddBool(fcpattern, FC_SCALABLE, FcTrue);
</a><a href="#h7-0-334" id="h7-0-334" class="i">+
</a><a href="#h7-0-335" id="h7-0-335" class="i">+			FcConfigSubstitute(NULL, fcpattern, FcMatchPattern);
</a><a href="#h7-0-336" id="h7-0-336" class="i">+			FcDefaultSubstitute(fcpattern);
</a><a href="#h7-0-337" id="h7-0-337" class="i">+			match = XftFontMatch(drw-&gt;dpy, drw-&gt;screen, fcpattern, &amp;result);
</a><a href="#h7-0-338" id="h7-0-338" class="i">+
</a><a href="#h7-0-339" id="h7-0-339" class="i">+			FcCharSetDestroy(fccharset);
</a><a href="#h7-0-340" id="h7-0-340" class="i">+			FcPatternDestroy(fcpattern);
</a><a href="#h7-0-341" id="h7-0-341" class="i">+
</a><a href="#h7-0-342" id="h7-0-342" class="i">+			if (match) {
</a><a href="#h7-0-343" id="h7-0-343" class="i">+				curfont = drw_font_xcreate(drw, NULL, match);
</a><a href="#h7-0-344" id="h7-0-344" class="i">+				if (curfont &amp;&amp; XftCharExists(drw-&gt;dpy, curfont-&gt;xfont, utf8codepoint)) {
</a><a href="#h7-0-345" id="h7-0-345" class="i">+					drw-&gt;fonts[drw-&gt;fontcount++] = curfont;
</a><a href="#h7-0-346" id="h7-0-346" class="i">+				} else {
</a><a href="#h7-0-347" id="h7-0-347" class="i">+					if (curfont) {
</a><a href="#h7-0-348" id="h7-0-348" class="i">+						drw_font_free(curfont);
</a><a href="#h7-0-349" id="h7-0-349" class="i">+					}
</a><a href="#h7-0-350" id="h7-0-350" class="i">+					curfont = drw-&gt;fonts[0];
</a><a href="#h7-0-351" id="h7-0-351" class="i">+				}
</a><a href="#h7-0-352" id="h7-0-352" class="i">+			}
</a><a href="#h7-0-353" id="h7-0-353" class="i">+		}
</a><a href="#h7-0-354" id="h7-0-354" class="i">+	}
</a><a href="#h7-0-355" id="h7-0-355" class="i">+
</a><a href="#h7-0-356" id="h7-0-356" class="i">+	if (render) {
</a><a href="#h7-0-357" id="h7-0-357" class="i">+		XftDrawDestroy(d);
</a><a href="#h7-0-358" id="h7-0-358" class="i">+	}
</a><a href="#h7-0-359" id="h7-0-359" class="i">+
</a><a href="#h7-0-360" id="h7-0-360" class="i">+	return x;
</a><a href="#h7-0-361" id="h7-0-361" class="i">+}
</a><a href="#h7-0-362" id="h7-0-362" class="i">+
</a><a href="#h7-0-363" id="h7-0-363" class="i">+void
</a><a href="#h7-0-364" id="h7-0-364" class="i">+drw_map(Drw *drw, Window win, int x, int y, unsigned int w, unsigned int h) {
</a><a href="#h7-0-365" id="h7-0-365" class="i">+	if(!drw)
</a><a href="#h7-0-366" id="h7-0-366" class="i">+		return;
</a><a href="#h7-0-367" id="h7-0-367" class="i">+	XCopyArea(drw-&gt;dpy, drw-&gt;drawable, win, drw-&gt;gc, x, y, w, h, x, y);
</a><a href="#h7-0-368" id="h7-0-368" class="i">+	XSync(drw-&gt;dpy, False);
</a><a href="#h7-0-369" id="h7-0-369" class="i">+}
</a><a href="#h7-0-370" id="h7-0-370" class="i">+
</a><a href="#h7-0-371" id="h7-0-371" class="i">+
</a><a href="#h7-0-372" id="h7-0-372" class="i">+void
</a><a href="#h7-0-373" id="h7-0-373" class="i">+drw_font_getexts(Fnt *font, const char *text, unsigned int len, Extnts *tex) {
</a><a href="#h7-0-374" id="h7-0-374" class="i">+	XGlyphInfo ext;
</a><a href="#h7-0-375" id="h7-0-375" class="i">+
</a><a href="#h7-0-376" id="h7-0-376" class="i">+	if(!font || !text)
</a><a href="#h7-0-377" id="h7-0-377" class="i">+		return;
</a><a href="#h7-0-378" id="h7-0-378" class="i">+	XftTextExtentsUtf8(font-&gt;dpy, font-&gt;xfont, (XftChar8 *)text, len, &amp;ext);
</a><a href="#h7-0-379" id="h7-0-379" class="i">+	tex-&gt;h = font-&gt;h;
</a><a href="#h7-0-380" id="h7-0-380" class="i">+	tex-&gt;w = ext.xOff;
</a><a href="#h7-0-381" id="h7-0-381" class="i">+}
</a><a href="#h7-0-382" id="h7-0-382" class="i">+
</a><a href="#h7-0-383" id="h7-0-383" class="i">+unsigned int
</a><a href="#h7-0-384" id="h7-0-384" class="i">+drw_font_getexts_width(Fnt *font, const char *text, unsigned int len) {
</a><a href="#h7-0-385" id="h7-0-385" class="i">+	Extnts tex;
</a><a href="#h7-0-386" id="h7-0-386" class="i">+
</a><a href="#h7-0-387" id="h7-0-387" class="i">+	if(!font)
</a><a href="#h7-0-388" id="h7-0-388" class="i">+		return -1;
</a><a href="#h7-0-389" id="h7-0-389" class="i">+	drw_font_getexts(font, text, len, &amp;tex);
</a><a href="#h7-0-390" id="h7-0-390" class="i">+	return tex.w;
</a><a href="#h7-0-391" id="h7-0-391" class="i">+}
</a><a href="#h7-0-392" id="h7-0-392" class="i">+
</a><a href="#h7-0-393" id="h7-0-393" class="i">+Cur *
</a><a href="#h7-0-394" id="h7-0-394" class="i">+drw_cur_create(Drw *drw, int shape) {
</a><a href="#h7-0-395" id="h7-0-395" class="i">+	Cur *cur;
</a><a href="#h7-0-396" id="h7-0-396" class="i">+
</a><a href="#h7-0-397" id="h7-0-397" class="i">+	if(!drw)
</a><a href="#h7-0-398" id="h7-0-398" class="i">+		return NULL;
</a><a href="#h7-0-399" id="h7-0-399" class="i">+	cur = (Cur *)calloc(1, sizeof(Cur));
</a><a href="#h7-0-400" id="h7-0-400" class="i">+	if (!cur)
</a><a href="#h7-0-401" id="h7-0-401" class="i">+		return NULL;
</a><a href="#h7-0-402" id="h7-0-402" class="i">+	cur-&gt;cursor = XCreateFontCursor(drw-&gt;dpy, shape);
</a><a href="#h7-0-403" id="h7-0-403" class="i">+	return cur;
</a><a href="#h7-0-404" id="h7-0-404" class="i">+}
</a><a href="#h7-0-405" id="h7-0-405" class="i">+
</a><a href="#h7-0-406" id="h7-0-406" class="i">+void
</a><a href="#h7-0-407" id="h7-0-407" class="i">+drw_cur_free(Drw *drw, Cur *cursor) {
</a><a href="#h7-0-408" id="h7-0-408" class="i">+	if(!drw || !cursor)
</a><a href="#h7-0-409" id="h7-0-409" class="i">+		return;
</a><a href="#h7-0-410" id="h7-0-410" class="i">+	XFreeCursor(drw-&gt;dpy, cursor-&gt;cursor);
</a><a href="#h7-0-411" id="h7-0-411" class="i">+	free(cursor);
</a><a href="#h7-0-412" id="h7-0-412" class="i">+}
</a><b>diff --git a/<a id="h8" href="../file/drw.h.html">drw.h</a> b/<a href="../file/drw.h.html">drw.h</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,74 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+/* See LICENSE file for copyright and license details. */
</a><a href="#h8-0-1" id="h8-0-1" class="i">+#define DRW_FONT_CACHE_SIZE 32
</a><a href="#h8-0-2" id="h8-0-2" class="i">+
</a><a href="#h8-0-3" id="h8-0-3" class="i">+typedef struct {
</a><a href="#h8-0-4" id="h8-0-4" class="i">+	unsigned long pix;
</a><a href="#h8-0-5" id="h8-0-5" class="i">+	XftColor rgb;
</a><a href="#h8-0-6" id="h8-0-6" class="i">+} Clr;
</a><a href="#h8-0-7" id="h8-0-7" class="i">+
</a><a href="#h8-0-8" id="h8-0-8" class="i">+typedef struct {
</a><a href="#h8-0-9" id="h8-0-9" class="i">+	Cursor cursor;
</a><a href="#h8-0-10" id="h8-0-10" class="i">+} Cur;
</a><a href="#h8-0-11" id="h8-0-11" class="i">+
</a><a href="#h8-0-12" id="h8-0-12" class="i">+typedef struct {
</a><a href="#h8-0-13" id="h8-0-13" class="i">+	Display *dpy;
</a><a href="#h8-0-14" id="h8-0-14" class="i">+	int ascent;
</a><a href="#h8-0-15" id="h8-0-15" class="i">+	int descent;
</a><a href="#h8-0-16" id="h8-0-16" class="i">+	unsigned int h;
</a><a href="#h8-0-17" id="h8-0-17" class="i">+	XftFont *xfont;
</a><a href="#h8-0-18" id="h8-0-18" class="i">+	FcPattern *pattern;
</a><a href="#h8-0-19" id="h8-0-19" class="i">+} Fnt;
</a><a href="#h8-0-20" id="h8-0-20" class="i">+
</a><a href="#h8-0-21" id="h8-0-21" class="i">+typedef struct {
</a><a href="#h8-0-22" id="h8-0-22" class="i">+	Clr *fg;
</a><a href="#h8-0-23" id="h8-0-23" class="i">+	Clr *bg;
</a><a href="#h8-0-24" id="h8-0-24" class="i">+	Clr *border;
</a><a href="#h8-0-25" id="h8-0-25" class="i">+} ClrScheme;
</a><a href="#h8-0-26" id="h8-0-26" class="i">+
</a><a href="#h8-0-27" id="h8-0-27" class="i">+typedef struct {
</a><a href="#h8-0-28" id="h8-0-28" class="i">+	unsigned int w, h;
</a><a href="#h8-0-29" id="h8-0-29" class="i">+	Display *dpy;
</a><a href="#h8-0-30" id="h8-0-30" class="i">+	int screen;
</a><a href="#h8-0-31" id="h8-0-31" class="i">+	Window root;
</a><a href="#h8-0-32" id="h8-0-32" class="i">+	Drawable drawable;
</a><a href="#h8-0-33" id="h8-0-33" class="i">+	GC gc;
</a><a href="#h8-0-34" id="h8-0-34" class="i">+	ClrScheme *scheme;
</a><a href="#h8-0-35" id="h8-0-35" class="i">+	size_t fontcount;
</a><a href="#h8-0-36" id="h8-0-36" class="i">+	Fnt *fonts[DRW_FONT_CACHE_SIZE];
</a><a href="#h8-0-37" id="h8-0-37" class="i">+} Drw;
</a><a href="#h8-0-38" id="h8-0-38" class="i">+
</a><a href="#h8-0-39" id="h8-0-39" class="i">+typedef struct {
</a><a href="#h8-0-40" id="h8-0-40" class="i">+	unsigned int w;
</a><a href="#h8-0-41" id="h8-0-41" class="i">+	unsigned int h;
</a><a href="#h8-0-42" id="h8-0-42" class="i">+} Extnts;
</a><a href="#h8-0-43" id="h8-0-43" class="i">+
</a><a href="#h8-0-44" id="h8-0-44" class="i">+/* Drawable abstraction */
</a><a href="#h8-0-45" id="h8-0-45" class="i">+Drw *drw_create(Display *dpy, int screen, Window win, unsigned int w, unsigned int h);
</a><a href="#h8-0-46" id="h8-0-46" class="i">+void drw_resize(Drw *drw, unsigned int w, unsigned int h);
</a><a href="#h8-0-47" id="h8-0-47" class="i">+void drw_free(Drw *drw);
</a><a href="#h8-0-48" id="h8-0-48" class="i">+
</a><a href="#h8-0-49" id="h8-0-49" class="i">+/* Fnt abstraction */
</a><a href="#h8-0-50" id="h8-0-50" class="i">+Fnt *drw_font_create(Drw *drw, const char *fontname);
</a><a href="#h8-0-51" id="h8-0-51" class="i">+void drw_load_fonts(Drw* drw, const char *fonts[], size_t fontcount);
</a><a href="#h8-0-52" id="h8-0-52" class="i">+void drw_font_free(Fnt *font);
</a><a href="#h8-0-53" id="h8-0-53" class="i">+void drw_font_getexts(Fnt *font, const char *text, unsigned int len, Extnts *extnts);
</a><a href="#h8-0-54" id="h8-0-54" class="i">+unsigned int drw_font_getexts_width(Fnt *font, const char *text, unsigned int len);
</a><a href="#h8-0-55" id="h8-0-55" class="i">+
</a><a href="#h8-0-56" id="h8-0-56" class="i">+/* Colour abstraction */
</a><a href="#h8-0-57" id="h8-0-57" class="i">+Clr *drw_clr_create(Drw *drw, const char *clrname);
</a><a href="#h8-0-58" id="h8-0-58" class="i">+void drw_clr_free(Clr *clr);
</a><a href="#h8-0-59" id="h8-0-59" class="i">+
</a><a href="#h8-0-60" id="h8-0-60" class="i">+/* Cursor abstraction */
</a><a href="#h8-0-61" id="h8-0-61" class="i">+Cur *drw_cur_create(Drw *drw, int shape);
</a><a href="#h8-0-62" id="h8-0-62" class="i">+void drw_cur_free(Drw *drw, Cur *cursor);
</a><a href="#h8-0-63" id="h8-0-63" class="i">+
</a><a href="#h8-0-64" id="h8-0-64" class="i">+/* Drawing context manipulation */
</a><a href="#h8-0-65" id="h8-0-65" class="i">+void drw_setfont(Drw *drw, Fnt *font);
</a><a href="#h8-0-66" id="h8-0-66" class="i">+void drw_setscheme(Drw *drw, ClrScheme *scheme);
</a><a href="#h8-0-67" id="h8-0-67" class="i">+
</a><a href="#h8-0-68" id="h8-0-68" class="i">+/* Drawing functions */
</a><a href="#h8-0-69" id="h8-0-69" class="i">+void drw_rect(Drw *drw, int x, int y, unsigned int w, unsigned int h, int filled, int empty, int invert);
</a><a href="#h8-0-70" id="h8-0-70" class="i">+int drw_text(Drw *drw, int x, int y, unsigned int w, unsigned int h, const char *text, int invert);
</a><a href="#h8-0-71" id="h8-0-71" class="i">+
</a><a href="#h8-0-72" id="h8-0-72" class="i">+/* Map functions */
</a><a href="#h8-0-73" id="h8-0-73" class="i">+void drw_map(Drw *drw, Window win, int x, int y, unsigned int w, unsigned int h);
</a><b>diff --git a/<a id="h9" href="../file/util.c.html">util.c</a> b/<a href="../file/util.c.html">util.c</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,23 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+/* See LICENSE file for copyright and license details. */
</a><a href="#h9-0-1" id="h9-0-1" class="i">+#include &lt;stdarg.h&gt;
</a><a href="#h9-0-2" id="h9-0-2" class="i">+#include &lt;stdio.h&gt;
</a><a href="#h9-0-3" id="h9-0-3" class="i">+#include &lt;stdlib.h&gt;
</a><a href="#h9-0-4" id="h9-0-4" class="i">+#include &lt;string.h&gt;
</a><a href="#h9-0-5" id="h9-0-5" class="i">+
</a><a href="#h9-0-6" id="h9-0-6" class="i">+#include &quot;util.h&quot;
</a><a href="#h9-0-7" id="h9-0-7" class="i">+
</a><a href="#h9-0-8" id="h9-0-8" class="i">+void
</a><a href="#h9-0-9" id="h9-0-9" class="i">+die(const char *fmt, ...) {
</a><a href="#h9-0-10" id="h9-0-10" class="i">+	va_list ap;
</a><a href="#h9-0-11" id="h9-0-11" class="i">+
</a><a href="#h9-0-12" id="h9-0-12" class="i">+	va_start(ap, fmt);
</a><a href="#h9-0-13" id="h9-0-13" class="i">+	vfprintf(stderr, fmt, ap);
</a><a href="#h9-0-14" id="h9-0-14" class="i">+	va_end(ap);
</a><a href="#h9-0-15" id="h9-0-15" class="i">+
</a><a href="#h9-0-16" id="h9-0-16" class="i">+	if (fmt[0] &amp;&amp; fmt[strlen(fmt)-1] == &#39;:&#39;) {
</a><a href="#h9-0-17" id="h9-0-17" class="i">+		fputc(&#39; &#39;, stderr);
</a><a href="#h9-0-18" id="h9-0-18" class="i">+		perror(NULL);
</a><a href="#h9-0-19" id="h9-0-19" class="i">+	}
</a><a href="#h9-0-20" id="h9-0-20" class="i">+
</a><a href="#h9-0-21" id="h9-0-21" class="i">+	exit(1);
</a><a href="#h9-0-22" id="h9-0-22" class="i">+}
</a><b>diff --git a/<a id="h10" href="../file/util.h.html">util.h</a> b/<a href="../file/util.h.html">util.h</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,7 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+/* See LICENSE file for copyright and license details. */
</a><a href="#h10-0-1" id="h10-0-1" class="i">+
</a><a href="#h10-0-2" id="h10-0-2" class="i">+#define MAX(A, B)               ((A) &gt; (B) ? (A) : (B))
</a><a href="#h10-0-3" id="h10-0-3" class="i">+#define MIN(A, B)               ((A) &lt; (B) ? (A) : (B))
</a><a href="#h10-0-4" id="h10-0-4" class="i">+#define BETWEEN(X, A, B)        ((A) &lt;= (X) &amp;&amp; (X) &lt;= (B))
</a><a href="#h10-0-5" id="h10-0-5" class="i">+
</a><a href="#h10-0-6" id="h10-0-6" class="i">+void die(const char *errstr, ...);
</a></pre>
</div>
</body>
</html>
