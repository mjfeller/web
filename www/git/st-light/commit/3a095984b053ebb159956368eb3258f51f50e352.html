<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Implementing line drawing right. - st-light - Unnamed repository; edit this file &#39;description&#39; to name the repository.
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st-light Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st-light</h1><span class="desc">Unnamed repository; edit this file &#39;description&#39; to name the repository.
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/3a095984b053ebb159956368eb3258f51f50e352.html">3a095984b053ebb159956368eb3258f51f50e352</a>
<b>parent</b> <a href="../commit/c3b0e2202b908834d3c08e3eaf70e0ac282cf319.html">c3b0e2202b908834d3c08e3eaf70e0ac282cf319</a>
<b>Author:</b> Christoph Lohmann &lt;<a href="mailto:20h@r-36.net">20h@r-36.net</a>&gt;
<b>Date:</b>   Wed, 26 Sep 2012 20:21:08 +0200

Implementing line drawing right.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">config.def.h</a></td><td> | </td><td class="num">8</td><td><span class="i"></span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">st.c</a></td><td> | </td><td class="num">52</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d">----------------</span></td></tr>
</table></pre><pre>2 files changed, 36 insertions(+), 24 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config.def.h.html">config.def.h</a> b/<a href="../file/config.def.h.html">config.def.h</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -79,14 +79,6 @@ static Key key[] = {
</a> /* Set TERM to this */
 #define TNAME &quot;st-256color&quot;
 
<a href="#h0-0-3" id="h0-0-3" class="d">-/* Line drawing characters (sometime specific to each font...) */
</a><a href="#h0-0-4" id="h0-0-4" class="d">-static char gfx[] = {
</a><a href="#h0-0-5" id="h0-0-5" class="d">-	[&#39;f&#39;] = &#39;o&#39;,
</a><a href="#h0-0-6" id="h0-0-6" class="d">-	[&#39;g&#39;] = &#39;+&#39;,
</a><a href="#h0-0-7" id="h0-0-7" class="d">-	[&#39;i&#39;] = &#39;#&#39;,
</a><a href="#h0-0-8" id="h0-0-8" class="d">-	[255] = 0,
</a><a href="#h0-0-9" id="h0-0-9" class="d">-};
</a><a href="#h0-0-10" id="h0-0-10" class="d">-
</a> /* double-click timeout (in milliseconds) between clicks for selection */
 #define DOUBLECLICK_TIMEOUT 300
 #define TRIPLECLICK_TIMEOUT (2*DOUBLECLICK_TIMEOUT)
<b>diff --git a/<a id="h1" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1094,6 +1094,27 @@ tmoveto(int x, int y) {
</a> 
 void
 tsetchar(char *c) {
<a href="#h1-0-3" id="h1-0-3" class="i">+	/*
</a><a href="#h1-0-4" id="h1-0-4" class="i">+	 * The table is proudly stolen from rxvt.
</a><a href="#h1-0-5" id="h1-0-5" class="i">+	 */
</a><a href="#h1-0-6" id="h1-0-6" class="i">+	if(term.c.attr.mode &amp; ATTR_GFX) {
</a><a href="#h1-0-7" id="h1-0-7" class="i">+		char *vt100_0[62] = { /* 0x41 - 0x7e */
</a><a href="#h1-0-8" id="h1-0-8" class="i">+			&quot;↑&quot;, &quot;↓&quot;, &quot;→&quot;, &quot;←&quot;, &quot;█&quot;, &quot;▚&quot;, &quot;☃&quot;, /* A - G */
</a><a href="#h1-0-9" id="h1-0-9" class="i">+			0, 0, 0, 0, 0, 0, 0, 0, /* H - O */
</a><a href="#h1-0-10" id="h1-0-10" class="i">+			0, 0, 0, 0, 0, 0, 0, 0, /* P - W */
</a><a href="#h1-0-11" id="h1-0-11" class="i">+			0, 0, 0, 0, 0, 0, 0, &quot; &quot;, /* X - _ */
</a><a href="#h1-0-12" id="h1-0-12" class="i">+			&quot;◆&quot;, &quot;▒&quot;, &quot;␉&quot;, &quot;␌&quot;, &quot;␍&quot;, &quot;␊&quot;, &quot;°&quot;, &quot;±&quot;, /* ` - g */
</a><a href="#h1-0-13" id="h1-0-13" class="i">+			&quot;␤&quot;, &quot;␋&quot;, &quot;┘&quot;, &quot;┐&quot;, &quot;┌&quot;, &quot;└&quot;, &quot;┼&quot;, &quot;⎺&quot;, /* h - o */
</a><a href="#h1-0-14" id="h1-0-14" class="i">+			&quot;⎻&quot;, &quot;─&quot;, &quot;⎼&quot;, &quot;⎽&quot;, &quot;├&quot;, &quot;┤&quot;, &quot;┴&quot;, &quot;┬&quot;, /* p - w */
</a><a href="#h1-0-15" id="h1-0-15" class="i">+			&quot;│&quot;, &quot;≤&quot;, &quot;≥&quot;, &quot;π&quot;, &quot;≠&quot;, &quot;£&quot;, &quot;·&quot;, /* x - ~ */
</a><a href="#h1-0-16" id="h1-0-16" class="i">+		};
</a><a href="#h1-0-17" id="h1-0-17" class="i">+
</a><a href="#h1-0-18" id="h1-0-18" class="i">+		if(c[0] &gt;= 0x41 &amp;&amp; c[0] &lt;= 0x7e
</a><a href="#h1-0-19" id="h1-0-19" class="i">+				&amp;&amp; vt100_0[c[0] - 0x41]) {
</a><a href="#h1-0-20" id="h1-0-20" class="i">+			c = vt100_0[c[0] - 0x41];
</a><a href="#h1-0-21" id="h1-0-21" class="i">+		}
</a><a href="#h1-0-22" id="h1-0-22" class="i">+	}
</a><a href="#h1-0-23" id="h1-0-23" class="i">+
</a> 	term.dirty[term.c.y] = 1;
 	term.line[term.c.y][term.c.x] = term.c.attr;
 	memcpy(term.line[term.c.y][term.c.x].c, c, UTF_SIZ);
<a href="#h1-1" id="h1-1" class="h">@@ -1177,7 +1198,7 @@ tsetattr(int *attr, int l) {
</a> 		switch(attr[i]) {
 		case 0:
 			term.c.attr.mode &amp;= ~(ATTR_REVERSE | ATTR_UNDERLINE | ATTR_BOLD \
<a href="#h1-1-3" id="h1-1-3" class="d">-					| ATTR_ITALIC | ATTR_BLINK | ATTR_GFX);
</a><a href="#h1-1-4" id="h1-1-4" class="i">+					| ATTR_ITALIC | ATTR_BLINK);
</a> 			term.c.attr.fg = DefaultFG;
 			term.c.attr.bg = DefaultBG;
 			break;
<a href="#h1-2" id="h1-2" class="h">@@ -1676,12 +1697,18 @@ tputc(char *c, int len) {
</a> 				strhandle();
 		} else if(term.esc &amp; ESC_ALTCHARSET) {
 			switch(ascii) {
<a href="#h1-2-3" id="h1-2-3" class="d">-			case &#39;0&#39;: /* Line drawing crap */
</a><a href="#h1-2-4" id="h1-2-4" class="i">+			case &#39;0&#39;: /* Line drawing set */
</a> 				term.c.attr.mode |= ATTR_GFX;
 				break;
<a href="#h1-2-7" id="h1-2-7" class="d">-			case &#39;B&#39;: /* Back to regular text */
</a><a href="#h1-2-8" id="h1-2-8" class="i">+			case &#39;B&#39;: /* USASCII */
</a> 				term.c.attr.mode &amp;= ~ATTR_GFX;
 				break;
<a href="#h1-2-11" id="h1-2-11" class="i">+			case &#39;A&#39;: /* UK (IGNORED) */
</a><a href="#h1-2-12" id="h1-2-12" class="i">+			case &#39;&lt;&#39;: /* multinational charset (IGNORED) */
</a><a href="#h1-2-13" id="h1-2-13" class="i">+			case &#39;5&#39;: /* Finnish (IGNORED) */
</a><a href="#h1-2-14" id="h1-2-14" class="i">+			case &#39;C&#39;: /* Finnish (IGNORED) */
</a><a href="#h1-2-15" id="h1-2-15" class="i">+			case &#39;K&#39;: /* German (IGNORED) */
</a><a href="#h1-2-16" id="h1-2-16" class="i">+				break;
</a> 			default:
 				fprintf(stderr, &quot;esc unhandled charset: ESC ( %c\n&quot;, ascii);
 			}
<a href="#h1-3" id="h1-3" class="h">@@ -1700,10 +1727,14 @@ tputc(char *c, int len) {
</a> 				strescseq.type = ascii;
 				term.esc |= ESC_STR;
 				break;
<a href="#h1-3-3" id="h1-3-3" class="d">-			case &#39;)&#39;:
</a><a href="#h1-3-4" id="h1-3-4" class="d">-			case &#39;(&#39;:
</a><a href="#h1-3-5" id="h1-3-5" class="i">+			case &#39;(&#39;: /* set primary charset G0 */
</a> 				term.esc |= ESC_ALTCHARSET;
 				break;
<a href="#h1-3-8" id="h1-3-8" class="i">+			case &#39;)&#39;: /* set secondary charset G1 (IGNORED) */
</a><a href="#h1-3-9" id="h1-3-9" class="i">+			case &#39;*&#39;: /* set tertiary charset G2 (IGNORED) */
</a><a href="#h1-3-10" id="h1-3-10" class="i">+			case &#39;+&#39;: /* set quaternary charset G3 (IGNORED) */
</a><a href="#h1-3-11" id="h1-3-11" class="i">+				term.esc = 0;
</a><a href="#h1-3-12" id="h1-3-12" class="i">+				break;
</a> 			case &#39;D&#39;: /* IND -- Linefeed */
 				if(term.c.y == term.bot)
 					tscrollup(term.top, 1);
<a href="#h1-4" id="h1-4" class="h">@@ -2067,7 +2098,6 @@ xdraws(char *s, Glyph base, int x, int y, int charlen, int bytelen) {
</a> 	int winx = BORDER+x*xw.cw, winy = BORDER+y*xw.ch + dc.font.ascent, width = charlen*xw.cw;
 	Font *font = &amp;dc.font;
 	XGlyphInfo extents;
<a href="#h1-4-3" id="h1-4-3" class="d">-	int i;
</a> 
 	/* only switch default fg/bg if term is in RV mode */
 	if(IS_SET(MODE_REVERSE)) {
<a href="#h1-5" id="h1-5" class="h">@@ -2093,16 +2123,6 @@ xdraws(char *s, Glyph base, int x, int y, int charlen, int bytelen) {
</a> 	XSetBackground(xw.dpy, dc.gc, dc.col[bg]);
 	XSetForeground(xw.dpy, dc.gc, dc.col[fg]);
 
<a href="#h1-5-3" id="h1-5-3" class="d">-	if(base.mode &amp; ATTR_GFX) {
</a><a href="#h1-5-4" id="h1-5-4" class="d">-		for(i = 0; i &lt; bytelen; i++) {
</a><a href="#h1-5-5" id="h1-5-5" class="d">-			char c = gfx[(uint)s[i] % 256];
</a><a href="#h1-5-6" id="h1-5-6" class="d">-			if(c)
</a><a href="#h1-5-7" id="h1-5-7" class="d">-				s[i] = c;
</a><a href="#h1-5-8" id="h1-5-8" class="d">-			else if(s[i] &gt; 0x5f)
</a><a href="#h1-5-9" id="h1-5-9" class="d">-				s[i] -= 0x5f;
</a><a href="#h1-5-10" id="h1-5-10" class="d">-		}
</a><a href="#h1-5-11" id="h1-5-11" class="d">-	}
</a><a href="#h1-5-12" id="h1-5-12" class="d">-
</a> 	XftTextExtentsUtf8(xw.dpy, font-&gt;xft_set, (FcChar8 *)s, bytelen, &amp;extents);
 	width = extents.xOff;
 	XftDrawRect(xw.xft_draw, &amp;dc.xft_col[bg], winx, winy - font-&gt;ascent, width, xw.ch);
</pre>
</div>
</body>
</html>
