<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>selection clicks, shift+arrow keys, fast(er) redraw, key mask in config.h (thx Magnus Leuthner) - st-light - Unnamed repository; edit this file &#39;description&#39; to name the repository.
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st-light Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st-light</h1><span class="desc">Unnamed repository; edit this file &#39;description&#39; to name the repository.
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/9d5ea14b9dffac863b41432e4ce12b5624592000.html">9d5ea14b9dffac863b41432e4ce12b5624592000</a>
<b>parent</b> <a href="../commit/d3c5aba2d9b0f6046e4cc72fb056cbd56c6314e6.html">d3c5aba2d9b0f6046e4cc72fb056cbd56c6314e6</a>
<b>Author:</b> Aur√©lien Aptel &lt;<a href="mailto:aurelien.aptel@gmail.com">aurelien.aptel@gmail.com</a>&gt;
<b>Date:</b>   Fri, 22 Apr 2011 00:18:53 +0200

selection clicks, shift+arrow keys, fast(er) redraw, key mask in config.h (thx Magnus Leuthner)

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">config.def.h</a></td><td> | </td><td class="num">47</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d">---------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">st.c</a></td><td> | </td><td class="num">136</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">st.info</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
</table></pre><pre>3 files changed, 126 insertions(+), 61 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config.def.h.html">config.def.h</a> b/<a href="../file/config.def.h.html">config.def.h</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -26,32 +26,33 @@ static const char *colorname[] = {
</a> };
 
 /* Default colors (colorname index) */
<a href="#h0-0-3" id="h0-0-3" class="d">-/* foreground, background, cursor */
</a><a href="#h0-0-4" id="h0-0-4" class="i">+/* foreground, background, cursor   */
</a> #define DefaultFG 7
 #define DefaultBG 0
 #define DefaultCS 1
 
<a href="#h0-0-9" id="h0-0-9" class="d">-/* Special keys */
</a><a href="#h0-0-10" id="h0-0-10" class="i">+/* Special keys (change &amp; recompile st.info accordingly) */
</a><a href="#h0-0-11" id="h0-0-11" class="i">+/*    key,        mask,  output */
</a> static Key key[] = {
<a href="#h0-0-13" id="h0-0-13" class="d">-	{ XK_BackSpace, &quot;\177&quot; },
</a><a href="#h0-0-14" id="h0-0-14" class="d">-	{ XK_Insert,    &quot;\033[2~&quot; },
</a><a href="#h0-0-15" id="h0-0-15" class="d">-	{ XK_Delete,    &quot;\033[3~&quot; },
</a><a href="#h0-0-16" id="h0-0-16" class="d">-	{ XK_Home,      &quot;\033[1~&quot; },
</a><a href="#h0-0-17" id="h0-0-17" class="d">-	{ XK_End,       &quot;\033[4~&quot; },
</a><a href="#h0-0-18" id="h0-0-18" class="d">-	{ XK_Prior,     &quot;\033[5~&quot; },
</a><a href="#h0-0-19" id="h0-0-19" class="d">-	{ XK_Next,      &quot;\033[6~&quot; },
</a><a href="#h0-0-20" id="h0-0-20" class="d">-	{ XK_F1,        &quot;\033OP&quot;   },
</a><a href="#h0-0-21" id="h0-0-21" class="d">-	{ XK_F2,        &quot;\033OQ&quot;   },
</a><a href="#h0-0-22" id="h0-0-22" class="d">-	{ XK_F3,        &quot;\033OR&quot;   },
</a><a href="#h0-0-23" id="h0-0-23" class="d">-	{ XK_F4,        &quot;\033OS&quot;   },
</a><a href="#h0-0-24" id="h0-0-24" class="d">-	{ XK_F5,        &quot;\033[15~&quot; },
</a><a href="#h0-0-25" id="h0-0-25" class="d">-	{ XK_F6,        &quot;\033[17~&quot; },
</a><a href="#h0-0-26" id="h0-0-26" class="d">-	{ XK_F7,        &quot;\033[18~&quot; },
</a><a href="#h0-0-27" id="h0-0-27" class="d">-	{ XK_F8,        &quot;\033[19~&quot; },
</a><a href="#h0-0-28" id="h0-0-28" class="d">-	{ XK_F9,        &quot;\033[20~&quot; },
</a><a href="#h0-0-29" id="h0-0-29" class="d">-	{ XK_F10,       &quot;\033[21~&quot; },
</a><a href="#h0-0-30" id="h0-0-30" class="d">-	{ XK_F11,       &quot;\033[23~&quot; },
</a><a href="#h0-0-31" id="h0-0-31" class="d">-	{ XK_F12,       &quot;\033[24~&quot; },
</a><a href="#h0-0-32" id="h0-0-32" class="i">+	{ XK_BackSpace, 0, &quot;\177&quot; },
</a><a href="#h0-0-33" id="h0-0-33" class="i">+	{ XK_Insert,    0, &quot;\033[2~&quot; },
</a><a href="#h0-0-34" id="h0-0-34" class="i">+	{ XK_Delete,    0, &quot;\033[3~&quot; },
</a><a href="#h0-0-35" id="h0-0-35" class="i">+	{ XK_Home,      0, &quot;\033[1~&quot; },
</a><a href="#h0-0-36" id="h0-0-36" class="i">+	{ XK_End,       0, &quot;\033[4~&quot; },
</a><a href="#h0-0-37" id="h0-0-37" class="i">+	{ XK_Prior,     0, &quot;\033[5~&quot; },
</a><a href="#h0-0-38" id="h0-0-38" class="i">+	{ XK_Next,      0, &quot;\033[6~&quot; },
</a><a href="#h0-0-39" id="h0-0-39" class="i">+	{ XK_F1,        0, &quot;\033OP&quot;   },
</a><a href="#h0-0-40" id="h0-0-40" class="i">+	{ XK_F2,        0, &quot;\033OQ&quot;   },
</a><a href="#h0-0-41" id="h0-0-41" class="i">+	{ XK_F3,        0, &quot;\033OR&quot;   },
</a><a href="#h0-0-42" id="h0-0-42" class="i">+	{ XK_F4,        0, &quot;\033OS&quot;   },
</a><a href="#h0-0-43" id="h0-0-43" class="i">+	{ XK_F5,        0, &quot;\033[15~&quot; },
</a><a href="#h0-0-44" id="h0-0-44" class="i">+	{ XK_F6,        0, &quot;\033[17~&quot; },
</a><a href="#h0-0-45" id="h0-0-45" class="i">+	{ XK_F7,        0, &quot;\033[18~&quot; },
</a><a href="#h0-0-46" id="h0-0-46" class="i">+	{ XK_F8,        0, &quot;\033[19~&quot; },
</a><a href="#h0-0-47" id="h0-0-47" class="i">+	{ XK_F9,        0, &quot;\033[20~&quot; },
</a><a href="#h0-0-48" id="h0-0-48" class="i">+	{ XK_F10,       0, &quot;\033[21~&quot; },
</a><a href="#h0-0-49" id="h0-0-49" class="i">+	{ XK_F11,       0, &quot;\033[23~&quot; },
</a><a href="#h0-0-50" id="h0-0-50" class="i">+	{ XK_F12,       0, &quot;\033[24~&quot; },
</a> };
 
 /* Line drawing characters (sometime specific to each font...) */
<a href="#h0-1" id="h0-1" class="h">@@ -61,3 +62,7 @@ static char gfx[] = {
</a> 	[&#39;i&#39;] = &#39;#&#39;,
 	[255] = 0,
 };
<a href="#h0-1-3" id="h0-1-3" class="i">+
</a><a href="#h0-1-4" id="h0-1-4" class="i">+/* double-click timeout (in milliseconds) between clicks for selection */
</a><a href="#h0-1-5" id="h0-1-5" class="i">+#define DOUBLECLICK_TIMEOUT 300
</a><a href="#h0-1-6" id="h0-1-6" class="i">+#define TRIPLECLICK_TIMEOUT (2*DOUBLECLICK_TIMEOUT)
</a><b>diff --git a/<a id="h1" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -22,6 +22,9 @@
</a> #include &lt;X11/cursorfont.h&gt;
 #include &lt;X11/keysym.h&gt;
 
<a href="#h1-0-3" id="h1-0-3" class="i">+#include &lt;sys/time.h&gt;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+#include &lt;time.h&gt;
</a><a href="#h1-0-5" id="h1-0-5" class="i">+
</a> #if   defined(__linux)
  #include &lt;pty.h&gt;
 #elif defined(__OpenBSD__) || defined(__NetBSD__) || defined(__APPLE__)
<a href="#h1-1" id="h1-1" class="h">@@ -45,11 +48,12 @@
</a> #define MIN(a, b)  ((a) &lt; (b) ? (a) : (b))
 #define MAX(a, b)  ((a) &lt; (b) ? (b) : (a))
 #define LEN(a)     (sizeof(a) / sizeof(a[0]))
<a href="#h1-1-3" id="h1-1-3" class="d">-#define DEFAULT(a, b)     (a) = (a) ? (a) : (b)    
</a><a href="#h1-1-4" id="h1-1-4" class="i">+#define DEFAULT(a, b)     (a) = (a) ? (a) : (b)
</a> #define BETWEEN(x, a, b)  ((a) &lt;= (x) &amp;&amp; (x) &lt;= (b))
 #define LIMIT(x, a, b)    (x) = (x) &lt; (a) ? (a) : (x) &gt; (b) ? (b) : (x)
 #define ATTRCMP(a, b) ((a).mode != (b).mode || (a).fg != (b).fg || (a).bg != (b).bg)
 #define IS_SET(flag) (term.mode &amp; (flag))
<a href="#h1-1-9" id="h1-1-9" class="i">+#define TIMEDIFFERENCE(t1, t2) ((t1.tv_sec-t2.tv_sec)*1000 + (t1.tv_usec-t2.tv_usec)/1000)
</a> 
 /* Attribute, Cursor, Character state, Terminal mode, Screen draw mode */
 enum { ATTR_NULL=0 , ATTR_REVERSE=1 , ATTR_UNDERLINE=2, ATTR_BOLD=4, ATTR_GFX=8 };
<a href="#h1-2" id="h1-2" class="h">@@ -57,10 +61,9 @@ enum { CURSOR_UP, CURSOR_DOWN, CURSOR_LEFT, CURSOR_RIGHT,
</a>        CURSOR_SAVE, CURSOR_LOAD };
 enum { CURSOR_DEFAULT = 0, CURSOR_HIDE = 1, CURSOR_WRAPNEXT = 2 };
 enum { GLYPH_SET=1, GLYPH_DIRTY=2 };
<a href="#h1-2-3" id="h1-2-3" class="d">-enum { MODE_WRAP=1, MODE_INSERT=2, MODE_APPKEYPAD=4, MODE_ALTSCREEN=8, 
</a><a href="#h1-2-4" id="h1-2-4" class="i">+enum { MODE_WRAP=1, MODE_INSERT=2, MODE_APPKEYPAD=4, MODE_ALTSCREEN=8,
</a>        MODE_CRLF=16 };
 enum { ESC_START=1, ESC_CSI=2, ESC_OSC=4, ESC_TITLE=8, ESC_ALTCHARSET=16 };
<a href="#h1-2-7" id="h1-2-7" class="d">-enum { SCREEN_UPDATE, SCREEN_REDRAW };
</a> enum { WIN_VISIBLE=1, WIN_REDRAW=2, WIN_FOCUSED=4 };
 
 #undef B0
<a href="#h1-3" id="h1-3" class="h">@@ -87,21 +90,21 @@ typedef struct {
</a> /* ESC &#39;[&#39; [[ [&lt;priv&gt;] &lt;arg&gt; [;]] &lt;mode&gt;] */
 typedef struct {
 	char buf[ESC_BUF_SIZ]; /* raw string */
<a href="#h1-3-3" id="h1-3-3" class="d">-	int len;			   /* raw string length */
</a><a href="#h1-3-4" id="h1-3-4" class="i">+	int len;               /* raw string length */
</a> 	char priv;
 	int arg[ESC_ARG_SIZ];
<a href="#h1-3-7" id="h1-3-7" class="d">-	int narg;			   /* nb of args */
</a><a href="#h1-3-8" id="h1-3-8" class="i">+	int narg;              /* nb of args */
</a> 	char mode;
 } CSIEscape;
 
 /* Internal representation of the screen */
 typedef struct {
<a href="#h1-3-14" id="h1-3-14" class="d">-	int row;	/* nb row */  
</a><a href="#h1-3-15" id="h1-3-15" class="i">+	int row;	/* nb row */
</a> 	int col;	/* nb col */
 	Line* line;	/* screen */
 	Line* alt;	/* alternate screen */
 	TCursor c;	/* cursor */
<a href="#h1-3-20" id="h1-3-20" class="d">-	int top;	/* top	  scroll limit */
</a><a href="#h1-3-21" id="h1-3-21" class="i">+	int top;	/* top    scroll limit */
</a> 	int bot;	/* bottom scroll limit */
 	int mode;	/* terminal mode flags */
 	int esc;	/* escape state flags */
<a href="#h1-4" id="h1-4" class="h">@@ -118,17 +121,18 @@ typedef struct {
</a> 	XIM xim;
 	XIC xic;
 	int scr;
<a href="#h1-4-3" id="h1-4-3" class="d">-	int w;	/* window width	 */
</a><a href="#h1-4-4" id="h1-4-4" class="i">+	int w;	/* window width */
</a> 	int h;	/* window height */
 	int bufw; /* pixmap width  */
 	int bufh; /* pixmap height */
 	int ch; /* char height */
 	int cw; /* char width  */
 	char state; /* focus, redraw, visible */
<a href="#h1-4-11" id="h1-4-11" class="d">-} XWindow; 
</a><a href="#h1-4-12" id="h1-4-12" class="i">+} XWindow;
</a> 
 typedef struct {
 	KeySym k;
<a href="#h1-4-16" id="h1-4-16" class="i">+	unsigned int mask;
</a> 	char s[ESC_BUF_SIZ];
 } Key;
 
<a href="#h1-5" id="h1-5" class="h">@@ -150,15 +154,18 @@ typedef struct {
</a> 	int mode;
 	int bx, by;
 	int ex, ey;
<a href="#h1-5-3" id="h1-5-3" class="d">-	struct {int x, y;}  b, e;
</a><a href="#h1-5-4" id="h1-5-4" class="i">+	struct {int x, y;} b, e;
</a> 	char *clip;
 	Atom xtarget;
<a href="#h1-5-7" id="h1-5-7" class="i">+	struct timeval tclick1;
</a><a href="#h1-5-8" id="h1-5-8" class="i">+	struct timeval tclick2;
</a> } Selection;
 
 #include &quot;config.h&quot;
 
 static void die(const char *errstr, ...);
<a href="#h1-5-14" id="h1-5-14" class="d">-static void draw(int);
</a><a href="#h1-5-15" id="h1-5-15" class="i">+static void draw();
</a><a href="#h1-5-16" id="h1-5-16" class="i">+static void drawregion(int, int, int, int);
</a> static void execsh(void);
 static void sigchld(int);
 static void run(void);
<a href="#h1-6" id="h1-6" class="h">@@ -206,7 +213,7 @@ static void xresize(int, int);
</a> static void expose(XEvent *);
 static void visibility(XEvent *);
 static void unmap(XEvent *);
<a href="#h1-6-3" id="h1-6-3" class="d">-static char* kmap(KeySym);
</a><a href="#h1-6-4" id="h1-6-4" class="i">+static char* kmap(KeySym, unsigned int state);
</a> static void kpress(XEvent *);
 static void resize(XEvent *);
 static void focus(XEvent *);
<a href="#h1-7" id="h1-7" class="h">@@ -219,7 +226,7 @@ static void selrequest(XEvent *);
</a> static void selinit(void);
 static inline int selected(int, int);
 static void selcopy(void);
<a href="#h1-7-3" id="h1-7-3" class="d">-static void selpaste(void);
</a><a href="#h1-7-4" id="h1-7-4" class="i">+static void selpaste();
</a> 
 static int utf8decode(char *, long *);
 static int utf8encode(long *, char *);
<a href="#h1-8" id="h1-8" class="h">@@ -340,7 +347,7 @@ isfullutf8(char *s, int b) {
</a> 	else if((*c1&amp;(B7|B6|B5)) == (B7|B6) &amp;&amp; b == 1)
 		return 0;
 	else if((*c1&amp;(B7|B6|B5|B4)) == (B7|B6|B5) &amp;&amp;
<a href="#h1-8-3" id="h1-8-3" class="d">-	    ((b == 1) || 
</a><a href="#h1-8-4" id="h1-8-4" class="i">+	    ((b == 1) ||
</a> 	    ((b == 2) &amp;&amp; (*c2&amp;(B7|B6)) == B7)))
 		return 0;
 	else if((*c1&amp;(B7|B6|B5|B4|B3)) == (B7|B6|B5|B4) &amp;&amp;
<a href="#h1-9" id="h1-9" class="h">@@ -362,12 +369,14 @@ utf8size(char *s) {
</a> 		return 2;
 	else if ((c&amp;(B7|B6|B5|B4)) == (B7|B6|B5))
 		return 3;
<a href="#h1-9-3" id="h1-9-3" class="d">-	else 
</a><a href="#h1-9-4" id="h1-9-4" class="i">+	else
</a> 		return 4;
 }
 
 void
 selinit(void) {
<a href="#h1-9-10" id="h1-9-10" class="i">+	sel.tclick1.tv_sec = 0;
</a><a href="#h1-9-11" id="h1-9-11" class="i">+	sel.tclick1.tv_usec = 0;
</a> 	sel.mode = 0;
 	sel.bx = -1;
 	sel.clip = NULL;
<a href="#h1-10" id="h1-10" class="h">@@ -376,14 +385,14 @@ selinit(void) {
</a> 		sel.xtarget = XA_STRING;
 }
 
<a href="#h1-10-3" id="h1-10-3" class="d">-static inline int 
</a><a href="#h1-10-4" id="h1-10-4" class="i">+static inline int
</a> selected(int x, int y) {
 	if(sel.ey == y &amp;&amp; sel.by == y) {
 		int bx = MIN(sel.bx, sel.ex);
 		int ex = MAX(sel.bx, sel.ex);
 		return BETWEEN(x, bx, ex);
 	}
<a href="#h1-10-11" id="h1-10-11" class="d">-	return ((sel.b.y &lt; y&amp;&amp;y &lt; sel.e.y) || (y==sel.e.y &amp;&amp; x&lt;=sel.e.x)) 
</a><a href="#h1-10-12" id="h1-10-12" class="i">+	return ((sel.b.y &lt; y&amp;&amp;y &lt; sel.e.y) || (y==sel.e.y &amp;&amp; x&lt;=sel.e.x))
</a> 		|| (y==sel.b.y &amp;&amp; x&gt;=sel.b.x &amp;&amp; (x&lt;=sel.e.x || sel.b.y!=sel.e.y));
 }
 
<a href="#h1-11" id="h1-11" class="h">@@ -511,30 +520,63 @@ xsetsel(char *str) {
</a> 	XFlush(xw.dpy);
 }
 
<a href="#h1-11-3" id="h1-11-3" class="d">-/* TODO: doubleclick to select word */
</a> void
 brelease(XEvent *e) {
 	int b;
 	sel.mode = 0;
 	getbuttoninfo(e, &amp;b, &amp;sel.ex, &amp;sel.ey);
<a href="#h1-11-9" id="h1-11-9" class="d">-	if(sel.bx==sel.ex &amp;&amp; sel.by==sel.ey) {
</a><a href="#h1-11-10" id="h1-11-10" class="i">+	
</a><a href="#h1-11-11" id="h1-11-11" class="i">+	if(sel.bx == sel.ex &amp;&amp; sel.by == sel.ey) {
</a> 		sel.bx = -1;
<a href="#h1-11-13" id="h1-11-13" class="d">-		if(b==2)
</a><a href="#h1-11-14" id="h1-11-14" class="i">+		if(b == 2)
</a> 			selpaste();
<a href="#h1-11-16" id="h1-11-16" class="i">+
</a><a href="#h1-11-17" id="h1-11-17" class="i">+		else if(b == 1) {
</a><a href="#h1-11-18" id="h1-11-18" class="i">+			/* double click to select word */
</a><a href="#h1-11-19" id="h1-11-19" class="i">+			struct timeval now;
</a><a href="#h1-11-20" id="h1-11-20" class="i">+			gettimeofday(&amp;now, NULL);
</a><a href="#h1-11-21" id="h1-11-21" class="i">+
</a><a href="#h1-11-22" id="h1-11-22" class="i">+			if(TIMEDIFFERENCE(now, sel.tclick1) &lt;= DOUBLECLICK_TIMEOUT) {
</a><a href="#h1-11-23" id="h1-11-23" class="i">+				sel.bx = sel.ex;
</a><a href="#h1-11-24" id="h1-11-24" class="i">+				while(term.line[sel.ey][sel.bx-1].state &amp; GLYPH_SET &amp;&amp; 
</a><a href="#h1-11-25" id="h1-11-25" class="i">+					  term.line[sel.ey][sel.bx-1].c[0] != &#39; &#39;) sel.bx--;
</a><a href="#h1-11-26" id="h1-11-26" class="i">+				sel.b.x = sel.bx;
</a><a href="#h1-11-27" id="h1-11-27" class="i">+				while(term.line[sel.ey][sel.ex+1].state &amp; GLYPH_SET &amp;&amp; 
</a><a href="#h1-11-28" id="h1-11-28" class="i">+					  term.line[sel.ey][sel.ex+1].c[0] != &#39; &#39;) sel.ex++;
</a><a href="#h1-11-29" id="h1-11-29" class="i">+				sel.e.x = sel.ex;
</a><a href="#h1-11-30" id="h1-11-30" class="i">+				sel.b.y = sel.e.y = sel.ey;
</a><a href="#h1-11-31" id="h1-11-31" class="i">+				selcopy();
</a><a href="#h1-11-32" id="h1-11-32" class="i">+			}
</a><a href="#h1-11-33" id="h1-11-33" class="i">+
</a><a href="#h1-11-34" id="h1-11-34" class="i">+			/* triple click on the line */
</a><a href="#h1-11-35" id="h1-11-35" class="i">+			if(TIMEDIFFERENCE(now, sel.tclick2) &lt;= TRIPLECLICK_TIMEOUT) {
</a><a href="#h1-11-36" id="h1-11-36" class="i">+				sel.b.x = sel.bx = 0;
</a><a href="#h1-11-37" id="h1-11-37" class="i">+				sel.e.x = sel.ex = term.col;
</a><a href="#h1-11-38" id="h1-11-38" class="i">+				sel.b.y = sel.e.y = sel.ey;
</a><a href="#h1-11-39" id="h1-11-39" class="i">+				selcopy();
</a><a href="#h1-11-40" id="h1-11-40" class="i">+			}
</a><a href="#h1-11-41" id="h1-11-41" class="i">+		}
</a> 	} else {
<a href="#h1-11-43" id="h1-11-43" class="d">-		if(b==1)
</a><a href="#h1-11-44" id="h1-11-44" class="i">+		if(b == 1) 
</a> 			selcopy();
 	}
<a href="#h1-11-47" id="h1-11-47" class="d">-	draw(1);
</a><a href="#h1-11-48" id="h1-11-48" class="i">+	memcpy(&amp;sel.tclick2, &amp;sel.tclick1, sizeof(struct timeval));
</a><a href="#h1-11-49" id="h1-11-49" class="i">+	gettimeofday(&amp;sel.tclick1, NULL);
</a><a href="#h1-11-50" id="h1-11-50" class="i">+	draw();
</a> }
 
 void
 bmotion(XEvent *e) {
<a href="#h1-11-55" id="h1-11-55" class="d">-	if (sel.mode) {
</a><a href="#h1-11-56" id="h1-11-56" class="i">+	if(sel.mode) {
</a><a href="#h1-11-57" id="h1-11-57" class="i">+		int oldey = sel.ey, 
</a><a href="#h1-11-58" id="h1-11-58" class="i">+			oldex = sel.ex;
</a> 		getbuttoninfo(e, NULL, &amp;sel.ex, &amp;sel.ey);
<a href="#h1-11-60" id="h1-11-60" class="d">-		/* XXX: draw() can&#39;t keep up, disabled for now.
</a><a href="#h1-11-61" id="h1-11-61" class="d">-		   selection is visible on button release.
</a><a href="#h1-11-62" id="h1-11-62" class="d">-		   draw(1); */
</a><a href="#h1-11-63" id="h1-11-63" class="i">+
</a><a href="#h1-11-64" id="h1-11-64" class="i">+		if(oldey != sel.ey || oldex != sel.ex) {
</a><a href="#h1-11-65" id="h1-11-65" class="i">+			int starty = MIN(oldey, sel.ey);
</a><a href="#h1-11-66" id="h1-11-66" class="i">+			int endy = MAX(oldey, sel.ey);
</a><a href="#h1-11-67" id="h1-11-67" class="i">+			drawregion(0, (starty &gt; 0 ? starty : 0), term.col, (sel.ey &lt; term.row ? endy+1 : term.row));
</a><a href="#h1-11-68" id="h1-11-68" class="i">+		}
</a> 	}
 }
 
<a href="#h1-12" id="h1-12" class="h">@@ -641,6 +683,10 @@ ttyread(void) {
</a> 
 void
 ttywrite(const char *s, size_t n) {
<a href="#h1-12-3" id="h1-12-3" class="i">+	{size_t nn;
</a><a href="#h1-12-4" id="h1-12-4" class="i">+		for(nn = 0; nn &lt; n; nn++)
</a><a href="#h1-12-5" id="h1-12-5" class="i">+			dump(s[nn]);
</a><a href="#h1-12-6" id="h1-12-6" class="i">+	}
</a> 	if(write(cmdfd, s, n) == -1)
 		die(&quot;write error on tty: %s\n&quot;, SERRNO);
 }
<a href="#h1-13" id="h1-13" class="h">@@ -1640,8 +1686,13 @@ xdrawc(int x, int y, Glyph g) {
</a> 	    dc.gc, r.x, r.y+dc.font.ascent, g.c, sl);
 }
 
<a href="#h1-13-3" id="h1-13-3" class="i">+void 
</a><a href="#h1-13-4" id="h1-13-4" class="i">+drawregion(int x0, int x1, int y0, int y1) {
</a><a href="#h1-13-5" id="h1-13-5" class="i">+	draw();
</a><a href="#h1-13-6" id="h1-13-6" class="i">+}
</a><a href="#h1-13-7" id="h1-13-7" class="i">+
</a> void
<a href="#h1-13-9" id="h1-13-9" class="d">-draw(int dummy) {
</a><a href="#h1-13-10" id="h1-13-10" class="i">+draw() {
</a> 	int x, y;
 
 	xclear(0, 0, term.col-1, term.row-1);
<a href="#h1-14" id="h1-14" class="h">@@ -1657,8 +1708,13 @@ draw(int dummy) {
</a> 
 #else
 /* optimized drawing routine */
<a href="#h1-14-3" id="h1-14-3" class="i">+void 
</a><a href="#h1-14-4" id="h1-14-4" class="i">+draw() {
</a><a href="#h1-14-5" id="h1-14-5" class="i">+	drawregion(0, 0, term.col, term.row);
</a><a href="#h1-14-6" id="h1-14-6" class="i">+}
</a><a href="#h1-14-7" id="h1-14-7" class="i">+
</a> void
<a href="#h1-14-9" id="h1-14-9" class="d">-draw(int redraw_all) {
</a><a href="#h1-14-10" id="h1-14-10" class="i">+drawregion(int x1, int y1, int x2, int y2) {
</a> 	int ic, ib, x, y, ox, sl;
 	Glyph base, new;
 	char buf[DRAW_BUF_SIZ];
<a href="#h1-15" id="h1-15" class="h">@@ -1666,13 +1722,13 @@ draw(int redraw_all) {
</a> 	if(!(xw.state &amp; WIN_VISIBLE))
 		return;
 
<a href="#h1-15-3" id="h1-15-3" class="d">-	xclear(0, 0, term.col-1, term.row-1);
</a><a href="#h1-15-4" id="h1-15-4" class="d">-	for(y = 0; y &lt; term.row; y++) {
</a><a href="#h1-15-5" id="h1-15-5" class="i">+	xclear(x1, y1, x2-1, y2-1);
</a><a href="#h1-15-6" id="h1-15-6" class="i">+	for(y = y1; y &lt; y2; y++) {
</a> 		base = term.line[y][0];
 		ic = ib = ox = 0;
<a href="#h1-15-9" id="h1-15-9" class="d">-		for(x = 0; x &lt; term.col; x++) {
</a><a href="#h1-15-10" id="h1-15-10" class="i">+		for(x = x1; x &lt; x2; x++) {
</a> 			new = term.line[y][x];
<a href="#h1-15-12" id="h1-15-12" class="d">-			if(sel.bx!=-1 &amp;&amp; *(new.c) &amp;&amp; selected(x, y))
</a><a href="#h1-15-13" id="h1-15-13" class="i">+			if(sel.bx != -1 &amp;&amp; *(new.c) &amp;&amp; selected(x, y))
</a> 				new.mode ^= ATTR_REVERSE;
 			if(ib &gt; 0 &amp;&amp; (!(new.state &amp; GLYPH_SET) || ATTRCMP(base, new) ||
 					ib &gt;= DRAW_BUF_SIZ-UTF_SIZ)) {
<a href="#h1-16" id="h1-16" class="h">@@ -1705,7 +1761,7 @@ expose(XEvent *ev) {
</a> 	if(xw.state &amp; WIN_REDRAW) {
 		if(!e-&gt;count) {
 			xw.state &amp;= ~WIN_REDRAW;
<a href="#h1-16-3" id="h1-16-3" class="d">-			draw(SCREEN_REDRAW);
</a><a href="#h1-16-4" id="h1-16-4" class="i">+			draw();
</a> 		}
 	} else
 		XCopyArea(xw.dpy, xw.buf, xw.win, dc.gc, e-&gt;x-BORDER, e-&gt;y-BORDER,
<a href="#h1-17" id="h1-17" class="h">@@ -1742,14 +1798,14 @@ focus(XEvent *ev) {
</a> 		xseturgency(0);
 	} else
 		xw.state &amp;= ~WIN_FOCUSED;
<a href="#h1-17-3" id="h1-17-3" class="d">-	draw(SCREEN_UPDATE);
</a><a href="#h1-17-4" id="h1-17-4" class="i">+	draw();
</a> }
 
 char*
<a href="#h1-17-8" id="h1-17-8" class="d">-kmap(KeySym k) {
</a><a href="#h1-17-9" id="h1-17-9" class="i">+kmap(KeySym k, unsigned int state) {
</a> 	int i;
 	for(i = 0; i &lt; LEN(key); i++)
<a href="#h1-17-12" id="h1-17-12" class="d">-		if(key[i].k == k)
</a><a href="#h1-17-13" id="h1-17-13" class="i">+		if(key[i].k == k &amp;&amp; (key[i].mask == 0 || key[i].mask &amp; state))
</a> 			return (char*)key[i].s;
 	return NULL;
 }
<a href="#h1-18" id="h1-18" class="h">@@ -1770,7 +1826,7 @@ kpress(XEvent *ev) {
</a> 	len = XmbLookupString(xw.xic, e, buf, sizeof(buf), &amp;ksym, &amp;status);
 	
 	/* 1. custom keys from config.h */
<a href="#h1-18-3" id="h1-18-3" class="d">-	if((customkey = kmap(ksym)))
</a><a href="#h1-18-4" id="h1-18-4" class="i">+	if((customkey = kmap(ksym, e-&gt;state)))
</a> 		ttywrite(customkey, strlen(customkey));
 	/* 2. hardcoded (overrides X lookup) */
 	else
<a href="#h1-19" id="h1-19" class="h">@@ -1779,7 +1835,7 @@ kpress(XEvent *ev) {
</a> 		case XK_Down:
 		case XK_Left:
 		case XK_Right:
<a href="#h1-19-3" id="h1-19-3" class="d">-			sprintf(buf, &quot;\033%c%c&quot;, IS_SET(MODE_APPKEYPAD) ? &#39;O&#39; : &#39;[&#39;, &quot;DACB&quot;[ksym - XK_Left]);
</a><a href="#h1-19-4" id="h1-19-4" class="i">+			sprintf(buf, &quot;\033%c%c&quot;, IS_SET(MODE_APPKEYPAD) ? &#39;O&#39; : &#39;[&#39;, (shift ? &quot;dacb&quot;:&quot;DACB&quot;)[ksym - XK_Left]);
</a> 			ttywrite(buf, 3);
 			break;
 		case XK_Insert:
<a href="#h1-20" id="h1-20" class="h">@@ -1817,7 +1873,7 @@ resize(XEvent *e) {
</a> 	if(col == term.col &amp;&amp; row == term.row)
 		return;
 	if(tresize(col, row))
<a href="#h1-20-3" id="h1-20-3" class="d">-		draw(SCREEN_REDRAW);
</a><a href="#h1-20-4" id="h1-20-4" class="i">+		draw();
</a> 	ttyresize(col, row);
 	xresize(col, row);
 }
<a href="#h1-21" id="h1-21" class="h">@@ -1839,7 +1895,7 @@ run(void) {
</a> 		}
 		if(FD_ISSET(cmdfd, &amp;rfd)) {
 			ttyread();
<a href="#h1-21-3" id="h1-21-3" class="d">-			draw(SCREEN_UPDATE); 
</a><a href="#h1-21-4" id="h1-21-4" class="i">+			draw(); 
</a> 		}
 		while(XPending(xw.dpy)) {
 			XNextEvent(xw.dpy, &amp;ev);
<b>diff --git a/<a id="h2" href="../file/st.info.html">st.info</a> b/<a href="../file/st.info.html">st.info</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -49,6 +49,10 @@ st| simpleterm,
</a> 	kcud1=\E[B,
 	kcuf1=\E[C,
 	kcuu1=\E[A,
<a href="#h2-0-3" id="h2-0-3" class="i">+	kLFT=\E[d,
</a><a href="#h2-0-4" id="h2-0-4" class="i">+	kRIT=\E[c,
</a><a href="#h2-0-5" id="h2-0-5" class="i">+	kind=\E[a,
</a><a href="#h2-0-6" id="h2-0-6" class="i">+	kri=\E[b,
</a> 	kdch1=\E[3~,
 	kich1=\E[2~,
 	kend=\E[4~,
</pre>
</div>
</body>
</html>
