<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Do not eat ESC character if control string is not properly terminated. - st-light - Unnamed repository; edit this file &#39;description&#39; to name the repository.
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st-light Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st-light</h1><span class="desc">Unnamed repository; edit this file &#39;description&#39; to name the repository.
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/02d2df5790d186f16e0e22becd8107a85f328c2f.html">02d2df5790d186f16e0e22becd8107a85f328c2f</a>
<b>parent</b> <a href="../commit/c4b79b055df9ef0126f05dd6dbd2bbf935dcb980.html">c4b79b055df9ef0126f05dd6dbd2bbf935dcb980</a>
<b>Author:</b> noname &lt;<a href="mailto:noname@inventati.org">noname@inventati.org</a>&gt;
<b>Date:</b>   Sat, 26 Apr 2014 00:12:41 +0200

Do not eat ESC character if control string is not properly terminated.

Currently tputc handles the case of too long control string waiting for
the end of control string.

Another case is when there is ESC character is encountered but is not
followed by &#39;\\&#39;.  In this case st stops processing control string,
but ESC character is ignored.

After this patch st processes ESC characters in control strings properly.

Test case:
printf &#39;\e]0;abc\e[1mBOLD\e[0m&#39;

Also ^[\ is actually processed in the code that handles ST.
According to ECMA-048 ST stands for STRING TERMINATOR and is used to
close control strings.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">8</td><td><span class="i">+++</span><span class="d">-----</span></td></tr>
</table></pre><pre>1 file changed, 3 insertions(+), 5 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -2452,10 +2452,6 @@ tputc(char *c, int len) {
</a> 				csiparse();
 				csihandle();
 			}
<a href="#h0-0-3" id="h0-0-3" class="d">-		} else if(term.esc &amp; ESC_STR_END) {
</a><a href="#h0-0-4" id="h0-0-4" class="d">-			term.esc = 0;
</a><a href="#h0-0-5" id="h0-0-5" class="d">-			if(ascii == &#39;\\&#39;)
</a><a href="#h0-0-6" id="h0-0-6" class="d">-				strhandle();
</a> 		} else if(term.esc &amp; ESC_ALTCHARSET) {
 			tdeftran(ascii);
 			tselcs();
<a href="#h0-1" id="h0-1" class="h">@@ -2545,7 +2541,9 @@ tputc(char *c, int len) {
</a> 				tcursor(CURSOR_LOAD);
 				term.esc = 0;
 				break;
<a href="#h0-1-3" id="h0-1-3" class="d">-			case &#39;\\&#39;: /* ST -- Stop */
</a><a href="#h0-1-4" id="h0-1-4" class="i">+			case &#39;\\&#39;: /* ST -- String Terminator */
</a><a href="#h0-1-5" id="h0-1-5" class="i">+				if(term.esc &amp; ESC_STR_END)
</a><a href="#h0-1-6" id="h0-1-6" class="i">+					strhandle();
</a> 				term.esc = 0;
 				break;
 			default:
</pre>
</div>
</body>
</html>
