<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Simplify tdeletechar and tinsertblank and fix memory corruption. - st-light - Unnamed repository; edit this file &#39;description&#39; to name the repository.
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st-light Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st-light</h1><span class="desc">Unnamed repository; edit this file &#39;description&#39; to name the repository.
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/80b32af794b659cb15745cfb2a19fce0829c42c7.html">80b32af794b659cb15745cfb2a19fce0829c42c7</a>
<b>parent</b> <a href="../commit/16ac85bf5422a7e925743f6134572d3ac1a25188.html">16ac85bf5422a7e925743f6134572d3ac1a25188</a>
<b>Author:</b> noname &lt;<a href="mailto:noname@inventati.org">noname@inventati.org</a>&gt;
<b>Date:</b>   Wed, 23 Apr 2014 02:08:13 +0400

Simplify tdeletechar and tinsertblank and fix memory corruption.

Current CSI parsing code uses strtol to parse arguments and allows them
to be negative. Negative argument is not properly handled in tdeletechar
and tinsertblank and results in memory corruption in memmove.

Reproduce with printf &#39;\e[-500@&#39;

Patch also removes special handling for corner case and simplifies
the code.

Removed
	term.dirty[term.c.y] = 1
because tclearregion sets dirty flag.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">30</td><td><span class="i">++++++++++++</span><span class="d">------------------</span></td></tr>
</table></pre><pre>1 file changed, 12 insertions(+), 18 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1586,37 +1586,31 @@ tclearregion(int x1, int y1, int x2, int y2) {
</a> 
 void
 tdeletechar(int n) {
<a href="#h0-0-3" id="h0-0-3" class="d">-	int src = term.c.x + n;
</a><a href="#h0-0-4" id="h0-0-4" class="d">-	int dst = term.c.x;
</a><a href="#h0-0-5" id="h0-0-5" class="d">-	int size = term.col - src;
</a><a href="#h0-0-6" id="h0-0-6" class="i">+	int dst, src, size;
</a> 
<a href="#h0-0-8" id="h0-0-8" class="d">-	term.dirty[term.c.y] = 1;
</a><a href="#h0-0-9" id="h0-0-9" class="i">+	LIMIT(n, 0, term.col - term.c.x);
</a> 
<a href="#h0-0-11" id="h0-0-11" class="d">-	if(src &gt;= term.col) {
</a><a href="#h0-0-12" id="h0-0-12" class="d">-		tclearregion(term.c.x, term.c.y, term.col-1, term.c.y);
</a><a href="#h0-0-13" id="h0-0-13" class="d">-		return;
</a><a href="#h0-0-14" id="h0-0-14" class="d">-	}
</a><a href="#h0-0-15" id="h0-0-15" class="i">+	dst = term.c.x;
</a><a href="#h0-0-16" id="h0-0-16" class="i">+	src = term.c.x + n;
</a><a href="#h0-0-17" id="h0-0-17" class="i">+	size = term.col - src;
</a> 
 	memmove(&amp;term.line[term.c.y][dst], &amp;term.line[term.c.y][src],
<a href="#h0-0-20" id="h0-0-20" class="d">-			size * sizeof(Glyph));
</a><a href="#h0-0-21" id="h0-0-21" class="i">+	        size * sizeof(Glyph));
</a> 	tclearregion(term.col-n, term.c.y, term.col-1, term.c.y);
 }
 
 void
 tinsertblank(int n) {
<a href="#h0-0-27" id="h0-0-27" class="d">-	int src = term.c.x;
</a><a href="#h0-0-28" id="h0-0-28" class="d">-	int dst = src + n;
</a><a href="#h0-0-29" id="h0-0-29" class="d">-	int size = term.col - dst;
</a><a href="#h0-0-30" id="h0-0-30" class="i">+	int dst, src, size;
</a> 
<a href="#h0-0-32" id="h0-0-32" class="d">-	term.dirty[term.c.y] = 1;
</a><a href="#h0-0-33" id="h0-0-33" class="i">+	LIMIT(n, 0, term.col - term.c.x);
</a> 
<a href="#h0-0-35" id="h0-0-35" class="d">-	if(dst &gt;= term.col) {
</a><a href="#h0-0-36" id="h0-0-36" class="d">-		tclearregion(term.c.x, term.c.y, term.col-1, term.c.y);
</a><a href="#h0-0-37" id="h0-0-37" class="d">-		return;
</a><a href="#h0-0-38" id="h0-0-38" class="d">-	}
</a><a href="#h0-0-39" id="h0-0-39" class="i">+	dst = term.c.x + n;
</a><a href="#h0-0-40" id="h0-0-40" class="i">+	src = term.c.x;
</a><a href="#h0-0-41" id="h0-0-41" class="i">+	size = term.col - dst;
</a> 
 	memmove(&amp;term.line[term.c.y][dst], &amp;term.line[term.c.y][src],
<a href="#h0-0-44" id="h0-0-44" class="d">-			size * sizeof(Glyph));
</a><a href="#h0-0-45" id="h0-0-45" class="i">+	        size * sizeof(Glyph));
</a> 	tclearregion(src, term.c.y, dst - 1, term.c.y);
 }
 
</pre>
</div>
</body>
</html>
