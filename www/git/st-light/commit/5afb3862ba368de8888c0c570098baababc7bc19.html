<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Add support for utmp in st - st-light - Unnamed repository; edit this file &#39;description&#39; to name the repository.
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st-light Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st-light</h1><span class="desc">Unnamed repository; edit this file &#39;description&#39; to name the repository.
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/5afb3862ba368de8888c0c570098baababc7bc19.html">5afb3862ba368de8888c0c570098baababc7bc19</a>
<b>parent</b> <a href="../commit/0392d165d07143eec29c730364006bc0613e1198.html">0392d165d07143eec29c730364006bc0613e1198</a>
<b>Author:</b> Roberto E. Vargas Caballero &lt;<a href="mailto:k0ga@shike2.com">k0ga@shike2.com</a>&gt;
<b>Date:</b>   Thu, 28 Aug 2014 12:48:29 +0200

Add support for utmp in st

St runs an interactive shell and not a login shell, and it means
that profile is not loaded. The default terminal configuration
in some system is not the correct for st, but since profile is
not loaded there is no way of getting a script configures the
correct values.

St doesn&#39;t update the utmp files, this is the job of another
suckless tool, utmp. Utmp also opens a login shell (it is the
logical behaviour when you create a new user record) it is a
good option execute utmp and then get a correct input in
utmp, wtmp and lastlog file, and execute the content of the
profile.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">config.def.h</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">st.c</a></td><td> | </td><td class="num">17</td><td><span class="i">+++++++++++</span><span class="d">------</span></td></tr>
</table></pre><pre>2 files changed, 12 insertions(+), 6 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config.def.h.html">config.def.h</a> b/<a href="../file/config.def.h.html">config.def.h</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -8,6 +8,7 @@
</a> static char font[] = &quot;Liberation Mono:pixelsize=12:antialias=false:autohint=false&quot;;
 static int borderpx = 2;
 static char shell[] = &quot;/bin/sh&quot;;
<a href="#h0-0-3" id="h0-0-3" class="i">+static char *utmp = NULL;
</a> 
 /* identification sequence returned in DA and DECID */
 static char vtiden[] = &quot;\033[?6c&quot;;
<b>diff --git a/<a id="h1" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1153,16 +1153,22 @@ execsh(void) {
</a> 		else
 			die(&quot;who are you?\n&quot;);
 	}
<a href="#h1-0-3" id="h1-0-3" class="d">-	unsetenv(&quot;COLUMNS&quot;);
</a><a href="#h1-0-4" id="h1-0-4" class="d">-	unsetenv(&quot;LINES&quot;);
</a><a href="#h1-0-5" id="h1-0-5" class="d">-	unsetenv(&quot;TERMCAP&quot;);
</a> 
<a href="#h1-0-7" id="h1-0-7" class="d">-	sh = (pw-&gt;pw_shell[0]) ? pw-&gt;pw_shell : shell;
</a><a href="#h1-0-8" id="h1-0-8" class="i">+	if (utmp)
</a><a href="#h1-0-9" id="h1-0-9" class="i">+		sh = utmp;
</a><a href="#h1-0-10" id="h1-0-10" class="i">+	else if (pw-&gt;pw_shell[0])
</a><a href="#h1-0-11" id="h1-0-11" class="i">+		sh = pw-&gt;pw_shell;
</a><a href="#h1-0-12" id="h1-0-12" class="i">+	else
</a><a href="#h1-0-13" id="h1-0-13" class="i">+		sh = shell;
</a><a href="#h1-0-14" id="h1-0-14" class="i">+	args = (opt_cmd) ? opt_cmd : (char *[]){sh, NULL};
</a> 	snprintf(buf, sizeof(buf), &quot;%lu&quot;, xw.win);
 
<a href="#h1-0-17" id="h1-0-17" class="i">+	unsetenv(&quot;COLUMNS&quot;);
</a><a href="#h1-0-18" id="h1-0-18" class="i">+	unsetenv(&quot;LINES&quot;);
</a><a href="#h1-0-19" id="h1-0-19" class="i">+	unsetenv(&quot;TERMCAP&quot;);
</a> 	setenv(&quot;LOGNAME&quot;, pw-&gt;pw_name, 1);
 	setenv(&quot;USER&quot;, pw-&gt;pw_name, 1);
<a href="#h1-0-22" id="h1-0-22" class="d">-	setenv(&quot;SHELL&quot;, sh, 1);
</a><a href="#h1-0-23" id="h1-0-23" class="i">+	setenv(&quot;SHELL&quot;, args[0], 1);
</a> 	setenv(&quot;HOME&quot;, pw-&gt;pw_dir, 1);
 	setenv(&quot;TERM&quot;, termname, 1);
 	setenv(&quot;WINDOWID&quot;, buf, 1);
<a href="#h1-1" id="h1-1" class="h">@@ -1174,7 +1180,6 @@ execsh(void) {
</a> 	signal(SIGTERM, SIG_DFL);
 	signal(SIGALRM, SIG_DFL);
 
<a href="#h1-1-3" id="h1-1-3" class="d">-	args = opt_cmd ? opt_cmd : (char *[]){sh, &quot;-i&quot;, NULL};
</a> 	execvp(args[0], args);
 	exit(EXIT_FAILURE);
 }
</pre>
</div>
</body>
</html>
