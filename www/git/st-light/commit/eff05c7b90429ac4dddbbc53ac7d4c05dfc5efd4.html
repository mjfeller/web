<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>more escapes &amp; more compability: - st-light - Unnamed repository; edit this file &#39;description&#39; to name the repository.
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st-light Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st-light</h1><span class="desc">Unnamed repository; edit this file &#39;description&#39; to name the repository.
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/eff05c7b90429ac4dddbbc53ac7d4c05dfc5efd4.html">eff05c7b90429ac4dddbbc53ac7d4c05dfc5efd4</a>
<b>parent</b> <a href="../commit/e6b3f5c755349ba7a339dd43958870e4cceb57bf.html">e6b3f5c755349ba7a339dd43958870e4cceb57bf</a>
<b>Author:</b> Aur√©lien Aptel &lt;<a href="mailto:aurelien.aptel@gmail.com">aurelien.aptel@gmail.com</a>&gt;
<b>Date:</b>   Mon,  8 Feb 2010 23:16:55 +0100

more escapes &amp; more compability:

cursor keys are handled in kpress according to the Application Mode (DECPAM).
define &amp; enum were renamed.
tcursor() is now tmovecursor() which is more correct.
tcpos() is now tcursor(), as DECSC is also supposed to save attributes.
capnames are indicated whenever possible.

Currently:
alsamixer looks fine, totally usable.
ncmpc is almost ok.
emacs looks like shit.
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">config.h</a></td><td> | </td><td class="num">5</td><td><span class="i">+</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">st.c</a></td><td> | </td><td class="num">318</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------------</span></td></tr>
</table></pre><pre>2 files changed, 178 insertions(+), 145 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config.h.html">config.h</a> b/<a href="../file/config.h.html">config.h</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -31,10 +31,6 @@ static Key key[] = {
</a> 	{ XK_End,    &quot;\033[4~&quot; },
 	{ XK_Prior,  &quot;\033[5~&quot; },
 	{ XK_Next,   &quot;\033[6~&quot; },
<a href="#h0-0-3" id="h0-0-3" class="d">-	{ XK_Left,   &quot;\033[D&quot; },
</a><a href="#h0-0-4" id="h0-0-4" class="d">-	{ XK_Right,  &quot;\033[C&quot; },
</a><a href="#h0-0-5" id="h0-0-5" class="d">-	{ XK_Up,     &quot;\033[A&quot; },
</a><a href="#h0-0-6" id="h0-0-6" class="d">-	{ XK_Down,   &quot;\033[B&quot; },
</a> };
 
 static char gfx[] = {
<a href="#h0-1" id="h0-1" class="h">@@ -70,4 +66,5 @@ static char gfx[] = {
</a> 	[&#39;l&#39;] = &#39;+&#39;,
 	[&#39;k&#39;] = &#39;+&#39;,
 	[&#39;x&#39;] = &#39;|&#39;,
<a href="#h0-1-3" id="h0-1-3" class="i">+	[255] = 0,
</a> };
<b>diff --git a/<a id="h1" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -23,10 +23,10 @@
</a> #define TNAME &quot;xterm&quot;
 
 /* Arbitrary sizes */
<a href="#h1-0-3" id="h1-0-3" class="d">-#define TITLESIZ 256
</a><a href="#h1-0-4" id="h1-0-4" class="d">-#define ESCSIZ 256
</a><a href="#h1-0-5" id="h1-0-5" class="d">-#define ESCARGSIZ 16
</a><a href="#h1-0-6" id="h1-0-6" class="d">-#define MAXDRAWBUF 1024
</a><a href="#h1-0-7" id="h1-0-7" class="i">+#define ESC_TITLE_SIZ 256
</a><a href="#h1-0-8" id="h1-0-8" class="i">+#define ESC_BUF_SIZ   256
</a><a href="#h1-0-9" id="h1-0-9" class="i">+#define ESC_ARG_SIZ   16
</a><a href="#h1-0-10" id="h1-0-10" class="i">+#define DRAW_BUF_SIZ  1024
</a> 
 #define SERRNO strerror(errno)
 #define MIN(a, b)  ((a) &lt; (b) ? (a) : (b))
<a href="#h1-1" id="h1-1" class="h">@@ -38,21 +38,19 @@
</a> #define ATTRCMP(a, b) ((a).mode != (b).mode || (a).fg != (b).fg || (a).bg != (b).bg)
 
 /* Attribute, Cursor, Character state, Terminal mode, Screen draw mode */
<a href="#h1-1-3" id="h1-1-3" class="d">-enum { ATnone=0 , ATreverse=1 , ATunderline=2, ATbold=4, ATgfx=8 };
</a><a href="#h1-1-4" id="h1-1-4" class="d">-enum { CSup, CSdown, CSright, CSleft, CShide, CSdraw, CSsave, CSload };
</a><a href="#h1-1-5" id="h1-1-5" class="d">-enum { CRset=1, CRupdate=2 };
</a><a href="#h1-1-6" id="h1-1-6" class="d">-enum { TMwrap=1, TMinsert=2 };
</a><a href="#h1-1-7" id="h1-1-7" class="d">-enum { ESCin=1, ESCcsi=2, ESCosc=4, ESCtitle=8, ESCcharset=16 };
</a><a href="#h1-1-8" id="h1-1-8" class="d">-enum { SCupdate, SCredraw };
</a><a href="#h1-1-9" id="h1-1-9" class="d">-
</a><a href="#h1-1-10" id="h1-1-10" class="d">-typedef int Color;
</a><a href="#h1-1-11" id="h1-1-11" class="i">+enum { ATTR_NULL=0 , ATTR_REVERSE=1 , ATTR_UNDERLINE=2, ATTR_BOLD=4, ATTR_GFX=8 };
</a><a href="#h1-1-12" id="h1-1-12" class="i">+enum { CURSOR_UP, CURSOR_DOWN, CURSOR_LEFT, CURSOR_RIGHT, CURSOR_HIDE, CURSOR_DRAW, CURSOR_SAVE, CURSOR_LOAD };
</a><a href="#h1-1-13" id="h1-1-13" class="i">+enum { GLYPH_SET=1, GLYPH_DIRTY=2 };
</a><a href="#h1-1-14" id="h1-1-14" class="i">+enum { MODE_WRAP=1, MODE_INSERT=2, MODE_APPKEYPAD=4 };
</a><a href="#h1-1-15" id="h1-1-15" class="i">+enum { ESC_START=1, ESC_CSI=2, ESC_OSC=4, ESC_TITLE=8, ESC_ALTCHARSET=16 };
</a><a href="#h1-1-16" id="h1-1-16" class="i">+enum { SCREEN_UPDATE, SCREEN_REDRAW };
</a> 
 typedef struct {
 	char c;     /* character code  */
 	char mode;  /* attribute flags */
<a href="#h1-1-21" id="h1-1-21" class="d">-	Color fg;   /* foreground      */
</a><a href="#h1-1-22" id="h1-1-22" class="d">-	Color bg;   /* background      */
</a><a href="#h1-1-23" id="h1-1-23" class="d">-	char state; /* state flag      */
</a><a href="#h1-1-24" id="h1-1-24" class="i">+	int fg;     /* foreground      */
</a><a href="#h1-1-25" id="h1-1-25" class="i">+	int bg;     /* background      */
</a><a href="#h1-1-26" id="h1-1-26" class="i">+	char state; /* state flags     */
</a> } Glyph;
 
 typedef Glyph* Line;
<a href="#h1-2" id="h1-2" class="h">@@ -67,11 +65,11 @@ typedef struct {
</a> /* CSI Escape sequence structs */
 /* ESC &#39;[&#39; [[ [&lt;priv&gt;] &lt;arg&gt; [;]] &lt;mode&gt;] */
 typedef struct {
<a href="#h1-2-3" id="h1-2-3" class="d">-	char buf[ESCSIZ]; /* raw string */
</a><a href="#h1-2-4" id="h1-2-4" class="d">-	int len;          /* raw string length */
</a><a href="#h1-2-5" id="h1-2-5" class="i">+	char buf[ESC_BUF_SIZ]; /* raw string */
</a><a href="#h1-2-6" id="h1-2-6" class="i">+	int len;               /* raw string length */
</a> 	char priv;
<a href="#h1-2-8" id="h1-2-8" class="d">-	int arg[ESCARGSIZ];
</a><a href="#h1-2-9" id="h1-2-9" class="d">-	int narg;           /* nb of args */
</a><a href="#h1-2-10" id="h1-2-10" class="i">+	int arg[ESC_ARG_SIZ];
</a><a href="#h1-2-11" id="h1-2-11" class="i">+	int narg;              /* nb of args */
</a> 	char mode;
 } CSIEscape;
 
<a href="#h1-3" id="h1-3" class="h">@@ -83,9 +81,9 @@ typedef struct {
</a> 	TCursor c;  /* cursor */
 	int top;    /* top    scroll limit */
 	int bot;    /* bottom scroll limit */
<a href="#h1-3-3" id="h1-3-3" class="d">-	int mode;   /* terminal mode */
</a><a href="#h1-3-4" id="h1-3-4" class="d">-	int esc;
</a><a href="#h1-3-5" id="h1-3-5" class="d">-	char title[TITLESIZ];
</a><a href="#h1-3-6" id="h1-3-6" class="i">+	int mode;   /* terminal mode flags */
</a><a href="#h1-3-7" id="h1-3-7" class="i">+	int esc;    /* escape state flags */
</a><a href="#h1-3-8" id="h1-3-8" class="i">+	char title[ESC_TITLE_SIZ];
</a> 	int titlelen;
 } Term;
 
<a href="#h1-4" id="h1-4" class="h">@@ -102,7 +100,7 @@ typedef struct {
</a> 
 typedef struct {
 	KeySym k;
<a href="#h1-4-3" id="h1-4-3" class="d">-	char s[ESCSIZ];
</a><a href="#h1-4-4" id="h1-4-4" class="i">+	char s[ESC_BUF_SIZ];
</a> } Key;
 
 #include &quot;config.h&quot;
<a href="#h1-5" id="h1-5" class="h">@@ -126,8 +124,8 @@ static void csiparse(void);
</a> static void csireset(void);
 
 static void tclearregion(int, int, int, int);
<a href="#h1-5-3" id="h1-5-3" class="d">-static void tcpos(int);
</a> static void tcursor(int);
<a href="#h1-5-5" id="h1-5-5" class="i">+static void tmovecursor(int);
</a> static void tdeletechar(int);
 static void tdeleteline(int);
 static void tinsertblank(int);
<a href="#h1-6" id="h1-6" class="h">@@ -187,7 +185,7 @@ tdump(void) {
</a> 				putchar(&#39;#&#39;);
 			else {
 				c = term.line[row][col];
<a href="#h1-6-3" id="h1-6-3" class="d">-				putchar(c.state &amp; CRset ? c.c : &#39;.&#39;);
</a><a href="#h1-6-4" id="h1-6-4" class="i">+				putchar(c.state &amp; GLYPH_SET ? c.c : &#39;.&#39;);
</a> 			}
 		}
 		putchar(&#39;\n&#39;);
<a href="#h1-7" id="h1-7" class="h">@@ -218,7 +216,7 @@ xbell(void) { /* visual bell */
</a> 	XSetForeground(xw.dis, dc.gc, dc.col[BellCol]);
 	XFillRectangles(xw.dis, xw.win, dc.gc, &amp;r, 1);
 	/* usleep(30000); */
<a href="#h1-7-3" id="h1-7-3" class="d">-	draw(SCredraw);
</a><a href="#h1-7-4" id="h1-7-4" class="i">+	draw(SCREEN_REDRAW);
</a> }
 
 void 
<a href="#h1-8" id="h1-8" class="h">@@ -281,13 +279,10 @@ ttyread(void) {
</a> 	char buf[BUFSIZ] = {0};
 	int ret;
 
<a href="#h1-8-3" id="h1-8-3" class="d">-	switch(ret = read(cmdfd, buf, BUFSIZ)) {
</a><a href="#h1-8-4" id="h1-8-4" class="d">-	case -1: 
</a><a href="#h1-8-5" id="h1-8-5" class="i">+	if((ret = read(cmdfd, buf, BUFSIZ)) &lt; 0)
</a> 		die(&quot;Couldn&#39;t read from shell: %s\n&quot;, SERRNO);
<a href="#h1-8-7" id="h1-8-7" class="d">-		break;
</a><a href="#h1-8-8" id="h1-8-8" class="d">-	default:
</a><a href="#h1-8-9" id="h1-8-9" class="i">+	else
</a> 		tputs(buf, ret);
<a href="#h1-8-11" id="h1-8-11" class="d">-	}
</a> }
 
 void
<a href="#h1-9" id="h1-9" class="h">@@ -308,14 +303,13 @@ ttyresize(int x, int y) {
</a> }
 
 void
<a href="#h1-9-3" id="h1-9-3" class="d">-tcpos(int mode) {
</a><a href="#h1-9-4" id="h1-9-4" class="d">-	static int x = 0;
</a><a href="#h1-9-5" id="h1-9-5" class="d">-	static int y = 0;
</a><a href="#h1-9-6" id="h1-9-6" class="d">-
</a><a href="#h1-9-7" id="h1-9-7" class="d">-	if(mode == CSsave)
</a><a href="#h1-9-8" id="h1-9-8" class="d">-		x = term.c.x, y = term.c.y;
</a><a href="#h1-9-9" id="h1-9-9" class="d">-	else if(mode == CSload)
</a><a href="#h1-9-10" id="h1-9-10" class="d">-		tmoveto(x, y);
</a><a href="#h1-9-11" id="h1-9-11" class="i">+tcursor(int mode) {
</a><a href="#h1-9-12" id="h1-9-12" class="i">+	static TCursor c;
</a><a href="#h1-9-13" id="h1-9-13" class="i">+
</a><a href="#h1-9-14" id="h1-9-14" class="i">+	if(mode == CURSOR_SAVE)
</a><a href="#h1-9-15" id="h1-9-15" class="i">+		c = term.c;
</a><a href="#h1-9-16" id="h1-9-16" class="i">+	else if(mode == CURSOR_LOAD)
</a><a href="#h1-9-17" id="h1-9-17" class="i">+		term.c = c, tmoveto(c.x, c.y);
</a> }
 
 void
<a href="#h1-10" id="h1-10" class="h">@@ -323,9 +317,9 @@ tnew(int col, int row) {   /* screen size */
</a> 	term.row = row, term.col = col;
 	term.top = 0, term.bot = term.row - 1;
 	/* mode */
<a href="#h1-10-3" id="h1-10-3" class="d">-	term.mode = TMwrap;
</a><a href="#h1-10-4" id="h1-10-4" class="i">+	term.mode = MODE_WRAP;
</a> 	/* cursor */
<a href="#h1-10-6" id="h1-10-6" class="d">-	term.c.attr.mode = ATnone;
</a><a href="#h1-10-7" id="h1-10-7" class="i">+	term.c.attr.mode = ATTR_NULL;
</a> 	term.c.attr.fg = DefaultFG;
 	term.c.attr.bg = DefaultBG;
 	term.c.x = term.c.y = 0;
<a href="#h1-11" id="h1-11" class="h">@@ -370,7 +364,7 @@ csiparse(void) {
</a> 			escseq.arg[escseq.narg] *= 10;
 			escseq.arg[escseq.narg] += *p++ - &#39;0&#39;/*, noarg = 0 */;
 		}
<a href="#h1-11-3" id="h1-11-3" class="d">-		if(*p == &#39;;&#39; &amp;&amp; escseq.narg+1 &lt; ESCARGSIZ)
</a><a href="#h1-11-4" id="h1-11-4" class="i">+		if(*p == &#39;;&#39; &amp;&amp; escseq.narg+1 &lt; ESC_ARG_SIZ)
</a> 			escseq.narg++, p++;
 		else {
 			escseq.mode = *p;
<a href="#h1-12" id="h1-12" class="h">@@ -387,27 +381,27 @@ tmoveto(int x, int y) {
</a> }
 
 void
<a href="#h1-12-3" id="h1-12-3" class="d">-tcursor(int dir) {
</a><a href="#h1-12-4" id="h1-12-4" class="i">+tmovecursor(int dir) {
</a> 	int xf = term.c.x, yf = term.c.y;
 	
 	switch(dir) {
<a href="#h1-12-8" id="h1-12-8" class="d">-	case CSup:
</a><a href="#h1-12-9" id="h1-12-9" class="i">+	case CURSOR_UP:
</a> 		yf--;
 		break;
<a href="#h1-12-12" id="h1-12-12" class="d">-	case CSdown:
</a><a href="#h1-12-13" id="h1-12-13" class="i">+	case CURSOR_DOWN:
</a> 		yf++;
 		break;
<a href="#h1-12-16" id="h1-12-16" class="d">-	case CSleft:
</a><a href="#h1-12-17" id="h1-12-17" class="i">+	case CURSOR_LEFT:
</a> 		xf--;
<a href="#h1-12-19" id="h1-12-19" class="d">-		if(term.mode &amp; TMwrap &amp;&amp; xf &lt; 0) {
</a><a href="#h1-12-20" id="h1-12-20" class="i">+		if(term.mode &amp; MODE_WRAP &amp;&amp; xf &lt; 0) {
</a> 			xf = term.col-1, yf--;
 			if(yf &lt; term.top)
 				yf = term.top, xf = 0;
 		}
 		break;
<a href="#h1-12-26" id="h1-12-26" class="d">-	case CSright:
</a><a href="#h1-12-27" id="h1-12-27" class="i">+	case CURSOR_RIGHT:
</a> 		xf++;
<a href="#h1-12-29" id="h1-12-29" class="d">-		if(term.mode &amp; TMwrap &amp;&amp; xf &gt;= term.col) {
</a><a href="#h1-12-30" id="h1-12-30" class="i">+		if(term.mode &amp; MODE_WRAP &amp;&amp; xf &gt;= term.col) {
</a> 			xf = 0, yf++;
 			if(yf &gt; term.bot)
 				yf = term.bot, tscroll();
<a href="#h1-13" id="h1-13" class="h">@@ -421,7 +415,7 @@ void
</a> tsetchar(char c) {
 	term.line[term.c.y][term.c.x] = term.c.attr;
 	term.line[term.c.y][term.c.x].c = c;
<a href="#h1-13-3" id="h1-13-3" class="d">-	term.line[term.c.y][term.c.x].state |= CRset | CRupdate;
</a><a href="#h1-13-4" id="h1-13-4" class="i">+	term.line[term.c.y][term.c.x].state |= GLYPH_SET | GLYPH_DIRTY;
</a> }
 
 void
<a href="#h1-14" id="h1-14" class="h">@@ -477,7 +471,7 @@ tsetlinestate(int n, int state) {
</a> }
 
 void
<a href="#h1-14-3" id="h1-14-3" class="d">-tinsertblankline (int n) {
</a><a href="#h1-14-4" id="h1-14-4" class="i">+tinsertblankline(int n) {
</a> 	int i;
 	Line blank;
 	int bot = term.bot;
<a href="#h1-15" id="h1-15" class="h">@@ -497,8 +491,8 @@ tinsertblankline (int n) {
</a> 		term.line[i-n] = blank;
 		/* blank it */
 		memset(blank, 0, term.col * sizeof(Glyph));
<a href="#h1-15-3" id="h1-15-3" class="d">-		tsetlinestate(i, CRupdate);
</a><a href="#h1-15-4" id="h1-15-4" class="d">-		tsetlinestate(i-n, CRupdate);
</a><a href="#h1-15-5" id="h1-15-5" class="i">+		tsetlinestate(i, GLYPH_DIRTY);
</a><a href="#h1-15-6" id="h1-15-6" class="i">+		tsetlinestate(i-n, GLYPH_DIRTY);
</a> 	}
 }
 
<a href="#h1-16" id="h1-16" class="h">@@ -523,8 +517,8 @@ tdeleteline(int n) {
</a> 		term.line[i+n] = blank;
 		/* blank it */
 		memset(blank, 0, term.col * sizeof(Glyph));
<a href="#h1-16-3" id="h1-16-3" class="d">-		tsetlinestate(i, CRupdate);
</a><a href="#h1-16-4" id="h1-16-4" class="d">-		tsetlinestate(i-n, CRupdate);
</a><a href="#h1-16-5" id="h1-16-5" class="i">+		tsetlinestate(i, GLYPH_DIRTY);
</a><a href="#h1-16-6" id="h1-16-6" class="i">+		tsetlinestate(i-n, GLYPH_DIRTY);
</a> 	}
 }
 
<a href="#h1-17" id="h1-17" class="h">@@ -535,30 +529,30 @@ tsetattr(int *attr, int l) {
</a> 	for(i = 0; i &lt; l; i++) {
 		switch(attr[i]) {
 		case 0:
<a href="#h1-17-3" id="h1-17-3" class="d">-			term.c.attr.mode &amp;= ~(ATreverse | ATunderline | ATbold);
</a><a href="#h1-17-4" id="h1-17-4" class="i">+			term.c.attr.mode &amp;= ~(ATTR_REVERSE | ATTR_UNDERLINE | ATTR_BOLD);
</a> 			term.c.attr.fg = DefaultFG;
 			term.c.attr.bg = DefaultBG;
 			break;
 		case 1:
<a href="#h1-17-9" id="h1-17-9" class="d">-			term.c.attr.mode |= ATbold;	 
</a><a href="#h1-17-10" id="h1-17-10" class="i">+			term.c.attr.mode |= ATTR_BOLD;	 
</a> 			break;
 		case 4: 
<a href="#h1-17-13" id="h1-17-13" class="d">-			term.c.attr.mode |= ATunderline;
</a><a href="#h1-17-14" id="h1-17-14" class="i">+			term.c.attr.mode |= ATTR_UNDERLINE;
</a> 			break;
 		case 7: 
<a href="#h1-17-17" id="h1-17-17" class="d">-			term.c.attr.mode |= ATreverse;	
</a><a href="#h1-17-18" id="h1-17-18" class="i">+			term.c.attr.mode |= ATTR_REVERSE;	
</a> 			break;
 		case 8:
<a href="#h1-17-21" id="h1-17-21" class="d">-			term.c.hidden = CShide;
</a><a href="#h1-17-22" id="h1-17-22" class="i">+			term.c.hidden = CURSOR_HIDE;
</a> 			break;
 		case 22: 
<a href="#h1-17-25" id="h1-17-25" class="d">-			term.c.attr.mode &amp;= ~ATbold;  
</a><a href="#h1-17-26" id="h1-17-26" class="i">+			term.c.attr.mode &amp;= ~ATTR_BOLD;  
</a> 			break;
 		case 24: 
<a href="#h1-17-29" id="h1-17-29" class="d">-			term.c.attr.mode &amp;= ~ATunderline;
</a><a href="#h1-17-30" id="h1-17-30" class="i">+			term.c.attr.mode &amp;= ~ATTR_UNDERLINE;
</a> 			break;
 		case 27: 
<a href="#h1-17-33" id="h1-17-33" class="d">-			term.c.attr.mode &amp;= ~ATreverse;	 
</a><a href="#h1-17-34" id="h1-17-34" class="i">+			term.c.attr.mode &amp;= ~ATTR_REVERSE;	 
</a> 			break;
 		case 39:
 			term.c.attr.fg = DefaultFG;
<a href="#h1-18" id="h1-18" class="h">@@ -593,57 +587,56 @@ tsetscroll(int t, int b) {
</a> 
 void
 csihandle(void) {
<a href="#h1-18-3" id="h1-18-3" class="d">-	if(escseq.priv)
</a><a href="#h1-18-4" id="h1-18-4" class="d">-		csidump();
</a> 	switch(escseq.mode) {
<a href="#h1-18-6" id="h1-18-6" class="d">-	unknown:
</a> 	default:
<a href="#h1-18-8" id="h1-18-8" class="d">-		fprintf(stderr, &quot;erresc: unknown sequence\n&quot;);
</a><a href="#h1-18-9" id="h1-18-9" class="i">+	unknown:
</a><a href="#h1-18-10" id="h1-18-10" class="i">+		printf(&quot;erresc: unknown sequence -- &quot;);
</a> 		csidump();
 		/* die(&quot;&quot;); */
 		break;
<a href="#h1-18-14" id="h1-18-14" class="d">-	case &#39;@&#39;: /* Insert &lt;n&gt; blank char */
</a><a href="#h1-18-15" id="h1-18-15" class="i">+	case &#39;@&#39;: /* ICH -- Insert &lt;n&gt; blank char */
</a> 		DEFAULT(escseq.arg[0], 1);
 		tinsertblank(escseq.arg[0]);
 		break;
<a href="#h1-18-19" id="h1-18-19" class="d">-	case &#39;A&#39;: /* Cursor &lt;n&gt; Up */
</a><a href="#h1-18-20" id="h1-18-20" class="i">+	case &#39;A&#39;: /* CUU -- Cursor &lt;n&gt; Up */
</a> 	case &#39;e&#39;:
 		DEFAULT(escseq.arg[0], 1);
 		tmoveto(term.c.x, term.c.y-escseq.arg[0]);
 		break;
<a href="#h1-18-25" id="h1-18-25" class="d">-	case &#39;B&#39;: /* Cursor &lt;n&gt; Down */
</a><a href="#h1-18-26" id="h1-18-26" class="i">+	case &#39;B&#39;: /* CUD -- Cursor &lt;n&gt; Down */
</a> 		DEFAULT(escseq.arg[0], 1);
 		tmoveto(term.c.x, term.c.y+escseq.arg[0]);
 		break;
<a href="#h1-18-30" id="h1-18-30" class="d">-	case &#39;C&#39;: /* Cursor &lt;n&gt; Forward */
</a><a href="#h1-18-31" id="h1-18-31" class="i">+	case &#39;C&#39;: /* CUF -- Cursor &lt;n&gt; Forward */
</a> 	case &#39;a&#39;:
 		DEFAULT(escseq.arg[0], 1);
 		tmoveto(term.c.x+escseq.arg[0], term.c.y);
 		break;
<a href="#h1-18-36" id="h1-18-36" class="d">-	case &#39;D&#39;: /* Cursor &lt;n&gt; Backward */
</a><a href="#h1-18-37" id="h1-18-37" class="i">+	case &#39;D&#39;: /* CUB -- Cursor &lt;n&gt; Backward */
</a> 		DEFAULT(escseq.arg[0], 1);
 		tmoveto(term.c.x-escseq.arg[0], term.c.y);
 		break;
<a href="#h1-18-41" id="h1-18-41" class="d">-	case &#39;E&#39;: /* Cursor &lt;n&gt; Down and first col */
</a><a href="#h1-18-42" id="h1-18-42" class="i">+	case &#39;E&#39;: /* CNL -- Cursor &lt;n&gt; Down and first col */
</a> 		DEFAULT(escseq.arg[0], 1);
 		tmoveto(0, term.c.y+escseq.arg[0]);
 		break;
<a href="#h1-18-46" id="h1-18-46" class="d">-	case &#39;F&#39;: /* Cursor &lt;n&gt; Up and first col */
</a><a href="#h1-18-47" id="h1-18-47" class="i">+	case &#39;F&#39;: /* CPL -- Cursor &lt;n&gt; Up and first col */
</a> 		DEFAULT(escseq.arg[0], 1);
 		tmoveto(0, term.c.y-escseq.arg[0]);
 		break;
<a href="#h1-18-51" id="h1-18-51" class="d">-	case &#39;G&#39;: /* Move to &lt;col&gt; */
</a><a href="#h1-18-52" id="h1-18-52" class="d">-	case &#39;`&#39;:
</a><a href="#h1-18-53" id="h1-18-53" class="i">+	case &#39;G&#39;: /* CHA -- Move to &lt;col&gt; */
</a><a href="#h1-18-54" id="h1-18-54" class="i">+	case &#39;`&#39;: /* XXX: HPA -- same? */
</a> 		DEFAULT(escseq.arg[0], 1);
      	tmoveto(escseq.arg[0]-1, term.c.y);
 		break;
<a href="#h1-18-58" id="h1-18-58" class="d">-	case &#39;H&#39;: /* Move to &lt;row&gt; &lt;col&gt; */
</a><a href="#h1-18-59" id="h1-18-59" class="d">-	case &#39;f&#39;:
</a><a href="#h1-18-60" id="h1-18-60" class="i">+	case &#39;H&#39;: /* CUP -- Move to &lt;row&gt; &lt;col&gt; */
</a><a href="#h1-18-61" id="h1-18-61" class="i">+	case &#39;f&#39;: /* XXX: HVP -- same? */
</a> 		DEFAULT(escseq.arg[0], 1);
 		DEFAULT(escseq.arg[1], 1);
 		tmoveto(escseq.arg[1]-1, escseq.arg[0]-1);
 		break;
<a href="#h1-18-66" id="h1-18-66" class="d">-	case &#39;J&#39;: /* Clear screen */
</a><a href="#h1-18-67" id="h1-18-67" class="i">+	/* XXX: (CSI n I) CHT -- Cursor Forward Tabulation &lt;n&gt; tab stops */
</a><a href="#h1-18-68" id="h1-18-68" class="i">+	case &#39;J&#39;: /* ED -- Clear screen */
</a> 		switch(escseq.arg[0]) {
 		case 0: /* below */
 			tclearregion(term.c.x, term.c.y, term.col-1, term.row-1);
<a href="#h1-19" id="h1-19" class="h">@@ -653,10 +646,13 @@ csihandle(void) {
</a> 			break;
 		case 2: /* all */
 			tclearregion(0, 0, term.col-1, term.row-1);
<a href="#h1-19-3" id="h1-19-3" class="d">-			break;				  
</a><a href="#h1-19-4" id="h1-19-4" class="i">+			break;
</a><a href="#h1-19-5" id="h1-19-5" class="i">+		case 3: /* XXX: erase saved lines (xterm) */
</a><a href="#h1-19-6" id="h1-19-6" class="i">+		default:
</a><a href="#h1-19-7" id="h1-19-7" class="i">+			goto unknown;
</a> 		}
 		break;
<a href="#h1-19-10" id="h1-19-10" class="d">-	case &#39;K&#39;: /* Clear line */
</a><a href="#h1-19-11" id="h1-19-11" class="i">+	case &#39;K&#39;: /* EL -- Clear line */
</a> 		switch(escseq.arg[0]) {
 		case 0: /* right */
 			tclearregion(term.c.x, term.c.y, term.col-1, term.c.y);
<a href="#h1-20" id="h1-20" class="h">@@ -669,54 +665,77 @@ csihandle(void) {
</a> 			break;
 		}
 		break;
<a href="#h1-20-3" id="h1-20-3" class="d">-	case &#39;S&#39;:
</a><a href="#h1-20-4" id="h1-20-4" class="d">-	case &#39;L&#39;: /* Insert &lt;n&gt; blank lines */
</a><a href="#h1-20-5" id="h1-20-5" class="i">+	case &#39;S&#39;: /* XXX: SU -- Scroll &lt;n&gt; line up (faked) */ 
</a><a href="#h1-20-6" id="h1-20-6" class="i">+	case &#39;L&#39;: /* IL -- Insert &lt;n&gt; blank lines */
</a> 		DEFAULT(escseq.arg[0], 1);
 		tinsertblankline(escseq.arg[0]);
 		break;
<a href="#h1-20-10" id="h1-20-10" class="d">-	case &#39;l&#39;:
</a><a href="#h1-20-11" id="h1-20-11" class="i">+	case &#39;l&#39;: /* RM -- Reset Mode */
</a> 		if(escseq.priv) {
 			switch(escseq.arg[0]) {
<a href="#h1-20-14" id="h1-20-14" class="i">+			case 1:
</a><a href="#h1-20-15" id="h1-20-15" class="i">+				term.mode &amp;= ~MODE_APPKEYPAD;
</a><a href="#h1-20-16" id="h1-20-16" class="i">+				break;
</a> 			case 7:
<a href="#h1-20-18" id="h1-20-18" class="d">-				term.mode &amp;= ~TMwrap;
</a><a href="#h1-20-19" id="h1-20-19" class="i">+				term.mode &amp;= ~MODE_WRAP;
</a><a href="#h1-20-20" id="h1-20-20" class="i">+				break;
</a><a href="#h1-20-21" id="h1-20-21" class="i">+			case 12: /* att610 -- Stop blinking cursor (IGNORED) */
</a> 				break;
 			case 25:
 				term.c.hidden = 1;
 				break;
<a href="#h1-20-26" id="h1-20-26" class="i">+			case 1048: /* XXX: no alt. screen to erase/save */
</a><a href="#h1-20-27" id="h1-20-27" class="i">+			case 1049:
</a><a href="#h1-20-28" id="h1-20-28" class="i">+				tcursor(CURSOR_LOAD);
</a><a href="#h1-20-29" id="h1-20-29" class="i">+				tclearregion(0, 0, term.col-1, term.row-1);
</a><a href="#h1-20-30" id="h1-20-30" class="i">+				break;
</a><a href="#h1-20-31" id="h1-20-31" class="i">+			default:
</a><a href="#h1-20-32" id="h1-20-32" class="i">+				goto unknown;
</a> 			}
<a href="#h1-20-34" id="h1-20-34" class="d">-		}
</a><a href="#h1-20-35" id="h1-20-35" class="i">+		} else goto unknown;
</a> 		break;
<a href="#h1-20-37" id="h1-20-37" class="d">-	case &#39;M&#39;: /* Delete &lt;n&gt; lines */
</a><a href="#h1-20-38" id="h1-20-38" class="i">+	case &#39;M&#39;: /* DL -- Delete &lt;n&gt; lines */
</a> 		DEFAULT(escseq.arg[0], 1);
 		tdeleteline(escseq.arg[0]);
 		break;
<a href="#h1-20-42" id="h1-20-42" class="d">-	case &#39;X&#39;:
</a><a href="#h1-20-43" id="h1-20-43" class="d">-	case &#39;P&#39;: /* Delete &lt;n&gt; char */
</a><a href="#h1-20-44" id="h1-20-44" class="i">+	case &#39;X&#39;: /* ECH -- Erase &lt;n&gt; char XXX: same? */
</a><a href="#h1-20-45" id="h1-20-45" class="i">+	case &#39;P&#39;: /* DCH -- Delete &lt;n&gt; char */
</a> 		DEFAULT(escseq.arg[0], 1);
 		tdeletechar(escseq.arg[0]);
 		break;
<a href="#h1-20-49" id="h1-20-49" class="d">-	case &#39;d&#39;: /* Move to &lt;row&gt; */
</a><a href="#h1-20-50" id="h1-20-50" class="i">+	/* XXX: (CSI n Z) CBT -- Cursor Backward Tabulation &lt;n&gt; tab stops */
</a><a href="#h1-20-51" id="h1-20-51" class="i">+	case &#39;d&#39;: /* VPA -- Move to &lt;row&gt; */
</a> 		DEFAULT(escseq.arg[0], 1);
 		tmoveto(term.c.x, escseq.arg[0]-1);
 		break;
<a href="#h1-20-55" id="h1-20-55" class="d">-	case &#39;h&#39;: /* Set terminal mode */
</a><a href="#h1-20-56" id="h1-20-56" class="d">-		if(escseq.priv)
</a><a href="#h1-20-57" id="h1-20-57" class="i">+	case &#39;h&#39;: /* SM -- Set terminal mode */
</a><a href="#h1-20-58" id="h1-20-58" class="i">+		if(escseq.priv) {
</a> 			switch(escseq.arg[0]) {
<a href="#h1-20-60" id="h1-20-60" class="i">+			case 1:
</a><a href="#h1-20-61" id="h1-20-61" class="i">+				term.mode |= MODE_APPKEYPAD;
</a><a href="#h1-20-62" id="h1-20-62" class="i">+				break;
</a> 			case 7:
<a href="#h1-20-64" id="h1-20-64" class="d">-				term.mode |= TMwrap;
</a><a href="#h1-20-65" id="h1-20-65" class="i">+				term.mode |= MODE_WRAP;
</a><a href="#h1-20-66" id="h1-20-66" class="i">+				break;
</a><a href="#h1-20-67" id="h1-20-67" class="i">+			case 12: /* att610 -- Start blinking cursor (IGNORED) */
</a> 				break;
 			case 25:
 				term.c.hidden = 0;
 				break;
<a href="#h1-20-72" id="h1-20-72" class="d">-			case 1034:
</a><a href="#h1-20-73" id="h1-20-73" class="d">-				/* XXX: Interpret &quot;meta&quot; key, sets eighth bit. */
</a><a href="#h1-20-74" id="h1-20-74" class="i">+			case 1048: 
</a><a href="#h1-20-75" id="h1-20-75" class="i">+			case 1049: /* XXX: no alt. screen to erase/save */
</a><a href="#h1-20-76" id="h1-20-76" class="i">+				tcursor(CURSOR_SAVE);
</a><a href="#h1-20-77" id="h1-20-77" class="i">+				tclearregion(0, 0, term.col-1, term.row-1);
</a> 				break;
<a href="#h1-20-79" id="h1-20-79" class="i">+			default:
</a><a href="#h1-20-80" id="h1-20-80" class="i">+				goto unknown;
</a> 			}
<a href="#h1-20-82" id="h1-20-82" class="i">+		} else goto unknown;
</a> 		break;
<a href="#h1-20-84" id="h1-20-84" class="d">-	case &#39;m&#39;: /* Terminal attribute (color) */
</a><a href="#h1-20-85" id="h1-20-85" class="i">+	case &#39;m&#39;: /* SGR -- Terminal attribute (color) */
</a> 		tsetattr(escseq.arg, escseq.narg);
 		break;
<a href="#h1-20-88" id="h1-20-88" class="d">-	case &#39;r&#39;:
</a><a href="#h1-20-89" id="h1-20-89" class="i">+	case &#39;r&#39;: /* DECSTBM -- Set Scrolling Region */
</a> 		if(escseq.priv)
 			goto unknown;
 		else {
<a href="#h1-21" id="h1-21" class="h">@@ -725,11 +744,11 @@ csihandle(void) {
</a> 			tsetscroll(escseq.arg[0]-1, escseq.arg[1]-1);
 		}
 		break;
<a href="#h1-21-3" id="h1-21-3" class="d">-	case &#39;s&#39;: /* Save cursor position */
</a><a href="#h1-21-4" id="h1-21-4" class="d">-		tcpos(CSsave);
</a><a href="#h1-21-5" id="h1-21-5" class="i">+	case &#39;s&#39;: /* DECSC -- Save cursor position (ANSI.SYS) */
</a><a href="#h1-21-6" id="h1-21-6" class="i">+		tcursor(CURSOR_SAVE);
</a> 		break;
<a href="#h1-21-8" id="h1-21-8" class="d">-	case &#39;u&#39;: /* Load cursor position */
</a><a href="#h1-21-9" id="h1-21-9" class="d">-		tcpos(CSload);
</a><a href="#h1-21-10" id="h1-21-10" class="i">+	case &#39;u&#39;: /* DECRC -- Restore cursor position (ANSI.SYS) */
</a><a href="#h1-21-11" id="h1-21-11" class="i">+		tcursor(CURSOR_LOAD);
</a> 		break;
 	}
 }
<a href="#h1-22" id="h1-22" class="h">@@ -759,70 +778,82 @@ tputtab(void) {
</a> 		space--;
 	
 	for(; space &gt; 0; space--)
<a href="#h1-22-3" id="h1-22-3" class="d">-		tcursor(CSright);
</a><a href="#h1-22-4" id="h1-22-4" class="i">+		tmovecursor(CURSOR_RIGHT);
</a> }
 
 void
 tputc(char c) {
<a href="#h1-22-9" id="h1-22-9" class="d">-#if 0
</a><a href="#h1-22-10" id="h1-22-10" class="d">-	dump(c);
</a><a href="#h1-22-11" id="h1-22-11" class="d">-#endif	
</a><a href="#h1-22-12" id="h1-22-12" class="d">-	if(term.esc &amp; ESCin) {
</a><a href="#h1-22-13" id="h1-22-13" class="d">-		if(term.esc &amp; ESCcsi) {
</a><a href="#h1-22-14" id="h1-22-14" class="i">+	/* dump(c); */
</a><a href="#h1-22-15" id="h1-22-15" class="i">+	if(term.esc &amp; ESC_START) {
</a><a href="#h1-22-16" id="h1-22-16" class="i">+		if(term.esc &amp; ESC_CSI) {
</a> 			escseq.buf[escseq.len++] = c;
<a href="#h1-22-18" id="h1-22-18" class="d">-			if(BETWEEN(c, 0x40, 0x7E) || escseq.len &gt;= ESCSIZ) {
</a><a href="#h1-22-19" id="h1-22-19" class="i">+			if(BETWEEN(c, 0x40, 0x7E) || escseq.len &gt;= ESC_BUF_SIZ) {
</a> 				term.esc = 0;
 				csiparse(), csihandle();
 			}
<a href="#h1-22-23" id="h1-22-23" class="d">-		} else if (term.esc &amp; ESCosc) {
</a><a href="#h1-22-24" id="h1-22-24" class="i">+		} else if(term.esc &amp; ESC_OSC) {
</a> 			if(c == &#39;;&#39;) {
 				term.titlelen = 0;
<a href="#h1-22-27" id="h1-22-27" class="d">-				term.esc = ESCin | ESCtitle;
</a><a href="#h1-22-28" id="h1-22-28" class="i">+				term.esc = ESC_START | ESC_TITLE;
</a> 			}
<a href="#h1-22-30" id="h1-22-30" class="d">-		} else if(term.esc &amp; ESCtitle) {
</a><a href="#h1-22-31" id="h1-22-31" class="d">-			if(c == &#39;\a&#39; || term.titlelen+1 &gt;= TITLESIZ) {
</a><a href="#h1-22-32" id="h1-22-32" class="i">+		} else if(term.esc &amp; ESC_TITLE) {
</a><a href="#h1-22-33" id="h1-22-33" class="i">+			if(c == &#39;\a&#39; || term.titlelen+1 &gt;= ESC_TITLE_SIZ) {
</a> 				term.esc = 0;
 				term.title[term.titlelen] = &#39;\0&#39;;
 				XStoreName(xw.dis, xw.win, term.title);
 			} else {
 				term.title[term.titlelen++] = c;
 			}
<a href="#h1-22-40" id="h1-22-40" class="d">-		} else if(term.esc &amp; ESCcharset) {
</a><a href="#h1-22-41" id="h1-22-41" class="d">-			printf(&quot;ESC ( %c\n&quot;, c);
</a><a href="#h1-22-42" id="h1-22-42" class="i">+		} else if(term.esc &amp; ESC_ALTCHARSET) {
</a> 			switch(c) {
 			case &#39;0&#39;: /* Line drawing crap */
<a href="#h1-22-45" id="h1-22-45" class="d">-				term.c.attr.mode |= ATgfx;
</a><a href="#h1-22-46" id="h1-22-46" class="i">+				term.c.attr.mode |= ATTR_GFX;
</a> 				break;
 			case &#39;B&#39;: /* Back to regular text */
<a href="#h1-22-49" id="h1-22-49" class="d">-				term.c.attr.mode &amp;= ~ATgfx;
</a><a href="#h1-22-50" id="h1-22-50" class="i">+				term.c.attr.mode &amp;= ~ATTR_GFX;
</a> 				break;
<a href="#h1-22-52" id="h1-22-52" class="i">+			default:
</a><a href="#h1-22-53" id="h1-22-53" class="i">+				printf(&quot;esc unhandled charset: ESC ( %c\n&quot;, c);
</a> 			}
 			term.esc = 0;
 		} else {		
 			switch(c) {
 			case &#39;[&#39;:
<a href="#h1-22-59" id="h1-22-59" class="d">-				term.esc |= ESCcsi;
</a><a href="#h1-22-60" id="h1-22-60" class="i">+				term.esc |= ESC_CSI;
</a> 				break;
 			case &#39;]&#39;:
<a href="#h1-22-63" id="h1-22-63" class="d">-				term.esc |= ESCosc;
</a><a href="#h1-22-64" id="h1-22-64" class="i">+				term.esc |= ESC_OSC;
</a> 				break;
 			case &#39;(&#39;:
<a href="#h1-22-67" id="h1-22-67" class="d">-				term.esc |= ESCcharset;
</a><a href="#h1-22-68" id="h1-22-68" class="i">+				term.esc |= ESC_ALTCHARSET;
</a> 				break;
 			case &#39;A&#39;:
 				tmoveto(term.c.x, term.c.y-1);
<a href="#h1-22-72" id="h1-22-72" class="i">+				term.esc = 0;
</a> 				break;
 			case &#39;B&#39;:
 				tmoveto(term.c.x, term.c.y+1);
<a href="#h1-22-76" id="h1-22-76" class="i">+				term.esc = 0;
</a> 				break;
 			case &#39;C&#39;:
 				tmoveto(term.c.x+1, term.c.y);
<a href="#h1-22-80" id="h1-22-80" class="i">+				term.esc = 0;
</a> 				break;
 			case &#39;D&#39;:
 				tmoveto(term.c.x-1, term.c.y);
<a href="#h1-22-84" id="h1-22-84" class="i">+				term.esc = 0;
</a><a href="#h1-22-85" id="h1-22-85" class="i">+				break;
</a><a href="#h1-22-86" id="h1-22-86" class="i">+			case &#39;=&#39;: /* DECPAM */
</a><a href="#h1-22-87" id="h1-22-87" class="i">+				term.mode |= MODE_APPKEYPAD;
</a><a href="#h1-22-88" id="h1-22-88" class="i">+				term.esc = 0;
</a><a href="#h1-22-89" id="h1-22-89" class="i">+				break;
</a><a href="#h1-22-90" id="h1-22-90" class="i">+			case &#39;&gt;&#39;: /* DECPNM */
</a><a href="#h1-22-91" id="h1-22-91" class="i">+				term.mode &amp;= ~MODE_APPKEYPAD;
</a><a href="#h1-22-92" id="h1-22-92" class="i">+				term.esc = 0;
</a> 				break;
 			default:
 				fprintf(stderr, &quot;erresc: unknown sequence ESC %02X &#39;%c&#39;\n&quot;, c, isprint(c)?c:&#39;.&#39;);
<a href="#h1-22-96" id="h1-22-96" class="i">+				term.esc = 0;
</a> 			}
 		}
 	} else {
<a href="#h1-23" id="h1-23" class="h">@@ -831,7 +862,7 @@ tputc(char c) {
</a> 			tputtab();
 			break;
 		case &#39;\b&#39;:
<a href="#h1-23-3" id="h1-23-3" class="d">-			tcursor(CSleft);
</a><a href="#h1-23-4" id="h1-23-4" class="i">+			tmovecursor(CURSOR_LEFT);
</a> 			break;
 		case &#39;\r&#39;:
 			tmoveto(0, term.c.y);
<a href="#h1-24" id="h1-24" class="h">@@ -844,11 +875,11 @@ tputc(char c) {
</a> 			break;
 		case &#39;\033&#39;:
 			csireset();
<a href="#h1-24-3" id="h1-24-3" class="d">-			term.esc = ESCin;
</a><a href="#h1-24-4" id="h1-24-4" class="i">+			term.esc = ESC_START;
</a> 			break;
 		default:
 			tsetchar(c);
<a href="#h1-24-8" id="h1-24-8" class="d">-			tcursor(CSright);
</a><a href="#h1-24-9" id="h1-24-9" class="i">+			tmovecursor(CURSOR_RIGHT);
</a> 			break;
 		}
 	}
<a href="#h1-25" id="h1-25" class="h">@@ -917,7 +948,7 @@ xscroll(void) {
</a> 	int dsty = term.top * xw.ch;
 	int height = (term.bot-term.top) * xw.ch;
 
<a href="#h1-25-3" id="h1-25-3" class="d">-	xcursor(CShide);
</a><a href="#h1-25-4" id="h1-25-4" class="i">+	xcursor(CURSOR_HIDE);
</a> 	XCopyArea(xw.dis, xw.win, xw.win, dc.gc, 0, srcy, xw.w, height, 0, dsty);
 	xclear(0, term.bot, term.col-1, term.bot);
 }
<a href="#h1-26" id="h1-26" class="h">@@ -950,7 +981,7 @@ xinit(void) {
</a> 
 	term.c.attr.fg = DefaultFG;
 	term.c.attr.bg = DefaultBG;
<a href="#h1-26-3" id="h1-26-3" class="d">-	term.c.attr.mode = ATnone;
</a><a href="#h1-26-4" id="h1-26-4" class="i">+	term.c.attr.mode = ATTR_NULL;
</a> 	/* windows */
 	xw.h = term.row * xw.ch;
 	xw.w = term.col * xw.cw;
<a href="#h1-27" id="h1-27" class="h">@@ -977,12 +1008,12 @@ xinit(void) {
</a> }
 
 void
<a href="#h1-27-3" id="h1-27-3" class="d">-xdraws (char *s, Glyph base, int x, int y, int len) {
</a><a href="#h1-27-4" id="h1-27-4" class="i">+xdraws(char *s, Glyph base, int x, int y, int len) {
</a> 	unsigned long xfg, xbg;
 	int winx = x*xw.cw, winy = y*xw.ch + dc.font-&gt;ascent, width = len*xw.cw;
 	int i;
 
<a href="#h1-27-9" id="h1-27-9" class="d">-	if(base.mode &amp; ATreverse)
</a><a href="#h1-27-10" id="h1-27-10" class="i">+	if(base.mode &amp; ATTR_REVERSE)
</a> 		xfg = dc.col[base.bg], xbg = dc.col[base.fg];
 	else
 		xfg = dc.col[base.fg], xbg = dc.col[base.bg];
<a href="#h1-28" id="h1-28" class="h">@@ -990,15 +1021,13 @@ xdraws (char *s, Glyph base, int x, int y, int len) {
</a> 	XSetBackground(xw.dis, dc.gc, xbg);
 	XSetForeground(xw.dis, dc.gc, xfg);
 	
<a href="#h1-28-3" id="h1-28-3" class="d">-	if(base.mode &amp; ATgfx) {
</a><a href="#h1-28-4" id="h1-28-4" class="d">-	   
</a><a href="#h1-28-5" id="h1-28-5" class="i">+	if(base.mode &amp; ATTR_GFX)
</a> 		for(i = 0; i &lt; len; i++)
 			s[i] = gfx[s[i]];
<a href="#h1-28-8" id="h1-28-8" class="d">-	}
</a> 	
 	XDrawImageString(xw.dis, xw.win, dc.gc, winx, winy, s, len);
 	
<a href="#h1-28-12" id="h1-28-12" class="d">-	if(base.mode &amp; ATunderline)
</a><a href="#h1-28-13" id="h1-28-13" class="i">+	if(base.mode &amp; ATTR_UNDERLINE)
</a> 		XDrawLine(xw.dis, xw.win, dc.gc, winx, winy+1, winx+width-1, winy+1);
 }
 
<a href="#h1-29" id="h1-29" class="h">@@ -1008,7 +1037,7 @@ xdrawc(int x, int y, Glyph g) {
</a> 	unsigned long xfg, xbg;
 
 	/* reverse video */
<a href="#h1-29-3" id="h1-29-3" class="d">-	if(g.mode &amp; ATreverse)
</a><a href="#h1-29-4" id="h1-29-4" class="i">+	if(g.mode &amp; ATTR_REVERSE)
</a> 		xfg = dc.col[g.bg], xbg = dc.col[g.fg];
 	else
 		xfg = dc.col[g.fg], xbg = dc.col[g.bg];
<a href="#h1-30" id="h1-30" class="h">@@ -1022,20 +1051,20 @@ void
</a> xcursor(int mode) {
 	static int oldx = 0;
 	static int oldy = 0;
<a href="#h1-30-3" id="h1-30-3" class="d">-	Glyph g = {&#39; &#39;, ATnone, DefaultBG, DefaultCS, 0};
</a><a href="#h1-30-4" id="h1-30-4" class="i">+	Glyph g = {&#39; &#39;, ATTR_NULL, DefaultBG, DefaultCS, 0};
</a> 	
 	LIMIT(oldx, 0, term.col-1);
 	LIMIT(oldy, 0, term.row-1);
 	
<a href="#h1-30-9" id="h1-30-9" class="d">-	if(term.line[term.c.y][term.c.x].state &amp; CRset)
</a><a href="#h1-30-10" id="h1-30-10" class="i">+	if(term.line[term.c.y][term.c.x].state &amp; GLYPH_SET)
</a> 		g.c = term.line[term.c.y][term.c.x].c;
 	/* remove the old cursor */
<a href="#h1-30-13" id="h1-30-13" class="d">-	if(term.line[oldy][oldx].state &amp; CRset)
</a><a href="#h1-30-14" id="h1-30-14" class="i">+	if(term.line[oldy][oldx].state &amp; GLYPH_SET)
</a> 		xdrawc(oldx, oldy, term.line[oldy][oldx]);
 	else 
 		xclear(oldx, oldy, oldx, oldy);
 	/* draw the new one */
<a href="#h1-30-19" id="h1-30-19" class="d">-	if(mode == CSdraw) {
</a><a href="#h1-30-20" id="h1-30-20" class="i">+	if(mode == CURSOR_DRAW) {
</a> 		xdrawc(term.c.x, term.c.y, g);
 		oldx = term.c.x, oldy = term.c.y;
 	}
<a href="#h1-31" id="h1-31" class="h">@@ -1045,14 +1074,14 @@ void
</a> draw(int redraw_all) {
 	int i, x, y, ox;
 	Glyph base, new;
<a href="#h1-31-3" id="h1-31-3" class="d">-	char buf[MAXDRAWBUF];
</a><a href="#h1-31-4" id="h1-31-4" class="i">+	char buf[DRAW_BUF_SIZ];
</a> 	
 	for(y = 0; y &lt; term.row; y++) {
 		base = term.line[y][0];
 		i = ox = 0;
 		for(x = 0; x &lt; term.col; x++) {
 			new = term.line[y][x];
<a href="#h1-31-11" id="h1-31-11" class="d">-			if(!ATTRCMP(base, new) &amp;&amp; i &lt; MAXDRAWBUF)
</a><a href="#h1-31-12" id="h1-31-12" class="i">+			if(!ATTRCMP(base, new) &amp;&amp; i &lt; DRAW_BUF_SIZ)
</a> 				buf[i++] = new.c;
 			else {
 				xdraws(buf, base, ox, y, i);
<a href="#h1-32" id="h1-32" class="h">@@ -1065,12 +1094,12 @@ draw(int redraw_all) {
</a> 		xdraws(buf, base, ox, y, i);
 	}
 	if(!term.c.hidden)
<a href="#h1-32-3" id="h1-32-3" class="d">-		xcursor(CSdraw);
</a><a href="#h1-32-4" id="h1-32-4" class="i">+		xcursor(CURSOR_DRAW);
</a> }
 
 void
 expose(XEvent *ev) {
<a href="#h1-32-9" id="h1-32-9" class="d">-	draw(SCredraw);
</a><a href="#h1-32-10" id="h1-32-10" class="i">+	draw(SCREEN_REDRAW);
</a> }
 
 char*
<a href="#h1-33" id="h1-33" class="h">@@ -1105,6 +1134,13 @@ kpress(XEvent *ev) {
</a> 		ttywrite(buf, len);
 	} else
 		switch(ksym) {
<a href="#h1-33-3" id="h1-33-3" class="i">+		case XK_Up:
</a><a href="#h1-33-4" id="h1-33-4" class="i">+		case XK_Down:
</a><a href="#h1-33-5" id="h1-33-5" class="i">+		case XK_Left:
</a><a href="#h1-33-6" id="h1-33-6" class="i">+		case XK_Right:
</a><a href="#h1-33-7" id="h1-33-7" class="i">+			sprintf(buf, &quot;\033%c%c&quot;, term.mode &amp; MODE_APPKEYPAD ? &#39;O&#39; : &#39;[&#39;, &quot;DACB&quot;[ksym - XK_Left]);
</a><a href="#h1-33-8" id="h1-33-8" class="i">+			ttywrite(buf, 3);
</a><a href="#h1-33-9" id="h1-33-9" class="i">+			break;
</a> 		case XK_Insert:
 			if(shift)
 				/* XXX: paste X clipboard */;
<a href="#h1-34" id="h1-34" class="h">@@ -1126,7 +1162,7 @@ resize(XEvent *e) {
</a> 		ttyresize(col, row);
 		xw.w = e-&gt;xconfigure.width;
 		xw.h = e-&gt;xconfigure.height;
<a href="#h1-34-3" id="h1-34-3" class="d">-		draw(SCredraw);
</a><a href="#h1-34-4" id="h1-34-4" class="i">+		draw(SCREEN_REDRAW);
</a> 	}
 }
 
<a href="#h1-35" id="h1-35" class="h">@@ -1151,7 +1187,7 @@ run(void) {
</a> 		}
 		if(FD_ISSET(cmdfd, &amp;rfd)) {
 			ttyread();
<a href="#h1-35-3" id="h1-35-3" class="d">-			draw(SCupdate);
</a><a href="#h1-35-4" id="h1-35-4" class="i">+			draw(SCREEN_UPDATE);
</a> 		}
 		while(XPending(xw.dis)) {
 			XNextEvent(xw.dis, &amp;ev);
</pre>
</div>
</body>
</html>
