<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Check alternative screen before drawing box selection - st-light - Unnamed repository; edit this file &#39;description&#39; to name the repository.
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st-light Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st-light</h1><span class="desc">Unnamed repository; edit this file &#39;description&#39; to name the repository.
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/98b6f84bfcb63cff54f8aee87191432fa769346c.html">98b6f84bfcb63cff54f8aee87191432fa769346c</a>
<b>parent</b> <a href="../commit/66669a558560c0ba3b5da4cd2009de81d68a2263.html">66669a558560c0ba3b5da4cd2009de81d68a2263</a>
<b>Author:</b> Roberto E. Vargas Caballero &lt;<a href="mailto:k0ga@shike2.com">k0ga@shike2.com</a>&gt;
<b>Date:</b>   Tue,  4 Sep 2012 20:33:01 +0200

Check alternative screen before drawing box selection

Some programs use the alternative screen (vi, less, ...), whose
content is different of the main screen. If you select text in one of
the screen, you don&#39;t wait the box selection is painted in the other
screen, so it is necessary check if the selection was done in the same
screen we are going to paint. Before to this commit, you could do
something like:

	$ LESS=&quot;&quot; ls | less
	(select some code)
	q

and selection box remains drawing in the main screen, but the content
of selection keeps text of the alternate screen.
---
 st.c |    7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">7</td><td><span class="i">++++++</span><span class="d">-</span></td></tr>
</table></pre><pre>1 file changed, 6 insertions(+), 1 deletion(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -221,6 +221,7 @@ typedef struct {
</a> 	struct {int x, y;} b, e;
 	char *clip;
 	Atom xtarget;
<a href="#h0-0-3" id="h0-0-3" class="i">+	bool alt;
</a> 	struct timeval tclick1;
 	struct timeval tclick2;
 } Selection;
<a href="#h0-1" id="h0-1" class="h">@@ -579,6 +580,7 @@ selcopy(void) {
</a> 		}
 		*ptr = 0;
 	}
<a href="#h0-1-3" id="h0-1-3" class="i">+	sel.alt = IS_SET(MODE_ALTSCREEN);
</a> 	xsetsel(str);
 }
 
<a href="#h0-2" id="h0-2" class="h">@@ -2076,7 +2078,10 @@ drawregion(int x1, int y1, int x2, int y2) {
</a> 	int ic, ib, x, y, ox, sl;
 	Glyph base, new;
 	char buf[DRAW_BUF_SIZ];
<a href="#h0-2-3" id="h0-2-3" class="i">+	bool ena_sel = sel.bx != -1, alt = IS_SET(MODE_ALTSCREEN);
</a> 
<a href="#h0-2-5" id="h0-2-5" class="i">+	if((sel.alt &amp;&amp; !alt) || (!sel.alt &amp;&amp; alt))
</a><a href="#h0-2-6" id="h0-2-6" class="i">+		ena_sel = 0;
</a> 	if(!(xw.state &amp; WIN_VISIBLE))
 		return;
 
<a href="#h0-3" id="h0-3" class="h">@@ -2089,7 +2094,7 @@ drawregion(int x1, int y1, int x2, int y2) {
</a> 		ic = ib = ox = 0;
 		for(x = x1; x &lt; x2; x++) {
 			new = term.line[y][x];
<a href="#h0-3-3" id="h0-3-3" class="d">-			if(sel.bx != -1 &amp;&amp; *(new.c) &amp;&amp; selected(x, y))
</a><a href="#h0-3-4" id="h0-3-4" class="i">+			if(ena_sel &amp;&amp; *(new.c) &amp;&amp; selected(x, y))
</a> 				new.mode ^= ATTR_REVERSE;
 			if(ib &gt; 0 &amp;&amp; (!(new.state &amp; GLYPH_SET) || ATTRCMP(base, new) ||
 						  ib &gt;= DRAW_BUF_SIZ-UTF_SIZ)) {
</pre>
</div>
</body>
</html>
