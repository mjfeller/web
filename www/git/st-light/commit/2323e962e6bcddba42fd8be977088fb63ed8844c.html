<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Make selection consistent over line breaks. - st-light - Unnamed repository; edit this file &#39;description&#39; to name the repository.
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st-light Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st-light</h1><span class="desc">Unnamed repository; edit this file &#39;description&#39; to name the repository.
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/2323e962e6bcddba42fd8be977088fb63ed8844c.html">2323e962e6bcddba42fd8be977088fb63ed8844c</a>
<b>parent</b> <a href="../commit/c6fcb78b3a9a73b691875048848430c18870a0fc.html">c6fcb78b3a9a73b691875048848430c18870a0fc</a>
<b>Author:</b> Colona &lt;<a href="mailto:colona@ycc.fr">colona@ycc.fr</a>&gt;
<b>Date:</b>   Tue,  3 Jun 2014 04:34:58 +0200

Make selection consistent over line breaks.

Currently, selection is expanded to the end of the line over line breaks only in
regular selection mode, when the line in not empty and when going down and/or
right. This covers all the cases including word selection mode, with the
exception of rectangular selection because it would make this mode too rigid.
This adjustment is made in selsort so I renamed it to selnormalize to better
reflect what it does now.

Signed-off-by: Roberto E. Vargas Caballero &lt;k0ga@shike2.com&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">46</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
</table></pre><pre>1 file changed, 26 insertions(+), 20 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -441,7 +441,7 @@ static void selclear(XEvent *);
</a> static void selrequest(XEvent *);
 
 static void selinit(void);
<a href="#h0-0-3" id="h0-0-3" class="d">-static void selsort(void);
</a><a href="#h0-0-4" id="h0-0-4" class="i">+static void selnormalize(void);
</a> static inline bool selected(int, int);
 static char *getsel(void);
 static void selcopy(void);
<a href="#h0-1" id="h0-1" class="h">@@ -657,8 +657,19 @@ y2row(int y) {
</a> 	return LIMIT(y, 0, term.row-1);
 }
 
<a href="#h0-1-3" id="h0-1-3" class="i">+static int tlinelen(int y) {
</a><a href="#h0-1-4" id="h0-1-4" class="i">+	int i = term.col;
</a><a href="#h0-1-5" id="h0-1-5" class="i">+
</a><a href="#h0-1-6" id="h0-1-6" class="i">+	while (i &gt; 0 &amp;&amp; term.line[y][i - 1].c[0] == &#39; &#39;)
</a><a href="#h0-1-7" id="h0-1-7" class="i">+		--i;
</a><a href="#h0-1-8" id="h0-1-8" class="i">+
</a><a href="#h0-1-9" id="h0-1-9" class="i">+	return i;
</a><a href="#h0-1-10" id="h0-1-10" class="i">+}
</a><a href="#h0-1-11" id="h0-1-11" class="i">+
</a> static void
<a href="#h0-1-13" id="h0-1-13" class="d">-selsort(void) {
</a><a href="#h0-1-14" id="h0-1-14" class="i">+selnormalize(void) {
</a><a href="#h0-1-15" id="h0-1-15" class="i">+	int i;
</a><a href="#h0-1-16" id="h0-1-16" class="i">+
</a> 	if(sel.ob.y == sel.oe.y) {
 		sel.nb.x = MIN(sel.ob.x, sel.oe.x);
 		sel.ne.x = MAX(sel.ob.x, sel.oe.x);
<a href="#h0-2" id="h0-2" class="h">@@ -668,6 +679,15 @@ selsort(void) {
</a> 	}
 	sel.nb.y = MIN(sel.ob.y, sel.oe.y);
 	sel.ne.y = MAX(sel.ob.y, sel.oe.y);
<a href="#h0-2-3" id="h0-2-3" class="i">+
</a><a href="#h0-2-4" id="h0-2-4" class="i">+	/* expand selection over line breaks */
</a><a href="#h0-2-5" id="h0-2-5" class="i">+	if (sel.type == SEL_RECTANGULAR)
</a><a href="#h0-2-6" id="h0-2-6" class="i">+		return;
</a><a href="#h0-2-7" id="h0-2-7" class="i">+	i = tlinelen(sel.nb.y);
</a><a href="#h0-2-8" id="h0-2-8" class="i">+	if (i &lt; sel.nb.x)
</a><a href="#h0-2-9" id="h0-2-9" class="i">+		sel.nb.x = i;
</a><a href="#h0-2-10" id="h0-2-10" class="i">+	if (tlinelen(sel.ne.y) &lt;= sel.ne.x)
</a><a href="#h0-2-11" id="h0-2-11" class="i">+		sel.ne.x = term.col - 1;
</a> }
 
 static inline bool
<a href="#h0-3" id="h0-3" class="h">@@ -683,8 +703,6 @@ selected(int x, int y) {
</a> 
 void
 selsnap(int mode, int *x, int *y, int direction) {
<a href="#h0-3-3" id="h0-3-3" class="d">-	int i;
</a><a href="#h0-3-4" id="h0-3-4" class="d">-
</a> 	switch(mode) {
 	case SNAP_WORD:
 		/*
<a href="#h0-4" id="h0-4" class="h">@@ -716,7 +734,7 @@ selsnap(int mode, int *x, int *y, int direction) {
</a> 				continue;
 			}
 
<a href="#h0-4-3" id="h0-4-3" class="d">-			if(strchr(worddelimiters,
</a><a href="#h0-4-4" id="h0-4-4" class="i">+			if(*x &gt;= tlinelen(*y) || strchr(worddelimiters,
</a> 					term.line[*y][*x+direction].c[0])) {
 				break;
 			}
<a href="#h0-5" id="h0-5" class="h">@@ -747,18 +765,6 @@ selsnap(int mode, int *x, int *y, int direction) {
</a> 			}
 		}
 		break;
<a href="#h0-5-3" id="h0-5-3" class="d">-	default:
</a><a href="#h0-5-4" id="h0-5-4" class="d">-		/*
</a><a href="#h0-5-5" id="h0-5-5" class="d">-		 * Select the whole line when the end of line is reached.
</a><a href="#h0-5-6" id="h0-5-6" class="d">-		 */
</a><a href="#h0-5-7" id="h0-5-7" class="d">-		if(direction &gt; 0) {
</a><a href="#h0-5-8" id="h0-5-8" class="d">-			i = term.col;
</a><a href="#h0-5-9" id="h0-5-9" class="d">-			while(--i &gt; 0 &amp;&amp; term.line[*y][i].c[0] == &#39; &#39;)
</a><a href="#h0-5-10" id="h0-5-10" class="d">-				/* nothing */;
</a><a href="#h0-5-11" id="h0-5-11" class="d">-			if(i &gt; 0 &amp;&amp; i &lt; *x)
</a><a href="#h0-5-12" id="h0-5-12" class="d">-				*x = term.col - 1;
</a><a href="#h0-5-13" id="h0-5-13" class="d">-		}
</a><a href="#h0-5-14" id="h0-5-14" class="d">-		break;
</a> 	}
 }
 
<a href="#h0-6" id="h0-6" class="h">@@ -780,7 +786,7 @@ getbuttoninfo(XEvent *e) {
</a> 		selsnap(sel.snap, &amp;sel.oe.x, &amp;sel.oe.y, -1);
 		selsnap(sel.snap, &amp;sel.ob.x, &amp;sel.ob.y, +1);
 	}
<a href="#h0-6-3" id="h0-6-3" class="d">-	selsort();
</a><a href="#h0-6-4" id="h0-6-4" class="i">+	selnormalize();
</a> 
 	sel.type = SEL_REGULAR;
 	for(type = 1; type &lt; LEN(selmasks); ++type) {
<a href="#h0-7" id="h0-7" class="h">@@ -896,7 +902,7 @@ bpress(XEvent *e) {
</a> 		}
 		selsnap(sel.snap, &amp;sel.ob.x, &amp;sel.ob.y, -1);
 		selsnap(sel.snap, &amp;sel.oe.x, &amp;sel.oe.y, +1);
<a href="#h0-7-3" id="h0-7-3" class="d">-		selsort();
</a><a href="#h0-7-4" id="h0-7-4" class="i">+		selnormalize();
</a> 
 		/*
 		 * Draw selection, unless it&#39;s regular and we don&#39;t want to
<a href="#h0-8" id="h0-8" class="h">@@ -1451,7 +1457,7 @@ selscroll(int orig, int n) {
</a> 				sel.oe.x = term.col;
 			}
 		}
<a href="#h0-8-3" id="h0-8-3" class="d">-		selsort();
</a><a href="#h0-8-4" id="h0-8-4" class="i">+		selnormalize();
</a> 	}
 }
 
</pre>
</div>
</body>
</html>
