<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Split X-specific code into x.c - st-light - Unnamed repository; edit this file &#39;description&#39; to name the repository.
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st-light Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st-light</h1><span class="desc">Unnamed repository; edit this file &#39;description&#39; to name the repository.
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/e2ee5ee6114eb74bb08cb9abe5a3020203e92688.html">e2ee5ee6114eb74bb08cb9abe5a3020203e92688</a>
<b>parent</b> <a href="../commit/c63a87cd936c1eeef14c4c21572e5b782d3df4bc.html">c63a87cd936c1eeef14c4c21572e5b782d3df4bc</a>
<b>Author:</b> Michael Forney &lt;<a href="mailto:mforney@mforney.org">mforney@mforney.org</a>&gt;
<b>Date:</b>   Fri, 20 Jan 2017 00:06:39 -0800

Split X-specific code into x.c

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">Makefile</a></td><td> | </td><td class="num">5</td><td><span class="i">++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">config.def.h</a></td><td> | </td><td class="num">64</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">st.c</a></td><td> | </td><td class="num">2080</td><td><span class="i">++++</span><span class="d">---------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">st.h</a></td><td> | </td><td class="num">272</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h4">win.h</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">x.c</a></td><td> | </td><td class="num">1766</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
</table></pre><pre>6 files changed, 2195 insertions(+), 2021 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/Makefile.html">Makefile</a> b/<a href="../file/Makefile.html">Makefile</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -3,7 +3,7 @@
</a> 
 include config.mk
 
<a href="#h0-0-3" id="h0-0-3" class="d">-SRC = st.c
</a><a href="#h0-0-4" id="h0-0-4" class="i">+SRC = st.c x.c
</a> OBJ = ${SRC:.c=.o}
 
 all: options st
<a href="#h0-1" id="h0-1" class="h">@@ -21,6 +21,9 @@ config.h:
</a> 	@echo CC $&lt;
 	@${CC} -c ${CFLAGS} $&lt;
 
<a href="#h0-1-3" id="h0-1-3" class="i">+st.o: config.h st.h win.h
</a><a href="#h0-1-4" id="h0-1-4" class="i">+x.o: arg.h st.h win.h
</a><a href="#h0-1-5" id="h0-1-5" class="i">+
</a> ${OBJ}: config.h config.mk
 
 st: ${OBJ}
<b>diff --git a/<a id="h1" href="../file/config.def.h.html">config.def.h</a> b/<a href="../file/config.def.h.html">config.def.h</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -5,8 +5,8 @@
</a>  *
  * font: see http://freedesktop.org/software/fontconfig/fontconfig-user.html
  */
<a href="#h1-0-3" id="h1-0-3" class="d">-static char font[] = &quot;Liberation Mono:pixelsize=12:antialias=true:autohint=true&quot;;
</a><a href="#h1-0-4" id="h1-0-4" class="d">-static int borderpx = 2;
</a><a href="#h1-0-5" id="h1-0-5" class="i">+char font[] = &quot;Liberation Mono:pixelsize=12:antialias=true:autohint=true&quot;;
</a><a href="#h1-0-6" id="h1-0-6" class="i">+int borderpx = 2;
</a> 
 /*
  * What program is execed by st depends of these precedence rules:
<a href="#h1-1" id="h1-1" class="h">@@ -24,8 +24,8 @@ static char stty_args[] = &quot;stty raw pass8 nl -echo -iexten -cstopb 38400&quot;;
</a> static char vtiden[] = &quot;\033[?6c&quot;;
 
 /* Kerning / character bounding-box multipliers */
<a href="#h1-1-3" id="h1-1-3" class="d">-static float cwscale = 1.0;
</a><a href="#h1-1-4" id="h1-1-4" class="d">-static float chscale = 1.0;
</a><a href="#h1-1-5" id="h1-1-5" class="i">+float cwscale = 1.0;
</a><a href="#h1-1-6" id="h1-1-6" class="i">+float chscale = 1.0;
</a> 
 /*
  * word delimiter string
<a href="#h1-2" id="h1-2" class="h">@@ -35,26 +35,26 @@ static float chscale = 1.0;
</a> static char worddelimiters[] = &quot; &quot;;
 
 /* selection timeouts (in milliseconds) */
<a href="#h1-2-3" id="h1-2-3" class="d">-static unsigned int doubleclicktimeout = 300;
</a><a href="#h1-2-4" id="h1-2-4" class="d">-static unsigned int tripleclicktimeout = 600;
</a><a href="#h1-2-5" id="h1-2-5" class="i">+unsigned int doubleclicktimeout = 300;
</a><a href="#h1-2-6" id="h1-2-6" class="i">+unsigned int tripleclicktimeout = 600;
</a> 
 /* alt screens */
<a href="#h1-2-9" id="h1-2-9" class="d">-static int allowaltscreen = 1;
</a><a href="#h1-2-10" id="h1-2-10" class="i">+int allowaltscreen = 1;
</a> 
 /* frames per second st should at maximum draw to the screen */
<a href="#h1-2-13" id="h1-2-13" class="d">-static unsigned int xfps = 120;
</a><a href="#h1-2-14" id="h1-2-14" class="d">-static unsigned int actionfps = 30;
</a><a href="#h1-2-15" id="h1-2-15" class="i">+unsigned int xfps = 120;
</a><a href="#h1-2-16" id="h1-2-16" class="i">+unsigned int actionfps = 30;
</a> 
 /*
  * blinking timeout (set to 0 to disable blinking) for the terminal blinking
  * attribute.
  */
<a href="#h1-2-22" id="h1-2-22" class="d">-static unsigned int blinktimeout = 800;
</a><a href="#h1-2-23" id="h1-2-23" class="i">+unsigned int blinktimeout = 800;
</a> 
 /*
  * thickness of underline and bar cursors
  */
<a href="#h1-2-28" id="h1-2-28" class="d">-static unsigned int cursorthickness = 2;
</a><a href="#h1-2-29" id="h1-2-29" class="i">+unsigned int cursorthickness = 2;
</a> 
 /*
  * bell volume. It must be a value between -100 and 100. Use 0 for disabling
<a href="#h1-3" id="h1-3" class="h">@@ -63,7 +63,7 @@ static unsigned int cursorthickness = 2;
</a> static int bellvolume = 0;
 
 /* default TERM value */
<a href="#h1-3-3" id="h1-3-3" class="d">-static char termname[] = &quot;st-256color&quot;;
</a><a href="#h1-3-4" id="h1-3-4" class="i">+char termname[] = &quot;st-256color&quot;;
</a> 
 /*
  * spaces per tab
<a href="#h1-4" id="h1-4" class="h">@@ -83,7 +83,7 @@ static char termname[] = &quot;st-256color&quot;;
</a> static unsigned int tabspaces = 8;
 
 /* Terminal colors (16 first used in escape sequence) */
<a href="#h1-4-3" id="h1-4-3" class="d">-static const char *colorname[] = {
</a><a href="#h1-4-4" id="h1-4-4" class="i">+const char *colorname[] = {
</a> 	/* 8 normal colors */
 	&quot;black&quot;,
 	&quot;red3&quot;,
<a href="#h1-5" id="h1-5" class="h">@@ -116,10 +116,10 @@ static const char *colorname[] = {
</a>  * Default colors (colorname index)
  * foreground, background, cursor, reverse cursor
  */
<a href="#h1-5-3" id="h1-5-3" class="d">-static unsigned int defaultfg = 7;
</a><a href="#h1-5-4" id="h1-5-4" class="d">-static unsigned int defaultbg = 0;
</a><a href="#h1-5-5" id="h1-5-5" class="d">-static unsigned int defaultcs = 256;
</a><a href="#h1-5-6" id="h1-5-6" class="d">-static unsigned int defaultrcs = 257;
</a><a href="#h1-5-7" id="h1-5-7" class="i">+unsigned int defaultfg = 7;
</a><a href="#h1-5-8" id="h1-5-8" class="i">+unsigned int defaultbg = 0;
</a><a href="#h1-5-9" id="h1-5-9" class="i">+unsigned int defaultcs = 256;
</a><a href="#h1-5-10" id="h1-5-10" class="i">+unsigned int defaultrcs = 257;
</a> 
 /*
  * Default shape of cursor
<a href="#h1-6" id="h1-6" class="h">@@ -128,33 +128,33 @@ static unsigned int defaultrcs = 257;
</a>  * 6: Bar (&quot;|&quot;)
  * 7: Snowman (&quot;☃&quot;)
  */
<a href="#h1-6-3" id="h1-6-3" class="d">-static unsigned int cursorshape = 2;
</a><a href="#h1-6-4" id="h1-6-4" class="i">+unsigned int cursorshape = 2;
</a> 
 /*
  * Default columns and rows numbers
  */
 
<a href="#h1-6-10" id="h1-6-10" class="d">-static unsigned int cols = 80;
</a><a href="#h1-6-11" id="h1-6-11" class="d">-static unsigned int rows = 24;
</a><a href="#h1-6-12" id="h1-6-12" class="i">+unsigned int cols = 80;
</a><a href="#h1-6-13" id="h1-6-13" class="i">+unsigned int rows = 24;
</a> 
 /*
  * Default colour and shape of the mouse cursor
  */
<a href="#h1-6-18" id="h1-6-18" class="d">-static unsigned int mouseshape = XC_xterm;
</a><a href="#h1-6-19" id="h1-6-19" class="d">-static unsigned int mousefg = 7;
</a><a href="#h1-6-20" id="h1-6-20" class="d">-static unsigned int mousebg = 0;
</a><a href="#h1-6-21" id="h1-6-21" class="i">+unsigned int mouseshape = XC_xterm;
</a><a href="#h1-6-22" id="h1-6-22" class="i">+unsigned int mousefg = 7;
</a><a href="#h1-6-23" id="h1-6-23" class="i">+unsigned int mousebg = 0;
</a> 
 /*
  * Color used to display font attributes when fontconfig selected a font which
  * doesn&#39;t match the ones requested.
  */
<a href="#h1-6-29" id="h1-6-29" class="d">-static unsigned int defaultattr = 11;
</a><a href="#h1-6-30" id="h1-6-30" class="i">+unsigned int defaultattr = 11;
</a> 
 /*
  * Internal mouse shortcuts.
  * Beware that overloading Button1 will disable the selection.
  */
<a href="#h1-6-36" id="h1-6-36" class="d">-static MouseShortcut mshortcuts[] = {
</a><a href="#h1-6-37" id="h1-6-37" class="i">+MouseShortcut mshortcuts[] = {
</a> 	/* button               mask            string */
 	{ Button4,              XK_ANY_MOD,     &quot;\031&quot; },
 	{ Button5,              XK_ANY_MOD,     &quot;\005&quot; },
<a href="#h1-7" id="h1-7" class="h">@@ -163,15 +163,15 @@ static MouseShortcut mshortcuts[] = {
</a> /* Internal keyboard shortcuts. */
 #define MODKEY Mod1Mask
 
<a href="#h1-7-3" id="h1-7-3" class="d">-static Shortcut shortcuts[] = {
</a><a href="#h1-7-4" id="h1-7-4" class="i">+Shortcut shortcuts[] = {
</a> 	/* mask                 keysym          function        argument */
 	{ XK_ANY_MOD,           XK_Break,       sendbreak,      {.i =  0} },
 	{ ControlMask,          XK_Print,       toggleprinter,  {.i =  0} },
 	{ ShiftMask,            XK_Print,       printscreen,    {.i =  0} },
 	{ XK_ANY_MOD,           XK_Print,       printsel,       {.i =  0} },
<a href="#h1-7-10" id="h1-7-10" class="d">-	{ MODKEY|ShiftMask,     XK_Prior,       xzoom,          {.f = +1} },
</a><a href="#h1-7-11" id="h1-7-11" class="d">-	{ MODKEY|ShiftMask,     XK_Next,        xzoom,          {.f = -1} },
</a><a href="#h1-7-12" id="h1-7-12" class="d">-	{ MODKEY|ShiftMask,     XK_Home,        xzoomreset,     {.f =  0} },
</a><a href="#h1-7-13" id="h1-7-13" class="i">+	{ MODKEY|ShiftMask,     XK_Prior,       zoom,           {.f = +1} },
</a><a href="#h1-7-14" id="h1-7-14" class="i">+	{ MODKEY|ShiftMask,     XK_Next,        zoom,           {.f = -1} },
</a><a href="#h1-7-15" id="h1-7-15" class="i">+	{ MODKEY|ShiftMask,     XK_Home,        zoomreset,      {.f =  0} },
</a> 	{ ShiftMask,            XK_Insert,      selpaste,       {.i =  0} },
 	{ MODKEY|ShiftMask,     XK_Insert,      clippaste,      {.i =  0} },
 	{ MODKEY|ShiftMask,     XK_C,           clipcopy,       {.i =  0} },
<a href="#h1-8" id="h1-8" class="h">@@ -222,7 +222,7 @@ static uint ignoremod = Mod2Mask|XK_SWITCH_MOD;
</a>  * Note that if you want to use ShiftMask with selmasks, set this to an other
  * modifier, set to 0 to not use it.
  */
<a href="#h1-8-3" id="h1-8-3" class="d">-static uint forceselmod = ShiftMask;
</a><a href="#h1-8-4" id="h1-8-4" class="i">+uint forceselmod = ShiftMask;
</a> 
 /*
  * This is the huge key array which defines all compatibility to the Linux
<a href="#h1-9" id="h1-9" class="h">@@ -451,7 +451,7 @@ static Key key[] = {
</a>  * ButtonRelease and MotionNotify.
  * If no match is found, regular selection is used.
  */
<a href="#h1-9-3" id="h1-9-3" class="d">-static uint selmasks[] = {
</a><a href="#h1-9-4" id="h1-9-4" class="i">+uint selmasks[] = {
</a> 	[SEL_RECTANGULAR] = Mod1Mask,
 };
 
<a href="#h1-10" id="h1-10" class="h">@@ -459,7 +459,7 @@ static uint selmasks[] = {
</a>  * Printable characters in ASCII, used to estimate the advance width
  * of single wide characters.
  */
<a href="#h1-10-3" id="h1-10-3" class="d">-static char ascii_printable[] =
</a><a href="#h1-10-4" id="h1-10-4" class="i">+char ascii_printable[] =
</a> 	&quot; !\&quot;#$%&amp;&#39;()*+,-./0123456789:;&lt;=&gt;?&quot;
 	&quot;@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_&quot;
 	&quot;`abcdefghijklmnopqrstuvwxyz{|}~&quot;;
<b>diff --git a/<a id="h2" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -21,23 +21,21 @@
</a> #include &lt;time.h&gt;
 #include &lt;unistd.h&gt;
 #include &lt;libgen.h&gt;
<a href="#h2-0-3" id="h2-0-3" class="d">-#include &lt;X11/Xatom.h&gt;
</a><a href="#h2-0-4" id="h2-0-4" class="d">-#include &lt;X11/Xlib.h&gt;
</a><a href="#h2-0-5" id="h2-0-5" class="d">-#include &lt;X11/Xutil.h&gt;
</a><a href="#h2-0-6" id="h2-0-6" class="d">-#include &lt;X11/cursorfont.h&gt;
</a><a href="#h2-0-7" id="h2-0-7" class="d">-#include &lt;X11/keysym.h&gt;
</a><a href="#h2-0-8" id="h2-0-8" class="d">-#include &lt;X11/Xft/Xft.h&gt;
</a><a href="#h2-0-9" id="h2-0-9" class="d">-#include &lt;X11/XKBlib.h&gt;
</a> #include &lt;fontconfig/fontconfig.h&gt;
 #include &lt;wchar.h&gt;
 
<a href="#h2-0-13" id="h2-0-13" class="d">-#include &quot;arg.h&quot;
</a><a href="#h2-0-14" id="h2-0-14" class="i">+/* X11 */
</a><a href="#h2-0-15" id="h2-0-15" class="i">+#include &lt;X11/cursorfont.h&gt;
</a><a href="#h2-0-16" id="h2-0-16" class="i">+#include &lt;X11/Xft/Xft.h&gt;
</a> 
 char *argv0;
 
 #define Glyph Glyph_
 #define Font Font_
 
<a href="#h2-0-23" id="h2-0-23" class="i">+#include &quot;win.h&quot;
</a><a href="#h2-0-24" id="h2-0-24" class="i">+#include &quot;st.h&quot;
</a><a href="#h2-0-25" id="h2-0-25" class="i">+
</a> #if   defined(__linux)
  #include &lt;pty.h&gt;
 #elif defined(__OpenBSD__) || defined(__NetBSD__) || defined(__APPLE__)
<a href="#h2-1" id="h2-1" class="h">@@ -46,67 +44,24 @@ char *argv0;
</a>  #include &lt;libutil.h&gt;
 #endif
 
<a href="#h2-1-3" id="h2-1-3" class="d">-
</a><a href="#h2-1-4" id="h2-1-4" class="d">-/* XEMBED messages */
</a><a href="#h2-1-5" id="h2-1-5" class="d">-#define XEMBED_FOCUS_IN  4
</a><a href="#h2-1-6" id="h2-1-6" class="d">-#define XEMBED_FOCUS_OUT 5
</a><a href="#h2-1-7" id="h2-1-7" class="d">-
</a> /* Arbitrary sizes */
 #define UTF_INVALID   0xFFFD
<a href="#h2-1-10" id="h2-1-10" class="d">-#define UTF_SIZ       4
</a> #define ESC_BUF_SIZ   (128*UTF_SIZ)
 #define ESC_ARG_SIZ   16
 #define STR_BUF_SIZ   ESC_BUF_SIZ
 #define STR_ARG_SIZ   ESC_ARG_SIZ
<a href="#h2-1-15" id="h2-1-15" class="d">-#define XK_ANY_MOD    UINT_MAX
</a><a href="#h2-1-16" id="h2-1-16" class="d">-#define XK_NO_MOD     0
</a><a href="#h2-1-17" id="h2-1-17" class="d">-#define XK_SWITCH_MOD (1&lt;&lt;13)
</a> 
 /* macros */
<a href="#h2-1-20" id="h2-1-20" class="d">-#define MIN(a, b)		((a) &lt; (b) ? (a) : (b))
</a><a href="#h2-1-21" id="h2-1-21" class="d">-#define MAX(a, b)		((a) &lt; (b) ? (b) : (a))
</a><a href="#h2-1-22" id="h2-1-22" class="d">-#define LEN(a)			(sizeof(a) / sizeof(a)[0])
</a> #define NUMMAXLEN(x)		((int)(sizeof(x) * 2.56 + 0.5) + 1)
 #define DEFAULT(a, b)		(a) = (a) ? (a) : (b)
<a href="#h2-1-25" id="h2-1-25" class="d">-#define BETWEEN(x, a, b)	((a) &lt;= (x) &amp;&amp; (x) &lt;= (b))
</a><a href="#h2-1-26" id="h2-1-26" class="d">-#define DIVCEIL(n, d)		(((n) + ((d) - 1)) / (d))
</a> #define ISCONTROLC0(c)		(BETWEEN(c, 0, 0x1f) || (c) == &#39;\177&#39;)
 #define ISCONTROLC1(c)		(BETWEEN(c, 0x80, 0x9f))
 #define ISCONTROL(c)		(ISCONTROLC0(c) || ISCONTROLC1(c))
 #define ISDELIM(u)		(utf8strchr(worddelimiters, u) != NULL)
<a href="#h2-1-31" id="h2-1-31" class="d">-#define LIMIT(x, a, b)		(x) = (x) &lt; (a) ? (a) : (x) &gt; (b) ? (b) : (x)
</a><a href="#h2-1-32" id="h2-1-32" class="d">-#define ATTRCMP(a, b)		((a).mode != (b).mode || (a).fg != (b).fg || \
</a><a href="#h2-1-33" id="h2-1-33" class="d">-				(a).bg != (b).bg)
</a><a href="#h2-1-34" id="h2-1-34" class="d">-#define IS_SET(flag)		((term.mode &amp; (flag)) != 0)
</a><a href="#h2-1-35" id="h2-1-35" class="d">-#define TIMEDIFF(t1, t2)	((t1.tv_sec-t2.tv_sec)*1000 + \
</a><a href="#h2-1-36" id="h2-1-36" class="d">-				(t1.tv_nsec-t2.tv_nsec)/1E6)
</a><a href="#h2-1-37" id="h2-1-37" class="d">-#define MODBIT(x, set, bit)	((set) ? ((x) |= (bit)) : ((x) &amp;= ~(bit)))
</a><a href="#h2-1-38" id="h2-1-38" class="d">-
</a><a href="#h2-1-39" id="h2-1-39" class="d">-#define TRUECOLOR(r,g,b)	(1 &lt;&lt; 24 | (r) &lt;&lt; 16 | (g) &lt;&lt; 8 | (b))
</a><a href="#h2-1-40" id="h2-1-40" class="d">-#define IS_TRUECOL(x)		(1 &lt;&lt; 24 &amp; (x))
</a><a href="#h2-1-41" id="h2-1-41" class="d">-#define TRUERED(x)		(((x) &amp; 0xff0000) &gt;&gt; 8)
</a><a href="#h2-1-42" id="h2-1-42" class="d">-#define TRUEGREEN(x)		(((x) &amp; 0xff00))
</a><a href="#h2-1-43" id="h2-1-43" class="d">-#define TRUEBLUE(x)		(((x) &amp; 0xff) &lt;&lt; 8)
</a> 
 /* constants */
 #define ISO14755CMD		&quot;dmenu -w %lu -p codepoint: &lt;/dev/null&quot;
 
<a href="#h2-1-48" id="h2-1-48" class="d">-enum glyph_attribute {
</a><a href="#h2-1-49" id="h2-1-49" class="d">-	ATTR_NULL       = 0,
</a><a href="#h2-1-50" id="h2-1-50" class="d">-	ATTR_BOLD       = 1 &lt;&lt; 0,
</a><a href="#h2-1-51" id="h2-1-51" class="d">-	ATTR_FAINT      = 1 &lt;&lt; 1,
</a><a href="#h2-1-52" id="h2-1-52" class="d">-	ATTR_ITALIC     = 1 &lt;&lt; 2,
</a><a href="#h2-1-53" id="h2-1-53" class="d">-	ATTR_UNDERLINE  = 1 &lt;&lt; 3,
</a><a href="#h2-1-54" id="h2-1-54" class="d">-	ATTR_BLINK      = 1 &lt;&lt; 4,
</a><a href="#h2-1-55" id="h2-1-55" class="d">-	ATTR_REVERSE    = 1 &lt;&lt; 5,
</a><a href="#h2-1-56" id="h2-1-56" class="d">-	ATTR_INVISIBLE  = 1 &lt;&lt; 6,
</a><a href="#h2-1-57" id="h2-1-57" class="d">-	ATTR_STRUCK     = 1 &lt;&lt; 7,
</a><a href="#h2-1-58" id="h2-1-58" class="d">-	ATTR_WRAP       = 1 &lt;&lt; 8,
</a><a href="#h2-1-59" id="h2-1-59" class="d">-	ATTR_WIDE       = 1 &lt;&lt; 9,
</a><a href="#h2-1-60" id="h2-1-60" class="d">-	ATTR_WDUMMY     = 1 &lt;&lt; 10,
</a><a href="#h2-1-61" id="h2-1-61" class="d">-	ATTR_BOLD_FAINT = ATTR_BOLD | ATTR_FAINT,
</a><a href="#h2-1-62" id="h2-1-62" class="d">-};
</a><a href="#h2-1-63" id="h2-1-63" class="d">-
</a> enum cursor_movement {
 	CURSOR_SAVE,
 	CURSOR_LOAD
<a href="#h2-2" id="h2-2" class="h">@@ -118,34 +73,6 @@ enum cursor_state {
</a> 	CURSOR_ORIGIN   = 2
 };
 
<a href="#h2-2-3" id="h2-2-3" class="d">-enum term_mode {
</a><a href="#h2-2-4" id="h2-2-4" class="d">-	MODE_WRAP        = 1 &lt;&lt; 0,
</a><a href="#h2-2-5" id="h2-2-5" class="d">-	MODE_INSERT      = 1 &lt;&lt; 1,
</a><a href="#h2-2-6" id="h2-2-6" class="d">-	MODE_APPKEYPAD   = 1 &lt;&lt; 2,
</a><a href="#h2-2-7" id="h2-2-7" class="d">-	MODE_ALTSCREEN   = 1 &lt;&lt; 3,
</a><a href="#h2-2-8" id="h2-2-8" class="d">-	MODE_CRLF        = 1 &lt;&lt; 4,
</a><a href="#h2-2-9" id="h2-2-9" class="d">-	MODE_MOUSEBTN    = 1 &lt;&lt; 5,
</a><a href="#h2-2-10" id="h2-2-10" class="d">-	MODE_MOUSEMOTION = 1 &lt;&lt; 6,
</a><a href="#h2-2-11" id="h2-2-11" class="d">-	MODE_REVERSE     = 1 &lt;&lt; 7,
</a><a href="#h2-2-12" id="h2-2-12" class="d">-	MODE_KBDLOCK     = 1 &lt;&lt; 8,
</a><a href="#h2-2-13" id="h2-2-13" class="d">-	MODE_HIDE        = 1 &lt;&lt; 9,
</a><a href="#h2-2-14" id="h2-2-14" class="d">-	MODE_ECHO        = 1 &lt;&lt; 10,
</a><a href="#h2-2-15" id="h2-2-15" class="d">-	MODE_APPCURSOR   = 1 &lt;&lt; 11,
</a><a href="#h2-2-16" id="h2-2-16" class="d">-	MODE_MOUSESGR    = 1 &lt;&lt; 12,
</a><a href="#h2-2-17" id="h2-2-17" class="d">-	MODE_8BIT        = 1 &lt;&lt; 13,
</a><a href="#h2-2-18" id="h2-2-18" class="d">-	MODE_BLINK       = 1 &lt;&lt; 14,
</a><a href="#h2-2-19" id="h2-2-19" class="d">-	MODE_FBLINK      = 1 &lt;&lt; 15,
</a><a href="#h2-2-20" id="h2-2-20" class="d">-	MODE_FOCUS       = 1 &lt;&lt; 16,
</a><a href="#h2-2-21" id="h2-2-21" class="d">-	MODE_MOUSEX10    = 1 &lt;&lt; 17,
</a><a href="#h2-2-22" id="h2-2-22" class="d">-	MODE_MOUSEMANY   = 1 &lt;&lt; 18,
</a><a href="#h2-2-23" id="h2-2-23" class="d">-	MODE_BRCKTPASTE  = 1 &lt;&lt; 19,
</a><a href="#h2-2-24" id="h2-2-24" class="d">-	MODE_PRINT       = 1 &lt;&lt; 20,
</a><a href="#h2-2-25" id="h2-2-25" class="d">-	MODE_UTF8        = 1 &lt;&lt; 21,
</a><a href="#h2-2-26" id="h2-2-26" class="d">-	MODE_SIXEL       = 1 &lt;&lt; 22,
</a><a href="#h2-2-27" id="h2-2-27" class="d">-	MODE_MOUSE       = MODE_MOUSEBTN|MODE_MOUSEMOTION|MODE_MOUSEX10\
</a><a href="#h2-2-28" id="h2-2-28" class="d">-	                  |MODE_MOUSEMANY,
</a><a href="#h2-2-29" id="h2-2-29" class="d">-};
</a><a href="#h2-2-30" id="h2-2-30" class="d">-
</a> enum charset {
 	CS_GRAPHIC0,
 	CS_GRAPHIC1,
<a href="#h2-3" id="h2-3" class="h">@@ -167,53 +94,6 @@ enum escape_state {
</a> 	ESC_DCS        =128,
 };
 
<a href="#h2-3-3" id="h2-3-3" class="d">-enum window_state {
</a><a href="#h2-3-4" id="h2-3-4" class="d">-	WIN_VISIBLE = 1,
</a><a href="#h2-3-5" id="h2-3-5" class="d">-	WIN_FOCUSED = 2
</a><a href="#h2-3-6" id="h2-3-6" class="d">-};
</a><a href="#h2-3-7" id="h2-3-7" class="d">-
</a><a href="#h2-3-8" id="h2-3-8" class="d">-enum selection_mode {
</a><a href="#h2-3-9" id="h2-3-9" class="d">-	SEL_IDLE = 0,
</a><a href="#h2-3-10" id="h2-3-10" class="d">-	SEL_EMPTY = 1,
</a><a href="#h2-3-11" id="h2-3-11" class="d">-	SEL_READY = 2
</a><a href="#h2-3-12" id="h2-3-12" class="d">-};
</a><a href="#h2-3-13" id="h2-3-13" class="d">-
</a><a href="#h2-3-14" id="h2-3-14" class="d">-enum selection_type {
</a><a href="#h2-3-15" id="h2-3-15" class="d">-	SEL_REGULAR = 1,
</a><a href="#h2-3-16" id="h2-3-16" class="d">-	SEL_RECTANGULAR = 2
</a><a href="#h2-3-17" id="h2-3-17" class="d">-};
</a><a href="#h2-3-18" id="h2-3-18" class="d">-
</a><a href="#h2-3-19" id="h2-3-19" class="d">-enum selection_snap {
</a><a href="#h2-3-20" id="h2-3-20" class="d">-	SNAP_WORD = 1,
</a><a href="#h2-3-21" id="h2-3-21" class="d">-	SNAP_LINE = 2
</a><a href="#h2-3-22" id="h2-3-22" class="d">-};
</a><a href="#h2-3-23" id="h2-3-23" class="d">-
</a><a href="#h2-3-24" id="h2-3-24" class="d">-typedef unsigned char uchar;
</a><a href="#h2-3-25" id="h2-3-25" class="d">-typedef unsigned int uint;
</a><a href="#h2-3-26" id="h2-3-26" class="d">-typedef unsigned long ulong;
</a><a href="#h2-3-27" id="h2-3-27" class="d">-typedef unsigned short ushort;
</a><a href="#h2-3-28" id="h2-3-28" class="d">-
</a><a href="#h2-3-29" id="h2-3-29" class="d">-typedef uint_least32_t Rune;
</a><a href="#h2-3-30" id="h2-3-30" class="d">-
</a><a href="#h2-3-31" id="h2-3-31" class="d">-typedef XftDraw *Draw;
</a><a href="#h2-3-32" id="h2-3-32" class="d">-typedef XftColor Color;
</a><a href="#h2-3-33" id="h2-3-33" class="d">-
</a><a href="#h2-3-34" id="h2-3-34" class="d">-typedef struct {
</a><a href="#h2-3-35" id="h2-3-35" class="d">-	Rune u;           /* character code */
</a><a href="#h2-3-36" id="h2-3-36" class="d">-	ushort mode;      /* attribute flags */
</a><a href="#h2-3-37" id="h2-3-37" class="d">-	uint32_t fg;      /* foreground  */
</a><a href="#h2-3-38" id="h2-3-38" class="d">-	uint32_t bg;      /* background  */
</a><a href="#h2-3-39" id="h2-3-39" class="d">-} Glyph;
</a><a href="#h2-3-40" id="h2-3-40" class="d">-
</a><a href="#h2-3-41" id="h2-3-41" class="d">-typedef Glyph *Line;
</a><a href="#h2-3-42" id="h2-3-42" class="d">-
</a><a href="#h2-3-43" id="h2-3-43" class="d">-typedef struct {
</a><a href="#h2-3-44" id="h2-3-44" class="d">-	Glyph attr; /* current char attributes */
</a><a href="#h2-3-45" id="h2-3-45" class="d">-	int x;
</a><a href="#h2-3-46" id="h2-3-46" class="d">-	int y;
</a><a href="#h2-3-47" id="h2-3-47" class="d">-	char state;
</a><a href="#h2-3-48" id="h2-3-48" class="d">-} TCursor;
</a><a href="#h2-3-49" id="h2-3-49" class="d">-
</a> /* CSI Escape sequence structs */
 /* ESC &#39;[&#39; [[ [&lt;priv&gt;] &lt;arg&gt; [;]] &lt;mode&gt; [&lt;mode&gt;]] */
 typedef struct {
<a href="#h2-4" id="h2-4" class="h">@@ -235,56 +115,6 @@ typedef struct {
</a> 	int narg;              /* nb of args */
 } STREscape;
 
<a href="#h2-4-3" id="h2-4-3" class="d">-/* Internal representation of the screen */
</a><a href="#h2-4-4" id="h2-4-4" class="d">-typedef struct {
</a><a href="#h2-4-5" id="h2-4-5" class="d">-	int row;      /* nb row */
</a><a href="#h2-4-6" id="h2-4-6" class="d">-	int col;      /* nb col */
</a><a href="#h2-4-7" id="h2-4-7" class="d">-	Line *line;   /* screen */
</a><a href="#h2-4-8" id="h2-4-8" class="d">-	Line *alt;    /* alternate screen */
</a><a href="#h2-4-9" id="h2-4-9" class="d">-	int *dirty;  /* dirtyness of lines */
</a><a href="#h2-4-10" id="h2-4-10" class="d">-	XftGlyphFontSpec *specbuf; /* font spec buffer used for rendering */
</a><a href="#h2-4-11" id="h2-4-11" class="d">-	TCursor c;    /* cursor */
</a><a href="#h2-4-12" id="h2-4-12" class="d">-	int top;      /* top    scroll limit */
</a><a href="#h2-4-13" id="h2-4-13" class="d">-	int bot;      /* bottom scroll limit */
</a><a href="#h2-4-14" id="h2-4-14" class="d">-	int mode;     /* terminal mode flags */
</a><a href="#h2-4-15" id="h2-4-15" class="d">-	int esc;      /* escape state flags */
</a><a href="#h2-4-16" id="h2-4-16" class="d">-	char trantbl[4]; /* charset table translation */
</a><a href="#h2-4-17" id="h2-4-17" class="d">-	int charset;  /* current charset */
</a><a href="#h2-4-18" id="h2-4-18" class="d">-	int icharset; /* selected charset for sequence */
</a><a href="#h2-4-19" id="h2-4-19" class="d">-	int numlock; /* lock numbers in keyboard */
</a><a href="#h2-4-20" id="h2-4-20" class="d">-	int *tabs;
</a><a href="#h2-4-21" id="h2-4-21" class="d">-} Term;
</a><a href="#h2-4-22" id="h2-4-22" class="d">-
</a><a href="#h2-4-23" id="h2-4-23" class="d">-/* Purely graphic info */
</a><a href="#h2-4-24" id="h2-4-24" class="d">-typedef struct {
</a><a href="#h2-4-25" id="h2-4-25" class="d">-	Display *dpy;
</a><a href="#h2-4-26" id="h2-4-26" class="d">-	Colormap cmap;
</a><a href="#h2-4-27" id="h2-4-27" class="d">-	Window win;
</a><a href="#h2-4-28" id="h2-4-28" class="d">-	Drawable buf;
</a><a href="#h2-4-29" id="h2-4-29" class="d">-	Atom xembed, wmdeletewin, netwmname, netwmpid;
</a><a href="#h2-4-30" id="h2-4-30" class="d">-	XIM xim;
</a><a href="#h2-4-31" id="h2-4-31" class="d">-	XIC xic;
</a><a href="#h2-4-32" id="h2-4-32" class="d">-	Draw draw;
</a><a href="#h2-4-33" id="h2-4-33" class="d">-	Visual *vis;
</a><a href="#h2-4-34" id="h2-4-34" class="d">-	XSetWindowAttributes attrs;
</a><a href="#h2-4-35" id="h2-4-35" class="d">-	int scr;
</a><a href="#h2-4-36" id="h2-4-36" class="d">-	int isfixed; /* is fixed geometry? */
</a><a href="#h2-4-37" id="h2-4-37" class="d">-	int l, t; /* left and top offset */
</a><a href="#h2-4-38" id="h2-4-38" class="d">-	int gm; /* geometry mask */
</a><a href="#h2-4-39" id="h2-4-39" class="d">-	int tw, th; /* tty width and height */
</a><a href="#h2-4-40" id="h2-4-40" class="d">-	int w, h; /* window width and height */
</a><a href="#h2-4-41" id="h2-4-41" class="d">-	int ch; /* char height */
</a><a href="#h2-4-42" id="h2-4-42" class="d">-	int cw; /* char width  */
</a><a href="#h2-4-43" id="h2-4-43" class="d">-	char state; /* focus, redraw, visible */
</a><a href="#h2-4-44" id="h2-4-44" class="d">-	int cursor; /* cursor style */
</a><a href="#h2-4-45" id="h2-4-45" class="d">-} XWindow;
</a><a href="#h2-4-46" id="h2-4-46" class="d">-
</a><a href="#h2-4-47" id="h2-4-47" class="d">-typedef struct {
</a><a href="#h2-4-48" id="h2-4-48" class="d">-	uint b;
</a><a href="#h2-4-49" id="h2-4-49" class="d">-	uint mask;
</a><a href="#h2-4-50" id="h2-4-50" class="d">-	char *s;
</a><a href="#h2-4-51" id="h2-4-51" class="d">-} MouseShortcut;
</a><a href="#h2-4-52" id="h2-4-52" class="d">-
</a> typedef struct {
 	KeySym k;
 	uint mask;
<a href="#h2-5" id="h2-5" class="h">@@ -295,89 +125,26 @@ typedef struct {
</a> 	signed char crlf;      /* crlf mode          */
 } Key;
 
<a href="#h2-5-3" id="h2-5-3" class="d">-typedef struct {
</a><a href="#h2-5-4" id="h2-5-4" class="d">-	int mode;
</a><a href="#h2-5-5" id="h2-5-5" class="d">-	int type;
</a><a href="#h2-5-6" id="h2-5-6" class="d">-	int snap;
</a><a href="#h2-5-7" id="h2-5-7" class="d">-	/*
</a><a href="#h2-5-8" id="h2-5-8" class="d">-	 * Selection variables:
</a><a href="#h2-5-9" id="h2-5-9" class="d">-	 * nb – normalized coordinates of the beginning of the selection
</a><a href="#h2-5-10" id="h2-5-10" class="d">-	 * ne – normalized coordinates of the end of the selection
</a><a href="#h2-5-11" id="h2-5-11" class="d">-	 * ob – original coordinates of the beginning of the selection
</a><a href="#h2-5-12" id="h2-5-12" class="d">-	 * oe – original coordinates of the end of the selection
</a><a href="#h2-5-13" id="h2-5-13" class="d">-	 */
</a><a href="#h2-5-14" id="h2-5-14" class="d">-	struct {
</a><a href="#h2-5-15" id="h2-5-15" class="d">-		int x, y;
</a><a href="#h2-5-16" id="h2-5-16" class="d">-	} nb, ne, ob, oe;
</a><a href="#h2-5-17" id="h2-5-17" class="d">-
</a><a href="#h2-5-18" id="h2-5-18" class="d">-	char *primary, *clipboard;
</a><a href="#h2-5-19" id="h2-5-19" class="d">-	Atom xtarget;
</a><a href="#h2-5-20" id="h2-5-20" class="d">-	int alt;
</a><a href="#h2-5-21" id="h2-5-21" class="d">-	struct timespec tclick1;
</a><a href="#h2-5-22" id="h2-5-22" class="d">-	struct timespec tclick2;
</a><a href="#h2-5-23" id="h2-5-23" class="d">-} Selection;
</a><a href="#h2-5-24" id="h2-5-24" class="d">-
</a><a href="#h2-5-25" id="h2-5-25" class="d">-typedef union {
</a><a href="#h2-5-26" id="h2-5-26" class="d">-	int i;
</a><a href="#h2-5-27" id="h2-5-27" class="d">-	uint ui;
</a><a href="#h2-5-28" id="h2-5-28" class="d">-	float f;
</a><a href="#h2-5-29" id="h2-5-29" class="d">-	const void *v;
</a><a href="#h2-5-30" id="h2-5-30" class="d">-} Arg;
</a><a href="#h2-5-31" id="h2-5-31" class="d">-
</a><a href="#h2-5-32" id="h2-5-32" class="d">-typedef struct {
</a><a href="#h2-5-33" id="h2-5-33" class="d">-	uint mod;
</a><a href="#h2-5-34" id="h2-5-34" class="d">-	KeySym keysym;
</a><a href="#h2-5-35" id="h2-5-35" class="d">-	void (*func)(const Arg *);
</a><a href="#h2-5-36" id="h2-5-36" class="d">-	const Arg arg;
</a><a href="#h2-5-37" id="h2-5-37" class="d">-} Shortcut;
</a><a href="#h2-5-38" id="h2-5-38" class="d">-
</a> /* function definitions used in config.h */
 static void clipcopy(const Arg *);
 static void clippaste(const Arg *);
 static void numlock(const Arg *);
 static void selpaste(const Arg *);
<a href="#h2-5-44" id="h2-5-44" class="d">-static void xzoom(const Arg *);
</a><a href="#h2-5-45" id="h2-5-45" class="d">-static void xzoomabs(const Arg *);
</a><a href="#h2-5-46" id="h2-5-46" class="d">-static void xzoomreset(const Arg *);
</a><a href="#h2-5-47" id="h2-5-47" class="i">+static void zoom(const Arg *);
</a><a href="#h2-5-48" id="h2-5-48" class="i">+static void zoomabs(const Arg *);
</a><a href="#h2-5-49" id="h2-5-49" class="i">+static void zoomreset(const Arg *);
</a> static void printsel(const Arg *);
 static void printscreen(const Arg *) ;
 static void iso14755(const Arg *);
 static void toggleprinter(const Arg *);
 static void sendbreak(const Arg *);
 
<a href="#h2-5-56" id="h2-5-56" class="d">-/* Config.h for applying patches and the configuration. */
</a><a href="#h2-5-57" id="h2-5-57" class="i">+/* config.h for applying patches and the configuration. */
</a> #include &quot;config.h&quot;
 
<a href="#h2-5-60" id="h2-5-60" class="d">-/* Font structure */
</a><a href="#h2-5-61" id="h2-5-61" class="d">-typedef struct {
</a><a href="#h2-5-62" id="h2-5-62" class="d">-	int height;
</a><a href="#h2-5-63" id="h2-5-63" class="d">-	int width;
</a><a href="#h2-5-64" id="h2-5-64" class="d">-	int ascent;
</a><a href="#h2-5-65" id="h2-5-65" class="d">-	int descent;
</a><a href="#h2-5-66" id="h2-5-66" class="d">-	int badslant;
</a><a href="#h2-5-67" id="h2-5-67" class="d">-	int badweight;
</a><a href="#h2-5-68" id="h2-5-68" class="d">-	short lbearing;
</a><a href="#h2-5-69" id="h2-5-69" class="d">-	short rbearing;
</a><a href="#h2-5-70" id="h2-5-70" class="d">-	XftFont *match;
</a><a href="#h2-5-71" id="h2-5-71" class="d">-	FcFontSet *set;
</a><a href="#h2-5-72" id="h2-5-72" class="d">-	FcPattern *pattern;
</a><a href="#h2-5-73" id="h2-5-73" class="d">-} Font;
</a><a href="#h2-5-74" id="h2-5-74" class="d">-
</a><a href="#h2-5-75" id="h2-5-75" class="d">-/* Drawing Context */
</a><a href="#h2-5-76" id="h2-5-76" class="d">-typedef struct {
</a><a href="#h2-5-77" id="h2-5-77" class="d">-	Color col[MAX(LEN(colorname), 256)];
</a><a href="#h2-5-78" id="h2-5-78" class="d">-	Font font, bfont, ifont, ibfont;
</a><a href="#h2-5-79" id="h2-5-79" class="d">-	GC gc;
</a><a href="#h2-5-80" id="h2-5-80" class="d">-} DC;
</a><a href="#h2-5-81" id="h2-5-81" class="d">-
</a><a href="#h2-5-82" id="h2-5-82" class="d">-static void die(const char *, ...);
</a><a href="#h2-5-83" id="h2-5-83" class="d">-static void draw(void);
</a><a href="#h2-5-84" id="h2-5-84" class="d">-static void redraw(void);
</a><a href="#h2-5-85" id="h2-5-85" class="d">-static void drawregion(int, int, int, int);
</a> static void execsh(void);
 static void stty(void);
 static void sigchld(int);
<a href="#h2-5-89" id="h2-5-89" class="d">-static void run(void);
</a> 
 static void csidump(void);
 static void csihandle(void);
<a href="#h2-6" id="h2-6" class="h">@@ -389,7 +156,6 @@ static void strhandle(void);
</a> static void strparse(void);
 static void strreset(void);
 
<a href="#h2-6-3" id="h2-6-3" class="d">-static int tattrset(int);
</a> static void tprinter(char *, size_t);
 static void tdumpsel(void);
 static void tdumpline(int);
<a href="#h2-7" id="h2-7" class="h">@@ -403,7 +169,6 @@ static void tinsertblankline(int);
</a> static int tlinelen(int);
 static void tmoveto(int, int);
 static void tmoveato(int, int);
<a href="#h2-7-3" id="h2-7-3" class="d">-static void tnew(int, int);
</a> static void tnewline(int);
 static void tputtab(int);
 static void tputc(Rune);
<a href="#h2-8" id="h2-8" class="h">@@ -415,8 +180,6 @@ static void tsetattr(int *, int);
</a> static void tsetchar(Rune, Glyph *, int, int);
 static void tsetscroll(int, int);
 static void tswapscreen(void);
<a href="#h2-8-3" id="h2-8-3" class="d">-static void tsetdirt(int, int);
</a><a href="#h2-8-4" id="h2-8-4" class="d">-static void tsetdirtattr(int);
</a> static void tsetmode(int, int, int *, int);
 static void tfulldirt(void);
 static void techo(Rune);
<a href="#h2-9" id="h2-9" class="h">@@ -425,151 +188,53 @@ static void tdectest(char );
</a> static void tdefutf8(char);
 static int32_t tdefcolor(int *, int *, int);
 static void tdeftran(char);
<a href="#h2-9-3" id="h2-9-3" class="d">-static inline int match(uint, uint);
</a><a href="#h2-9-4" id="h2-9-4" class="d">-static void ttynew(void);
</a><a href="#h2-9-5" id="h2-9-5" class="d">-static size_t ttyread(void);
</a><a href="#h2-9-6" id="h2-9-6" class="d">-static void ttyresize(void);
</a><a href="#h2-9-7" id="h2-9-7" class="d">-static void ttysend(char *, size_t);
</a><a href="#h2-9-8" id="h2-9-8" class="d">-static void ttywrite(const char *, size_t);
</a> static void tstrsequence(uchar);
 
<a href="#h2-9-11" id="h2-9-11" class="d">-static inline ushort sixd_to_16bit(int);
</a><a href="#h2-9-12" id="h2-9-12" class="d">-static int xmakeglyphfontspecs(XftGlyphFontSpec *, const Glyph *, int, int, int);
</a><a href="#h2-9-13" id="h2-9-13" class="d">-static void xdrawglyphfontspecs(const XftGlyphFontSpec *, Glyph, int, int, int);
</a><a href="#h2-9-14" id="h2-9-14" class="d">-static void xdrawglyph(Glyph, int, int);
</a><a href="#h2-9-15" id="h2-9-15" class="d">-static void xhints(void);
</a><a href="#h2-9-16" id="h2-9-16" class="d">-static void xclear(int, int, int, int);
</a><a href="#h2-9-17" id="h2-9-17" class="d">-static void xdrawcursor(void);
</a><a href="#h2-9-18" id="h2-9-18" class="d">-static void xinit(void);
</a><a href="#h2-9-19" id="h2-9-19" class="d">-static void xloadcols(void);
</a><a href="#h2-9-20" id="h2-9-20" class="d">-static int xsetcolorname(int, const char *);
</a><a href="#h2-9-21" id="h2-9-21" class="d">-static int xgeommasktogravity(int);
</a><a href="#h2-9-22" id="h2-9-22" class="d">-static int xloadfont(Font *, FcPattern *);
</a><a href="#h2-9-23" id="h2-9-23" class="d">-static void xloadfonts(char *, double);
</a><a href="#h2-9-24" id="h2-9-24" class="d">-static void xsettitle(char *);
</a><a href="#h2-9-25" id="h2-9-25" class="d">-static void xresettitle(void);
</a><a href="#h2-9-26" id="h2-9-26" class="d">-static void xsetpointermotion(int);
</a><a href="#h2-9-27" id="h2-9-27" class="d">-static void xseturgency(int);
</a><a href="#h2-9-28" id="h2-9-28" class="d">-static void xsetsel(char *, Time);
</a><a href="#h2-9-29" id="h2-9-29" class="d">-static void xunloadfont(Font *);
</a><a href="#h2-9-30" id="h2-9-30" class="d">-static void xunloadfonts(void);
</a><a href="#h2-9-31" id="h2-9-31" class="d">-static void xresize(int, int);
</a><a href="#h2-9-32" id="h2-9-32" class="d">-
</a><a href="#h2-9-33" id="h2-9-33" class="d">-static void expose(XEvent *);
</a><a href="#h2-9-34" id="h2-9-34" class="d">-static void visibility(XEvent *);
</a><a href="#h2-9-35" id="h2-9-35" class="d">-static void unmap(XEvent *);
</a><a href="#h2-9-36" id="h2-9-36" class="d">-static char *kmap(KeySym, uint);
</a><a href="#h2-9-37" id="h2-9-37" class="d">-static void kpress(XEvent *);
</a><a href="#h2-9-38" id="h2-9-38" class="d">-static void cmessage(XEvent *);
</a><a href="#h2-9-39" id="h2-9-39" class="d">-static void cresize(int, int);
</a><a href="#h2-9-40" id="h2-9-40" class="d">-static void resize(XEvent *);
</a><a href="#h2-9-41" id="h2-9-41" class="d">-static void focus(XEvent *);
</a><a href="#h2-9-42" id="h2-9-42" class="d">-static void brelease(XEvent *);
</a><a href="#h2-9-43" id="h2-9-43" class="d">-static void bpress(XEvent *);
</a><a href="#h2-9-44" id="h2-9-44" class="d">-static void bmotion(XEvent *);
</a><a href="#h2-9-45" id="h2-9-45" class="d">-static void propnotify(XEvent *);
</a><a href="#h2-9-46" id="h2-9-46" class="d">-static void selnotify(XEvent *);
</a><a href="#h2-9-47" id="h2-9-47" class="d">-static void selclear(XEvent *);
</a><a href="#h2-9-48" id="h2-9-48" class="d">-static void selrequest(XEvent *);
</a><a href="#h2-9-49" id="h2-9-49" class="d">-
</a><a href="#h2-9-50" id="h2-9-50" class="d">-static void selinit(void);
</a><a href="#h2-9-51" id="h2-9-51" class="d">-static void selnormalize(void);
</a><a href="#h2-9-52" id="h2-9-52" class="d">-static inline int selected(int, int);
</a><a href="#h2-9-53" id="h2-9-53" class="d">-static char *getsel(void);
</a><a href="#h2-9-54" id="h2-9-54" class="d">-static void selcopy(Time);
</a> static void selscroll(int, int);
 static void selsnap(int *, int *, int);
<a href="#h2-9-57" id="h2-9-57" class="d">-static int x2col(int);
</a><a href="#h2-9-58" id="h2-9-58" class="d">-static int y2row(int);
</a><a href="#h2-9-59" id="h2-9-59" class="d">-static void getbuttoninfo(XEvent *);
</a><a href="#h2-9-60" id="h2-9-60" class="d">-static void mousereport(XEvent *);
</a> 
<a href="#h2-9-62" id="h2-9-62" class="d">-static size_t utf8decode(char *, Rune *, size_t);
</a> static Rune utf8decodebyte(char, size_t *);
<a href="#h2-9-64" id="h2-9-64" class="d">-static size_t utf8encode(Rune, char *);
</a> static char utf8encodebyte(Rune, size_t);
 static char *utf8strchr(char *s, Rune u);
 static size_t utf8validate(Rune *, size_t);
 
 static ssize_t xwrite(int, const char *, size_t);
<a href="#h2-9-70" id="h2-9-70" class="d">-static void *xmalloc(size_t);
</a> static void *xrealloc(void *, size_t);
<a href="#h2-9-72" id="h2-9-72" class="d">-static char *xstrdup(char *);
</a><a href="#h2-9-73" id="h2-9-73" class="d">-
</a><a href="#h2-9-74" id="h2-9-74" class="d">-static void usage(void);
</a><a href="#h2-9-75" id="h2-9-75" class="d">-
</a><a href="#h2-9-76" id="h2-9-76" class="d">-static void (*handler[LASTEvent])(XEvent *) = {
</a><a href="#h2-9-77" id="h2-9-77" class="d">-	[KeyPress] = kpress,
</a><a href="#h2-9-78" id="h2-9-78" class="d">-	[ClientMessage] = cmessage,
</a><a href="#h2-9-79" id="h2-9-79" class="d">-	[ConfigureNotify] = resize,
</a><a href="#h2-9-80" id="h2-9-80" class="d">-	[VisibilityNotify] = visibility,
</a><a href="#h2-9-81" id="h2-9-81" class="d">-	[UnmapNotify] = unmap,
</a><a href="#h2-9-82" id="h2-9-82" class="d">-	[Expose] = expose,
</a><a href="#h2-9-83" id="h2-9-83" class="d">-	[FocusIn] = focus,
</a><a href="#h2-9-84" id="h2-9-84" class="d">-	[FocusOut] = focus,
</a><a href="#h2-9-85" id="h2-9-85" class="d">-	[MotionNotify] = bmotion,
</a><a href="#h2-9-86" id="h2-9-86" class="d">-	[ButtonPress] = bpress,
</a><a href="#h2-9-87" id="h2-9-87" class="d">-	[ButtonRelease] = brelease,
</a><a href="#h2-9-88" id="h2-9-88" class="d">-/*
</a><a href="#h2-9-89" id="h2-9-89" class="d">- * Uncomment if you want the selection to disappear when you select something
</a><a href="#h2-9-90" id="h2-9-90" class="d">- * different in another window.
</a><a href="#h2-9-91" id="h2-9-91" class="d">- */
</a><a href="#h2-9-92" id="h2-9-92" class="d">-/*	[SelectionClear] = selclear, */
</a><a href="#h2-9-93" id="h2-9-93" class="d">-	[SelectionNotify] = selnotify,
</a><a href="#h2-9-94" id="h2-9-94" class="d">-/*
</a><a href="#h2-9-95" id="h2-9-95" class="d">- * PropertyNotify is only turned on when there is some INCR transfer happening
</a><a href="#h2-9-96" id="h2-9-96" class="d">- * for the selection retrieval.
</a><a href="#h2-9-97" id="h2-9-97" class="d">- */
</a><a href="#h2-9-98" id="h2-9-98" class="d">-	[PropertyNotify] = propnotify,
</a><a href="#h2-9-99" id="h2-9-99" class="d">-	[SelectionRequest] = selrequest,
</a><a href="#h2-9-100" id="h2-9-100" class="d">-};
</a> 
 /* Globals */
<a href="#h2-9-103" id="h2-9-103" class="d">-static DC dc;
</a><a href="#h2-9-104" id="h2-9-104" class="d">-static XWindow xw;
</a><a href="#h2-9-105" id="h2-9-105" class="d">-static Term term;
</a><a href="#h2-9-106" id="h2-9-106" class="i">+TermWindow win;
</a><a href="#h2-9-107" id="h2-9-107" class="i">+Term term;
</a><a href="#h2-9-108" id="h2-9-108" class="i">+Selection sel;
</a><a href="#h2-9-109" id="h2-9-109" class="i">+int cmdfd;
</a><a href="#h2-9-110" id="h2-9-110" class="i">+pid_t pid;
</a><a href="#h2-9-111" id="h2-9-111" class="i">+char **opt_cmd  = NULL;
</a><a href="#h2-9-112" id="h2-9-112" class="i">+char *opt_class = NULL;
</a><a href="#h2-9-113" id="h2-9-113" class="i">+char *opt_embed = NULL;
</a><a href="#h2-9-114" id="h2-9-114" class="i">+char *opt_font  = NULL;
</a><a href="#h2-9-115" id="h2-9-115" class="i">+char *opt_io    = NULL;
</a><a href="#h2-9-116" id="h2-9-116" class="i">+char *opt_line  = NULL;
</a><a href="#h2-9-117" id="h2-9-117" class="i">+char *opt_name  = NULL;
</a><a href="#h2-9-118" id="h2-9-118" class="i">+char *opt_title = NULL;
</a><a href="#h2-9-119" id="h2-9-119" class="i">+int oldbutton   = 3; /* button event on startup: 3 = release */
</a><a href="#h2-9-120" id="h2-9-120" class="i">+
</a> static CSIEscape csiescseq;
 static STREscape strescseq;
<a href="#h2-9-123" id="h2-9-123" class="d">-static int cmdfd;
</a><a href="#h2-9-124" id="h2-9-124" class="d">-static pid_t pid;
</a><a href="#h2-9-125" id="h2-9-125" class="d">-static Selection sel;
</a> static int iofd = 1;
<a href="#h2-9-127" id="h2-9-127" class="d">-static char **opt_cmd  = NULL;
</a><a href="#h2-9-128" id="h2-9-128" class="d">-static char *opt_class = NULL;
</a><a href="#h2-9-129" id="h2-9-129" class="d">-static char *opt_embed = NULL;
</a><a href="#h2-9-130" id="h2-9-130" class="d">-static char *opt_font  = NULL;
</a><a href="#h2-9-131" id="h2-9-131" class="d">-static char *opt_io    = NULL;
</a><a href="#h2-9-132" id="h2-9-132" class="d">-static char *opt_line  = NULL;
</a><a href="#h2-9-133" id="h2-9-133" class="d">-static char *opt_name  = NULL;
</a><a href="#h2-9-134" id="h2-9-134" class="d">-static char *opt_title = NULL;
</a><a href="#h2-9-135" id="h2-9-135" class="d">-static int oldbutton   = 3; /* button event on startup: 3 = release */
</a><a href="#h2-9-136" id="h2-9-136" class="d">-
</a><a href="#h2-9-137" id="h2-9-137" class="d">-static char *usedfont = NULL;
</a><a href="#h2-9-138" id="h2-9-138" class="d">-static double usedfontsize = 0;
</a><a href="#h2-9-139" id="h2-9-139" class="d">-static double defaultfontsize = 0;
</a><a href="#h2-9-140" id="h2-9-140" class="i">+
</a><a href="#h2-9-141" id="h2-9-141" class="i">+char *usedfont = NULL;
</a><a href="#h2-9-142" id="h2-9-142" class="i">+double usedfontsize = 0;
</a><a href="#h2-9-143" id="h2-9-143" class="i">+double defaultfontsize = 0;
</a> 
 static uchar utfbyte[UTF_SIZ + 1] = {0x80,    0, 0xC0, 0xE0, 0xF0};
 static uchar utfmask[UTF_SIZ + 1] = {0xC0, 0x80, 0xE0, 0xF0, 0xF8};
 static Rune utfmin[UTF_SIZ + 1] = {       0,    0,  0x80,  0x800,  0x10000};
 static Rune utfmax[UTF_SIZ + 1] = {0x10FFFF, 0x7F, 0x7FF, 0xFFFF, 0x10FFFF};
 
<a href="#h2-9-150" id="h2-9-150" class="d">-/* Font Ring Cache */
</a><a href="#h2-9-151" id="h2-9-151" class="d">-enum {
</a><a href="#h2-9-152" id="h2-9-152" class="d">-	FRC_NORMAL,
</a><a href="#h2-9-153" id="h2-9-153" class="d">-	FRC_ITALIC,
</a><a href="#h2-9-154" id="h2-9-154" class="d">-	FRC_BOLD,
</a><a href="#h2-9-155" id="h2-9-155" class="d">-	FRC_ITALICBOLD
</a><a href="#h2-9-156" id="h2-9-156" class="d">-};
</a><a href="#h2-9-157" id="h2-9-157" class="d">-
</a><a href="#h2-9-158" id="h2-9-158" class="d">-typedef struct {
</a><a href="#h2-9-159" id="h2-9-159" class="d">-	XftFont *font;
</a><a href="#h2-9-160" id="h2-9-160" class="d">-	int flags;
</a><a href="#h2-9-161" id="h2-9-161" class="d">-	Rune unicodep;
</a><a href="#h2-9-162" id="h2-9-162" class="d">-} Fontcache;
</a><a href="#h2-9-163" id="h2-9-163" class="d">-
</a><a href="#h2-9-164" id="h2-9-164" class="d">-/* Fontcache is an array now. A new font will be appended to the array. */
</a><a href="#h2-9-165" id="h2-9-165" class="d">-static Fontcache frc[16];
</a><a href="#h2-9-166" id="h2-9-166" class="d">-static int frclen = 0;
</a><a href="#h2-9-167" id="h2-9-167" class="i">+/* config.h array lengths */
</a><a href="#h2-9-168" id="h2-9-168" class="i">+size_t colornamelen = LEN(colorname);
</a><a href="#h2-9-169" id="h2-9-169" class="i">+size_t mshortcutslen = LEN(mshortcuts);
</a><a href="#h2-9-170" id="h2-9-170" class="i">+size_t shortcutslen = LEN(shortcuts);
</a><a href="#h2-9-171" id="h2-9-171" class="i">+size_t selmaskslen = LEN(selmasks);
</a> 
 ssize_t
 xwrite(int fd, const char *s, size_t len)
<a href="#h2-10" id="h2-10" class="h">@@ -714,16 +379,13 @@ selinit(void)
</a> 	sel.ob.x = -1;
 	sel.primary = NULL;
 	sel.clipboard = NULL;
<a href="#h2-10-3" id="h2-10-3" class="d">-	sel.xtarget = XInternAtom(xw.dpy, &quot;UTF8_STRING&quot;, 0);
</a><a href="#h2-10-4" id="h2-10-4" class="d">-	if (sel.xtarget == None)
</a><a href="#h2-10-5" id="h2-10-5" class="d">-		sel.xtarget = XA_STRING;
</a> }
 
 int
 x2col(int x)
 {
 	x -= borderpx;
<a href="#h2-10-12" id="h2-10-12" class="d">-	x /= xw.cw;
</a><a href="#h2-10-13" id="h2-10-13" class="i">+	x /= win.cw;
</a> 
 	return LIMIT(x, 0, term.col-1);
 }
<a href="#h2-11" id="h2-11" class="h">@@ -732,7 +394,7 @@ int
</a> y2row(int y)
 {
 	y -= borderpx;
<a href="#h2-11-3" id="h2-11-3" class="d">-	y /= xw.ch;
</a><a href="#h2-11-4" id="h2-11-4" class="i">+	y /= win.ch;
</a> 
 	return LIMIT(y, 0, term.row-1);
 }
<a href="#h2-12" id="h2-12" class="h">@@ -867,141 +529,6 @@ selsnap(int *x, int *y, int direction)
</a> 	}
 }
 
<a href="#h2-12-3" id="h2-12-3" class="d">-void
</a><a href="#h2-12-4" id="h2-12-4" class="d">-getbuttoninfo(XEvent *e)
</a><a href="#h2-12-5" id="h2-12-5" class="d">-{
</a><a href="#h2-12-6" id="h2-12-6" class="d">-	int type;
</a><a href="#h2-12-7" id="h2-12-7" class="d">-	uint state = e-&gt;xbutton.state &amp; ~(Button1Mask | forceselmod);
</a><a href="#h2-12-8" id="h2-12-8" class="d">-
</a><a href="#h2-12-9" id="h2-12-9" class="d">-	sel.alt = IS_SET(MODE_ALTSCREEN);
</a><a href="#h2-12-10" id="h2-12-10" class="d">-
</a><a href="#h2-12-11" id="h2-12-11" class="d">-	sel.oe.x = x2col(e-&gt;xbutton.x);
</a><a href="#h2-12-12" id="h2-12-12" class="d">-	sel.oe.y = y2row(e-&gt;xbutton.y);
</a><a href="#h2-12-13" id="h2-12-13" class="d">-	selnormalize();
</a><a href="#h2-12-14" id="h2-12-14" class="d">-
</a><a href="#h2-12-15" id="h2-12-15" class="d">-	sel.type = SEL_REGULAR;
</a><a href="#h2-12-16" id="h2-12-16" class="d">-	for (type = 1; type &lt; LEN(selmasks); ++type) {
</a><a href="#h2-12-17" id="h2-12-17" class="d">-		if (match(selmasks[type], state)) {
</a><a href="#h2-12-18" id="h2-12-18" class="d">-			sel.type = type;
</a><a href="#h2-12-19" id="h2-12-19" class="d">-			break;
</a><a href="#h2-12-20" id="h2-12-20" class="d">-		}
</a><a href="#h2-12-21" id="h2-12-21" class="d">-	}
</a><a href="#h2-12-22" id="h2-12-22" class="d">-}
</a><a href="#h2-12-23" id="h2-12-23" class="d">-
</a><a href="#h2-12-24" id="h2-12-24" class="d">-void
</a><a href="#h2-12-25" id="h2-12-25" class="d">-mousereport(XEvent *e)
</a><a href="#h2-12-26" id="h2-12-26" class="d">-{
</a><a href="#h2-12-27" id="h2-12-27" class="d">-	int x = x2col(e-&gt;xbutton.x), y = y2row(e-&gt;xbutton.y),
</a><a href="#h2-12-28" id="h2-12-28" class="d">-	    button = e-&gt;xbutton.button, state = e-&gt;xbutton.state,
</a><a href="#h2-12-29" id="h2-12-29" class="d">-	    len;
</a><a href="#h2-12-30" id="h2-12-30" class="d">-	char buf[40];
</a><a href="#h2-12-31" id="h2-12-31" class="d">-	static int ox, oy;
</a><a href="#h2-12-32" id="h2-12-32" class="d">-
</a><a href="#h2-12-33" id="h2-12-33" class="d">-	/* from urxvt */
</a><a href="#h2-12-34" id="h2-12-34" class="d">-	if (e-&gt;xbutton.type == MotionNotify) {
</a><a href="#h2-12-35" id="h2-12-35" class="d">-		if (x == ox &amp;&amp; y == oy)
</a><a href="#h2-12-36" id="h2-12-36" class="d">-			return;
</a><a href="#h2-12-37" id="h2-12-37" class="d">-		if (!IS_SET(MODE_MOUSEMOTION) &amp;&amp; !IS_SET(MODE_MOUSEMANY))
</a><a href="#h2-12-38" id="h2-12-38" class="d">-			return;
</a><a href="#h2-12-39" id="h2-12-39" class="d">-		/* MOUSE_MOTION: no reporting if no button is pressed */
</a><a href="#h2-12-40" id="h2-12-40" class="d">-		if (IS_SET(MODE_MOUSEMOTION) &amp;&amp; oldbutton == 3)
</a><a href="#h2-12-41" id="h2-12-41" class="d">-			return;
</a><a href="#h2-12-42" id="h2-12-42" class="d">-
</a><a href="#h2-12-43" id="h2-12-43" class="d">-		button = oldbutton + 32;
</a><a href="#h2-12-44" id="h2-12-44" class="d">-		ox = x;
</a><a href="#h2-12-45" id="h2-12-45" class="d">-		oy = y;
</a><a href="#h2-12-46" id="h2-12-46" class="d">-	} else {
</a><a href="#h2-12-47" id="h2-12-47" class="d">-		if (!IS_SET(MODE_MOUSESGR) &amp;&amp; e-&gt;xbutton.type == ButtonRelease) {
</a><a href="#h2-12-48" id="h2-12-48" class="d">-			button = 3;
</a><a href="#h2-12-49" id="h2-12-49" class="d">-		} else {
</a><a href="#h2-12-50" id="h2-12-50" class="d">-			button -= Button1;
</a><a href="#h2-12-51" id="h2-12-51" class="d">-			if (button &gt;= 3)
</a><a href="#h2-12-52" id="h2-12-52" class="d">-				button += 64 - 3;
</a><a href="#h2-12-53" id="h2-12-53" class="d">-		}
</a><a href="#h2-12-54" id="h2-12-54" class="d">-		if (e-&gt;xbutton.type == ButtonPress) {
</a><a href="#h2-12-55" id="h2-12-55" class="d">-			oldbutton = button;
</a><a href="#h2-12-56" id="h2-12-56" class="d">-			ox = x;
</a><a href="#h2-12-57" id="h2-12-57" class="d">-			oy = y;
</a><a href="#h2-12-58" id="h2-12-58" class="d">-		} else if (e-&gt;xbutton.type == ButtonRelease) {
</a><a href="#h2-12-59" id="h2-12-59" class="d">-			oldbutton = 3;
</a><a href="#h2-12-60" id="h2-12-60" class="d">-			/* MODE_MOUSEX10: no button release reporting */
</a><a href="#h2-12-61" id="h2-12-61" class="d">-			if (IS_SET(MODE_MOUSEX10))
</a><a href="#h2-12-62" id="h2-12-62" class="d">-				return;
</a><a href="#h2-12-63" id="h2-12-63" class="d">-			if (button == 64 || button == 65)
</a><a href="#h2-12-64" id="h2-12-64" class="d">-				return;
</a><a href="#h2-12-65" id="h2-12-65" class="d">-		}
</a><a href="#h2-12-66" id="h2-12-66" class="d">-	}
</a><a href="#h2-12-67" id="h2-12-67" class="d">-
</a><a href="#h2-12-68" id="h2-12-68" class="d">-	if (!IS_SET(MODE_MOUSEX10)) {
</a><a href="#h2-12-69" id="h2-12-69" class="d">-		button += ((state &amp; ShiftMask  ) ? 4  : 0)
</a><a href="#h2-12-70" id="h2-12-70" class="d">-			+ ((state &amp; Mod4Mask   ) ? 8  : 0)
</a><a href="#h2-12-71" id="h2-12-71" class="d">-			+ ((state &amp; ControlMask) ? 16 : 0);
</a><a href="#h2-12-72" id="h2-12-72" class="d">-	}
</a><a href="#h2-12-73" id="h2-12-73" class="d">-
</a><a href="#h2-12-74" id="h2-12-74" class="d">-	if (IS_SET(MODE_MOUSESGR)) {
</a><a href="#h2-12-75" id="h2-12-75" class="d">-		len = snprintf(buf, sizeof(buf), &quot;\033[&lt;%d;%d;%d%c&quot;,
</a><a href="#h2-12-76" id="h2-12-76" class="d">-				button, x+1, y+1,
</a><a href="#h2-12-77" id="h2-12-77" class="d">-				e-&gt;xbutton.type == ButtonRelease ? &#39;m&#39; : &#39;M&#39;);
</a><a href="#h2-12-78" id="h2-12-78" class="d">-	} else if (x &lt; 223 &amp;&amp; y &lt; 223) {
</a><a href="#h2-12-79" id="h2-12-79" class="d">-		len = snprintf(buf, sizeof(buf), &quot;\033[M%c%c%c&quot;,
</a><a href="#h2-12-80" id="h2-12-80" class="d">-				32+button, 32+x+1, 32+y+1);
</a><a href="#h2-12-81" id="h2-12-81" class="d">-	} else {
</a><a href="#h2-12-82" id="h2-12-82" class="d">-		return;
</a><a href="#h2-12-83" id="h2-12-83" class="d">-	}
</a><a href="#h2-12-84" id="h2-12-84" class="d">-
</a><a href="#h2-12-85" id="h2-12-85" class="d">-	ttywrite(buf, len);
</a><a href="#h2-12-86" id="h2-12-86" class="d">-}
</a><a href="#h2-12-87" id="h2-12-87" class="d">-
</a><a href="#h2-12-88" id="h2-12-88" class="d">-void
</a><a href="#h2-12-89" id="h2-12-89" class="d">-bpress(XEvent *e)
</a><a href="#h2-12-90" id="h2-12-90" class="d">-{
</a><a href="#h2-12-91" id="h2-12-91" class="d">-	struct timespec now;
</a><a href="#h2-12-92" id="h2-12-92" class="d">-	MouseShortcut *ms;
</a><a href="#h2-12-93" id="h2-12-93" class="d">-
</a><a href="#h2-12-94" id="h2-12-94" class="d">-	if (IS_SET(MODE_MOUSE) &amp;&amp; !(e-&gt;xbutton.state &amp; forceselmod)) {
</a><a href="#h2-12-95" id="h2-12-95" class="d">-		mousereport(e);
</a><a href="#h2-12-96" id="h2-12-96" class="d">-		return;
</a><a href="#h2-12-97" id="h2-12-97" class="d">-	}
</a><a href="#h2-12-98" id="h2-12-98" class="d">-
</a><a href="#h2-12-99" id="h2-12-99" class="d">-	for (ms = mshortcuts; ms &lt; mshortcuts + LEN(mshortcuts); ms++) {
</a><a href="#h2-12-100" id="h2-12-100" class="d">-		if (e-&gt;xbutton.button == ms-&gt;b
</a><a href="#h2-12-101" id="h2-12-101" class="d">-				&amp;&amp; match(ms-&gt;mask, e-&gt;xbutton.state)) {
</a><a href="#h2-12-102" id="h2-12-102" class="d">-			ttysend(ms-&gt;s, strlen(ms-&gt;s));
</a><a href="#h2-12-103" id="h2-12-103" class="d">-			return;
</a><a href="#h2-12-104" id="h2-12-104" class="d">-		}
</a><a href="#h2-12-105" id="h2-12-105" class="d">-	}
</a><a href="#h2-12-106" id="h2-12-106" class="d">-
</a><a href="#h2-12-107" id="h2-12-107" class="d">-	if (e-&gt;xbutton.button == Button1) {
</a><a href="#h2-12-108" id="h2-12-108" class="d">-		clock_gettime(CLOCK_MONOTONIC, &amp;now);
</a><a href="#h2-12-109" id="h2-12-109" class="d">-
</a><a href="#h2-12-110" id="h2-12-110" class="d">-		/* Clear previous selection, logically and visually. */
</a><a href="#h2-12-111" id="h2-12-111" class="d">-		selclear(NULL);
</a><a href="#h2-12-112" id="h2-12-112" class="d">-		sel.mode = SEL_EMPTY;
</a><a href="#h2-12-113" id="h2-12-113" class="d">-		sel.type = SEL_REGULAR;
</a><a href="#h2-12-114" id="h2-12-114" class="d">-		sel.oe.x = sel.ob.x = x2col(e-&gt;xbutton.x);
</a><a href="#h2-12-115" id="h2-12-115" class="d">-		sel.oe.y = sel.ob.y = y2row(e-&gt;xbutton.y);
</a><a href="#h2-12-116" id="h2-12-116" class="d">-
</a><a href="#h2-12-117" id="h2-12-117" class="d">-		/*
</a><a href="#h2-12-118" id="h2-12-118" class="d">-		 * If the user clicks below predefined timeouts specific
</a><a href="#h2-12-119" id="h2-12-119" class="d">-		 * snapping behaviour is exposed.
</a><a href="#h2-12-120" id="h2-12-120" class="d">-		 */
</a><a href="#h2-12-121" id="h2-12-121" class="d">-		if (TIMEDIFF(now, sel.tclick2) &lt;= tripleclicktimeout) {
</a><a href="#h2-12-122" id="h2-12-122" class="d">-			sel.snap = SNAP_LINE;
</a><a href="#h2-12-123" id="h2-12-123" class="d">-		} else if (TIMEDIFF(now, sel.tclick1) &lt;= doubleclicktimeout) {
</a><a href="#h2-12-124" id="h2-12-124" class="d">-			sel.snap = SNAP_WORD;
</a><a href="#h2-12-125" id="h2-12-125" class="d">-		} else {
</a><a href="#h2-12-126" id="h2-12-126" class="d">-			sel.snap = 0;
</a><a href="#h2-12-127" id="h2-12-127" class="d">-		}
</a><a href="#h2-12-128" id="h2-12-128" class="d">-		selnormalize();
</a><a href="#h2-12-129" id="h2-12-129" class="d">-
</a><a href="#h2-12-130" id="h2-12-130" class="d">-		if (sel.snap != 0)
</a><a href="#h2-12-131" id="h2-12-131" class="d">-			sel.mode = SEL_READY;
</a><a href="#h2-12-132" id="h2-12-132" class="d">-		tsetdirt(sel.nb.y, sel.ne.y);
</a><a href="#h2-12-133" id="h2-12-133" class="d">-		sel.tclick2 = sel.tclick1;
</a><a href="#h2-12-134" id="h2-12-134" class="d">-		sel.tclick1 = now;
</a><a href="#h2-12-135" id="h2-12-135" class="d">-	}
</a><a href="#h2-12-136" id="h2-12-136" class="d">-}
</a><a href="#h2-12-137" id="h2-12-137" class="d">-
</a> char *
 getsel(void)
 {
<a href="#h2-13" id="h2-13" class="h">@@ -1057,148 +584,25 @@ getsel(void)
</a> }
 
 void
<a href="#h2-13-3" id="h2-13-3" class="d">-selcopy(Time t)
</a><a href="#h2-13-4" id="h2-13-4" class="d">-{
</a><a href="#h2-13-5" id="h2-13-5" class="d">-	xsetsel(getsel(), t);
</a><a href="#h2-13-6" id="h2-13-6" class="d">-}
</a><a href="#h2-13-7" id="h2-13-7" class="d">-
</a><a href="#h2-13-8" id="h2-13-8" class="d">-void
</a><a href="#h2-13-9" id="h2-13-9" class="d">-propnotify(XEvent *e)
</a><a href="#h2-13-10" id="h2-13-10" class="d">-{
</a><a href="#h2-13-11" id="h2-13-11" class="d">-	XPropertyEvent *xpev;
</a><a href="#h2-13-12" id="h2-13-12" class="d">-	Atom clipboard = XInternAtom(xw.dpy, &quot;CLIPBOARD&quot;, 0);
</a><a href="#h2-13-13" id="h2-13-13" class="d">-
</a><a href="#h2-13-14" id="h2-13-14" class="d">-	xpev = &amp;e-&gt;xproperty;
</a><a href="#h2-13-15" id="h2-13-15" class="d">-	if (xpev-&gt;state == PropertyNewValue &amp;&amp;
</a><a href="#h2-13-16" id="h2-13-16" class="d">-			(xpev-&gt;atom == XA_PRIMARY ||
</a><a href="#h2-13-17" id="h2-13-17" class="d">-			 xpev-&gt;atom == clipboard)) {
</a><a href="#h2-13-18" id="h2-13-18" class="d">-		selnotify(e);
</a><a href="#h2-13-19" id="h2-13-19" class="d">-	}
</a><a href="#h2-13-20" id="h2-13-20" class="d">-}
</a><a href="#h2-13-21" id="h2-13-21" class="d">-
</a><a href="#h2-13-22" id="h2-13-22" class="d">-void
</a><a href="#h2-13-23" id="h2-13-23" class="d">-selnotify(XEvent *e)
</a><a href="#h2-13-24" id="h2-13-24" class="d">-{
</a><a href="#h2-13-25" id="h2-13-25" class="d">-	ulong nitems, ofs, rem;
</a><a href="#h2-13-26" id="h2-13-26" class="d">-	int format;
</a><a href="#h2-13-27" id="h2-13-27" class="d">-	uchar *data, *last, *repl;
</a><a href="#h2-13-28" id="h2-13-28" class="d">-	Atom type, incratom, property;
</a><a href="#h2-13-29" id="h2-13-29" class="d">-
</a><a href="#h2-13-30" id="h2-13-30" class="d">-	incratom = XInternAtom(xw.dpy, &quot;INCR&quot;, 0);
</a><a href="#h2-13-31" id="h2-13-31" class="d">-
</a><a href="#h2-13-32" id="h2-13-32" class="d">-	ofs = 0;
</a><a href="#h2-13-33" id="h2-13-33" class="d">-	if (e-&gt;type == SelectionNotify) {
</a><a href="#h2-13-34" id="h2-13-34" class="d">-		property = e-&gt;xselection.property;
</a><a href="#h2-13-35" id="h2-13-35" class="d">-	} else if(e-&gt;type == PropertyNotify) {
</a><a href="#h2-13-36" id="h2-13-36" class="d">-		property = e-&gt;xproperty.atom;
</a><a href="#h2-13-37" id="h2-13-37" class="d">-	} else {
</a><a href="#h2-13-38" id="h2-13-38" class="d">-		return;
</a><a href="#h2-13-39" id="h2-13-39" class="d">-	}
</a><a href="#h2-13-40" id="h2-13-40" class="d">-	if (property == None)
</a><a href="#h2-13-41" id="h2-13-41" class="d">-		return;
</a><a href="#h2-13-42" id="h2-13-42" class="d">-
</a><a href="#h2-13-43" id="h2-13-43" class="d">-	do {
</a><a href="#h2-13-44" id="h2-13-44" class="d">-		if (XGetWindowProperty(xw.dpy, xw.win, property, ofs,
</a><a href="#h2-13-45" id="h2-13-45" class="d">-					BUFSIZ/4, False, AnyPropertyType,
</a><a href="#h2-13-46" id="h2-13-46" class="d">-					&amp;type, &amp;format, &amp;nitems, &amp;rem,
</a><a href="#h2-13-47" id="h2-13-47" class="d">-					&amp;data)) {
</a><a href="#h2-13-48" id="h2-13-48" class="d">-			fprintf(stderr, &quot;Clipboard allocation failed\n&quot;);
</a><a href="#h2-13-49" id="h2-13-49" class="d">-			return;
</a><a href="#h2-13-50" id="h2-13-50" class="d">-		}
</a><a href="#h2-13-51" id="h2-13-51" class="d">-
</a><a href="#h2-13-52" id="h2-13-52" class="d">-		if (e-&gt;type == PropertyNotify &amp;&amp; nitems == 0 &amp;&amp; rem == 0) {
</a><a href="#h2-13-53" id="h2-13-53" class="d">-			/*
</a><a href="#h2-13-54" id="h2-13-54" class="d">-			 * If there is some PropertyNotify with no data, then
</a><a href="#h2-13-55" id="h2-13-55" class="d">-			 * this is the signal of the selection owner that all
</a><a href="#h2-13-56" id="h2-13-56" class="d">-			 * data has been transferred. We won&#39;t need to receive
</a><a href="#h2-13-57" id="h2-13-57" class="d">-			 * PropertyNotify events anymore.
</a><a href="#h2-13-58" id="h2-13-58" class="d">-			 */
</a><a href="#h2-13-59" id="h2-13-59" class="d">-			MODBIT(xw.attrs.event_mask, 0, PropertyChangeMask);
</a><a href="#h2-13-60" id="h2-13-60" class="d">-			XChangeWindowAttributes(xw.dpy, xw.win, CWEventMask,
</a><a href="#h2-13-61" id="h2-13-61" class="d">-					&amp;xw.attrs);
</a><a href="#h2-13-62" id="h2-13-62" class="d">-		}
</a><a href="#h2-13-63" id="h2-13-63" class="d">-
</a><a href="#h2-13-64" id="h2-13-64" class="d">-		if (type == incratom) {
</a><a href="#h2-13-65" id="h2-13-65" class="d">-			/*
</a><a href="#h2-13-66" id="h2-13-66" class="d">-			 * Activate the PropertyNotify events so we receive
</a><a href="#h2-13-67" id="h2-13-67" class="d">-			 * when the selection owner does send us the next
</a><a href="#h2-13-68" id="h2-13-68" class="d">-			 * chunk of data.
</a><a href="#h2-13-69" id="h2-13-69" class="d">-			 */
</a><a href="#h2-13-70" id="h2-13-70" class="d">-			MODBIT(xw.attrs.event_mask, 1, PropertyChangeMask);
</a><a href="#h2-13-71" id="h2-13-71" class="d">-			XChangeWindowAttributes(xw.dpy, xw.win, CWEventMask,
</a><a href="#h2-13-72" id="h2-13-72" class="d">-					&amp;xw.attrs);
</a><a href="#h2-13-73" id="h2-13-73" class="d">-
</a><a href="#h2-13-74" id="h2-13-74" class="d">-			/*
</a><a href="#h2-13-75" id="h2-13-75" class="d">-			 * Deleting the property is the transfer start signal.
</a><a href="#h2-13-76" id="h2-13-76" class="d">-			 */
</a><a href="#h2-13-77" id="h2-13-77" class="d">-			XDeleteProperty(xw.dpy, xw.win, (int)property);
</a><a href="#h2-13-78" id="h2-13-78" class="d">-			continue;
</a><a href="#h2-13-79" id="h2-13-79" class="d">-		}
</a><a href="#h2-13-80" id="h2-13-80" class="d">-
</a><a href="#h2-13-81" id="h2-13-81" class="d">-		/*
</a><a href="#h2-13-82" id="h2-13-82" class="d">-		 * As seen in getsel:
</a><a href="#h2-13-83" id="h2-13-83" class="d">-		 * Line endings are inconsistent in the terminal and GUI world
</a><a href="#h2-13-84" id="h2-13-84" class="d">-		 * copy and pasting. When receiving some selection data,
</a><a href="#h2-13-85" id="h2-13-85" class="d">-		 * replace all &#39;\n&#39; with &#39;\r&#39;.
</a><a href="#h2-13-86" id="h2-13-86" class="d">-		 * FIXME: Fix the computer world.
</a><a href="#h2-13-87" id="h2-13-87" class="d">-		 */
</a><a href="#h2-13-88" id="h2-13-88" class="d">-		repl = data;
</a><a href="#h2-13-89" id="h2-13-89" class="d">-		last = data + nitems * format / 8;
</a><a href="#h2-13-90" id="h2-13-90" class="d">-		while ((repl = memchr(repl, &#39;\n&#39;, last - repl))) {
</a><a href="#h2-13-91" id="h2-13-91" class="d">-			*repl++ = &#39;\r&#39;;
</a><a href="#h2-13-92" id="h2-13-92" class="d">-		}
</a><a href="#h2-13-93" id="h2-13-93" class="d">-
</a><a href="#h2-13-94" id="h2-13-94" class="d">-		if (IS_SET(MODE_BRCKTPASTE) &amp;&amp; ofs == 0)
</a><a href="#h2-13-95" id="h2-13-95" class="d">-			ttywrite(&quot;\033[200~&quot;, 6);
</a><a href="#h2-13-96" id="h2-13-96" class="d">-		ttysend((char *)data, nitems * format / 8);
</a><a href="#h2-13-97" id="h2-13-97" class="d">-		if (IS_SET(MODE_BRCKTPASTE) &amp;&amp; rem == 0)
</a><a href="#h2-13-98" id="h2-13-98" class="d">-			ttywrite(&quot;\033[201~&quot;, 6);
</a><a href="#h2-13-99" id="h2-13-99" class="d">-		XFree(data);
</a><a href="#h2-13-100" id="h2-13-100" class="d">-		/* number of 32-bit chunks returned */
</a><a href="#h2-13-101" id="h2-13-101" class="d">-		ofs += nitems * format / 32;
</a><a href="#h2-13-102" id="h2-13-102" class="d">-	} while (rem &gt; 0);
</a><a href="#h2-13-103" id="h2-13-103" class="d">-
</a><a href="#h2-13-104" id="h2-13-104" class="d">-	/*
</a><a href="#h2-13-105" id="h2-13-105" class="d">-	 * Deleting the property again tells the selection owner to send the
</a><a href="#h2-13-106" id="h2-13-106" class="d">-	 * next data chunk in the property.
</a><a href="#h2-13-107" id="h2-13-107" class="d">-	 */
</a><a href="#h2-13-108" id="h2-13-108" class="d">-	XDeleteProperty(xw.dpy, xw.win, (int)property);
</a><a href="#h2-13-109" id="h2-13-109" class="d">-}
</a><a href="#h2-13-110" id="h2-13-110" class="d">-
</a><a href="#h2-13-111" id="h2-13-111" class="d">-void
</a> selpaste(const Arg *dummy)
 {
<a href="#h2-13-114" id="h2-13-114" class="d">-	XConvertSelection(xw.dpy, XA_PRIMARY, sel.xtarget, XA_PRIMARY,
</a><a href="#h2-13-115" id="h2-13-115" class="d">-			xw.win, CurrentTime);
</a><a href="#h2-13-116" id="h2-13-116" class="i">+	xselpaste();
</a> }
 
 void
 clipcopy(const Arg *dummy)
 {
<a href="#h2-13-122" id="h2-13-122" class="d">-	Atom clipboard;
</a><a href="#h2-13-123" id="h2-13-123" class="d">-
</a><a href="#h2-13-124" id="h2-13-124" class="d">-	if (sel.clipboard != NULL)
</a><a href="#h2-13-125" id="h2-13-125" class="d">-		free(sel.clipboard);
</a><a href="#h2-13-126" id="h2-13-126" class="d">-
</a><a href="#h2-13-127" id="h2-13-127" class="d">-	if (sel.primary != NULL) {
</a><a href="#h2-13-128" id="h2-13-128" class="d">-		sel.clipboard = xstrdup(sel.primary);
</a><a href="#h2-13-129" id="h2-13-129" class="d">-		clipboard = XInternAtom(xw.dpy, &quot;CLIPBOARD&quot;, 0);
</a><a href="#h2-13-130" id="h2-13-130" class="d">-		XSetSelectionOwner(xw.dpy, clipboard, xw.win, CurrentTime);
</a><a href="#h2-13-131" id="h2-13-131" class="d">-	}
</a><a href="#h2-13-132" id="h2-13-132" class="i">+	xclipcopy();
</a> }
 
 void
 clippaste(const Arg *dummy)
 {
<a href="#h2-13-138" id="h2-13-138" class="d">-	Atom clipboard;
</a><a href="#h2-13-139" id="h2-13-139" class="d">-
</a><a href="#h2-13-140" id="h2-13-140" class="d">-	clipboard = XInternAtom(xw.dpy, &quot;CLIPBOARD&quot;, 0);
</a><a href="#h2-13-141" id="h2-13-141" class="d">-	XConvertSelection(xw.dpy, clipboard, sel.xtarget, clipboard,
</a><a href="#h2-13-142" id="h2-13-142" class="d">-			xw.win, CurrentTime);
</a><a href="#h2-13-143" id="h2-13-143" class="i">+	xclippaste();
</a> }
 
 void
<a href="#h2-13-147" id="h2-13-147" class="d">-selclear(XEvent *e)
</a><a href="#h2-13-148" id="h2-13-148" class="i">+selclear(void)
</a> {
 	if (sel.ob.x == -1)
 		return;
<a href="#h2-14" id="h2-14" class="h">@@ -1208,120 +612,6 @@ selclear(XEvent *e)
</a> }
 
 void
<a href="#h2-14-3" id="h2-14-3" class="d">-selrequest(XEvent *e)
</a><a href="#h2-14-4" id="h2-14-4" class="d">-{
</a><a href="#h2-14-5" id="h2-14-5" class="d">-	XSelectionRequestEvent *xsre;
</a><a href="#h2-14-6" id="h2-14-6" class="d">-	XSelectionEvent xev;
</a><a href="#h2-14-7" id="h2-14-7" class="d">-	Atom xa_targets, string, clipboard;
</a><a href="#h2-14-8" id="h2-14-8" class="d">-	char *seltext;
</a><a href="#h2-14-9" id="h2-14-9" class="d">-
</a><a href="#h2-14-10" id="h2-14-10" class="d">-	xsre = (XSelectionRequestEvent *) e;
</a><a href="#h2-14-11" id="h2-14-11" class="d">-	xev.type = SelectionNotify;
</a><a href="#h2-14-12" id="h2-14-12" class="d">-	xev.requestor = xsre-&gt;requestor;
</a><a href="#h2-14-13" id="h2-14-13" class="d">-	xev.selection = xsre-&gt;selection;
</a><a href="#h2-14-14" id="h2-14-14" class="d">-	xev.target = xsre-&gt;target;
</a><a href="#h2-14-15" id="h2-14-15" class="d">-	xev.time = xsre-&gt;time;
</a><a href="#h2-14-16" id="h2-14-16" class="d">-	if (xsre-&gt;property == None)
</a><a href="#h2-14-17" id="h2-14-17" class="d">-		xsre-&gt;property = xsre-&gt;target;
</a><a href="#h2-14-18" id="h2-14-18" class="d">-
</a><a href="#h2-14-19" id="h2-14-19" class="d">-	/* reject */
</a><a href="#h2-14-20" id="h2-14-20" class="d">-	xev.property = None;
</a><a href="#h2-14-21" id="h2-14-21" class="d">-
</a><a href="#h2-14-22" id="h2-14-22" class="d">-	xa_targets = XInternAtom(xw.dpy, &quot;TARGETS&quot;, 0);
</a><a href="#h2-14-23" id="h2-14-23" class="d">-	if (xsre-&gt;target == xa_targets) {
</a><a href="#h2-14-24" id="h2-14-24" class="d">-		/* respond with the supported type */
</a><a href="#h2-14-25" id="h2-14-25" class="d">-		string = sel.xtarget;
</a><a href="#h2-14-26" id="h2-14-26" class="d">-		XChangeProperty(xsre-&gt;display, xsre-&gt;requestor, xsre-&gt;property,
</a><a href="#h2-14-27" id="h2-14-27" class="d">-				XA_ATOM, 32, PropModeReplace,
</a><a href="#h2-14-28" id="h2-14-28" class="d">-				(uchar *) &amp;string, 1);
</a><a href="#h2-14-29" id="h2-14-29" class="d">-		xev.property = xsre-&gt;property;
</a><a href="#h2-14-30" id="h2-14-30" class="d">-	} else if (xsre-&gt;target == sel.xtarget || xsre-&gt;target == XA_STRING) {
</a><a href="#h2-14-31" id="h2-14-31" class="d">-		/*
</a><a href="#h2-14-32" id="h2-14-32" class="d">-		 * xith XA_STRING non ascii characters may be incorrect in the
</a><a href="#h2-14-33" id="h2-14-33" class="d">-		 * requestor. It is not our problem, use utf8.
</a><a href="#h2-14-34" id="h2-14-34" class="d">-		 */
</a><a href="#h2-14-35" id="h2-14-35" class="d">-		clipboard = XInternAtom(xw.dpy, &quot;CLIPBOARD&quot;, 0);
</a><a href="#h2-14-36" id="h2-14-36" class="d">-		if (xsre-&gt;selection == XA_PRIMARY) {
</a><a href="#h2-14-37" id="h2-14-37" class="d">-			seltext = sel.primary;
</a><a href="#h2-14-38" id="h2-14-38" class="d">-		} else if (xsre-&gt;selection == clipboard) {
</a><a href="#h2-14-39" id="h2-14-39" class="d">-			seltext = sel.clipboard;
</a><a href="#h2-14-40" id="h2-14-40" class="d">-		} else {
</a><a href="#h2-14-41" id="h2-14-41" class="d">-			fprintf(stderr,
</a><a href="#h2-14-42" id="h2-14-42" class="d">-				&quot;Unhandled clipboard selection 0x%lx\n&quot;,
</a><a href="#h2-14-43" id="h2-14-43" class="d">-				xsre-&gt;selection);
</a><a href="#h2-14-44" id="h2-14-44" class="d">-			return;
</a><a href="#h2-14-45" id="h2-14-45" class="d">-		}
</a><a href="#h2-14-46" id="h2-14-46" class="d">-		if (seltext != NULL) {
</a><a href="#h2-14-47" id="h2-14-47" class="d">-			XChangeProperty(xsre-&gt;display, xsre-&gt;requestor,
</a><a href="#h2-14-48" id="h2-14-48" class="d">-					xsre-&gt;property, xsre-&gt;target,
</a><a href="#h2-14-49" id="h2-14-49" class="d">-					8, PropModeReplace,
</a><a href="#h2-14-50" id="h2-14-50" class="d">-					(uchar *)seltext, strlen(seltext));
</a><a href="#h2-14-51" id="h2-14-51" class="d">-			xev.property = xsre-&gt;property;
</a><a href="#h2-14-52" id="h2-14-52" class="d">-		}
</a><a href="#h2-14-53" id="h2-14-53" class="d">-	}
</a><a href="#h2-14-54" id="h2-14-54" class="d">-
</a><a href="#h2-14-55" id="h2-14-55" class="d">-	/* all done, send a notification to the listener */
</a><a href="#h2-14-56" id="h2-14-56" class="d">-	if (!XSendEvent(xsre-&gt;display, xsre-&gt;requestor, 1, 0, (XEvent *) &amp;xev))
</a><a href="#h2-14-57" id="h2-14-57" class="d">-		fprintf(stderr, &quot;Error sending SelectionNotify event\n&quot;);
</a><a href="#h2-14-58" id="h2-14-58" class="d">-}
</a><a href="#h2-14-59" id="h2-14-59" class="d">-
</a><a href="#h2-14-60" id="h2-14-60" class="d">-void
</a><a href="#h2-14-61" id="h2-14-61" class="d">-xsetsel(char *str, Time t)
</a><a href="#h2-14-62" id="h2-14-62" class="d">-{
</a><a href="#h2-14-63" id="h2-14-63" class="d">-	free(sel.primary);
</a><a href="#h2-14-64" id="h2-14-64" class="d">-	sel.primary = str;
</a><a href="#h2-14-65" id="h2-14-65" class="d">-
</a><a href="#h2-14-66" id="h2-14-66" class="d">-	XSetSelectionOwner(xw.dpy, XA_PRIMARY, xw.win, t);
</a><a href="#h2-14-67" id="h2-14-67" class="d">-	if (XGetSelectionOwner(xw.dpy, XA_PRIMARY) != xw.win)
</a><a href="#h2-14-68" id="h2-14-68" class="d">-		selclear(0);
</a><a href="#h2-14-69" id="h2-14-69" class="d">-}
</a><a href="#h2-14-70" id="h2-14-70" class="d">-
</a><a href="#h2-14-71" id="h2-14-71" class="d">-void
</a><a href="#h2-14-72" id="h2-14-72" class="d">-brelease(XEvent *e)
</a><a href="#h2-14-73" id="h2-14-73" class="d">-{
</a><a href="#h2-14-74" id="h2-14-74" class="d">-	if (IS_SET(MODE_MOUSE) &amp;&amp; !(e-&gt;xbutton.state &amp; forceselmod)) {
</a><a href="#h2-14-75" id="h2-14-75" class="d">-		mousereport(e);
</a><a href="#h2-14-76" id="h2-14-76" class="d">-		return;
</a><a href="#h2-14-77" id="h2-14-77" class="d">-	}
</a><a href="#h2-14-78" id="h2-14-78" class="d">-
</a><a href="#h2-14-79" id="h2-14-79" class="d">-	if (e-&gt;xbutton.button == Button2) {
</a><a href="#h2-14-80" id="h2-14-80" class="d">-		selpaste(NULL);
</a><a href="#h2-14-81" id="h2-14-81" class="d">-	} else if (e-&gt;xbutton.button == Button1) {
</a><a href="#h2-14-82" id="h2-14-82" class="d">-		if (sel.mode == SEL_READY) {
</a><a href="#h2-14-83" id="h2-14-83" class="d">-			getbuttoninfo(e);
</a><a href="#h2-14-84" id="h2-14-84" class="d">-			selcopy(e-&gt;xbutton.time);
</a><a href="#h2-14-85" id="h2-14-85" class="d">-		} else
</a><a href="#h2-14-86" id="h2-14-86" class="d">-			selclear(NULL);
</a><a href="#h2-14-87" id="h2-14-87" class="d">-		sel.mode = SEL_IDLE;
</a><a href="#h2-14-88" id="h2-14-88" class="d">-		tsetdirt(sel.nb.y, sel.ne.y);
</a><a href="#h2-14-89" id="h2-14-89" class="d">-	}
</a><a href="#h2-14-90" id="h2-14-90" class="d">-}
</a><a href="#h2-14-91" id="h2-14-91" class="d">-
</a><a href="#h2-14-92" id="h2-14-92" class="d">-void
</a><a href="#h2-14-93" id="h2-14-93" class="d">-bmotion(XEvent *e)
</a><a href="#h2-14-94" id="h2-14-94" class="d">-{
</a><a href="#h2-14-95" id="h2-14-95" class="d">-	int oldey, oldex, oldsby, oldsey;
</a><a href="#h2-14-96" id="h2-14-96" class="d">-
</a><a href="#h2-14-97" id="h2-14-97" class="d">-	if (IS_SET(MODE_MOUSE) &amp;&amp; !(e-&gt;xbutton.state &amp; forceselmod)) {
</a><a href="#h2-14-98" id="h2-14-98" class="d">-		mousereport(e);
</a><a href="#h2-14-99" id="h2-14-99" class="d">-		return;
</a><a href="#h2-14-100" id="h2-14-100" class="d">-	}
</a><a href="#h2-14-101" id="h2-14-101" class="d">-
</a><a href="#h2-14-102" id="h2-14-102" class="d">-	if (!sel.mode)
</a><a href="#h2-14-103" id="h2-14-103" class="d">-		return;
</a><a href="#h2-14-104" id="h2-14-104" class="d">-
</a><a href="#h2-14-105" id="h2-14-105" class="d">-	sel.mode = SEL_READY;
</a><a href="#h2-14-106" id="h2-14-106" class="d">-	oldey = sel.oe.y;
</a><a href="#h2-14-107" id="h2-14-107" class="d">-	oldex = sel.oe.x;
</a><a href="#h2-14-108" id="h2-14-108" class="d">-	oldsby = sel.nb.y;
</a><a href="#h2-14-109" id="h2-14-109" class="d">-	oldsey = sel.ne.y;
</a><a href="#h2-14-110" id="h2-14-110" class="d">-	getbuttoninfo(e);
</a><a href="#h2-14-111" id="h2-14-111" class="d">-
</a><a href="#h2-14-112" id="h2-14-112" class="d">-	if (oldey != sel.oe.y || oldex != sel.oe.x)
</a><a href="#h2-14-113" id="h2-14-113" class="d">-		tsetdirt(MIN(sel.nb.y, oldsby), MAX(sel.ne.y, oldsey));
</a><a href="#h2-14-114" id="h2-14-114" class="d">-}
</a><a href="#h2-14-115" id="h2-14-115" class="d">-
</a><a href="#h2-14-116" id="h2-14-116" class="d">-void
</a> die(const char *errstr, ...)
 {
 	va_list ap;
<a href="#h2-15" id="h2-15" class="h">@@ -1337,7 +627,6 @@ execsh(void)
</a> {
 	char **args, *sh, *prog;
 	const struct passwd *pw;
<a href="#h2-15-3" id="h2-15-3" class="d">-	char buf[sizeof(long) * 8 + 1];
</a> 
 	errno = 0;
 	if ((pw = getpwuid(getuid())) == NULL) {
<a href="#h2-16" id="h2-16" class="h">@@ -1358,8 +647,6 @@ execsh(void)
</a> 		prog = sh;
 	args = (opt_cmd) ? opt_cmd : (char *[]) {prog, NULL};
 
<a href="#h2-16-3" id="h2-16-3" class="d">-	snprintf(buf, sizeof(buf), &quot;%lu&quot;, xw.win);
</a><a href="#h2-16-4" id="h2-16-4" class="d">-
</a> 	unsetenv(&quot;COLUMNS&quot;);
 	unsetenv(&quot;LINES&quot;);
 	unsetenv(&quot;TERMCAP&quot;);
<a href="#h2-17" id="h2-17" class="h">@@ -1368,7 +655,7 @@ execsh(void)
</a> 	setenv(&quot;SHELL&quot;, sh, 1);
 	setenv(&quot;HOME&quot;, pw-&gt;pw_dir, 1);
 	setenv(&quot;TERM&quot;, termname, 1);
<a href="#h2-17-3" id="h2-17-3" class="d">-	setenv(&quot;WINDOWID&quot;, buf, 1);
</a><a href="#h2-17-4" id="h2-17-4" class="i">+	xsetenv();
</a> 
 	signal(SIGCHLD, SIG_DFL);
 	signal(SIGHUP, SIG_DFL);
<a href="#h2-18" id="h2-18" class="h">@@ -1606,8 +893,8 @@ ttyresize(void)
</a> 
 	w.ws_row = term.row;
 	w.ws_col = term.col;
<a href="#h2-18-3" id="h2-18-3" class="d">-	w.ws_xpixel = xw.tw;
</a><a href="#h2-18-4" id="h2-18-4" class="d">-	w.ws_ypixel = xw.th;
</a><a href="#h2-18-5" id="h2-18-5" class="i">+	w.ws_xpixel = win.tw;
</a><a href="#h2-18-6" id="h2-18-6" class="i">+	w.ws_ypixel = win.th;
</a> 	if (ioctl(cmdfd, TIOCSWINSZ, &amp;w) &lt; 0)
 		fprintf(stderr, &quot;Couldn&#39;t set window size: %s\n&quot;, strerror(errno));
 }
<a href="#h2-19" id="h2-19" class="h">@@ -1771,7 +1058,7 @@ selscroll(int orig, int n)
</a> 
 	if (BETWEEN(sel.ob.y, orig, term.bot) || BETWEEN(sel.oe.y, orig, term.bot)) {
 		if ((sel.ob.y += n) &gt; term.bot || (sel.oe.y += n) &lt; term.top) {
<a href="#h2-19-3" id="h2-19-3" class="d">-			selclear(NULL);
</a><a href="#h2-19-4" id="h2-19-4" class="i">+			selclear();
</a> 			return;
 		}
 		if (sel.type == SEL_RECTANGULAR) {
<a href="#h2-20" id="h2-20" class="h">@@ -1917,7 +1204,7 @@ tclearregion(int x1, int y1, int x2, int y2)
</a> 		for (x = x1; x &lt;= x2; x++) {
 			gp = &amp;term.line[y][x];
 			if (selected(x, y))
<a href="#h2-20-3" id="h2-20-3" class="d">-				selclear(NULL);
</a><a href="#h2-20-4" id="h2-20-4" class="i">+				selclear();
</a> 			gp-&gt;fg = term.c.attr.fg;
 			gp-&gt;bg = term.c.attr.bg;
 			gp-&gt;mode = 0;
<a href="#h2-21" id="h2-21" class="h">@@ -2368,7 +1655,7 @@ csihandle(void)
</a> 		tputtab(csiescseq.arg[0]);
 		break;
 	case &#39;J&#39;: /* ED -- Clear screen */
<a href="#h2-21-3" id="h2-21-3" class="d">-		selclear(NULL);
</a><a href="#h2-21-4" id="h2-21-4" class="i">+		selclear();
</a> 		switch (csiescseq.arg[0]) {
 		case 0: /* below */
 			tclearregion(term.c.x, term.c.y, term.col-1, term.c.y);
<a href="#h2-22" id="h2-22" class="h">@@ -2475,7 +1762,7 @@ csihandle(void)
</a> 			if (!BETWEEN(csiescseq.arg[0], 0, 6)) {
 				goto unknown;
 			}
<a href="#h2-22-3" id="h2-22-3" class="d">-			xw.cursor = csiescseq.arg[0];
</a><a href="#h2-22-4" id="h2-22-4" class="i">+			win.cursor = csiescseq.arg[0];
</a> 			break;
 		default:
 			goto unknown;
<a href="#h2-23" id="h2-23" class="h">@@ -2642,12 +1929,13 @@ tprinter(char *s, size_t len)
</a> void
 iso14755(const Arg *arg)
 {
<a href="#h2-23-3" id="h2-23-3" class="d">-	char cmd[sizeof(ISO14755CMD) + NUMMAXLEN(xw.win)];
</a><a href="#h2-23-4" id="h2-23-4" class="i">+	unsigned long id = xwinid();
</a><a href="#h2-23-5" id="h2-23-5" class="i">+	char cmd[sizeof(ISO14755CMD) + NUMMAXLEN(id)];
</a> 	FILE *p;
 	char *us, *e, codepoint[9], uc[UTF_SIZ];
 	unsigned long utf32;
 
<a href="#h2-23-10" id="h2-23-10" class="d">-	snprintf(cmd, sizeof(cmd), ISO14755CMD, xw.win);
</a><a href="#h2-23-11" id="h2-23-11" class="i">+	snprintf(cmd, sizeof(cmd), ISO14755CMD, id);
</a> 	if (!(p = popen(cmd, &quot;r&quot;)))
 		return;
 
<a href="#h2-24" id="h2-24" class="h">@@ -2833,10 +2121,10 @@ tcontrolcode(uchar ascii)
</a> 			/* backwards compatibility to xterm */
 			strhandle();
 		} else {
<a href="#h2-24-3" id="h2-24-3" class="d">-			if (!(xw.state &amp; WIN_FOCUSED))
</a><a href="#h2-24-4" id="h2-24-4" class="i">+			if (!(win.state &amp; WIN_FOCUSED))
</a> 				xseturgency(1);
 			if (bellvolume)
<a href="#h2-24-7" id="h2-24-7" class="d">-				XkbBell(xw.dpy, xw.win, bellvolume, (Atom)NULL);
</a><a href="#h2-24-8" id="h2-24-8" class="i">+				xbell(bellvolume);
</a> 		}
 		break;
 	case &#39;\033&#39;: /* ESC */
<a href="#h2-25" id="h2-25" class="h">@@ -2968,7 +2256,7 @@ eschandle(uchar ascii)
</a> 		break;
 	case &#39;c&#39;: /* RIS -- Reset to inital state */
 		treset();
<a href="#h2-25-3" id="h2-25-3" class="d">-		xresettitle();
</a><a href="#h2-25-4" id="h2-25-4" class="i">+		resettitle();
</a> 		xloadcols();
 		break;
 	case &#39;=&#39;: /* DECPAM -- Application keypad */
<a href="#h2-26" id="h2-26" class="h">@@ -3109,7 +2397,7 @@ check_control_code:
</a> 		return;
 	}
 	if (sel.ob.x != -1 &amp;&amp; BETWEEN(term.c.y, sel.ob.y, sel.oe.y))
<a href="#h2-26-3" id="h2-26-3" class="d">-		selclear(NULL);
</a><a href="#h2-26-4" id="h2-26-4" class="i">+		selclear();
</a> 
 	gp = &amp;term.line[term.c.y][term.c.x];
 	if (IS_SET(MODE_WRAP) &amp;&amp; (term.c.state &amp; CURSOR_WRAPNEXT)) {
<a href="#h2-27" id="h2-27" class="h">@@ -3177,7 +2465,7 @@ tresize(int col, int row)
</a> 	}
 
 	/* resize to new width */
<a href="#h2-27-3" id="h2-27-3" class="d">-	term.specbuf = xrealloc(term.specbuf, col * sizeof(XftGlyphFontSpec));
</a><a href="#h2-27-4" id="h2-27-4" class="i">+	term.specbuf = xrealloc(term.specbuf, col * sizeof(GlyphFontSpec));
</a> 
 	/* resize to new height */
 	term.line = xrealloc(term.line, row * sizeof(Line));
<a href="#h2-28" id="h2-28" class="h">@@ -3228,993 +2516,66 @@ tresize(int col, int row)
</a> }
 
 void
<a href="#h2-28-3" id="h2-28-3" class="d">-xresize(int col, int row)
</a><a href="#h2-28-4" id="h2-28-4" class="i">+zoom(const Arg *arg)
</a> {
<a href="#h2-28-6" id="h2-28-6" class="d">-	xw.tw = MAX(1, col * xw.cw);
</a><a href="#h2-28-7" id="h2-28-7" class="d">-	xw.th = MAX(1, row * xw.ch);
</a><a href="#h2-28-8" id="h2-28-8" class="d">-
</a><a href="#h2-28-9" id="h2-28-9" class="d">-	XFreePixmap(xw.dpy, xw.buf);
</a><a href="#h2-28-10" id="h2-28-10" class="d">-	xw.buf = XCreatePixmap(xw.dpy, xw.win, xw.w, xw.h,
</a><a href="#h2-28-11" id="h2-28-11" class="d">-			DefaultDepth(xw.dpy, xw.scr));
</a><a href="#h2-28-12" id="h2-28-12" class="d">-	XftDrawChange(xw.draw, xw.buf);
</a><a href="#h2-28-13" id="h2-28-13" class="d">-	xclear(0, 0, xw.w, xw.h);
</a><a href="#h2-28-14" id="h2-28-14" class="d">-}
</a><a href="#h2-28-15" id="h2-28-15" class="i">+	Arg larg;
</a> 
<a href="#h2-28-17" id="h2-28-17" class="d">-ushort
</a><a href="#h2-28-18" id="h2-28-18" class="d">-sixd_to_16bit(int x)
</a><a href="#h2-28-19" id="h2-28-19" class="d">-{
</a><a href="#h2-28-20" id="h2-28-20" class="d">-	return x == 0 ? 0 : 0x3737 + 0x2828 * x;
</a><a href="#h2-28-21" id="h2-28-21" class="i">+	larg.f = usedfontsize + arg-&gt;f;
</a><a href="#h2-28-22" id="h2-28-22" class="i">+	zoomabs(&amp;larg);
</a> }
 
<a href="#h2-28-25" id="h2-28-25" class="d">-int
</a><a href="#h2-28-26" id="h2-28-26" class="d">-xloadcolor(int i, const char *name, Color *ncolor)
</a><a href="#h2-28-27" id="h2-28-27" class="i">+void
</a><a href="#h2-28-28" id="h2-28-28" class="i">+zoomabs(const Arg *arg)
</a> {
<a href="#h2-28-30" id="h2-28-30" class="d">-	XRenderColor color = { .alpha = 0xffff };
</a><a href="#h2-28-31" id="h2-28-31" class="d">-
</a><a href="#h2-28-32" id="h2-28-32" class="d">-	if (!name) {
</a><a href="#h2-28-33" id="h2-28-33" class="d">-		if (BETWEEN(i, 16, 255)) { /* 256 color */
</a><a href="#h2-28-34" id="h2-28-34" class="d">-			if (i &lt; 6*6*6+16) { /* same colors as xterm */
</a><a href="#h2-28-35" id="h2-28-35" class="d">-				color.red   = sixd_to_16bit( ((i-16)/36)%6 );
</a><a href="#h2-28-36" id="h2-28-36" class="d">-				color.green = sixd_to_16bit( ((i-16)/6) %6 );
</a><a href="#h2-28-37" id="h2-28-37" class="d">-				color.blue  = sixd_to_16bit( ((i-16)/1) %6 );
</a><a href="#h2-28-38" id="h2-28-38" class="d">-			} else { /* greyscale */
</a><a href="#h2-28-39" id="h2-28-39" class="d">-				color.red = 0x0808 + 0x0a0a * (i - (6*6*6+16));
</a><a href="#h2-28-40" id="h2-28-40" class="d">-				color.green = color.blue = color.red;
</a><a href="#h2-28-41" id="h2-28-41" class="d">-			}
</a><a href="#h2-28-42" id="h2-28-42" class="d">-			return XftColorAllocValue(xw.dpy, xw.vis,
</a><a href="#h2-28-43" id="h2-28-43" class="d">-			                          xw.cmap, &amp;color, ncolor);
</a><a href="#h2-28-44" id="h2-28-44" class="d">-		} else
</a><a href="#h2-28-45" id="h2-28-45" class="d">-			name = colorname[i];
</a><a href="#h2-28-46" id="h2-28-46" class="d">-	}
</a><a href="#h2-28-47" id="h2-28-47" class="d">-
</a><a href="#h2-28-48" id="h2-28-48" class="d">-	return XftColorAllocName(xw.dpy, xw.vis, xw.cmap, name, ncolor);
</a><a href="#h2-28-49" id="h2-28-49" class="i">+	xunloadfonts();
</a><a href="#h2-28-50" id="h2-28-50" class="i">+	xloadfonts(usedfont, arg-&gt;f);
</a><a href="#h2-28-51" id="h2-28-51" class="i">+	cresize(0, 0);
</a><a href="#h2-28-52" id="h2-28-52" class="i">+	ttyresize();
</a><a href="#h2-28-53" id="h2-28-53" class="i">+	redraw();
</a><a href="#h2-28-54" id="h2-28-54" class="i">+	xhints();
</a> }
 
 void
<a href="#h2-28-58" id="h2-28-58" class="d">-xloadcols(void)
</a><a href="#h2-28-59" id="h2-28-59" class="i">+zoomreset(const Arg *arg)
</a> {
<a href="#h2-28-61" id="h2-28-61" class="d">-	int i;
</a><a href="#h2-28-62" id="h2-28-62" class="d">-	static int loaded;
</a><a href="#h2-28-63" id="h2-28-63" class="d">-	Color *cp;
</a><a href="#h2-28-64" id="h2-28-64" class="i">+	Arg larg;
</a> 
<a href="#h2-28-66" id="h2-28-66" class="d">-	if (loaded) {
</a><a href="#h2-28-67" id="h2-28-67" class="d">-		for (cp = dc.col; cp &lt; &amp;dc.col[LEN(dc.col)]; ++cp)
</a><a href="#h2-28-68" id="h2-28-68" class="d">-			XftColorFree(xw.dpy, xw.vis, xw.cmap, cp);
</a><a href="#h2-28-69" id="h2-28-69" class="i">+	if (defaultfontsize &gt; 0) {
</a><a href="#h2-28-70" id="h2-28-70" class="i">+		larg.f = defaultfontsize;
</a><a href="#h2-28-71" id="h2-28-71" class="i">+		zoomabs(&amp;larg);
</a> 	}
<a href="#h2-28-73" id="h2-28-73" class="d">-
</a><a href="#h2-28-74" id="h2-28-74" class="d">-	for (i = 0; i &lt; LEN(dc.col); i++)
</a><a href="#h2-28-75" id="h2-28-75" class="d">-		if (!xloadcolor(i, NULL, &amp;dc.col[i])) {
</a><a href="#h2-28-76" id="h2-28-76" class="d">-			if (colorname[i])
</a><a href="#h2-28-77" id="h2-28-77" class="d">-				die(&quot;Could not allocate color &#39;%s&#39;\n&quot;, colorname[i]);
</a><a href="#h2-28-78" id="h2-28-78" class="d">-			else
</a><a href="#h2-28-79" id="h2-28-79" class="d">-				die(&quot;Could not allocate color %d\n&quot;, i);
</a><a href="#h2-28-80" id="h2-28-80" class="d">-		}
</a><a href="#h2-28-81" id="h2-28-81" class="d">-	loaded = 1;
</a><a href="#h2-28-82" id="h2-28-82" class="d">-}
</a><a href="#h2-28-83" id="h2-28-83" class="d">-
</a><a href="#h2-28-84" id="h2-28-84" class="d">-int
</a><a href="#h2-28-85" id="h2-28-85" class="d">-xsetcolorname(int x, const char *name)
</a><a href="#h2-28-86" id="h2-28-86" class="d">-{
</a><a href="#h2-28-87" id="h2-28-87" class="d">-	Color ncolor;
</a><a href="#h2-28-88" id="h2-28-88" class="d">-
</a><a href="#h2-28-89" id="h2-28-89" class="d">-	if (!BETWEEN(x, 0, LEN(dc.col)))
</a><a href="#h2-28-90" id="h2-28-90" class="d">-		return 1;
</a><a href="#h2-28-91" id="h2-28-91" class="d">-
</a><a href="#h2-28-92" id="h2-28-92" class="d">-
</a><a href="#h2-28-93" id="h2-28-93" class="d">-	if (!xloadcolor(x, name, &amp;ncolor))
</a><a href="#h2-28-94" id="h2-28-94" class="d">-		return 1;
</a><a href="#h2-28-95" id="h2-28-95" class="d">-
</a><a href="#h2-28-96" id="h2-28-96" class="d">-	XftColorFree(xw.dpy, xw.vis, xw.cmap, &amp;dc.col[x]);
</a><a href="#h2-28-97" id="h2-28-97" class="d">-	dc.col[x] = ncolor;
</a><a href="#h2-28-98" id="h2-28-98" class="d">-
</a><a href="#h2-28-99" id="h2-28-99" class="d">-	return 0;
</a> }
 
<a href="#h2-28-102" id="h2-28-102" class="d">-/*
</a><a href="#h2-28-103" id="h2-28-103" class="d">- * Absolute coordinates.
</a><a href="#h2-28-104" id="h2-28-104" class="d">- */
</a> void
<a href="#h2-28-106" id="h2-28-106" class="d">-xclear(int x1, int y1, int x2, int y2)
</a><a href="#h2-28-107" id="h2-28-107" class="i">+resettitle(void)
</a> {
<a href="#h2-28-109" id="h2-28-109" class="d">-	XftDrawRect(xw.draw,
</a><a href="#h2-28-110" id="h2-28-110" class="d">-			&amp;dc.col[IS_SET(MODE_REVERSE)? defaultfg : defaultbg],
</a><a href="#h2-28-111" id="h2-28-111" class="d">-			x1, y1, x2-x1, y2-y1);
</a><a href="#h2-28-112" id="h2-28-112" class="i">+	xsettitle(opt_title ? opt_title : &quot;st&quot;);
</a> }
 
 void
<a href="#h2-28-116" id="h2-28-116" class="d">-xhints(void)
</a><a href="#h2-28-117" id="h2-28-117" class="i">+redraw(void)
</a> {
<a href="#h2-28-119" id="h2-28-119" class="d">-	XClassHint class = {opt_name ? opt_name : termname,
</a><a href="#h2-28-120" id="h2-28-120" class="d">-	                    opt_class ? opt_class : termname};
</a><a href="#h2-28-121" id="h2-28-121" class="d">-	XWMHints wm = {.flags = InputHint, .input = 1};
</a><a href="#h2-28-122" id="h2-28-122" class="d">-	XSizeHints *sizeh = NULL;
</a><a href="#h2-28-123" id="h2-28-123" class="d">-
</a><a href="#h2-28-124" id="h2-28-124" class="d">-	sizeh = XAllocSizeHints();
</a><a href="#h2-28-125" id="h2-28-125" class="d">-
</a><a href="#h2-28-126" id="h2-28-126" class="d">-	sizeh-&gt;flags = PSize | PResizeInc | PBaseSize;
</a><a href="#h2-28-127" id="h2-28-127" class="d">-	sizeh-&gt;height = xw.h;
</a><a href="#h2-28-128" id="h2-28-128" class="d">-	sizeh-&gt;width = xw.w;
</a><a href="#h2-28-129" id="h2-28-129" class="d">-	sizeh-&gt;height_inc = xw.ch;
</a><a href="#h2-28-130" id="h2-28-130" class="d">-	sizeh-&gt;width_inc = xw.cw;
</a><a href="#h2-28-131" id="h2-28-131" class="d">-	sizeh-&gt;base_height = 2 * borderpx;
</a><a href="#h2-28-132" id="h2-28-132" class="d">-	sizeh-&gt;base_width = 2 * borderpx;
</a><a href="#h2-28-133" id="h2-28-133" class="d">-	if (xw.isfixed) {
</a><a href="#h2-28-134" id="h2-28-134" class="d">-		sizeh-&gt;flags |= PMaxSize | PMinSize;
</a><a href="#h2-28-135" id="h2-28-135" class="d">-		sizeh-&gt;min_width = sizeh-&gt;max_width = xw.w;
</a><a href="#h2-28-136" id="h2-28-136" class="d">-		sizeh-&gt;min_height = sizeh-&gt;max_height = xw.h;
</a><a href="#h2-28-137" id="h2-28-137" class="d">-	}
</a><a href="#h2-28-138" id="h2-28-138" class="d">-	if (xw.gm &amp; (XValue|YValue)) {
</a><a href="#h2-28-139" id="h2-28-139" class="d">-		sizeh-&gt;flags |= USPosition | PWinGravity;
</a><a href="#h2-28-140" id="h2-28-140" class="d">-		sizeh-&gt;x = xw.l;
</a><a href="#h2-28-141" id="h2-28-141" class="d">-		sizeh-&gt;y = xw.t;
</a><a href="#h2-28-142" id="h2-28-142" class="d">-		sizeh-&gt;win_gravity = xgeommasktogravity(xw.gm);
</a><a href="#h2-28-143" id="h2-28-143" class="d">-	}
</a><a href="#h2-28-144" id="h2-28-144" class="d">-
</a><a href="#h2-28-145" id="h2-28-145" class="d">-	XSetWMProperties(xw.dpy, xw.win, NULL, NULL, NULL, 0, sizeh, &amp;wm,
</a><a href="#h2-28-146" id="h2-28-146" class="d">-			&amp;class);
</a><a href="#h2-28-147" id="h2-28-147" class="d">-	XFree(sizeh);
</a><a href="#h2-28-148" id="h2-28-148" class="i">+	tfulldirt();
</a><a href="#h2-28-149" id="h2-28-149" class="i">+	draw();
</a> }
 
 int
<a href="#h2-28-153" id="h2-28-153" class="d">-xgeommasktogravity(int mask)
</a><a href="#h2-28-154" id="h2-28-154" class="i">+match(uint mask, uint state)
</a> {
<a href="#h2-28-156" id="h2-28-156" class="d">-	switch (mask &amp; (XNegative|YNegative)) {
</a><a href="#h2-28-157" id="h2-28-157" class="d">-	case 0:
</a><a href="#h2-28-158" id="h2-28-158" class="d">-		return NorthWestGravity;
</a><a href="#h2-28-159" id="h2-28-159" class="d">-	case XNegative:
</a><a href="#h2-28-160" id="h2-28-160" class="d">-		return NorthEastGravity;
</a><a href="#h2-28-161" id="h2-28-161" class="d">-	case YNegative:
</a><a href="#h2-28-162" id="h2-28-162" class="d">-		return SouthWestGravity;
</a><a href="#h2-28-163" id="h2-28-163" class="d">-	}
</a><a href="#h2-28-164" id="h2-28-164" class="d">-
</a><a href="#h2-28-165" id="h2-28-165" class="d">-	return SouthEastGravity;
</a><a href="#h2-28-166" id="h2-28-166" class="i">+	return mask == XK_ANY_MOD || mask == (state &amp; ~ignoremod);
</a> }
 
<a href="#h2-28-169" id="h2-28-169" class="d">-int
</a><a href="#h2-28-170" id="h2-28-170" class="d">-xloadfont(Font *f, FcPattern *pattern)
</a><a href="#h2-28-171" id="h2-28-171" class="i">+void
</a><a href="#h2-28-172" id="h2-28-172" class="i">+numlock(const Arg *dummy)
</a> {
<a href="#h2-28-174" id="h2-28-174" class="d">-	FcPattern *configured;
</a><a href="#h2-28-175" id="h2-28-175" class="d">-	FcPattern *match;
</a><a href="#h2-28-176" id="h2-28-176" class="d">-	FcResult result;
</a><a href="#h2-28-177" id="h2-28-177" class="d">-	XGlyphInfo extents;
</a><a href="#h2-28-178" id="h2-28-178" class="d">-	int wantattr, haveattr;
</a><a href="#h2-28-179" id="h2-28-179" class="i">+	term.numlock ^= 1;
</a><a href="#h2-28-180" id="h2-28-180" class="i">+}
</a> 
<a href="#h2-28-182" id="h2-28-182" class="d">-	/*
</a><a href="#h2-28-183" id="h2-28-183" class="d">-	 * Manually configure instead of calling XftMatchFont
</a><a href="#h2-28-184" id="h2-28-184" class="d">-	 * so that we can use the configured pattern for
</a><a href="#h2-28-185" id="h2-28-185" class="d">-	 * &quot;missing glyph&quot; lookups.
</a><a href="#h2-28-186" id="h2-28-186" class="d">-	 */
</a><a href="#h2-28-187" id="h2-28-187" class="d">-	configured = FcPatternDuplicate(pattern);
</a><a href="#h2-28-188" id="h2-28-188" class="d">-	if (!configured)
</a><a href="#h2-28-189" id="h2-28-189" class="d">-		return 1;
</a><a href="#h2-28-190" id="h2-28-190" class="d">-
</a><a href="#h2-28-191" id="h2-28-191" class="d">-	FcConfigSubstitute(NULL, configured, FcMatchPattern);
</a><a href="#h2-28-192" id="h2-28-192" class="d">-	XftDefaultSubstitute(xw.dpy, xw.scr, configured);
</a><a href="#h2-28-193" id="h2-28-193" class="d">-
</a><a href="#h2-28-194" id="h2-28-194" class="d">-	match = FcFontMatch(NULL, configured, &amp;result);
</a><a href="#h2-28-195" id="h2-28-195" class="d">-	if (!match) {
</a><a href="#h2-28-196" id="h2-28-196" class="d">-		FcPatternDestroy(configured);
</a><a href="#h2-28-197" id="h2-28-197" class="d">-		return 1;
</a><a href="#h2-28-198" id="h2-28-198" class="d">-	}
</a><a href="#h2-28-199" id="h2-28-199" class="d">-
</a><a href="#h2-28-200" id="h2-28-200" class="d">-	if (!(f-&gt;match = XftFontOpenPattern(xw.dpy, match))) {
</a><a href="#h2-28-201" id="h2-28-201" class="d">-		FcPatternDestroy(configured);
</a><a href="#h2-28-202" id="h2-28-202" class="d">-		FcPatternDestroy(match);
</a><a href="#h2-28-203" id="h2-28-203" class="d">-		return 1;
</a><a href="#h2-28-204" id="h2-28-204" class="d">-	}
</a><a href="#h2-28-205" id="h2-28-205" class="d">-
</a><a href="#h2-28-206" id="h2-28-206" class="d">-	if ((XftPatternGetInteger(pattern, &quot;slant&quot;, 0, &amp;wantattr) ==
</a><a href="#h2-28-207" id="h2-28-207" class="d">-	    XftResultMatch)) {
</a><a href="#h2-28-208" id="h2-28-208" class="d">-		/*
</a><a href="#h2-28-209" id="h2-28-209" class="d">-		 * Check if xft was unable to find a font with the appropriate
</a><a href="#h2-28-210" id="h2-28-210" class="d">-		 * slant but gave us one anyway. Try to mitigate.
</a><a href="#h2-28-211" id="h2-28-211" class="d">-		 */
</a><a href="#h2-28-212" id="h2-28-212" class="d">-		if ((XftPatternGetInteger(f-&gt;match-&gt;pattern, &quot;slant&quot;, 0,
</a><a href="#h2-28-213" id="h2-28-213" class="d">-		    &amp;haveattr) != XftResultMatch) || haveattr &lt; wantattr) {
</a><a href="#h2-28-214" id="h2-28-214" class="d">-			f-&gt;badslant = 1;
</a><a href="#h2-28-215" id="h2-28-215" class="d">-			fputs(&quot;st: font slant does not match\n&quot;, stderr);
</a><a href="#h2-28-216" id="h2-28-216" class="d">-		}
</a><a href="#h2-28-217" id="h2-28-217" class="d">-	}
</a><a href="#h2-28-218" id="h2-28-218" class="d">-
</a><a href="#h2-28-219" id="h2-28-219" class="d">-	if ((XftPatternGetInteger(pattern, &quot;weight&quot;, 0, &amp;wantattr) ==
</a><a href="#h2-28-220" id="h2-28-220" class="d">-	    XftResultMatch)) {
</a><a href="#h2-28-221" id="h2-28-221" class="d">-		if ((XftPatternGetInteger(f-&gt;match-&gt;pattern, &quot;weight&quot;, 0,
</a><a href="#h2-28-222" id="h2-28-222" class="d">-		    &amp;haveattr) != XftResultMatch) || haveattr != wantattr) {
</a><a href="#h2-28-223" id="h2-28-223" class="d">-			f-&gt;badweight = 1;
</a><a href="#h2-28-224" id="h2-28-224" class="d">-			fputs(&quot;st: font weight does not match\n&quot;, stderr);
</a><a href="#h2-28-225" id="h2-28-225" class="d">-		}
</a><a href="#h2-28-226" id="h2-28-226" class="d">-	}
</a><a href="#h2-28-227" id="h2-28-227" class="d">-
</a><a href="#h2-28-228" id="h2-28-228" class="d">-	XftTextExtentsUtf8(xw.dpy, f-&gt;match,
</a><a href="#h2-28-229" id="h2-28-229" class="d">-		(const FcChar8 *) ascii_printable,
</a><a href="#h2-28-230" id="h2-28-230" class="d">-		strlen(ascii_printable), &amp;extents);
</a><a href="#h2-28-231" id="h2-28-231" class="d">-
</a><a href="#h2-28-232" id="h2-28-232" class="d">-	f-&gt;set = NULL;
</a><a href="#h2-28-233" id="h2-28-233" class="d">-	f-&gt;pattern = configured;
</a><a href="#h2-28-234" id="h2-28-234" class="d">-
</a><a href="#h2-28-235" id="h2-28-235" class="d">-	f-&gt;ascent = f-&gt;match-&gt;ascent;
</a><a href="#h2-28-236" id="h2-28-236" class="d">-	f-&gt;descent = f-&gt;match-&gt;descent;
</a><a href="#h2-28-237" id="h2-28-237" class="d">-	f-&gt;lbearing = 0;
</a><a href="#h2-28-238" id="h2-28-238" class="d">-	f-&gt;rbearing = f-&gt;match-&gt;max_advance_width;
</a><a href="#h2-28-239" id="h2-28-239" class="d">-
</a><a href="#h2-28-240" id="h2-28-240" class="d">-	f-&gt;height = f-&gt;ascent + f-&gt;descent;
</a><a href="#h2-28-241" id="h2-28-241" class="d">-	f-&gt;width = DIVCEIL(extents.xOff, strlen(ascii_printable));
</a><a href="#h2-28-242" id="h2-28-242" class="d">-
</a><a href="#h2-28-243" id="h2-28-243" class="d">-	return 0;
</a><a href="#h2-28-244" id="h2-28-244" class="d">-}
</a><a href="#h2-28-245" id="h2-28-245" class="d">-
</a><a href="#h2-28-246" id="h2-28-246" class="d">-void
</a><a href="#h2-28-247" id="h2-28-247" class="d">-xloadfonts(char *fontstr, double fontsize)
</a><a href="#h2-28-248" id="h2-28-248" class="d">-{
</a><a href="#h2-28-249" id="h2-28-249" class="d">-	FcPattern *pattern;
</a><a href="#h2-28-250" id="h2-28-250" class="d">-	double fontval;
</a><a href="#h2-28-251" id="h2-28-251" class="d">-	float ceilf(float);
</a><a href="#h2-28-252" id="h2-28-252" class="d">-
</a><a href="#h2-28-253" id="h2-28-253" class="d">-	if (fontstr[0] == &#39;-&#39;) {
</a><a href="#h2-28-254" id="h2-28-254" class="d">-		pattern = XftXlfdParse(fontstr, False, False);
</a><a href="#h2-28-255" id="h2-28-255" class="d">-	} else {
</a><a href="#h2-28-256" id="h2-28-256" class="d">-		pattern = FcNameParse((FcChar8 *)fontstr);
</a><a href="#h2-28-257" id="h2-28-257" class="d">-	}
</a><a href="#h2-28-258" id="h2-28-258" class="d">-
</a><a href="#h2-28-259" id="h2-28-259" class="d">-	if (!pattern)
</a><a href="#h2-28-260" id="h2-28-260" class="d">-		die(&quot;st: can&#39;t open font %s\n&quot;, fontstr);
</a><a href="#h2-28-261" id="h2-28-261" class="d">-
</a><a href="#h2-28-262" id="h2-28-262" class="d">-	if (fontsize &gt; 1) {
</a><a href="#h2-28-263" id="h2-28-263" class="d">-		FcPatternDel(pattern, FC_PIXEL_SIZE);
</a><a href="#h2-28-264" id="h2-28-264" class="d">-		FcPatternDel(pattern, FC_SIZE);
</a><a href="#h2-28-265" id="h2-28-265" class="d">-		FcPatternAddDouble(pattern, FC_PIXEL_SIZE, (double)fontsize);
</a><a href="#h2-28-266" id="h2-28-266" class="d">-		usedfontsize = fontsize;
</a><a href="#h2-28-267" id="h2-28-267" class="d">-	} else {
</a><a href="#h2-28-268" id="h2-28-268" class="d">-		if (FcPatternGetDouble(pattern, FC_PIXEL_SIZE, 0, &amp;fontval) ==
</a><a href="#h2-28-269" id="h2-28-269" class="d">-				FcResultMatch) {
</a><a href="#h2-28-270" id="h2-28-270" class="d">-			usedfontsize = fontval;
</a><a href="#h2-28-271" id="h2-28-271" class="d">-		} else if (FcPatternGetDouble(pattern, FC_SIZE, 0, &amp;fontval) ==
</a><a href="#h2-28-272" id="h2-28-272" class="d">-				FcResultMatch) {
</a><a href="#h2-28-273" id="h2-28-273" class="d">-			usedfontsize = -1;
</a><a href="#h2-28-274" id="h2-28-274" class="d">-		} else {
</a><a href="#h2-28-275" id="h2-28-275" class="d">-			/*
</a><a href="#h2-28-276" id="h2-28-276" class="d">-			 * Default font size is 12, if none given. This is to
</a><a href="#h2-28-277" id="h2-28-277" class="d">-			 * have a known usedfontsize value.
</a><a href="#h2-28-278" id="h2-28-278" class="d">-			 */
</a><a href="#h2-28-279" id="h2-28-279" class="d">-			FcPatternAddDouble(pattern, FC_PIXEL_SIZE, 12);
</a><a href="#h2-28-280" id="h2-28-280" class="d">-			usedfontsize = 12;
</a><a href="#h2-28-281" id="h2-28-281" class="d">-		}
</a><a href="#h2-28-282" id="h2-28-282" class="d">-		defaultfontsize = usedfontsize;
</a><a href="#h2-28-283" id="h2-28-283" class="d">-	}
</a><a href="#h2-28-284" id="h2-28-284" class="d">-
</a><a href="#h2-28-285" id="h2-28-285" class="d">-	if (xloadfont(&amp;dc.font, pattern))
</a><a href="#h2-28-286" id="h2-28-286" class="d">-		die(&quot;st: can&#39;t open font %s\n&quot;, fontstr);
</a><a href="#h2-28-287" id="h2-28-287" class="d">-
</a><a href="#h2-28-288" id="h2-28-288" class="d">-	if (usedfontsize &lt; 0) {
</a><a href="#h2-28-289" id="h2-28-289" class="d">-		FcPatternGetDouble(dc.font.match-&gt;pattern,
</a><a href="#h2-28-290" id="h2-28-290" class="d">-		                   FC_PIXEL_SIZE, 0, &amp;fontval);
</a><a href="#h2-28-291" id="h2-28-291" class="d">-		usedfontsize = fontval;
</a><a href="#h2-28-292" id="h2-28-292" class="d">-		if (fontsize == 0)
</a><a href="#h2-28-293" id="h2-28-293" class="d">-			defaultfontsize = fontval;
</a><a href="#h2-28-294" id="h2-28-294" class="d">-	}
</a><a href="#h2-28-295" id="h2-28-295" class="d">-
</a><a href="#h2-28-296" id="h2-28-296" class="d">-	/* Setting character width and height. */
</a><a href="#h2-28-297" id="h2-28-297" class="d">-	xw.cw = ceilf(dc.font.width * cwscale);
</a><a href="#h2-28-298" id="h2-28-298" class="d">-	xw.ch = ceilf(dc.font.height * chscale);
</a><a href="#h2-28-299" id="h2-28-299" class="d">-
</a><a href="#h2-28-300" id="h2-28-300" class="d">-	FcPatternDel(pattern, FC_SLANT);
</a><a href="#h2-28-301" id="h2-28-301" class="d">-	FcPatternAddInteger(pattern, FC_SLANT, FC_SLANT_ITALIC);
</a><a href="#h2-28-302" id="h2-28-302" class="d">-	if (xloadfont(&amp;dc.ifont, pattern))
</a><a href="#h2-28-303" id="h2-28-303" class="d">-		die(&quot;st: can&#39;t open font %s\n&quot;, fontstr);
</a><a href="#h2-28-304" id="h2-28-304" class="d">-
</a><a href="#h2-28-305" id="h2-28-305" class="d">-	FcPatternDel(pattern, FC_WEIGHT);
</a><a href="#h2-28-306" id="h2-28-306" class="d">-	FcPatternAddInteger(pattern, FC_WEIGHT, FC_WEIGHT_BOLD);
</a><a href="#h2-28-307" id="h2-28-307" class="d">-	if (xloadfont(&amp;dc.ibfont, pattern))
</a><a href="#h2-28-308" id="h2-28-308" class="d">-		die(&quot;st: can&#39;t open font %s\n&quot;, fontstr);
</a><a href="#h2-28-309" id="h2-28-309" class="d">-
</a><a href="#h2-28-310" id="h2-28-310" class="d">-	FcPatternDel(pattern, FC_SLANT);
</a><a href="#h2-28-311" id="h2-28-311" class="d">-	FcPatternAddInteger(pattern, FC_SLANT, FC_SLANT_ROMAN);
</a><a href="#h2-28-312" id="h2-28-312" class="d">-	if (xloadfont(&amp;dc.bfont, pattern))
</a><a href="#h2-28-313" id="h2-28-313" class="d">-		die(&quot;st: can&#39;t open font %s\n&quot;, fontstr);
</a><a href="#h2-28-314" id="h2-28-314" class="d">-
</a><a href="#h2-28-315" id="h2-28-315" class="d">-	FcPatternDestroy(pattern);
</a><a href="#h2-28-316" id="h2-28-316" class="d">-}
</a><a href="#h2-28-317" id="h2-28-317" class="d">-
</a><a href="#h2-28-318" id="h2-28-318" class="d">-void
</a><a href="#h2-28-319" id="h2-28-319" class="d">-xunloadfont(Font *f)
</a><a href="#h2-28-320" id="h2-28-320" class="d">-{
</a><a href="#h2-28-321" id="h2-28-321" class="d">-	XftFontClose(xw.dpy, f-&gt;match);
</a><a href="#h2-28-322" id="h2-28-322" class="d">-	FcPatternDestroy(f-&gt;pattern);
</a><a href="#h2-28-323" id="h2-28-323" class="d">-	if (f-&gt;set)
</a><a href="#h2-28-324" id="h2-28-324" class="d">-		FcFontSetDestroy(f-&gt;set);
</a><a href="#h2-28-325" id="h2-28-325" class="d">-}
</a><a href="#h2-28-326" id="h2-28-326" class="d">-
</a><a href="#h2-28-327" id="h2-28-327" class="d">-void
</a><a href="#h2-28-328" id="h2-28-328" class="d">-xunloadfonts(void)
</a><a href="#h2-28-329" id="h2-28-329" class="d">-{
</a><a href="#h2-28-330" id="h2-28-330" class="d">-	/* Free the loaded fonts in the font cache.  */
</a><a href="#h2-28-331" id="h2-28-331" class="d">-	while (frclen &gt; 0)
</a><a href="#h2-28-332" id="h2-28-332" class="d">-		XftFontClose(xw.dpy, frc[--frclen].font);
</a><a href="#h2-28-333" id="h2-28-333" class="d">-
</a><a href="#h2-28-334" id="h2-28-334" class="d">-	xunloadfont(&amp;dc.font);
</a><a href="#h2-28-335" id="h2-28-335" class="d">-	xunloadfont(&amp;dc.bfont);
</a><a href="#h2-28-336" id="h2-28-336" class="d">-	xunloadfont(&amp;dc.ifont);
</a><a href="#h2-28-337" id="h2-28-337" class="d">-	xunloadfont(&amp;dc.ibfont);
</a><a href="#h2-28-338" id="h2-28-338" class="d">-}
</a><a href="#h2-28-339" id="h2-28-339" class="d">-
</a><a href="#h2-28-340" id="h2-28-340" class="d">-void
</a><a href="#h2-28-341" id="h2-28-341" class="d">-xzoom(const Arg *arg)
</a><a href="#h2-28-342" id="h2-28-342" class="d">-{
</a><a href="#h2-28-343" id="h2-28-343" class="d">-	Arg larg;
</a><a href="#h2-28-344" id="h2-28-344" class="d">-
</a><a href="#h2-28-345" id="h2-28-345" class="d">-	larg.f = usedfontsize + arg-&gt;f;
</a><a href="#h2-28-346" id="h2-28-346" class="d">-	xzoomabs(&amp;larg);
</a><a href="#h2-28-347" id="h2-28-347" class="d">-}
</a><a href="#h2-28-348" id="h2-28-348" class="d">-
</a><a href="#h2-28-349" id="h2-28-349" class="d">-void
</a><a href="#h2-28-350" id="h2-28-350" class="d">-xzoomabs(const Arg *arg)
</a><a href="#h2-28-351" id="h2-28-351" class="d">-{
</a><a href="#h2-28-352" id="h2-28-352" class="d">-	xunloadfonts();
</a><a href="#h2-28-353" id="h2-28-353" class="d">-	xloadfonts(usedfont, arg-&gt;f);
</a><a href="#h2-28-354" id="h2-28-354" class="d">-	cresize(0, 0);
</a><a href="#h2-28-355" id="h2-28-355" class="d">-	ttyresize();
</a><a href="#h2-28-356" id="h2-28-356" class="d">-	redraw();
</a><a href="#h2-28-357" id="h2-28-357" class="d">-	xhints();
</a><a href="#h2-28-358" id="h2-28-358" class="d">-}
</a><a href="#h2-28-359" id="h2-28-359" class="d">-
</a><a href="#h2-28-360" id="h2-28-360" class="d">-void
</a><a href="#h2-28-361" id="h2-28-361" class="d">-xzoomreset(const Arg *arg)
</a><a href="#h2-28-362" id="h2-28-362" class="d">-{
</a><a href="#h2-28-363" id="h2-28-363" class="d">-	Arg larg;
</a><a href="#h2-28-364" id="h2-28-364" class="d">-
</a><a href="#h2-28-365" id="h2-28-365" class="d">-	if (defaultfontsize &gt; 0) {
</a><a href="#h2-28-366" id="h2-28-366" class="d">-		larg.f = defaultfontsize;
</a><a href="#h2-28-367" id="h2-28-367" class="d">-		xzoomabs(&amp;larg);
</a><a href="#h2-28-368" id="h2-28-368" class="d">-	}
</a><a href="#h2-28-369" id="h2-28-369" class="d">-}
</a><a href="#h2-28-370" id="h2-28-370" class="d">-
</a><a href="#h2-28-371" id="h2-28-371" class="d">-void
</a><a href="#h2-28-372" id="h2-28-372" class="d">-xinit(void)
</a><a href="#h2-28-373" id="h2-28-373" class="d">-{
</a><a href="#h2-28-374" id="h2-28-374" class="d">-	XGCValues gcvalues;
</a><a href="#h2-28-375" id="h2-28-375" class="d">-	Cursor cursor;
</a><a href="#h2-28-376" id="h2-28-376" class="d">-	Window parent;
</a><a href="#h2-28-377" id="h2-28-377" class="d">-	pid_t thispid = getpid();
</a><a href="#h2-28-378" id="h2-28-378" class="d">-	XColor xmousefg, xmousebg;
</a><a href="#h2-28-379" id="h2-28-379" class="d">-
</a><a href="#h2-28-380" id="h2-28-380" class="d">-	if (!(xw.dpy = XOpenDisplay(NULL)))
</a><a href="#h2-28-381" id="h2-28-381" class="d">-		die(&quot;Can&#39;t open display\n&quot;);
</a><a href="#h2-28-382" id="h2-28-382" class="d">-	xw.scr = XDefaultScreen(xw.dpy);
</a><a href="#h2-28-383" id="h2-28-383" class="d">-	xw.vis = XDefaultVisual(xw.dpy, xw.scr);
</a><a href="#h2-28-384" id="h2-28-384" class="d">-
</a><a href="#h2-28-385" id="h2-28-385" class="d">-	/* font */
</a><a href="#h2-28-386" id="h2-28-386" class="d">-	if (!FcInit())
</a><a href="#h2-28-387" id="h2-28-387" class="d">-		die(&quot;Could not init fontconfig.\n&quot;);
</a><a href="#h2-28-388" id="h2-28-388" class="d">-
</a><a href="#h2-28-389" id="h2-28-389" class="d">-	usedfont = (opt_font == NULL)? font : opt_font;
</a><a href="#h2-28-390" id="h2-28-390" class="d">-	xloadfonts(usedfont, 0);
</a><a href="#h2-28-391" id="h2-28-391" class="d">-
</a><a href="#h2-28-392" id="h2-28-392" class="d">-	/* colors */
</a><a href="#h2-28-393" id="h2-28-393" class="d">-	xw.cmap = XDefaultColormap(xw.dpy, xw.scr);
</a><a href="#h2-28-394" id="h2-28-394" class="d">-	xloadcols();
</a><a href="#h2-28-395" id="h2-28-395" class="d">-
</a><a href="#h2-28-396" id="h2-28-396" class="d">-	/* adjust fixed window geometry */
</a><a href="#h2-28-397" id="h2-28-397" class="d">-	xw.w = 2 * borderpx + term.col * xw.cw;
</a><a href="#h2-28-398" id="h2-28-398" class="d">-	xw.h = 2 * borderpx + term.row * xw.ch;
</a><a href="#h2-28-399" id="h2-28-399" class="d">-	if (xw.gm &amp; XNegative)
</a><a href="#h2-28-400" id="h2-28-400" class="d">-		xw.l += DisplayWidth(xw.dpy, xw.scr) - xw.w - 2;
</a><a href="#h2-28-401" id="h2-28-401" class="d">-	if (xw.gm &amp; YNegative)
</a><a href="#h2-28-402" id="h2-28-402" class="d">-		xw.t += DisplayHeight(xw.dpy, xw.scr) - xw.h - 2;
</a><a href="#h2-28-403" id="h2-28-403" class="d">-
</a><a href="#h2-28-404" id="h2-28-404" class="d">-	/* Events */
</a><a href="#h2-28-405" id="h2-28-405" class="d">-	xw.attrs.background_pixel = dc.col[defaultbg].pixel;
</a><a href="#h2-28-406" id="h2-28-406" class="d">-	xw.attrs.border_pixel = dc.col[defaultbg].pixel;
</a><a href="#h2-28-407" id="h2-28-407" class="d">-	xw.attrs.bit_gravity = NorthWestGravity;
</a><a href="#h2-28-408" id="h2-28-408" class="d">-	xw.attrs.event_mask = FocusChangeMask | KeyPressMask
</a><a href="#h2-28-409" id="h2-28-409" class="d">-		| ExposureMask | VisibilityChangeMask | StructureNotifyMask
</a><a href="#h2-28-410" id="h2-28-410" class="d">-		| ButtonMotionMask | ButtonPressMask | ButtonReleaseMask;
</a><a href="#h2-28-411" id="h2-28-411" class="d">-	xw.attrs.colormap = xw.cmap;
</a><a href="#h2-28-412" id="h2-28-412" class="d">-
</a><a href="#h2-28-413" id="h2-28-413" class="d">-	if (!(opt_embed &amp;&amp; (parent = strtol(opt_embed, NULL, 0))))
</a><a href="#h2-28-414" id="h2-28-414" class="d">-		parent = XRootWindow(xw.dpy, xw.scr);
</a><a href="#h2-28-415" id="h2-28-415" class="d">-	xw.win = XCreateWindow(xw.dpy, parent, xw.l, xw.t,
</a><a href="#h2-28-416" id="h2-28-416" class="d">-			xw.w, xw.h, 0, XDefaultDepth(xw.dpy, xw.scr), InputOutput,
</a><a href="#h2-28-417" id="h2-28-417" class="d">-			xw.vis, CWBackPixel | CWBorderPixel | CWBitGravity
</a><a href="#h2-28-418" id="h2-28-418" class="d">-			| CWEventMask | CWColormap, &amp;xw.attrs);
</a><a href="#h2-28-419" id="h2-28-419" class="d">-
</a><a href="#h2-28-420" id="h2-28-420" class="d">-	memset(&amp;gcvalues, 0, sizeof(gcvalues));
</a><a href="#h2-28-421" id="h2-28-421" class="d">-	gcvalues.graphics_exposures = False;
</a><a href="#h2-28-422" id="h2-28-422" class="d">-	dc.gc = XCreateGC(xw.dpy, parent, GCGraphicsExposures,
</a><a href="#h2-28-423" id="h2-28-423" class="d">-			&amp;gcvalues);
</a><a href="#h2-28-424" id="h2-28-424" class="d">-	xw.buf = XCreatePixmap(xw.dpy, xw.win, xw.w, xw.h,
</a><a href="#h2-28-425" id="h2-28-425" class="d">-			DefaultDepth(xw.dpy, xw.scr));
</a><a href="#h2-28-426" id="h2-28-426" class="d">-	XSetForeground(xw.dpy, dc.gc, dc.col[defaultbg].pixel);
</a><a href="#h2-28-427" id="h2-28-427" class="d">-	XFillRectangle(xw.dpy, xw.buf, dc.gc, 0, 0, xw.w, xw.h);
</a><a href="#h2-28-428" id="h2-28-428" class="d">-
</a><a href="#h2-28-429" id="h2-28-429" class="d">-	/* Xft rendering context */
</a><a href="#h2-28-430" id="h2-28-430" class="d">-	xw.draw = XftDrawCreate(xw.dpy, xw.buf, xw.vis, xw.cmap);
</a><a href="#h2-28-431" id="h2-28-431" class="d">-
</a><a href="#h2-28-432" id="h2-28-432" class="d">-	/* input methods */
</a><a href="#h2-28-433" id="h2-28-433" class="d">-	if ((xw.xim = XOpenIM(xw.dpy, NULL, NULL, NULL)) == NULL) {
</a><a href="#h2-28-434" id="h2-28-434" class="d">-		XSetLocaleModifiers(&quot;@im=local&quot;);
</a><a href="#h2-28-435" id="h2-28-435" class="d">-		if ((xw.xim =  XOpenIM(xw.dpy, NULL, NULL, NULL)) == NULL) {
</a><a href="#h2-28-436" id="h2-28-436" class="d">-			XSetLocaleModifiers(&quot;@im=&quot;);
</a><a href="#h2-28-437" id="h2-28-437" class="d">-			if ((xw.xim = XOpenIM(xw.dpy,
</a><a href="#h2-28-438" id="h2-28-438" class="d">-					NULL, NULL, NULL)) == NULL) {
</a><a href="#h2-28-439" id="h2-28-439" class="d">-				die(&quot;XOpenIM failed. Could not open input&quot;
</a><a href="#h2-28-440" id="h2-28-440" class="d">-					&quot; device.\n&quot;);
</a><a href="#h2-28-441" id="h2-28-441" class="d">-			}
</a><a href="#h2-28-442" id="h2-28-442" class="d">-		}
</a><a href="#h2-28-443" id="h2-28-443" class="d">-	}
</a><a href="#h2-28-444" id="h2-28-444" class="d">-	xw.xic = XCreateIC(xw.xim, XNInputStyle, XIMPreeditNothing
</a><a href="#h2-28-445" id="h2-28-445" class="d">-					   | XIMStatusNothing, XNClientWindow, xw.win,
</a><a href="#h2-28-446" id="h2-28-446" class="d">-					   XNFocusWindow, xw.win, NULL);
</a><a href="#h2-28-447" id="h2-28-447" class="d">-	if (xw.xic == NULL)
</a><a href="#h2-28-448" id="h2-28-448" class="d">-		die(&quot;XCreateIC failed. Could not obtain input method.\n&quot;);
</a><a href="#h2-28-449" id="h2-28-449" class="d">-
</a><a href="#h2-28-450" id="h2-28-450" class="d">-	/* white cursor, black outline */
</a><a href="#h2-28-451" id="h2-28-451" class="d">-	cursor = XCreateFontCursor(xw.dpy, mouseshape);
</a><a href="#h2-28-452" id="h2-28-452" class="d">-	XDefineCursor(xw.dpy, xw.win, cursor);
</a><a href="#h2-28-453" id="h2-28-453" class="d">-
</a><a href="#h2-28-454" id="h2-28-454" class="d">-	if (XParseColor(xw.dpy, xw.cmap, colorname[mousefg], &amp;xmousefg) == 0) {
</a><a href="#h2-28-455" id="h2-28-455" class="d">-		xmousefg.red   = 0xffff;
</a><a href="#h2-28-456" id="h2-28-456" class="d">-		xmousefg.green = 0xffff;
</a><a href="#h2-28-457" id="h2-28-457" class="d">-		xmousefg.blue  = 0xffff;
</a><a href="#h2-28-458" id="h2-28-458" class="d">-	}
</a><a href="#h2-28-459" id="h2-28-459" class="d">-
</a><a href="#h2-28-460" id="h2-28-460" class="d">-	if (XParseColor(xw.dpy, xw.cmap, colorname[mousebg], &amp;xmousebg) == 0) {
</a><a href="#h2-28-461" id="h2-28-461" class="d">-		xmousebg.red   = 0x0000;
</a><a href="#h2-28-462" id="h2-28-462" class="d">-		xmousebg.green = 0x0000;
</a><a href="#h2-28-463" id="h2-28-463" class="d">-		xmousebg.blue  = 0x0000;
</a><a href="#h2-28-464" id="h2-28-464" class="d">-	}
</a><a href="#h2-28-465" id="h2-28-465" class="d">-
</a><a href="#h2-28-466" id="h2-28-466" class="d">-	XRecolorCursor(xw.dpy, cursor, &amp;xmousefg, &amp;xmousebg);
</a><a href="#h2-28-467" id="h2-28-467" class="d">-
</a><a href="#h2-28-468" id="h2-28-468" class="d">-	xw.xembed = XInternAtom(xw.dpy, &quot;_XEMBED&quot;, False);
</a><a href="#h2-28-469" id="h2-28-469" class="d">-	xw.wmdeletewin = XInternAtom(xw.dpy, &quot;WM_DELETE_WINDOW&quot;, False);
</a><a href="#h2-28-470" id="h2-28-470" class="d">-	xw.netwmname = XInternAtom(xw.dpy, &quot;_NET_WM_NAME&quot;, False);
</a><a href="#h2-28-471" id="h2-28-471" class="d">-	XSetWMProtocols(xw.dpy, xw.win, &amp;xw.wmdeletewin, 1);
</a><a href="#h2-28-472" id="h2-28-472" class="d">-
</a><a href="#h2-28-473" id="h2-28-473" class="d">-	xw.netwmpid = XInternAtom(xw.dpy, &quot;_NET_WM_PID&quot;, False);
</a><a href="#h2-28-474" id="h2-28-474" class="d">-	XChangeProperty(xw.dpy, xw.win, xw.netwmpid, XA_CARDINAL, 32,
</a><a href="#h2-28-475" id="h2-28-475" class="d">-			PropModeReplace, (uchar *)&amp;thispid, 1);
</a><a href="#h2-28-476" id="h2-28-476" class="d">-
</a><a href="#h2-28-477" id="h2-28-477" class="d">-	xresettitle();
</a><a href="#h2-28-478" id="h2-28-478" class="d">-	XMapWindow(xw.dpy, xw.win);
</a><a href="#h2-28-479" id="h2-28-479" class="d">-	xhints();
</a><a href="#h2-28-480" id="h2-28-480" class="d">-	XSync(xw.dpy, False);
</a><a href="#h2-28-481" id="h2-28-481" class="d">-}
</a><a href="#h2-28-482" id="h2-28-482" class="d">-
</a><a href="#h2-28-483" id="h2-28-483" class="d">-int
</a><a href="#h2-28-484" id="h2-28-484" class="d">-xmakeglyphfontspecs(XftGlyphFontSpec *specs, const Glyph *glyphs, int len, int x, int y)
</a><a href="#h2-28-485" id="h2-28-485" class="d">-{
</a><a href="#h2-28-486" id="h2-28-486" class="d">-	float winx = borderpx + x * xw.cw, winy = borderpx + y * xw.ch, xp, yp;
</a><a href="#h2-28-487" id="h2-28-487" class="d">-	ushort mode, prevmode = USHRT_MAX;
</a><a href="#h2-28-488" id="h2-28-488" class="d">-	Font *font = &amp;dc.font;
</a><a href="#h2-28-489" id="h2-28-489" class="d">-	int frcflags = FRC_NORMAL;
</a><a href="#h2-28-490" id="h2-28-490" class="d">-	float runewidth = xw.cw;
</a><a href="#h2-28-491" id="h2-28-491" class="d">-	Rune rune;
</a><a href="#h2-28-492" id="h2-28-492" class="d">-	FT_UInt glyphidx;
</a><a href="#h2-28-493" id="h2-28-493" class="d">-	FcResult fcres;
</a><a href="#h2-28-494" id="h2-28-494" class="d">-	FcPattern *fcpattern, *fontpattern;
</a><a href="#h2-28-495" id="h2-28-495" class="d">-	FcFontSet *fcsets[] = { NULL };
</a><a href="#h2-28-496" id="h2-28-496" class="d">-	FcCharSet *fccharset;
</a><a href="#h2-28-497" id="h2-28-497" class="d">-	int i, f, numspecs = 0;
</a><a href="#h2-28-498" id="h2-28-498" class="d">-
</a><a href="#h2-28-499" id="h2-28-499" class="d">-	for (i = 0, xp = winx, yp = winy + font-&gt;ascent; i &lt; len; ++i) {
</a><a href="#h2-28-500" id="h2-28-500" class="d">-		/* Fetch rune and mode for current glyph. */
</a><a href="#h2-28-501" id="h2-28-501" class="d">-		rune = glyphs[i].u;
</a><a href="#h2-28-502" id="h2-28-502" class="d">-		mode = glyphs[i].mode;
</a><a href="#h2-28-503" id="h2-28-503" class="d">-
</a><a href="#h2-28-504" id="h2-28-504" class="d">-		/* Skip dummy wide-character spacing. */
</a><a href="#h2-28-505" id="h2-28-505" class="d">-		if (mode == ATTR_WDUMMY)
</a><a href="#h2-28-506" id="h2-28-506" class="d">-			continue;
</a><a href="#h2-28-507" id="h2-28-507" class="d">-
</a><a href="#h2-28-508" id="h2-28-508" class="d">-		/* Determine font for glyph if different from previous glyph. */
</a><a href="#h2-28-509" id="h2-28-509" class="d">-		if (prevmode != mode) {
</a><a href="#h2-28-510" id="h2-28-510" class="d">-			prevmode = mode;
</a><a href="#h2-28-511" id="h2-28-511" class="d">-			font = &amp;dc.font;
</a><a href="#h2-28-512" id="h2-28-512" class="d">-			frcflags = FRC_NORMAL;
</a><a href="#h2-28-513" id="h2-28-513" class="d">-			runewidth = xw.cw * ((mode &amp; ATTR_WIDE) ? 2.0f : 1.0f);
</a><a href="#h2-28-514" id="h2-28-514" class="d">-			if ((mode &amp; ATTR_ITALIC) &amp;&amp; (mode &amp; ATTR_BOLD)) {
</a><a href="#h2-28-515" id="h2-28-515" class="d">-				font = &amp;dc.ibfont;
</a><a href="#h2-28-516" id="h2-28-516" class="d">-				frcflags = FRC_ITALICBOLD;
</a><a href="#h2-28-517" id="h2-28-517" class="d">-			} else if (mode &amp; ATTR_ITALIC) {
</a><a href="#h2-28-518" id="h2-28-518" class="d">-				font = &amp;dc.ifont;
</a><a href="#h2-28-519" id="h2-28-519" class="d">-				frcflags = FRC_ITALIC;
</a><a href="#h2-28-520" id="h2-28-520" class="d">-			} else if (mode &amp; ATTR_BOLD) {
</a><a href="#h2-28-521" id="h2-28-521" class="d">-				font = &amp;dc.bfont;
</a><a href="#h2-28-522" id="h2-28-522" class="d">-				frcflags = FRC_BOLD;
</a><a href="#h2-28-523" id="h2-28-523" class="d">-			}
</a><a href="#h2-28-524" id="h2-28-524" class="d">-			yp = winy + font-&gt;ascent;
</a><a href="#h2-28-525" id="h2-28-525" class="d">-		}
</a><a href="#h2-28-526" id="h2-28-526" class="d">-
</a><a href="#h2-28-527" id="h2-28-527" class="d">-		/* Lookup character index with default font. */
</a><a href="#h2-28-528" id="h2-28-528" class="d">-		glyphidx = XftCharIndex(xw.dpy, font-&gt;match, rune);
</a><a href="#h2-28-529" id="h2-28-529" class="d">-		if (glyphidx) {
</a><a href="#h2-28-530" id="h2-28-530" class="d">-			specs[numspecs].font = font-&gt;match;
</a><a href="#h2-28-531" id="h2-28-531" class="d">-			specs[numspecs].glyph = glyphidx;
</a><a href="#h2-28-532" id="h2-28-532" class="d">-			specs[numspecs].x = (short)xp;
</a><a href="#h2-28-533" id="h2-28-533" class="d">-			specs[numspecs].y = (short)yp;
</a><a href="#h2-28-534" id="h2-28-534" class="d">-			xp += runewidth;
</a><a href="#h2-28-535" id="h2-28-535" class="d">-			numspecs++;
</a><a href="#h2-28-536" id="h2-28-536" class="d">-			continue;
</a><a href="#h2-28-537" id="h2-28-537" class="d">-		}
</a><a href="#h2-28-538" id="h2-28-538" class="d">-
</a><a href="#h2-28-539" id="h2-28-539" class="d">-		/* Fallback on font cache, search the font cache for match. */
</a><a href="#h2-28-540" id="h2-28-540" class="d">-		for (f = 0; f &lt; frclen; f++) {
</a><a href="#h2-28-541" id="h2-28-541" class="d">-			glyphidx = XftCharIndex(xw.dpy, frc[f].font, rune);
</a><a href="#h2-28-542" id="h2-28-542" class="d">-			/* Everything correct. */
</a><a href="#h2-28-543" id="h2-28-543" class="d">-			if (glyphidx &amp;&amp; frc[f].flags == frcflags)
</a><a href="#h2-28-544" id="h2-28-544" class="d">-				break;
</a><a href="#h2-28-545" id="h2-28-545" class="d">-			/* We got a default font for a not found glyph. */
</a><a href="#h2-28-546" id="h2-28-546" class="d">-			if (!glyphidx &amp;&amp; frc[f].flags == frcflags
</a><a href="#h2-28-547" id="h2-28-547" class="d">-					&amp;&amp; frc[f].unicodep == rune) {
</a><a href="#h2-28-548" id="h2-28-548" class="d">-				break;
</a><a href="#h2-28-549" id="h2-28-549" class="d">-			}
</a><a href="#h2-28-550" id="h2-28-550" class="d">-		}
</a><a href="#h2-28-551" id="h2-28-551" class="d">-
</a><a href="#h2-28-552" id="h2-28-552" class="d">-		/* Nothing was found. Use fontconfig to find matching font. */
</a><a href="#h2-28-553" id="h2-28-553" class="d">-		if (f &gt;= frclen) {
</a><a href="#h2-28-554" id="h2-28-554" class="d">-			if (!font-&gt;set)
</a><a href="#h2-28-555" id="h2-28-555" class="d">-				font-&gt;set = FcFontSort(0, font-&gt;pattern,
</a><a href="#h2-28-556" id="h2-28-556" class="d">-				                       1, 0, &amp;fcres);
</a><a href="#h2-28-557" id="h2-28-557" class="d">-			fcsets[0] = font-&gt;set;
</a><a href="#h2-28-558" id="h2-28-558" class="d">-
</a><a href="#h2-28-559" id="h2-28-559" class="d">-			/*
</a><a href="#h2-28-560" id="h2-28-560" class="d">-			 * Nothing was found in the cache. Now use
</a><a href="#h2-28-561" id="h2-28-561" class="d">-			 * some dozen of Fontconfig calls to get the
</a><a href="#h2-28-562" id="h2-28-562" class="d">-			 * font for one single character.
</a><a href="#h2-28-563" id="h2-28-563" class="d">-			 *
</a><a href="#h2-28-564" id="h2-28-564" class="d">-			 * Xft and fontconfig are design failures.
</a><a href="#h2-28-565" id="h2-28-565" class="d">-			 */
</a><a href="#h2-28-566" id="h2-28-566" class="d">-			fcpattern = FcPatternDuplicate(font-&gt;pattern);
</a><a href="#h2-28-567" id="h2-28-567" class="d">-			fccharset = FcCharSetCreate();
</a><a href="#h2-28-568" id="h2-28-568" class="d">-
</a><a href="#h2-28-569" id="h2-28-569" class="d">-			FcCharSetAddChar(fccharset, rune);
</a><a href="#h2-28-570" id="h2-28-570" class="d">-			FcPatternAddCharSet(fcpattern, FC_CHARSET,
</a><a href="#h2-28-571" id="h2-28-571" class="d">-					fccharset);
</a><a href="#h2-28-572" id="h2-28-572" class="d">-			FcPatternAddBool(fcpattern, FC_SCALABLE, 1);
</a><a href="#h2-28-573" id="h2-28-573" class="d">-
</a><a href="#h2-28-574" id="h2-28-574" class="d">-			FcConfigSubstitute(0, fcpattern,
</a><a href="#h2-28-575" id="h2-28-575" class="d">-					FcMatchPattern);
</a><a href="#h2-28-576" id="h2-28-576" class="d">-			FcDefaultSubstitute(fcpattern);
</a><a href="#h2-28-577" id="h2-28-577" class="d">-
</a><a href="#h2-28-578" id="h2-28-578" class="d">-			fontpattern = FcFontSetMatch(0, fcsets, 1,
</a><a href="#h2-28-579" id="h2-28-579" class="d">-					fcpattern, &amp;fcres);
</a><a href="#h2-28-580" id="h2-28-580" class="d">-
</a><a href="#h2-28-581" id="h2-28-581" class="d">-			/*
</a><a href="#h2-28-582" id="h2-28-582" class="d">-			 * Overwrite or create the new cache entry.
</a><a href="#h2-28-583" id="h2-28-583" class="d">-			 */
</a><a href="#h2-28-584" id="h2-28-584" class="d">-			if (frclen &gt;= LEN(frc)) {
</a><a href="#h2-28-585" id="h2-28-585" class="d">-				frclen = LEN(frc) - 1;
</a><a href="#h2-28-586" id="h2-28-586" class="d">-				XftFontClose(xw.dpy, frc[frclen].font);
</a><a href="#h2-28-587" id="h2-28-587" class="d">-				frc[frclen].unicodep = 0;
</a><a href="#h2-28-588" id="h2-28-588" class="d">-			}
</a><a href="#h2-28-589" id="h2-28-589" class="d">-
</a><a href="#h2-28-590" id="h2-28-590" class="d">-			frc[frclen].font = XftFontOpenPattern(xw.dpy,
</a><a href="#h2-28-591" id="h2-28-591" class="d">-					fontpattern);
</a><a href="#h2-28-592" id="h2-28-592" class="d">-			frc[frclen].flags = frcflags;
</a><a href="#h2-28-593" id="h2-28-593" class="d">-			frc[frclen].unicodep = rune;
</a><a href="#h2-28-594" id="h2-28-594" class="d">-
</a><a href="#h2-28-595" id="h2-28-595" class="d">-			glyphidx = XftCharIndex(xw.dpy, frc[frclen].font, rune);
</a><a href="#h2-28-596" id="h2-28-596" class="d">-
</a><a href="#h2-28-597" id="h2-28-597" class="d">-			f = frclen;
</a><a href="#h2-28-598" id="h2-28-598" class="d">-			frclen++;
</a><a href="#h2-28-599" id="h2-28-599" class="d">-
</a><a href="#h2-28-600" id="h2-28-600" class="d">-			FcPatternDestroy(fcpattern);
</a><a href="#h2-28-601" id="h2-28-601" class="d">-			FcCharSetDestroy(fccharset);
</a><a href="#h2-28-602" id="h2-28-602" class="d">-		}
</a><a href="#h2-28-603" id="h2-28-603" class="d">-
</a><a href="#h2-28-604" id="h2-28-604" class="d">-		specs[numspecs].font = frc[f].font;
</a><a href="#h2-28-605" id="h2-28-605" class="d">-		specs[numspecs].glyph = glyphidx;
</a><a href="#h2-28-606" id="h2-28-606" class="d">-		specs[numspecs].x = (short)xp;
</a><a href="#h2-28-607" id="h2-28-607" class="d">-		specs[numspecs].y = (short)yp;
</a><a href="#h2-28-608" id="h2-28-608" class="d">-		xp += runewidth;
</a><a href="#h2-28-609" id="h2-28-609" class="d">-		numspecs++;
</a><a href="#h2-28-610" id="h2-28-610" class="d">-	}
</a><a href="#h2-28-611" id="h2-28-611" class="d">-
</a><a href="#h2-28-612" id="h2-28-612" class="d">-	return numspecs;
</a><a href="#h2-28-613" id="h2-28-613" class="d">-}
</a><a href="#h2-28-614" id="h2-28-614" class="d">-
</a><a href="#h2-28-615" id="h2-28-615" class="d">-void
</a><a href="#h2-28-616" id="h2-28-616" class="d">-xdrawglyphfontspecs(const XftGlyphFontSpec *specs, Glyph base, int len, int x, int y)
</a><a href="#h2-28-617" id="h2-28-617" class="d">-{
</a><a href="#h2-28-618" id="h2-28-618" class="d">-	int charlen = len * ((base.mode &amp; ATTR_WIDE) ? 2 : 1);
</a><a href="#h2-28-619" id="h2-28-619" class="d">-	int winx = borderpx + x * xw.cw, winy = borderpx + y * xw.ch,
</a><a href="#h2-28-620" id="h2-28-620" class="d">-	    width = charlen * xw.cw;
</a><a href="#h2-28-621" id="h2-28-621" class="d">-	Color *fg, *bg, *temp, revfg, revbg, truefg, truebg;
</a><a href="#h2-28-622" id="h2-28-622" class="d">-	XRenderColor colfg, colbg;
</a><a href="#h2-28-623" id="h2-28-623" class="d">-	XRectangle r;
</a><a href="#h2-28-624" id="h2-28-624" class="d">-
</a><a href="#h2-28-625" id="h2-28-625" class="d">-	/* Fallback on color display for attributes not supported by the font */
</a><a href="#h2-28-626" id="h2-28-626" class="d">-	if (base.mode &amp; ATTR_ITALIC &amp;&amp; base.mode &amp; ATTR_BOLD) {
</a><a href="#h2-28-627" id="h2-28-627" class="d">-		if (dc.ibfont.badslant || dc.ibfont.badweight)
</a><a href="#h2-28-628" id="h2-28-628" class="d">-			base.fg = defaultattr;
</a><a href="#h2-28-629" id="h2-28-629" class="d">-	} else if ((base.mode &amp; ATTR_ITALIC &amp;&amp; dc.ifont.badslant) ||
</a><a href="#h2-28-630" id="h2-28-630" class="d">-	    (base.mode &amp; ATTR_BOLD &amp;&amp; dc.bfont.badweight)) {
</a><a href="#h2-28-631" id="h2-28-631" class="d">-		base.fg = defaultattr;
</a><a href="#h2-28-632" id="h2-28-632" class="d">-	}
</a><a href="#h2-28-633" id="h2-28-633" class="d">-
</a><a href="#h2-28-634" id="h2-28-634" class="d">-	if (IS_TRUECOL(base.fg)) {
</a><a href="#h2-28-635" id="h2-28-635" class="d">-		colfg.alpha = 0xffff;
</a><a href="#h2-28-636" id="h2-28-636" class="d">-		colfg.red = TRUERED(base.fg);
</a><a href="#h2-28-637" id="h2-28-637" class="d">-		colfg.green = TRUEGREEN(base.fg);
</a><a href="#h2-28-638" id="h2-28-638" class="d">-		colfg.blue = TRUEBLUE(base.fg);
</a><a href="#h2-28-639" id="h2-28-639" class="d">-		XftColorAllocValue(xw.dpy, xw.vis, xw.cmap, &amp;colfg, &amp;truefg);
</a><a href="#h2-28-640" id="h2-28-640" class="d">-		fg = &amp;truefg;
</a><a href="#h2-28-641" id="h2-28-641" class="d">-	} else {
</a><a href="#h2-28-642" id="h2-28-642" class="d">-		fg = &amp;dc.col[base.fg];
</a><a href="#h2-28-643" id="h2-28-643" class="d">-	}
</a><a href="#h2-28-644" id="h2-28-644" class="d">-
</a><a href="#h2-28-645" id="h2-28-645" class="d">-	if (IS_TRUECOL(base.bg)) {
</a><a href="#h2-28-646" id="h2-28-646" class="d">-		colbg.alpha = 0xffff;
</a><a href="#h2-28-647" id="h2-28-647" class="d">-		colbg.green = TRUEGREEN(base.bg);
</a><a href="#h2-28-648" id="h2-28-648" class="d">-		colbg.red = TRUERED(base.bg);
</a><a href="#h2-28-649" id="h2-28-649" class="d">-		colbg.blue = TRUEBLUE(base.bg);
</a><a href="#h2-28-650" id="h2-28-650" class="d">-		XftColorAllocValue(xw.dpy, xw.vis, xw.cmap, &amp;colbg, &amp;truebg);
</a><a href="#h2-28-651" id="h2-28-651" class="d">-		bg = &amp;truebg;
</a><a href="#h2-28-652" id="h2-28-652" class="d">-	} else {
</a><a href="#h2-28-653" id="h2-28-653" class="d">-		bg = &amp;dc.col[base.bg];
</a><a href="#h2-28-654" id="h2-28-654" class="d">-	}
</a><a href="#h2-28-655" id="h2-28-655" class="d">-
</a><a href="#h2-28-656" id="h2-28-656" class="d">-	/* Change basic system colors [0-7] to bright system colors [8-15] */
</a><a href="#h2-28-657" id="h2-28-657" class="d">-	if ((base.mode &amp; ATTR_BOLD_FAINT) == ATTR_BOLD &amp;&amp; BETWEEN(base.fg, 0, 7))
</a><a href="#h2-28-658" id="h2-28-658" class="d">-		fg = &amp;dc.col[base.fg + 8];
</a><a href="#h2-28-659" id="h2-28-659" class="d">-
</a><a href="#h2-28-660" id="h2-28-660" class="d">-	if (IS_SET(MODE_REVERSE)) {
</a><a href="#h2-28-661" id="h2-28-661" class="d">-		if (fg == &amp;dc.col[defaultfg]) {
</a><a href="#h2-28-662" id="h2-28-662" class="d">-			fg = &amp;dc.col[defaultbg];
</a><a href="#h2-28-663" id="h2-28-663" class="d">-		} else {
</a><a href="#h2-28-664" id="h2-28-664" class="d">-			colfg.red = ~fg-&gt;color.red;
</a><a href="#h2-28-665" id="h2-28-665" class="d">-			colfg.green = ~fg-&gt;color.green;
</a><a href="#h2-28-666" id="h2-28-666" class="d">-			colfg.blue = ~fg-&gt;color.blue;
</a><a href="#h2-28-667" id="h2-28-667" class="d">-			colfg.alpha = fg-&gt;color.alpha;
</a><a href="#h2-28-668" id="h2-28-668" class="d">-			XftColorAllocValue(xw.dpy, xw.vis, xw.cmap, &amp;colfg,
</a><a href="#h2-28-669" id="h2-28-669" class="d">-					&amp;revfg);
</a><a href="#h2-28-670" id="h2-28-670" class="d">-			fg = &amp;revfg;
</a><a href="#h2-28-671" id="h2-28-671" class="d">-		}
</a><a href="#h2-28-672" id="h2-28-672" class="d">-
</a><a href="#h2-28-673" id="h2-28-673" class="d">-		if (bg == &amp;dc.col[defaultbg]) {
</a><a href="#h2-28-674" id="h2-28-674" class="d">-			bg = &amp;dc.col[defaultfg];
</a><a href="#h2-28-675" id="h2-28-675" class="d">-		} else {
</a><a href="#h2-28-676" id="h2-28-676" class="d">-			colbg.red = ~bg-&gt;color.red;
</a><a href="#h2-28-677" id="h2-28-677" class="d">-			colbg.green = ~bg-&gt;color.green;
</a><a href="#h2-28-678" id="h2-28-678" class="d">-			colbg.blue = ~bg-&gt;color.blue;
</a><a href="#h2-28-679" id="h2-28-679" class="d">-			colbg.alpha = bg-&gt;color.alpha;
</a><a href="#h2-28-680" id="h2-28-680" class="d">-			XftColorAllocValue(xw.dpy, xw.vis, xw.cmap, &amp;colbg,
</a><a href="#h2-28-681" id="h2-28-681" class="d">-					&amp;revbg);
</a><a href="#h2-28-682" id="h2-28-682" class="d">-			bg = &amp;revbg;
</a><a href="#h2-28-683" id="h2-28-683" class="d">-		}
</a><a href="#h2-28-684" id="h2-28-684" class="d">-	}
</a><a href="#h2-28-685" id="h2-28-685" class="d">-
</a><a href="#h2-28-686" id="h2-28-686" class="d">-	if (base.mode &amp; ATTR_REVERSE) {
</a><a href="#h2-28-687" id="h2-28-687" class="d">-		temp = fg;
</a><a href="#h2-28-688" id="h2-28-688" class="d">-		fg = bg;
</a><a href="#h2-28-689" id="h2-28-689" class="d">-		bg = temp;
</a><a href="#h2-28-690" id="h2-28-690" class="d">-	}
</a><a href="#h2-28-691" id="h2-28-691" class="d">-
</a><a href="#h2-28-692" id="h2-28-692" class="d">-	if ((base.mode &amp; ATTR_BOLD_FAINT) == ATTR_FAINT) {
</a><a href="#h2-28-693" id="h2-28-693" class="d">-		colfg.red = fg-&gt;color.red / 2;
</a><a href="#h2-28-694" id="h2-28-694" class="d">-		colfg.green = fg-&gt;color.green / 2;
</a><a href="#h2-28-695" id="h2-28-695" class="d">-		colfg.blue = fg-&gt;color.blue / 2;
</a><a href="#h2-28-696" id="h2-28-696" class="d">-		XftColorAllocValue(xw.dpy, xw.vis, xw.cmap, &amp;colfg, &amp;revfg);
</a><a href="#h2-28-697" id="h2-28-697" class="d">-		fg = &amp;revfg;
</a><a href="#h2-28-698" id="h2-28-698" class="d">-	}
</a><a href="#h2-28-699" id="h2-28-699" class="d">-
</a><a href="#h2-28-700" id="h2-28-700" class="d">-	if (base.mode &amp; ATTR_BLINK &amp;&amp; term.mode &amp; MODE_BLINK)
</a><a href="#h2-28-701" id="h2-28-701" class="d">-		fg = bg;
</a><a href="#h2-28-702" id="h2-28-702" class="d">-
</a><a href="#h2-28-703" id="h2-28-703" class="d">-	if (base.mode &amp; ATTR_INVISIBLE)
</a><a href="#h2-28-704" id="h2-28-704" class="d">-		fg = bg;
</a><a href="#h2-28-705" id="h2-28-705" class="d">-
</a><a href="#h2-28-706" id="h2-28-706" class="d">-	/* Intelligent cleaning up of the borders. */
</a><a href="#h2-28-707" id="h2-28-707" class="d">-	if (x == 0) {
</a><a href="#h2-28-708" id="h2-28-708" class="d">-		xclear(0, (y == 0)? 0 : winy, borderpx,
</a><a href="#h2-28-709" id="h2-28-709" class="d">-			winy + xw.ch + ((y &gt;= term.row-1)? xw.h : 0));
</a><a href="#h2-28-710" id="h2-28-710" class="d">-	}
</a><a href="#h2-28-711" id="h2-28-711" class="d">-	if (x + charlen &gt;= term.col) {
</a><a href="#h2-28-712" id="h2-28-712" class="d">-		xclear(winx + width, (y == 0)? 0 : winy, xw.w,
</a><a href="#h2-28-713" id="h2-28-713" class="d">-			((y &gt;= term.row-1)? xw.h : (winy + xw.ch)));
</a><a href="#h2-28-714" id="h2-28-714" class="d">-	}
</a><a href="#h2-28-715" id="h2-28-715" class="d">-	if (y == 0)
</a><a href="#h2-28-716" id="h2-28-716" class="d">-		xclear(winx, 0, winx + width, borderpx);
</a><a href="#h2-28-717" id="h2-28-717" class="d">-	if (y == term.row-1)
</a><a href="#h2-28-718" id="h2-28-718" class="d">-		xclear(winx, winy + xw.ch, winx + width, xw.h);
</a><a href="#h2-28-719" id="h2-28-719" class="d">-
</a><a href="#h2-28-720" id="h2-28-720" class="d">-	/* Clean up the region we want to draw to. */
</a><a href="#h2-28-721" id="h2-28-721" class="d">-	XftDrawRect(xw.draw, bg, winx, winy, width, xw.ch);
</a><a href="#h2-28-722" id="h2-28-722" class="d">-
</a><a href="#h2-28-723" id="h2-28-723" class="d">-	/* Set the clip region because Xft is sometimes dirty. */
</a><a href="#h2-28-724" id="h2-28-724" class="d">-	r.x = 0;
</a><a href="#h2-28-725" id="h2-28-725" class="d">-	r.y = 0;
</a><a href="#h2-28-726" id="h2-28-726" class="d">-	r.height = xw.ch;
</a><a href="#h2-28-727" id="h2-28-727" class="d">-	r.width = width;
</a><a href="#h2-28-728" id="h2-28-728" class="d">-	XftDrawSetClipRectangles(xw.draw, winx, winy, &amp;r, 1);
</a><a href="#h2-28-729" id="h2-28-729" class="d">-
</a><a href="#h2-28-730" id="h2-28-730" class="d">-	/* Render the glyphs. */
</a><a href="#h2-28-731" id="h2-28-731" class="d">-	XftDrawGlyphFontSpec(xw.draw, fg, specs, len);
</a><a href="#h2-28-732" id="h2-28-732" class="d">-
</a><a href="#h2-28-733" id="h2-28-733" class="d">-	/* Render underline and strikethrough. */
</a><a href="#h2-28-734" id="h2-28-734" class="d">-	if (base.mode &amp; ATTR_UNDERLINE) {
</a><a href="#h2-28-735" id="h2-28-735" class="d">-		XftDrawRect(xw.draw, fg, winx, winy + dc.font.ascent + 1,
</a><a href="#h2-28-736" id="h2-28-736" class="d">-				width, 1);
</a><a href="#h2-28-737" id="h2-28-737" class="d">-	}
</a><a href="#h2-28-738" id="h2-28-738" class="d">-
</a><a href="#h2-28-739" id="h2-28-739" class="d">-	if (base.mode &amp; ATTR_STRUCK) {
</a><a href="#h2-28-740" id="h2-28-740" class="d">-		XftDrawRect(xw.draw, fg, winx, winy + 2 * dc.font.ascent / 3,
</a><a href="#h2-28-741" id="h2-28-741" class="d">-				width, 1);
</a><a href="#h2-28-742" id="h2-28-742" class="d">-	}
</a><a href="#h2-28-743" id="h2-28-743" class="d">-
</a><a href="#h2-28-744" id="h2-28-744" class="d">-	/* Reset clip to none. */
</a><a href="#h2-28-745" id="h2-28-745" class="d">-	XftDrawSetClip(xw.draw, 0);
</a><a href="#h2-28-746" id="h2-28-746" class="d">-}
</a><a href="#h2-28-747" id="h2-28-747" class="d">-
</a><a href="#h2-28-748" id="h2-28-748" class="d">-void
</a><a href="#h2-28-749" id="h2-28-749" class="d">-xdrawglyph(Glyph g, int x, int y)
</a><a href="#h2-28-750" id="h2-28-750" class="d">-{
</a><a href="#h2-28-751" id="h2-28-751" class="d">-	int numspecs;
</a><a href="#h2-28-752" id="h2-28-752" class="d">-	XftGlyphFontSpec spec;
</a><a href="#h2-28-753" id="h2-28-753" class="d">-
</a><a href="#h2-28-754" id="h2-28-754" class="d">-	numspecs = xmakeglyphfontspecs(&amp;spec, &amp;g, 1, x, y);
</a><a href="#h2-28-755" id="h2-28-755" class="d">-	xdrawglyphfontspecs(&amp;spec, g, numspecs, x, y);
</a><a href="#h2-28-756" id="h2-28-756" class="d">-}
</a><a href="#h2-28-757" id="h2-28-757" class="d">-
</a><a href="#h2-28-758" id="h2-28-758" class="d">-void
</a><a href="#h2-28-759" id="h2-28-759" class="d">-xdrawcursor(void)
</a><a href="#h2-28-760" id="h2-28-760" class="d">-{
</a><a href="#h2-28-761" id="h2-28-761" class="d">-	static int oldx = 0, oldy = 0;
</a><a href="#h2-28-762" id="h2-28-762" class="d">-	int curx;
</a><a href="#h2-28-763" id="h2-28-763" class="d">-	Glyph g = {&#39; &#39;, ATTR_NULL, defaultbg, defaultcs}, og;
</a><a href="#h2-28-764" id="h2-28-764" class="d">-	int ena_sel = sel.ob.x != -1 &amp;&amp; sel.alt == IS_SET(MODE_ALTSCREEN);
</a><a href="#h2-28-765" id="h2-28-765" class="d">-	Color drawcol;
</a><a href="#h2-28-766" id="h2-28-766" class="d">-
</a><a href="#h2-28-767" id="h2-28-767" class="d">-	LIMIT(oldx, 0, term.col-1);
</a><a href="#h2-28-768" id="h2-28-768" class="d">-	LIMIT(oldy, 0, term.row-1);
</a><a href="#h2-28-769" id="h2-28-769" class="d">-
</a><a href="#h2-28-770" id="h2-28-770" class="d">-	curx = term.c.x;
</a><a href="#h2-28-771" id="h2-28-771" class="d">-
</a><a href="#h2-28-772" id="h2-28-772" class="d">-	/* adjust position if in dummy */
</a><a href="#h2-28-773" id="h2-28-773" class="d">-	if (term.line[oldy][oldx].mode &amp; ATTR_WDUMMY)
</a><a href="#h2-28-774" id="h2-28-774" class="d">-		oldx--;
</a><a href="#h2-28-775" id="h2-28-775" class="d">-	if (term.line[term.c.y][curx].mode &amp; ATTR_WDUMMY)
</a><a href="#h2-28-776" id="h2-28-776" class="d">-		curx--;
</a><a href="#h2-28-777" id="h2-28-777" class="d">-
</a><a href="#h2-28-778" id="h2-28-778" class="d">-	/* remove the old cursor */
</a><a href="#h2-28-779" id="h2-28-779" class="d">-	og = term.line[oldy][oldx];
</a><a href="#h2-28-780" id="h2-28-780" class="d">-	if (ena_sel &amp;&amp; selected(oldx, oldy))
</a><a href="#h2-28-781" id="h2-28-781" class="d">-		og.mode ^= ATTR_REVERSE;
</a><a href="#h2-28-782" id="h2-28-782" class="d">-	xdrawglyph(og, oldx, oldy);
</a><a href="#h2-28-783" id="h2-28-783" class="d">-
</a><a href="#h2-28-784" id="h2-28-784" class="d">-	g.u = term.line[term.c.y][term.c.x].u;
</a><a href="#h2-28-785" id="h2-28-785" class="d">-
</a><a href="#h2-28-786" id="h2-28-786" class="d">-	/*
</a><a href="#h2-28-787" id="h2-28-787" class="d">-	 * Select the right color for the right mode.
</a><a href="#h2-28-788" id="h2-28-788" class="d">-	 */
</a><a href="#h2-28-789" id="h2-28-789" class="d">-	if (IS_SET(MODE_REVERSE)) {
</a><a href="#h2-28-790" id="h2-28-790" class="d">-		g.mode |= ATTR_REVERSE;
</a><a href="#h2-28-791" id="h2-28-791" class="d">-		g.bg = defaultfg;
</a><a href="#h2-28-792" id="h2-28-792" class="d">-		if (ena_sel &amp;&amp; selected(term.c.x, term.c.y)) {
</a><a href="#h2-28-793" id="h2-28-793" class="d">-			drawcol = dc.col[defaultcs];
</a><a href="#h2-28-794" id="h2-28-794" class="d">-			g.fg = defaultrcs;
</a><a href="#h2-28-795" id="h2-28-795" class="d">-		} else {
</a><a href="#h2-28-796" id="h2-28-796" class="d">-			drawcol = dc.col[defaultrcs];
</a><a href="#h2-28-797" id="h2-28-797" class="d">-			g.fg = defaultcs;
</a><a href="#h2-28-798" id="h2-28-798" class="d">-		}
</a><a href="#h2-28-799" id="h2-28-799" class="d">-	} else {
</a><a href="#h2-28-800" id="h2-28-800" class="d">-		if (ena_sel &amp;&amp; selected(term.c.x, term.c.y)) {
</a><a href="#h2-28-801" id="h2-28-801" class="d">-			drawcol = dc.col[defaultrcs];
</a><a href="#h2-28-802" id="h2-28-802" class="d">-			g.fg = defaultfg;
</a><a href="#h2-28-803" id="h2-28-803" class="d">-			g.bg = defaultrcs;
</a><a href="#h2-28-804" id="h2-28-804" class="d">-		} else {
</a><a href="#h2-28-805" id="h2-28-805" class="d">-			drawcol = dc.col[defaultcs];
</a><a href="#h2-28-806" id="h2-28-806" class="d">-		}
</a><a href="#h2-28-807" id="h2-28-807" class="d">-	}
</a><a href="#h2-28-808" id="h2-28-808" class="d">-
</a><a href="#h2-28-809" id="h2-28-809" class="d">-	if (IS_SET(MODE_HIDE))
</a><a href="#h2-28-810" id="h2-28-810" class="d">-		return;
</a><a href="#h2-28-811" id="h2-28-811" class="d">-
</a><a href="#h2-28-812" id="h2-28-812" class="d">-	/* draw the new one */
</a><a href="#h2-28-813" id="h2-28-813" class="d">-	if (xw.state &amp; WIN_FOCUSED) {
</a><a href="#h2-28-814" id="h2-28-814" class="d">-		switch (xw.cursor) {
</a><a href="#h2-28-815" id="h2-28-815" class="d">-		case 7: /* st extension: snowman */
</a><a href="#h2-28-816" id="h2-28-816" class="d">-			utf8decode(&quot;☃&quot;, &amp;g.u, UTF_SIZ);
</a><a href="#h2-28-817" id="h2-28-817" class="d">-		case 0: /* Blinking Block */
</a><a href="#h2-28-818" id="h2-28-818" class="d">-		case 1: /* Blinking Block (Default) */
</a><a href="#h2-28-819" id="h2-28-819" class="d">-		case 2: /* Steady Block */
</a><a href="#h2-28-820" id="h2-28-820" class="d">-			g.mode |= term.line[term.c.y][curx].mode &amp; ATTR_WIDE;
</a><a href="#h2-28-821" id="h2-28-821" class="d">-			xdrawglyph(g, term.c.x, term.c.y);
</a><a href="#h2-28-822" id="h2-28-822" class="d">-			break;
</a><a href="#h2-28-823" id="h2-28-823" class="d">-		case 3: /* Blinking Underline */
</a><a href="#h2-28-824" id="h2-28-824" class="d">-		case 4: /* Steady Underline */
</a><a href="#h2-28-825" id="h2-28-825" class="d">-			XftDrawRect(xw.draw, &amp;drawcol,
</a><a href="#h2-28-826" id="h2-28-826" class="d">-					borderpx + curx * xw.cw,
</a><a href="#h2-28-827" id="h2-28-827" class="d">-					borderpx + (term.c.y + 1) * xw.ch - \
</a><a href="#h2-28-828" id="h2-28-828" class="d">-						cursorthickness,
</a><a href="#h2-28-829" id="h2-28-829" class="d">-					xw.cw, cursorthickness);
</a><a href="#h2-28-830" id="h2-28-830" class="d">-			break;
</a><a href="#h2-28-831" id="h2-28-831" class="d">-		case 5: /* Blinking bar */
</a><a href="#h2-28-832" id="h2-28-832" class="d">-		case 6: /* Steady bar */
</a><a href="#h2-28-833" id="h2-28-833" class="d">-			XftDrawRect(xw.draw, &amp;drawcol,
</a><a href="#h2-28-834" id="h2-28-834" class="d">-					borderpx + curx * xw.cw,
</a><a href="#h2-28-835" id="h2-28-835" class="d">-					borderpx + term.c.y * xw.ch,
</a><a href="#h2-28-836" id="h2-28-836" class="d">-					cursorthickness, xw.ch);
</a><a href="#h2-28-837" id="h2-28-837" class="d">-			break;
</a><a href="#h2-28-838" id="h2-28-838" class="d">-		}
</a><a href="#h2-28-839" id="h2-28-839" class="d">-	} else {
</a><a href="#h2-28-840" id="h2-28-840" class="d">-		XftDrawRect(xw.draw, &amp;drawcol,
</a><a href="#h2-28-841" id="h2-28-841" class="d">-				borderpx + curx * xw.cw,
</a><a href="#h2-28-842" id="h2-28-842" class="d">-				borderpx + term.c.y * xw.ch,
</a><a href="#h2-28-843" id="h2-28-843" class="d">-				xw.cw - 1, 1);
</a><a href="#h2-28-844" id="h2-28-844" class="d">-		XftDrawRect(xw.draw, &amp;drawcol,
</a><a href="#h2-28-845" id="h2-28-845" class="d">-				borderpx + curx * xw.cw,
</a><a href="#h2-28-846" id="h2-28-846" class="d">-				borderpx + term.c.y * xw.ch,
</a><a href="#h2-28-847" id="h2-28-847" class="d">-				1, xw.ch - 1);
</a><a href="#h2-28-848" id="h2-28-848" class="d">-		XftDrawRect(xw.draw, &amp;drawcol,
</a><a href="#h2-28-849" id="h2-28-849" class="d">-				borderpx + (curx + 1) * xw.cw - 1,
</a><a href="#h2-28-850" id="h2-28-850" class="d">-				borderpx + term.c.y * xw.ch,
</a><a href="#h2-28-851" id="h2-28-851" class="d">-				1, xw.ch - 1);
</a><a href="#h2-28-852" id="h2-28-852" class="d">-		XftDrawRect(xw.draw, &amp;drawcol,
</a><a href="#h2-28-853" id="h2-28-853" class="d">-				borderpx + curx * xw.cw,
</a><a href="#h2-28-854" id="h2-28-854" class="d">-				borderpx + (term.c.y + 1) * xw.ch - 1,
</a><a href="#h2-28-855" id="h2-28-855" class="d">-				xw.cw, 1);
</a><a href="#h2-28-856" id="h2-28-856" class="d">-	}
</a><a href="#h2-28-857" id="h2-28-857" class="d">-	oldx = curx, oldy = term.c.y;
</a><a href="#h2-28-858" id="h2-28-858" class="d">-}
</a><a href="#h2-28-859" id="h2-28-859" class="d">-
</a><a href="#h2-28-860" id="h2-28-860" class="d">-
</a><a href="#h2-28-861" id="h2-28-861" class="d">-void
</a><a href="#h2-28-862" id="h2-28-862" class="d">-xsettitle(char *p)
</a><a href="#h2-28-863" id="h2-28-863" class="d">-{
</a><a href="#h2-28-864" id="h2-28-864" class="d">-	XTextProperty prop;
</a><a href="#h2-28-865" id="h2-28-865" class="d">-
</a><a href="#h2-28-866" id="h2-28-866" class="d">-	Xutf8TextListToTextProperty(xw.dpy, &amp;p, 1, XUTF8StringStyle,
</a><a href="#h2-28-867" id="h2-28-867" class="d">-			&amp;prop);
</a><a href="#h2-28-868" id="h2-28-868" class="d">-	XSetWMName(xw.dpy, xw.win, &amp;prop);
</a><a href="#h2-28-869" id="h2-28-869" class="d">-	XSetTextProperty(xw.dpy, xw.win, &amp;prop, xw.netwmname);
</a><a href="#h2-28-870" id="h2-28-870" class="d">-	XFree(prop.value);
</a><a href="#h2-28-871" id="h2-28-871" class="d">-}
</a><a href="#h2-28-872" id="h2-28-872" class="d">-
</a><a href="#h2-28-873" id="h2-28-873" class="d">-void
</a><a href="#h2-28-874" id="h2-28-874" class="d">-xresettitle(void)
</a><a href="#h2-28-875" id="h2-28-875" class="d">-{
</a><a href="#h2-28-876" id="h2-28-876" class="d">-	xsettitle(opt_title ? opt_title : &quot;st&quot;);
</a><a href="#h2-28-877" id="h2-28-877" class="d">-}
</a><a href="#h2-28-878" id="h2-28-878" class="d">-
</a><a href="#h2-28-879" id="h2-28-879" class="d">-void
</a><a href="#h2-28-880" id="h2-28-880" class="d">-redraw(void)
</a><a href="#h2-28-881" id="h2-28-881" class="d">-{
</a><a href="#h2-28-882" id="h2-28-882" class="d">-	tfulldirt();
</a><a href="#h2-28-883" id="h2-28-883" class="d">-	draw();
</a><a href="#h2-28-884" id="h2-28-884" class="d">-}
</a><a href="#h2-28-885" id="h2-28-885" class="d">-
</a><a href="#h2-28-886" id="h2-28-886" class="d">-void
</a><a href="#h2-28-887" id="h2-28-887" class="d">-draw(void)
</a><a href="#h2-28-888" id="h2-28-888" class="d">-{
</a><a href="#h2-28-889" id="h2-28-889" class="d">-	drawregion(0, 0, term.col, term.row);
</a><a href="#h2-28-890" id="h2-28-890" class="d">-	XCopyArea(xw.dpy, xw.buf, xw.win, dc.gc, 0, 0, xw.w,
</a><a href="#h2-28-891" id="h2-28-891" class="d">-			xw.h, 0, 0);
</a><a href="#h2-28-892" id="h2-28-892" class="d">-	XSetForeground(xw.dpy, dc.gc,
</a><a href="#h2-28-893" id="h2-28-893" class="d">-			dc.col[IS_SET(MODE_REVERSE)?
</a><a href="#h2-28-894" id="h2-28-894" class="d">-				defaultfg : defaultbg].pixel);
</a><a href="#h2-28-895" id="h2-28-895" class="d">-}
</a><a href="#h2-28-896" id="h2-28-896" class="d">-
</a><a href="#h2-28-897" id="h2-28-897" class="d">-void
</a><a href="#h2-28-898" id="h2-28-898" class="d">-drawregion(int x1, int y1, int x2, int y2)
</a><a href="#h2-28-899" id="h2-28-899" class="d">-{
</a><a href="#h2-28-900" id="h2-28-900" class="d">-	int i, x, y, ox, numspecs;
</a><a href="#h2-28-901" id="h2-28-901" class="d">-	Glyph base, new;
</a><a href="#h2-28-902" id="h2-28-902" class="d">-	XftGlyphFontSpec *specs;
</a><a href="#h2-28-903" id="h2-28-903" class="d">-	int ena_sel = sel.ob.x != -1 &amp;&amp; sel.alt == IS_SET(MODE_ALTSCREEN);
</a><a href="#h2-28-904" id="h2-28-904" class="d">-
</a><a href="#h2-28-905" id="h2-28-905" class="d">-	if (!(xw.state &amp; WIN_VISIBLE))
</a><a href="#h2-28-906" id="h2-28-906" class="d">-		return;
</a><a href="#h2-28-907" id="h2-28-907" class="d">-
</a><a href="#h2-28-908" id="h2-28-908" class="d">-	for (y = y1; y &lt; y2; y++) {
</a><a href="#h2-28-909" id="h2-28-909" class="d">-		if (!term.dirty[y])
</a><a href="#h2-28-910" id="h2-28-910" class="d">-			continue;
</a><a href="#h2-28-911" id="h2-28-911" class="d">-
</a><a href="#h2-28-912" id="h2-28-912" class="d">-		term.dirty[y] = 0;
</a><a href="#h2-28-913" id="h2-28-913" class="d">-
</a><a href="#h2-28-914" id="h2-28-914" class="d">-		specs = term.specbuf;
</a><a href="#h2-28-915" id="h2-28-915" class="d">-		numspecs = xmakeglyphfontspecs(specs, &amp;term.line[y][x1], x2 - x1, x1, y);
</a><a href="#h2-28-916" id="h2-28-916" class="d">-
</a><a href="#h2-28-917" id="h2-28-917" class="d">-		i = ox = 0;
</a><a href="#h2-28-918" id="h2-28-918" class="d">-		for (x = x1; x &lt; x2 &amp;&amp; i &lt; numspecs; x++) {
</a><a href="#h2-28-919" id="h2-28-919" class="d">-			new = term.line[y][x];
</a><a href="#h2-28-920" id="h2-28-920" class="d">-			if (new.mode == ATTR_WDUMMY)
</a><a href="#h2-28-921" id="h2-28-921" class="d">-				continue;
</a><a href="#h2-28-922" id="h2-28-922" class="d">-			if (ena_sel &amp;&amp; selected(x, y))
</a><a href="#h2-28-923" id="h2-28-923" class="d">-				new.mode ^= ATTR_REVERSE;
</a><a href="#h2-28-924" id="h2-28-924" class="d">-			if (i &gt; 0 &amp;&amp; ATTRCMP(base, new)) {
</a><a href="#h2-28-925" id="h2-28-925" class="d">-				xdrawglyphfontspecs(specs, base, i, ox, y);
</a><a href="#h2-28-926" id="h2-28-926" class="d">-				specs += i;
</a><a href="#h2-28-927" id="h2-28-927" class="d">-				numspecs -= i;
</a><a href="#h2-28-928" id="h2-28-928" class="d">-				i = 0;
</a><a href="#h2-28-929" id="h2-28-929" class="d">-			}
</a><a href="#h2-28-930" id="h2-28-930" class="d">-			if (i == 0) {
</a><a href="#h2-28-931" id="h2-28-931" class="d">-				ox = x;
</a><a href="#h2-28-932" id="h2-28-932" class="d">-				base = new;
</a><a href="#h2-28-933" id="h2-28-933" class="d">-			}
</a><a href="#h2-28-934" id="h2-28-934" class="d">-			i++;
</a><a href="#h2-28-935" id="h2-28-935" class="d">-		}
</a><a href="#h2-28-936" id="h2-28-936" class="d">-		if (i &gt; 0)
</a><a href="#h2-28-937" id="h2-28-937" class="d">-			xdrawglyphfontspecs(specs, base, i, ox, y);
</a><a href="#h2-28-938" id="h2-28-938" class="d">-	}
</a><a href="#h2-28-939" id="h2-28-939" class="d">-	xdrawcursor();
</a><a href="#h2-28-940" id="h2-28-940" class="d">-}
</a><a href="#h2-28-941" id="h2-28-941" class="d">-
</a><a href="#h2-28-942" id="h2-28-942" class="d">-void
</a><a href="#h2-28-943" id="h2-28-943" class="d">-expose(XEvent *ev)
</a><a href="#h2-28-944" id="h2-28-944" class="d">-{
</a><a href="#h2-28-945" id="h2-28-945" class="d">-	redraw();
</a><a href="#h2-28-946" id="h2-28-946" class="d">-}
</a><a href="#h2-28-947" id="h2-28-947" class="d">-
</a><a href="#h2-28-948" id="h2-28-948" class="d">-void
</a><a href="#h2-28-949" id="h2-28-949" class="d">-visibility(XEvent *ev)
</a><a href="#h2-28-950" id="h2-28-950" class="d">-{
</a><a href="#h2-28-951" id="h2-28-951" class="d">-	XVisibilityEvent *e = &amp;ev-&gt;xvisibility;
</a><a href="#h2-28-952" id="h2-28-952" class="d">-
</a><a href="#h2-28-953" id="h2-28-953" class="d">-	MODBIT(xw.state, e-&gt;state != VisibilityFullyObscured, WIN_VISIBLE);
</a><a href="#h2-28-954" id="h2-28-954" class="d">-}
</a><a href="#h2-28-955" id="h2-28-955" class="d">-
</a><a href="#h2-28-956" id="h2-28-956" class="d">-void
</a><a href="#h2-28-957" id="h2-28-957" class="d">-unmap(XEvent *ev)
</a><a href="#h2-28-958" id="h2-28-958" class="d">-{
</a><a href="#h2-28-959" id="h2-28-959" class="d">-	xw.state &amp;= ~WIN_VISIBLE;
</a><a href="#h2-28-960" id="h2-28-960" class="d">-}
</a><a href="#h2-28-961" id="h2-28-961" class="d">-
</a><a href="#h2-28-962" id="h2-28-962" class="d">-void
</a><a href="#h2-28-963" id="h2-28-963" class="d">-xsetpointermotion(int set)
</a><a href="#h2-28-964" id="h2-28-964" class="d">-{
</a><a href="#h2-28-965" id="h2-28-965" class="d">-	MODBIT(xw.attrs.event_mask, set, PointerMotionMask);
</a><a href="#h2-28-966" id="h2-28-966" class="d">-	XChangeWindowAttributes(xw.dpy, xw.win, CWEventMask, &amp;xw.attrs);
</a><a href="#h2-28-967" id="h2-28-967" class="d">-}
</a><a href="#h2-28-968" id="h2-28-968" class="d">-
</a><a href="#h2-28-969" id="h2-28-969" class="d">-void
</a><a href="#h2-28-970" id="h2-28-970" class="d">-xseturgency(int add)
</a><a href="#h2-28-971" id="h2-28-971" class="d">-{
</a><a href="#h2-28-972" id="h2-28-972" class="d">-	XWMHints *h = XGetWMHints(xw.dpy, xw.win);
</a><a href="#h2-28-973" id="h2-28-973" class="d">-
</a><a href="#h2-28-974" id="h2-28-974" class="d">-	MODBIT(h-&gt;flags, add, XUrgencyHint);
</a><a href="#h2-28-975" id="h2-28-975" class="d">-	XSetWMHints(xw.dpy, xw.win, h);
</a><a href="#h2-28-976" id="h2-28-976" class="d">-	XFree(h);
</a><a href="#h2-28-977" id="h2-28-977" class="d">-}
</a><a href="#h2-28-978" id="h2-28-978" class="d">-
</a><a href="#h2-28-979" id="h2-28-979" class="d">-void
</a><a href="#h2-28-980" id="h2-28-980" class="d">-focus(XEvent *ev)
</a><a href="#h2-28-981" id="h2-28-981" class="d">-{
</a><a href="#h2-28-982" id="h2-28-982" class="d">-	XFocusChangeEvent *e = &amp;ev-&gt;xfocus;
</a><a href="#h2-28-983" id="h2-28-983" class="d">-
</a><a href="#h2-28-984" id="h2-28-984" class="d">-	if (e-&gt;mode == NotifyGrab)
</a><a href="#h2-28-985" id="h2-28-985" class="d">-		return;
</a><a href="#h2-28-986" id="h2-28-986" class="d">-
</a><a href="#h2-28-987" id="h2-28-987" class="d">-	if (ev-&gt;type == FocusIn) {
</a><a href="#h2-28-988" id="h2-28-988" class="d">-		XSetICFocus(xw.xic);
</a><a href="#h2-28-989" id="h2-28-989" class="d">-		xw.state |= WIN_FOCUSED;
</a><a href="#h2-28-990" id="h2-28-990" class="d">-		xseturgency(0);
</a><a href="#h2-28-991" id="h2-28-991" class="d">-		if (IS_SET(MODE_FOCUS))
</a><a href="#h2-28-992" id="h2-28-992" class="d">-			ttywrite(&quot;\033[I&quot;, 3);
</a><a href="#h2-28-993" id="h2-28-993" class="d">-	} else {
</a><a href="#h2-28-994" id="h2-28-994" class="d">-		XUnsetICFocus(xw.xic);
</a><a href="#h2-28-995" id="h2-28-995" class="d">-		xw.state &amp;= ~WIN_FOCUSED;
</a><a href="#h2-28-996" id="h2-28-996" class="d">-		if (IS_SET(MODE_FOCUS))
</a><a href="#h2-28-997" id="h2-28-997" class="d">-			ttywrite(&quot;\033[O&quot;, 3);
</a><a href="#h2-28-998" id="h2-28-998" class="d">-	}
</a><a href="#h2-28-999" id="h2-28-999" class="d">-}
</a><a href="#h2-28-1000" id="h2-28-1000" class="d">-
</a><a href="#h2-28-1001" id="h2-28-1001" class="d">-int
</a><a href="#h2-28-1002" id="h2-28-1002" class="d">-match(uint mask, uint state)
</a><a href="#h2-28-1003" id="h2-28-1003" class="d">-{
</a><a href="#h2-28-1004" id="h2-28-1004" class="d">-	return mask == XK_ANY_MOD || mask == (state &amp; ~ignoremod);
</a><a href="#h2-28-1005" id="h2-28-1005" class="d">-}
</a><a href="#h2-28-1006" id="h2-28-1006" class="d">-
</a><a href="#h2-28-1007" id="h2-28-1007" class="d">-void
</a><a href="#h2-28-1008" id="h2-28-1008" class="d">-numlock(const Arg *dummy)
</a><a href="#h2-28-1009" id="h2-28-1009" class="d">-{
</a><a href="#h2-28-1010" id="h2-28-1010" class="d">-	term.numlock ^= 1;
</a><a href="#h2-28-1011" id="h2-28-1011" class="d">-}
</a><a href="#h2-28-1012" id="h2-28-1012" class="d">-
</a><a href="#h2-28-1013" id="h2-28-1013" class="d">-char*
</a><a href="#h2-28-1014" id="h2-28-1014" class="d">-kmap(KeySym k, uint state)
</a><a href="#h2-28-1015" id="h2-28-1015" class="d">-{
</a><a href="#h2-28-1016" id="h2-28-1016" class="d">-	Key *kp;
</a><a href="#h2-28-1017" id="h2-28-1017" class="d">-	int i;
</a><a href="#h2-28-1018" id="h2-28-1018" class="i">+char*
</a><a href="#h2-28-1019" id="h2-28-1019" class="i">+kmap(KeySym k, uint state)
</a><a href="#h2-28-1020" id="h2-28-1020" class="i">+{
</a><a href="#h2-28-1021" id="h2-28-1021" class="i">+	Key *kp;
</a><a href="#h2-28-1022" id="h2-28-1022" class="i">+	int i;
</a> 
 	/* Check for mapped keys out of X11 function keys. */
 	for (i = 0; i &lt; LEN(mappedkeys); i++) {
<a href="#h2-29" id="h2-29" class="h">@@ -4251,211 +2612,23 @@ kmap(KeySym k, uint state)
</a> }
 
 void
<a href="#h2-29-3" id="h2-29-3" class="d">-kpress(XEvent *ev)
</a><a href="#h2-29-4" id="h2-29-4" class="d">-{
</a><a href="#h2-29-5" id="h2-29-5" class="d">-	XKeyEvent *e = &amp;ev-&gt;xkey;
</a><a href="#h2-29-6" id="h2-29-6" class="d">-	KeySym ksym;
</a><a href="#h2-29-7" id="h2-29-7" class="d">-	char buf[32], *customkey;
</a><a href="#h2-29-8" id="h2-29-8" class="d">-	int len;
</a><a href="#h2-29-9" id="h2-29-9" class="d">-	Rune c;
</a><a href="#h2-29-10" id="h2-29-10" class="d">-	Status status;
</a><a href="#h2-29-11" id="h2-29-11" class="d">-	Shortcut *bp;
</a><a href="#h2-29-12" id="h2-29-12" class="d">-
</a><a href="#h2-29-13" id="h2-29-13" class="d">-	if (IS_SET(MODE_KBDLOCK))
</a><a href="#h2-29-14" id="h2-29-14" class="d">-		return;
</a><a href="#h2-29-15" id="h2-29-15" class="d">-
</a><a href="#h2-29-16" id="h2-29-16" class="d">-	len = XmbLookupString(xw.xic, e, buf, sizeof buf, &amp;ksym, &amp;status);
</a><a href="#h2-29-17" id="h2-29-17" class="d">-	/* 1. shortcuts */
</a><a href="#h2-29-18" id="h2-29-18" class="d">-	for (bp = shortcuts; bp &lt; shortcuts + LEN(shortcuts); bp++) {
</a><a href="#h2-29-19" id="h2-29-19" class="d">-		if (ksym == bp-&gt;keysym &amp;&amp; match(bp-&gt;mod, e-&gt;state)) {
</a><a href="#h2-29-20" id="h2-29-20" class="d">-			bp-&gt;func(&amp;(bp-&gt;arg));
</a><a href="#h2-29-21" id="h2-29-21" class="d">-			return;
</a><a href="#h2-29-22" id="h2-29-22" class="d">-		}
</a><a href="#h2-29-23" id="h2-29-23" class="d">-	}
</a><a href="#h2-29-24" id="h2-29-24" class="d">-
</a><a href="#h2-29-25" id="h2-29-25" class="d">-	/* 2. custom keys from config.h */
</a><a href="#h2-29-26" id="h2-29-26" class="d">-	if ((customkey = kmap(ksym, e-&gt;state))) {
</a><a href="#h2-29-27" id="h2-29-27" class="d">-		ttysend(customkey, strlen(customkey));
</a><a href="#h2-29-28" id="h2-29-28" class="d">-		return;
</a><a href="#h2-29-29" id="h2-29-29" class="d">-	}
</a><a href="#h2-29-30" id="h2-29-30" class="d">-
</a><a href="#h2-29-31" id="h2-29-31" class="d">-	/* 3. composed string from input method */
</a><a href="#h2-29-32" id="h2-29-32" class="d">-	if (len == 0)
</a><a href="#h2-29-33" id="h2-29-33" class="d">-		return;
</a><a href="#h2-29-34" id="h2-29-34" class="d">-	if (len == 1 &amp;&amp; e-&gt;state &amp; Mod1Mask) {
</a><a href="#h2-29-35" id="h2-29-35" class="d">-		if (IS_SET(MODE_8BIT)) {
</a><a href="#h2-29-36" id="h2-29-36" class="d">-			if (*buf &lt; 0177) {
</a><a href="#h2-29-37" id="h2-29-37" class="d">-				c = *buf | 0x80;
</a><a href="#h2-29-38" id="h2-29-38" class="d">-				len = utf8encode(c, buf);
</a><a href="#h2-29-39" id="h2-29-39" class="d">-			}
</a><a href="#h2-29-40" id="h2-29-40" class="d">-		} else {
</a><a href="#h2-29-41" id="h2-29-41" class="d">-			buf[1] = buf[0];
</a><a href="#h2-29-42" id="h2-29-42" class="d">-			buf[0] = &#39;\033&#39;;
</a><a href="#h2-29-43" id="h2-29-43" class="d">-			len = 2;
</a><a href="#h2-29-44" id="h2-29-44" class="d">-		}
</a><a href="#h2-29-45" id="h2-29-45" class="d">-	}
</a><a href="#h2-29-46" id="h2-29-46" class="d">-	ttysend(buf, len);
</a><a href="#h2-29-47" id="h2-29-47" class="d">-}
</a><a href="#h2-29-48" id="h2-29-48" class="d">-
</a><a href="#h2-29-49" id="h2-29-49" class="d">-
</a><a href="#h2-29-50" id="h2-29-50" class="d">-void
</a><a href="#h2-29-51" id="h2-29-51" class="d">-cmessage(XEvent *e)
</a><a href="#h2-29-52" id="h2-29-52" class="d">-{
</a><a href="#h2-29-53" id="h2-29-53" class="d">-	/*
</a><a href="#h2-29-54" id="h2-29-54" class="d">-	 * See xembed specs
</a><a href="#h2-29-55" id="h2-29-55" class="d">-	 *  http://standards.freedesktop.org/xembed-spec/xembed-spec-latest.html
</a><a href="#h2-29-56" id="h2-29-56" class="d">-	 */
</a><a href="#h2-29-57" id="h2-29-57" class="d">-	if (e-&gt;xclient.message_type == xw.xembed &amp;&amp; e-&gt;xclient.format == 32) {
</a><a href="#h2-29-58" id="h2-29-58" class="d">-		if (e-&gt;xclient.data.l[1] == XEMBED_FOCUS_IN) {
</a><a href="#h2-29-59" id="h2-29-59" class="d">-			xw.state |= WIN_FOCUSED;
</a><a href="#h2-29-60" id="h2-29-60" class="d">-			xseturgency(0);
</a><a href="#h2-29-61" id="h2-29-61" class="d">-		} else if (e-&gt;xclient.data.l[1] == XEMBED_FOCUS_OUT) {
</a><a href="#h2-29-62" id="h2-29-62" class="d">-			xw.state &amp;= ~WIN_FOCUSED;
</a><a href="#h2-29-63" id="h2-29-63" class="d">-		}
</a><a href="#h2-29-64" id="h2-29-64" class="d">-	} else if (e-&gt;xclient.data.l[0] == xw.wmdeletewin) {
</a><a href="#h2-29-65" id="h2-29-65" class="d">-		/* Send SIGHUP to shell */
</a><a href="#h2-29-66" id="h2-29-66" class="d">-		kill(pid, SIGHUP);
</a><a href="#h2-29-67" id="h2-29-67" class="d">-		exit(0);
</a><a href="#h2-29-68" id="h2-29-68" class="d">-	}
</a><a href="#h2-29-69" id="h2-29-69" class="d">-}
</a><a href="#h2-29-70" id="h2-29-70" class="d">-
</a><a href="#h2-29-71" id="h2-29-71" class="d">-void
</a> cresize(int width, int height)
 {
 	int col, row;
 
 	if (width != 0)
<a href="#h2-29-77" id="h2-29-77" class="d">-		xw.w = width;
</a><a href="#h2-29-78" id="h2-29-78" class="i">+		win.w = width;
</a> 	if (height != 0)
<a href="#h2-29-80" id="h2-29-80" class="d">-		xw.h = height;
</a><a href="#h2-29-81" id="h2-29-81" class="i">+		win.h = height;
</a> 
<a href="#h2-29-83" id="h2-29-83" class="d">-	col = (xw.w - 2 * borderpx) / xw.cw;
</a><a href="#h2-29-84" id="h2-29-84" class="d">-	row = (xw.h - 2 * borderpx) / xw.ch;
</a><a href="#h2-29-85" id="h2-29-85" class="i">+	col = (win.w - 2 * borderpx) / win.cw;
</a><a href="#h2-29-86" id="h2-29-86" class="i">+	row = (win.h - 2 * borderpx) / win.ch;
</a> 
 	tresize(col, row);
 	xresize(col, row);
 }
 
 void
<a href="#h2-29-93" id="h2-29-93" class="d">-resize(XEvent *e)
</a><a href="#h2-29-94" id="h2-29-94" class="d">-{
</a><a href="#h2-29-95" id="h2-29-95" class="d">-	if (e-&gt;xconfigure.width == xw.w &amp;&amp; e-&gt;xconfigure.height == xw.h)
</a><a href="#h2-29-96" id="h2-29-96" class="d">-		return;
</a><a href="#h2-29-97" id="h2-29-97" class="d">-
</a><a href="#h2-29-98" id="h2-29-98" class="d">-	cresize(e-&gt;xconfigure.width, e-&gt;xconfigure.height);
</a><a href="#h2-29-99" id="h2-29-99" class="d">-	ttyresize();
</a><a href="#h2-29-100" id="h2-29-100" class="d">-}
</a><a href="#h2-29-101" id="h2-29-101" class="d">-
</a><a href="#h2-29-102" id="h2-29-102" class="d">-void
</a><a href="#h2-29-103" id="h2-29-103" class="d">-run(void)
</a><a href="#h2-29-104" id="h2-29-104" class="d">-{
</a><a href="#h2-29-105" id="h2-29-105" class="d">-	XEvent ev;
</a><a href="#h2-29-106" id="h2-29-106" class="d">-	int w = xw.w, h = xw.h;
</a><a href="#h2-29-107" id="h2-29-107" class="d">-	fd_set rfd;
</a><a href="#h2-29-108" id="h2-29-108" class="d">-	int xfd = XConnectionNumber(xw.dpy), xev, blinkset = 0, dodraw = 0;
</a><a href="#h2-29-109" id="h2-29-109" class="d">-	struct timespec drawtimeout, *tv = NULL, now, last, lastblink;
</a><a href="#h2-29-110" id="h2-29-110" class="d">-	long deltatime;
</a><a href="#h2-29-111" id="h2-29-111" class="d">-
</a><a href="#h2-29-112" id="h2-29-112" class="d">-	/* Waiting for window mapping */
</a><a href="#h2-29-113" id="h2-29-113" class="d">-	do {
</a><a href="#h2-29-114" id="h2-29-114" class="d">-		XNextEvent(xw.dpy, &amp;ev);
</a><a href="#h2-29-115" id="h2-29-115" class="d">-		/*
</a><a href="#h2-29-116" id="h2-29-116" class="d">-		 * This XFilterEvent call is required because of XOpenIM. It
</a><a href="#h2-29-117" id="h2-29-117" class="d">-		 * does filter out the key event and some client message for
</a><a href="#h2-29-118" id="h2-29-118" class="d">-		 * the input method too.
</a><a href="#h2-29-119" id="h2-29-119" class="d">-		 */
</a><a href="#h2-29-120" id="h2-29-120" class="d">-		if (XFilterEvent(&amp;ev, None))
</a><a href="#h2-29-121" id="h2-29-121" class="d">-			continue;
</a><a href="#h2-29-122" id="h2-29-122" class="d">-		if (ev.type == ConfigureNotify) {
</a><a href="#h2-29-123" id="h2-29-123" class="d">-			w = ev.xconfigure.width;
</a><a href="#h2-29-124" id="h2-29-124" class="d">-			h = ev.xconfigure.height;
</a><a href="#h2-29-125" id="h2-29-125" class="d">-		}
</a><a href="#h2-29-126" id="h2-29-126" class="d">-	} while (ev.type != MapNotify);
</a><a href="#h2-29-127" id="h2-29-127" class="d">-
</a><a href="#h2-29-128" id="h2-29-128" class="d">-	cresize(w, h);
</a><a href="#h2-29-129" id="h2-29-129" class="d">-	ttynew();
</a><a href="#h2-29-130" id="h2-29-130" class="d">-	ttyresize();
</a><a href="#h2-29-131" id="h2-29-131" class="d">-
</a><a href="#h2-29-132" id="h2-29-132" class="d">-	clock_gettime(CLOCK_MONOTONIC, &amp;last);
</a><a href="#h2-29-133" id="h2-29-133" class="d">-	lastblink = last;
</a><a href="#h2-29-134" id="h2-29-134" class="d">-
</a><a href="#h2-29-135" id="h2-29-135" class="d">-	for (xev = actionfps;;) {
</a><a href="#h2-29-136" id="h2-29-136" class="d">-		FD_ZERO(&amp;rfd);
</a><a href="#h2-29-137" id="h2-29-137" class="d">-		FD_SET(cmdfd, &amp;rfd);
</a><a href="#h2-29-138" id="h2-29-138" class="d">-		FD_SET(xfd, &amp;rfd);
</a><a href="#h2-29-139" id="h2-29-139" class="d">-
</a><a href="#h2-29-140" id="h2-29-140" class="d">-		if (pselect(MAX(xfd, cmdfd)+1, &amp;rfd, NULL, NULL, tv, NULL) &lt; 0) {
</a><a href="#h2-29-141" id="h2-29-141" class="d">-			if (errno == EINTR)
</a><a href="#h2-29-142" id="h2-29-142" class="d">-				continue;
</a><a href="#h2-29-143" id="h2-29-143" class="d">-			die(&quot;select failed: %s\n&quot;, strerror(errno));
</a><a href="#h2-29-144" id="h2-29-144" class="d">-		}
</a><a href="#h2-29-145" id="h2-29-145" class="d">-		if (FD_ISSET(cmdfd, &amp;rfd)) {
</a><a href="#h2-29-146" id="h2-29-146" class="d">-			ttyread();
</a><a href="#h2-29-147" id="h2-29-147" class="d">-			if (blinktimeout) {
</a><a href="#h2-29-148" id="h2-29-148" class="d">-				blinkset = tattrset(ATTR_BLINK);
</a><a href="#h2-29-149" id="h2-29-149" class="d">-				if (!blinkset)
</a><a href="#h2-29-150" id="h2-29-150" class="d">-					MODBIT(term.mode, 0, MODE_BLINK);
</a><a href="#h2-29-151" id="h2-29-151" class="d">-			}
</a><a href="#h2-29-152" id="h2-29-152" class="d">-		}
</a><a href="#h2-29-153" id="h2-29-153" class="d">-
</a><a href="#h2-29-154" id="h2-29-154" class="d">-		if (FD_ISSET(xfd, &amp;rfd))
</a><a href="#h2-29-155" id="h2-29-155" class="d">-			xev = actionfps;
</a><a href="#h2-29-156" id="h2-29-156" class="d">-
</a><a href="#h2-29-157" id="h2-29-157" class="d">-		clock_gettime(CLOCK_MONOTONIC, &amp;now);
</a><a href="#h2-29-158" id="h2-29-158" class="d">-		drawtimeout.tv_sec = 0;
</a><a href="#h2-29-159" id="h2-29-159" class="d">-		drawtimeout.tv_nsec =  (1000 * 1E6)/ xfps;
</a><a href="#h2-29-160" id="h2-29-160" class="d">-		tv = &amp;drawtimeout;
</a><a href="#h2-29-161" id="h2-29-161" class="d">-
</a><a href="#h2-29-162" id="h2-29-162" class="d">-		dodraw = 0;
</a><a href="#h2-29-163" id="h2-29-163" class="d">-		if (blinktimeout &amp;&amp; TIMEDIFF(now, lastblink) &gt; blinktimeout) {
</a><a href="#h2-29-164" id="h2-29-164" class="d">-			tsetdirtattr(ATTR_BLINK);
</a><a href="#h2-29-165" id="h2-29-165" class="d">-			term.mode ^= MODE_BLINK;
</a><a href="#h2-29-166" id="h2-29-166" class="d">-			lastblink = now;
</a><a href="#h2-29-167" id="h2-29-167" class="d">-			dodraw = 1;
</a><a href="#h2-29-168" id="h2-29-168" class="d">-		}
</a><a href="#h2-29-169" id="h2-29-169" class="d">-		deltatime = TIMEDIFF(now, last);
</a><a href="#h2-29-170" id="h2-29-170" class="d">-		if (deltatime &gt; 1000 / (xev ? xfps : actionfps)) {
</a><a href="#h2-29-171" id="h2-29-171" class="d">-			dodraw = 1;
</a><a href="#h2-29-172" id="h2-29-172" class="d">-			last = now;
</a><a href="#h2-29-173" id="h2-29-173" class="d">-		}
</a><a href="#h2-29-174" id="h2-29-174" class="d">-
</a><a href="#h2-29-175" id="h2-29-175" class="d">-		if (dodraw) {
</a><a href="#h2-29-176" id="h2-29-176" class="d">-			while (XPending(xw.dpy)) {
</a><a href="#h2-29-177" id="h2-29-177" class="d">-				XNextEvent(xw.dpy, &amp;ev);
</a><a href="#h2-29-178" id="h2-29-178" class="d">-				if (XFilterEvent(&amp;ev, None))
</a><a href="#h2-29-179" id="h2-29-179" class="d">-					continue;
</a><a href="#h2-29-180" id="h2-29-180" class="d">-				if (handler[ev.type])
</a><a href="#h2-29-181" id="h2-29-181" class="d">-					(handler[ev.type])(&amp;ev);
</a><a href="#h2-29-182" id="h2-29-182" class="d">-			}
</a><a href="#h2-29-183" id="h2-29-183" class="d">-
</a><a href="#h2-29-184" id="h2-29-184" class="d">-			draw();
</a><a href="#h2-29-185" id="h2-29-185" class="d">-			XFlush(xw.dpy);
</a><a href="#h2-29-186" id="h2-29-186" class="d">-
</a><a href="#h2-29-187" id="h2-29-187" class="d">-			if (xev &amp;&amp; !FD_ISSET(xfd, &amp;rfd))
</a><a href="#h2-29-188" id="h2-29-188" class="d">-				xev--;
</a><a href="#h2-29-189" id="h2-29-189" class="d">-			if (!FD_ISSET(cmdfd, &amp;rfd) &amp;&amp; !FD_ISSET(xfd, &amp;rfd)) {
</a><a href="#h2-29-190" id="h2-29-190" class="d">-				if (blinkset) {
</a><a href="#h2-29-191" id="h2-29-191" class="d">-					if (TIMEDIFF(now, lastblink) \
</a><a href="#h2-29-192" id="h2-29-192" class="d">-							&gt; blinktimeout) {
</a><a href="#h2-29-193" id="h2-29-193" class="d">-						drawtimeout.tv_nsec = 1000;
</a><a href="#h2-29-194" id="h2-29-194" class="d">-					} else {
</a><a href="#h2-29-195" id="h2-29-195" class="d">-						drawtimeout.tv_nsec = (1E6 * \
</a><a href="#h2-29-196" id="h2-29-196" class="d">-							(blinktimeout - \
</a><a href="#h2-29-197" id="h2-29-197" class="d">-							TIMEDIFF(now,
</a><a href="#h2-29-198" id="h2-29-198" class="d">-								lastblink)));
</a><a href="#h2-29-199" id="h2-29-199" class="d">-					}
</a><a href="#h2-29-200" id="h2-29-200" class="d">-					drawtimeout.tv_sec = \
</a><a href="#h2-29-201" id="h2-29-201" class="d">-					    drawtimeout.tv_nsec / 1E9;
</a><a href="#h2-29-202" id="h2-29-202" class="d">-					drawtimeout.tv_nsec %= (long)1E9;
</a><a href="#h2-29-203" id="h2-29-203" class="d">-				} else {
</a><a href="#h2-29-204" id="h2-29-204" class="d">-					tv = NULL;
</a><a href="#h2-29-205" id="h2-29-205" class="d">-				}
</a><a href="#h2-29-206" id="h2-29-206" class="d">-			}
</a><a href="#h2-29-207" id="h2-29-207" class="d">-		}
</a><a href="#h2-29-208" id="h2-29-208" class="d">-	}
</a><a href="#h2-29-209" id="h2-29-209" class="d">-}
</a><a href="#h2-29-210" id="h2-29-210" class="d">-
</a><a href="#h2-29-211" id="h2-29-211" class="d">-void
</a> usage(void)
 {
 	die(&quot;usage: %s [-aiv] [-c class] [-f font] [-g geometry]&quot;
<a href="#h2-30" id="h2-30" class="h">@@ -4467,72 +2640,3 @@ usage(void)
</a> 	    &quot;          [-T title] [-t title] [-w windowid] -l line&quot;
 	    &quot; [stty_args ...]\n&quot;, argv0, argv0);
 }
<a href="#h2-30-3" id="h2-30-3" class="d">-
</a><a href="#h2-30-4" id="h2-30-4" class="d">-int
</a><a href="#h2-30-5" id="h2-30-5" class="d">-main(int argc, char *argv[])
</a><a href="#h2-30-6" id="h2-30-6" class="d">-{
</a><a href="#h2-30-7" id="h2-30-7" class="d">-	xw.l = xw.t = 0;
</a><a href="#h2-30-8" id="h2-30-8" class="d">-	xw.isfixed = False;
</a><a href="#h2-30-9" id="h2-30-9" class="d">-	xw.cursor = cursorshape;
</a><a href="#h2-30-10" id="h2-30-10" class="d">-
</a><a href="#h2-30-11" id="h2-30-11" class="d">-	ARGBEGIN {
</a><a href="#h2-30-12" id="h2-30-12" class="d">-	case &#39;a&#39;:
</a><a href="#h2-30-13" id="h2-30-13" class="d">-		allowaltscreen = 0;
</a><a href="#h2-30-14" id="h2-30-14" class="d">-		break;
</a><a href="#h2-30-15" id="h2-30-15" class="d">-	case &#39;c&#39;:
</a><a href="#h2-30-16" id="h2-30-16" class="d">-		opt_class = EARGF(usage());
</a><a href="#h2-30-17" id="h2-30-17" class="d">-		break;
</a><a href="#h2-30-18" id="h2-30-18" class="d">-	case &#39;e&#39;:
</a><a href="#h2-30-19" id="h2-30-19" class="d">-		if (argc &gt; 0)
</a><a href="#h2-30-20" id="h2-30-20" class="d">-			--argc, ++argv;
</a><a href="#h2-30-21" id="h2-30-21" class="d">-		goto run;
</a><a href="#h2-30-22" id="h2-30-22" class="d">-	case &#39;f&#39;:
</a><a href="#h2-30-23" id="h2-30-23" class="d">-		opt_font = EARGF(usage());
</a><a href="#h2-30-24" id="h2-30-24" class="d">-		break;
</a><a href="#h2-30-25" id="h2-30-25" class="d">-	case &#39;g&#39;:
</a><a href="#h2-30-26" id="h2-30-26" class="d">-		xw.gm = XParseGeometry(EARGF(usage()),
</a><a href="#h2-30-27" id="h2-30-27" class="d">-				&amp;xw.l, &amp;xw.t, &amp;cols, &amp;rows);
</a><a href="#h2-30-28" id="h2-30-28" class="d">-		break;
</a><a href="#h2-30-29" id="h2-30-29" class="d">-	case &#39;i&#39;:
</a><a href="#h2-30-30" id="h2-30-30" class="d">-		xw.isfixed = 1;
</a><a href="#h2-30-31" id="h2-30-31" class="d">-		break;
</a><a href="#h2-30-32" id="h2-30-32" class="d">-	case &#39;o&#39;:
</a><a href="#h2-30-33" id="h2-30-33" class="d">-		opt_io = EARGF(usage());
</a><a href="#h2-30-34" id="h2-30-34" class="d">-		break;
</a><a href="#h2-30-35" id="h2-30-35" class="d">-	case &#39;l&#39;:
</a><a href="#h2-30-36" id="h2-30-36" class="d">-		opt_line = EARGF(usage());
</a><a href="#h2-30-37" id="h2-30-37" class="d">-		break;
</a><a href="#h2-30-38" id="h2-30-38" class="d">-	case &#39;n&#39;:
</a><a href="#h2-30-39" id="h2-30-39" class="d">-		opt_name = EARGF(usage());
</a><a href="#h2-30-40" id="h2-30-40" class="d">-		break;
</a><a href="#h2-30-41" id="h2-30-41" class="d">-	case &#39;t&#39;:
</a><a href="#h2-30-42" id="h2-30-42" class="d">-	case &#39;T&#39;:
</a><a href="#h2-30-43" id="h2-30-43" class="d">-		opt_title = EARGF(usage());
</a><a href="#h2-30-44" id="h2-30-44" class="d">-		break;
</a><a href="#h2-30-45" id="h2-30-45" class="d">-	case &#39;w&#39;:
</a><a href="#h2-30-46" id="h2-30-46" class="d">-		opt_embed = EARGF(usage());
</a><a href="#h2-30-47" id="h2-30-47" class="d">-		break;
</a><a href="#h2-30-48" id="h2-30-48" class="d">-	case &#39;v&#39;:
</a><a href="#h2-30-49" id="h2-30-49" class="d">-		die(&quot;%s &quot; VERSION &quot; (c) 2010-2016 st engineers\n&quot;, argv0);
</a><a href="#h2-30-50" id="h2-30-50" class="d">-		break;
</a><a href="#h2-30-51" id="h2-30-51" class="d">-	default:
</a><a href="#h2-30-52" id="h2-30-52" class="d">-		usage();
</a><a href="#h2-30-53" id="h2-30-53" class="d">-	} ARGEND;
</a><a href="#h2-30-54" id="h2-30-54" class="d">-
</a><a href="#h2-30-55" id="h2-30-55" class="d">-run:
</a><a href="#h2-30-56" id="h2-30-56" class="d">-	if (argc &gt; 0) {
</a><a href="#h2-30-57" id="h2-30-57" class="d">-		/* eat all remaining arguments */
</a><a href="#h2-30-58" id="h2-30-58" class="d">-		opt_cmd = argv;
</a><a href="#h2-30-59" id="h2-30-59" class="d">-		if (!opt_title &amp;&amp; !opt_line)
</a><a href="#h2-30-60" id="h2-30-60" class="d">-			opt_title = basename(xstrdup(argv[0]));
</a><a href="#h2-30-61" id="h2-30-61" class="d">-	}
</a><a href="#h2-30-62" id="h2-30-62" class="d">-	setlocale(LC_CTYPE, &quot;&quot;);
</a><a href="#h2-30-63" id="h2-30-63" class="d">-	XSetLocaleModifiers(&quot;&quot;);
</a><a href="#h2-30-64" id="h2-30-64" class="d">-	tnew(MAX(cols, 1), MAX(rows, 1));
</a><a href="#h2-30-65" id="h2-30-65" class="d">-	xinit();
</a><a href="#h2-30-66" id="h2-30-66" class="d">-	selinit();
</a><a href="#h2-30-67" id="h2-30-67" class="d">-	run();
</a><a href="#h2-30-68" id="h2-30-68" class="d">-
</a><a href="#h2-30-69" id="h2-30-69" class="d">-	return 0;
</a><a href="#h2-30-70" id="h2-30-70" class="d">-}
</a><a href="#h2-30-71" id="h2-30-71" class="d">-
</a><b>diff --git a/<a id="h3" href="../file/st.h.html">st.h</a> b/<a href="../file/st.h.html">st.h</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,272 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+/* See LICENSE for license details. */
</a><a href="#h3-0-1" id="h3-0-1" class="i">+
</a><a href="#h3-0-2" id="h3-0-2" class="i">+/* Arbitrary sizes */
</a><a href="#h3-0-3" id="h3-0-3" class="i">+#define UTF_SIZ       4
</a><a href="#h3-0-4" id="h3-0-4" class="i">+
</a><a href="#h3-0-5" id="h3-0-5" class="i">+/* macros */
</a><a href="#h3-0-6" id="h3-0-6" class="i">+#define MIN(a, b)		((a) &lt; (b) ? (a) : (b))
</a><a href="#h3-0-7" id="h3-0-7" class="i">+#define MAX(a, b)		((a) &lt; (b) ? (b) : (a))
</a><a href="#h3-0-8" id="h3-0-8" class="i">+#define LEN(a)			(sizeof(a) / sizeof(a)[0])
</a><a href="#h3-0-9" id="h3-0-9" class="i">+#define BETWEEN(x, a, b)	((a) &lt;= (x) &amp;&amp; (x) &lt;= (b))
</a><a href="#h3-0-10" id="h3-0-10" class="i">+#define DIVCEIL(n, d)		(((n) + ((d) - 1)) / (d))
</a><a href="#h3-0-11" id="h3-0-11" class="i">+#define LIMIT(x, a, b)		(x) = (x) &lt; (a) ? (a) : (x) &gt; (b) ? (b) : (x)
</a><a href="#h3-0-12" id="h3-0-12" class="i">+#define ATTRCMP(a, b)		((a).mode != (b).mode || (a).fg != (b).fg || \
</a><a href="#h3-0-13" id="h3-0-13" class="i">+				(a).bg != (b).bg)
</a><a href="#h3-0-14" id="h3-0-14" class="i">+#define IS_SET(flag)		((term.mode &amp; (flag)) != 0)
</a><a href="#h3-0-15" id="h3-0-15" class="i">+#define TIMEDIFF(t1, t2)	((t1.tv_sec-t2.tv_sec)*1000 + \
</a><a href="#h3-0-16" id="h3-0-16" class="i">+				(t1.tv_nsec-t2.tv_nsec)/1E6)
</a><a href="#h3-0-17" id="h3-0-17" class="i">+#define MODBIT(x, set, bit)	((set) ? ((x) |= (bit)) : ((x) &amp;= ~(bit)))
</a><a href="#h3-0-18" id="h3-0-18" class="i">+
</a><a href="#h3-0-19" id="h3-0-19" class="i">+#define TRUECOLOR(r,g,b)	(1 &lt;&lt; 24 | (r) &lt;&lt; 16 | (g) &lt;&lt; 8 | (b))
</a><a href="#h3-0-20" id="h3-0-20" class="i">+#define IS_TRUECOL(x)		(1 &lt;&lt; 24 &amp; (x))
</a><a href="#h3-0-21" id="h3-0-21" class="i">+
</a><a href="#h3-0-22" id="h3-0-22" class="i">+enum glyph_attribute {
</a><a href="#h3-0-23" id="h3-0-23" class="i">+	ATTR_NULL       = 0,
</a><a href="#h3-0-24" id="h3-0-24" class="i">+	ATTR_BOLD       = 1 &lt;&lt; 0,
</a><a href="#h3-0-25" id="h3-0-25" class="i">+	ATTR_FAINT      = 1 &lt;&lt; 1,
</a><a href="#h3-0-26" id="h3-0-26" class="i">+	ATTR_ITALIC     = 1 &lt;&lt; 2,
</a><a href="#h3-0-27" id="h3-0-27" class="i">+	ATTR_UNDERLINE  = 1 &lt;&lt; 3,
</a><a href="#h3-0-28" id="h3-0-28" class="i">+	ATTR_BLINK      = 1 &lt;&lt; 4,
</a><a href="#h3-0-29" id="h3-0-29" class="i">+	ATTR_REVERSE    = 1 &lt;&lt; 5,
</a><a href="#h3-0-30" id="h3-0-30" class="i">+	ATTR_INVISIBLE  = 1 &lt;&lt; 6,
</a><a href="#h3-0-31" id="h3-0-31" class="i">+	ATTR_STRUCK     = 1 &lt;&lt; 7,
</a><a href="#h3-0-32" id="h3-0-32" class="i">+	ATTR_WRAP       = 1 &lt;&lt; 8,
</a><a href="#h3-0-33" id="h3-0-33" class="i">+	ATTR_WIDE       = 1 &lt;&lt; 9,
</a><a href="#h3-0-34" id="h3-0-34" class="i">+	ATTR_WDUMMY     = 1 &lt;&lt; 10,
</a><a href="#h3-0-35" id="h3-0-35" class="i">+	ATTR_BOLD_FAINT = ATTR_BOLD | ATTR_FAINT,
</a><a href="#h3-0-36" id="h3-0-36" class="i">+};
</a><a href="#h3-0-37" id="h3-0-37" class="i">+
</a><a href="#h3-0-38" id="h3-0-38" class="i">+enum term_mode {
</a><a href="#h3-0-39" id="h3-0-39" class="i">+	MODE_WRAP        = 1 &lt;&lt; 0,
</a><a href="#h3-0-40" id="h3-0-40" class="i">+	MODE_INSERT      = 1 &lt;&lt; 1,
</a><a href="#h3-0-41" id="h3-0-41" class="i">+	MODE_APPKEYPAD   = 1 &lt;&lt; 2,
</a><a href="#h3-0-42" id="h3-0-42" class="i">+	MODE_ALTSCREEN   = 1 &lt;&lt; 3,
</a><a href="#h3-0-43" id="h3-0-43" class="i">+	MODE_CRLF        = 1 &lt;&lt; 4,
</a><a href="#h3-0-44" id="h3-0-44" class="i">+	MODE_MOUSEBTN    = 1 &lt;&lt; 5,
</a><a href="#h3-0-45" id="h3-0-45" class="i">+	MODE_MOUSEMOTION = 1 &lt;&lt; 6,
</a><a href="#h3-0-46" id="h3-0-46" class="i">+	MODE_REVERSE     = 1 &lt;&lt; 7,
</a><a href="#h3-0-47" id="h3-0-47" class="i">+	MODE_KBDLOCK     = 1 &lt;&lt; 8,
</a><a href="#h3-0-48" id="h3-0-48" class="i">+	MODE_HIDE        = 1 &lt;&lt; 9,
</a><a href="#h3-0-49" id="h3-0-49" class="i">+	MODE_ECHO        = 1 &lt;&lt; 10,
</a><a href="#h3-0-50" id="h3-0-50" class="i">+	MODE_APPCURSOR   = 1 &lt;&lt; 11,
</a><a href="#h3-0-51" id="h3-0-51" class="i">+	MODE_MOUSESGR    = 1 &lt;&lt; 12,
</a><a href="#h3-0-52" id="h3-0-52" class="i">+	MODE_8BIT        = 1 &lt;&lt; 13,
</a><a href="#h3-0-53" id="h3-0-53" class="i">+	MODE_BLINK       = 1 &lt;&lt; 14,
</a><a href="#h3-0-54" id="h3-0-54" class="i">+	MODE_FBLINK      = 1 &lt;&lt; 15,
</a><a href="#h3-0-55" id="h3-0-55" class="i">+	MODE_FOCUS       = 1 &lt;&lt; 16,
</a><a href="#h3-0-56" id="h3-0-56" class="i">+	MODE_MOUSEX10    = 1 &lt;&lt; 17,
</a><a href="#h3-0-57" id="h3-0-57" class="i">+	MODE_MOUSEMANY   = 1 &lt;&lt; 18,
</a><a href="#h3-0-58" id="h3-0-58" class="i">+	MODE_BRCKTPASTE  = 1 &lt;&lt; 19,
</a><a href="#h3-0-59" id="h3-0-59" class="i">+	MODE_PRINT       = 1 &lt;&lt; 20,
</a><a href="#h3-0-60" id="h3-0-60" class="i">+	MODE_UTF8        = 1 &lt;&lt; 21,
</a><a href="#h3-0-61" id="h3-0-61" class="i">+	MODE_SIXEL       = 1 &lt;&lt; 22,
</a><a href="#h3-0-62" id="h3-0-62" class="i">+	MODE_MOUSE       = MODE_MOUSEBTN|MODE_MOUSEMOTION|MODE_MOUSEX10\
</a><a href="#h3-0-63" id="h3-0-63" class="i">+	                  |MODE_MOUSEMANY,
</a><a href="#h3-0-64" id="h3-0-64" class="i">+};
</a><a href="#h3-0-65" id="h3-0-65" class="i">+
</a><a href="#h3-0-66" id="h3-0-66" class="i">+enum selection_mode {
</a><a href="#h3-0-67" id="h3-0-67" class="i">+	SEL_IDLE = 0,
</a><a href="#h3-0-68" id="h3-0-68" class="i">+	SEL_EMPTY = 1,
</a><a href="#h3-0-69" id="h3-0-69" class="i">+	SEL_READY = 2
</a><a href="#h3-0-70" id="h3-0-70" class="i">+};
</a><a href="#h3-0-71" id="h3-0-71" class="i">+
</a><a href="#h3-0-72" id="h3-0-72" class="i">+enum selection_type {
</a><a href="#h3-0-73" id="h3-0-73" class="i">+	SEL_REGULAR = 1,
</a><a href="#h3-0-74" id="h3-0-74" class="i">+	SEL_RECTANGULAR = 2
</a><a href="#h3-0-75" id="h3-0-75" class="i">+};
</a><a href="#h3-0-76" id="h3-0-76" class="i">+
</a><a href="#h3-0-77" id="h3-0-77" class="i">+enum selection_snap {
</a><a href="#h3-0-78" id="h3-0-78" class="i">+	SNAP_WORD = 1,
</a><a href="#h3-0-79" id="h3-0-79" class="i">+	SNAP_LINE = 2
</a><a href="#h3-0-80" id="h3-0-80" class="i">+};
</a><a href="#h3-0-81" id="h3-0-81" class="i">+
</a><a href="#h3-0-82" id="h3-0-82" class="i">+enum window_state {
</a><a href="#h3-0-83" id="h3-0-83" class="i">+	WIN_VISIBLE = 1,
</a><a href="#h3-0-84" id="h3-0-84" class="i">+	WIN_FOCUSED = 2
</a><a href="#h3-0-85" id="h3-0-85" class="i">+};
</a><a href="#h3-0-86" id="h3-0-86" class="i">+
</a><a href="#h3-0-87" id="h3-0-87" class="i">+typedef unsigned char uchar;
</a><a href="#h3-0-88" id="h3-0-88" class="i">+typedef unsigned int uint;
</a><a href="#h3-0-89" id="h3-0-89" class="i">+typedef unsigned long ulong;
</a><a href="#h3-0-90" id="h3-0-90" class="i">+typedef unsigned short ushort;
</a><a href="#h3-0-91" id="h3-0-91" class="i">+
</a><a href="#h3-0-92" id="h3-0-92" class="i">+typedef uint_least32_t Rune;
</a><a href="#h3-0-93" id="h3-0-93" class="i">+
</a><a href="#h3-0-94" id="h3-0-94" class="i">+typedef struct {
</a><a href="#h3-0-95" id="h3-0-95" class="i">+	Rune u;           /* character code */
</a><a href="#h3-0-96" id="h3-0-96" class="i">+	ushort mode;      /* attribute flags */
</a><a href="#h3-0-97" id="h3-0-97" class="i">+	uint32_t fg;      /* foreground  */
</a><a href="#h3-0-98" id="h3-0-98" class="i">+	uint32_t bg;      /* background  */
</a><a href="#h3-0-99" id="h3-0-99" class="i">+} Glyph;
</a><a href="#h3-0-100" id="h3-0-100" class="i">+
</a><a href="#h3-0-101" id="h3-0-101" class="i">+typedef Glyph *Line;
</a><a href="#h3-0-102" id="h3-0-102" class="i">+
</a><a href="#h3-0-103" id="h3-0-103" class="i">+typedef struct {
</a><a href="#h3-0-104" id="h3-0-104" class="i">+	Glyph attr; /* current char attributes */
</a><a href="#h3-0-105" id="h3-0-105" class="i">+	int x;
</a><a href="#h3-0-106" id="h3-0-106" class="i">+	int y;
</a><a href="#h3-0-107" id="h3-0-107" class="i">+	char state;
</a><a href="#h3-0-108" id="h3-0-108" class="i">+} TCursor;
</a><a href="#h3-0-109" id="h3-0-109" class="i">+
</a><a href="#h3-0-110" id="h3-0-110" class="i">+/* Internal representation of the screen */
</a><a href="#h3-0-111" id="h3-0-111" class="i">+typedef struct {
</a><a href="#h3-0-112" id="h3-0-112" class="i">+	int row;      /* nb row */
</a><a href="#h3-0-113" id="h3-0-113" class="i">+	int col;      /* nb col */
</a><a href="#h3-0-114" id="h3-0-114" class="i">+	Line *line;   /* screen */
</a><a href="#h3-0-115" id="h3-0-115" class="i">+	Line *alt;    /* alternate screen */
</a><a href="#h3-0-116" id="h3-0-116" class="i">+	int *dirty;  /* dirtyness of lines */
</a><a href="#h3-0-117" id="h3-0-117" class="i">+	GlyphFontSpec *specbuf; /* font spec buffer used for rendering */
</a><a href="#h3-0-118" id="h3-0-118" class="i">+	TCursor c;    /* cursor */
</a><a href="#h3-0-119" id="h3-0-119" class="i">+	int top;      /* top    scroll limit */
</a><a href="#h3-0-120" id="h3-0-120" class="i">+	int bot;      /* bottom scroll limit */
</a><a href="#h3-0-121" id="h3-0-121" class="i">+	int mode;     /* terminal mode flags */
</a><a href="#h3-0-122" id="h3-0-122" class="i">+	int esc;      /* escape state flags */
</a><a href="#h3-0-123" id="h3-0-123" class="i">+	char trantbl[4]; /* charset table translation */
</a><a href="#h3-0-124" id="h3-0-124" class="i">+	int charset;  /* current charset */
</a><a href="#h3-0-125" id="h3-0-125" class="i">+	int icharset; /* selected charset for sequence */
</a><a href="#h3-0-126" id="h3-0-126" class="i">+	int numlock; /* lock numbers in keyboard */
</a><a href="#h3-0-127" id="h3-0-127" class="i">+	int *tabs;
</a><a href="#h3-0-128" id="h3-0-128" class="i">+} Term;
</a><a href="#h3-0-129" id="h3-0-129" class="i">+
</a><a href="#h3-0-130" id="h3-0-130" class="i">+/* Purely graphic info */
</a><a href="#h3-0-131" id="h3-0-131" class="i">+typedef struct {
</a><a href="#h3-0-132" id="h3-0-132" class="i">+	int tw, th; /* tty width and height */
</a><a href="#h3-0-133" id="h3-0-133" class="i">+	int w, h; /* window width and height */
</a><a href="#h3-0-134" id="h3-0-134" class="i">+	int ch; /* char height */
</a><a href="#h3-0-135" id="h3-0-135" class="i">+	int cw; /* char width  */
</a><a href="#h3-0-136" id="h3-0-136" class="i">+	char state; /* focus, redraw, visible */
</a><a href="#h3-0-137" id="h3-0-137" class="i">+	int cursor; /* cursor style */
</a><a href="#h3-0-138" id="h3-0-138" class="i">+} TermWindow;
</a><a href="#h3-0-139" id="h3-0-139" class="i">+
</a><a href="#h3-0-140" id="h3-0-140" class="i">+typedef struct {
</a><a href="#h3-0-141" id="h3-0-141" class="i">+	uint b;
</a><a href="#h3-0-142" id="h3-0-142" class="i">+	uint mask;
</a><a href="#h3-0-143" id="h3-0-143" class="i">+	char *s;
</a><a href="#h3-0-144" id="h3-0-144" class="i">+} MouseShortcut;
</a><a href="#h3-0-145" id="h3-0-145" class="i">+
</a><a href="#h3-0-146" id="h3-0-146" class="i">+typedef struct {
</a><a href="#h3-0-147" id="h3-0-147" class="i">+	int mode;
</a><a href="#h3-0-148" id="h3-0-148" class="i">+	int type;
</a><a href="#h3-0-149" id="h3-0-149" class="i">+	int snap;
</a><a href="#h3-0-150" id="h3-0-150" class="i">+	/*
</a><a href="#h3-0-151" id="h3-0-151" class="i">+	 * Selection variables:
</a><a href="#h3-0-152" id="h3-0-152" class="i">+	 * nb – normalized coordinates of the beginning of the selection
</a><a href="#h3-0-153" id="h3-0-153" class="i">+	 * ne – normalized coordinates of the end of the selection
</a><a href="#h3-0-154" id="h3-0-154" class="i">+	 * ob – original coordinates of the beginning of the selection
</a><a href="#h3-0-155" id="h3-0-155" class="i">+	 * oe – original coordinates of the end of the selection
</a><a href="#h3-0-156" id="h3-0-156" class="i">+	 */
</a><a href="#h3-0-157" id="h3-0-157" class="i">+	struct {
</a><a href="#h3-0-158" id="h3-0-158" class="i">+		int x, y;
</a><a href="#h3-0-159" id="h3-0-159" class="i">+	} nb, ne, ob, oe;
</a><a href="#h3-0-160" id="h3-0-160" class="i">+
</a><a href="#h3-0-161" id="h3-0-161" class="i">+	char *primary, *clipboard;
</a><a href="#h3-0-162" id="h3-0-162" class="i">+	int alt;
</a><a href="#h3-0-163" id="h3-0-163" class="i">+	struct timespec tclick1;
</a><a href="#h3-0-164" id="h3-0-164" class="i">+	struct timespec tclick2;
</a><a href="#h3-0-165" id="h3-0-165" class="i">+
</a><a href="#h3-0-166" id="h3-0-166" class="i">+	//Atom xtarget;
</a><a href="#h3-0-167" id="h3-0-167" class="i">+} Selection;
</a><a href="#h3-0-168" id="h3-0-168" class="i">+
</a><a href="#h3-0-169" id="h3-0-169" class="i">+typedef union {
</a><a href="#h3-0-170" id="h3-0-170" class="i">+	int i;
</a><a href="#h3-0-171" id="h3-0-171" class="i">+	uint ui;
</a><a href="#h3-0-172" id="h3-0-172" class="i">+	float f;
</a><a href="#h3-0-173" id="h3-0-173" class="i">+	const void *v;
</a><a href="#h3-0-174" id="h3-0-174" class="i">+} Arg;
</a><a href="#h3-0-175" id="h3-0-175" class="i">+
</a><a href="#h3-0-176" id="h3-0-176" class="i">+typedef struct {
</a><a href="#h3-0-177" id="h3-0-177" class="i">+	uint mod;
</a><a href="#h3-0-178" id="h3-0-178" class="i">+	KeySym keysym;
</a><a href="#h3-0-179" id="h3-0-179" class="i">+	void (*func)(const Arg *);
</a><a href="#h3-0-180" id="h3-0-180" class="i">+	const Arg arg;
</a><a href="#h3-0-181" id="h3-0-181" class="i">+} Shortcut;
</a><a href="#h3-0-182" id="h3-0-182" class="i">+
</a><a href="#h3-0-183" id="h3-0-183" class="i">+void die(const char *, ...);
</a><a href="#h3-0-184" id="h3-0-184" class="i">+void redraw(void);
</a><a href="#h3-0-185" id="h3-0-185" class="i">+
</a><a href="#h3-0-186" id="h3-0-186" class="i">+int tattrset(int);
</a><a href="#h3-0-187" id="h3-0-187" class="i">+void tnew(int, int);
</a><a href="#h3-0-188" id="h3-0-188" class="i">+void tsetdirt(int, int);
</a><a href="#h3-0-189" id="h3-0-189" class="i">+void tsetdirtattr(int);
</a><a href="#h3-0-190" id="h3-0-190" class="i">+int match(uint, uint);
</a><a href="#h3-0-191" id="h3-0-191" class="i">+void ttynew(void);
</a><a href="#h3-0-192" id="h3-0-192" class="i">+size_t ttyread(void);
</a><a href="#h3-0-193" id="h3-0-193" class="i">+void ttyresize(void);
</a><a href="#h3-0-194" id="h3-0-194" class="i">+void ttysend(char *, size_t);
</a><a href="#h3-0-195" id="h3-0-195" class="i">+void ttywrite(const char *, size_t);
</a><a href="#h3-0-196" id="h3-0-196" class="i">+
</a><a href="#h3-0-197" id="h3-0-197" class="i">+void resettitle(void);
</a><a href="#h3-0-198" id="h3-0-198" class="i">+
</a><a href="#h3-0-199" id="h3-0-199" class="i">+char *kmap(KeySym, uint);
</a><a href="#h3-0-200" id="h3-0-200" class="i">+void cresize(int, int);
</a><a href="#h3-0-201" id="h3-0-201" class="i">+void selclear(void);
</a><a href="#h3-0-202" id="h3-0-202" class="i">+
</a><a href="#h3-0-203" id="h3-0-203" class="i">+void selinit(void);
</a><a href="#h3-0-204" id="h3-0-204" class="i">+void selnormalize(void);
</a><a href="#h3-0-205" id="h3-0-205" class="i">+int selected(int, int);
</a><a href="#h3-0-206" id="h3-0-206" class="i">+char *getsel(void);
</a><a href="#h3-0-207" id="h3-0-207" class="i">+int x2col(int);
</a><a href="#h3-0-208" id="h3-0-208" class="i">+int y2row(int);
</a><a href="#h3-0-209" id="h3-0-209" class="i">+
</a><a href="#h3-0-210" id="h3-0-210" class="i">+size_t utf8decode(char *, Rune *, size_t);
</a><a href="#h3-0-211" id="h3-0-211" class="i">+size_t utf8encode(Rune, char *);
</a><a href="#h3-0-212" id="h3-0-212" class="i">+
</a><a href="#h3-0-213" id="h3-0-213" class="i">+void *xmalloc(size_t);
</a><a href="#h3-0-214" id="h3-0-214" class="i">+char *xstrdup(char *);
</a><a href="#h3-0-215" id="h3-0-215" class="i">+
</a><a href="#h3-0-216" id="h3-0-216" class="i">+void usage(void);
</a><a href="#h3-0-217" id="h3-0-217" class="i">+
</a><a href="#h3-0-218" id="h3-0-218" class="i">+/* Globals */
</a><a href="#h3-0-219" id="h3-0-219" class="i">+extern TermWindow win;
</a><a href="#h3-0-220" id="h3-0-220" class="i">+extern Term term;
</a><a href="#h3-0-221" id="h3-0-221" class="i">+extern Selection sel;
</a><a href="#h3-0-222" id="h3-0-222" class="i">+extern int cmdfd;
</a><a href="#h3-0-223" id="h3-0-223" class="i">+extern pid_t pid;
</a><a href="#h3-0-224" id="h3-0-224" class="i">+extern char **opt_cmd;
</a><a href="#h3-0-225" id="h3-0-225" class="i">+extern char *opt_class;
</a><a href="#h3-0-226" id="h3-0-226" class="i">+extern char *opt_embed;
</a><a href="#h3-0-227" id="h3-0-227" class="i">+extern char *opt_font;
</a><a href="#h3-0-228" id="h3-0-228" class="i">+extern char *opt_io;
</a><a href="#h3-0-229" id="h3-0-229" class="i">+extern char *opt_line;
</a><a href="#h3-0-230" id="h3-0-230" class="i">+extern char *opt_name;
</a><a href="#h3-0-231" id="h3-0-231" class="i">+extern char *opt_title;
</a><a href="#h3-0-232" id="h3-0-232" class="i">+extern int oldbutton;
</a><a href="#h3-0-233" id="h3-0-233" class="i">+
</a><a href="#h3-0-234" id="h3-0-234" class="i">+extern char *usedfont;
</a><a href="#h3-0-235" id="h3-0-235" class="i">+extern double usedfontsize;
</a><a href="#h3-0-236" id="h3-0-236" class="i">+extern double defaultfontsize;
</a><a href="#h3-0-237" id="h3-0-237" class="i">+
</a><a href="#h3-0-238" id="h3-0-238" class="i">+/* config.h globals */
</a><a href="#h3-0-239" id="h3-0-239" class="i">+extern char font[];
</a><a href="#h3-0-240" id="h3-0-240" class="i">+extern int borderpx;
</a><a href="#h3-0-241" id="h3-0-241" class="i">+extern float cwscale;
</a><a href="#h3-0-242" id="h3-0-242" class="i">+extern float chscale;
</a><a href="#h3-0-243" id="h3-0-243" class="i">+extern unsigned int doubleclicktimeout;
</a><a href="#h3-0-244" id="h3-0-244" class="i">+extern unsigned int tripleclicktimeout;
</a><a href="#h3-0-245" id="h3-0-245" class="i">+extern int allowaltscreen;
</a><a href="#h3-0-246" id="h3-0-246" class="i">+extern unsigned int xfps;
</a><a href="#h3-0-247" id="h3-0-247" class="i">+extern unsigned int actionfps;
</a><a href="#h3-0-248" id="h3-0-248" class="i">+extern unsigned int cursorthickness;
</a><a href="#h3-0-249" id="h3-0-249" class="i">+extern unsigned int blinktimeout;
</a><a href="#h3-0-250" id="h3-0-250" class="i">+extern char termname[];
</a><a href="#h3-0-251" id="h3-0-251" class="i">+extern const char *colorname[];
</a><a href="#h3-0-252" id="h3-0-252" class="i">+extern size_t colornamelen;
</a><a href="#h3-0-253" id="h3-0-253" class="i">+extern unsigned int defaultfg;
</a><a href="#h3-0-254" id="h3-0-254" class="i">+extern unsigned int defaultbg;
</a><a href="#h3-0-255" id="h3-0-255" class="i">+extern unsigned int defaultcs;
</a><a href="#h3-0-256" id="h3-0-256" class="i">+extern unsigned int defaultrcs;
</a><a href="#h3-0-257" id="h3-0-257" class="i">+extern unsigned int cursorshape;
</a><a href="#h3-0-258" id="h3-0-258" class="i">+extern unsigned int cols;
</a><a href="#h3-0-259" id="h3-0-259" class="i">+extern unsigned int rows;
</a><a href="#h3-0-260" id="h3-0-260" class="i">+extern unsigned int mouseshape;
</a><a href="#h3-0-261" id="h3-0-261" class="i">+extern unsigned int mousefg;
</a><a href="#h3-0-262" id="h3-0-262" class="i">+extern unsigned int mousebg;
</a><a href="#h3-0-263" id="h3-0-263" class="i">+extern unsigned int defaultattr;
</a><a href="#h3-0-264" id="h3-0-264" class="i">+extern MouseShortcut mshortcuts[];
</a><a href="#h3-0-265" id="h3-0-265" class="i">+extern size_t mshortcutslen;
</a><a href="#h3-0-266" id="h3-0-266" class="i">+extern Shortcut shortcuts[];
</a><a href="#h3-0-267" id="h3-0-267" class="i">+extern size_t shortcutslen;
</a><a href="#h3-0-268" id="h3-0-268" class="i">+extern uint forceselmod;
</a><a href="#h3-0-269" id="h3-0-269" class="i">+extern uint selmasks[];
</a><a href="#h3-0-270" id="h3-0-270" class="i">+extern size_t selmaskslen;
</a><a href="#h3-0-271" id="h3-0-271" class="i">+extern char ascii_printable[];
</a><b>diff --git a/<a id="h4" href="../file/win.h.html">win.h</a> b/<a href="../file/win.h.html">win.h</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -0,0 +1,29 @@
</a><a href="#h4-0-0" id="h4-0-0" class="i">+/* See LICENSE for license details. */
</a><a href="#h4-0-1" id="h4-0-1" class="i">+
</a><a href="#h4-0-2" id="h4-0-2" class="i">+/* X modifiers */
</a><a href="#h4-0-3" id="h4-0-3" class="i">+#define XK_ANY_MOD    UINT_MAX
</a><a href="#h4-0-4" id="h4-0-4" class="i">+#define XK_NO_MOD     0
</a><a href="#h4-0-5" id="h4-0-5" class="i">+#define XK_SWITCH_MOD (1&lt;&lt;13)
</a><a href="#h4-0-6" id="h4-0-6" class="i">+
</a><a href="#h4-0-7" id="h4-0-7" class="i">+typedef XftGlyphFontSpec GlyphFontSpec;
</a><a href="#h4-0-8" id="h4-0-8" class="i">+
</a><a href="#h4-0-9" id="h4-0-9" class="i">+void draw(void);
</a><a href="#h4-0-10" id="h4-0-10" class="i">+void drawregion(int, int, int, int);
</a><a href="#h4-0-11" id="h4-0-11" class="i">+void run(void);
</a><a href="#h4-0-12" id="h4-0-12" class="i">+
</a><a href="#h4-0-13" id="h4-0-13" class="i">+void xbell(int);
</a><a href="#h4-0-14" id="h4-0-14" class="i">+void xclipcopy(void);
</a><a href="#h4-0-15" id="h4-0-15" class="i">+void xclippaste(void);
</a><a href="#h4-0-16" id="h4-0-16" class="i">+void xhints(void);
</a><a href="#h4-0-17" id="h4-0-17" class="i">+void xinit(void);
</a><a href="#h4-0-18" id="h4-0-18" class="i">+void xloadcols(void);
</a><a href="#h4-0-19" id="h4-0-19" class="i">+int xsetcolorname(int, const char *);
</a><a href="#h4-0-20" id="h4-0-20" class="i">+void xloadfonts(char *, double);
</a><a href="#h4-0-21" id="h4-0-21" class="i">+void xsetenv(void);
</a><a href="#h4-0-22" id="h4-0-22" class="i">+void xsettitle(char *);
</a><a href="#h4-0-23" id="h4-0-23" class="i">+void xsetpointermotion(int);
</a><a href="#h4-0-24" id="h4-0-24" class="i">+void xseturgency(int);
</a><a href="#h4-0-25" id="h4-0-25" class="i">+void xunloadfonts(void);
</a><a href="#h4-0-26" id="h4-0-26" class="i">+void xresize(int, int);
</a><a href="#h4-0-27" id="h4-0-27" class="i">+void xselpaste(void);
</a><a href="#h4-0-28" id="h4-0-28" class="i">+unsigned long xwinid(void);
</a><b>diff --git a/<a id="h5" href="../file/x.c.html">x.c</a> b/<a href="../file/x.c.html">x.c</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,1766 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+/* See LICENSE for license details. */
</a><a href="#h5-0-1" id="h5-0-1" class="i">+#include &lt;errno.h&gt;
</a><a href="#h5-0-2" id="h5-0-2" class="i">+#include &lt;locale.h&gt;
</a><a href="#h5-0-3" id="h5-0-3" class="i">+#include &lt;signal.h&gt;
</a><a href="#h5-0-4" id="h5-0-4" class="i">+#include &lt;stdint.h&gt;
</a><a href="#h5-0-5" id="h5-0-5" class="i">+#include &lt;sys/select.h&gt;
</a><a href="#h5-0-6" id="h5-0-6" class="i">+#include &lt;time.h&gt;
</a><a href="#h5-0-7" id="h5-0-7" class="i">+#include &lt;unistd.h&gt;
</a><a href="#h5-0-8" id="h5-0-8" class="i">+#include &lt;libgen.h&gt;
</a><a href="#h5-0-9" id="h5-0-9" class="i">+#include &lt;X11/Xatom.h&gt;
</a><a href="#h5-0-10" id="h5-0-10" class="i">+#include &lt;X11/Xlib.h&gt;
</a><a href="#h5-0-11" id="h5-0-11" class="i">+#include &lt;X11/Xutil.h&gt;
</a><a href="#h5-0-12" id="h5-0-12" class="i">+#include &lt;X11/cursorfont.h&gt;
</a><a href="#h5-0-13" id="h5-0-13" class="i">+#include &lt;X11/keysym.h&gt;
</a><a href="#h5-0-14" id="h5-0-14" class="i">+#include &lt;X11/Xft/Xft.h&gt;
</a><a href="#h5-0-15" id="h5-0-15" class="i">+#include &lt;X11/XKBlib.h&gt;
</a><a href="#h5-0-16" id="h5-0-16" class="i">+
</a><a href="#h5-0-17" id="h5-0-17" class="i">+#include &quot;arg.h&quot;
</a><a href="#h5-0-18" id="h5-0-18" class="i">+
</a><a href="#h5-0-19" id="h5-0-19" class="i">+#define Glyph Glyph_
</a><a href="#h5-0-20" id="h5-0-20" class="i">+#define Font Font_
</a><a href="#h5-0-21" id="h5-0-21" class="i">+
</a><a href="#h5-0-22" id="h5-0-22" class="i">+#include &quot;win.h&quot;
</a><a href="#h5-0-23" id="h5-0-23" class="i">+#include &quot;st.h&quot;
</a><a href="#h5-0-24" id="h5-0-24" class="i">+
</a><a href="#h5-0-25" id="h5-0-25" class="i">+/* XEMBED messages */
</a><a href="#h5-0-26" id="h5-0-26" class="i">+#define XEMBED_FOCUS_IN  4
</a><a href="#h5-0-27" id="h5-0-27" class="i">+#define XEMBED_FOCUS_OUT 5
</a><a href="#h5-0-28" id="h5-0-28" class="i">+
</a><a href="#h5-0-29" id="h5-0-29" class="i">+/* macros */
</a><a href="#h5-0-30" id="h5-0-30" class="i">+#define TRUERED(x)		(((x) &amp; 0xff0000) &gt;&gt; 8)
</a><a href="#h5-0-31" id="h5-0-31" class="i">+#define TRUEGREEN(x)		(((x) &amp; 0xff00))
</a><a href="#h5-0-32" id="h5-0-32" class="i">+#define TRUEBLUE(x)		(((x) &amp; 0xff) &lt;&lt; 8)
</a><a href="#h5-0-33" id="h5-0-33" class="i">+
</a><a href="#h5-0-34" id="h5-0-34" class="i">+typedef XftDraw *Draw;
</a><a href="#h5-0-35" id="h5-0-35" class="i">+typedef XftColor Color;
</a><a href="#h5-0-36" id="h5-0-36" class="i">+
</a><a href="#h5-0-37" id="h5-0-37" class="i">+/* Purely graphic info */
</a><a href="#h5-0-38" id="h5-0-38" class="i">+typedef struct {
</a><a href="#h5-0-39" id="h5-0-39" class="i">+	Display *dpy;
</a><a href="#h5-0-40" id="h5-0-40" class="i">+	Colormap cmap;
</a><a href="#h5-0-41" id="h5-0-41" class="i">+	Window win;
</a><a href="#h5-0-42" id="h5-0-42" class="i">+	Drawable buf;
</a><a href="#h5-0-43" id="h5-0-43" class="i">+	Atom xembed, wmdeletewin, netwmname, netwmpid;
</a><a href="#h5-0-44" id="h5-0-44" class="i">+	XIM xim;
</a><a href="#h5-0-45" id="h5-0-45" class="i">+	XIC xic;
</a><a href="#h5-0-46" id="h5-0-46" class="i">+	Draw draw;
</a><a href="#h5-0-47" id="h5-0-47" class="i">+	Visual *vis;
</a><a href="#h5-0-48" id="h5-0-48" class="i">+	XSetWindowAttributes attrs;
</a><a href="#h5-0-49" id="h5-0-49" class="i">+	int scr;
</a><a href="#h5-0-50" id="h5-0-50" class="i">+	int isfixed; /* is fixed geometry? */
</a><a href="#h5-0-51" id="h5-0-51" class="i">+	int l, t; /* left and top offset */
</a><a href="#h5-0-52" id="h5-0-52" class="i">+	int gm; /* geometry mask */
</a><a href="#h5-0-53" id="h5-0-53" class="i">+} XWindow;
</a><a href="#h5-0-54" id="h5-0-54" class="i">+
</a><a href="#h5-0-55" id="h5-0-55" class="i">+typedef struct {
</a><a href="#h5-0-56" id="h5-0-56" class="i">+	Atom xtarget;
</a><a href="#h5-0-57" id="h5-0-57" class="i">+} XSelection;
</a><a href="#h5-0-58" id="h5-0-58" class="i">+
</a><a href="#h5-0-59" id="h5-0-59" class="i">+/* Font structure */
</a><a href="#h5-0-60" id="h5-0-60" class="i">+typedef struct {
</a><a href="#h5-0-61" id="h5-0-61" class="i">+	int height;
</a><a href="#h5-0-62" id="h5-0-62" class="i">+	int width;
</a><a href="#h5-0-63" id="h5-0-63" class="i">+	int ascent;
</a><a href="#h5-0-64" id="h5-0-64" class="i">+	int descent;
</a><a href="#h5-0-65" id="h5-0-65" class="i">+	int badslant;
</a><a href="#h5-0-66" id="h5-0-66" class="i">+	int badweight;
</a><a href="#h5-0-67" id="h5-0-67" class="i">+	short lbearing;
</a><a href="#h5-0-68" id="h5-0-68" class="i">+	short rbearing;
</a><a href="#h5-0-69" id="h5-0-69" class="i">+	XftFont *match;
</a><a href="#h5-0-70" id="h5-0-70" class="i">+	FcFontSet *set;
</a><a href="#h5-0-71" id="h5-0-71" class="i">+	FcPattern *pattern;
</a><a href="#h5-0-72" id="h5-0-72" class="i">+} Font;
</a><a href="#h5-0-73" id="h5-0-73" class="i">+
</a><a href="#h5-0-74" id="h5-0-74" class="i">+/* Drawing Context */
</a><a href="#h5-0-75" id="h5-0-75" class="i">+typedef struct {
</a><a href="#h5-0-76" id="h5-0-76" class="i">+	Color *col;
</a><a href="#h5-0-77" id="h5-0-77" class="i">+	size_t collen;
</a><a href="#h5-0-78" id="h5-0-78" class="i">+	Font font, bfont, ifont, ibfont;
</a><a href="#h5-0-79" id="h5-0-79" class="i">+	GC gc;
</a><a href="#h5-0-80" id="h5-0-80" class="i">+} DC;
</a><a href="#h5-0-81" id="h5-0-81" class="i">+
</a><a href="#h5-0-82" id="h5-0-82" class="i">+static inline ushort sixd_to_16bit(int);
</a><a href="#h5-0-83" id="h5-0-83" class="i">+static int xmakeglyphfontspecs(XftGlyphFontSpec *, const Glyph *, int, int, int);
</a><a href="#h5-0-84" id="h5-0-84" class="i">+static void xdrawglyphfontspecs(const XftGlyphFontSpec *, Glyph, int, int, int);
</a><a href="#h5-0-85" id="h5-0-85" class="i">+static void xdrawglyph(Glyph, int, int);
</a><a href="#h5-0-86" id="h5-0-86" class="i">+static void xclear(int, int, int, int);
</a><a href="#h5-0-87" id="h5-0-87" class="i">+static void xdrawcursor(void);
</a><a href="#h5-0-88" id="h5-0-88" class="i">+static int xgeommasktogravity(int);
</a><a href="#h5-0-89" id="h5-0-89" class="i">+static int xloadfont(Font *, FcPattern *);
</a><a href="#h5-0-90" id="h5-0-90" class="i">+static void xsetsel(char *, Time);
</a><a href="#h5-0-91" id="h5-0-91" class="i">+static void xunloadfont(Font *);
</a><a href="#h5-0-92" id="h5-0-92" class="i">+
</a><a href="#h5-0-93" id="h5-0-93" class="i">+static void expose(XEvent *);
</a><a href="#h5-0-94" id="h5-0-94" class="i">+static void visibility(XEvent *);
</a><a href="#h5-0-95" id="h5-0-95" class="i">+static void unmap(XEvent *);
</a><a href="#h5-0-96" id="h5-0-96" class="i">+static void kpress(XEvent *);
</a><a href="#h5-0-97" id="h5-0-97" class="i">+static void cmessage(XEvent *);
</a><a href="#h5-0-98" id="h5-0-98" class="i">+static void resize(XEvent *);
</a><a href="#h5-0-99" id="h5-0-99" class="i">+static void focus(XEvent *);
</a><a href="#h5-0-100" id="h5-0-100" class="i">+static void brelease(XEvent *);
</a><a href="#h5-0-101" id="h5-0-101" class="i">+static void bpress(XEvent *);
</a><a href="#h5-0-102" id="h5-0-102" class="i">+static void bmotion(XEvent *);
</a><a href="#h5-0-103" id="h5-0-103" class="i">+static void propnotify(XEvent *);
</a><a href="#h5-0-104" id="h5-0-104" class="i">+static void selnotify(XEvent *);
</a><a href="#h5-0-105" id="h5-0-105" class="i">+static void selclear_(XEvent *);
</a><a href="#h5-0-106" id="h5-0-106" class="i">+static void selrequest(XEvent *);
</a><a href="#h5-0-107" id="h5-0-107" class="i">+
</a><a href="#h5-0-108" id="h5-0-108" class="i">+static void selcopy(Time);
</a><a href="#h5-0-109" id="h5-0-109" class="i">+static void getbuttoninfo(XEvent *);
</a><a href="#h5-0-110" id="h5-0-110" class="i">+static void mousereport(XEvent *);
</a><a href="#h5-0-111" id="h5-0-111" class="i">+
</a><a href="#h5-0-112" id="h5-0-112" class="i">+static void (*handler[LASTEvent])(XEvent *) = {
</a><a href="#h5-0-113" id="h5-0-113" class="i">+	[KeyPress] = kpress,
</a><a href="#h5-0-114" id="h5-0-114" class="i">+	[ClientMessage] = cmessage,
</a><a href="#h5-0-115" id="h5-0-115" class="i">+	[ConfigureNotify] = resize,
</a><a href="#h5-0-116" id="h5-0-116" class="i">+	[VisibilityNotify] = visibility,
</a><a href="#h5-0-117" id="h5-0-117" class="i">+	[UnmapNotify] = unmap,
</a><a href="#h5-0-118" id="h5-0-118" class="i">+	[Expose] = expose,
</a><a href="#h5-0-119" id="h5-0-119" class="i">+	[FocusIn] = focus,
</a><a href="#h5-0-120" id="h5-0-120" class="i">+	[FocusOut] = focus,
</a><a href="#h5-0-121" id="h5-0-121" class="i">+	[MotionNotify] = bmotion,
</a><a href="#h5-0-122" id="h5-0-122" class="i">+	[ButtonPress] = bpress,
</a><a href="#h5-0-123" id="h5-0-123" class="i">+	[ButtonRelease] = brelease,
</a><a href="#h5-0-124" id="h5-0-124" class="i">+/*
</a><a href="#h5-0-125" id="h5-0-125" class="i">+ * Uncomment if you want the selection to disappear when you select something
</a><a href="#h5-0-126" id="h5-0-126" class="i">+ * different in another window.
</a><a href="#h5-0-127" id="h5-0-127" class="i">+ */
</a><a href="#h5-0-128" id="h5-0-128" class="i">+/*	[SelectionClear] = selclear_, */
</a><a href="#h5-0-129" id="h5-0-129" class="i">+	[SelectionNotify] = selnotify,
</a><a href="#h5-0-130" id="h5-0-130" class="i">+/*
</a><a href="#h5-0-131" id="h5-0-131" class="i">+ * PropertyNotify is only turned on when there is some INCR transfer happening
</a><a href="#h5-0-132" id="h5-0-132" class="i">+ * for the selection retrieval.
</a><a href="#h5-0-133" id="h5-0-133" class="i">+ */
</a><a href="#h5-0-134" id="h5-0-134" class="i">+	[PropertyNotify] = propnotify,
</a><a href="#h5-0-135" id="h5-0-135" class="i">+	[SelectionRequest] = selrequest,
</a><a href="#h5-0-136" id="h5-0-136" class="i">+};
</a><a href="#h5-0-137" id="h5-0-137" class="i">+
</a><a href="#h5-0-138" id="h5-0-138" class="i">+/* Globals */
</a><a href="#h5-0-139" id="h5-0-139" class="i">+static DC dc;
</a><a href="#h5-0-140" id="h5-0-140" class="i">+static XWindow xw;
</a><a href="#h5-0-141" id="h5-0-141" class="i">+static XSelection xsel;
</a><a href="#h5-0-142" id="h5-0-142" class="i">+
</a><a href="#h5-0-143" id="h5-0-143" class="i">+/* Font Ring Cache */
</a><a href="#h5-0-144" id="h5-0-144" class="i">+enum {
</a><a href="#h5-0-145" id="h5-0-145" class="i">+	FRC_NORMAL,
</a><a href="#h5-0-146" id="h5-0-146" class="i">+	FRC_ITALIC,
</a><a href="#h5-0-147" id="h5-0-147" class="i">+	FRC_BOLD,
</a><a href="#h5-0-148" id="h5-0-148" class="i">+	FRC_ITALICBOLD
</a><a href="#h5-0-149" id="h5-0-149" class="i">+};
</a><a href="#h5-0-150" id="h5-0-150" class="i">+
</a><a href="#h5-0-151" id="h5-0-151" class="i">+typedef struct {
</a><a href="#h5-0-152" id="h5-0-152" class="i">+	XftFont *font;
</a><a href="#h5-0-153" id="h5-0-153" class="i">+	int flags;
</a><a href="#h5-0-154" id="h5-0-154" class="i">+	Rune unicodep;
</a><a href="#h5-0-155" id="h5-0-155" class="i">+} Fontcache;
</a><a href="#h5-0-156" id="h5-0-156" class="i">+
</a><a href="#h5-0-157" id="h5-0-157" class="i">+/* Fontcache is an array now. A new font will be appended to the array. */
</a><a href="#h5-0-158" id="h5-0-158" class="i">+static Fontcache frc[16];
</a><a href="#h5-0-159" id="h5-0-159" class="i">+static int frclen = 0;
</a><a href="#h5-0-160" id="h5-0-160" class="i">+
</a><a href="#h5-0-161" id="h5-0-161" class="i">+void
</a><a href="#h5-0-162" id="h5-0-162" class="i">+getbuttoninfo(XEvent *e)
</a><a href="#h5-0-163" id="h5-0-163" class="i">+{
</a><a href="#h5-0-164" id="h5-0-164" class="i">+	int type;
</a><a href="#h5-0-165" id="h5-0-165" class="i">+	uint state = e-&gt;xbutton.state &amp; ~(Button1Mask | forceselmod);
</a><a href="#h5-0-166" id="h5-0-166" class="i">+
</a><a href="#h5-0-167" id="h5-0-167" class="i">+	sel.alt = IS_SET(MODE_ALTSCREEN);
</a><a href="#h5-0-168" id="h5-0-168" class="i">+
</a><a href="#h5-0-169" id="h5-0-169" class="i">+	sel.oe.x = x2col(e-&gt;xbutton.x);
</a><a href="#h5-0-170" id="h5-0-170" class="i">+	sel.oe.y = y2row(e-&gt;xbutton.y);
</a><a href="#h5-0-171" id="h5-0-171" class="i">+	selnormalize();
</a><a href="#h5-0-172" id="h5-0-172" class="i">+
</a><a href="#h5-0-173" id="h5-0-173" class="i">+	sel.type = SEL_REGULAR;
</a><a href="#h5-0-174" id="h5-0-174" class="i">+	for (type = 1; type &lt; selmaskslen; ++type) {
</a><a href="#h5-0-175" id="h5-0-175" class="i">+		if (match(selmasks[type], state)) {
</a><a href="#h5-0-176" id="h5-0-176" class="i">+			sel.type = type;
</a><a href="#h5-0-177" id="h5-0-177" class="i">+			break;
</a><a href="#h5-0-178" id="h5-0-178" class="i">+		}
</a><a href="#h5-0-179" id="h5-0-179" class="i">+	}
</a><a href="#h5-0-180" id="h5-0-180" class="i">+}
</a><a href="#h5-0-181" id="h5-0-181" class="i">+
</a><a href="#h5-0-182" id="h5-0-182" class="i">+void
</a><a href="#h5-0-183" id="h5-0-183" class="i">+mousereport(XEvent *e)
</a><a href="#h5-0-184" id="h5-0-184" class="i">+{
</a><a href="#h5-0-185" id="h5-0-185" class="i">+	int x = x2col(e-&gt;xbutton.x), y = y2row(e-&gt;xbutton.y),
</a><a href="#h5-0-186" id="h5-0-186" class="i">+	    button = e-&gt;xbutton.button, state = e-&gt;xbutton.state,
</a><a href="#h5-0-187" id="h5-0-187" class="i">+	    len;
</a><a href="#h5-0-188" id="h5-0-188" class="i">+	char buf[40];
</a><a href="#h5-0-189" id="h5-0-189" class="i">+	static int ox, oy;
</a><a href="#h5-0-190" id="h5-0-190" class="i">+
</a><a href="#h5-0-191" id="h5-0-191" class="i">+	/* from urxvt */
</a><a href="#h5-0-192" id="h5-0-192" class="i">+	if (e-&gt;xbutton.type == MotionNotify) {
</a><a href="#h5-0-193" id="h5-0-193" class="i">+		if (x == ox &amp;&amp; y == oy)
</a><a href="#h5-0-194" id="h5-0-194" class="i">+			return;
</a><a href="#h5-0-195" id="h5-0-195" class="i">+		if (!IS_SET(MODE_MOUSEMOTION) &amp;&amp; !IS_SET(MODE_MOUSEMANY))
</a><a href="#h5-0-196" id="h5-0-196" class="i">+			return;
</a><a href="#h5-0-197" id="h5-0-197" class="i">+		/* MOUSE_MOTION: no reporting if no button is pressed */
</a><a href="#h5-0-198" id="h5-0-198" class="i">+		if (IS_SET(MODE_MOUSEMOTION) &amp;&amp; oldbutton == 3)
</a><a href="#h5-0-199" id="h5-0-199" class="i">+			return;
</a><a href="#h5-0-200" id="h5-0-200" class="i">+
</a><a href="#h5-0-201" id="h5-0-201" class="i">+		button = oldbutton + 32;
</a><a href="#h5-0-202" id="h5-0-202" class="i">+		ox = x;
</a><a href="#h5-0-203" id="h5-0-203" class="i">+		oy = y;
</a><a href="#h5-0-204" id="h5-0-204" class="i">+	} else {
</a><a href="#h5-0-205" id="h5-0-205" class="i">+		if (!IS_SET(MODE_MOUSESGR) &amp;&amp; e-&gt;xbutton.type == ButtonRelease) {
</a><a href="#h5-0-206" id="h5-0-206" class="i">+			button = 3;
</a><a href="#h5-0-207" id="h5-0-207" class="i">+		} else {
</a><a href="#h5-0-208" id="h5-0-208" class="i">+			button -= Button1;
</a><a href="#h5-0-209" id="h5-0-209" class="i">+			if (button &gt;= 3)
</a><a href="#h5-0-210" id="h5-0-210" class="i">+				button += 64 - 3;
</a><a href="#h5-0-211" id="h5-0-211" class="i">+		}
</a><a href="#h5-0-212" id="h5-0-212" class="i">+		if (e-&gt;xbutton.type == ButtonPress) {
</a><a href="#h5-0-213" id="h5-0-213" class="i">+			oldbutton = button;
</a><a href="#h5-0-214" id="h5-0-214" class="i">+			ox = x;
</a><a href="#h5-0-215" id="h5-0-215" class="i">+			oy = y;
</a><a href="#h5-0-216" id="h5-0-216" class="i">+		} else if (e-&gt;xbutton.type == ButtonRelease) {
</a><a href="#h5-0-217" id="h5-0-217" class="i">+			oldbutton = 3;
</a><a href="#h5-0-218" id="h5-0-218" class="i">+			/* MODE_MOUSEX10: no button release reporting */
</a><a href="#h5-0-219" id="h5-0-219" class="i">+			if (IS_SET(MODE_MOUSEX10))
</a><a href="#h5-0-220" id="h5-0-220" class="i">+				return;
</a><a href="#h5-0-221" id="h5-0-221" class="i">+			if (button == 64 || button == 65)
</a><a href="#h5-0-222" id="h5-0-222" class="i">+				return;
</a><a href="#h5-0-223" id="h5-0-223" class="i">+		}
</a><a href="#h5-0-224" id="h5-0-224" class="i">+	}
</a><a href="#h5-0-225" id="h5-0-225" class="i">+
</a><a href="#h5-0-226" id="h5-0-226" class="i">+	if (!IS_SET(MODE_MOUSEX10)) {
</a><a href="#h5-0-227" id="h5-0-227" class="i">+		button += ((state &amp; ShiftMask  ) ? 4  : 0)
</a><a href="#h5-0-228" id="h5-0-228" class="i">+			+ ((state &amp; Mod4Mask   ) ? 8  : 0)
</a><a href="#h5-0-229" id="h5-0-229" class="i">+			+ ((state &amp; ControlMask) ? 16 : 0);
</a><a href="#h5-0-230" id="h5-0-230" class="i">+	}
</a><a href="#h5-0-231" id="h5-0-231" class="i">+
</a><a href="#h5-0-232" id="h5-0-232" class="i">+	if (IS_SET(MODE_MOUSESGR)) {
</a><a href="#h5-0-233" id="h5-0-233" class="i">+		len = snprintf(buf, sizeof(buf), &quot;\033[&lt;%d;%d;%d%c&quot;,
</a><a href="#h5-0-234" id="h5-0-234" class="i">+				button, x+1, y+1,
</a><a href="#h5-0-235" id="h5-0-235" class="i">+				e-&gt;xbutton.type == ButtonRelease ? &#39;m&#39; : &#39;M&#39;);
</a><a href="#h5-0-236" id="h5-0-236" class="i">+	} else if (x &lt; 223 &amp;&amp; y &lt; 223) {
</a><a href="#h5-0-237" id="h5-0-237" class="i">+		len = snprintf(buf, sizeof(buf), &quot;\033[M%c%c%c&quot;,
</a><a href="#h5-0-238" id="h5-0-238" class="i">+				32+button, 32+x+1, 32+y+1);
</a><a href="#h5-0-239" id="h5-0-239" class="i">+	} else {
</a><a href="#h5-0-240" id="h5-0-240" class="i">+		return;
</a><a href="#h5-0-241" id="h5-0-241" class="i">+	}
</a><a href="#h5-0-242" id="h5-0-242" class="i">+
</a><a href="#h5-0-243" id="h5-0-243" class="i">+	ttywrite(buf, len);
</a><a href="#h5-0-244" id="h5-0-244" class="i">+}
</a><a href="#h5-0-245" id="h5-0-245" class="i">+
</a><a href="#h5-0-246" id="h5-0-246" class="i">+void
</a><a href="#h5-0-247" id="h5-0-247" class="i">+bpress(XEvent *e)
</a><a href="#h5-0-248" id="h5-0-248" class="i">+{
</a><a href="#h5-0-249" id="h5-0-249" class="i">+	struct timespec now;
</a><a href="#h5-0-250" id="h5-0-250" class="i">+	MouseShortcut *ms;
</a><a href="#h5-0-251" id="h5-0-251" class="i">+
</a><a href="#h5-0-252" id="h5-0-252" class="i">+	if (IS_SET(MODE_MOUSE) &amp;&amp; !(e-&gt;xbutton.state &amp; forceselmod)) {
</a><a href="#h5-0-253" id="h5-0-253" class="i">+		mousereport(e);
</a><a href="#h5-0-254" id="h5-0-254" class="i">+		return;
</a><a href="#h5-0-255" id="h5-0-255" class="i">+	}
</a><a href="#h5-0-256" id="h5-0-256" class="i">+
</a><a href="#h5-0-257" id="h5-0-257" class="i">+	for (ms = mshortcuts; ms &lt; mshortcuts + mshortcutslen; ms++) {
</a><a href="#h5-0-258" id="h5-0-258" class="i">+		if (e-&gt;xbutton.button == ms-&gt;b
</a><a href="#h5-0-259" id="h5-0-259" class="i">+				&amp;&amp; match(ms-&gt;mask, e-&gt;xbutton.state)) {
</a><a href="#h5-0-260" id="h5-0-260" class="i">+			ttysend(ms-&gt;s, strlen(ms-&gt;s));
</a><a href="#h5-0-261" id="h5-0-261" class="i">+			return;
</a><a href="#h5-0-262" id="h5-0-262" class="i">+		}
</a><a href="#h5-0-263" id="h5-0-263" class="i">+	}
</a><a href="#h5-0-264" id="h5-0-264" class="i">+
</a><a href="#h5-0-265" id="h5-0-265" class="i">+	if (e-&gt;xbutton.button == Button1) {
</a><a href="#h5-0-266" id="h5-0-266" class="i">+		clock_gettime(CLOCK_MONOTONIC, &amp;now);
</a><a href="#h5-0-267" id="h5-0-267" class="i">+
</a><a href="#h5-0-268" id="h5-0-268" class="i">+		/* Clear previous selection, logically and visually. */
</a><a href="#h5-0-269" id="h5-0-269" class="i">+		selclear_(NULL);
</a><a href="#h5-0-270" id="h5-0-270" class="i">+		sel.mode = SEL_EMPTY;
</a><a href="#h5-0-271" id="h5-0-271" class="i">+		sel.type = SEL_REGULAR;
</a><a href="#h5-0-272" id="h5-0-272" class="i">+		sel.oe.x = sel.ob.x = x2col(e-&gt;xbutton.x);
</a><a href="#h5-0-273" id="h5-0-273" class="i">+		sel.oe.y = sel.ob.y = y2row(e-&gt;xbutton.y);
</a><a href="#h5-0-274" id="h5-0-274" class="i">+
</a><a href="#h5-0-275" id="h5-0-275" class="i">+		/*
</a><a href="#h5-0-276" id="h5-0-276" class="i">+		 * If the user clicks below predefined timeouts specific
</a><a href="#h5-0-277" id="h5-0-277" class="i">+		 * snapping behaviour is exposed.
</a><a href="#h5-0-278" id="h5-0-278" class="i">+		 */
</a><a href="#h5-0-279" id="h5-0-279" class="i">+		if (TIMEDIFF(now, sel.tclick2) &lt;= tripleclicktimeout) {
</a><a href="#h5-0-280" id="h5-0-280" class="i">+			sel.snap = SNAP_LINE;
</a><a href="#h5-0-281" id="h5-0-281" class="i">+		} else if (TIMEDIFF(now, sel.tclick1) &lt;= doubleclicktimeout) {
</a><a href="#h5-0-282" id="h5-0-282" class="i">+			sel.snap = SNAP_WORD;
</a><a href="#h5-0-283" id="h5-0-283" class="i">+		} else {
</a><a href="#h5-0-284" id="h5-0-284" class="i">+			sel.snap = 0;
</a><a href="#h5-0-285" id="h5-0-285" class="i">+		}
</a><a href="#h5-0-286" id="h5-0-286" class="i">+		selnormalize();
</a><a href="#h5-0-287" id="h5-0-287" class="i">+
</a><a href="#h5-0-288" id="h5-0-288" class="i">+		if (sel.snap != 0)
</a><a href="#h5-0-289" id="h5-0-289" class="i">+			sel.mode = SEL_READY;
</a><a href="#h5-0-290" id="h5-0-290" class="i">+		tsetdirt(sel.nb.y, sel.ne.y);
</a><a href="#h5-0-291" id="h5-0-291" class="i">+		sel.tclick2 = sel.tclick1;
</a><a href="#h5-0-292" id="h5-0-292" class="i">+		sel.tclick1 = now;
</a><a href="#h5-0-293" id="h5-0-293" class="i">+	}
</a><a href="#h5-0-294" id="h5-0-294" class="i">+}
</a><a href="#h5-0-295" id="h5-0-295" class="i">+
</a><a href="#h5-0-296" id="h5-0-296" class="i">+void
</a><a href="#h5-0-297" id="h5-0-297" class="i">+selcopy(Time t)
</a><a href="#h5-0-298" id="h5-0-298" class="i">+{
</a><a href="#h5-0-299" id="h5-0-299" class="i">+	xsetsel(getsel(), t);
</a><a href="#h5-0-300" id="h5-0-300" class="i">+}
</a><a href="#h5-0-301" id="h5-0-301" class="i">+
</a><a href="#h5-0-302" id="h5-0-302" class="i">+void
</a><a href="#h5-0-303" id="h5-0-303" class="i">+propnotify(XEvent *e)
</a><a href="#h5-0-304" id="h5-0-304" class="i">+{
</a><a href="#h5-0-305" id="h5-0-305" class="i">+	XPropertyEvent *xpev;
</a><a href="#h5-0-306" id="h5-0-306" class="i">+	Atom clipboard = XInternAtom(xw.dpy, &quot;CLIPBOARD&quot;, 0);
</a><a href="#h5-0-307" id="h5-0-307" class="i">+
</a><a href="#h5-0-308" id="h5-0-308" class="i">+	xpev = &amp;e-&gt;xproperty;
</a><a href="#h5-0-309" id="h5-0-309" class="i">+	if (xpev-&gt;state == PropertyNewValue &amp;&amp;
</a><a href="#h5-0-310" id="h5-0-310" class="i">+			(xpev-&gt;atom == XA_PRIMARY ||
</a><a href="#h5-0-311" id="h5-0-311" class="i">+			 xpev-&gt;atom == clipboard)) {
</a><a href="#h5-0-312" id="h5-0-312" class="i">+		selnotify(e);
</a><a href="#h5-0-313" id="h5-0-313" class="i">+	}
</a><a href="#h5-0-314" id="h5-0-314" class="i">+}
</a><a href="#h5-0-315" id="h5-0-315" class="i">+
</a><a href="#h5-0-316" id="h5-0-316" class="i">+void
</a><a href="#h5-0-317" id="h5-0-317" class="i">+selnotify(XEvent *e)
</a><a href="#h5-0-318" id="h5-0-318" class="i">+{
</a><a href="#h5-0-319" id="h5-0-319" class="i">+	ulong nitems, ofs, rem;
</a><a href="#h5-0-320" id="h5-0-320" class="i">+	int format;
</a><a href="#h5-0-321" id="h5-0-321" class="i">+	uchar *data, *last, *repl;
</a><a href="#h5-0-322" id="h5-0-322" class="i">+	Atom type, incratom, property;
</a><a href="#h5-0-323" id="h5-0-323" class="i">+
</a><a href="#h5-0-324" id="h5-0-324" class="i">+	incratom = XInternAtom(xw.dpy, &quot;INCR&quot;, 0);
</a><a href="#h5-0-325" id="h5-0-325" class="i">+
</a><a href="#h5-0-326" id="h5-0-326" class="i">+	ofs = 0;
</a><a href="#h5-0-327" id="h5-0-327" class="i">+	if (e-&gt;type == SelectionNotify) {
</a><a href="#h5-0-328" id="h5-0-328" class="i">+		property = e-&gt;xselection.property;
</a><a href="#h5-0-329" id="h5-0-329" class="i">+	} else if(e-&gt;type == PropertyNotify) {
</a><a href="#h5-0-330" id="h5-0-330" class="i">+		property = e-&gt;xproperty.atom;
</a><a href="#h5-0-331" id="h5-0-331" class="i">+	} else {
</a><a href="#h5-0-332" id="h5-0-332" class="i">+		return;
</a><a href="#h5-0-333" id="h5-0-333" class="i">+	}
</a><a href="#h5-0-334" id="h5-0-334" class="i">+	if (property == None)
</a><a href="#h5-0-335" id="h5-0-335" class="i">+		return;
</a><a href="#h5-0-336" id="h5-0-336" class="i">+
</a><a href="#h5-0-337" id="h5-0-337" class="i">+	do {
</a><a href="#h5-0-338" id="h5-0-338" class="i">+		if (XGetWindowProperty(xw.dpy, xw.win, property, ofs,
</a><a href="#h5-0-339" id="h5-0-339" class="i">+					BUFSIZ/4, False, AnyPropertyType,
</a><a href="#h5-0-340" id="h5-0-340" class="i">+					&amp;type, &amp;format, &amp;nitems, &amp;rem,
</a><a href="#h5-0-341" id="h5-0-341" class="i">+					&amp;data)) {
</a><a href="#h5-0-342" id="h5-0-342" class="i">+			fprintf(stderr, &quot;Clipboard allocation failed\n&quot;);
</a><a href="#h5-0-343" id="h5-0-343" class="i">+			return;
</a><a href="#h5-0-344" id="h5-0-344" class="i">+		}
</a><a href="#h5-0-345" id="h5-0-345" class="i">+
</a><a href="#h5-0-346" id="h5-0-346" class="i">+		if (e-&gt;type == PropertyNotify &amp;&amp; nitems == 0 &amp;&amp; rem == 0) {
</a><a href="#h5-0-347" id="h5-0-347" class="i">+			/*
</a><a href="#h5-0-348" id="h5-0-348" class="i">+			 * If there is some PropertyNotify with no data, then
</a><a href="#h5-0-349" id="h5-0-349" class="i">+			 * this is the signal of the selection owner that all
</a><a href="#h5-0-350" id="h5-0-350" class="i">+			 * data has been transferred. We won&#39;t need to receive
</a><a href="#h5-0-351" id="h5-0-351" class="i">+			 * PropertyNotify events anymore.
</a><a href="#h5-0-352" id="h5-0-352" class="i">+			 */
</a><a href="#h5-0-353" id="h5-0-353" class="i">+			MODBIT(xw.attrs.event_mask, 0, PropertyChangeMask);
</a><a href="#h5-0-354" id="h5-0-354" class="i">+			XChangeWindowAttributes(xw.dpy, xw.win, CWEventMask,
</a><a href="#h5-0-355" id="h5-0-355" class="i">+					&amp;xw.attrs);
</a><a href="#h5-0-356" id="h5-0-356" class="i">+		}
</a><a href="#h5-0-357" id="h5-0-357" class="i">+
</a><a href="#h5-0-358" id="h5-0-358" class="i">+		if (type == incratom) {
</a><a href="#h5-0-359" id="h5-0-359" class="i">+			/*
</a><a href="#h5-0-360" id="h5-0-360" class="i">+			 * Activate the PropertyNotify events so we receive
</a><a href="#h5-0-361" id="h5-0-361" class="i">+			 * when the selection owner does send us the next
</a><a href="#h5-0-362" id="h5-0-362" class="i">+			 * chunk of data.
</a><a href="#h5-0-363" id="h5-0-363" class="i">+			 */
</a><a href="#h5-0-364" id="h5-0-364" class="i">+			MODBIT(xw.attrs.event_mask, 1, PropertyChangeMask);
</a><a href="#h5-0-365" id="h5-0-365" class="i">+			XChangeWindowAttributes(xw.dpy, xw.win, CWEventMask,
</a><a href="#h5-0-366" id="h5-0-366" class="i">+					&amp;xw.attrs);
</a><a href="#h5-0-367" id="h5-0-367" class="i">+
</a><a href="#h5-0-368" id="h5-0-368" class="i">+			/*
</a><a href="#h5-0-369" id="h5-0-369" class="i">+			 * Deleting the property is the transfer start signal.
</a><a href="#h5-0-370" id="h5-0-370" class="i">+			 */
</a><a href="#h5-0-371" id="h5-0-371" class="i">+			XDeleteProperty(xw.dpy, xw.win, (int)property);
</a><a href="#h5-0-372" id="h5-0-372" class="i">+			continue;
</a><a href="#h5-0-373" id="h5-0-373" class="i">+		}
</a><a href="#h5-0-374" id="h5-0-374" class="i">+
</a><a href="#h5-0-375" id="h5-0-375" class="i">+		/*
</a><a href="#h5-0-376" id="h5-0-376" class="i">+		 * As seen in getsel:
</a><a href="#h5-0-377" id="h5-0-377" class="i">+		 * Line endings are inconsistent in the terminal and GUI world
</a><a href="#h5-0-378" id="h5-0-378" class="i">+		 * copy and pasting. When receiving some selection data,
</a><a href="#h5-0-379" id="h5-0-379" class="i">+		 * replace all &#39;\n&#39; with &#39;\r&#39;.
</a><a href="#h5-0-380" id="h5-0-380" class="i">+		 * FIXME: Fix the computer world.
</a><a href="#h5-0-381" id="h5-0-381" class="i">+		 */
</a><a href="#h5-0-382" id="h5-0-382" class="i">+		repl = data;
</a><a href="#h5-0-383" id="h5-0-383" class="i">+		last = data + nitems * format / 8;
</a><a href="#h5-0-384" id="h5-0-384" class="i">+		while ((repl = memchr(repl, &#39;\n&#39;, last - repl))) {
</a><a href="#h5-0-385" id="h5-0-385" class="i">+			*repl++ = &#39;\r&#39;;
</a><a href="#h5-0-386" id="h5-0-386" class="i">+		}
</a><a href="#h5-0-387" id="h5-0-387" class="i">+
</a><a href="#h5-0-388" id="h5-0-388" class="i">+		if (IS_SET(MODE_BRCKTPASTE) &amp;&amp; ofs == 0)
</a><a href="#h5-0-389" id="h5-0-389" class="i">+			ttywrite(&quot;\033[200~&quot;, 6);
</a><a href="#h5-0-390" id="h5-0-390" class="i">+		ttysend((char *)data, nitems * format / 8);
</a><a href="#h5-0-391" id="h5-0-391" class="i">+		if (IS_SET(MODE_BRCKTPASTE) &amp;&amp; rem == 0)
</a><a href="#h5-0-392" id="h5-0-392" class="i">+			ttywrite(&quot;\033[201~&quot;, 6);
</a><a href="#h5-0-393" id="h5-0-393" class="i">+		XFree(data);
</a><a href="#h5-0-394" id="h5-0-394" class="i">+		/* number of 32-bit chunks returned */
</a><a href="#h5-0-395" id="h5-0-395" class="i">+		ofs += nitems * format / 32;
</a><a href="#h5-0-396" id="h5-0-396" class="i">+	} while (rem &gt; 0);
</a><a href="#h5-0-397" id="h5-0-397" class="i">+
</a><a href="#h5-0-398" id="h5-0-398" class="i">+	/*
</a><a href="#h5-0-399" id="h5-0-399" class="i">+	 * Deleting the property again tells the selection owner to send the
</a><a href="#h5-0-400" id="h5-0-400" class="i">+	 * next data chunk in the property.
</a><a href="#h5-0-401" id="h5-0-401" class="i">+	 */
</a><a href="#h5-0-402" id="h5-0-402" class="i">+	XDeleteProperty(xw.dpy, xw.win, (int)property);
</a><a href="#h5-0-403" id="h5-0-403" class="i">+}
</a><a href="#h5-0-404" id="h5-0-404" class="i">+
</a><a href="#h5-0-405" id="h5-0-405" class="i">+void
</a><a href="#h5-0-406" id="h5-0-406" class="i">+xselpaste(void)
</a><a href="#h5-0-407" id="h5-0-407" class="i">+{
</a><a href="#h5-0-408" id="h5-0-408" class="i">+	XConvertSelection(xw.dpy, XA_PRIMARY, xsel.xtarget, XA_PRIMARY,
</a><a href="#h5-0-409" id="h5-0-409" class="i">+			xw.win, CurrentTime);
</a><a href="#h5-0-410" id="h5-0-410" class="i">+}
</a><a href="#h5-0-411" id="h5-0-411" class="i">+
</a><a href="#h5-0-412" id="h5-0-412" class="i">+void
</a><a href="#h5-0-413" id="h5-0-413" class="i">+xclipcopy(void)
</a><a href="#h5-0-414" id="h5-0-414" class="i">+{
</a><a href="#h5-0-415" id="h5-0-415" class="i">+	Atom clipboard;
</a><a href="#h5-0-416" id="h5-0-416" class="i">+
</a><a href="#h5-0-417" id="h5-0-417" class="i">+	if (sel.clipboard != NULL)
</a><a href="#h5-0-418" id="h5-0-418" class="i">+		free(sel.clipboard);
</a><a href="#h5-0-419" id="h5-0-419" class="i">+
</a><a href="#h5-0-420" id="h5-0-420" class="i">+	if (sel.primary != NULL) {
</a><a href="#h5-0-421" id="h5-0-421" class="i">+		sel.clipboard = xstrdup(sel.primary);
</a><a href="#h5-0-422" id="h5-0-422" class="i">+		clipboard = XInternAtom(xw.dpy, &quot;CLIPBOARD&quot;, 0);
</a><a href="#h5-0-423" id="h5-0-423" class="i">+		XSetSelectionOwner(xw.dpy, clipboard, xw.win, CurrentTime);
</a><a href="#h5-0-424" id="h5-0-424" class="i">+	}
</a><a href="#h5-0-425" id="h5-0-425" class="i">+}
</a><a href="#h5-0-426" id="h5-0-426" class="i">+
</a><a href="#h5-0-427" id="h5-0-427" class="i">+void
</a><a href="#h5-0-428" id="h5-0-428" class="i">+xclippaste(void)
</a><a href="#h5-0-429" id="h5-0-429" class="i">+{
</a><a href="#h5-0-430" id="h5-0-430" class="i">+	Atom clipboard;
</a><a href="#h5-0-431" id="h5-0-431" class="i">+
</a><a href="#h5-0-432" id="h5-0-432" class="i">+	clipboard = XInternAtom(xw.dpy, &quot;CLIPBOARD&quot;, 0);
</a><a href="#h5-0-433" id="h5-0-433" class="i">+	XConvertSelection(xw.dpy, clipboard, xsel.xtarget, clipboard,
</a><a href="#h5-0-434" id="h5-0-434" class="i">+			xw.win, CurrentTime);
</a><a href="#h5-0-435" id="h5-0-435" class="i">+}
</a><a href="#h5-0-436" id="h5-0-436" class="i">+
</a><a href="#h5-0-437" id="h5-0-437" class="i">+void
</a><a href="#h5-0-438" id="h5-0-438" class="i">+selclear_(XEvent *e)
</a><a href="#h5-0-439" id="h5-0-439" class="i">+{
</a><a href="#h5-0-440" id="h5-0-440" class="i">+	selclear();
</a><a href="#h5-0-441" id="h5-0-441" class="i">+}
</a><a href="#h5-0-442" id="h5-0-442" class="i">+
</a><a href="#h5-0-443" id="h5-0-443" class="i">+void
</a><a href="#h5-0-444" id="h5-0-444" class="i">+selrequest(XEvent *e)
</a><a href="#h5-0-445" id="h5-0-445" class="i">+{
</a><a href="#h5-0-446" id="h5-0-446" class="i">+	XSelectionRequestEvent *xsre;
</a><a href="#h5-0-447" id="h5-0-447" class="i">+	XSelectionEvent xev;
</a><a href="#h5-0-448" id="h5-0-448" class="i">+	Atom xa_targets, string, clipboard;
</a><a href="#h5-0-449" id="h5-0-449" class="i">+	char *seltext;
</a><a href="#h5-0-450" id="h5-0-450" class="i">+
</a><a href="#h5-0-451" id="h5-0-451" class="i">+	xsre = (XSelectionRequestEvent *) e;
</a><a href="#h5-0-452" id="h5-0-452" class="i">+	xev.type = SelectionNotify;
</a><a href="#h5-0-453" id="h5-0-453" class="i">+	xev.requestor = xsre-&gt;requestor;
</a><a href="#h5-0-454" id="h5-0-454" class="i">+	xev.selection = xsre-&gt;selection;
</a><a href="#h5-0-455" id="h5-0-455" class="i">+	xev.target = xsre-&gt;target;
</a><a href="#h5-0-456" id="h5-0-456" class="i">+	xev.time = xsre-&gt;time;
</a><a href="#h5-0-457" id="h5-0-457" class="i">+	if (xsre-&gt;property == None)
</a><a href="#h5-0-458" id="h5-0-458" class="i">+		xsre-&gt;property = xsre-&gt;target;
</a><a href="#h5-0-459" id="h5-0-459" class="i">+
</a><a href="#h5-0-460" id="h5-0-460" class="i">+	/* reject */
</a><a href="#h5-0-461" id="h5-0-461" class="i">+	xev.property = None;
</a><a href="#h5-0-462" id="h5-0-462" class="i">+
</a><a href="#h5-0-463" id="h5-0-463" class="i">+	xa_targets = XInternAtom(xw.dpy, &quot;TARGETS&quot;, 0);
</a><a href="#h5-0-464" id="h5-0-464" class="i">+	if (xsre-&gt;target == xa_targets) {
</a><a href="#h5-0-465" id="h5-0-465" class="i">+		/* respond with the supported type */
</a><a href="#h5-0-466" id="h5-0-466" class="i">+		string = xsel.xtarget;
</a><a href="#h5-0-467" id="h5-0-467" class="i">+		XChangeProperty(xsre-&gt;display, xsre-&gt;requestor, xsre-&gt;property,
</a><a href="#h5-0-468" id="h5-0-468" class="i">+				XA_ATOM, 32, PropModeReplace,
</a><a href="#h5-0-469" id="h5-0-469" class="i">+				(uchar *) &amp;string, 1);
</a><a href="#h5-0-470" id="h5-0-470" class="i">+		xev.property = xsre-&gt;property;
</a><a href="#h5-0-471" id="h5-0-471" class="i">+	} else if (xsre-&gt;target == xsel.xtarget || xsre-&gt;target == XA_STRING) {
</a><a href="#h5-0-472" id="h5-0-472" class="i">+		/*
</a><a href="#h5-0-473" id="h5-0-473" class="i">+		 * xith XA_STRING non ascii characters may be incorrect in the
</a><a href="#h5-0-474" id="h5-0-474" class="i">+		 * requestor. It is not our problem, use utf8.
</a><a href="#h5-0-475" id="h5-0-475" class="i">+		 */
</a><a href="#h5-0-476" id="h5-0-476" class="i">+		clipboard = XInternAtom(xw.dpy, &quot;CLIPBOARD&quot;, 0);
</a><a href="#h5-0-477" id="h5-0-477" class="i">+		if (xsre-&gt;selection == XA_PRIMARY) {
</a><a href="#h5-0-478" id="h5-0-478" class="i">+			seltext = sel.primary;
</a><a href="#h5-0-479" id="h5-0-479" class="i">+		} else if (xsre-&gt;selection == clipboard) {
</a><a href="#h5-0-480" id="h5-0-480" class="i">+			seltext = sel.clipboard;
</a><a href="#h5-0-481" id="h5-0-481" class="i">+		} else {
</a><a href="#h5-0-482" id="h5-0-482" class="i">+			fprintf(stderr,
</a><a href="#h5-0-483" id="h5-0-483" class="i">+				&quot;Unhandled clipboard selection 0x%lx\n&quot;,
</a><a href="#h5-0-484" id="h5-0-484" class="i">+				xsre-&gt;selection);
</a><a href="#h5-0-485" id="h5-0-485" class="i">+			return;
</a><a href="#h5-0-486" id="h5-0-486" class="i">+		}
</a><a href="#h5-0-487" id="h5-0-487" class="i">+		if (seltext != NULL) {
</a><a href="#h5-0-488" id="h5-0-488" class="i">+			XChangeProperty(xsre-&gt;display, xsre-&gt;requestor,
</a><a href="#h5-0-489" id="h5-0-489" class="i">+					xsre-&gt;property, xsre-&gt;target,
</a><a href="#h5-0-490" id="h5-0-490" class="i">+					8, PropModeReplace,
</a><a href="#h5-0-491" id="h5-0-491" class="i">+					(uchar *)seltext, strlen(seltext));
</a><a href="#h5-0-492" id="h5-0-492" class="i">+			xev.property = xsre-&gt;property;
</a><a href="#h5-0-493" id="h5-0-493" class="i">+		}
</a><a href="#h5-0-494" id="h5-0-494" class="i">+	}
</a><a href="#h5-0-495" id="h5-0-495" class="i">+
</a><a href="#h5-0-496" id="h5-0-496" class="i">+	/* all done, send a notification to the listener */
</a><a href="#h5-0-497" id="h5-0-497" class="i">+	if (!XSendEvent(xsre-&gt;display, xsre-&gt;requestor, 1, 0, (XEvent *) &amp;xev))
</a><a href="#h5-0-498" id="h5-0-498" class="i">+		fprintf(stderr, &quot;Error sending SelectionNotify event\n&quot;);
</a><a href="#h5-0-499" id="h5-0-499" class="i">+}
</a><a href="#h5-0-500" id="h5-0-500" class="i">+
</a><a href="#h5-0-501" id="h5-0-501" class="i">+void
</a><a href="#h5-0-502" id="h5-0-502" class="i">+xsetsel(char *str, Time t)
</a><a href="#h5-0-503" id="h5-0-503" class="i">+{
</a><a href="#h5-0-504" id="h5-0-504" class="i">+	free(sel.primary);
</a><a href="#h5-0-505" id="h5-0-505" class="i">+	sel.primary = str;
</a><a href="#h5-0-506" id="h5-0-506" class="i">+
</a><a href="#h5-0-507" id="h5-0-507" class="i">+	XSetSelectionOwner(xw.dpy, XA_PRIMARY, xw.win, t);
</a><a href="#h5-0-508" id="h5-0-508" class="i">+	if (XGetSelectionOwner(xw.dpy, XA_PRIMARY) != xw.win)
</a><a href="#h5-0-509" id="h5-0-509" class="i">+		selclear_(NULL);
</a><a href="#h5-0-510" id="h5-0-510" class="i">+}
</a><a href="#h5-0-511" id="h5-0-511" class="i">+
</a><a href="#h5-0-512" id="h5-0-512" class="i">+void
</a><a href="#h5-0-513" id="h5-0-513" class="i">+brelease(XEvent *e)
</a><a href="#h5-0-514" id="h5-0-514" class="i">+{
</a><a href="#h5-0-515" id="h5-0-515" class="i">+	if (IS_SET(MODE_MOUSE) &amp;&amp; !(e-&gt;xbutton.state &amp; forceselmod)) {
</a><a href="#h5-0-516" id="h5-0-516" class="i">+		mousereport(e);
</a><a href="#h5-0-517" id="h5-0-517" class="i">+		return;
</a><a href="#h5-0-518" id="h5-0-518" class="i">+	}
</a><a href="#h5-0-519" id="h5-0-519" class="i">+
</a><a href="#h5-0-520" id="h5-0-520" class="i">+	if (e-&gt;xbutton.button == Button2) {
</a><a href="#h5-0-521" id="h5-0-521" class="i">+		xselpaste();
</a><a href="#h5-0-522" id="h5-0-522" class="i">+	} else if (e-&gt;xbutton.button == Button1) {
</a><a href="#h5-0-523" id="h5-0-523" class="i">+		if (sel.mode == SEL_READY) {
</a><a href="#h5-0-524" id="h5-0-524" class="i">+			getbuttoninfo(e);
</a><a href="#h5-0-525" id="h5-0-525" class="i">+			selcopy(e-&gt;xbutton.time);
</a><a href="#h5-0-526" id="h5-0-526" class="i">+		} else
</a><a href="#h5-0-527" id="h5-0-527" class="i">+			selclear_(NULL);
</a><a href="#h5-0-528" id="h5-0-528" class="i">+		sel.mode = SEL_IDLE;
</a><a href="#h5-0-529" id="h5-0-529" class="i">+		tsetdirt(sel.nb.y, sel.ne.y);
</a><a href="#h5-0-530" id="h5-0-530" class="i">+	}
</a><a href="#h5-0-531" id="h5-0-531" class="i">+}
</a><a href="#h5-0-532" id="h5-0-532" class="i">+
</a><a href="#h5-0-533" id="h5-0-533" class="i">+void
</a><a href="#h5-0-534" id="h5-0-534" class="i">+bmotion(XEvent *e)
</a><a href="#h5-0-535" id="h5-0-535" class="i">+{
</a><a href="#h5-0-536" id="h5-0-536" class="i">+	int oldey, oldex, oldsby, oldsey;
</a><a href="#h5-0-537" id="h5-0-537" class="i">+
</a><a href="#h5-0-538" id="h5-0-538" class="i">+	if (IS_SET(MODE_MOUSE) &amp;&amp; !(e-&gt;xbutton.state &amp; forceselmod)) {
</a><a href="#h5-0-539" id="h5-0-539" class="i">+		mousereport(e);
</a><a href="#h5-0-540" id="h5-0-540" class="i">+		return;
</a><a href="#h5-0-541" id="h5-0-541" class="i">+	}
</a><a href="#h5-0-542" id="h5-0-542" class="i">+
</a><a href="#h5-0-543" id="h5-0-543" class="i">+	if (!sel.mode)
</a><a href="#h5-0-544" id="h5-0-544" class="i">+		return;
</a><a href="#h5-0-545" id="h5-0-545" class="i">+
</a><a href="#h5-0-546" id="h5-0-546" class="i">+	sel.mode = SEL_READY;
</a><a href="#h5-0-547" id="h5-0-547" class="i">+	oldey = sel.oe.y;
</a><a href="#h5-0-548" id="h5-0-548" class="i">+	oldex = sel.oe.x;
</a><a href="#h5-0-549" id="h5-0-549" class="i">+	oldsby = sel.nb.y;
</a><a href="#h5-0-550" id="h5-0-550" class="i">+	oldsey = sel.ne.y;
</a><a href="#h5-0-551" id="h5-0-551" class="i">+	getbuttoninfo(e);
</a><a href="#h5-0-552" id="h5-0-552" class="i">+
</a><a href="#h5-0-553" id="h5-0-553" class="i">+	if (oldey != sel.oe.y || oldex != sel.oe.x)
</a><a href="#h5-0-554" id="h5-0-554" class="i">+		tsetdirt(MIN(sel.nb.y, oldsby), MAX(sel.ne.y, oldsey));
</a><a href="#h5-0-555" id="h5-0-555" class="i">+}
</a><a href="#h5-0-556" id="h5-0-556" class="i">+
</a><a href="#h5-0-557" id="h5-0-557" class="i">+void
</a><a href="#h5-0-558" id="h5-0-558" class="i">+xresize(int col, int row)
</a><a href="#h5-0-559" id="h5-0-559" class="i">+{
</a><a href="#h5-0-560" id="h5-0-560" class="i">+	win.tw = MAX(1, col * win.cw);
</a><a href="#h5-0-561" id="h5-0-561" class="i">+	win.th = MAX(1, row * win.ch);
</a><a href="#h5-0-562" id="h5-0-562" class="i">+
</a><a href="#h5-0-563" id="h5-0-563" class="i">+	XFreePixmap(xw.dpy, xw.buf);
</a><a href="#h5-0-564" id="h5-0-564" class="i">+	xw.buf = XCreatePixmap(xw.dpy, xw.win, win.w, win.h,
</a><a href="#h5-0-565" id="h5-0-565" class="i">+			DefaultDepth(xw.dpy, xw.scr));
</a><a href="#h5-0-566" id="h5-0-566" class="i">+	XftDrawChange(xw.draw, xw.buf);
</a><a href="#h5-0-567" id="h5-0-567" class="i">+	xclear(0, 0, win.w, win.h);
</a><a href="#h5-0-568" id="h5-0-568" class="i">+}
</a><a href="#h5-0-569" id="h5-0-569" class="i">+
</a><a href="#h5-0-570" id="h5-0-570" class="i">+ushort
</a><a href="#h5-0-571" id="h5-0-571" class="i">+sixd_to_16bit(int x)
</a><a href="#h5-0-572" id="h5-0-572" class="i">+{
</a><a href="#h5-0-573" id="h5-0-573" class="i">+	return x == 0 ? 0 : 0x3737 + 0x2828 * x;
</a><a href="#h5-0-574" id="h5-0-574" class="i">+}
</a><a href="#h5-0-575" id="h5-0-575" class="i">+
</a><a href="#h5-0-576" id="h5-0-576" class="i">+int
</a><a href="#h5-0-577" id="h5-0-577" class="i">+xloadcolor(int i, const char *name, Color *ncolor)
</a><a href="#h5-0-578" id="h5-0-578" class="i">+{
</a><a href="#h5-0-579" id="h5-0-579" class="i">+	XRenderColor color = { .alpha = 0xffff };
</a><a href="#h5-0-580" id="h5-0-580" class="i">+
</a><a href="#h5-0-581" id="h5-0-581" class="i">+	if (!name) {
</a><a href="#h5-0-582" id="h5-0-582" class="i">+		if (BETWEEN(i, 16, 255)) { /* 256 color */
</a><a href="#h5-0-583" id="h5-0-583" class="i">+			if (i &lt; 6*6*6+16) { /* same colors as xterm */
</a><a href="#h5-0-584" id="h5-0-584" class="i">+				color.red   = sixd_to_16bit( ((i-16)/36)%6 );
</a><a href="#h5-0-585" id="h5-0-585" class="i">+				color.green = sixd_to_16bit( ((i-16)/6) %6 );
</a><a href="#h5-0-586" id="h5-0-586" class="i">+				color.blue  = sixd_to_16bit( ((i-16)/1) %6 );
</a><a href="#h5-0-587" id="h5-0-587" class="i">+			} else { /* greyscale */
</a><a href="#h5-0-588" id="h5-0-588" class="i">+				color.red = 0x0808 + 0x0a0a * (i - (6*6*6+16));
</a><a href="#h5-0-589" id="h5-0-589" class="i">+				color.green = color.blue = color.red;
</a><a href="#h5-0-590" id="h5-0-590" class="i">+			}
</a><a href="#h5-0-591" id="h5-0-591" class="i">+			return XftColorAllocValue(xw.dpy, xw.vis,
</a><a href="#h5-0-592" id="h5-0-592" class="i">+			                          xw.cmap, &amp;color, ncolor);
</a><a href="#h5-0-593" id="h5-0-593" class="i">+		} else
</a><a href="#h5-0-594" id="h5-0-594" class="i">+			name = colorname[i];
</a><a href="#h5-0-595" id="h5-0-595" class="i">+	}
</a><a href="#h5-0-596" id="h5-0-596" class="i">+
</a><a href="#h5-0-597" id="h5-0-597" class="i">+	return XftColorAllocName(xw.dpy, xw.vis, xw.cmap, name, ncolor);
</a><a href="#h5-0-598" id="h5-0-598" class="i">+}
</a><a href="#h5-0-599" id="h5-0-599" class="i">+
</a><a href="#h5-0-600" id="h5-0-600" class="i">+void
</a><a href="#h5-0-601" id="h5-0-601" class="i">+xloadcols(void)
</a><a href="#h5-0-602" id="h5-0-602" class="i">+{
</a><a href="#h5-0-603" id="h5-0-603" class="i">+	int i;
</a><a href="#h5-0-604" id="h5-0-604" class="i">+	static int loaded;
</a><a href="#h5-0-605" id="h5-0-605" class="i">+	Color *cp;
</a><a href="#h5-0-606" id="h5-0-606" class="i">+
</a><a href="#h5-0-607" id="h5-0-607" class="i">+	dc.collen = MAX(colornamelen, 256);
</a><a href="#h5-0-608" id="h5-0-608" class="i">+	dc.col = xmalloc(dc.collen * sizeof(Color));
</a><a href="#h5-0-609" id="h5-0-609" class="i">+
</a><a href="#h5-0-610" id="h5-0-610" class="i">+	if (loaded) {
</a><a href="#h5-0-611" id="h5-0-611" class="i">+		for (cp = dc.col; cp &lt; &amp;dc.col[dc.collen]; ++cp)
</a><a href="#h5-0-612" id="h5-0-612" class="i">+			XftColorFree(xw.dpy, xw.vis, xw.cmap, cp);
</a><a href="#h5-0-613" id="h5-0-613" class="i">+	}
</a><a href="#h5-0-614" id="h5-0-614" class="i">+
</a><a href="#h5-0-615" id="h5-0-615" class="i">+	for (i = 0; i &lt; dc.collen; i++)
</a><a href="#h5-0-616" id="h5-0-616" class="i">+		if (!xloadcolor(i, NULL, &amp;dc.col[i])) {
</a><a href="#h5-0-617" id="h5-0-617" class="i">+			if (colorname[i])
</a><a href="#h5-0-618" id="h5-0-618" class="i">+				die(&quot;Could not allocate color &#39;%s&#39;\n&quot;, colorname[i]);
</a><a href="#h5-0-619" id="h5-0-619" class="i">+			else
</a><a href="#h5-0-620" id="h5-0-620" class="i">+				die(&quot;Could not allocate color %d\n&quot;, i);
</a><a href="#h5-0-621" id="h5-0-621" class="i">+		}
</a><a href="#h5-0-622" id="h5-0-622" class="i">+	loaded = 1;
</a><a href="#h5-0-623" id="h5-0-623" class="i">+}
</a><a href="#h5-0-624" id="h5-0-624" class="i">+
</a><a href="#h5-0-625" id="h5-0-625" class="i">+int
</a><a href="#h5-0-626" id="h5-0-626" class="i">+xsetcolorname(int x, const char *name)
</a><a href="#h5-0-627" id="h5-0-627" class="i">+{
</a><a href="#h5-0-628" id="h5-0-628" class="i">+	Color ncolor;
</a><a href="#h5-0-629" id="h5-0-629" class="i">+
</a><a href="#h5-0-630" id="h5-0-630" class="i">+	if (!BETWEEN(x, 0, dc.collen))
</a><a href="#h5-0-631" id="h5-0-631" class="i">+		return 1;
</a><a href="#h5-0-632" id="h5-0-632" class="i">+
</a><a href="#h5-0-633" id="h5-0-633" class="i">+
</a><a href="#h5-0-634" id="h5-0-634" class="i">+	if (!xloadcolor(x, name, &amp;ncolor))
</a><a href="#h5-0-635" id="h5-0-635" class="i">+		return 1;
</a><a href="#h5-0-636" id="h5-0-636" class="i">+
</a><a href="#h5-0-637" id="h5-0-637" class="i">+	XftColorFree(xw.dpy, xw.vis, xw.cmap, &amp;dc.col[x]);
</a><a href="#h5-0-638" id="h5-0-638" class="i">+	dc.col[x] = ncolor;
</a><a href="#h5-0-639" id="h5-0-639" class="i">+
</a><a href="#h5-0-640" id="h5-0-640" class="i">+	return 0;
</a><a href="#h5-0-641" id="h5-0-641" class="i">+}
</a><a href="#h5-0-642" id="h5-0-642" class="i">+
</a><a href="#h5-0-643" id="h5-0-643" class="i">+/*
</a><a href="#h5-0-644" id="h5-0-644" class="i">+ * Absolute coordinates.
</a><a href="#h5-0-645" id="h5-0-645" class="i">+ */
</a><a href="#h5-0-646" id="h5-0-646" class="i">+void
</a><a href="#h5-0-647" id="h5-0-647" class="i">+xclear(int x1, int y1, int x2, int y2)
</a><a href="#h5-0-648" id="h5-0-648" class="i">+{
</a><a href="#h5-0-649" id="h5-0-649" class="i">+	XftDrawRect(xw.draw,
</a><a href="#h5-0-650" id="h5-0-650" class="i">+			&amp;dc.col[IS_SET(MODE_REVERSE)? defaultfg : defaultbg],
</a><a href="#h5-0-651" id="h5-0-651" class="i">+			x1, y1, x2-x1, y2-y1);
</a><a href="#h5-0-652" id="h5-0-652" class="i">+}
</a><a href="#h5-0-653" id="h5-0-653" class="i">+
</a><a href="#h5-0-654" id="h5-0-654" class="i">+void
</a><a href="#h5-0-655" id="h5-0-655" class="i">+xhints(void)
</a><a href="#h5-0-656" id="h5-0-656" class="i">+{
</a><a href="#h5-0-657" id="h5-0-657" class="i">+	XClassHint class = {opt_name ? opt_name : termname,
</a><a href="#h5-0-658" id="h5-0-658" class="i">+	                    opt_class ? opt_class : termname};
</a><a href="#h5-0-659" id="h5-0-659" class="i">+	XWMHints wm = {.flags = InputHint, .input = 1};
</a><a href="#h5-0-660" id="h5-0-660" class="i">+	XSizeHints *sizeh = NULL;
</a><a href="#h5-0-661" id="h5-0-661" class="i">+
</a><a href="#h5-0-662" id="h5-0-662" class="i">+	sizeh = XAllocSizeHints();
</a><a href="#h5-0-663" id="h5-0-663" class="i">+
</a><a href="#h5-0-664" id="h5-0-664" class="i">+	sizeh-&gt;flags = PSize | PResizeInc | PBaseSize;
</a><a href="#h5-0-665" id="h5-0-665" class="i">+	sizeh-&gt;height = win.h;
</a><a href="#h5-0-666" id="h5-0-666" class="i">+	sizeh-&gt;width = win.w;
</a><a href="#h5-0-667" id="h5-0-667" class="i">+	sizeh-&gt;height_inc = win.ch;
</a><a href="#h5-0-668" id="h5-0-668" class="i">+	sizeh-&gt;width_inc = win.cw;
</a><a href="#h5-0-669" id="h5-0-669" class="i">+	sizeh-&gt;base_height = 2 * borderpx;
</a><a href="#h5-0-670" id="h5-0-670" class="i">+	sizeh-&gt;base_width = 2 * borderpx;
</a><a href="#h5-0-671" id="h5-0-671" class="i">+	if (xw.isfixed) {
</a><a href="#h5-0-672" id="h5-0-672" class="i">+		sizeh-&gt;flags |= PMaxSize | PMinSize;
</a><a href="#h5-0-673" id="h5-0-673" class="i">+		sizeh-&gt;min_width = sizeh-&gt;max_width = win.w;
</a><a href="#h5-0-674" id="h5-0-674" class="i">+		sizeh-&gt;min_height = sizeh-&gt;max_height = win.h;
</a><a href="#h5-0-675" id="h5-0-675" class="i">+	}
</a><a href="#h5-0-676" id="h5-0-676" class="i">+	if (xw.gm &amp; (XValue|YValue)) {
</a><a href="#h5-0-677" id="h5-0-677" class="i">+		sizeh-&gt;flags |= USPosition | PWinGravity;
</a><a href="#h5-0-678" id="h5-0-678" class="i">+		sizeh-&gt;x = xw.l;
</a><a href="#h5-0-679" id="h5-0-679" class="i">+		sizeh-&gt;y = xw.t;
</a><a href="#h5-0-680" id="h5-0-680" class="i">+		sizeh-&gt;win_gravity = xgeommasktogravity(xw.gm);
</a><a href="#h5-0-681" id="h5-0-681" class="i">+	}
</a><a href="#h5-0-682" id="h5-0-682" class="i">+
</a><a href="#h5-0-683" id="h5-0-683" class="i">+	XSetWMProperties(xw.dpy, xw.win, NULL, NULL, NULL, 0, sizeh, &amp;wm,
</a><a href="#h5-0-684" id="h5-0-684" class="i">+			&amp;class);
</a><a href="#h5-0-685" id="h5-0-685" class="i">+	XFree(sizeh);
</a><a href="#h5-0-686" id="h5-0-686" class="i">+}
</a><a href="#h5-0-687" id="h5-0-687" class="i">+
</a><a href="#h5-0-688" id="h5-0-688" class="i">+int
</a><a href="#h5-0-689" id="h5-0-689" class="i">+xgeommasktogravity(int mask)
</a><a href="#h5-0-690" id="h5-0-690" class="i">+{
</a><a href="#h5-0-691" id="h5-0-691" class="i">+	switch (mask &amp; (XNegative|YNegative)) {
</a><a href="#h5-0-692" id="h5-0-692" class="i">+	case 0:
</a><a href="#h5-0-693" id="h5-0-693" class="i">+		return NorthWestGravity;
</a><a href="#h5-0-694" id="h5-0-694" class="i">+	case XNegative:
</a><a href="#h5-0-695" id="h5-0-695" class="i">+		return NorthEastGravity;
</a><a href="#h5-0-696" id="h5-0-696" class="i">+	case YNegative:
</a><a href="#h5-0-697" id="h5-0-697" class="i">+		return SouthWestGravity;
</a><a href="#h5-0-698" id="h5-0-698" class="i">+	}
</a><a href="#h5-0-699" id="h5-0-699" class="i">+
</a><a href="#h5-0-700" id="h5-0-700" class="i">+	return SouthEastGravity;
</a><a href="#h5-0-701" id="h5-0-701" class="i">+}
</a><a href="#h5-0-702" id="h5-0-702" class="i">+
</a><a href="#h5-0-703" id="h5-0-703" class="i">+int
</a><a href="#h5-0-704" id="h5-0-704" class="i">+xloadfont(Font *f, FcPattern *pattern)
</a><a href="#h5-0-705" id="h5-0-705" class="i">+{
</a><a href="#h5-0-706" id="h5-0-706" class="i">+	FcPattern *configured;
</a><a href="#h5-0-707" id="h5-0-707" class="i">+	FcPattern *match;
</a><a href="#h5-0-708" id="h5-0-708" class="i">+	FcResult result;
</a><a href="#h5-0-709" id="h5-0-709" class="i">+	XGlyphInfo extents;
</a><a href="#h5-0-710" id="h5-0-710" class="i">+	int wantattr, haveattr;
</a><a href="#h5-0-711" id="h5-0-711" class="i">+
</a><a href="#h5-0-712" id="h5-0-712" class="i">+	/*
</a><a href="#h5-0-713" id="h5-0-713" class="i">+	 * Manually configure instead of calling XftMatchFont
</a><a href="#h5-0-714" id="h5-0-714" class="i">+	 * so that we can use the configured pattern for
</a><a href="#h5-0-715" id="h5-0-715" class="i">+	 * &quot;missing glyph&quot; lookups.
</a><a href="#h5-0-716" id="h5-0-716" class="i">+	 */
</a><a href="#h5-0-717" id="h5-0-717" class="i">+	configured = FcPatternDuplicate(pattern);
</a><a href="#h5-0-718" id="h5-0-718" class="i">+	if (!configured)
</a><a href="#h5-0-719" id="h5-0-719" class="i">+		return 1;
</a><a href="#h5-0-720" id="h5-0-720" class="i">+
</a><a href="#h5-0-721" id="h5-0-721" class="i">+	FcConfigSubstitute(NULL, configured, FcMatchPattern);
</a><a href="#h5-0-722" id="h5-0-722" class="i">+	XftDefaultSubstitute(xw.dpy, xw.scr, configured);
</a><a href="#h5-0-723" id="h5-0-723" class="i">+
</a><a href="#h5-0-724" id="h5-0-724" class="i">+	match = FcFontMatch(NULL, configured, &amp;result);
</a><a href="#h5-0-725" id="h5-0-725" class="i">+	if (!match) {
</a><a href="#h5-0-726" id="h5-0-726" class="i">+		FcPatternDestroy(configured);
</a><a href="#h5-0-727" id="h5-0-727" class="i">+		return 1;
</a><a href="#h5-0-728" id="h5-0-728" class="i">+	}
</a><a href="#h5-0-729" id="h5-0-729" class="i">+
</a><a href="#h5-0-730" id="h5-0-730" class="i">+	if (!(f-&gt;match = XftFontOpenPattern(xw.dpy, match))) {
</a><a href="#h5-0-731" id="h5-0-731" class="i">+		FcPatternDestroy(configured);
</a><a href="#h5-0-732" id="h5-0-732" class="i">+		FcPatternDestroy(match);
</a><a href="#h5-0-733" id="h5-0-733" class="i">+		return 1;
</a><a href="#h5-0-734" id="h5-0-734" class="i">+	}
</a><a href="#h5-0-735" id="h5-0-735" class="i">+
</a><a href="#h5-0-736" id="h5-0-736" class="i">+	if ((XftPatternGetInteger(pattern, &quot;slant&quot;, 0, &amp;wantattr) ==
</a><a href="#h5-0-737" id="h5-0-737" class="i">+	    XftResultMatch)) {
</a><a href="#h5-0-738" id="h5-0-738" class="i">+		/*
</a><a href="#h5-0-739" id="h5-0-739" class="i">+		 * Check if xft was unable to find a font with the appropriate
</a><a href="#h5-0-740" id="h5-0-740" class="i">+		 * slant but gave us one anyway. Try to mitigate.
</a><a href="#h5-0-741" id="h5-0-741" class="i">+		 */
</a><a href="#h5-0-742" id="h5-0-742" class="i">+		if ((XftPatternGetInteger(f-&gt;match-&gt;pattern, &quot;slant&quot;, 0,
</a><a href="#h5-0-743" id="h5-0-743" class="i">+		    &amp;haveattr) != XftResultMatch) || haveattr &lt; wantattr) {
</a><a href="#h5-0-744" id="h5-0-744" class="i">+			f-&gt;badslant = 1;
</a><a href="#h5-0-745" id="h5-0-745" class="i">+			fputs(&quot;st: font slant does not match\n&quot;, stderr);
</a><a href="#h5-0-746" id="h5-0-746" class="i">+		}
</a><a href="#h5-0-747" id="h5-0-747" class="i">+	}
</a><a href="#h5-0-748" id="h5-0-748" class="i">+
</a><a href="#h5-0-749" id="h5-0-749" class="i">+	if ((XftPatternGetInteger(pattern, &quot;weight&quot;, 0, &amp;wantattr) ==
</a><a href="#h5-0-750" id="h5-0-750" class="i">+	    XftResultMatch)) {
</a><a href="#h5-0-751" id="h5-0-751" class="i">+		if ((XftPatternGetInteger(f-&gt;match-&gt;pattern, &quot;weight&quot;, 0,
</a><a href="#h5-0-752" id="h5-0-752" class="i">+		    &amp;haveattr) != XftResultMatch) || haveattr != wantattr) {
</a><a href="#h5-0-753" id="h5-0-753" class="i">+			f-&gt;badweight = 1;
</a><a href="#h5-0-754" id="h5-0-754" class="i">+			fputs(&quot;st: font weight does not match\n&quot;, stderr);
</a><a href="#h5-0-755" id="h5-0-755" class="i">+		}
</a><a href="#h5-0-756" id="h5-0-756" class="i">+	}
</a><a href="#h5-0-757" id="h5-0-757" class="i">+
</a><a href="#h5-0-758" id="h5-0-758" class="i">+	XftTextExtentsUtf8(xw.dpy, f-&gt;match,
</a><a href="#h5-0-759" id="h5-0-759" class="i">+		(const FcChar8 *) ascii_printable,
</a><a href="#h5-0-760" id="h5-0-760" class="i">+		strlen(ascii_printable), &amp;extents);
</a><a href="#h5-0-761" id="h5-0-761" class="i">+
</a><a href="#h5-0-762" id="h5-0-762" class="i">+	f-&gt;set = NULL;
</a><a href="#h5-0-763" id="h5-0-763" class="i">+	f-&gt;pattern = configured;
</a><a href="#h5-0-764" id="h5-0-764" class="i">+
</a><a href="#h5-0-765" id="h5-0-765" class="i">+	f-&gt;ascent = f-&gt;match-&gt;ascent;
</a><a href="#h5-0-766" id="h5-0-766" class="i">+	f-&gt;descent = f-&gt;match-&gt;descent;
</a><a href="#h5-0-767" id="h5-0-767" class="i">+	f-&gt;lbearing = 0;
</a><a href="#h5-0-768" id="h5-0-768" class="i">+	f-&gt;rbearing = f-&gt;match-&gt;max_advance_width;
</a><a href="#h5-0-769" id="h5-0-769" class="i">+
</a><a href="#h5-0-770" id="h5-0-770" class="i">+	f-&gt;height = f-&gt;ascent + f-&gt;descent;
</a><a href="#h5-0-771" id="h5-0-771" class="i">+	f-&gt;width = DIVCEIL(extents.xOff, strlen(ascii_printable));
</a><a href="#h5-0-772" id="h5-0-772" class="i">+
</a><a href="#h5-0-773" id="h5-0-773" class="i">+	return 0;
</a><a href="#h5-0-774" id="h5-0-774" class="i">+}
</a><a href="#h5-0-775" id="h5-0-775" class="i">+
</a><a href="#h5-0-776" id="h5-0-776" class="i">+void
</a><a href="#h5-0-777" id="h5-0-777" class="i">+xloadfonts(char *fontstr, double fontsize)
</a><a href="#h5-0-778" id="h5-0-778" class="i">+{
</a><a href="#h5-0-779" id="h5-0-779" class="i">+	FcPattern *pattern;
</a><a href="#h5-0-780" id="h5-0-780" class="i">+	double fontval;
</a><a href="#h5-0-781" id="h5-0-781" class="i">+	float ceilf(float);
</a><a href="#h5-0-782" id="h5-0-782" class="i">+
</a><a href="#h5-0-783" id="h5-0-783" class="i">+	if (fontstr[0] == &#39;-&#39;) {
</a><a href="#h5-0-784" id="h5-0-784" class="i">+		pattern = XftXlfdParse(fontstr, False, False);
</a><a href="#h5-0-785" id="h5-0-785" class="i">+	} else {
</a><a href="#h5-0-786" id="h5-0-786" class="i">+		pattern = FcNameParse((FcChar8 *)fontstr);
</a><a href="#h5-0-787" id="h5-0-787" class="i">+	}
</a><a href="#h5-0-788" id="h5-0-788" class="i">+
</a><a href="#h5-0-789" id="h5-0-789" class="i">+	if (!pattern)
</a><a href="#h5-0-790" id="h5-0-790" class="i">+		die(&quot;st: can&#39;t open font %s\n&quot;, fontstr);
</a><a href="#h5-0-791" id="h5-0-791" class="i">+
</a><a href="#h5-0-792" id="h5-0-792" class="i">+	if (fontsize &gt; 1) {
</a><a href="#h5-0-793" id="h5-0-793" class="i">+		FcPatternDel(pattern, FC_PIXEL_SIZE);
</a><a href="#h5-0-794" id="h5-0-794" class="i">+		FcPatternDel(pattern, FC_SIZE);
</a><a href="#h5-0-795" id="h5-0-795" class="i">+		FcPatternAddDouble(pattern, FC_PIXEL_SIZE, (double)fontsize);
</a><a href="#h5-0-796" id="h5-0-796" class="i">+		usedfontsize = fontsize;
</a><a href="#h5-0-797" id="h5-0-797" class="i">+	} else {
</a><a href="#h5-0-798" id="h5-0-798" class="i">+		if (FcPatternGetDouble(pattern, FC_PIXEL_SIZE, 0, &amp;fontval) ==
</a><a href="#h5-0-799" id="h5-0-799" class="i">+				FcResultMatch) {
</a><a href="#h5-0-800" id="h5-0-800" class="i">+			usedfontsize = fontval;
</a><a href="#h5-0-801" id="h5-0-801" class="i">+		} else if (FcPatternGetDouble(pattern, FC_SIZE, 0, &amp;fontval) ==
</a><a href="#h5-0-802" id="h5-0-802" class="i">+				FcResultMatch) {
</a><a href="#h5-0-803" id="h5-0-803" class="i">+			usedfontsize = -1;
</a><a href="#h5-0-804" id="h5-0-804" class="i">+		} else {
</a><a href="#h5-0-805" id="h5-0-805" class="i">+			/*
</a><a href="#h5-0-806" id="h5-0-806" class="i">+			 * Default font size is 12, if none given. This is to
</a><a href="#h5-0-807" id="h5-0-807" class="i">+			 * have a known usedfontsize value.
</a><a href="#h5-0-808" id="h5-0-808" class="i">+			 */
</a><a href="#h5-0-809" id="h5-0-809" class="i">+			FcPatternAddDouble(pattern, FC_PIXEL_SIZE, 12);
</a><a href="#h5-0-810" id="h5-0-810" class="i">+			usedfontsize = 12;
</a><a href="#h5-0-811" id="h5-0-811" class="i">+		}
</a><a href="#h5-0-812" id="h5-0-812" class="i">+		defaultfontsize = usedfontsize;
</a><a href="#h5-0-813" id="h5-0-813" class="i">+	}
</a><a href="#h5-0-814" id="h5-0-814" class="i">+
</a><a href="#h5-0-815" id="h5-0-815" class="i">+	if (xloadfont(&amp;dc.font, pattern))
</a><a href="#h5-0-816" id="h5-0-816" class="i">+		die(&quot;st: can&#39;t open font %s\n&quot;, fontstr);
</a><a href="#h5-0-817" id="h5-0-817" class="i">+
</a><a href="#h5-0-818" id="h5-0-818" class="i">+	if (usedfontsize &lt; 0) {
</a><a href="#h5-0-819" id="h5-0-819" class="i">+		FcPatternGetDouble(dc.font.match-&gt;pattern,
</a><a href="#h5-0-820" id="h5-0-820" class="i">+		                   FC_PIXEL_SIZE, 0, &amp;fontval);
</a><a href="#h5-0-821" id="h5-0-821" class="i">+		usedfontsize = fontval;
</a><a href="#h5-0-822" id="h5-0-822" class="i">+		if (fontsize == 0)
</a><a href="#h5-0-823" id="h5-0-823" class="i">+			defaultfontsize = fontval;
</a><a href="#h5-0-824" id="h5-0-824" class="i">+	}
</a><a href="#h5-0-825" id="h5-0-825" class="i">+
</a><a href="#h5-0-826" id="h5-0-826" class="i">+	/* Setting character width and height. */
</a><a href="#h5-0-827" id="h5-0-827" class="i">+	win.cw = ceilf(dc.font.width * cwscale);
</a><a href="#h5-0-828" id="h5-0-828" class="i">+	win.ch = ceilf(dc.font.height * chscale);
</a><a href="#h5-0-829" id="h5-0-829" class="i">+
</a><a href="#h5-0-830" id="h5-0-830" class="i">+	FcPatternDel(pattern, FC_SLANT);
</a><a href="#h5-0-831" id="h5-0-831" class="i">+	FcPatternAddInteger(pattern, FC_SLANT, FC_SLANT_ITALIC);
</a><a href="#h5-0-832" id="h5-0-832" class="i">+	if (xloadfont(&amp;dc.ifont, pattern))
</a><a href="#h5-0-833" id="h5-0-833" class="i">+		die(&quot;st: can&#39;t open font %s\n&quot;, fontstr);
</a><a href="#h5-0-834" id="h5-0-834" class="i">+
</a><a href="#h5-0-835" id="h5-0-835" class="i">+	FcPatternDel(pattern, FC_WEIGHT);
</a><a href="#h5-0-836" id="h5-0-836" class="i">+	FcPatternAddInteger(pattern, FC_WEIGHT, FC_WEIGHT_BOLD);
</a><a href="#h5-0-837" id="h5-0-837" class="i">+	if (xloadfont(&amp;dc.ibfont, pattern))
</a><a href="#h5-0-838" id="h5-0-838" class="i">+		die(&quot;st: can&#39;t open font %s\n&quot;, fontstr);
</a><a href="#h5-0-839" id="h5-0-839" class="i">+
</a><a href="#h5-0-840" id="h5-0-840" class="i">+	FcPatternDel(pattern, FC_SLANT);
</a><a href="#h5-0-841" id="h5-0-841" class="i">+	FcPatternAddInteger(pattern, FC_SLANT, FC_SLANT_ROMAN);
</a><a href="#h5-0-842" id="h5-0-842" class="i">+	if (xloadfont(&amp;dc.bfont, pattern))
</a><a href="#h5-0-843" id="h5-0-843" class="i">+		die(&quot;st: can&#39;t open font %s\n&quot;, fontstr);
</a><a href="#h5-0-844" id="h5-0-844" class="i">+
</a><a href="#h5-0-845" id="h5-0-845" class="i">+	FcPatternDestroy(pattern);
</a><a href="#h5-0-846" id="h5-0-846" class="i">+}
</a><a href="#h5-0-847" id="h5-0-847" class="i">+
</a><a href="#h5-0-848" id="h5-0-848" class="i">+void
</a><a href="#h5-0-849" id="h5-0-849" class="i">+xunloadfont(Font *f)
</a><a href="#h5-0-850" id="h5-0-850" class="i">+{
</a><a href="#h5-0-851" id="h5-0-851" class="i">+	XftFontClose(xw.dpy, f-&gt;match);
</a><a href="#h5-0-852" id="h5-0-852" class="i">+	FcPatternDestroy(f-&gt;pattern);
</a><a href="#h5-0-853" id="h5-0-853" class="i">+	if (f-&gt;set)
</a><a href="#h5-0-854" id="h5-0-854" class="i">+		FcFontSetDestroy(f-&gt;set);
</a><a href="#h5-0-855" id="h5-0-855" class="i">+}
</a><a href="#h5-0-856" id="h5-0-856" class="i">+
</a><a href="#h5-0-857" id="h5-0-857" class="i">+void
</a><a href="#h5-0-858" id="h5-0-858" class="i">+xunloadfonts(void)
</a><a href="#h5-0-859" id="h5-0-859" class="i">+{
</a><a href="#h5-0-860" id="h5-0-860" class="i">+	/* Free the loaded fonts in the font cache.  */
</a><a href="#h5-0-861" id="h5-0-861" class="i">+	while (frclen &gt; 0)
</a><a href="#h5-0-862" id="h5-0-862" class="i">+		XftFontClose(xw.dpy, frc[--frclen].font);
</a><a href="#h5-0-863" id="h5-0-863" class="i">+
</a><a href="#h5-0-864" id="h5-0-864" class="i">+	xunloadfont(&amp;dc.font);
</a><a href="#h5-0-865" id="h5-0-865" class="i">+	xunloadfont(&amp;dc.bfont);
</a><a href="#h5-0-866" id="h5-0-866" class="i">+	xunloadfont(&amp;dc.ifont);
</a><a href="#h5-0-867" id="h5-0-867" class="i">+	xunloadfont(&amp;dc.ibfont);
</a><a href="#h5-0-868" id="h5-0-868" class="i">+}
</a><a href="#h5-0-869" id="h5-0-869" class="i">+
</a><a href="#h5-0-870" id="h5-0-870" class="i">+void
</a><a href="#h5-0-871" id="h5-0-871" class="i">+xinit(void)
</a><a href="#h5-0-872" id="h5-0-872" class="i">+{
</a><a href="#h5-0-873" id="h5-0-873" class="i">+	XGCValues gcvalues;
</a><a href="#h5-0-874" id="h5-0-874" class="i">+	Cursor cursor;
</a><a href="#h5-0-875" id="h5-0-875" class="i">+	Window parent;
</a><a href="#h5-0-876" id="h5-0-876" class="i">+	pid_t thispid = getpid();
</a><a href="#h5-0-877" id="h5-0-877" class="i">+	XColor xmousefg, xmousebg;
</a><a href="#h5-0-878" id="h5-0-878" class="i">+
</a><a href="#h5-0-879" id="h5-0-879" class="i">+	if (!(xw.dpy = XOpenDisplay(NULL)))
</a><a href="#h5-0-880" id="h5-0-880" class="i">+		die(&quot;Can&#39;t open display\n&quot;);
</a><a href="#h5-0-881" id="h5-0-881" class="i">+	xw.scr = XDefaultScreen(xw.dpy);
</a><a href="#h5-0-882" id="h5-0-882" class="i">+	xw.vis = XDefaultVisual(xw.dpy, xw.scr);
</a><a href="#h5-0-883" id="h5-0-883" class="i">+
</a><a href="#h5-0-884" id="h5-0-884" class="i">+	/* font */
</a><a href="#h5-0-885" id="h5-0-885" class="i">+	if (!FcInit())
</a><a href="#h5-0-886" id="h5-0-886" class="i">+		die(&quot;Could not init fontconfig.\n&quot;);
</a><a href="#h5-0-887" id="h5-0-887" class="i">+
</a><a href="#h5-0-888" id="h5-0-888" class="i">+	usedfont = (opt_font == NULL)? font : opt_font;
</a><a href="#h5-0-889" id="h5-0-889" class="i">+	xloadfonts(usedfont, 0);
</a><a href="#h5-0-890" id="h5-0-890" class="i">+
</a><a href="#h5-0-891" id="h5-0-891" class="i">+	/* colors */
</a><a href="#h5-0-892" id="h5-0-892" class="i">+	xw.cmap = XDefaultColormap(xw.dpy, xw.scr);
</a><a href="#h5-0-893" id="h5-0-893" class="i">+	xloadcols();
</a><a href="#h5-0-894" id="h5-0-894" class="i">+
</a><a href="#h5-0-895" id="h5-0-895" class="i">+	/* adjust fixed window geometry */
</a><a href="#h5-0-896" id="h5-0-896" class="i">+	win.w = 2 * borderpx + term.col * win.cw;
</a><a href="#h5-0-897" id="h5-0-897" class="i">+	win.h = 2 * borderpx + term.row * win.ch;
</a><a href="#h5-0-898" id="h5-0-898" class="i">+	if (xw.gm &amp; XNegative)
</a><a href="#h5-0-899" id="h5-0-899" class="i">+		xw.l += DisplayWidth(xw.dpy, xw.scr) - win.w - 2;
</a><a href="#h5-0-900" id="h5-0-900" class="i">+	if (xw.gm &amp; YNegative)
</a><a href="#h5-0-901" id="h5-0-901" class="i">+		xw.t += DisplayHeight(xw.dpy, xw.scr) - win.h - 2;
</a><a href="#h5-0-902" id="h5-0-902" class="i">+
</a><a href="#h5-0-903" id="h5-0-903" class="i">+	/* Events */
</a><a href="#h5-0-904" id="h5-0-904" class="i">+	xw.attrs.background_pixel = dc.col[defaultbg].pixel;
</a><a href="#h5-0-905" id="h5-0-905" class="i">+	xw.attrs.border_pixel = dc.col[defaultbg].pixel;
</a><a href="#h5-0-906" id="h5-0-906" class="i">+	xw.attrs.bit_gravity = NorthWestGravity;
</a><a href="#h5-0-907" id="h5-0-907" class="i">+	xw.attrs.event_mask = FocusChangeMask | KeyPressMask
</a><a href="#h5-0-908" id="h5-0-908" class="i">+		| ExposureMask | VisibilityChangeMask | StructureNotifyMask
</a><a href="#h5-0-909" id="h5-0-909" class="i">+		| ButtonMotionMask | ButtonPressMask | ButtonReleaseMask;
</a><a href="#h5-0-910" id="h5-0-910" class="i">+	xw.attrs.colormap = xw.cmap;
</a><a href="#h5-0-911" id="h5-0-911" class="i">+
</a><a href="#h5-0-912" id="h5-0-912" class="i">+	if (!(opt_embed &amp;&amp; (parent = strtol(opt_embed, NULL, 0))))
</a><a href="#h5-0-913" id="h5-0-913" class="i">+		parent = XRootWindow(xw.dpy, xw.scr);
</a><a href="#h5-0-914" id="h5-0-914" class="i">+	xw.win = XCreateWindow(xw.dpy, parent, xw.l, xw.t,
</a><a href="#h5-0-915" id="h5-0-915" class="i">+			win.w, win.h, 0, XDefaultDepth(xw.dpy, xw.scr), InputOutput,
</a><a href="#h5-0-916" id="h5-0-916" class="i">+			xw.vis, CWBackPixel | CWBorderPixel | CWBitGravity
</a><a href="#h5-0-917" id="h5-0-917" class="i">+			| CWEventMask | CWColormap, &amp;xw.attrs);
</a><a href="#h5-0-918" id="h5-0-918" class="i">+
</a><a href="#h5-0-919" id="h5-0-919" class="i">+	memset(&amp;gcvalues, 0, sizeof(gcvalues));
</a><a href="#h5-0-920" id="h5-0-920" class="i">+	gcvalues.graphics_exposures = False;
</a><a href="#h5-0-921" id="h5-0-921" class="i">+	dc.gc = XCreateGC(xw.dpy, parent, GCGraphicsExposures,
</a><a href="#h5-0-922" id="h5-0-922" class="i">+			&amp;gcvalues);
</a><a href="#h5-0-923" id="h5-0-923" class="i">+	xw.buf = XCreatePixmap(xw.dpy, xw.win, win.w, win.h,
</a><a href="#h5-0-924" id="h5-0-924" class="i">+			DefaultDepth(xw.dpy, xw.scr));
</a><a href="#h5-0-925" id="h5-0-925" class="i">+	XSetForeground(xw.dpy, dc.gc, dc.col[defaultbg].pixel);
</a><a href="#h5-0-926" id="h5-0-926" class="i">+	XFillRectangle(xw.dpy, xw.buf, dc.gc, 0, 0, win.w, win.h);
</a><a href="#h5-0-927" id="h5-0-927" class="i">+
</a><a href="#h5-0-928" id="h5-0-928" class="i">+	/* Xft rendering context */
</a><a href="#h5-0-929" id="h5-0-929" class="i">+	xw.draw = XftDrawCreate(xw.dpy, xw.buf, xw.vis, xw.cmap);
</a><a href="#h5-0-930" id="h5-0-930" class="i">+
</a><a href="#h5-0-931" id="h5-0-931" class="i">+	/* input methods */
</a><a href="#h5-0-932" id="h5-0-932" class="i">+	if ((xw.xim = XOpenIM(xw.dpy, NULL, NULL, NULL)) == NULL) {
</a><a href="#h5-0-933" id="h5-0-933" class="i">+		XSetLocaleModifiers(&quot;@im=local&quot;);
</a><a href="#h5-0-934" id="h5-0-934" class="i">+		if ((xw.xim =  XOpenIM(xw.dpy, NULL, NULL, NULL)) == NULL) {
</a><a href="#h5-0-935" id="h5-0-935" class="i">+			XSetLocaleModifiers(&quot;@im=&quot;);
</a><a href="#h5-0-936" id="h5-0-936" class="i">+			if ((xw.xim = XOpenIM(xw.dpy,
</a><a href="#h5-0-937" id="h5-0-937" class="i">+					NULL, NULL, NULL)) == NULL) {
</a><a href="#h5-0-938" id="h5-0-938" class="i">+				die(&quot;XOpenIM failed. Could not open input&quot;
</a><a href="#h5-0-939" id="h5-0-939" class="i">+					&quot; device.\n&quot;);
</a><a href="#h5-0-940" id="h5-0-940" class="i">+			}
</a><a href="#h5-0-941" id="h5-0-941" class="i">+		}
</a><a href="#h5-0-942" id="h5-0-942" class="i">+	}
</a><a href="#h5-0-943" id="h5-0-943" class="i">+	xw.xic = XCreateIC(xw.xim, XNInputStyle, XIMPreeditNothing
</a><a href="#h5-0-944" id="h5-0-944" class="i">+					   | XIMStatusNothing, XNClientWindow, xw.win,
</a><a href="#h5-0-945" id="h5-0-945" class="i">+					   XNFocusWindow, xw.win, NULL);
</a><a href="#h5-0-946" id="h5-0-946" class="i">+	if (xw.xic == NULL)
</a><a href="#h5-0-947" id="h5-0-947" class="i">+		die(&quot;XCreateIC failed. Could not obtain input method.\n&quot;);
</a><a href="#h5-0-948" id="h5-0-948" class="i">+
</a><a href="#h5-0-949" id="h5-0-949" class="i">+	/* white cursor, black outline */
</a><a href="#h5-0-950" id="h5-0-950" class="i">+	cursor = XCreateFontCursor(xw.dpy, mouseshape);
</a><a href="#h5-0-951" id="h5-0-951" class="i">+	XDefineCursor(xw.dpy, xw.win, cursor);
</a><a href="#h5-0-952" id="h5-0-952" class="i">+
</a><a href="#h5-0-953" id="h5-0-953" class="i">+	if (XParseColor(xw.dpy, xw.cmap, colorname[mousefg], &amp;xmousefg) == 0) {
</a><a href="#h5-0-954" id="h5-0-954" class="i">+		xmousefg.red   = 0xffff;
</a><a href="#h5-0-955" id="h5-0-955" class="i">+		xmousefg.green = 0xffff;
</a><a href="#h5-0-956" id="h5-0-956" class="i">+		xmousefg.blue  = 0xffff;
</a><a href="#h5-0-957" id="h5-0-957" class="i">+	}
</a><a href="#h5-0-958" id="h5-0-958" class="i">+
</a><a href="#h5-0-959" id="h5-0-959" class="i">+	if (XParseColor(xw.dpy, xw.cmap, colorname[mousebg], &amp;xmousebg) == 0) {
</a><a href="#h5-0-960" id="h5-0-960" class="i">+		xmousebg.red   = 0x0000;
</a><a href="#h5-0-961" id="h5-0-961" class="i">+		xmousebg.green = 0x0000;
</a><a href="#h5-0-962" id="h5-0-962" class="i">+		xmousebg.blue  = 0x0000;
</a><a href="#h5-0-963" id="h5-0-963" class="i">+	}
</a><a href="#h5-0-964" id="h5-0-964" class="i">+
</a><a href="#h5-0-965" id="h5-0-965" class="i">+	XRecolorCursor(xw.dpy, cursor, &amp;xmousefg, &amp;xmousebg);
</a><a href="#h5-0-966" id="h5-0-966" class="i">+
</a><a href="#h5-0-967" id="h5-0-967" class="i">+	xw.xembed = XInternAtom(xw.dpy, &quot;_XEMBED&quot;, False);
</a><a href="#h5-0-968" id="h5-0-968" class="i">+	xw.wmdeletewin = XInternAtom(xw.dpy, &quot;WM_DELETE_WINDOW&quot;, False);
</a><a href="#h5-0-969" id="h5-0-969" class="i">+	xw.netwmname = XInternAtom(xw.dpy, &quot;_NET_WM_NAME&quot;, False);
</a><a href="#h5-0-970" id="h5-0-970" class="i">+	XSetWMProtocols(xw.dpy, xw.win, &amp;xw.wmdeletewin, 1);
</a><a href="#h5-0-971" id="h5-0-971" class="i">+
</a><a href="#h5-0-972" id="h5-0-972" class="i">+	xw.netwmpid = XInternAtom(xw.dpy, &quot;_NET_WM_PID&quot;, False);
</a><a href="#h5-0-973" id="h5-0-973" class="i">+	XChangeProperty(xw.dpy, xw.win, xw.netwmpid, XA_CARDINAL, 32,
</a><a href="#h5-0-974" id="h5-0-974" class="i">+			PropModeReplace, (uchar *)&amp;thispid, 1);
</a><a href="#h5-0-975" id="h5-0-975" class="i">+
</a><a href="#h5-0-976" id="h5-0-976" class="i">+	resettitle();
</a><a href="#h5-0-977" id="h5-0-977" class="i">+	XMapWindow(xw.dpy, xw.win);
</a><a href="#h5-0-978" id="h5-0-978" class="i">+	xhints();
</a><a href="#h5-0-979" id="h5-0-979" class="i">+	XSync(xw.dpy, False);
</a><a href="#h5-0-980" id="h5-0-980" class="i">+
</a><a href="#h5-0-981" id="h5-0-981" class="i">+	xsel.xtarget = XInternAtom(xw.dpy, &quot;UTF8_STRING&quot;, 0);
</a><a href="#h5-0-982" id="h5-0-982" class="i">+	if (xsel.xtarget == None)
</a><a href="#h5-0-983" id="h5-0-983" class="i">+		xsel.xtarget = XA_STRING;
</a><a href="#h5-0-984" id="h5-0-984" class="i">+}
</a><a href="#h5-0-985" id="h5-0-985" class="i">+
</a><a href="#h5-0-986" id="h5-0-986" class="i">+int
</a><a href="#h5-0-987" id="h5-0-987" class="i">+xmakeglyphfontspecs(XftGlyphFontSpec *specs, const Glyph *glyphs, int len, int x, int y)
</a><a href="#h5-0-988" id="h5-0-988" class="i">+{
</a><a href="#h5-0-989" id="h5-0-989" class="i">+	float winx = borderpx + x * win.cw, winy = borderpx + y * win.ch, xp, yp;
</a><a href="#h5-0-990" id="h5-0-990" class="i">+	ushort mode, prevmode = USHRT_MAX;
</a><a href="#h5-0-991" id="h5-0-991" class="i">+	Font *font = &amp;dc.font;
</a><a href="#h5-0-992" id="h5-0-992" class="i">+	int frcflags = FRC_NORMAL;
</a><a href="#h5-0-993" id="h5-0-993" class="i">+	float runewidth = win.cw;
</a><a href="#h5-0-994" id="h5-0-994" class="i">+	Rune rune;
</a><a href="#h5-0-995" id="h5-0-995" class="i">+	FT_UInt glyphidx;
</a><a href="#h5-0-996" id="h5-0-996" class="i">+	FcResult fcres;
</a><a href="#h5-0-997" id="h5-0-997" class="i">+	FcPattern *fcpattern, *fontpattern;
</a><a href="#h5-0-998" id="h5-0-998" class="i">+	FcFontSet *fcsets[] = { NULL };
</a><a href="#h5-0-999" id="h5-0-999" class="i">+	FcCharSet *fccharset;
</a><a href="#h5-0-1000" id="h5-0-1000" class="i">+	int i, f, numspecs = 0;
</a><a href="#h5-0-1001" id="h5-0-1001" class="i">+
</a><a href="#h5-0-1002" id="h5-0-1002" class="i">+	for (i = 0, xp = winx, yp = winy + font-&gt;ascent; i &lt; len; ++i) {
</a><a href="#h5-0-1003" id="h5-0-1003" class="i">+		/* Fetch rune and mode for current glyph. */
</a><a href="#h5-0-1004" id="h5-0-1004" class="i">+		rune = glyphs[i].u;
</a><a href="#h5-0-1005" id="h5-0-1005" class="i">+		mode = glyphs[i].mode;
</a><a href="#h5-0-1006" id="h5-0-1006" class="i">+
</a><a href="#h5-0-1007" id="h5-0-1007" class="i">+		/* Skip dummy wide-character spacing. */
</a><a href="#h5-0-1008" id="h5-0-1008" class="i">+		if (mode == ATTR_WDUMMY)
</a><a href="#h5-0-1009" id="h5-0-1009" class="i">+			continue;
</a><a href="#h5-0-1010" id="h5-0-1010" class="i">+
</a><a href="#h5-0-1011" id="h5-0-1011" class="i">+		/* Determine font for glyph if different from previous glyph. */
</a><a href="#h5-0-1012" id="h5-0-1012" class="i">+		if (prevmode != mode) {
</a><a href="#h5-0-1013" id="h5-0-1013" class="i">+			prevmode = mode;
</a><a href="#h5-0-1014" id="h5-0-1014" class="i">+			font = &amp;dc.font;
</a><a href="#h5-0-1015" id="h5-0-1015" class="i">+			frcflags = FRC_NORMAL;
</a><a href="#h5-0-1016" id="h5-0-1016" class="i">+			runewidth = win.cw * ((mode &amp; ATTR_WIDE) ? 2.0f : 1.0f);
</a><a href="#h5-0-1017" id="h5-0-1017" class="i">+			if ((mode &amp; ATTR_ITALIC) &amp;&amp; (mode &amp; ATTR_BOLD)) {
</a><a href="#h5-0-1018" id="h5-0-1018" class="i">+				font = &amp;dc.ibfont;
</a><a href="#h5-0-1019" id="h5-0-1019" class="i">+				frcflags = FRC_ITALICBOLD;
</a><a href="#h5-0-1020" id="h5-0-1020" class="i">+			} else if (mode &amp; ATTR_ITALIC) {
</a><a href="#h5-0-1021" id="h5-0-1021" class="i">+				font = &amp;dc.ifont;
</a><a href="#h5-0-1022" id="h5-0-1022" class="i">+				frcflags = FRC_ITALIC;
</a><a href="#h5-0-1023" id="h5-0-1023" class="i">+			} else if (mode &amp; ATTR_BOLD) {
</a><a href="#h5-0-1024" id="h5-0-1024" class="i">+				font = &amp;dc.bfont;
</a><a href="#h5-0-1025" id="h5-0-1025" class="i">+				frcflags = FRC_BOLD;
</a><a href="#h5-0-1026" id="h5-0-1026" class="i">+			}
</a><a href="#h5-0-1027" id="h5-0-1027" class="i">+			yp = winy + font-&gt;ascent;
</a><a href="#h5-0-1028" id="h5-0-1028" class="i">+		}
</a><a href="#h5-0-1029" id="h5-0-1029" class="i">+
</a><a href="#h5-0-1030" id="h5-0-1030" class="i">+		/* Lookup character index with default font. */
</a><a href="#h5-0-1031" id="h5-0-1031" class="i">+		glyphidx = XftCharIndex(xw.dpy, font-&gt;match, rune);
</a><a href="#h5-0-1032" id="h5-0-1032" class="i">+		if (glyphidx) {
</a><a href="#h5-0-1033" id="h5-0-1033" class="i">+			specs[numspecs].font = font-&gt;match;
</a><a href="#h5-0-1034" id="h5-0-1034" class="i">+			specs[numspecs].glyph = glyphidx;
</a><a href="#h5-0-1035" id="h5-0-1035" class="i">+			specs[numspecs].x = (short)xp;
</a><a href="#h5-0-1036" id="h5-0-1036" class="i">+			specs[numspecs].y = (short)yp;
</a><a href="#h5-0-1037" id="h5-0-1037" class="i">+			xp += runewidth;
</a><a href="#h5-0-1038" id="h5-0-1038" class="i">+			numspecs++;
</a><a href="#h5-0-1039" id="h5-0-1039" class="i">+			continue;
</a><a href="#h5-0-1040" id="h5-0-1040" class="i">+		}
</a><a href="#h5-0-1041" id="h5-0-1041" class="i">+
</a><a href="#h5-0-1042" id="h5-0-1042" class="i">+		/* Fallback on font cache, search the font cache for match. */
</a><a href="#h5-0-1043" id="h5-0-1043" class="i">+		for (f = 0; f &lt; frclen; f++) {
</a><a href="#h5-0-1044" id="h5-0-1044" class="i">+			glyphidx = XftCharIndex(xw.dpy, frc[f].font, rune);
</a><a href="#h5-0-1045" id="h5-0-1045" class="i">+			/* Everything correct. */
</a><a href="#h5-0-1046" id="h5-0-1046" class="i">+			if (glyphidx &amp;&amp; frc[f].flags == frcflags)
</a><a href="#h5-0-1047" id="h5-0-1047" class="i">+				break;
</a><a href="#h5-0-1048" id="h5-0-1048" class="i">+			/* We got a default font for a not found glyph. */
</a><a href="#h5-0-1049" id="h5-0-1049" class="i">+			if (!glyphidx &amp;&amp; frc[f].flags == frcflags
</a><a href="#h5-0-1050" id="h5-0-1050" class="i">+					&amp;&amp; frc[f].unicodep == rune) {
</a><a href="#h5-0-1051" id="h5-0-1051" class="i">+				break;
</a><a href="#h5-0-1052" id="h5-0-1052" class="i">+			}
</a><a href="#h5-0-1053" id="h5-0-1053" class="i">+		}
</a><a href="#h5-0-1054" id="h5-0-1054" class="i">+
</a><a href="#h5-0-1055" id="h5-0-1055" class="i">+		/* Nothing was found. Use fontconfig to find matching font. */
</a><a href="#h5-0-1056" id="h5-0-1056" class="i">+		if (f &gt;= frclen) {
</a><a href="#h5-0-1057" id="h5-0-1057" class="i">+			if (!font-&gt;set)
</a><a href="#h5-0-1058" id="h5-0-1058" class="i">+				font-&gt;set = FcFontSort(0, font-&gt;pattern,
</a><a href="#h5-0-1059" id="h5-0-1059" class="i">+				                       1, 0, &amp;fcres);
</a><a href="#h5-0-1060" id="h5-0-1060" class="i">+			fcsets[0] = font-&gt;set;
</a><a href="#h5-0-1061" id="h5-0-1061" class="i">+
</a><a href="#h5-0-1062" id="h5-0-1062" class="i">+			/*
</a><a href="#h5-0-1063" id="h5-0-1063" class="i">+			 * Nothing was found in the cache. Now use
</a><a href="#h5-0-1064" id="h5-0-1064" class="i">+			 * some dozen of Fontconfig calls to get the
</a><a href="#h5-0-1065" id="h5-0-1065" class="i">+			 * font for one single character.
</a><a href="#h5-0-1066" id="h5-0-1066" class="i">+			 *
</a><a href="#h5-0-1067" id="h5-0-1067" class="i">+			 * Xft and fontconfig are design failures.
</a><a href="#h5-0-1068" id="h5-0-1068" class="i">+			 */
</a><a href="#h5-0-1069" id="h5-0-1069" class="i">+			fcpattern = FcPatternDuplicate(font-&gt;pattern);
</a><a href="#h5-0-1070" id="h5-0-1070" class="i">+			fccharset = FcCharSetCreate();
</a><a href="#h5-0-1071" id="h5-0-1071" class="i">+
</a><a href="#h5-0-1072" id="h5-0-1072" class="i">+			FcCharSetAddChar(fccharset, rune);
</a><a href="#h5-0-1073" id="h5-0-1073" class="i">+			FcPatternAddCharSet(fcpattern, FC_CHARSET,
</a><a href="#h5-0-1074" id="h5-0-1074" class="i">+					fccharset);
</a><a href="#h5-0-1075" id="h5-0-1075" class="i">+			FcPatternAddBool(fcpattern, FC_SCALABLE, 1);
</a><a href="#h5-0-1076" id="h5-0-1076" class="i">+
</a><a href="#h5-0-1077" id="h5-0-1077" class="i">+			FcConfigSubstitute(0, fcpattern,
</a><a href="#h5-0-1078" id="h5-0-1078" class="i">+					FcMatchPattern);
</a><a href="#h5-0-1079" id="h5-0-1079" class="i">+			FcDefaultSubstitute(fcpattern);
</a><a href="#h5-0-1080" id="h5-0-1080" class="i">+
</a><a href="#h5-0-1081" id="h5-0-1081" class="i">+			fontpattern = FcFontSetMatch(0, fcsets, 1,
</a><a href="#h5-0-1082" id="h5-0-1082" class="i">+					fcpattern, &amp;fcres);
</a><a href="#h5-0-1083" id="h5-0-1083" class="i">+
</a><a href="#h5-0-1084" id="h5-0-1084" class="i">+			/*
</a><a href="#h5-0-1085" id="h5-0-1085" class="i">+			 * Overwrite or create the new cache entry.
</a><a href="#h5-0-1086" id="h5-0-1086" class="i">+			 */
</a><a href="#h5-0-1087" id="h5-0-1087" class="i">+			if (frclen &gt;= LEN(frc)) {
</a><a href="#h5-0-1088" id="h5-0-1088" class="i">+				frclen = LEN(frc) - 1;
</a><a href="#h5-0-1089" id="h5-0-1089" class="i">+				XftFontClose(xw.dpy, frc[frclen].font);
</a><a href="#h5-0-1090" id="h5-0-1090" class="i">+				frc[frclen].unicodep = 0;
</a><a href="#h5-0-1091" id="h5-0-1091" class="i">+			}
</a><a href="#h5-0-1092" id="h5-0-1092" class="i">+
</a><a href="#h5-0-1093" id="h5-0-1093" class="i">+			frc[frclen].font = XftFontOpenPattern(xw.dpy,
</a><a href="#h5-0-1094" id="h5-0-1094" class="i">+					fontpattern);
</a><a href="#h5-0-1095" id="h5-0-1095" class="i">+			frc[frclen].flags = frcflags;
</a><a href="#h5-0-1096" id="h5-0-1096" class="i">+			frc[frclen].unicodep = rune;
</a><a href="#h5-0-1097" id="h5-0-1097" class="i">+
</a><a href="#h5-0-1098" id="h5-0-1098" class="i">+			glyphidx = XftCharIndex(xw.dpy, frc[frclen].font, rune);
</a><a href="#h5-0-1099" id="h5-0-1099" class="i">+
</a><a href="#h5-0-1100" id="h5-0-1100" class="i">+			f = frclen;
</a><a href="#h5-0-1101" id="h5-0-1101" class="i">+			frclen++;
</a><a href="#h5-0-1102" id="h5-0-1102" class="i">+
</a><a href="#h5-0-1103" id="h5-0-1103" class="i">+			FcPatternDestroy(fcpattern);
</a><a href="#h5-0-1104" id="h5-0-1104" class="i">+			FcCharSetDestroy(fccharset);
</a><a href="#h5-0-1105" id="h5-0-1105" class="i">+		}
</a><a href="#h5-0-1106" id="h5-0-1106" class="i">+
</a><a href="#h5-0-1107" id="h5-0-1107" class="i">+		specs[numspecs].font = frc[f].font;
</a><a href="#h5-0-1108" id="h5-0-1108" class="i">+		specs[numspecs].glyph = glyphidx;
</a><a href="#h5-0-1109" id="h5-0-1109" class="i">+		specs[numspecs].x = (short)xp;
</a><a href="#h5-0-1110" id="h5-0-1110" class="i">+		specs[numspecs].y = (short)yp;
</a><a href="#h5-0-1111" id="h5-0-1111" class="i">+		xp += runewidth;
</a><a href="#h5-0-1112" id="h5-0-1112" class="i">+		numspecs++;
</a><a href="#h5-0-1113" id="h5-0-1113" class="i">+	}
</a><a href="#h5-0-1114" id="h5-0-1114" class="i">+
</a><a href="#h5-0-1115" id="h5-0-1115" class="i">+	return numspecs;
</a><a href="#h5-0-1116" id="h5-0-1116" class="i">+}
</a><a href="#h5-0-1117" id="h5-0-1117" class="i">+
</a><a href="#h5-0-1118" id="h5-0-1118" class="i">+void
</a><a href="#h5-0-1119" id="h5-0-1119" class="i">+xdrawglyphfontspecs(const XftGlyphFontSpec *specs, Glyph base, int len, int x, int y)
</a><a href="#h5-0-1120" id="h5-0-1120" class="i">+{
</a><a href="#h5-0-1121" id="h5-0-1121" class="i">+	int charlen = len * ((base.mode &amp; ATTR_WIDE) ? 2 : 1);
</a><a href="#h5-0-1122" id="h5-0-1122" class="i">+	int winx = borderpx + x * win.cw, winy = borderpx + y * win.ch,
</a><a href="#h5-0-1123" id="h5-0-1123" class="i">+	    width = charlen * win.cw;
</a><a href="#h5-0-1124" id="h5-0-1124" class="i">+	Color *fg, *bg, *temp, revfg, revbg, truefg, truebg;
</a><a href="#h5-0-1125" id="h5-0-1125" class="i">+	XRenderColor colfg, colbg;
</a><a href="#h5-0-1126" id="h5-0-1126" class="i">+	XRectangle r;
</a><a href="#h5-0-1127" id="h5-0-1127" class="i">+
</a><a href="#h5-0-1128" id="h5-0-1128" class="i">+	/* Fallback on color display for attributes not supported by the font */
</a><a href="#h5-0-1129" id="h5-0-1129" class="i">+	if (base.mode &amp; ATTR_ITALIC &amp;&amp; base.mode &amp; ATTR_BOLD) {
</a><a href="#h5-0-1130" id="h5-0-1130" class="i">+		if (dc.ibfont.badslant || dc.ibfont.badweight)
</a><a href="#h5-0-1131" id="h5-0-1131" class="i">+			base.fg = defaultattr;
</a><a href="#h5-0-1132" id="h5-0-1132" class="i">+	} else if ((base.mode &amp; ATTR_ITALIC &amp;&amp; dc.ifont.badslant) ||
</a><a href="#h5-0-1133" id="h5-0-1133" class="i">+	    (base.mode &amp; ATTR_BOLD &amp;&amp; dc.bfont.badweight)) {
</a><a href="#h5-0-1134" id="h5-0-1134" class="i">+		base.fg = defaultattr;
</a><a href="#h5-0-1135" id="h5-0-1135" class="i">+	}
</a><a href="#h5-0-1136" id="h5-0-1136" class="i">+
</a><a href="#h5-0-1137" id="h5-0-1137" class="i">+	if (IS_TRUECOL(base.fg)) {
</a><a href="#h5-0-1138" id="h5-0-1138" class="i">+		colfg.alpha = 0xffff;
</a><a href="#h5-0-1139" id="h5-0-1139" class="i">+		colfg.red = TRUERED(base.fg);
</a><a href="#h5-0-1140" id="h5-0-1140" class="i">+		colfg.green = TRUEGREEN(base.fg);
</a><a href="#h5-0-1141" id="h5-0-1141" class="i">+		colfg.blue = TRUEBLUE(base.fg);
</a><a href="#h5-0-1142" id="h5-0-1142" class="i">+		XftColorAllocValue(xw.dpy, xw.vis, xw.cmap, &amp;colfg, &amp;truefg);
</a><a href="#h5-0-1143" id="h5-0-1143" class="i">+		fg = &amp;truefg;
</a><a href="#h5-0-1144" id="h5-0-1144" class="i">+	} else {
</a><a href="#h5-0-1145" id="h5-0-1145" class="i">+		fg = &amp;dc.col[base.fg];
</a><a href="#h5-0-1146" id="h5-0-1146" class="i">+	}
</a><a href="#h5-0-1147" id="h5-0-1147" class="i">+
</a><a href="#h5-0-1148" id="h5-0-1148" class="i">+	if (IS_TRUECOL(base.bg)) {
</a><a href="#h5-0-1149" id="h5-0-1149" class="i">+		colbg.alpha = 0xffff;
</a><a href="#h5-0-1150" id="h5-0-1150" class="i">+		colbg.green = TRUEGREEN(base.bg);
</a><a href="#h5-0-1151" id="h5-0-1151" class="i">+		colbg.red = TRUERED(base.bg);
</a><a href="#h5-0-1152" id="h5-0-1152" class="i">+		colbg.blue = TRUEBLUE(base.bg);
</a><a href="#h5-0-1153" id="h5-0-1153" class="i">+		XftColorAllocValue(xw.dpy, xw.vis, xw.cmap, &amp;colbg, &amp;truebg);
</a><a href="#h5-0-1154" id="h5-0-1154" class="i">+		bg = &amp;truebg;
</a><a href="#h5-0-1155" id="h5-0-1155" class="i">+	} else {
</a><a href="#h5-0-1156" id="h5-0-1156" class="i">+		bg = &amp;dc.col[base.bg];
</a><a href="#h5-0-1157" id="h5-0-1157" class="i">+	}
</a><a href="#h5-0-1158" id="h5-0-1158" class="i">+
</a><a href="#h5-0-1159" id="h5-0-1159" class="i">+	/* Change basic system colors [0-7] to bright system colors [8-15] */
</a><a href="#h5-0-1160" id="h5-0-1160" class="i">+	if ((base.mode &amp; ATTR_BOLD_FAINT) == ATTR_BOLD &amp;&amp; BETWEEN(base.fg, 0, 7))
</a><a href="#h5-0-1161" id="h5-0-1161" class="i">+		fg = &amp;dc.col[base.fg + 8];
</a><a href="#h5-0-1162" id="h5-0-1162" class="i">+
</a><a href="#h5-0-1163" id="h5-0-1163" class="i">+	if (IS_SET(MODE_REVERSE)) {
</a><a href="#h5-0-1164" id="h5-0-1164" class="i">+		if (fg == &amp;dc.col[defaultfg]) {
</a><a href="#h5-0-1165" id="h5-0-1165" class="i">+			fg = &amp;dc.col[defaultbg];
</a><a href="#h5-0-1166" id="h5-0-1166" class="i">+		} else {
</a><a href="#h5-0-1167" id="h5-0-1167" class="i">+			colfg.red = ~fg-&gt;color.red;
</a><a href="#h5-0-1168" id="h5-0-1168" class="i">+			colfg.green = ~fg-&gt;color.green;
</a><a href="#h5-0-1169" id="h5-0-1169" class="i">+			colfg.blue = ~fg-&gt;color.blue;
</a><a href="#h5-0-1170" id="h5-0-1170" class="i">+			colfg.alpha = fg-&gt;color.alpha;
</a><a href="#h5-0-1171" id="h5-0-1171" class="i">+			XftColorAllocValue(xw.dpy, xw.vis, xw.cmap, &amp;colfg,
</a><a href="#h5-0-1172" id="h5-0-1172" class="i">+					&amp;revfg);
</a><a href="#h5-0-1173" id="h5-0-1173" class="i">+			fg = &amp;revfg;
</a><a href="#h5-0-1174" id="h5-0-1174" class="i">+		}
</a><a href="#h5-0-1175" id="h5-0-1175" class="i">+
</a><a href="#h5-0-1176" id="h5-0-1176" class="i">+		if (bg == &amp;dc.col[defaultbg]) {
</a><a href="#h5-0-1177" id="h5-0-1177" class="i">+			bg = &amp;dc.col[defaultfg];
</a><a href="#h5-0-1178" id="h5-0-1178" class="i">+		} else {
</a><a href="#h5-0-1179" id="h5-0-1179" class="i">+			colbg.red = ~bg-&gt;color.red;
</a><a href="#h5-0-1180" id="h5-0-1180" class="i">+			colbg.green = ~bg-&gt;color.green;
</a><a href="#h5-0-1181" id="h5-0-1181" class="i">+			colbg.blue = ~bg-&gt;color.blue;
</a><a href="#h5-0-1182" id="h5-0-1182" class="i">+			colbg.alpha = bg-&gt;color.alpha;
</a><a href="#h5-0-1183" id="h5-0-1183" class="i">+			XftColorAllocValue(xw.dpy, xw.vis, xw.cmap, &amp;colbg,
</a><a href="#h5-0-1184" id="h5-0-1184" class="i">+					&amp;revbg);
</a><a href="#h5-0-1185" id="h5-0-1185" class="i">+			bg = &amp;revbg;
</a><a href="#h5-0-1186" id="h5-0-1186" class="i">+		}
</a><a href="#h5-0-1187" id="h5-0-1187" class="i">+	}
</a><a href="#h5-0-1188" id="h5-0-1188" class="i">+
</a><a href="#h5-0-1189" id="h5-0-1189" class="i">+	if (base.mode &amp; ATTR_REVERSE) {
</a><a href="#h5-0-1190" id="h5-0-1190" class="i">+		temp = fg;
</a><a href="#h5-0-1191" id="h5-0-1191" class="i">+		fg = bg;
</a><a href="#h5-0-1192" id="h5-0-1192" class="i">+		bg = temp;
</a><a href="#h5-0-1193" id="h5-0-1193" class="i">+	}
</a><a href="#h5-0-1194" id="h5-0-1194" class="i">+
</a><a href="#h5-0-1195" id="h5-0-1195" class="i">+	if ((base.mode &amp; ATTR_BOLD_FAINT) == ATTR_FAINT) {
</a><a href="#h5-0-1196" id="h5-0-1196" class="i">+		colfg.red = fg-&gt;color.red / 2;
</a><a href="#h5-0-1197" id="h5-0-1197" class="i">+		colfg.green = fg-&gt;color.green / 2;
</a><a href="#h5-0-1198" id="h5-0-1198" class="i">+		colfg.blue = fg-&gt;color.blue / 2;
</a><a href="#h5-0-1199" id="h5-0-1199" class="i">+		XftColorAllocValue(xw.dpy, xw.vis, xw.cmap, &amp;colfg, &amp;revfg);
</a><a href="#h5-0-1200" id="h5-0-1200" class="i">+		fg = &amp;revfg;
</a><a href="#h5-0-1201" id="h5-0-1201" class="i">+	}
</a><a href="#h5-0-1202" id="h5-0-1202" class="i">+
</a><a href="#h5-0-1203" id="h5-0-1203" class="i">+	if (base.mode &amp; ATTR_BLINK &amp;&amp; term.mode &amp; MODE_BLINK)
</a><a href="#h5-0-1204" id="h5-0-1204" class="i">+		fg = bg;
</a><a href="#h5-0-1205" id="h5-0-1205" class="i">+
</a><a href="#h5-0-1206" id="h5-0-1206" class="i">+	if (base.mode &amp; ATTR_INVISIBLE)
</a><a href="#h5-0-1207" id="h5-0-1207" class="i">+		fg = bg;
</a><a href="#h5-0-1208" id="h5-0-1208" class="i">+
</a><a href="#h5-0-1209" id="h5-0-1209" class="i">+	/* Intelligent cleaning up of the borders. */
</a><a href="#h5-0-1210" id="h5-0-1210" class="i">+	if (x == 0) {
</a><a href="#h5-0-1211" id="h5-0-1211" class="i">+		xclear(0, (y == 0)? 0 : winy, borderpx,
</a><a href="#h5-0-1212" id="h5-0-1212" class="i">+			winy + win.ch + ((y &gt;= term.row-1)? win.h : 0));
</a><a href="#h5-0-1213" id="h5-0-1213" class="i">+	}
</a><a href="#h5-0-1214" id="h5-0-1214" class="i">+	if (x + charlen &gt;= term.col) {
</a><a href="#h5-0-1215" id="h5-0-1215" class="i">+		xclear(winx + width, (y == 0)? 0 : winy, win.w,
</a><a href="#h5-0-1216" id="h5-0-1216" class="i">+			((y &gt;= term.row-1)? win.h : (winy + win.ch)));
</a><a href="#h5-0-1217" id="h5-0-1217" class="i">+	}
</a><a href="#h5-0-1218" id="h5-0-1218" class="i">+	if (y == 0)
</a><a href="#h5-0-1219" id="h5-0-1219" class="i">+		xclear(winx, 0, winx + width, borderpx);
</a><a href="#h5-0-1220" id="h5-0-1220" class="i">+	if (y == term.row-1)
</a><a href="#h5-0-1221" id="h5-0-1221" class="i">+		xclear(winx, winy + win.ch, winx + width, win.h);
</a><a href="#h5-0-1222" id="h5-0-1222" class="i">+
</a><a href="#h5-0-1223" id="h5-0-1223" class="i">+	/* Clean up the region we want to draw to. */
</a><a href="#h5-0-1224" id="h5-0-1224" class="i">+	XftDrawRect(xw.draw, bg, winx, winy, width, win.ch);
</a><a href="#h5-0-1225" id="h5-0-1225" class="i">+
</a><a href="#h5-0-1226" id="h5-0-1226" class="i">+	/* Set the clip region because Xft is sometimes dirty. */
</a><a href="#h5-0-1227" id="h5-0-1227" class="i">+	r.x = 0;
</a><a href="#h5-0-1228" id="h5-0-1228" class="i">+	r.y = 0;
</a><a href="#h5-0-1229" id="h5-0-1229" class="i">+	r.height = win.ch;
</a><a href="#h5-0-1230" id="h5-0-1230" class="i">+	r.width = width;
</a><a href="#h5-0-1231" id="h5-0-1231" class="i">+	XftDrawSetClipRectangles(xw.draw, winx, winy, &amp;r, 1);
</a><a href="#h5-0-1232" id="h5-0-1232" class="i">+
</a><a href="#h5-0-1233" id="h5-0-1233" class="i">+	/* Render the glyphs. */
</a><a href="#h5-0-1234" id="h5-0-1234" class="i">+	XftDrawGlyphFontSpec(xw.draw, fg, specs, len);
</a><a href="#h5-0-1235" id="h5-0-1235" class="i">+
</a><a href="#h5-0-1236" id="h5-0-1236" class="i">+	/* Render underline and strikethrough. */
</a><a href="#h5-0-1237" id="h5-0-1237" class="i">+	if (base.mode &amp; ATTR_UNDERLINE) {
</a><a href="#h5-0-1238" id="h5-0-1238" class="i">+		XftDrawRect(xw.draw, fg, winx, winy + dc.font.ascent + 1,
</a><a href="#h5-0-1239" id="h5-0-1239" class="i">+				width, 1);
</a><a href="#h5-0-1240" id="h5-0-1240" class="i">+	}
</a><a href="#h5-0-1241" id="h5-0-1241" class="i">+
</a><a href="#h5-0-1242" id="h5-0-1242" class="i">+	if (base.mode &amp; ATTR_STRUCK) {
</a><a href="#h5-0-1243" id="h5-0-1243" class="i">+		XftDrawRect(xw.draw, fg, winx, winy + 2 * dc.font.ascent / 3,
</a><a href="#h5-0-1244" id="h5-0-1244" class="i">+				width, 1);
</a><a href="#h5-0-1245" id="h5-0-1245" class="i">+	}
</a><a href="#h5-0-1246" id="h5-0-1246" class="i">+
</a><a href="#h5-0-1247" id="h5-0-1247" class="i">+	/* Reset clip to none. */
</a><a href="#h5-0-1248" id="h5-0-1248" class="i">+	XftDrawSetClip(xw.draw, 0);
</a><a href="#h5-0-1249" id="h5-0-1249" class="i">+}
</a><a href="#h5-0-1250" id="h5-0-1250" class="i">+
</a><a href="#h5-0-1251" id="h5-0-1251" class="i">+void
</a><a href="#h5-0-1252" id="h5-0-1252" class="i">+xdrawglyph(Glyph g, int x, int y)
</a><a href="#h5-0-1253" id="h5-0-1253" class="i">+{
</a><a href="#h5-0-1254" id="h5-0-1254" class="i">+	int numspecs;
</a><a href="#h5-0-1255" id="h5-0-1255" class="i">+	XftGlyphFontSpec spec;
</a><a href="#h5-0-1256" id="h5-0-1256" class="i">+
</a><a href="#h5-0-1257" id="h5-0-1257" class="i">+	numspecs = xmakeglyphfontspecs(&amp;spec, &amp;g, 1, x, y);
</a><a href="#h5-0-1258" id="h5-0-1258" class="i">+	xdrawglyphfontspecs(&amp;spec, g, numspecs, x, y);
</a><a href="#h5-0-1259" id="h5-0-1259" class="i">+}
</a><a href="#h5-0-1260" id="h5-0-1260" class="i">+
</a><a href="#h5-0-1261" id="h5-0-1261" class="i">+void
</a><a href="#h5-0-1262" id="h5-0-1262" class="i">+xdrawcursor(void)
</a><a href="#h5-0-1263" id="h5-0-1263" class="i">+{
</a><a href="#h5-0-1264" id="h5-0-1264" class="i">+	static int oldx = 0, oldy = 0;
</a><a href="#h5-0-1265" id="h5-0-1265" class="i">+	int curx;
</a><a href="#h5-0-1266" id="h5-0-1266" class="i">+	Glyph g = {&#39; &#39;, ATTR_NULL, defaultbg, defaultcs}, og;
</a><a href="#h5-0-1267" id="h5-0-1267" class="i">+	int ena_sel = sel.ob.x != -1 &amp;&amp; sel.alt == IS_SET(MODE_ALTSCREEN);
</a><a href="#h5-0-1268" id="h5-0-1268" class="i">+	Color drawcol;
</a><a href="#h5-0-1269" id="h5-0-1269" class="i">+
</a><a href="#h5-0-1270" id="h5-0-1270" class="i">+	LIMIT(oldx, 0, term.col-1);
</a><a href="#h5-0-1271" id="h5-0-1271" class="i">+	LIMIT(oldy, 0, term.row-1);
</a><a href="#h5-0-1272" id="h5-0-1272" class="i">+
</a><a href="#h5-0-1273" id="h5-0-1273" class="i">+	curx = term.c.x;
</a><a href="#h5-0-1274" id="h5-0-1274" class="i">+
</a><a href="#h5-0-1275" id="h5-0-1275" class="i">+	/* adjust position if in dummy */
</a><a href="#h5-0-1276" id="h5-0-1276" class="i">+	if (term.line[oldy][oldx].mode &amp; ATTR_WDUMMY)
</a><a href="#h5-0-1277" id="h5-0-1277" class="i">+		oldx--;
</a><a href="#h5-0-1278" id="h5-0-1278" class="i">+	if (term.line[term.c.y][curx].mode &amp; ATTR_WDUMMY)
</a><a href="#h5-0-1279" id="h5-0-1279" class="i">+		curx--;
</a><a href="#h5-0-1280" id="h5-0-1280" class="i">+
</a><a href="#h5-0-1281" id="h5-0-1281" class="i">+	/* remove the old cursor */
</a><a href="#h5-0-1282" id="h5-0-1282" class="i">+	og = term.line[oldy][oldx];
</a><a href="#h5-0-1283" id="h5-0-1283" class="i">+	if (ena_sel &amp;&amp; selected(oldx, oldy))
</a><a href="#h5-0-1284" id="h5-0-1284" class="i">+		og.mode ^= ATTR_REVERSE;
</a><a href="#h5-0-1285" id="h5-0-1285" class="i">+	xdrawglyph(og, oldx, oldy);
</a><a href="#h5-0-1286" id="h5-0-1286" class="i">+
</a><a href="#h5-0-1287" id="h5-0-1287" class="i">+	g.u = term.line[term.c.y][term.c.x].u;
</a><a href="#h5-0-1288" id="h5-0-1288" class="i">+
</a><a href="#h5-0-1289" id="h5-0-1289" class="i">+	/*
</a><a href="#h5-0-1290" id="h5-0-1290" class="i">+	 * Select the right color for the right mode.
</a><a href="#h5-0-1291" id="h5-0-1291" class="i">+	 */
</a><a href="#h5-0-1292" id="h5-0-1292" class="i">+	if (IS_SET(MODE_REVERSE)) {
</a><a href="#h5-0-1293" id="h5-0-1293" class="i">+		g.mode |= ATTR_REVERSE;
</a><a href="#h5-0-1294" id="h5-0-1294" class="i">+		g.bg = defaultfg;
</a><a href="#h5-0-1295" id="h5-0-1295" class="i">+		if (ena_sel &amp;&amp; selected(term.c.x, term.c.y)) {
</a><a href="#h5-0-1296" id="h5-0-1296" class="i">+			drawcol = dc.col[defaultcs];
</a><a href="#h5-0-1297" id="h5-0-1297" class="i">+			g.fg = defaultrcs;
</a><a href="#h5-0-1298" id="h5-0-1298" class="i">+		} else {
</a><a href="#h5-0-1299" id="h5-0-1299" class="i">+			drawcol = dc.col[defaultrcs];
</a><a href="#h5-0-1300" id="h5-0-1300" class="i">+			g.fg = defaultcs;
</a><a href="#h5-0-1301" id="h5-0-1301" class="i">+		}
</a><a href="#h5-0-1302" id="h5-0-1302" class="i">+	} else {
</a><a href="#h5-0-1303" id="h5-0-1303" class="i">+		if (ena_sel &amp;&amp; selected(term.c.x, term.c.y)) {
</a><a href="#h5-0-1304" id="h5-0-1304" class="i">+			drawcol = dc.col[defaultrcs];
</a><a href="#h5-0-1305" id="h5-0-1305" class="i">+			g.fg = defaultfg;
</a><a href="#h5-0-1306" id="h5-0-1306" class="i">+			g.bg = defaultrcs;
</a><a href="#h5-0-1307" id="h5-0-1307" class="i">+		} else {
</a><a href="#h5-0-1308" id="h5-0-1308" class="i">+			drawcol = dc.col[defaultcs];
</a><a href="#h5-0-1309" id="h5-0-1309" class="i">+		}
</a><a href="#h5-0-1310" id="h5-0-1310" class="i">+	}
</a><a href="#h5-0-1311" id="h5-0-1311" class="i">+
</a><a href="#h5-0-1312" id="h5-0-1312" class="i">+	if (IS_SET(MODE_HIDE))
</a><a href="#h5-0-1313" id="h5-0-1313" class="i">+		return;
</a><a href="#h5-0-1314" id="h5-0-1314" class="i">+
</a><a href="#h5-0-1315" id="h5-0-1315" class="i">+	/* draw the new one */
</a><a href="#h5-0-1316" id="h5-0-1316" class="i">+	if (win.state &amp; WIN_FOCUSED) {
</a><a href="#h5-0-1317" id="h5-0-1317" class="i">+		switch (win.cursor) {
</a><a href="#h5-0-1318" id="h5-0-1318" class="i">+		case 7: /* st extension: snowman */
</a><a href="#h5-0-1319" id="h5-0-1319" class="i">+			utf8decode(&quot;☃&quot;, &amp;g.u, UTF_SIZ);
</a><a href="#h5-0-1320" id="h5-0-1320" class="i">+		case 0: /* Blinking Block */
</a><a href="#h5-0-1321" id="h5-0-1321" class="i">+		case 1: /* Blinking Block (Default) */
</a><a href="#h5-0-1322" id="h5-0-1322" class="i">+		case 2: /* Steady Block */
</a><a href="#h5-0-1323" id="h5-0-1323" class="i">+			g.mode |= term.line[term.c.y][curx].mode &amp; ATTR_WIDE;
</a><a href="#h5-0-1324" id="h5-0-1324" class="i">+			xdrawglyph(g, term.c.x, term.c.y);
</a><a href="#h5-0-1325" id="h5-0-1325" class="i">+			break;
</a><a href="#h5-0-1326" id="h5-0-1326" class="i">+		case 3: /* Blinking Underline */
</a><a href="#h5-0-1327" id="h5-0-1327" class="i">+		case 4: /* Steady Underline */
</a><a href="#h5-0-1328" id="h5-0-1328" class="i">+			XftDrawRect(xw.draw, &amp;drawcol,
</a><a href="#h5-0-1329" id="h5-0-1329" class="i">+					borderpx + curx * win.cw,
</a><a href="#h5-0-1330" id="h5-0-1330" class="i">+					borderpx + (term.c.y + 1) * win.ch - \
</a><a href="#h5-0-1331" id="h5-0-1331" class="i">+						cursorthickness,
</a><a href="#h5-0-1332" id="h5-0-1332" class="i">+					win.cw, cursorthickness);
</a><a href="#h5-0-1333" id="h5-0-1333" class="i">+			break;
</a><a href="#h5-0-1334" id="h5-0-1334" class="i">+		case 5: /* Blinking bar */
</a><a href="#h5-0-1335" id="h5-0-1335" class="i">+		case 6: /* Steady bar */
</a><a href="#h5-0-1336" id="h5-0-1336" class="i">+			XftDrawRect(xw.draw, &amp;drawcol,
</a><a href="#h5-0-1337" id="h5-0-1337" class="i">+					borderpx + curx * win.cw,
</a><a href="#h5-0-1338" id="h5-0-1338" class="i">+					borderpx + term.c.y * win.ch,
</a><a href="#h5-0-1339" id="h5-0-1339" class="i">+					cursorthickness, win.ch);
</a><a href="#h5-0-1340" id="h5-0-1340" class="i">+			break;
</a><a href="#h5-0-1341" id="h5-0-1341" class="i">+		}
</a><a href="#h5-0-1342" id="h5-0-1342" class="i">+	} else {
</a><a href="#h5-0-1343" id="h5-0-1343" class="i">+		XftDrawRect(xw.draw, &amp;drawcol,
</a><a href="#h5-0-1344" id="h5-0-1344" class="i">+				borderpx + curx * win.cw,
</a><a href="#h5-0-1345" id="h5-0-1345" class="i">+				borderpx + term.c.y * win.ch,
</a><a href="#h5-0-1346" id="h5-0-1346" class="i">+				win.cw - 1, 1);
</a><a href="#h5-0-1347" id="h5-0-1347" class="i">+		XftDrawRect(xw.draw, &amp;drawcol,
</a><a href="#h5-0-1348" id="h5-0-1348" class="i">+				borderpx + curx * win.cw,
</a><a href="#h5-0-1349" id="h5-0-1349" class="i">+				borderpx + term.c.y * win.ch,
</a><a href="#h5-0-1350" id="h5-0-1350" class="i">+				1, win.ch - 1);
</a><a href="#h5-0-1351" id="h5-0-1351" class="i">+		XftDrawRect(xw.draw, &amp;drawcol,
</a><a href="#h5-0-1352" id="h5-0-1352" class="i">+				borderpx + (curx + 1) * win.cw - 1,
</a><a href="#h5-0-1353" id="h5-0-1353" class="i">+				borderpx + term.c.y * win.ch,
</a><a href="#h5-0-1354" id="h5-0-1354" class="i">+				1, win.ch - 1);
</a><a href="#h5-0-1355" id="h5-0-1355" class="i">+		XftDrawRect(xw.draw, &amp;drawcol,
</a><a href="#h5-0-1356" id="h5-0-1356" class="i">+				borderpx + curx * win.cw,
</a><a href="#h5-0-1357" id="h5-0-1357" class="i">+				borderpx + (term.c.y + 1) * win.ch - 1,
</a><a href="#h5-0-1358" id="h5-0-1358" class="i">+				win.cw, 1);
</a><a href="#h5-0-1359" id="h5-0-1359" class="i">+	}
</a><a href="#h5-0-1360" id="h5-0-1360" class="i">+	oldx = curx, oldy = term.c.y;
</a><a href="#h5-0-1361" id="h5-0-1361" class="i">+}
</a><a href="#h5-0-1362" id="h5-0-1362" class="i">+
</a><a href="#h5-0-1363" id="h5-0-1363" class="i">+void
</a><a href="#h5-0-1364" id="h5-0-1364" class="i">+xsetenv(void)
</a><a href="#h5-0-1365" id="h5-0-1365" class="i">+{
</a><a href="#h5-0-1366" id="h5-0-1366" class="i">+	char buf[sizeof(long) * 8 + 1];
</a><a href="#h5-0-1367" id="h5-0-1367" class="i">+
</a><a href="#h5-0-1368" id="h5-0-1368" class="i">+	snprintf(buf, sizeof(buf), &quot;%lu&quot;, xw.win);
</a><a href="#h5-0-1369" id="h5-0-1369" class="i">+	setenv(&quot;WINDOWID&quot;, buf, 1);
</a><a href="#h5-0-1370" id="h5-0-1370" class="i">+}
</a><a href="#h5-0-1371" id="h5-0-1371" class="i">+
</a><a href="#h5-0-1372" id="h5-0-1372" class="i">+void
</a><a href="#h5-0-1373" id="h5-0-1373" class="i">+xsettitle(char *p)
</a><a href="#h5-0-1374" id="h5-0-1374" class="i">+{
</a><a href="#h5-0-1375" id="h5-0-1375" class="i">+	XTextProperty prop;
</a><a href="#h5-0-1376" id="h5-0-1376" class="i">+
</a><a href="#h5-0-1377" id="h5-0-1377" class="i">+	Xutf8TextListToTextProperty(xw.dpy, &amp;p, 1, XUTF8StringStyle,
</a><a href="#h5-0-1378" id="h5-0-1378" class="i">+			&amp;prop);
</a><a href="#h5-0-1379" id="h5-0-1379" class="i">+	XSetWMName(xw.dpy, xw.win, &amp;prop);
</a><a href="#h5-0-1380" id="h5-0-1380" class="i">+	XSetTextProperty(xw.dpy, xw.win, &amp;prop, xw.netwmname);
</a><a href="#h5-0-1381" id="h5-0-1381" class="i">+	XFree(prop.value);
</a><a href="#h5-0-1382" id="h5-0-1382" class="i">+}
</a><a href="#h5-0-1383" id="h5-0-1383" class="i">+
</a><a href="#h5-0-1384" id="h5-0-1384" class="i">+void
</a><a href="#h5-0-1385" id="h5-0-1385" class="i">+draw(void)
</a><a href="#h5-0-1386" id="h5-0-1386" class="i">+{
</a><a href="#h5-0-1387" id="h5-0-1387" class="i">+	drawregion(0, 0, term.col, term.row);
</a><a href="#h5-0-1388" id="h5-0-1388" class="i">+	XCopyArea(xw.dpy, xw.buf, xw.win, dc.gc, 0, 0, win.w,
</a><a href="#h5-0-1389" id="h5-0-1389" class="i">+			win.h, 0, 0);
</a><a href="#h5-0-1390" id="h5-0-1390" class="i">+	XSetForeground(xw.dpy, dc.gc,
</a><a href="#h5-0-1391" id="h5-0-1391" class="i">+			dc.col[IS_SET(MODE_REVERSE)?
</a><a href="#h5-0-1392" id="h5-0-1392" class="i">+				defaultfg : defaultbg].pixel);
</a><a href="#h5-0-1393" id="h5-0-1393" class="i">+}
</a><a href="#h5-0-1394" id="h5-0-1394" class="i">+
</a><a href="#h5-0-1395" id="h5-0-1395" class="i">+void
</a><a href="#h5-0-1396" id="h5-0-1396" class="i">+drawregion(int x1, int y1, int x2, int y2)
</a><a href="#h5-0-1397" id="h5-0-1397" class="i">+{
</a><a href="#h5-0-1398" id="h5-0-1398" class="i">+	int i, x, y, ox, numspecs;
</a><a href="#h5-0-1399" id="h5-0-1399" class="i">+	Glyph base, new;
</a><a href="#h5-0-1400" id="h5-0-1400" class="i">+	XftGlyphFontSpec *specs;
</a><a href="#h5-0-1401" id="h5-0-1401" class="i">+	int ena_sel = sel.ob.x != -1 &amp;&amp; sel.alt == IS_SET(MODE_ALTSCREEN);
</a><a href="#h5-0-1402" id="h5-0-1402" class="i">+
</a><a href="#h5-0-1403" id="h5-0-1403" class="i">+	if (!(win.state &amp; WIN_VISIBLE))
</a><a href="#h5-0-1404" id="h5-0-1404" class="i">+		return;
</a><a href="#h5-0-1405" id="h5-0-1405" class="i">+
</a><a href="#h5-0-1406" id="h5-0-1406" class="i">+	for (y = y1; y &lt; y2; y++) {
</a><a href="#h5-0-1407" id="h5-0-1407" class="i">+		if (!term.dirty[y])
</a><a href="#h5-0-1408" id="h5-0-1408" class="i">+			continue;
</a><a href="#h5-0-1409" id="h5-0-1409" class="i">+
</a><a href="#h5-0-1410" id="h5-0-1410" class="i">+		term.dirty[y] = 0;
</a><a href="#h5-0-1411" id="h5-0-1411" class="i">+
</a><a href="#h5-0-1412" id="h5-0-1412" class="i">+		specs = term.specbuf;
</a><a href="#h5-0-1413" id="h5-0-1413" class="i">+		numspecs = xmakeglyphfontspecs(specs, &amp;term.line[y][x1], x2 - x1, x1, y);
</a><a href="#h5-0-1414" id="h5-0-1414" class="i">+
</a><a href="#h5-0-1415" id="h5-0-1415" class="i">+		i = ox = 0;
</a><a href="#h5-0-1416" id="h5-0-1416" class="i">+		for (x = x1; x &lt; x2 &amp;&amp; i &lt; numspecs; x++) {
</a><a href="#h5-0-1417" id="h5-0-1417" class="i">+			new = term.line[y][x];
</a><a href="#h5-0-1418" id="h5-0-1418" class="i">+			if (new.mode == ATTR_WDUMMY)
</a><a href="#h5-0-1419" id="h5-0-1419" class="i">+				continue;
</a><a href="#h5-0-1420" id="h5-0-1420" class="i">+			if (ena_sel &amp;&amp; selected(x, y))
</a><a href="#h5-0-1421" id="h5-0-1421" class="i">+				new.mode ^= ATTR_REVERSE;
</a><a href="#h5-0-1422" id="h5-0-1422" class="i">+			if (i &gt; 0 &amp;&amp; ATTRCMP(base, new)) {
</a><a href="#h5-0-1423" id="h5-0-1423" class="i">+				xdrawglyphfontspecs(specs, base, i, ox, y);
</a><a href="#h5-0-1424" id="h5-0-1424" class="i">+				specs += i;
</a><a href="#h5-0-1425" id="h5-0-1425" class="i">+				numspecs -= i;
</a><a href="#h5-0-1426" id="h5-0-1426" class="i">+				i = 0;
</a><a href="#h5-0-1427" id="h5-0-1427" class="i">+			}
</a><a href="#h5-0-1428" id="h5-0-1428" class="i">+			if (i == 0) {
</a><a href="#h5-0-1429" id="h5-0-1429" class="i">+				ox = x;
</a><a href="#h5-0-1430" id="h5-0-1430" class="i">+				base = new;
</a><a href="#h5-0-1431" id="h5-0-1431" class="i">+			}
</a><a href="#h5-0-1432" id="h5-0-1432" class="i">+			i++;
</a><a href="#h5-0-1433" id="h5-0-1433" class="i">+		}
</a><a href="#h5-0-1434" id="h5-0-1434" class="i">+		if (i &gt; 0)
</a><a href="#h5-0-1435" id="h5-0-1435" class="i">+			xdrawglyphfontspecs(specs, base, i, ox, y);
</a><a href="#h5-0-1436" id="h5-0-1436" class="i">+	}
</a><a href="#h5-0-1437" id="h5-0-1437" class="i">+	xdrawcursor();
</a><a href="#h5-0-1438" id="h5-0-1438" class="i">+}
</a><a href="#h5-0-1439" id="h5-0-1439" class="i">+
</a><a href="#h5-0-1440" id="h5-0-1440" class="i">+void
</a><a href="#h5-0-1441" id="h5-0-1441" class="i">+expose(XEvent *ev)
</a><a href="#h5-0-1442" id="h5-0-1442" class="i">+{
</a><a href="#h5-0-1443" id="h5-0-1443" class="i">+	redraw();
</a><a href="#h5-0-1444" id="h5-0-1444" class="i">+}
</a><a href="#h5-0-1445" id="h5-0-1445" class="i">+
</a><a href="#h5-0-1446" id="h5-0-1446" class="i">+void
</a><a href="#h5-0-1447" id="h5-0-1447" class="i">+visibility(XEvent *ev)
</a><a href="#h5-0-1448" id="h5-0-1448" class="i">+{
</a><a href="#h5-0-1449" id="h5-0-1449" class="i">+	XVisibilityEvent *e = &amp;ev-&gt;xvisibility;
</a><a href="#h5-0-1450" id="h5-0-1450" class="i">+
</a><a href="#h5-0-1451" id="h5-0-1451" class="i">+	MODBIT(win.state, e-&gt;state != VisibilityFullyObscured, WIN_VISIBLE);
</a><a href="#h5-0-1452" id="h5-0-1452" class="i">+}
</a><a href="#h5-0-1453" id="h5-0-1453" class="i">+
</a><a href="#h5-0-1454" id="h5-0-1454" class="i">+void
</a><a href="#h5-0-1455" id="h5-0-1455" class="i">+unmap(XEvent *ev)
</a><a href="#h5-0-1456" id="h5-0-1456" class="i">+{
</a><a href="#h5-0-1457" id="h5-0-1457" class="i">+	win.state &amp;= ~WIN_VISIBLE;
</a><a href="#h5-0-1458" id="h5-0-1458" class="i">+}
</a><a href="#h5-0-1459" id="h5-0-1459" class="i">+
</a><a href="#h5-0-1460" id="h5-0-1460" class="i">+void
</a><a href="#h5-0-1461" id="h5-0-1461" class="i">+xsetpointermotion(int set)
</a><a href="#h5-0-1462" id="h5-0-1462" class="i">+{
</a><a href="#h5-0-1463" id="h5-0-1463" class="i">+	MODBIT(xw.attrs.event_mask, set, PointerMotionMask);
</a><a href="#h5-0-1464" id="h5-0-1464" class="i">+	XChangeWindowAttributes(xw.dpy, xw.win, CWEventMask, &amp;xw.attrs);
</a><a href="#h5-0-1465" id="h5-0-1465" class="i">+}
</a><a href="#h5-0-1466" id="h5-0-1466" class="i">+
</a><a href="#h5-0-1467" id="h5-0-1467" class="i">+void
</a><a href="#h5-0-1468" id="h5-0-1468" class="i">+xseturgency(int add)
</a><a href="#h5-0-1469" id="h5-0-1469" class="i">+{
</a><a href="#h5-0-1470" id="h5-0-1470" class="i">+	XWMHints *h = XGetWMHints(xw.dpy, xw.win);
</a><a href="#h5-0-1471" id="h5-0-1471" class="i">+
</a><a href="#h5-0-1472" id="h5-0-1472" class="i">+	MODBIT(h-&gt;flags, add, XUrgencyHint);
</a><a href="#h5-0-1473" id="h5-0-1473" class="i">+	XSetWMHints(xw.dpy, xw.win, h);
</a><a href="#h5-0-1474" id="h5-0-1474" class="i">+	XFree(h);
</a><a href="#h5-0-1475" id="h5-0-1475" class="i">+}
</a><a href="#h5-0-1476" id="h5-0-1476" class="i">+
</a><a href="#h5-0-1477" id="h5-0-1477" class="i">+void
</a><a href="#h5-0-1478" id="h5-0-1478" class="i">+xbell(int vol)
</a><a href="#h5-0-1479" id="h5-0-1479" class="i">+{
</a><a href="#h5-0-1480" id="h5-0-1480" class="i">+	XkbBell(xw.dpy, xw.win, vol, (Atom)NULL);
</a><a href="#h5-0-1481" id="h5-0-1481" class="i">+}
</a><a href="#h5-0-1482" id="h5-0-1482" class="i">+
</a><a href="#h5-0-1483" id="h5-0-1483" class="i">+unsigned long
</a><a href="#h5-0-1484" id="h5-0-1484" class="i">+xwinid(void)
</a><a href="#h5-0-1485" id="h5-0-1485" class="i">+{
</a><a href="#h5-0-1486" id="h5-0-1486" class="i">+	return xw.win;
</a><a href="#h5-0-1487" id="h5-0-1487" class="i">+}
</a><a href="#h5-0-1488" id="h5-0-1488" class="i">+
</a><a href="#h5-0-1489" id="h5-0-1489" class="i">+void
</a><a href="#h5-0-1490" id="h5-0-1490" class="i">+focus(XEvent *ev)
</a><a href="#h5-0-1491" id="h5-0-1491" class="i">+{
</a><a href="#h5-0-1492" id="h5-0-1492" class="i">+	XFocusChangeEvent *e = &amp;ev-&gt;xfocus;
</a><a href="#h5-0-1493" id="h5-0-1493" class="i">+
</a><a href="#h5-0-1494" id="h5-0-1494" class="i">+	if (e-&gt;mode == NotifyGrab)
</a><a href="#h5-0-1495" id="h5-0-1495" class="i">+		return;
</a><a href="#h5-0-1496" id="h5-0-1496" class="i">+
</a><a href="#h5-0-1497" id="h5-0-1497" class="i">+	if (ev-&gt;type == FocusIn) {
</a><a href="#h5-0-1498" id="h5-0-1498" class="i">+		XSetICFocus(xw.xic);
</a><a href="#h5-0-1499" id="h5-0-1499" class="i">+		win.state |= WIN_FOCUSED;
</a><a href="#h5-0-1500" id="h5-0-1500" class="i">+		xseturgency(0);
</a><a href="#h5-0-1501" id="h5-0-1501" class="i">+		if (IS_SET(MODE_FOCUS))
</a><a href="#h5-0-1502" id="h5-0-1502" class="i">+			ttywrite(&quot;\033[I&quot;, 3);
</a><a href="#h5-0-1503" id="h5-0-1503" class="i">+	} else {
</a><a href="#h5-0-1504" id="h5-0-1504" class="i">+		XUnsetICFocus(xw.xic);
</a><a href="#h5-0-1505" id="h5-0-1505" class="i">+		win.state &amp;= ~WIN_FOCUSED;
</a><a href="#h5-0-1506" id="h5-0-1506" class="i">+		if (IS_SET(MODE_FOCUS))
</a><a href="#h5-0-1507" id="h5-0-1507" class="i">+			ttywrite(&quot;\033[O&quot;, 3);
</a><a href="#h5-0-1508" id="h5-0-1508" class="i">+	}
</a><a href="#h5-0-1509" id="h5-0-1509" class="i">+}
</a><a href="#h5-0-1510" id="h5-0-1510" class="i">+
</a><a href="#h5-0-1511" id="h5-0-1511" class="i">+void
</a><a href="#h5-0-1512" id="h5-0-1512" class="i">+kpress(XEvent *ev)
</a><a href="#h5-0-1513" id="h5-0-1513" class="i">+{
</a><a href="#h5-0-1514" id="h5-0-1514" class="i">+	XKeyEvent *e = &amp;ev-&gt;xkey;
</a><a href="#h5-0-1515" id="h5-0-1515" class="i">+	KeySym ksym;
</a><a href="#h5-0-1516" id="h5-0-1516" class="i">+	char buf[32], *customkey;
</a><a href="#h5-0-1517" id="h5-0-1517" class="i">+	int len;
</a><a href="#h5-0-1518" id="h5-0-1518" class="i">+	Rune c;
</a><a href="#h5-0-1519" id="h5-0-1519" class="i">+	Status status;
</a><a href="#h5-0-1520" id="h5-0-1520" class="i">+	Shortcut *bp;
</a><a href="#h5-0-1521" id="h5-0-1521" class="i">+
</a><a href="#h5-0-1522" id="h5-0-1522" class="i">+	if (IS_SET(MODE_KBDLOCK))
</a><a href="#h5-0-1523" id="h5-0-1523" class="i">+		return;
</a><a href="#h5-0-1524" id="h5-0-1524" class="i">+
</a><a href="#h5-0-1525" id="h5-0-1525" class="i">+	len = XmbLookupString(xw.xic, e, buf, sizeof buf, &amp;ksym, &amp;status);
</a><a href="#h5-0-1526" id="h5-0-1526" class="i">+	/* 1. shortcuts */
</a><a href="#h5-0-1527" id="h5-0-1527" class="i">+	for (bp = shortcuts; bp &lt; shortcuts + shortcutslen; bp++) {
</a><a href="#h5-0-1528" id="h5-0-1528" class="i">+		if (ksym == bp-&gt;keysym &amp;&amp; match(bp-&gt;mod, e-&gt;state)) {
</a><a href="#h5-0-1529" id="h5-0-1529" class="i">+			bp-&gt;func(&amp;(bp-&gt;arg));
</a><a href="#h5-0-1530" id="h5-0-1530" class="i">+			return;
</a><a href="#h5-0-1531" id="h5-0-1531" class="i">+		}
</a><a href="#h5-0-1532" id="h5-0-1532" class="i">+	}
</a><a href="#h5-0-1533" id="h5-0-1533" class="i">+
</a><a href="#h5-0-1534" id="h5-0-1534" class="i">+	/* 2. custom keys from config.h */
</a><a href="#h5-0-1535" id="h5-0-1535" class="i">+	if ((customkey = kmap(ksym, e-&gt;state))) {
</a><a href="#h5-0-1536" id="h5-0-1536" class="i">+		ttysend(customkey, strlen(customkey));
</a><a href="#h5-0-1537" id="h5-0-1537" class="i">+		return;
</a><a href="#h5-0-1538" id="h5-0-1538" class="i">+	}
</a><a href="#h5-0-1539" id="h5-0-1539" class="i">+
</a><a href="#h5-0-1540" id="h5-0-1540" class="i">+	/* 3. composed string from input method */
</a><a href="#h5-0-1541" id="h5-0-1541" class="i">+	if (len == 0)
</a><a href="#h5-0-1542" id="h5-0-1542" class="i">+		return;
</a><a href="#h5-0-1543" id="h5-0-1543" class="i">+	if (len == 1 &amp;&amp; e-&gt;state &amp; Mod1Mask) {
</a><a href="#h5-0-1544" id="h5-0-1544" class="i">+		if (IS_SET(MODE_8BIT)) {
</a><a href="#h5-0-1545" id="h5-0-1545" class="i">+			if (*buf &lt; 0177) {
</a><a href="#h5-0-1546" id="h5-0-1546" class="i">+				c = *buf | 0x80;
</a><a href="#h5-0-1547" id="h5-0-1547" class="i">+				len = utf8encode(c, buf);
</a><a href="#h5-0-1548" id="h5-0-1548" class="i">+			}
</a><a href="#h5-0-1549" id="h5-0-1549" class="i">+		} else {
</a><a href="#h5-0-1550" id="h5-0-1550" class="i">+			buf[1] = buf[0];
</a><a href="#h5-0-1551" id="h5-0-1551" class="i">+			buf[0] = &#39;\033&#39;;
</a><a href="#h5-0-1552" id="h5-0-1552" class="i">+			len = 2;
</a><a href="#h5-0-1553" id="h5-0-1553" class="i">+		}
</a><a href="#h5-0-1554" id="h5-0-1554" class="i">+	}
</a><a href="#h5-0-1555" id="h5-0-1555" class="i">+	ttysend(buf, len);
</a><a href="#h5-0-1556" id="h5-0-1556" class="i">+}
</a><a href="#h5-0-1557" id="h5-0-1557" class="i">+
</a><a href="#h5-0-1558" id="h5-0-1558" class="i">+
</a><a href="#h5-0-1559" id="h5-0-1559" class="i">+void
</a><a href="#h5-0-1560" id="h5-0-1560" class="i">+cmessage(XEvent *e)
</a><a href="#h5-0-1561" id="h5-0-1561" class="i">+{
</a><a href="#h5-0-1562" id="h5-0-1562" class="i">+	/*
</a><a href="#h5-0-1563" id="h5-0-1563" class="i">+	 * See xembed specs
</a><a href="#h5-0-1564" id="h5-0-1564" class="i">+	 *  http://standards.freedesktop.org/xembed-spec/xembed-spec-latest.html
</a><a href="#h5-0-1565" id="h5-0-1565" class="i">+	 */
</a><a href="#h5-0-1566" id="h5-0-1566" class="i">+	if (e-&gt;xclient.message_type == xw.xembed &amp;&amp; e-&gt;xclient.format == 32) {
</a><a href="#h5-0-1567" id="h5-0-1567" class="i">+		if (e-&gt;xclient.data.l[1] == XEMBED_FOCUS_IN) {
</a><a href="#h5-0-1568" id="h5-0-1568" class="i">+			win.state |= WIN_FOCUSED;
</a><a href="#h5-0-1569" id="h5-0-1569" class="i">+			xseturgency(0);
</a><a href="#h5-0-1570" id="h5-0-1570" class="i">+		} else if (e-&gt;xclient.data.l[1] == XEMBED_FOCUS_OUT) {
</a><a href="#h5-0-1571" id="h5-0-1571" class="i">+			win.state &amp;= ~WIN_FOCUSED;
</a><a href="#h5-0-1572" id="h5-0-1572" class="i">+		}
</a><a href="#h5-0-1573" id="h5-0-1573" class="i">+	} else if (e-&gt;xclient.data.l[0] == xw.wmdeletewin) {
</a><a href="#h5-0-1574" id="h5-0-1574" class="i">+		/* Send SIGHUP to shell */
</a><a href="#h5-0-1575" id="h5-0-1575" class="i">+		kill(pid, SIGHUP);
</a><a href="#h5-0-1576" id="h5-0-1576" class="i">+		exit(0);
</a><a href="#h5-0-1577" id="h5-0-1577" class="i">+	}
</a><a href="#h5-0-1578" id="h5-0-1578" class="i">+}
</a><a href="#h5-0-1579" id="h5-0-1579" class="i">+
</a><a href="#h5-0-1580" id="h5-0-1580" class="i">+void
</a><a href="#h5-0-1581" id="h5-0-1581" class="i">+resize(XEvent *e)
</a><a href="#h5-0-1582" id="h5-0-1582" class="i">+{
</a><a href="#h5-0-1583" id="h5-0-1583" class="i">+	if (e-&gt;xconfigure.width == win.w &amp;&amp; e-&gt;xconfigure.height == win.h)
</a><a href="#h5-0-1584" id="h5-0-1584" class="i">+		return;
</a><a href="#h5-0-1585" id="h5-0-1585" class="i">+
</a><a href="#h5-0-1586" id="h5-0-1586" class="i">+	cresize(e-&gt;xconfigure.width, e-&gt;xconfigure.height);
</a><a href="#h5-0-1587" id="h5-0-1587" class="i">+	ttyresize();
</a><a href="#h5-0-1588" id="h5-0-1588" class="i">+}
</a><a href="#h5-0-1589" id="h5-0-1589" class="i">+
</a><a href="#h5-0-1590" id="h5-0-1590" class="i">+void
</a><a href="#h5-0-1591" id="h5-0-1591" class="i">+run(void)
</a><a href="#h5-0-1592" id="h5-0-1592" class="i">+{
</a><a href="#h5-0-1593" id="h5-0-1593" class="i">+	XEvent ev;
</a><a href="#h5-0-1594" id="h5-0-1594" class="i">+	int w = win.w, h = win.h;
</a><a href="#h5-0-1595" id="h5-0-1595" class="i">+	fd_set rfd;
</a><a href="#h5-0-1596" id="h5-0-1596" class="i">+	int xfd = XConnectionNumber(xw.dpy), xev, blinkset = 0, dodraw = 0;
</a><a href="#h5-0-1597" id="h5-0-1597" class="i">+	struct timespec drawtimeout, *tv = NULL, now, last, lastblink;
</a><a href="#h5-0-1598" id="h5-0-1598" class="i">+	long deltatime;
</a><a href="#h5-0-1599" id="h5-0-1599" class="i">+
</a><a href="#h5-0-1600" id="h5-0-1600" class="i">+	/* Waiting for window mapping */
</a><a href="#h5-0-1601" id="h5-0-1601" class="i">+	do {
</a><a href="#h5-0-1602" id="h5-0-1602" class="i">+		XNextEvent(xw.dpy, &amp;ev);
</a><a href="#h5-0-1603" id="h5-0-1603" class="i">+		/*
</a><a href="#h5-0-1604" id="h5-0-1604" class="i">+		 * This XFilterEvent call is required because of XOpenIM. It
</a><a href="#h5-0-1605" id="h5-0-1605" class="i">+		 * does filter out the key event and some client message for
</a><a href="#h5-0-1606" id="h5-0-1606" class="i">+		 * the input method too.
</a><a href="#h5-0-1607" id="h5-0-1607" class="i">+		 */
</a><a href="#h5-0-1608" id="h5-0-1608" class="i">+		if (XFilterEvent(&amp;ev, None))
</a><a href="#h5-0-1609" id="h5-0-1609" class="i">+			continue;
</a><a href="#h5-0-1610" id="h5-0-1610" class="i">+		if (ev.type == ConfigureNotify) {
</a><a href="#h5-0-1611" id="h5-0-1611" class="i">+			w = ev.xconfigure.width;
</a><a href="#h5-0-1612" id="h5-0-1612" class="i">+			h = ev.xconfigure.height;
</a><a href="#h5-0-1613" id="h5-0-1613" class="i">+		}
</a><a href="#h5-0-1614" id="h5-0-1614" class="i">+	} while (ev.type != MapNotify);
</a><a href="#h5-0-1615" id="h5-0-1615" class="i">+
</a><a href="#h5-0-1616" id="h5-0-1616" class="i">+	cresize(w, h);
</a><a href="#h5-0-1617" id="h5-0-1617" class="i">+	ttynew();
</a><a href="#h5-0-1618" id="h5-0-1618" class="i">+	ttyresize();
</a><a href="#h5-0-1619" id="h5-0-1619" class="i">+
</a><a href="#h5-0-1620" id="h5-0-1620" class="i">+	clock_gettime(CLOCK_MONOTONIC, &amp;last);
</a><a href="#h5-0-1621" id="h5-0-1621" class="i">+	lastblink = last;
</a><a href="#h5-0-1622" id="h5-0-1622" class="i">+
</a><a href="#h5-0-1623" id="h5-0-1623" class="i">+	for (xev = actionfps;;) {
</a><a href="#h5-0-1624" id="h5-0-1624" class="i">+		FD_ZERO(&amp;rfd);
</a><a href="#h5-0-1625" id="h5-0-1625" class="i">+		FD_SET(cmdfd, &amp;rfd);
</a><a href="#h5-0-1626" id="h5-0-1626" class="i">+		FD_SET(xfd, &amp;rfd);
</a><a href="#h5-0-1627" id="h5-0-1627" class="i">+
</a><a href="#h5-0-1628" id="h5-0-1628" class="i">+		if (pselect(MAX(xfd, cmdfd)+1, &amp;rfd, NULL, NULL, tv, NULL) &lt; 0) {
</a><a href="#h5-0-1629" id="h5-0-1629" class="i">+			if (errno == EINTR)
</a><a href="#h5-0-1630" id="h5-0-1630" class="i">+				continue;
</a><a href="#h5-0-1631" id="h5-0-1631" class="i">+			die(&quot;select failed: %s\n&quot;, strerror(errno));
</a><a href="#h5-0-1632" id="h5-0-1632" class="i">+		}
</a><a href="#h5-0-1633" id="h5-0-1633" class="i">+		if (FD_ISSET(cmdfd, &amp;rfd)) {
</a><a href="#h5-0-1634" id="h5-0-1634" class="i">+			ttyread();
</a><a href="#h5-0-1635" id="h5-0-1635" class="i">+			if (blinktimeout) {
</a><a href="#h5-0-1636" id="h5-0-1636" class="i">+				blinkset = tattrset(ATTR_BLINK);
</a><a href="#h5-0-1637" id="h5-0-1637" class="i">+				if (!blinkset)
</a><a href="#h5-0-1638" id="h5-0-1638" class="i">+					MODBIT(term.mode, 0, MODE_BLINK);
</a><a href="#h5-0-1639" id="h5-0-1639" class="i">+			}
</a><a href="#h5-0-1640" id="h5-0-1640" class="i">+		}
</a><a href="#h5-0-1641" id="h5-0-1641" class="i">+
</a><a href="#h5-0-1642" id="h5-0-1642" class="i">+		if (FD_ISSET(xfd, &amp;rfd))
</a><a href="#h5-0-1643" id="h5-0-1643" class="i">+			xev = actionfps;
</a><a href="#h5-0-1644" id="h5-0-1644" class="i">+
</a><a href="#h5-0-1645" id="h5-0-1645" class="i">+		clock_gettime(CLOCK_MONOTONIC, &amp;now);
</a><a href="#h5-0-1646" id="h5-0-1646" class="i">+		drawtimeout.tv_sec = 0;
</a><a href="#h5-0-1647" id="h5-0-1647" class="i">+		drawtimeout.tv_nsec =  (1000 * 1E6)/ xfps;
</a><a href="#h5-0-1648" id="h5-0-1648" class="i">+		tv = &amp;drawtimeout;
</a><a href="#h5-0-1649" id="h5-0-1649" class="i">+
</a><a href="#h5-0-1650" id="h5-0-1650" class="i">+		dodraw = 0;
</a><a href="#h5-0-1651" id="h5-0-1651" class="i">+		if (blinktimeout &amp;&amp; TIMEDIFF(now, lastblink) &gt; blinktimeout) {
</a><a href="#h5-0-1652" id="h5-0-1652" class="i">+			tsetdirtattr(ATTR_BLINK);
</a><a href="#h5-0-1653" id="h5-0-1653" class="i">+			term.mode ^= MODE_BLINK;
</a><a href="#h5-0-1654" id="h5-0-1654" class="i">+			lastblink = now;
</a><a href="#h5-0-1655" id="h5-0-1655" class="i">+			dodraw = 1;
</a><a href="#h5-0-1656" id="h5-0-1656" class="i">+		}
</a><a href="#h5-0-1657" id="h5-0-1657" class="i">+		deltatime = TIMEDIFF(now, last);
</a><a href="#h5-0-1658" id="h5-0-1658" class="i">+		if (deltatime &gt; 1000 / (xev ? xfps : actionfps)) {
</a><a href="#h5-0-1659" id="h5-0-1659" class="i">+			dodraw = 1;
</a><a href="#h5-0-1660" id="h5-0-1660" class="i">+			last = now;
</a><a href="#h5-0-1661" id="h5-0-1661" class="i">+		}
</a><a href="#h5-0-1662" id="h5-0-1662" class="i">+
</a><a href="#h5-0-1663" id="h5-0-1663" class="i">+		if (dodraw) {
</a><a href="#h5-0-1664" id="h5-0-1664" class="i">+			while (XPending(xw.dpy)) {
</a><a href="#h5-0-1665" id="h5-0-1665" class="i">+				XNextEvent(xw.dpy, &amp;ev);
</a><a href="#h5-0-1666" id="h5-0-1666" class="i">+				if (XFilterEvent(&amp;ev, None))
</a><a href="#h5-0-1667" id="h5-0-1667" class="i">+					continue;
</a><a href="#h5-0-1668" id="h5-0-1668" class="i">+				if (handler[ev.type])
</a><a href="#h5-0-1669" id="h5-0-1669" class="i">+					(handler[ev.type])(&amp;ev);
</a><a href="#h5-0-1670" id="h5-0-1670" class="i">+			}
</a><a href="#h5-0-1671" id="h5-0-1671" class="i">+
</a><a href="#h5-0-1672" id="h5-0-1672" class="i">+			draw();
</a><a href="#h5-0-1673" id="h5-0-1673" class="i">+			XFlush(xw.dpy);
</a><a href="#h5-0-1674" id="h5-0-1674" class="i">+
</a><a href="#h5-0-1675" id="h5-0-1675" class="i">+			if (xev &amp;&amp; !FD_ISSET(xfd, &amp;rfd))
</a><a href="#h5-0-1676" id="h5-0-1676" class="i">+				xev--;
</a><a href="#h5-0-1677" id="h5-0-1677" class="i">+			if (!FD_ISSET(cmdfd, &amp;rfd) &amp;&amp; !FD_ISSET(xfd, &amp;rfd)) {
</a><a href="#h5-0-1678" id="h5-0-1678" class="i">+				if (blinkset) {
</a><a href="#h5-0-1679" id="h5-0-1679" class="i">+					if (TIMEDIFF(now, lastblink) \
</a><a href="#h5-0-1680" id="h5-0-1680" class="i">+							&gt; blinktimeout) {
</a><a href="#h5-0-1681" id="h5-0-1681" class="i">+						drawtimeout.tv_nsec = 1000;
</a><a href="#h5-0-1682" id="h5-0-1682" class="i">+					} else {
</a><a href="#h5-0-1683" id="h5-0-1683" class="i">+						drawtimeout.tv_nsec = (1E6 * \
</a><a href="#h5-0-1684" id="h5-0-1684" class="i">+							(blinktimeout - \
</a><a href="#h5-0-1685" id="h5-0-1685" class="i">+							TIMEDIFF(now,
</a><a href="#h5-0-1686" id="h5-0-1686" class="i">+								lastblink)));
</a><a href="#h5-0-1687" id="h5-0-1687" class="i">+					}
</a><a href="#h5-0-1688" id="h5-0-1688" class="i">+					drawtimeout.tv_sec = \
</a><a href="#h5-0-1689" id="h5-0-1689" class="i">+					    drawtimeout.tv_nsec / 1E9;
</a><a href="#h5-0-1690" id="h5-0-1690" class="i">+					drawtimeout.tv_nsec %= (long)1E9;
</a><a href="#h5-0-1691" id="h5-0-1691" class="i">+				} else {
</a><a href="#h5-0-1692" id="h5-0-1692" class="i">+					tv = NULL;
</a><a href="#h5-0-1693" id="h5-0-1693" class="i">+				}
</a><a href="#h5-0-1694" id="h5-0-1694" class="i">+			}
</a><a href="#h5-0-1695" id="h5-0-1695" class="i">+		}
</a><a href="#h5-0-1696" id="h5-0-1696" class="i">+	}
</a><a href="#h5-0-1697" id="h5-0-1697" class="i">+}
</a><a href="#h5-0-1698" id="h5-0-1698" class="i">+
</a><a href="#h5-0-1699" id="h5-0-1699" class="i">+int
</a><a href="#h5-0-1700" id="h5-0-1700" class="i">+main(int argc, char *argv[])
</a><a href="#h5-0-1701" id="h5-0-1701" class="i">+{
</a><a href="#h5-0-1702" id="h5-0-1702" class="i">+	xw.l = xw.t = 0;
</a><a href="#h5-0-1703" id="h5-0-1703" class="i">+	xw.isfixed = False;
</a><a href="#h5-0-1704" id="h5-0-1704" class="i">+	win.cursor = cursorshape;
</a><a href="#h5-0-1705" id="h5-0-1705" class="i">+
</a><a href="#h5-0-1706" id="h5-0-1706" class="i">+	ARGBEGIN {
</a><a href="#h5-0-1707" id="h5-0-1707" class="i">+	case &#39;a&#39;:
</a><a href="#h5-0-1708" id="h5-0-1708" class="i">+		allowaltscreen = 0;
</a><a href="#h5-0-1709" id="h5-0-1709" class="i">+		break;
</a><a href="#h5-0-1710" id="h5-0-1710" class="i">+	case &#39;c&#39;:
</a><a href="#h5-0-1711" id="h5-0-1711" class="i">+		opt_class = EARGF(usage());
</a><a href="#h5-0-1712" id="h5-0-1712" class="i">+		break;
</a><a href="#h5-0-1713" id="h5-0-1713" class="i">+	case &#39;e&#39;:
</a><a href="#h5-0-1714" id="h5-0-1714" class="i">+		if (argc &gt; 0)
</a><a href="#h5-0-1715" id="h5-0-1715" class="i">+			--argc, ++argv;
</a><a href="#h5-0-1716" id="h5-0-1716" class="i">+		goto run;
</a><a href="#h5-0-1717" id="h5-0-1717" class="i">+	case &#39;f&#39;:
</a><a href="#h5-0-1718" id="h5-0-1718" class="i">+		opt_font = EARGF(usage());
</a><a href="#h5-0-1719" id="h5-0-1719" class="i">+		break;
</a><a href="#h5-0-1720" id="h5-0-1720" class="i">+	case &#39;g&#39;:
</a><a href="#h5-0-1721" id="h5-0-1721" class="i">+		xw.gm = XParseGeometry(EARGF(usage()),
</a><a href="#h5-0-1722" id="h5-0-1722" class="i">+				&amp;xw.l, &amp;xw.t, &amp;cols, &amp;rows);
</a><a href="#h5-0-1723" id="h5-0-1723" class="i">+		break;
</a><a href="#h5-0-1724" id="h5-0-1724" class="i">+	case &#39;i&#39;:
</a><a href="#h5-0-1725" id="h5-0-1725" class="i">+		xw.isfixed = 1;
</a><a href="#h5-0-1726" id="h5-0-1726" class="i">+		break;
</a><a href="#h5-0-1727" id="h5-0-1727" class="i">+	case &#39;o&#39;:
</a><a href="#h5-0-1728" id="h5-0-1728" class="i">+		opt_io = EARGF(usage());
</a><a href="#h5-0-1729" id="h5-0-1729" class="i">+		break;
</a><a href="#h5-0-1730" id="h5-0-1730" class="i">+	case &#39;l&#39;:
</a><a href="#h5-0-1731" id="h5-0-1731" class="i">+		opt_line = EARGF(usage());
</a><a href="#h5-0-1732" id="h5-0-1732" class="i">+		break;
</a><a href="#h5-0-1733" id="h5-0-1733" class="i">+	case &#39;n&#39;:
</a><a href="#h5-0-1734" id="h5-0-1734" class="i">+		opt_name = EARGF(usage());
</a><a href="#h5-0-1735" id="h5-0-1735" class="i">+		break;
</a><a href="#h5-0-1736" id="h5-0-1736" class="i">+	case &#39;t&#39;:
</a><a href="#h5-0-1737" id="h5-0-1737" class="i">+	case &#39;T&#39;:
</a><a href="#h5-0-1738" id="h5-0-1738" class="i">+		opt_title = EARGF(usage());
</a><a href="#h5-0-1739" id="h5-0-1739" class="i">+		break;
</a><a href="#h5-0-1740" id="h5-0-1740" class="i">+	case &#39;w&#39;:
</a><a href="#h5-0-1741" id="h5-0-1741" class="i">+		opt_embed = EARGF(usage());
</a><a href="#h5-0-1742" id="h5-0-1742" class="i">+		break;
</a><a href="#h5-0-1743" id="h5-0-1743" class="i">+	case &#39;v&#39;:
</a><a href="#h5-0-1744" id="h5-0-1744" class="i">+		die(&quot;%s &quot; VERSION &quot; (c) 2010-2016 st engineers\n&quot;, argv0);
</a><a href="#h5-0-1745" id="h5-0-1745" class="i">+		break;
</a><a href="#h5-0-1746" id="h5-0-1746" class="i">+	default:
</a><a href="#h5-0-1747" id="h5-0-1747" class="i">+		usage();
</a><a href="#h5-0-1748" id="h5-0-1748" class="i">+	} ARGEND;
</a><a href="#h5-0-1749" id="h5-0-1749" class="i">+
</a><a href="#h5-0-1750" id="h5-0-1750" class="i">+run:
</a><a href="#h5-0-1751" id="h5-0-1751" class="i">+	if (argc &gt; 0) {
</a><a href="#h5-0-1752" id="h5-0-1752" class="i">+		/* eat all remaining arguments */
</a><a href="#h5-0-1753" id="h5-0-1753" class="i">+		opt_cmd = argv;
</a><a href="#h5-0-1754" id="h5-0-1754" class="i">+		if (!opt_title &amp;&amp; !opt_line)
</a><a href="#h5-0-1755" id="h5-0-1755" class="i">+			opt_title = basename(xstrdup(argv[0]));
</a><a href="#h5-0-1756" id="h5-0-1756" class="i">+	}
</a><a href="#h5-0-1757" id="h5-0-1757" class="i">+	setlocale(LC_CTYPE, &quot;&quot;);
</a><a href="#h5-0-1758" id="h5-0-1758" class="i">+	XSetLocaleModifiers(&quot;&quot;);
</a><a href="#h5-0-1759" id="h5-0-1759" class="i">+	tnew(MAX(cols, 1), MAX(rows, 1));
</a><a href="#h5-0-1760" id="h5-0-1760" class="i">+	xinit();
</a><a href="#h5-0-1761" id="h5-0-1761" class="i">+	selinit();
</a><a href="#h5-0-1762" id="h5-0-1762" class="i">+	run();
</a><a href="#h5-0-1763" id="h5-0-1763" class="i">+
</a><a href="#h5-0-1764" id="h5-0-1764" class="i">+	return 0;
</a><a href="#h5-0-1765" id="h5-0-1765" class="i">+}
</a></pre>
</div>
</body>
</html>
