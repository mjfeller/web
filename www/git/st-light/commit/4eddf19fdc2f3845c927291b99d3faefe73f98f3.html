<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>The style inquisition was here. Yes, making it a unified style. The last - st-light - Unnamed repository; edit this file &#39;description&#39; to name the repository.
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st-light Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st-light</h1><span class="desc">Unnamed repository; edit this file &#39;description&#39; to name the repository.
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/4eddf19fdc2f3845c927291b99d3faefe73f98f3.html">4eddf19fdc2f3845c927291b99d3faefe73f98f3</a>
<b>parent</b> <a href="../commit/7efa4514d104d51793c4dd01ddedd4976080be07.html">7efa4514d104d51793c4dd01ddedd4976080be07</a>
<b>Author:</b> Christoph Lohmann &lt;<a href="mailto:20h@r-36.net">20h@r-36.net</a>&gt;
<b>Date:</b>   Sat,  6 Oct 2012 09:58:45 +0200

The style inquisition was here. Yes, making it a unified style. The last

infidels will be squashed too!
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">st.c</a></td><td> | </td><td class="num">365</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------</span></td></tr>
</table></pre><pre>1 file changed, 230 insertions(+), 135 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -180,9 +180,9 @@ typedef struct {
</a> typedef struct {
 	int row;	/* nb row */
 	int col;	/* nb col */
<a href="#h0-0-3" id="h0-0-3" class="d">-	Line* line;	/* screen */
</a><a href="#h0-0-4" id="h0-0-4" class="d">-	Line* alt;	/* alternate screen */
</a><a href="#h0-0-5" id="h0-0-5" class="d">-	bool* dirty;	/* dirtyness of lines */
</a><a href="#h0-0-6" id="h0-0-6" class="i">+	Line *line;	/* screen */
</a><a href="#h0-0-7" id="h0-0-7" class="i">+	Line *alt;	/* alternate screen */
</a><a href="#h0-0-8" id="h0-0-8" class="i">+	bool *dirty;	/* dirtyness of lines */
</a> 	TCursor c;	/* cursor */
 	int top;	/* top    scroll limit */
 	int bot;	/* bottom scroll limit */
<a href="#h0-1" id="h0-1" class="h">@@ -242,7 +242,7 @@ typedef struct {
</a> 	int descent;
 	short lbearing;
 	short rbearing;
<a href="#h0-1-3" id="h0-1-3" class="d">-	XftFont* xft_set;
</a><a href="#h0-1-4" id="h0-1-4" class="i">+	XftFont *xft_set;
</a> } Font;
 
 /* Drawing Context */
<a href="#h0-2" id="h0-2" class="h">@@ -252,7 +252,7 @@ typedef struct {
</a> 	Font font, bfont, ifont, ibfont;
 } DC;
 
<a href="#h0-2-3" id="h0-2-3" class="d">-static void die(const char*, ...);
</a><a href="#h0-2-4" id="h0-2-4" class="i">+static void die(const char *, ...);
</a> static void draw(void);
 static void redraw(void);
 static void drawregion(int, int, int, int);
<a href="#h0-3" id="h0-3" class="h">@@ -279,7 +279,7 @@ static void tmoveto(int, int);
</a> static void tnew(int, int);
 static void tnewline(int);
 static void tputtab(bool);
<a href="#h0-3-3" id="h0-3-3" class="d">-static void tputc(char*, int);
</a><a href="#h0-3-4" id="h0-3-4" class="i">+static void tputc(char *, int);
</a> static void treset(void);
 static int tresize(int, int);
 static void tscrollup(int, int);
<a href="#h0-4" id="h0-4" class="h">@@ -313,7 +313,7 @@ static void xresize(int, int);
</a> static void expose(XEvent *);
 static void visibility(XEvent *);
 static void unmap(XEvent *);
<a href="#h0-4-3" id="h0-4-3" class="d">-static char* kmap(KeySym, uint);
</a><a href="#h0-4-4" id="h0-4-4" class="i">+static char *kmap(KeySym, uint);
</a> static void kpress(XEvent *);
 static void cmessage(XEvent *);
 static void resize(XEvent *);
<a href="#h0-5" id="h0-5" class="h">@@ -378,8 +378,10 @@ static char *opt_font = NULL;
</a> void *
 xmalloc(size_t len) {
 	void *p = malloc(len);
<a href="#h0-5-3" id="h0-5-3" class="i">+
</a> 	if(!p)
 		die(&quot;Out of memory\n&quot;);
<a href="#h0-5-6" id="h0-5-6" class="i">+
</a> 	return p;
 }
 
<a href="#h0-6" id="h0-6" class="h">@@ -387,14 +389,17 @@ void *
</a> xrealloc(void *p, size_t len) {
 	if((p = realloc(p, len)) == NULL)
 		die(&quot;Out of memory\n&quot;);
<a href="#h0-6-3" id="h0-6-3" class="i">+
</a> 	return p;
 }
 
 void *
 xcalloc(size_t nmemb, size_t size) {
 	void *p = calloc(nmemb, size);
<a href="#h0-6-10" id="h0-6-10" class="i">+
</a> 	if(!p)
 		die(&quot;Out of memory\n&quot;);
<a href="#h0-6-13" id="h0-6-13" class="i">+
</a> 	return p;
 }
 
<a href="#h0-7" id="h0-7" class="h">@@ -455,8 +460,10 @@ utf8decode(char *s, long *u) {
</a> 	} else if((c &amp; (B7|B6|B5|B4|B3)) == (B7|B6|B5|B4)) { /* 11110xxx */
 		*u = c &amp; (B2|B1|B0);
 		n = 3;
<a href="#h0-7-3" id="h0-7-3" class="d">-	} else
</a><a href="#h0-7-4" id="h0-7-4" class="i">+	} else {
</a> 		goto invalid;
<a href="#h0-7-6" id="h0-7-6" class="i">+	}
</a><a href="#h0-7-7" id="h0-7-7" class="i">+
</a> 	for(i = n, ++s; i &gt; 0; --i, ++rtn, ++s) {
 		c = *s;
 		if((c &amp; (B7|B6)) != B7) /* 10xxxxxx */
<a href="#h0-8" id="h0-8" class="h">@@ -464,14 +471,18 @@ utf8decode(char *s, long *u) {
</a> 		*u &lt;&lt;= 6;
 		*u |= c &amp; (B5|B4|B3|B2|B1|B0);
 	}
<a href="#h0-8-3" id="h0-8-3" class="i">+
</a> 	if((n == 1 &amp;&amp; *u &lt; 0x80) ||
 	   (n == 2 &amp;&amp; *u &lt; 0x800) ||
 	   (n == 3 &amp;&amp; *u &lt; 0x10000) ||
<a href="#h0-8-7" id="h0-8-7" class="d">-	   (*u &gt;= 0xD800 &amp;&amp; *u &lt;= 0xDFFF))
</a><a href="#h0-8-8" id="h0-8-8" class="i">+	   (*u &gt;= 0xD800 &amp;&amp; *u &lt;= 0xDFFF)) {
</a> 		goto invalid;
<a href="#h0-8-10" id="h0-8-10" class="i">+	}
</a><a href="#h0-8-11" id="h0-8-11" class="i">+
</a> 	return rtn;
 invalid:
 	*u = 0xFFFD;
<a href="#h0-8-15" id="h0-8-15" class="i">+
</a> 	return rtn;
 }
 
<a href="#h0-9" id="h0-9" class="h">@@ -481,7 +492,7 @@ utf8encode(long *u, char *s) {
</a> 	ulong uc;
 	int i, n;
 
<a href="#h0-9-3" id="h0-9-3" class="d">-	sp = (uchar*) s;
</a><a href="#h0-9-4" id="h0-9-4" class="i">+	sp = (uchar *)s;
</a> 	uc = *u;
 	if(uc &lt; 0x80) {
 		*sp = uc; /* 0xxxxxxx */
<a href="#h0-10" id="h0-10" class="h">@@ -498,14 +509,17 @@ utf8encode(long *u, char *s) {
</a> 	} else {
 		goto invalid;
 	}
<a href="#h0-10-3" id="h0-10-3" class="i">+
</a> 	for(i=n,++sp; i&gt;0; --i,++sp)
 		*sp = ((uc &gt;&gt; 6*(i-1)) &amp; (B5|B4|B3|B2|B1|B0)) | B7; /* 10xxxxxx */
<a href="#h0-10-6" id="h0-10-6" class="i">+
</a> 	return n+1;
 invalid:
 	/* U+FFFD */
 	*s++ = &#39;\xEF&#39;;
 	*s++ = &#39;\xBF&#39;;
 	*s = &#39;\xBD&#39;;
<a href="#h0-10-13" id="h0-10-13" class="i">+
</a> 	return 3;
 }
 
<a href="#h0-11" id="h0-11" class="h">@@ -515,38 +529,40 @@ int
</a> isfullutf8(char *s, int b) {
 	uchar *c1, *c2, *c3;
 
<a href="#h0-11-3" id="h0-11-3" class="d">-	c1 = (uchar *) s;
</a><a href="#h0-11-4" id="h0-11-4" class="d">-	c2 = (uchar *) ++s;
</a><a href="#h0-11-5" id="h0-11-5" class="d">-	c3 = (uchar *) ++s;
</a><a href="#h0-11-6" id="h0-11-6" class="d">-	if(b &lt; 1)
</a><a href="#h0-11-7" id="h0-11-7" class="i">+	c1 = (uchar *)s;
</a><a href="#h0-11-8" id="h0-11-8" class="i">+	c2 = (uchar *)++s;
</a><a href="#h0-11-9" id="h0-11-9" class="i">+	c3 = (uchar *)++s;
</a><a href="#h0-11-10" id="h0-11-10" class="i">+	if(b &lt; 1) {
</a> 		return 0;
<a href="#h0-11-12" id="h0-11-12" class="d">-	else if((*c1&amp;(B7|B6|B5)) == (B7|B6) &amp;&amp; b == 1)
</a><a href="#h0-11-13" id="h0-11-13" class="i">+	} else if((*c1&amp;(B7|B6|B5)) == (B7|B6) &amp;&amp; b == 1) {
</a> 		return 0;
<a href="#h0-11-15" id="h0-11-15" class="d">-	else if((*c1&amp;(B7|B6|B5|B4)) == (B7|B6|B5) &amp;&amp;
</a><a href="#h0-11-16" id="h0-11-16" class="i">+	} else if((*c1&amp;(B7|B6|B5|B4)) == (B7|B6|B5) &amp;&amp;
</a> 	    ((b == 1) ||
<a href="#h0-11-18" id="h0-11-18" class="d">-	    ((b == 2) &amp;&amp; (*c2&amp;(B7|B6)) == B7)))
</a><a href="#h0-11-19" id="h0-11-19" class="i">+	    ((b == 2) &amp;&amp; (*c2&amp;(B7|B6)) == B7))) {
</a> 		return 0;
<a href="#h0-11-21" id="h0-11-21" class="d">-	else if((*c1&amp;(B7|B6|B5|B4|B3)) == (B7|B6|B5|B4) &amp;&amp;
</a><a href="#h0-11-22" id="h0-11-22" class="i">+	} else if((*c1&amp;(B7|B6|B5|B4|B3)) == (B7|B6|B5|B4) &amp;&amp;
</a> 	    ((b == 1) ||
 	    ((b == 2) &amp;&amp; (*c2&amp;(B7|B6)) == B7) ||
<a href="#h0-11-25" id="h0-11-25" class="d">-	    ((b == 3) &amp;&amp; (*c2&amp;(B7|B6)) == B7 &amp;&amp; (*c3&amp;(B7|B6)) == B7)))
</a><a href="#h0-11-26" id="h0-11-26" class="i">+	    ((b == 3) &amp;&amp; (*c2&amp;(B7|B6)) == B7 &amp;&amp; (*c3&amp;(B7|B6)) == B7))) {
</a> 		return 0;
<a href="#h0-11-28" id="h0-11-28" class="d">-	else
</a><a href="#h0-11-29" id="h0-11-29" class="i">+	} else {
</a> 		return 1;
<a href="#h0-11-31" id="h0-11-31" class="i">+	}
</a> }
 
 int
 utf8size(char *s) {
 	uchar c = *s;
 
<a href="#h0-11-38" id="h0-11-38" class="d">-	if(~c&amp;B7)
</a><a href="#h0-11-39" id="h0-11-39" class="i">+	if(~c&amp;B7) {
</a> 		return 1;
<a href="#h0-11-41" id="h0-11-41" class="d">-	else if((c&amp;(B7|B6|B5)) == (B7|B6))
</a><a href="#h0-11-42" id="h0-11-42" class="i">+	} else if((c&amp;(B7|B6|B5)) == (B7|B6)) {
</a> 		return 2;
<a href="#h0-11-44" id="h0-11-44" class="d">-	else if((c&amp;(B7|B6|B5|B4)) == (B7|B6|B5))
</a><a href="#h0-11-45" id="h0-11-45" class="i">+	} else if((c&amp;(B7|B6|B5|B4)) == (B7|B6|B5)) {
</a> 		return 3;
<a href="#h0-11-47" id="h0-11-47" class="d">-	else
</a><a href="#h0-11-48" id="h0-11-48" class="i">+	} else {
</a> 		return 4;
<a href="#h0-11-50" id="h0-11-50" class="i">+	}
</a> }
 
 void
<a href="#h0-12" id="h0-12" class="h">@@ -563,13 +579,18 @@ selinit(void) {
</a> 
 static inline bool
 selected(int x, int y) {
<a href="#h0-12-3" id="h0-12-3" class="i">+	int bx, ex;
</a><a href="#h0-12-4" id="h0-12-4" class="i">+
</a> 	if(sel.ey == y &amp;&amp; sel.by == y) {
<a href="#h0-12-6" id="h0-12-6" class="d">-		int bx = MIN(sel.bx, sel.ex);
</a><a href="#h0-12-7" id="h0-12-7" class="d">-		int ex = MAX(sel.bx, sel.ex);
</a><a href="#h0-12-8" id="h0-12-8" class="i">+		bx = MIN(sel.bx, sel.ex);
</a><a href="#h0-12-9" id="h0-12-9" class="i">+		ex = MAX(sel.bx, sel.ex);
</a> 		return BETWEEN(x, bx, ex);
 	}
<a href="#h0-12-12" id="h0-12-12" class="d">-	return ((sel.b.y &lt; y&amp;&amp;y &lt; sel.e.y) || (y==sel.e.y &amp;&amp; x&lt;=sel.e.x))
</a><a href="#h0-12-13" id="h0-12-13" class="d">-		|| (y==sel.b.y &amp;&amp; x&gt;=sel.b.x &amp;&amp; (x&lt;=sel.e.x || sel.b.y!=sel.e.y));
</a><a href="#h0-12-14" id="h0-12-14" class="i">+
</a><a href="#h0-12-15" id="h0-12-15" class="i">+	return ((sel.b.y &lt; y&amp;&amp;y &lt; sel.e.y)
</a><a href="#h0-12-16" id="h0-12-16" class="i">+			|| (y==sel.e.y &amp;&amp; x&lt;=sel.e.x))
</a><a href="#h0-12-17" id="h0-12-17" class="i">+			|| (y==sel.b.y &amp;&amp; x&gt;=sel.b.x
</a><a href="#h0-12-18" id="h0-12-18" class="i">+					&amp;&amp; (x&lt;=sel.e.x || sel.b.y!=sel.e.y));
</a> }
 
 void
<a href="#h0-13" id="h0-13" class="h">@@ -621,9 +642,9 @@ mousereport(XEvent *e) {
</a> 
 void
 bpress(XEvent *e) {
<a href="#h0-13-3" id="h0-13-3" class="d">-	if(IS_SET(MODE_MOUSE))
</a><a href="#h0-13-4" id="h0-13-4" class="i">+	if(IS_SET(MODE_MOUSE)) {
</a> 		mousereport(e);
<a href="#h0-13-6" id="h0-13-6" class="d">-	else if(e-&gt;xbutton.button == Button1) {
</a><a href="#h0-13-7" id="h0-13-7" class="i">+	} else if(e-&gt;xbutton.button == Button1) {
</a> 		if(sel.bx != -1) {
 			sel.bx = -1;
 			tsetdirt(sel.b.y, sel.e.y);
<a href="#h0-14" id="h0-14" class="h">@@ -637,22 +658,20 @@ bpress(XEvent *e) {
</a> 
 void
 selcopy(void) {
<a href="#h0-14-3" id="h0-14-3" class="d">-	char *str, *ptr;
</a><a href="#h0-14-4" id="h0-14-4" class="d">-	int x, y, bufsize, is_selected = 0;
</a><a href="#h0-14-5" id="h0-14-5" class="i">+	char *str, *ptr, *p;
</a><a href="#h0-14-6" id="h0-14-6" class="i">+	int x, y, bufsize, is_selected = 0, size;
</a><a href="#h0-14-7" id="h0-14-7" class="i">+	Glyph *gp;
</a> 
<a href="#h0-14-9" id="h0-14-9" class="d">-	if(sel.bx == -1)
</a><a href="#h0-14-10" id="h0-14-10" class="i">+	if(sel.bx == -1) {
</a> 		str = NULL;
<a href="#h0-14-12" id="h0-14-12" class="d">-
</a><a href="#h0-14-13" id="h0-14-13" class="d">-	else {
</a><a href="#h0-14-14" id="h0-14-14" class="i">+	} else {
</a> 		bufsize = (term.col+1) * (sel.e.y-sel.b.y+1) * UTF_SIZ;
 		ptr = str = xmalloc(bufsize);
 
 		/* append every set &amp; selected glyph to the selection */
 		for(y = 0; y &lt; term.row; y++) {
 			for(x = 0; x &lt; term.col; x++) {
<a href="#h0-14-21" id="h0-14-21" class="d">-				int size;
</a><a href="#h0-14-22" id="h0-14-22" class="d">-				char *p;
</a><a href="#h0-14-23" id="h0-14-23" class="d">-				Glyph *gp = &amp;term.line[y][x];
</a><a href="#h0-14-24" id="h0-14-24" class="i">+				gp = &amp;term.line[y][x];
</a> 
 				if(!(is_selected = selected(x, y)))
 					continue;
<a href="#h0-15" id="h0-15" class="h">@@ -694,8 +713,9 @@ selnotify(XEvent *e) {
</a> }
 
 void
<a href="#h0-15-3" id="h0-15-3" class="d">-selpaste() {
</a><a href="#h0-15-4" id="h0-15-4" class="d">-	XConvertSelection(xw.dpy, XA_PRIMARY, sel.xtarget, XA_PRIMARY, xw.win, CurrentTime);
</a><a href="#h0-15-5" id="h0-15-5" class="i">+selpaste(void) {
</a><a href="#h0-15-6" id="h0-15-6" class="i">+	XConvertSelection(xw.dpy, XA_PRIMARY, sel.xtarget, XA_PRIMARY,
</a><a href="#h0-15-7" id="h0-15-7" class="i">+			xw.win, CurrentTime);
</a> }
 
 void selclear(XEvent *e) {
<a href="#h0-16" id="h0-16" class="h">@@ -709,7 +729,7 @@ void
</a> selrequest(XEvent *e) {
 	XSelectionRequestEvent *xsre;
 	XSelectionEvent xev;
<a href="#h0-16-3" id="h0-16-3" class="d">-	Atom xa_targets;
</a><a href="#h0-16-4" id="h0-16-4" class="i">+	Atom xa_targets, string;
</a> 
 	xsre = (XSelectionRequestEvent *) e;
 	xev.type = SelectionNotify;
<a href="#h0-17" id="h0-17" class="h">@@ -723,7 +743,7 @@ selrequest(XEvent *e) {
</a> 	xa_targets = XInternAtom(xw.dpy, &quot;TARGETS&quot;, 0);
 	if(xsre-&gt;target == xa_targets) {
 		/* respond with the supported type */
<a href="#h0-17-3" id="h0-17-3" class="d">-		Atom string = sel.xtarget;
</a><a href="#h0-17-4" id="h0-17-4" class="i">+		string = sel.xtarget;
</a> 		XChangeProperty(xsre-&gt;display, xsre-&gt;requestor, xsre-&gt;property,
 				XA_ATOM, 32, PropModeReplace,
 				(uchar *) &amp;string, 1);
<a href="#h0-18" id="h0-18" class="h">@@ -756,18 +776,20 @@ xsetsel(char *str) {
</a> 
 void
 brelease(XEvent *e) {
<a href="#h0-18-3" id="h0-18-3" class="i">+	struct timeval now;
</a><a href="#h0-18-4" id="h0-18-4" class="i">+
</a> 	if(IS_SET(MODE_MOUSE)) {
 		mousereport(e);
 		return;
 	}
<a href="#h0-18-9" id="h0-18-9" class="d">-	if(e-&gt;xbutton.button == Button2)
</a><a href="#h0-18-10" id="h0-18-10" class="i">+
</a><a href="#h0-18-11" id="h0-18-11" class="i">+	if(e-&gt;xbutton.button == Button2) {
</a> 		selpaste();
<a href="#h0-18-13" id="h0-18-13" class="d">-	else if(e-&gt;xbutton.button == Button1) {
</a><a href="#h0-18-14" id="h0-18-14" class="i">+	} else if(e-&gt;xbutton.button == Button1) {
</a> 		sel.mode = 0;
 		getbuttoninfo(e, NULL, &amp;sel.ex, &amp;sel.ey);
 		term.dirty[sel.ey] = 1;
 		if(sel.bx == sel.ex &amp;&amp; sel.by == sel.ey) {
<a href="#h0-18-19" id="h0-18-19" class="d">-			struct timeval now;
</a> 			sel.bx = -1;
 			gettimeofday(&amp;now, NULL);
 
<a href="#h0-19" id="h0-19" class="h">@@ -781,34 +803,44 @@ brelease(XEvent *e) {
</a> 				/* double click to select word */
 				sel.bx = sel.ex;
 				while(sel.bx &gt; 0 &amp;&amp; term.line[sel.ey][sel.bx-1].state &amp; GLYPH_SET &amp;&amp;
<a href="#h0-19-3" id="h0-19-3" class="d">-					  term.line[sel.ey][sel.bx-1].c[0] != &#39; &#39;) sel.bx--;
</a><a href="#h0-19-4" id="h0-19-4" class="i">+					  term.line[sel.ey][sel.bx-1].c[0] != &#39; &#39;) {
</a><a href="#h0-19-5" id="h0-19-5" class="i">+					sel.bx--;
</a><a href="#h0-19-6" id="h0-19-6" class="i">+				}
</a> 				sel.b.x = sel.bx;
 				while(sel.ex &lt; term.col-1 &amp;&amp; term.line[sel.ey][sel.ex+1].state &amp; GLYPH_SET &amp;&amp;
<a href="#h0-19-9" id="h0-19-9" class="d">-					  term.line[sel.ey][sel.ex+1].c[0] != &#39; &#39;) sel.ex++;
</a><a href="#h0-19-10" id="h0-19-10" class="i">+					  term.line[sel.ey][sel.ex+1].c[0] != &#39; &#39;) {
</a><a href="#h0-19-11" id="h0-19-11" class="i">+					sel.ex++;
</a><a href="#h0-19-12" id="h0-19-12" class="i">+				}
</a> 				sel.e.x = sel.ex;
 				sel.b.y = sel.e.y = sel.ey;
 				selcopy();
 			}
<a href="#h0-19-17" id="h0-19-17" class="d">-		} else
</a><a href="#h0-19-18" id="h0-19-18" class="i">+		} else {
</a> 			selcopy();
<a href="#h0-19-20" id="h0-19-20" class="i">+		}
</a> 	}
<a href="#h0-19-22" id="h0-19-22" class="i">+
</a> 	memcpy(&amp;sel.tclick2, &amp;sel.tclick1, sizeof(struct timeval));
 	gettimeofday(&amp;sel.tclick1, NULL);
 }
 
 void
 bmotion(XEvent *e) {
<a href="#h0-19-29" id="h0-19-29" class="i">+	int starty, endy, oldey, oldex;
</a><a href="#h0-19-30" id="h0-19-30" class="i">+
</a> 	if(IS_SET(MODE_MOUSE)) {
 		mousereport(e);
 		return;
 	}
<a href="#h0-19-35" id="h0-19-35" class="i">+
</a> 	if(sel.mode) {
<a href="#h0-19-37" id="h0-19-37" class="d">-		int oldey = sel.ey, oldex = sel.ex;
</a><a href="#h0-19-38" id="h0-19-38" class="i">+		oldey = sel.ey;
</a><a href="#h0-19-39" id="h0-19-39" class="i">+		oldex = sel.ex;
</a> 		getbuttoninfo(e, NULL, &amp;sel.ex, &amp;sel.ey);
 
 		if(oldey != sel.ey || oldex != sel.ex) {
<a href="#h0-19-43" id="h0-19-43" class="d">-			int starty = MIN(oldey, sel.ey);
</a><a href="#h0-19-44" id="h0-19-44" class="d">-			int endy = MAX(oldey, sel.ey);
</a><a href="#h0-19-45" id="h0-19-45" class="i">+			starty = MIN(oldey, sel.ey);
</a><a href="#h0-19-46" id="h0-19-46" class="i">+			endy = MAX(oldey, sel.ey);
</a> 			tsetdirt(starty, endy);
 		}
 	}
<a href="#h0-20" id="h0-20" class="h">@@ -864,9 +896,9 @@ sigchld(int a) {
</a> void
 ttynew(void) {
 	int m, s;
<a href="#h0-20-3" id="h0-20-3" class="i">+	struct winsize w = {term.row, term.col, 0, 0};
</a> 
 	/* seems to work fine on linux, openbsd and freebsd */
<a href="#h0-20-6" id="h0-20-6" class="d">-	struct winsize w = {term.row, term.col, 0, 0};
</a> 	if(openpty(&amp;m, &amp;s, NULL, NULL, &amp;w) &lt; 0)
 		die(&quot;openpty failed: %s\n&quot;, SERRNO);
 
<a href="#h0-21" id="h0-21" class="h">@@ -905,6 +937,7 @@ ttynew(void) {
</a> void
 dump(char c) {
 	static int col;
<a href="#h0-21-3" id="h0-21-3" class="i">+
</a> 	fprintf(stderr, &quot; %02x &#39;%c&#39; &quot;, c, isprint(c)?c:&#39;.&#39;);
 	if(++col % 10 == 0)
 		fprintf(stderr, &quot;\n&quot;);
<a href="#h0-22" id="h0-22" class="h">@@ -931,7 +964,7 @@ ttyread(void) {
</a> 		charsize = utf8decode(ptr, &amp;utf8c);
 		utf8encode(&amp;utf8c, s);
 		tputc(s, charsize);
<a href="#h0-22-3" id="h0-22-3" class="d">-		ptr    += charsize;
</a><a href="#h0-22-4" id="h0-22-4" class="i">+		ptr += charsize;
</a> 		buflen -= charsize;
 	}
 
<a href="#h0-23" id="h0-23" class="h">@@ -958,8 +991,7 @@ ttyresize(void) {
</a> }
 
 void
<a href="#h0-23-3" id="h0-23-3" class="d">-tsetdirt(int top, int bot)
</a><a href="#h0-23-4" id="h0-23-4" class="d">-{
</a><a href="#h0-23-5" id="h0-23-5" class="i">+tsetdirt(int top, int bot) {
</a> 	int i;
 
 	LIMIT(top, 0, term.row-1);
<a href="#h0-24" id="h0-24" class="h">@@ -970,8 +1002,7 @@ tsetdirt(int top, int bot)
</a> }
 
 void
<a href="#h0-24-3" id="h0-24-3" class="d">-tfulldirt(void)
</a><a href="#h0-24-4" id="h0-24-4" class="d">-{
</a><a href="#h0-24-5" id="h0-24-5" class="i">+tfulldirt(void) {
</a> 	tsetdirt(0, term.row-1);
 }
 
<a href="#h0-25" id="h0-25" class="h">@@ -979,15 +1010,18 @@ void
</a> tcursor(int mode) {
 	static TCursor c;
 
<a href="#h0-25-3" id="h0-25-3" class="d">-	if(mode == CURSOR_SAVE)
</a><a href="#h0-25-4" id="h0-25-4" class="i">+	if(mode == CURSOR_SAVE) {
</a> 		c = term.c;
<a href="#h0-25-6" id="h0-25-6" class="d">-	else if(mode == CURSOR_LOAD)
</a><a href="#h0-25-7" id="h0-25-7" class="d">-		term.c = c, tmoveto(c.x, c.y);
</a><a href="#h0-25-8" id="h0-25-8" class="i">+	} else if(mode == CURSOR_LOAD) {
</a><a href="#h0-25-9" id="h0-25-9" class="i">+		term.c = c;
</a><a href="#h0-25-10" id="h0-25-10" class="i">+		tmoveto(c.x, c.y);
</a><a href="#h0-25-11" id="h0-25-11" class="i">+	}
</a> }
 
 void
 treset(void) {
 	uint i;
<a href="#h0-25-17" id="h0-25-17" class="i">+
</a> 	term.c = (TCursor){{
 		.mode = ATTR_NULL,
 		.fg = DefaultFG,
<a href="#h0-26" id="h0-26" class="h">@@ -1024,7 +1058,8 @@ tnew(int col, int row) {
</a> 
 void
 tswapscreen(void) {
<a href="#h0-26-3" id="h0-26-3" class="d">-	Line* tmp = term.line;
</a><a href="#h0-26-4" id="h0-26-4" class="i">+	Line *tmp = term.line;
</a><a href="#h0-26-5" id="h0-26-5" class="i">+
</a> 	term.line = term.alt;
 	term.alt = tmp;
 	term.mode ^= MODE_ALTSCREEN;
<a href="#h0-27" id="h0-27" class="h">@@ -1098,10 +1133,12 @@ selscroll(int orig, int n) {
</a> void
 tnewline(int first_col) {
 	int y = term.c.y;
<a href="#h0-27-3" id="h0-27-3" class="d">-	if(y == term.bot)
</a><a href="#h0-27-4" id="h0-27-4" class="i">+
</a><a href="#h0-27-5" id="h0-27-5" class="i">+	if(y == term.bot) {
</a> 		tscrollup(term.top, 1);
<a href="#h0-27-7" id="h0-27-7" class="d">-	else
</a><a href="#h0-27-8" id="h0-27-8" class="i">+	} else {
</a> 		y++;
<a href="#h0-27-10" id="h0-27-10" class="i">+	}
</a> 	tmoveto(first_col ? 0 : term.c.x, y);
 }
 
<a href="#h0-28" id="h0-28" class="h">@@ -1119,11 +1156,12 @@ csiparse(void) {
</a> 			csiescseq.arg[csiescseq.narg] *= 10;
 			csiescseq.arg[csiescseq.narg] += *p++ - &#39;0&#39;/*, noarg = 0 */;
 		}
<a href="#h0-28-3" id="h0-28-3" class="d">-		if(*p == &#39;;&#39; &amp;&amp; csiescseq.narg+1 &lt; ESC_ARG_SIZ)
</a><a href="#h0-28-4" id="h0-28-4" class="i">+		if(*p == &#39;;&#39; &amp;&amp; csiescseq.narg+1 &lt; ESC_ARG_SIZ) {
</a> 			csiescseq.narg++, p++;
<a href="#h0-28-6" id="h0-28-6" class="d">-		else {
</a><a href="#h0-28-7" id="h0-28-7" class="i">+		} else {
</a> 			csiescseq.mode = *p;
 			csiescseq.narg++;
<a href="#h0-28-10" id="h0-28-10" class="i">+
</a> 			return;
 		}
 	}
<a href="#h0-29" id="h0-29" class="h">@@ -1140,21 +1178,21 @@ tmoveto(int x, int y) {
</a> 
 void
 tsetchar(char *c) {
<a href="#h0-29-3" id="h0-29-3" class="i">+	char *vt100_0[62] = { /* 0x41 - 0x7e */
</a><a href="#h0-29-4" id="h0-29-4" class="i">+		&quot;↑&quot;, &quot;↓&quot;, &quot;→&quot;, &quot;←&quot;, &quot;█&quot;, &quot;▚&quot;, &quot;☃&quot;, /* A - G */
</a><a href="#h0-29-5" id="h0-29-5" class="i">+		0, 0, 0, 0, 0, 0, 0, 0, /* H - O */
</a><a href="#h0-29-6" id="h0-29-6" class="i">+		0, 0, 0, 0, 0, 0, 0, 0, /* P - W */
</a><a href="#h0-29-7" id="h0-29-7" class="i">+		0, 0, 0, 0, 0, 0, 0, &quot; &quot;, /* X - _ */
</a><a href="#h0-29-8" id="h0-29-8" class="i">+		&quot;◆&quot;, &quot;▒&quot;, &quot;␉&quot;, &quot;␌&quot;, &quot;␍&quot;, &quot;␊&quot;, &quot;°&quot;, &quot;±&quot;, /* ` - g */
</a><a href="#h0-29-9" id="h0-29-9" class="i">+		&quot;␤&quot;, &quot;␋&quot;, &quot;┘&quot;, &quot;┐&quot;, &quot;┌&quot;, &quot;└&quot;, &quot;┼&quot;, &quot;⎺&quot;, /* h - o */
</a><a href="#h0-29-10" id="h0-29-10" class="i">+		&quot;⎻&quot;, &quot;─&quot;, &quot;⎼&quot;, &quot;⎽&quot;, &quot;├&quot;, &quot;┤&quot;, &quot;┴&quot;, &quot;┬&quot;, /* p - w */
</a><a href="#h0-29-11" id="h0-29-11" class="i">+		&quot;│&quot;, &quot;≤&quot;, &quot;≥&quot;, &quot;π&quot;, &quot;≠&quot;, &quot;£&quot;, &quot;·&quot;, /* x - ~ */
</a><a href="#h0-29-12" id="h0-29-12" class="i">+	};
</a><a href="#h0-29-13" id="h0-29-13" class="i">+
</a> 	/*
 	 * The table is proudly stolen from rxvt.
 	 */
 	if(term.c.attr.mode &amp; ATTR_GFX) {
<a href="#h0-29-18" id="h0-29-18" class="d">-		char *vt100_0[62] = { /* 0x41 - 0x7e */
</a><a href="#h0-29-19" id="h0-29-19" class="d">-			&quot;↑&quot;, &quot;↓&quot;, &quot;→&quot;, &quot;←&quot;, &quot;█&quot;, &quot;▚&quot;, &quot;☃&quot;, /* A - G */
</a><a href="#h0-29-20" id="h0-29-20" class="d">-			0, 0, 0, 0, 0, 0, 0, 0, /* H - O */
</a><a href="#h0-29-21" id="h0-29-21" class="d">-			0, 0, 0, 0, 0, 0, 0, 0, /* P - W */
</a><a href="#h0-29-22" id="h0-29-22" class="d">-			0, 0, 0, 0, 0, 0, 0, &quot; &quot;, /* X - _ */
</a><a href="#h0-29-23" id="h0-29-23" class="d">-			&quot;◆&quot;, &quot;▒&quot;, &quot;␉&quot;, &quot;␌&quot;, &quot;␍&quot;, &quot;␊&quot;, &quot;°&quot;, &quot;±&quot;, /* ` - g */
</a><a href="#h0-29-24" id="h0-29-24" class="d">-			&quot;␤&quot;, &quot;␋&quot;, &quot;┘&quot;, &quot;┐&quot;, &quot;┌&quot;, &quot;└&quot;, &quot;┼&quot;, &quot;⎺&quot;, /* h - o */
</a><a href="#h0-29-25" id="h0-29-25" class="d">-			&quot;⎻&quot;, &quot;─&quot;, &quot;⎼&quot;, &quot;⎽&quot;, &quot;├&quot;, &quot;┤&quot;, &quot;┴&quot;, &quot;┬&quot;, /* p - w */
</a><a href="#h0-29-26" id="h0-29-26" class="d">-			&quot;│&quot;, &quot;≤&quot;, &quot;≥&quot;, &quot;π&quot;, &quot;≠&quot;, &quot;£&quot;, &quot;·&quot;, /* x - ~ */
</a><a href="#h0-29-27" id="h0-29-27" class="d">-		};
</a><a href="#h0-29-28" id="h0-29-28" class="d">-
</a> 		if(c[0] &gt;= 0x41 &amp;&amp; c[0] &lt;= 0x7e
 				&amp;&amp; vt100_0[c[0] - 0x41]) {
 			c = vt100_0[c[0] - 0x41];
<a href="#h0-30" id="h0-30" class="h">@@ -1200,7 +1238,9 @@ tdeletechar(int n) {
</a> 		tclearregion(term.c.x, term.c.y, term.col-1, term.c.y);
 		return;
 	}
<a href="#h0-30-3" id="h0-30-3" class="d">-	memmove(&amp;term.line[term.c.y][dst], &amp;term.line[term.c.y][src], size * sizeof(Glyph));
</a><a href="#h0-30-4" id="h0-30-4" class="i">+
</a><a href="#h0-30-5" id="h0-30-5" class="i">+	memmove(&amp;term.line[term.c.y][dst], &amp;term.line[term.c.y][src],
</a><a href="#h0-30-6" id="h0-30-6" class="i">+			size * sizeof(Glyph));
</a> 	tclearregion(term.col-n, term.c.y, term.col-1, term.c.y);
 }
 
<a href="#h0-31" id="h0-31" class="h">@@ -1216,7 +1256,9 @@ tinsertblank(int n) {
</a> 		tclearregion(term.c.x, term.c.y, term.col-1, term.c.y);
 		return;
 	}
<a href="#h0-31-3" id="h0-31-3" class="d">-	memmove(&amp;term.line[term.c.y][dst], &amp;term.line[term.c.y][src], size * sizeof(Glyph));
</a><a href="#h0-31-4" id="h0-31-4" class="i">+
</a><a href="#h0-31-5" id="h0-31-5" class="i">+	memmove(&amp;term.line[term.c.y][dst], &amp;term.line[term.c.y][src],
</a><a href="#h0-31-6" id="h0-31-6" class="i">+			size * sizeof(Glyph));
</a> 	tclearregion(src, term.c.y, dst - 1, term.c.y);
 }
 
<a href="#h0-32" id="h0-32" class="h">@@ -1282,13 +1324,18 @@ tsetattr(int *attr, int l) {
</a> 		case 38:
 			if(i + 2 &lt; l &amp;&amp; attr[i + 1] == 5) {
 				i += 2;
<a href="#h0-32-3" id="h0-32-3" class="d">-				if(BETWEEN(attr[i], 0, 255))
</a><a href="#h0-32-4" id="h0-32-4" class="i">+				if(BETWEEN(attr[i], 0, 255)) {
</a> 					term.c.attr.fg = attr[i];
<a href="#h0-32-6" id="h0-32-6" class="d">-				else
</a><a href="#h0-32-7" id="h0-32-7" class="d">-					fprintf(stderr, &quot;erresc: bad fgcolor %d\n&quot;, attr[i]);
</a><a href="#h0-32-8" id="h0-32-8" class="i">+				} else {
</a><a href="#h0-32-9" id="h0-32-9" class="i">+					fprintf(stderr,
</a><a href="#h0-32-10" id="h0-32-10" class="i">+						&quot;erresc: bad fgcolor %d\n&quot;,
</a><a href="#h0-32-11" id="h0-32-11" class="i">+						attr[i]);
</a><a href="#h0-32-12" id="h0-32-12" class="i">+				}
</a><a href="#h0-32-13" id="h0-32-13" class="i">+			} else {
</a><a href="#h0-32-14" id="h0-32-14" class="i">+				fprintf(stderr,
</a><a href="#h0-32-15" id="h0-32-15" class="i">+					&quot;erresc(38): gfx attr %d unknown\n&quot;,
</a><a href="#h0-32-16" id="h0-32-16" class="i">+					attr[i]);
</a> 			}
<a href="#h0-32-18" id="h0-32-18" class="d">-			else
</a><a href="#h0-32-19" id="h0-32-19" class="d">-				fprintf(stderr, &quot;erresc(38): gfx attr %d unknown\n&quot;, attr[i]);
</a> 			break;
 		case 39:
 			term.c.attr.fg = DefaultFG;
<a href="#h0-33" id="h0-33" class="h">@@ -1296,28 +1343,36 @@ tsetattr(int *attr, int l) {
</a> 		case 48:
 			if(i + 2 &lt; l &amp;&amp; attr[i + 1] == 5) {
 				i += 2;
<a href="#h0-33-3" id="h0-33-3" class="d">-				if(BETWEEN(attr[i], 0, 255))
</a><a href="#h0-33-4" id="h0-33-4" class="i">+				if(BETWEEN(attr[i], 0, 255)) {
</a> 					term.c.attr.bg = attr[i];
<a href="#h0-33-6" id="h0-33-6" class="d">-				else
</a><a href="#h0-33-7" id="h0-33-7" class="d">-					fprintf(stderr, &quot;erresc: bad bgcolor %d\n&quot;, attr[i]);
</a><a href="#h0-33-8" id="h0-33-8" class="i">+				} else {
</a><a href="#h0-33-9" id="h0-33-9" class="i">+					fprintf(stderr,
</a><a href="#h0-33-10" id="h0-33-10" class="i">+						&quot;erresc: bad bgcolor %d\n&quot;,
</a><a href="#h0-33-11" id="h0-33-11" class="i">+						attr[i]);
</a><a href="#h0-33-12" id="h0-33-12" class="i">+				}
</a><a href="#h0-33-13" id="h0-33-13" class="i">+			} else {
</a><a href="#h0-33-14" id="h0-33-14" class="i">+				fprintf(stderr,
</a><a href="#h0-33-15" id="h0-33-15" class="i">+					&quot;erresc(48): gfx attr %d unknown\n&quot;,
</a><a href="#h0-33-16" id="h0-33-16" class="i">+					attr[i]);
</a> 			}
<a href="#h0-33-18" id="h0-33-18" class="d">-			else
</a><a href="#h0-33-19" id="h0-33-19" class="d">-				fprintf(stderr, &quot;erresc(48): gfx attr %d unknown\n&quot;, attr[i]);
</a> 			break;
 		case 49:
 			term.c.attr.bg = DefaultBG;
 			break;
 		default:
<a href="#h0-33-25" id="h0-33-25" class="d">-			if(BETWEEN(attr[i], 30, 37))
</a><a href="#h0-33-26" id="h0-33-26" class="i">+			if(BETWEEN(attr[i], 30, 37)) {
</a> 				term.c.attr.fg = attr[i] - 30;
<a href="#h0-33-28" id="h0-33-28" class="d">-			else if(BETWEEN(attr[i], 40, 47))
</a><a href="#h0-33-29" id="h0-33-29" class="i">+			} else if(BETWEEN(attr[i], 40, 47)) {
</a> 				term.c.attr.bg = attr[i] - 40;
<a href="#h0-33-31" id="h0-33-31" class="d">-			else if(BETWEEN(attr[i], 90, 97))
</a><a href="#h0-33-32" id="h0-33-32" class="i">+			} else if(BETWEEN(attr[i], 90, 97)) {
</a> 				term.c.attr.fg = attr[i] - 90 + 8;
<a href="#h0-33-34" id="h0-33-34" class="d">-			else if(BETWEEN(attr[i], 100, 107))
</a><a href="#h0-33-35" id="h0-33-35" class="i">+			} else if(BETWEEN(attr[i], 100, 107)) {
</a> 				term.c.attr.bg = attr[i] - 100 + 8;
<a href="#h0-33-37" id="h0-33-37" class="d">-			else
</a><a href="#h0-33-38" id="h0-33-38" class="d">-				fprintf(stderr, &quot;erresc(default): gfx attr %d unknown\n&quot;, attr[i]), csidump();
</a><a href="#h0-33-39" id="h0-33-39" class="i">+			} else {
</a><a href="#h0-33-40" id="h0-33-40" class="i">+				fprintf(stderr,
</a><a href="#h0-33-41" id="h0-33-41" class="i">+					&quot;erresc(default): gfx attr %d unknown\n&quot;,
</a><a href="#h0-33-42" id="h0-33-42" class="i">+					attr[i]), csidump();
</a><a href="#h0-33-43" id="h0-33-43" class="i">+			}
</a> 			break;
 		}
 	}
<a href="#h0-34" id="h0-34" class="h">@@ -1573,9 +1628,9 @@ csihandle(void) {
</a> 		tsetattr(csiescseq.arg, csiescseq.narg);
 		break;
 	case &#39;r&#39;: /* DECSTBM -- Set Scrolling Region */
<a href="#h0-34-3" id="h0-34-3" class="d">-		if(csiescseq.priv)
</a><a href="#h0-34-4" id="h0-34-4" class="i">+		if(csiescseq.priv) {
</a> 			goto unknown;
<a href="#h0-34-6" id="h0-34-6" class="d">-		else {
</a><a href="#h0-34-7" id="h0-34-7" class="i">+		} else {
</a> 			DEFAULT(csiescseq.arg[0], 1);
 			DEFAULT(csiescseq.arg[1], term.row);
 			tsetscroll(csiescseq.arg[0]-1, csiescseq.arg[1]-1);
<a href="#h0-35" id="h0-35" class="h">@@ -1594,14 +1649,22 @@ csihandle(void) {
</a> void
 csidump(void) {
 	int i;
<a href="#h0-35-3" id="h0-35-3" class="i">+	uint c;
</a><a href="#h0-35-4" id="h0-35-4" class="i">+
</a> 	printf(&quot;ESC[&quot;);
 	for(i = 0; i &lt; csiescseq.len; i++) {
<a href="#h0-35-7" id="h0-35-7" class="d">-		uint c = csiescseq.buf[i] &amp; 0xff;
</a><a href="#h0-35-8" id="h0-35-8" class="d">-		if(isprint(c)) putchar(c);
</a><a href="#h0-35-9" id="h0-35-9" class="d">-		else if(c == &#39;\n&#39;) printf(&quot;(\\n)&quot;);
</a><a href="#h0-35-10" id="h0-35-10" class="d">-		else if(c == &#39;\r&#39;) printf(&quot;(\\r)&quot;);
</a><a href="#h0-35-11" id="h0-35-11" class="d">-		else if(c == 0x1b) printf(&quot;(\\e)&quot;);
</a><a href="#h0-35-12" id="h0-35-12" class="d">-		else printf(&quot;(%02x)&quot;, c);
</a><a href="#h0-35-13" id="h0-35-13" class="i">+		c = csiescseq.buf[i] &amp; 0xff;
</a><a href="#h0-35-14" id="h0-35-14" class="i">+		if(isprint(c)) {
</a><a href="#h0-35-15" id="h0-35-15" class="i">+			putchar(c);
</a><a href="#h0-35-16" id="h0-35-16" class="i">+		} else if(c == &#39;\n&#39;) {
</a><a href="#h0-35-17" id="h0-35-17" class="i">+			printf(&quot;(\\n)&quot;);
</a><a href="#h0-35-18" id="h0-35-18" class="i">+		} else if(c == &#39;\r&#39;) {
</a><a href="#h0-35-19" id="h0-35-19" class="i">+			printf(&quot;(\\r)&quot;);
</a><a href="#h0-35-20" id="h0-35-20" class="i">+		} else if(c == 0x1b) {
</a><a href="#h0-35-21" id="h0-35-21" class="i">+			printf(&quot;(\\e)&quot;);
</a><a href="#h0-35-22" id="h0-35-22" class="i">+		} else {
</a><a href="#h0-35-23" id="h0-35-23" class="i">+			printf(&quot;(%02x)&quot;, c);
</a><a href="#h0-35-24" id="h0-35-24" class="i">+		}
</a> 	}
 	putchar(&#39;\n&#39;);
 }
<a href="#h0-36" id="h0-36" class="h">@@ -1672,14 +1735,22 @@ strparse(void) {
</a> void
 strdump(void) {
 	int i;
<a href="#h0-36-3" id="h0-36-3" class="i">+	uint c;
</a><a href="#h0-36-4" id="h0-36-4" class="i">+
</a> 	printf(&quot;ESC%c&quot;, strescseq.type);
 	for(i = 0; i &lt; strescseq.len; i++) {
<a href="#h0-36-7" id="h0-36-7" class="d">-		uint c = strescseq.buf[i] &amp; 0xff;
</a><a href="#h0-36-8" id="h0-36-8" class="d">-		if(isprint(c)) putchar(c);
</a><a href="#h0-36-9" id="h0-36-9" class="d">-		else if(c == &#39;\n&#39;) printf(&quot;(\\n)&quot;);
</a><a href="#h0-36-10" id="h0-36-10" class="d">-		else if(c == &#39;\r&#39;) printf(&quot;(\\r)&quot;);
</a><a href="#h0-36-11" id="h0-36-11" class="d">-		else if(c == 0x1b) printf(&quot;(\\e)&quot;);
</a><a href="#h0-36-12" id="h0-36-12" class="d">-		else printf(&quot;(%02x)&quot;, c);
</a><a href="#h0-36-13" id="h0-36-13" class="i">+		c = strescseq.buf[i] &amp; 0xff;
</a><a href="#h0-36-14" id="h0-36-14" class="i">+		if(isprint(c)) {
</a><a href="#h0-36-15" id="h0-36-15" class="i">+			putchar(c);
</a><a href="#h0-36-16" id="h0-36-16" class="i">+		} else if(c == &#39;\n&#39;) {
</a><a href="#h0-36-17" id="h0-36-17" class="i">+			printf(&quot;(\\n)&quot;);
</a><a href="#h0-36-18" id="h0-36-18" class="i">+		} else if(c == &#39;\r&#39;) {
</a><a href="#h0-36-19" id="h0-36-19" class="i">+			printf(&quot;(\\r)&quot;);
</a><a href="#h0-36-20" id="h0-36-20" class="i">+		} else if(c == 0x1b) {
</a><a href="#h0-36-21" id="h0-36-21" class="i">+			printf(&quot;(\\e)&quot;);
</a><a href="#h0-36-22" id="h0-36-22" class="i">+		} else {
</a><a href="#h0-36-23" id="h0-36-23" class="i">+			printf(&quot;(%02x)&quot;, c);
</a><a href="#h0-36-24" id="h0-36-24" class="i">+		}
</a> 	}
 	printf(&quot;ESC\\\n&quot;);
 }
<a href="#h0-37" id="h0-37" class="h">@@ -1746,7 +1817,8 @@ tputc(char *c, int len) {
</a> 	if(term.esc &amp; ESC_START) {
 		if(term.esc &amp; ESC_CSI) {
 			csiescseq.buf[csiescseq.len++] = ascii;
<a href="#h0-37-3" id="h0-37-3" class="d">-			if(BETWEEN(ascii, 0x40, 0x7E) || csiescseq.len &gt;= ESC_BUF_SIZ) {
</a><a href="#h0-37-4" id="h0-37-4" class="i">+			if(BETWEEN(ascii, 0x40, 0x7E)
</a><a href="#h0-37-5" id="h0-37-5" class="i">+					|| csiescseq.len &gt;= ESC_BUF_SIZ) {
</a> 				term.esc = 0;
 				csiparse(), csihandle();
 			}
<a href="#h0-38" id="h0-38" class="h">@@ -1811,10 +1883,11 @@ tputc(char *c, int len) {
</a> 				term.esc = 0;
 				break;
 			case &#39;D&#39;: /* IND -- Linefeed */
<a href="#h0-38-3" id="h0-38-3" class="d">-				if(term.c.y == term.bot)
</a><a href="#h0-38-4" id="h0-38-4" class="i">+				if(term.c.y == term.bot) {
</a> 					tscrollup(term.top, 1);
<a href="#h0-38-6" id="h0-38-6" class="d">-				else
</a><a href="#h0-38-7" id="h0-38-7" class="i">+				} else {
</a> 					tmoveto(term.c.x, term.c.y+1);
<a href="#h0-38-9" id="h0-38-9" class="i">+				}
</a> 				term.esc = 0;
 				break;
 			case &#39;E&#39;: /* NEL -- Next line */
<a href="#h0-39" id="h0-39" class="h">@@ -1826,10 +1899,11 @@ tputc(char *c, int len) {
</a> 				term.esc = 0;
 				break;
 			case &#39;M&#39;: /* RI -- Reverse index */
<a href="#h0-39-3" id="h0-39-3" class="d">-				if(term.c.y == term.top)
</a><a href="#h0-39-4" id="h0-39-4" class="i">+				if(term.c.y == term.top) {
</a> 					tscrolldown(term.top, 1);
<a href="#h0-39-6" id="h0-39-6" class="d">-				else
</a><a href="#h0-39-7" id="h0-39-7" class="i">+				} else {
</a> 					tmoveto(term.c.x, term.c.y-1);
<a href="#h0-39-9" id="h0-39-9" class="i">+				}
</a> 				term.esc = 0;
 				break;
 			case &#39;c&#39;: /* RIS -- Reset to inital state */
<a href="#h0-40" id="h0-40" class="h">@@ -1859,7 +1933,7 @@ tputc(char *c, int len) {
</a> 				break;
 			default:
 				fprintf(stderr, &quot;erresc: unknown sequence ESC 0x%02X &#39;%c&#39;\n&quot;,
<a href="#h0-40-3" id="h0-40-3" class="d">-				    (uchar) ascii, isprint(ascii)?ascii:&#39;.&#39;);
</a><a href="#h0-40-4" id="h0-40-4" class="i">+					(uchar) ascii, isprint(ascii)? ascii:&#39;.&#39;);
</a> 				term.esc = 0;
 			}
 		}
<a href="#h0-41" id="h0-41" class="h">@@ -1870,10 +1944,11 @@ tputc(char *c, int len) {
</a> 			if(IS_SET(MODE_WRAP) &amp;&amp; term.c.state &amp; CURSOR_WRAPNEXT)
 				tnewline(1); /* always go to first col */
 			tsetchar(c);
<a href="#h0-41-3" id="h0-41-3" class="d">-			if(term.c.x+1 &lt; term.col)
</a><a href="#h0-41-4" id="h0-41-4" class="i">+			if(term.c.x+1 &lt; term.col) {
</a> 				tmoveto(term.c.x+1, term.c.y);
<a href="#h0-41-6" id="h0-41-6" class="d">-			else
</a><a href="#h0-41-7" id="h0-41-7" class="i">+			} else {
</a> 				term.c.state |= CURSOR_WRAPNEXT;
<a href="#h0-41-9" id="h0-41-9" class="i">+			}
</a> 		}
 	}
 }
<a href="#h0-42" id="h0-42" class="h">@@ -1884,6 +1959,7 @@ tresize(int col, int row) {
</a> 	int minrow = MIN(row, term.row);
 	int mincol = MIN(col, term.col);
 	int slide = term.c.y - row + 1;
<a href="#h0-42-3" id="h0-42-3" class="i">+	bool *bp;
</a> 
 	if(col &lt; 1 || row &lt; 1)
 		return 0;
<a href="#h0-43" id="h0-43" class="h">@@ -1930,7 +2006,7 @@ tresize(int col, int row) {
</a> 		term.alt [i] = xcalloc(col, sizeof(Glyph));
 	}
 	if(col &gt; term.col) {
<a href="#h0-43-3" id="h0-43-3" class="d">-		bool *bp = term.tabs + term.col;
</a><a href="#h0-43-4" id="h0-43-4" class="i">+		bp = term.tabs + term.col;
</a> 
 		memset(bp, 0, sizeof(*term.tabs) * (col - term.col));
 		while(--bp &gt; term.tabs &amp;&amp; !*bp)
<a href="#h0-44" id="h0-44" class="h">@@ -1987,7 +2063,8 @@ xloadcols(void) {
</a> 
 	for(r = 0; r &lt; 24; r++, i++) {
 		xft_color.red = xft_color.green = xft_color.blue = 0x0808 + 0x0a0a * r;
<a href="#h0-44-3" id="h0-44-3" class="d">-		if(!XftColorAllocValue(xw.dpy, xw.vis, xw.cmap, &amp;xft_color, &amp;dc.xft_col[i])) {
</a><a href="#h0-44-4" id="h0-44-4" class="i">+		if(!XftColorAllocValue(xw.dpy, xw.vis, xw.cmap, &amp;xft_color,
</a><a href="#h0-44-5" id="h0-44-5" class="i">+					&amp;dc.xft_col[i])) {
</a> 			die(&quot;Could not allocate color %d\n&quot;, i);
 		}
 	}
<a href="#h0-45" id="h0-45" class="h">@@ -2263,8 +2340,7 @@ xdraws(char *s, Glyph base, int x, int y, int charlen, int bytelen) {
</a> 
 void
 xdrawcursor(void) {
<a href="#h0-45-3" id="h0-45-3" class="d">-	static int oldx = 0;
</a><a href="#h0-45-4" id="h0-45-4" class="d">-	static int oldy = 0;
</a><a href="#h0-45-5" id="h0-45-5" class="i">+	static int oldx = 0, oldy = 0;
</a> 	int sl;
 	Glyph g = {{&#39; &#39;}, ATTR_NULL, DefaultBG, DefaultCS, 0};
 
<a href="#h0-46" id="h0-46" class="h">@@ -2277,9 +2353,11 @@ xdrawcursor(void) {
</a> 	/* remove the old cursor */
 	if(term.line[oldy][oldx].state &amp; GLYPH_SET) {
 		sl = utf8size(term.line[oldy][oldx].c);
<a href="#h0-46-3" id="h0-46-3" class="d">-		xdraws(term.line[oldy][oldx].c, term.line[oldy][oldx], oldx, oldy, 1, sl);
</a><a href="#h0-46-4" id="h0-46-4" class="d">-	} else
</a><a href="#h0-46-5" id="h0-46-5" class="i">+		xdraws(term.line[oldy][oldx].c, term.line[oldy][oldx], oldx,
</a><a href="#h0-46-6" id="h0-46-6" class="i">+				oldy, 1, sl);
</a><a href="#h0-46-7" id="h0-46-7" class="i">+	} else {
</a> 		xtermclear(oldx, oldy, oldx, oldy);
<a href="#h0-46-9" id="h0-46-9" class="i">+	}
</a> 
 	/* draw the new one */
 	if(!(term.c.state &amp; CURSOR_HIDE)) {
<a href="#h0-47" id="h0-47" class="h">@@ -2334,6 +2412,7 @@ drawregion(int x1, int y1, int x2, int y2) {
</a> 	for(y = y1; y &lt; y2; y++) {
 		if(!term.dirty[y])
 			continue;
<a href="#h0-47-3" id="h0-47-3" class="i">+
</a> 		xtermclear(0, y, term.col, y);
 		term.dirty[y] = 0;
 		base = term.line[y][0];
<a href="#h0-48" id="h0-48" class="h">@@ -2342,8 +2421,9 @@ drawregion(int x1, int y1, int x2, int y2) {
</a> 			new = term.line[y][x];
 			if(ena_sel &amp;&amp; *(new.c) &amp;&amp; selected(x, y))
 				new.mode ^= ATTR_REVERSE;
<a href="#h0-48-3" id="h0-48-3" class="d">-			if(ib &gt; 0 &amp;&amp; (!(new.state &amp; GLYPH_SET) || ATTRCMP(base, new) ||
</a><a href="#h0-48-4" id="h0-48-4" class="d">-						  ib &gt;= DRAW_BUF_SIZ-UTF_SIZ)) {
</a><a href="#h0-48-5" id="h0-48-5" class="i">+			if(ib &gt; 0 &amp;&amp; (!(new.state &amp; GLYPH_SET)
</a><a href="#h0-48-6" id="h0-48-6" class="i">+					|| ATTRCMP(base, new)
</a><a href="#h0-48-7" id="h0-48-7" class="i">+					|| ib &gt;= DRAW_BUF_SIZ-UTF_SIZ)) {
</a> 				xdraws(buf, base, ox, y, ic, ib);
 				ic = ib = 0;
 			}
<a href="#h0-49" id="h0-49" class="h">@@ -2367,6 +2447,7 @@ drawregion(int x1, int y1, int x2, int y2) {
</a> void
 expose(XEvent *ev) {
 	XExposeEvent *e = &amp;ev-&gt;xexpose;
<a href="#h0-49-3" id="h0-49-3" class="i">+
</a> 	if(xw.state &amp; WIN_REDRAW) {
 		if(!e-&gt;count)
 			xw.state &amp;= ~WIN_REDRAW;
<a href="#h0-50" id="h0-50" class="h">@@ -2376,11 +2457,13 @@ expose(XEvent *ev) {
</a> void
 visibility(XEvent *ev) {
 	XVisibilityEvent *e = &amp;ev-&gt;xvisibility;
<a href="#h0-50-3" id="h0-50-3" class="d">-	if(e-&gt;state == VisibilityFullyObscured)
</a><a href="#h0-50-4" id="h0-50-4" class="i">+
</a><a href="#h0-50-5" id="h0-50-5" class="i">+	if(e-&gt;state == VisibilityFullyObscured) {
</a> 		xw.state &amp;= ~WIN_VISIBLE;
<a href="#h0-50-7" id="h0-50-7" class="d">-	else if(!(xw.state &amp; WIN_VISIBLE))
</a><a href="#h0-50-8" id="h0-50-8" class="i">+	} else if(!(xw.state &amp; WIN_VISIBLE)) {
</a> 		/* need a full redraw for next Expose, not just a buf copy */
 		xw.state |= WIN_VISIBLE | WIN_REDRAW;
<a href="#h0-50-11" id="h0-50-11" class="i">+	}
</a> }
 
 void
<a href="#h0-51" id="h0-51" class="h">@@ -2391,6 +2474,7 @@ unmap(XEvent *ev) {
</a> void
 xseturgency(int add) {
 	XWMHints *h = XGetWMHints(xw.dpy, xw.win);
<a href="#h0-51-3" id="h0-51-3" class="i">+
</a> 	h-&gt;flags = add ? (h-&gt;flags | XUrgencyHint) : (h-&gt;flags &amp; ~XUrgencyHint);
 	XSetWMHints(xw.dpy, xw.win, h);
 	XFree(h);
<a href="#h0-52" id="h0-52" class="h">@@ -2401,18 +2485,24 @@ focus(XEvent *ev) {
</a> 	if(ev-&gt;type == FocusIn) {
 		xw.state |= WIN_FOCUSED;
 		xseturgency(0);
<a href="#h0-52-3" id="h0-52-3" class="d">-	} else
</a><a href="#h0-52-4" id="h0-52-4" class="i">+	} else {
</a> 		xw.state &amp;= ~WIN_FOCUSED;
<a href="#h0-52-6" id="h0-52-6" class="i">+	}
</a> }
 
 char*
 kmap(KeySym k, uint state) {
 	int i;
<a href="#h0-52-12" id="h0-52-12" class="i">+	uint mask;
</a><a href="#h0-52-13" id="h0-52-13" class="i">+
</a> 	state &amp;= ~Mod2Mask;
 	for(i = 0; i &lt; LEN(key); i++) {
<a href="#h0-52-16" id="h0-52-16" class="d">-		uint mask = key[i].mask;
</a><a href="#h0-52-17" id="h0-52-17" class="d">-		if(key[i].k == k &amp;&amp; ((state &amp; mask) == mask || (mask == XK_NO_MOD &amp;&amp; !state)))
</a><a href="#h0-52-18" id="h0-52-18" class="i">+		mask = key[i].mask;
</a><a href="#h0-52-19" id="h0-52-19" class="i">+
</a><a href="#h0-52-20" id="h0-52-20" class="i">+		if(key[i].k == k &amp;&amp; ((state &amp; mask) == mask
</a><a href="#h0-52-21" id="h0-52-21" class="i">+				|| (mask == XK_NO_MOD &amp;&amp; !state))) {
</a> 			return (char*)key[i].s;
<a href="#h0-52-23" id="h0-52-23" class="i">+		}
</a> 	}
 	return NULL;
 }
<a href="#h0-53" id="h0-53" class="h">@@ -2430,22 +2520,25 @@ kpress(XEvent *ev) {
</a> 
 	if (IS_SET(MODE_KBDLOCK))
 		return;
<a href="#h0-53-3" id="h0-53-3" class="i">+
</a> 	meta = e-&gt;state &amp; Mod1Mask;
 	shift = e-&gt;state &amp; ShiftMask;
 	len = XmbLookupString(xw.xic, e, buf, sizeof(buf), &amp;ksym, &amp;status);
 
 	/* 1. custom keys from config.h */
<a href="#h0-53-9" id="h0-53-9" class="d">-	if((customkey = kmap(ksym, e-&gt;state)))
</a><a href="#h0-53-10" id="h0-53-10" class="i">+	if((customkey = kmap(ksym, e-&gt;state))) {
</a> 		ttywrite(customkey, strlen(customkey));
 	/* 2. hardcoded (overrides X lookup) */
<a href="#h0-53-13" id="h0-53-13" class="d">-	else
</a><a href="#h0-53-14" id="h0-53-14" class="i">+	} else {
</a> 		switch(ksym) {
 		case XK_Up:
 		case XK_Down:
 		case XK_Left:
 		case XK_Right:
 			/* XXX: shift up/down doesn&#39;t work */
<a href="#h0-53-21" id="h0-53-21" class="d">-			sprintf(buf, &quot;\033%c%c&quot;, IS_SET(MODE_APPKEYPAD) ? &#39;O&#39; : &#39;[&#39;, (shift ? &quot;dacb&quot;:&quot;DACB&quot;)[ksym - XK_Left]);
</a><a href="#h0-53-22" id="h0-53-22" class="i">+			sprintf(buf, &quot;\033%c%c&quot;,
</a><a href="#h0-53-23" id="h0-53-23" class="i">+				IS_SET(MODE_APPKEYPAD) ? &#39;O&#39; : &#39;[&#39;,
</a><a href="#h0-53-24" id="h0-53-24" class="i">+				(shift ? &quot;dacb&quot;:&quot;DACB&quot;)[ksym - XK_Left]);
</a> 			ttywrite(buf, 3);
 			break;
 		case XK_Insert:
<a href="#h0-54" id="h0-54" class="h">@@ -2453,10 +2546,11 @@ kpress(XEvent *ev) {
</a> 				selpaste();
 			break;
 		case XK_Return:
<a href="#h0-54-3" id="h0-54-3" class="d">-			if(IS_SET(MODE_CRLF))
</a><a href="#h0-54-4" id="h0-54-4" class="i">+			if(IS_SET(MODE_CRLF)) {
</a> 				ttywrite(&quot;\r\n&quot;, 2);
<a href="#h0-54-6" id="h0-54-6" class="d">-			else
</a><a href="#h0-54-7" id="h0-54-7" class="i">+			} else {
</a> 				ttywrite(&quot;\r&quot;, 1);
<a href="#h0-54-9" id="h0-54-9" class="i">+			}
</a> 			break;
 			/* 3. X lookup  */
 		default:
<a href="#h0-55" id="h0-55" class="h">@@ -2467,6 +2561,7 @@ kpress(XEvent *ev) {
</a> 			}
 			break;
 		}
<a href="#h0-55-3" id="h0-55-3" class="i">+	}
</a> }
 
 void
<a href="#h0-56" id="h0-56" class="h">@@ -2618,7 +2713,7 @@ main(int argc, char *argv[]) {
</a> 		}
 	}
 
<a href="#h0-56-3" id="h0-56-3" class="d">- run:
</a><a href="#h0-56-4" id="h0-56-4" class="i">+run:
</a> 	setlocale(LC_CTYPE, &quot;&quot;);
 	tnew(80, 24);
 	ttynew();
</pre>
</div>
</body>
</html>
