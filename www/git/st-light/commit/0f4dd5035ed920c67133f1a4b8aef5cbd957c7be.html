<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>bold attribute is back. - st-light - Unnamed repository; edit this file &#39;description&#39; to name the repository.
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st-light Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st-light</h1><span class="desc">Unnamed repository; edit this file &#39;description&#39; to name the repository.
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/0f4dd5035ed920c67133f1a4b8aef5cbd957c7be.html">0f4dd5035ed920c67133f1a4b8aef5cbd957c7be</a>
<b>parent</b> <a href="../commit/7cdaf130b17e4991da9bb3d8d1341e0092474a73.html">7cdaf130b17e4991da9bb3d8d1341e0092474a73</a>
<b>Author:</b> Aur√©lien Aptel &lt;<a href="mailto:aurelien.aptel@gmail.com">aurelien.aptel@gmail.com</a>&gt;
<b>Date:</b>   Thu, 11 Mar 2010 23:50:50 +0100

bold attribute is back.

visibility of the cursor is not saved/loaded anymore.
scrolling up/down is fixed.
added RI and RIS sequences.
fixed cursor drawing bug.
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">config.h</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">st.c</a></td><td> | </td><td class="num">173</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------</span></td></tr>
</table></pre><pre>2 files changed, 126 insertions(+), 50 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config.h.html">config.h</a> b/<a href="../file/config.h.html">config.h</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,7 +1,8 @@
</a> #define SHELL &quot;/bin/bash&quot;
 #define TAB    8
 
<a href="#h0-0-3" id="h0-0-3" class="d">-#define FONT &quot;fixed&quot;
</a><a href="#h0-0-4" id="h0-0-4" class="i">+#define FONT &quot;6x13&quot;
</a><a href="#h0-0-5" id="h0-0-5" class="i">+#define BOLDFONT FONT&quot;bold&quot;
</a> #define BORDER 3
 #define LINESPACE 0 /* additional pixel between each line */
 
<b>diff --git a/<a id="h1" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -57,7 +57,6 @@ typedef Glyph* Line;
</a> 
 typedef struct {
 	Glyph attr;  /* current char attributes */
<a href="#h1-0-3" id="h1-0-3" class="d">-	char hidden;
</a> 	int x;
 	int y;
 } TCursor;
<a href="#h1-1" id="h1-1" class="h">@@ -79,6 +78,7 @@ typedef struct {
</a> 	int col;    /* nb col */
 	Line* line; /* screen */
 	TCursor c;  /* cursor */
<a href="#h1-1-3" id="h1-1-3" class="i">+	char hidec;
</a> 	int top;    /* top    scroll limit */
 	int bot;    /* bottom scroll limit */
 	int mode;   /* terminal mode flags */
<a href="#h1-2" id="h1-2" class="h">@@ -109,6 +109,7 @@ typedef struct {
</a> typedef struct {
 	unsigned long col[LEN(colorname)];
 	XFontStruct* font;
<a href="#h1-2-3" id="h1-2-3" class="i">+	XFontStruct* bfont;
</a> 	GC gc;
 } DC;
 
<a href="#h1-3" id="h1-3" class="h">@@ -135,8 +136,11 @@ static void tnew(int, int);
</a> static void tnewline(void);
 static void tputc(char);
 static void tputs(char*, int);
<a href="#h1-3-3" id="h1-3-3" class="i">+static void treset(void);
</a> static void tresize(int, int);
 static void tscroll(void);
<a href="#h1-3-6" id="h1-3-6" class="i">+static void tscrollup(int);
</a><a href="#h1-3-7" id="h1-3-7" class="i">+static void tscrolldown(int);
</a> static void tsetattr(int*, int);
 static void tsetchar(char);
 static void tsetscroll(int, int);
<a href="#h1-4" id="h1-4" class="h">@@ -149,12 +153,11 @@ static void ttywrite(const char *, size_t);
</a> static unsigned long xgetcol(const char *);
 static void xclear(int, int, int, int);
 static void xcursor(int);
<a href="#h1-4-3" id="h1-4-3" class="d">-static void xdrawc(int, int, Glyph);
</a> static void xinit(void);
 static void xscroll(void);
 
 static void expose(XEvent *);
<a href="#h1-4-8" id="h1-4-8" class="d">-static char * kmap(KeySym);
</a><a href="#h1-4-9" id="h1-4-9" class="i">+static char* kmap(KeySym);
</a> static void kpress(XEvent *);
 static void resize(XEvent *);
 
<a href="#h1-5" id="h1-5" class="h">@@ -313,6 +316,18 @@ tcursor(int mode) {
</a> }
 
 void
<a href="#h1-5-3" id="h1-5-3" class="i">+treset(void) {
</a><a href="#h1-5-4" id="h1-5-4" class="i">+	term.c.attr.mode = ATTR_NULL;
</a><a href="#h1-5-5" id="h1-5-5" class="i">+	term.c.attr.fg = DefaultFG;
</a><a href="#h1-5-6" id="h1-5-6" class="i">+	term.c.attr.bg = DefaultBG;
</a><a href="#h1-5-7" id="h1-5-7" class="i">+	term.c.x = term.c.y = 0;
</a><a href="#h1-5-8" id="h1-5-8" class="i">+	term.hidec = 0;
</a><a href="#h1-5-9" id="h1-5-9" class="i">+	term.top = 0, term.bot = term.row - 1;
</a><a href="#h1-5-10" id="h1-5-10" class="i">+	term.mode = MODE_WRAP;
</a><a href="#h1-5-11" id="h1-5-11" class="i">+	tclearregion(0, 0, term.col-1, term.row-1);
</a><a href="#h1-5-12" id="h1-5-12" class="i">+}
</a><a href="#h1-5-13" id="h1-5-13" class="i">+
</a><a href="#h1-5-14" id="h1-5-14" class="i">+void
</a> tnew(int col, int row) {   /* screen size */
 	term.row = row, term.col = col;
 	term.top = 0, term.bot = term.row - 1;
<a href="#h1-6" id="h1-6" class="h">@@ -323,17 +338,19 @@ tnew(int col, int row) {   /* screen size */
</a> 	term.c.attr.fg = DefaultFG;
 	term.c.attr.bg = DefaultBG;
 	term.c.x = term.c.y = 0;
<a href="#h1-6-3" id="h1-6-3" class="d">-	term.c.hidden = 0;
</a><a href="#h1-6-4" id="h1-6-4" class="i">+	term.hidec = 0;
</a> 	/* allocate screen */
 	term.line = calloc(term.row, sizeof(Line));
 	for(row = 0 ; row &lt; term.row; row++)
 		term.line[row] = calloc(term.col, sizeof(Glyph));
 }
 
<a href="#h1-6-11" id="h1-6-11" class="i">+/* TODO: Replace with scrollup/scolldown */
</a> void
 tscroll(void) {
 	Line temp = term.line[term.top];
 	int i;
<a href="#h1-6-16" id="h1-6-16" class="i">+	/* No dirty flag to set because of xscroll */
</a> 	/* X stuff _before_ the line swapping (results in wrong line index) */
 	xscroll();
 	for(i = term.top; i &lt; term.bot; i++)
<a href="#h1-7" id="h1-7" class="h">@@ -343,6 +360,41 @@ tscroll(void) {
</a> }
 
 void
<a href="#h1-7-3" id="h1-7-3" class="i">+tscrolldown (int n) {
</a><a href="#h1-7-4" id="h1-7-4" class="i">+	int i;
</a><a href="#h1-7-5" id="h1-7-5" class="i">+	Line temp;
</a><a href="#h1-7-6" id="h1-7-6" class="i">+	
</a><a href="#h1-7-7" id="h1-7-7" class="i">+	/* TODO: set dirty flag or scroll with some X func */
</a><a href="#h1-7-8" id="h1-7-8" class="i">+	LIMIT(n, 0, term.bot-term.top+1);
</a><a href="#h1-7-9" id="h1-7-9" class="i">+
</a><a href="#h1-7-10" id="h1-7-10" class="i">+	for(i = 0; i &lt; n; i++)
</a><a href="#h1-7-11" id="h1-7-11" class="i">+		memset(term.line[term.bot-i], 0, term.col*sizeof(Glyph));
</a><a href="#h1-7-12" id="h1-7-12" class="i">+   	
</a><a href="#h1-7-13" id="h1-7-13" class="i">+	for(i = term.bot; i &gt;= term.top+n; i--) {
</a><a href="#h1-7-14" id="h1-7-14" class="i">+		temp = term.line[i];
</a><a href="#h1-7-15" id="h1-7-15" class="i">+		term.line[i] = term.line[i-n];
</a><a href="#h1-7-16" id="h1-7-16" class="i">+		term.line[i-n] = temp;
</a><a href="#h1-7-17" id="h1-7-17" class="i">+	}
</a><a href="#h1-7-18" id="h1-7-18" class="i">+}
</a><a href="#h1-7-19" id="h1-7-19" class="i">+
</a><a href="#h1-7-20" id="h1-7-20" class="i">+void
</a><a href="#h1-7-21" id="h1-7-21" class="i">+tscrollup (int n) {
</a><a href="#h1-7-22" id="h1-7-22" class="i">+	int i;
</a><a href="#h1-7-23" id="h1-7-23" class="i">+	Line temp;
</a><a href="#h1-7-24" id="h1-7-24" class="i">+	LIMIT(n, 0, term.bot-term.top+1);
</a><a href="#h1-7-25" id="h1-7-25" class="i">+	
</a><a href="#h1-7-26" id="h1-7-26" class="i">+	/* TODO: set dirty flag or scroll with some X func */
</a><a href="#h1-7-27" id="h1-7-27" class="i">+	for(i = 0; i &lt; n; i++)
</a><a href="#h1-7-28" id="h1-7-28" class="i">+		memset(term.line[term.top+i], 0, term.col*sizeof(Glyph));
</a><a href="#h1-7-29" id="h1-7-29" class="i">+	
</a><a href="#h1-7-30" id="h1-7-30" class="i">+	 for(i = term.top; i &lt;= term.bot-n; i++) { 
</a><a href="#h1-7-31" id="h1-7-31" class="i">+		 temp = term.line[i];
</a><a href="#h1-7-32" id="h1-7-32" class="i">+		 term.line[i] = term.line[i+n]; 
</a><a href="#h1-7-33" id="h1-7-33" class="i">+		 term.line[i+n] = temp;
</a><a href="#h1-7-34" id="h1-7-34" class="i">+	 }
</a><a href="#h1-7-35" id="h1-7-35" class="i">+}
</a><a href="#h1-7-36" id="h1-7-36" class="i">+
</a><a href="#h1-7-37" id="h1-7-37" class="i">+void
</a> tnewline(void) {
 	int y = term.c.y + 1;
 	if(y &gt; term.bot)
<a href="#h1-8" id="h1-8" class="h">@@ -420,17 +472,20 @@ tsetchar(char c) {
</a> 
 void
 tclearregion(int x1, int y1, int x2, int y2) {
<a href="#h1-8-3" id="h1-8-3" class="d">-	int x, y;
</a><a href="#h1-8-4" id="h1-8-4" class="i">+	int y, temp;
</a><a href="#h1-8-5" id="h1-8-5" class="i">+
</a><a href="#h1-8-6" id="h1-8-6" class="i">+	if(x1 &gt; x2)
</a><a href="#h1-8-7" id="h1-8-7" class="i">+		temp = x1, x1 = x2, x2 = temp;
</a><a href="#h1-8-8" id="h1-8-8" class="i">+	if(y1 &gt; y2)
</a><a href="#h1-8-9" id="h1-8-9" class="i">+		temp = y1, y1 = y2, y2 = temp;
</a> 
 	LIMIT(x1, 0, term.col-1);
 	LIMIT(x2, 0, term.col-1);
 	LIMIT(y1, 0, term.row-1);
 	LIMIT(y2, 0, term.row-1);
 
<a href="#h1-8-16" id="h1-8-16" class="d">-	/* XXX: could be optimized */
</a><a href="#h1-8-17" id="h1-8-17" class="d">-	for(x = x1; x &lt;= x2; x++)
</a><a href="#h1-8-18" id="h1-8-18" class="d">-		for(y = y1; y &lt;= y2; y++)
</a><a href="#h1-8-19" id="h1-8-19" class="d">-			memset(&amp;term.line[y][x], 0, sizeof(Glyph));
</a><a href="#h1-8-20" id="h1-8-20" class="i">+	for(y = y1; y &lt;= y2; y++)
</a><a href="#h1-8-21" id="h1-8-21" class="i">+		memset(&amp;term.line[y][x1], 0, sizeof(Glyph)*(x2-x1+1));
</a> 
 	xclear(x1, y1, x2, y2);
 }
<a href="#h1-9" id="h1-9" class="h">@@ -542,9 +597,6 @@ tsetattr(int *attr, int l) {
</a> 		case 7: 
 			term.c.attr.mode |= ATTR_REVERSE;	
 			break;
<a href="#h1-9-3" id="h1-9-3" class="d">-		case 8:
</a><a href="#h1-9-4" id="h1-9-4" class="d">-			term.c.hidden = CURSOR_HIDE;
</a><a href="#h1-9-5" id="h1-9-5" class="d">-			break;
</a> 		case 22: 
 			term.c.attr.mode &amp;= ~ATTR_BOLD;  
 			break;
<a href="#h1-10" id="h1-10" class="h">@@ -565,6 +617,8 @@ tsetattr(int *attr, int l) {
</a> 				term.c.attr.fg = attr[i] - 30;
 			else if(BETWEEN(attr[i], 40, 47))
 				term.c.attr.bg = attr[i] - 40;
<a href="#h1-10-3" id="h1-10-3" class="i">+			else 
</a><a href="#h1-10-4" id="h1-10-4" class="i">+				fprintf(stderr, &quot;erresc: gfx attr %d unkown\n&quot;, attr[i]); 
</a> 			break;
 		}
 	}
<a href="#h1-11" id="h1-11" class="h">@@ -590,7 +644,7 @@ csihandle(void) {
</a> 	switch(escseq.mode) {
 	default:
 	unknown:
<a href="#h1-11-3" id="h1-11-3" class="d">-		printf(&quot;erresc: unknown sequence -- &quot;);
</a><a href="#h1-11-4" id="h1-11-4" class="i">+		printf(&quot;erresc: unknown csi &quot;);
</a> 		csidump();
 		/* die(&quot;&quot;); */
 		break;
<a href="#h1-12" id="h1-12" class="h">@@ -665,7 +719,14 @@ csihandle(void) {
</a> 			break;
 		}
 		break;
<a href="#h1-12-3" id="h1-12-3" class="d">-	case &#39;S&#39;: /* XXX: SU -- Scroll &lt;n&gt; line up (faked) */ 
</a><a href="#h1-12-4" id="h1-12-4" class="i">+	case &#39;S&#39;: /* SU -- Scroll &lt;n&gt; line up */
</a><a href="#h1-12-5" id="h1-12-5" class="i">+		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-12-6" id="h1-12-6" class="i">+		tscrollup(escseq.arg[0]);
</a><a href="#h1-12-7" id="h1-12-7" class="i">+		break;
</a><a href="#h1-12-8" id="h1-12-8" class="i">+	case &#39;T&#39;: /* SD -- Scroll &lt;n&gt; line down */
</a><a href="#h1-12-9" id="h1-12-9" class="i">+		DEFAULT(escseq.arg[0], 1);
</a><a href="#h1-12-10" id="h1-12-10" class="i">+		tscrolldown(escseq.arg[0]);
</a><a href="#h1-12-11" id="h1-12-11" class="i">+		break;
</a> 	case &#39;L&#39;: /* IL -- Insert &lt;n&gt; blank lines */
 		DEFAULT(escseq.arg[0], 1);
 		tinsertblankline(escseq.arg[0]);
<a href="#h1-13" id="h1-13" class="h">@@ -682,7 +743,7 @@ csihandle(void) {
</a> 			case 12: /* att610 -- Stop blinking cursor (IGNORED) */
 				break;
 			case 25:
<a href="#h1-13-3" id="h1-13-3" class="d">-				term.c.hidden = 1;
</a><a href="#h1-13-4" id="h1-13-4" class="i">+				term.hidec = 1;
</a> 				break;
 			case 1048: /* XXX: no alt. screen to erase/save */
 			case 1049:
<a href="#h1-14" id="h1-14" class="h">@@ -731,7 +792,7 @@ csihandle(void) {
</a> 			case 12: /* att610 -- Start blinking cursor (IGNORED) */
 				break;
 			case 25:
<a href="#h1-14-3" id="h1-14-3" class="d">-				term.c.hidden = 0;
</a><a href="#h1-14-4" id="h1-14-4" class="i">+				term.hidec = 0;
</a> 				break;
 			case 1048: 
 			case 1049: /* XXX: no alt. screen to erase/save */
<a href="#h1-15" id="h1-15" class="h">@@ -866,11 +927,15 @@ tputc(char c) {
</a> 				break;
 			case &#39;M&#39;: /* RI -- Reverse index */
 				if(term.c.y == term.top)
<a href="#h1-15-3" id="h1-15-3" class="d">-					tinsertblankline(1);
</a><a href="#h1-15-4" id="h1-15-4" class="i">+					tscrolldown(1);
</a> 				else
 					tmoveto(term.c.x, term.c.y-1);
 				term.esc = 0;
 				break;
<a href="#h1-15-9" id="h1-15-9" class="i">+			case &#39;c&#39;: /* RIS -- Reset to inital state */
</a><a href="#h1-15-10" id="h1-15-10" class="i">+				treset();
</a><a href="#h1-15-11" id="h1-15-11" class="i">+				term.esc = 0;
</a><a href="#h1-15-12" id="h1-15-12" class="i">+				break;
</a> 			case &#39;=&#39;: /* DECPAM */
 				term.mode |= MODE_APPKEYPAD;
 				term.esc = 0;
<a href="#h1-16" id="h1-16" class="h">@@ -888,7 +953,7 @@ tputc(char c) {
</a> 				term.esc = 0;
 				break;
 			default:
<a href="#h1-16-3" id="h1-16-3" class="d">-				fprintf(stderr, &quot;erresc: unknown sequence ESC %02X &#39;%c&#39;\n&quot;, c, isprint(c)?c:&#39;.&#39;);
</a><a href="#h1-16-4" id="h1-16-4" class="i">+				fprintf(stderr, &quot;erresc: unknown sequence ESC 0x%02X &#39;%c&#39;\n&quot;, c, isprint(c)?c:&#39;.&#39;);
</a> 				term.esc = 0;
 			}
 		}
<a href="#h1-17" id="h1-17" class="h">@@ -991,8 +1056,6 @@ xscroll(void) {
</a> 
 void
 xinit(void) {
<a href="#h1-17-3" id="h1-17-3" class="d">-	XGCValues values;
</a><a href="#h1-17-4" id="h1-17-4" class="d">-	unsigned long valuemask;
</a> 	XClassHint chint;
 	XWMHints wmhint;
 	XSizeHints shint;
<a href="#h1-18" id="h1-18" class="h">@@ -1005,9 +1068,10 @@ xinit(void) {
</a> 		die(&quot;Can&#39;t open display\n&quot;);
 	
 	/* font */
<a href="#h1-18-3" id="h1-18-3" class="d">-	if(!(dc.font = XLoadQueryFont(xw.dis, FONT)))
</a><a href="#h1-18-4" id="h1-18-4" class="d">-		die(&quot;Can&#39;t load font %s\n&quot;, FONT);
</a><a href="#h1-18-5" id="h1-18-5" class="i">+	if(!(dc.font = XLoadQueryFont(xw.dis, FONT)) || !(dc.bfont = XLoadQueryFont(xw.dis, BOLDFONT)))
</a><a href="#h1-18-6" id="h1-18-6" class="i">+		die(&quot;Can&#39;t load font %s\n&quot;, dc.font ? BOLDFONT : FONT);
</a> 
<a href="#h1-18-8" id="h1-18-8" class="i">+	/* XXX: Assuming same size for bold font */
</a> 	xw.cw = dc.font-&gt;max_bounds.rbearing - dc.font-&gt;min_bounds.lbearing;
 	xw.ch = dc.font-&gt;ascent + dc.font-&gt;descent + LINESPACE;
 
<a href="#h1-19" id="h1-19" class="h">@@ -1027,10 +1091,7 @@ xinit(void) {
</a> 			dc.col[DefaultBG],
 			dc.col[DefaultBG]);
 	/* gc */
<a href="#h1-19-3" id="h1-19-3" class="d">-	values.foreground = XWhitePixel(xw.dis, xw.scr);
</a><a href="#h1-19-4" id="h1-19-4" class="d">-	values.font = dc.font-&gt;fid;
</a><a href="#h1-19-5" id="h1-19-5" class="d">-	valuemask = GCForeground | GCFont;
</a><a href="#h1-19-6" id="h1-19-6" class="d">-	dc.gc = XCreateGC(xw.dis, xw.win, valuemask, &amp;values);
</a><a href="#h1-19-7" id="h1-19-7" class="i">+	dc.gc = XCreateGC(xw.dis, xw.win, 0, NULL);
</a> 	XMapWindow(xw.dis, xw.win);
 	/* wm stuff */
 	chint.res_name = TNAME, chint.res_class = TNAME;
<a href="#h1-20" id="h1-20" class="h">@@ -1060,7 +1121,8 @@ xdraws(char *s, Glyph base, int x, int y, int len) {
</a> 	if(base.mode &amp; ATTR_GFX)
 		for(i = 0; i &lt; len; i++)
 			s[i] = gfx[s[i]];
<a href="#h1-20-3" id="h1-20-3" class="d">-	
</a><a href="#h1-20-4" id="h1-20-4" class="i">+
</a><a href="#h1-20-5" id="h1-20-5" class="i">+	XSetFont(xw.dis, dc.gc, base.mode &amp; ATTR_BOLD ? dc.bfont-&gt;fid : dc.font-&gt;fid);	
</a> 	XDrawImageString(xw.dis, xw.win, dc.gc, winx, winy, s, len);
 	
 	if(base.mode &amp; ATTR_UNDERLINE)
<a href="#h1-21" id="h1-21" class="h">@@ -1068,22 +1130,6 @@ xdraws(char *s, Glyph base, int x, int y, int len) {
</a> }
 
 void
<a href="#h1-21-3" id="h1-21-3" class="d">-xdrawc(int x, int y, Glyph g) {
</a><a href="#h1-21-4" id="h1-21-4" class="d">-	XRectangle r = { x * xw.cw, y * xw.ch, xw.cw, xw.ch };
</a><a href="#h1-21-5" id="h1-21-5" class="d">-	unsigned long xfg, xbg;
</a><a href="#h1-21-6" id="h1-21-6" class="d">-
</a><a href="#h1-21-7" id="h1-21-7" class="d">-	/* reverse video */
</a><a href="#h1-21-8" id="h1-21-8" class="d">-	if(g.mode &amp; ATTR_REVERSE)
</a><a href="#h1-21-9" id="h1-21-9" class="d">-		xfg = dc.col[g.bg], xbg = dc.col[g.fg];
</a><a href="#h1-21-10" id="h1-21-10" class="d">-	else
</a><a href="#h1-21-11" id="h1-21-11" class="d">-		xfg = dc.col[g.fg], xbg = dc.col[g.bg];
</a><a href="#h1-21-12" id="h1-21-12" class="d">-	/* background */
</a><a href="#h1-21-13" id="h1-21-13" class="d">-	XSetBackground(xw.dis, dc.gc, xbg);
</a><a href="#h1-21-14" id="h1-21-14" class="d">-	XSetForeground(xw.dis, dc.gc, xfg);
</a><a href="#h1-21-15" id="h1-21-15" class="d">-	XDrawImageString(xw.dis, xw.win, dc.gc, r.x, r.y+dc.font-&gt;ascent, &amp;g.c, 1);
</a><a href="#h1-21-16" id="h1-21-16" class="d">-}
</a><a href="#h1-21-17" id="h1-21-17" class="d">-
</a><a href="#h1-21-18" id="h1-21-18" class="d">-void
</a> xcursor(int mode) {
 	static int oldx = 0;
 	static int oldy = 0;
<a href="#h1-22" id="h1-22" class="h">@@ -1094,24 +1140,54 @@ xcursor(int mode) {
</a> 	
 	if(term.line[term.c.y][term.c.x].state &amp; GLYPH_SET)
 		g.c = term.line[term.c.y][term.c.x].c;
<a href="#h1-22-3" id="h1-22-3" class="i">+
</a> 	/* remove the old cursor */
 	if(term.line[oldy][oldx].state &amp; GLYPH_SET)
<a href="#h1-22-6" id="h1-22-6" class="d">-		xdrawc(oldx, oldy, term.line[oldy][oldx]);
</a><a href="#h1-22-7" id="h1-22-7" class="d">-	else 
</a><a href="#h1-22-8" id="h1-22-8" class="i">+		xdraws(&amp;term.line[oldy][oldx].c, term.line[oldy][oldx], oldx, oldy, 1);
</a><a href="#h1-22-9" id="h1-22-9" class="i">+	else
</a> 		xclear(oldx, oldy, oldx, oldy);
<a href="#h1-22-11" id="h1-22-11" class="i">+	
</a> 	/* draw the new one */
 	if(mode == CURSOR_DRAW) {
<a href="#h1-22-14" id="h1-22-14" class="d">-		xdrawc(term.c.x, term.c.y, g);
</a><a href="#h1-22-15" id="h1-22-15" class="i">+		xdraws(&amp;g.c, g, term.c.x, term.c.y, 1);
</a> 		oldx = term.c.x, oldy = term.c.y;
 	}
 }
 
<a href="#h1-22-20" id="h1-22-20" class="i">+
</a><a href="#h1-22-21" id="h1-22-21" class="i">+#ifdef DEBUG
</a><a href="#h1-22-22" id="h1-22-22" class="i">+/* basic drawing routines */
</a><a href="#h1-22-23" id="h1-22-23" class="i">+void
</a><a href="#h1-22-24" id="h1-22-24" class="i">+xdrawc(int x, int y, Glyph g) {
</a><a href="#h1-22-25" id="h1-22-25" class="i">+	XRectangle r = { x * xw.cw, y * xw.ch, xw.cw, xw.ch };
</a><a href="#h1-22-26" id="h1-22-26" class="i">+	XSetBackground(xw.dis, dc.gc, dc.col[g.bg]);
</a><a href="#h1-22-27" id="h1-22-27" class="i">+	XSetForeground(xw.dis, dc.gc, dc.col[g.fg]);
</a><a href="#h1-22-28" id="h1-22-28" class="i">+	XSetFont(xw.dis, dc.gc, g.mode &amp; ATTR_BOLD ? dc.bfont-&gt;fid : dc.font-&gt;fid);
</a><a href="#h1-22-29" id="h1-22-29" class="i">+	XDrawImageString(xw.dis, xw.win, dc.gc, r.x, r.y+dc.font-&gt;ascent, &amp;g.c, 1);
</a><a href="#h1-22-30" id="h1-22-30" class="i">+}
</a><a href="#h1-22-31" id="h1-22-31" class="i">+
</a><a href="#h1-22-32" id="h1-22-32" class="i">+void
</a><a href="#h1-22-33" id="h1-22-33" class="i">+draw_(int dummy) {
</a><a href="#h1-22-34" id="h1-22-34" class="i">+	int x, y;
</a><a href="#h1-22-35" id="h1-22-35" class="i">+
</a><a href="#h1-22-36" id="h1-22-36" class="i">+	xclear(0, 0, term.col-1, term.row-1);
</a><a href="#h1-22-37" id="h1-22-37" class="i">+	for(y = 0; y &lt; term.row; y++)
</a><a href="#h1-22-38" id="h1-22-38" class="i">+		for(x = 0; x &lt; term.col; x++)
</a><a href="#h1-22-39" id="h1-22-39" class="i">+			if(term.line[y][x].state &amp; GLYPH_SET)
</a><a href="#h1-22-40" id="h1-22-40" class="i">+				xdrawc(x, y, term.line[y][x]);
</a><a href="#h1-22-41" id="h1-22-41" class="i">+
</a><a href="#h1-22-42" id="h1-22-42" class="i">+	if(!term.hidec)
</a><a href="#h1-22-43" id="h1-22-43" class="i">+		xcursor(CURSOR_DRAW);
</a><a href="#h1-22-44" id="h1-22-44" class="i">+}
</a><a href="#h1-22-45" id="h1-22-45" class="i">+#endif
</a><a href="#h1-22-46" id="h1-22-46" class="i">+
</a> void
 draw(int redraw_all) {
 	int i, x, y, ox;
 	Glyph base, new;
 	char buf[DRAW_BUF_SIZ];
 	
<a href="#h1-22-53" id="h1-22-53" class="i">+	/* XXX: optimize with GLYPH_DIRTY hint */
</a> 	for(y = 0; y &lt; term.row; y++) {
 		base = term.line[y][0];
 		i = ox = 0;
<a href="#h1-23" id="h1-23" class="h">@@ -1129,8 +1205,7 @@ draw(int redraw_all) {
</a> 		}
 		xdraws(buf, base, ox, y, i);
 	}
<a href="#h1-23-3" id="h1-23-3" class="d">-	if(!term.c.hidden)
</a><a href="#h1-23-4" id="h1-23-4" class="d">-		xcursor(CURSOR_DRAW);
</a><a href="#h1-23-5" id="h1-23-5" class="i">+	xcursor(term.hidec ? CURSOR_HIDE : CURSOR_DRAW);
</a> }
 
 void
<a href="#h1-24" id="h1-24" class="h">@@ -1179,7 +1254,7 @@ kpress(XEvent *ev) {
</a> 			break;
 		case XK_Insert:
 			if(shift)
<a href="#h1-24-3" id="h1-24-3" class="d">-				/* XXX: paste X clipboard */;
</a><a href="#h1-24-4" id="h1-24-4" class="i">+				draw(1), puts(&quot;draw!&quot;)/* XXX: paste X clipboard */;
</a> 			break;
 		default:
 			fprintf(stderr, &quot;errkey: %d\n&quot;, (int)ksym);
</pre>
</div>
</body>
</html>
