<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Add key for toogling numlock handling - st-light - Unnamed repository; edit this file &#39;description&#39; to name the repository.
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="st-light Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>st-light</h1><span class="desc">Unnamed repository; edit this file &#39;description&#39; to name the repository.
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/172f65436ce14a52842d67b862fdc45f8ff3ada3.html">172f65436ce14a52842d67b862fdc45f8ff3ada3</a>
<b>parent</b> <a href="../commit/b26df1d0d3f7791504150820e7c105b20c6b1c3b.html">b26df1d0d3f7791504150820e7c105b20c6b1c3b</a>
<b>Author:</b> Roberto E. Vargas Caballero &lt;<a href="mailto:k0ga@shike2.com">k0ga@shike2.com</a>&gt;
<b>Date:</b>   Sun, 25 Nov 2012 09:23:02 +0100

Add key for toogling numlock handling

Keypad will generate keycodes when keypad application mode is enabled. It
can cause problems with some programs like vi, which operates in such
mode.

This patch change by default don&#39;t generate the keycodes never, but this
behaviour can be changed using the combination Alt + NumLock.
---
 config.def.h |   34 ++++++++++++++++++----------------
 st.c         |   17 +++++++++++++++--
 2 files changed, 33 insertions(+), 18 deletions(-)
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">config.def.h</a></td><td> | </td><td class="num">34</td><td><span class="i">++++++++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">st.c</a></td><td> | </td><td class="num">17</td><td><span class="i">+++++++++++++++</span><span class="d">--</span></td></tr>
</table></pre><pre>2 files changed, 33 insertions(+), 18 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config.def.h.html">config.def.h</a> b/<a href="../file/config.def.h.html">config.def.h</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -62,6 +62,7 @@ static Shortcut shortcuts[] = {
</a> 	{ MODKEY|ShiftMask,	XK_Prior,	xzoom,		{.i = +1} },
 	{ MODKEY|ShiftMask,	XK_Next,	xzoom,		{.i = -1} },
 	{ ShiftMask,		XK_Insert,	selpaste,	{.i =  0} },
<a href="#h0-0-3" id="h0-0-3" class="i">+	{ MODKEY,		XK_Num_Lock,	numlock,	{.i =  0} },
</a> };
 
 /*
<a href="#h0-1" id="h0-1" class="h">@@ -73,6 +74,7 @@ static Shortcut shortcuts[] = {
</a>  * keypad value:
  * * 0: no value
  * * &gt; 0: keypad application mode enabled
<a href="#h0-1-3" id="h0-1-3" class="i">+ * *   = 2: term.numlock = 1
</a>  * * &lt; 0: keypad application mode disabled
  * cursor value:
  * * 0: no value
<a href="#h0-2" id="h0-2" class="h">@@ -123,24 +125,24 @@ static Key key[] = {
</a> 	{ XK_KP_Insert,     XK_ANY_MOD,     &quot;\033[2~&quot;,       0,    0,    0},
 	{ XK_KP_Delete,     ShiftMask,      &quot;\033[3;2~&quot;,     0,    0,    0},
 	{ XK_KP_Delete,     XK_ANY_MOD,     &quot;\033[3~&quot;,       0,    0,    0},
<a href="#h0-2-3" id="h0-2-3" class="d">-	{ XK_KP_Multiply,   XK_ANY_MOD,     &quot;\033Oj&quot;,       +1,    0,    0},
</a><a href="#h0-2-4" id="h0-2-4" class="d">-	{ XK_KP_Add,        XK_ANY_MOD,     &quot;\033Ok&quot;,       +1,    0,    0},
</a><a href="#h0-2-5" id="h0-2-5" class="d">-	{ XK_KP_Enter,      XK_ANY_MOD,     &quot;\033OM&quot;,       +1,    0,    0},
</a><a href="#h0-2-6" id="h0-2-6" class="i">+	{ XK_KP_Multiply,   XK_ANY_MOD,     &quot;\033Oj&quot;,       +2,    0,    0},
</a><a href="#h0-2-7" id="h0-2-7" class="i">+	{ XK_KP_Add,        XK_ANY_MOD,     &quot;\033Ok&quot;,       +2,    0,    0},
</a><a href="#h0-2-8" id="h0-2-8" class="i">+	{ XK_KP_Enter,      XK_ANY_MOD,     &quot;\033OM&quot;,       +2,    0,    0},
</a> 	{ XK_KP_Enter,      XK_ANY_MOD,     &quot;\r&quot;,           -1,    0,   -1},
 	{ XK_KP_Enter,      XK_ANY_MOD,     &quot;\r\n&quot;,         -1,    0,   +1},
<a href="#h0-2-11" id="h0-2-11" class="d">-	{ XK_KP_Subtract,   XK_ANY_MOD,     &quot;\033Om&quot;,       +1,    0,    0},
</a><a href="#h0-2-12" id="h0-2-12" class="d">-	{ XK_KP_Decimal,    XK_ANY_MOD,     &quot;\033On&quot;,       +1,    0,    0},
</a><a href="#h0-2-13" id="h0-2-13" class="d">-	{ XK_KP_Divide,     XK_ANY_MOD,     &quot;\033Oo&quot;,       +1,    0,    0},
</a><a href="#h0-2-14" id="h0-2-14" class="d">-	{ XK_KP_0,          XK_ANY_MOD,     &quot;\033Op&quot;,       +1,    0,    0},
</a><a href="#h0-2-15" id="h0-2-15" class="d">-	{ XK_KP_1,          XK_ANY_MOD,     &quot;\033Oq&quot;,       +1,    0,    0},
</a><a href="#h0-2-16" id="h0-2-16" class="d">-	{ XK_KP_2,          XK_ANY_MOD,     &quot;\033Or&quot;,       +1,    0,    0},
</a><a href="#h0-2-17" id="h0-2-17" class="d">-	{ XK_KP_3,          XK_ANY_MOD,     &quot;\033Os&quot;,       +1,    0,    0},
</a><a href="#h0-2-18" id="h0-2-18" class="d">-	{ XK_KP_4,          XK_ANY_MOD,     &quot;\033Ot&quot;,       +1,    0,    0},
</a><a href="#h0-2-19" id="h0-2-19" class="d">-	{ XK_KP_5,          XK_ANY_MOD,     &quot;\033Ou&quot;,       +1,    0,    0},
</a><a href="#h0-2-20" id="h0-2-20" class="d">-	{ XK_KP_6,          XK_ANY_MOD,     &quot;\033Ov&quot;,       +1,    0,    0},
</a><a href="#h0-2-21" id="h0-2-21" class="d">-	{ XK_KP_7,          XK_ANY_MOD,     &quot;\033Ow&quot;,       +1,    0,    0},
</a><a href="#h0-2-22" id="h0-2-22" class="d">-	{ XK_KP_8,          XK_ANY_MOD,     &quot;\033Ox&quot;,       +1,    0,    0},
</a><a href="#h0-2-23" id="h0-2-23" class="d">-	{ XK_KP_9,          XK_ANY_MOD,     &quot;\033Oy&quot;,       +1,    0,    0},
</a><a href="#h0-2-24" id="h0-2-24" class="i">+	{ XK_KP_Subtract,   XK_ANY_MOD,     &quot;\033Om&quot;,       +2,    0,    0},
</a><a href="#h0-2-25" id="h0-2-25" class="i">+	{ XK_KP_Decimal,    XK_ANY_MOD,     &quot;\033On&quot;,       +2,    0,    0},
</a><a href="#h0-2-26" id="h0-2-26" class="i">+	{ XK_KP_Divide,     XK_ANY_MOD,     &quot;\033Oo&quot;,       +2,    0,    0},
</a><a href="#h0-2-27" id="h0-2-27" class="i">+	{ XK_KP_0,          XK_ANY_MOD,     &quot;\033Op&quot;,       +2,    0,    0},
</a><a href="#h0-2-28" id="h0-2-28" class="i">+	{ XK_KP_1,          XK_ANY_MOD,     &quot;\033Oq&quot;,       +2,    0,    0},
</a><a href="#h0-2-29" id="h0-2-29" class="i">+	{ XK_KP_2,          XK_ANY_MOD,     &quot;\033Or&quot;,       +2,    0,    0},
</a><a href="#h0-2-30" id="h0-2-30" class="i">+	{ XK_KP_3,          XK_ANY_MOD,     &quot;\033Os&quot;,       +2,    0,    0},
</a><a href="#h0-2-31" id="h0-2-31" class="i">+	{ XK_KP_4,          XK_ANY_MOD,     &quot;\033Ot&quot;,       +2,    0,    0},
</a><a href="#h0-2-32" id="h0-2-32" class="i">+	{ XK_KP_5,          XK_ANY_MOD,     &quot;\033Ou&quot;,       +2,    0,    0},
</a><a href="#h0-2-33" id="h0-2-33" class="i">+	{ XK_KP_6,          XK_ANY_MOD,     &quot;\033Ov&quot;,       +2,    0,    0},
</a><a href="#h0-2-34" id="h0-2-34" class="i">+	{ XK_KP_7,          XK_ANY_MOD,     &quot;\033Ow&quot;,       +2,    0,    0},
</a><a href="#h0-2-35" id="h0-2-35" class="i">+	{ XK_KP_8,          XK_ANY_MOD,     &quot;\033Ox&quot;,       +2,    0,    0},
</a><a href="#h0-2-36" id="h0-2-36" class="i">+	{ XK_KP_9,          XK_ANY_MOD,     &quot;\033Oy&quot;,       +2,    0,    0},
</a> 	{ XK_BackSpace,     XK_NO_MOD,      &quot;\177&quot;,          0,    0,    0},
 	{ XK_Up,            ShiftMask,      &quot;\033[1;2A&quot;,     0,    0,    0},
 	{ XK_Up,            ControlMask,    &quot;\033[1;5A&quot;,     0,    0,    0},
<b>diff --git a/<a id="h1" href="../file/st.c.html">st.c</a> b/<a href="../file/st.c.html">st.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -194,6 +194,7 @@ typedef struct {
</a> 	int bot;	/* bottom scroll limit */
 	int mode;	/* terminal mode flags */
 	int esc;	/* escape state flags */
<a href="#h1-0-3" id="h1-0-3" class="i">+	bool numlock;	/* lock numbers in keyboard */
</a> 	bool *tabs;
 } Term;
 
<a href="#h1-1" id="h1-1" class="h">@@ -261,6 +262,7 @@ typedef struct {
</a> /* function definitions used in config.h */
 static void xzoom(const Arg *);
 static void selpaste(const Arg *);
<a href="#h1-1-3" id="h1-1-3" class="i">+static void numlock(const Arg *);
</a> 
 /* Config.h for applying patches and the configuration. */
 #include &quot;config.h&quot;
<a href="#h1-2" id="h1-2" class="h">@@ -1100,6 +1102,7 @@ tnew(int col, int row) {
</a> 		term.alt [row] = xmalloc(term.col * sizeof(Glyph));
 		term.dirty[row] = 0;
 	}
<a href="#h1-2-3" id="h1-2-3" class="i">+	term.numlock = 1;
</a> 	memset(term.tabs, 0, term.col * sizeof(*term.tabs));
 	/* setup screen */
 	treset();
<a href="#h1-3" id="h1-3" class="h">@@ -2700,6 +2703,12 @@ match(uint mask, uint state) {
</a> 	return true;
 }
 
<a href="#h1-3-3" id="h1-3-3" class="i">+void
</a><a href="#h1-3-4" id="h1-3-4" class="i">+numlock(const Arg *dummy)
</a><a href="#h1-3-5" id="h1-3-5" class="i">+{
</a><a href="#h1-3-6" id="h1-3-6" class="i">+	term.numlock ^= 1;
</a><a href="#h1-3-7" id="h1-3-7" class="i">+}
</a><a href="#h1-3-8" id="h1-3-8" class="i">+
</a> char*
 kmap(KeySym k, uint state) {
 	uint mask;
<a href="#h1-4" id="h1-4" class="h">@@ -2725,8 +2734,12 @@ kmap(KeySym k, uint state) {
</a> 		if(!match(mask, state))
 			continue;
 
<a href="#h1-4-3" id="h1-4-3" class="d">-		if((kp-&gt;appkey &lt; 0 &amp;&amp; IS_SET(MODE_APPKEYPAD)) ||
</a><a href="#h1-4-4" id="h1-4-4" class="d">-				(kp-&gt;appkey &gt; 0 &amp;&amp; !IS_SET(MODE_APPKEYPAD))) {
</a><a href="#h1-4-5" id="h1-4-5" class="i">+		if(kp-&gt;appkey &gt; 0) {
</a><a href="#h1-4-6" id="h1-4-6" class="i">+			if(!IS_SET(MODE_APPKEYPAD))
</a><a href="#h1-4-7" id="h1-4-7" class="i">+				continue;
</a><a href="#h1-4-8" id="h1-4-8" class="i">+			if(term.numlock &amp;&amp; kp-&gt;appkey == 2)
</a><a href="#h1-4-9" id="h1-4-9" class="i">+				continue;
</a><a href="#h1-4-10" id="h1-4-10" class="i">+		} else if (kp-&gt;appkey &lt; 0 &amp;&amp; IS_SET(MODE_APPKEYPAD)) {
</a> 			continue;
 		}
 
</pre>
</div>
</body>
</html>
