<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>added XRaiseWindow workaround when new clients are launched - slock - simple X display locker utility
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="slock Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>slock</h1><span class="desc">simple X display locker utility
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/d6e9e7d9e32d315330e1a60a5087a86c19ab1ab7.html">d6e9e7d9e32d315330e1a60a5087a86c19ab1ab7</a>
<b>parent</b> <a href="../commit/f013cb264e654125c043ed637b7f47692376f967.html">f013cb264e654125c043ed637b7f47692376f967</a>
<b>Author:</b> anselm@garbe.us &lt;<a href="mailto:unknown">unknown</a>&gt;
<b>Date:</b>   Sun,  5 Feb 2012 16:38:58 +0100

added XRaiseWindow workaround when new clients are launched
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">LICENSE</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">slock.c</a></td><td> | </td><td class="num">86</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------------------------</span></td></tr>
</table></pre><pre>2 files changed, 36 insertions(+), 52 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/LICENSE.html">LICENSE</a> b/<a href="../file/LICENSE.html">LICENSE</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,6 +1,6 @@
</a> MIT/X Consortium License
 
<a href="#h0-0-2" id="h0-0-2" class="d">-© 2006-2008 Anselm R Garbe &lt;garbeam at gmail dot com&gt;
</a><a href="#h0-0-3" id="h0-0-3" class="i">+© 2006-2012 Anselm R Garbe &lt;anselm@garbe.us&gt;
</a> 
 Permission is hereby granted, free of charge, to any person obtaining a
 copy of this software and associated documentation files (the &quot;Software&quot;),
<b>diff --git a/<a id="h1" href="../file/slock.c.html">slock.c</a> b/<a href="../file/slock.c.html">slock.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -22,25 +22,23 @@
</a> #include &lt;bsd_auth.h&gt;
 #endif
 
<a href="#h1-0-3" id="h1-0-3" class="d">-struct st_lock {
</a><a href="#h1-0-4" id="h1-0-4" class="i">+typedef struct {
</a> 	int screen;
<a href="#h1-0-6" id="h1-0-6" class="d">-	Window root, w;
</a><a href="#h1-0-7" id="h1-0-7" class="i">+	Window root, win;
</a> 	Pixmap pmap;
<a href="#h1-0-9" id="h1-0-9" class="d">-};
</a><a href="#h1-0-10" id="h1-0-10" class="i">+} Lock;
</a> 
<a href="#h1-0-12" id="h1-0-12" class="d">-extern const char *__progname;
</a><a href="#h1-0-13" id="h1-0-13" class="i">+static Lock **locks;
</a><a href="#h1-0-14" id="h1-0-14" class="i">+static int nscreens;
</a><a href="#h1-0-15" id="h1-0-15" class="i">+static Bool running = True;
</a> 
 static void
 die(const char *errstr, ...) {
 	va_list ap;
 
<a href="#h1-0-21" id="h1-0-21" class="d">-	fprintf(stderr, &quot;%s: &quot;, __progname);
</a> 	va_start(ap, errstr);
 	vfprintf(stderr, errstr, ap);
 	va_end(ap);
<a href="#h1-0-25" id="h1-0-25" class="d">-	fprintf(stderr, &quot;\n&quot;);
</a><a href="#h1-0-26" id="h1-0-26" class="d">-	fflush(stderr);
</a><a href="#h1-0-27" id="h1-0-27" class="d">-
</a> 	exit(EXIT_FAILURE);
 }
 
<a href="#h1-1" id="h1-1" class="h">@@ -52,7 +50,7 @@ getpw(void) { /* only run as root */
</a> 
 	pw = getpwuid(getuid());
 	if(!pw)
<a href="#h1-1-3" id="h1-1-3" class="d">-		die(&quot;cannot retrieve password entry (make sure to suid or sgid slock)&quot;);
</a><a href="#h1-1-4" id="h1-1-4" class="i">+		die(&quot;slock: cannot retrieve password entry (make sure to suid or sgid slock)&quot;);
</a> 	endpwent();
 	rval =  pw-&gt;pw_passwd;
 
<a href="#h1-2" id="h1-2" class="h">@@ -69,7 +67,7 @@ getpw(void) { /* only run as root */
</a> 
 	/* drop privileges */
 	if(setgid(pw-&gt;pw_gid) &lt; 0 || setuid(pw-&gt;pw_uid) &lt; 0)
<a href="#h1-2-3" id="h1-2-3" class="d">-		die(&quot;cannot drop privileges&quot;);
</a><a href="#h1-2-4" id="h1-2-4" class="i">+		die(&quot;slock: cannot drop privileges&quot;);
</a> 	return rval;
 }
 #endif
<a href="#h1-3" id="h1-3" class="h">@@ -82,10 +80,8 @@ readpw(Display *dpy, const char *pws)
</a> #endif
 {
 	char buf[32], passwd[256];
<a href="#h1-3-3" id="h1-3-3" class="d">-	int num;
</a><a href="#h1-3-4" id="h1-3-4" class="d">-
</a><a href="#h1-3-5" id="h1-3-5" class="i">+	int num, screen;
</a> 	unsigned int len;
<a href="#h1-3-7" id="h1-3-7" class="d">-	Bool running = True;
</a> 	KeySym ksym;
 	XEvent ev;
 
<a href="#h1-4" id="h1-4" class="h">@@ -96,7 +92,6 @@ readpw(Display *dpy, const char *pws)
</a> 	 * had been removed and you can set it with &quot;xset&quot; or some other
 	 * utility. This way the user can easily set a customized DPMS
 	 * timeout. */
<a href="#h1-4-3" id="h1-4-3" class="d">-
</a> 	while(running &amp;&amp; !XNextEvent(dpy, &amp;ev)) {
 		if(ev.type == KeyPress) {
 			buf[0] = 0;
<a href="#h1-5" id="h1-5" class="h">@@ -119,7 +114,7 @@ readpw(Display *dpy, const char *pws)
</a> #else
 				running = strcmp(crypt(passwd, pws), pws);
 #endif
<a href="#h1-5-3" id="h1-5-3" class="d">-				if (running != 0)
</a><a href="#h1-5-4" id="h1-5-4" class="i">+				if(running != False)
</a> 					XBell(dpy, 100);
 				len = 0;
 				break;
<a href="#h1-6" id="h1-6" class="h">@@ -138,36 +133,37 @@ readpw(Display *dpy, const char *pws)
</a> 				break;
 			}
 		}
<a href="#h1-6-3" id="h1-6-3" class="i">+		else for(screen = 0; screen &lt; nscreens; screen++)
</a><a href="#h1-6-4" id="h1-6-4" class="i">+			XMapRaised(dpy, locks[screen]-&gt;win);
</a> 	}
 }
 
 static void
<a href="#h1-6-9" id="h1-6-9" class="d">-unlockscreen(Display *dpy, struct st_lock *lock) {
</a><a href="#h1-6-10" id="h1-6-10" class="d">-	if (dpy == NULL || lock == NULL)
</a><a href="#h1-6-11" id="h1-6-11" class="i">+unlockscreen(Display *dpy, Lock *lock) {
</a><a href="#h1-6-12" id="h1-6-12" class="i">+	if(dpy == NULL || lock == NULL)
</a> 		return;
 
 	XUngrabPointer(dpy, CurrentTime);
 	XFreePixmap(dpy, lock-&gt;pmap);
<a href="#h1-6-17" id="h1-6-17" class="d">-	XDestroyWindow(dpy, lock-&gt;w);
</a><a href="#h1-6-18" id="h1-6-18" class="i">+	XDestroyWindow(dpy, lock-&gt;win);
</a> 
 	free(lock);
 }
 
<a href="#h1-6-23" id="h1-6-23" class="d">-static struct st_lock *
</a><a href="#h1-6-24" id="h1-6-24" class="i">+static Lock *
</a> lockscreen(Display *dpy, int screen) {
 	char curs[] = {0, 0, 0, 0, 0, 0, 0, 0};
 	unsigned int len;
<a href="#h1-6-28" id="h1-6-28" class="d">-	struct st_lock *lock;
</a><a href="#h1-6-29" id="h1-6-29" class="d">-	Bool running = True;
</a><a href="#h1-6-30" id="h1-6-30" class="i">+	Lock *lock;
</a> 	XColor black, dummy;
 	XSetWindowAttributes wa;
 	Cursor invisible;
 
<a href="#h1-6-35" id="h1-6-35" class="d">-	if (dpy == NULL || screen &lt; 0)
</a><a href="#h1-6-36" id="h1-6-36" class="i">+	if(dpy == NULL || screen &lt; 0)
</a> 		return NULL;
 
<a href="#h1-6-39" id="h1-6-39" class="d">-	lock = malloc(sizeof(struct st_lock));
</a><a href="#h1-6-40" id="h1-6-40" class="d">-	if (lock == NULL)
</a><a href="#h1-6-41" id="h1-6-41" class="i">+	lock = malloc(sizeof(Lock));
</a><a href="#h1-6-42" id="h1-6-42" class="i">+	if(lock == NULL)
</a> 		return NULL;
 
 	lock-&gt;screen = screen;
<a href="#h1-7" id="h1-7" class="h">@@ -177,21 +173,21 @@ lockscreen(Display *dpy, int screen) {
</a> 	/* init */
 	wa.override_redirect = 1;
 	wa.background_pixel = BlackPixel(dpy, lock-&gt;screen);
<a href="#h1-7-3" id="h1-7-3" class="d">-	lock-&gt;w = XCreateWindow(dpy, lock-&gt;root, 0, 0, DisplayWidth(dpy, lock-&gt;screen), DisplayHeight(dpy, lock-&gt;screen),
</a><a href="#h1-7-4" id="h1-7-4" class="i">+	lock-&gt;win = XCreateWindow(dpy, lock-&gt;root, 0, 0, DisplayWidth(dpy, lock-&gt;screen), DisplayHeight(dpy, lock-&gt;screen),
</a> 			0, DefaultDepth(dpy, lock-&gt;screen), CopyFromParent,
 			DefaultVisual(dpy, lock-&gt;screen), CWOverrideRedirect | CWBackPixel, &amp;wa);
 	XAllocNamedColor(dpy, DefaultColormap(dpy, lock-&gt;screen), &quot;black&quot;, &amp;black, &amp;dummy);
<a href="#h1-7-8" id="h1-7-8" class="d">-	lock-&gt;pmap = XCreateBitmapFromData(dpy, lock-&gt;w, curs, 8, 8);
</a><a href="#h1-7-9" id="h1-7-9" class="i">+	lock-&gt;pmap = XCreateBitmapFromData(dpy, lock-&gt;win, curs, 8, 8);
</a> 	invisible = XCreatePixmapCursor(dpy, lock-&gt;pmap, lock-&gt;pmap, &amp;black, &amp;black, 0, 0);
<a href="#h1-7-11" id="h1-7-11" class="d">-	XDefineCursor(dpy, lock-&gt;w, invisible);
</a><a href="#h1-7-12" id="h1-7-12" class="d">-	XMapRaised(dpy, lock-&gt;w);
</a><a href="#h1-7-13" id="h1-7-13" class="i">+	XDefineCursor(dpy, lock-&gt;win, invisible);
</a><a href="#h1-7-14" id="h1-7-14" class="i">+	XMapRaised(dpy, lock-&gt;win);
</a> 	for(len = 1000; len; len--) {
 		if(XGrabPointer(dpy, lock-&gt;root, False, ButtonPressMask | ButtonReleaseMask | PointerMotionMask,
 			GrabModeAsync, GrabModeAsync, None, invisible, CurrentTime) == GrabSuccess)
 			break;
 		usleep(1000);
 	}
<a href="#h1-7-21" id="h1-7-21" class="d">-	if((running = running &amp;&amp; (len &gt; 0))) {
</a><a href="#h1-7-22" id="h1-7-22" class="i">+	if(running &amp;&amp; (len &gt; 0)) {
</a> 		for(len = 1000; len; len--) {
 			if(XGrabKeyboard(dpy, lock-&gt;root, True, GrabModeAsync, GrabModeAsync, CurrentTime)
 				== GrabSuccess)
<a href="#h1-8" id="h1-8" class="h">@@ -201,7 +197,7 @@ lockscreen(Display *dpy, int screen) {
</a> 		running = (len &gt; 0);
 	}
 
<a href="#h1-8-3" id="h1-8-3" class="d">-	if (!running) {
</a><a href="#h1-8-4" id="h1-8-4" class="i">+	if(!running) {
</a> 		unlockscreen(dpy, lock);
 		lock = NULL;
 	}
<a href="#h1-9" id="h1-9" class="h">@@ -211,24 +207,17 @@ lockscreen(Display *dpy, int screen) {
</a> 
 static void
 usage(void) {
<a href="#h1-9-3" id="h1-9-3" class="d">-	fprintf(stderr, &quot;usage: %s -v&quot;, __progname);
</a><a href="#h1-9-4" id="h1-9-4" class="i">+	fprintf(stderr, &quot;usage: slock [-v]&quot;);
</a> 	exit(EXIT_FAILURE);
 }
 
<a href="#h1-9-8" id="h1-9-8" class="d">-static int
</a><a href="#h1-9-9" id="h1-9-9" class="d">-xerrordummy(Display *dpy, XErrorEvent *ee) {
</a><a href="#h1-9-10" id="h1-9-10" class="d">-	return 0;
</a><a href="#h1-9-11" id="h1-9-11" class="d">-}
</a><a href="#h1-9-12" id="h1-9-12" class="d">-
</a> int
 main(int argc, char **argv) {
 #ifndef HAVE_BSD_AUTH
 	const char *pws;
 #endif
 	Display *dpy;
<a href="#h1-9-19" id="h1-9-19" class="d">-	int nscreens, screen;
</a><a href="#h1-9-20" id="h1-9-20" class="d">-
</a><a href="#h1-9-21" id="h1-9-21" class="d">-	struct st_lock **locks;
</a><a href="#h1-9-22" id="h1-9-22" class="i">+	int screen;
</a> 
 	if((argc == 2) &amp;&amp; !strcmp(&quot;-v&quot;, argv[1]))
 		die(&quot;slock-%s, © 2006-2012 Anselm R Garbe&quot;, VERSION);
<a href="#h1-10" id="h1-10" class="h">@@ -236,25 +225,21 @@ main(int argc, char **argv) {
</a> 		usage();
 
 	if(!getpwuid(getuid()))
<a href="#h1-10-3" id="h1-10-3" class="d">-		die(&quot;no passwd entry for you&quot;);
</a><a href="#h1-10-4" id="h1-10-4" class="i">+		die(&quot;slock: no passwd entry for you&quot;);
</a> 
 #ifndef HAVE_BSD_AUTH
 	pws = getpw();
 #endif
 
 	if(!(dpy = XOpenDisplay(0)))
<a href="#h1-10-11" id="h1-10-11" class="d">-		die(&quot;cannot open display&quot;);
</a><a href="#h1-10-12" id="h1-10-12" class="d">-	/* prevent default error handler to take over */
</a><a href="#h1-10-13" id="h1-10-13" class="d">-	XSetErrorHandler(xerrordummy);
</a><a href="#h1-10-14" id="h1-10-14" class="i">+		die(&quot;slock: cannot open display&quot;);
</a> 	/* Get the number of screens in display &quot;dpy&quot; and blank them all. */
 	nscreens = ScreenCount(dpy);
<a href="#h1-10-17" id="h1-10-17" class="d">-	locks = malloc(sizeof(struct st_lock *) * nscreens);
</a><a href="#h1-10-18" id="h1-10-18" class="d">-	if (locks == NULL)
</a><a href="#h1-10-19" id="h1-10-19" class="d">-		die(&quot;malloc: %s&quot;, strerror(errno));
</a><a href="#h1-10-20" id="h1-10-20" class="d">-
</a><a href="#h1-10-21" id="h1-10-21" class="d">-	for (screen = 0; screen &lt; nscreens; screen++)
</a><a href="#h1-10-22" id="h1-10-22" class="i">+	locks = malloc(sizeof(Lock *) * nscreens);
</a><a href="#h1-10-23" id="h1-10-23" class="i">+	if(locks == NULL)
</a><a href="#h1-10-24" id="h1-10-24" class="i">+		die(&quot;slock: malloc: %s&quot;, strerror(errno));
</a><a href="#h1-10-25" id="h1-10-25" class="i">+	for(screen = 0; screen &lt; nscreens; screen++)
</a> 		locks[screen] = lockscreen(dpy, screen);
<a href="#h1-10-27" id="h1-10-27" class="d">-
</a> 	XSync(dpy, False);
 
 	/* Everything is now blank. Now wait for the correct password. */
<a href="#h1-11" id="h1-11" class="h">@@ -265,11 +250,10 @@ main(int argc, char **argv) {
</a> #endif
 
 	/* Password ok, unlock everything and quit. */
<a href="#h1-11-3" id="h1-11-3" class="d">-	for (screen = 0; screen &lt; nscreens; screen++)
</a><a href="#h1-11-4" id="h1-11-4" class="i">+	for(screen = 0; screen &lt; nscreens; screen++)
</a> 		unlockscreen(dpy, locks[screen]);
 
 	free(locks);
<a href="#h1-11-8" id="h1-11-8" class="d">-
</a> 	XCloseDisplay(dpy);
 
 	return 0;
</pre>
</div>
</body>
</html>
