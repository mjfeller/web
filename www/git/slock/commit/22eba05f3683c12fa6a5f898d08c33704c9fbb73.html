<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Ensure Polyphemus-Mitigation and properly drop privileges - slock - simple X display locker utility
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="slock Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>slock</h1><span class="desc">simple X display locker utility
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/22eba05f3683c12fa6a5f898d08c33704c9fbb73.html">22eba05f3683c12fa6a5f898d08c33704c9fbb73</a>
<b>parent</b> <a href="../commit/04143fd68dbc656905714eff5c208fadb3464e25.html">04143fd68dbc656905714eff5c208fadb3464e25</a>
<b>Author:</b> FRIGN &lt;<a href="mailto:dev@frign.de">dev@frign.de</a>&gt;
<b>Date:</b>   Wed,  7 Sep 2016 13:32:29 +0200

Ensure Polyphemus-Mitigation and properly drop privileges

Don&#39;t hide privilege drops inside readpw() and actually make it
configurable what you are dropping to in config.h.

The privilege drop comes after opening the Display because the
user &quot;nobody&quot; with &quot;nogroup&quot; can&#39;t do that.

So why do I call this strategy the Polyphemus-Mitigation?

&quot;&quot;&quot;
After the giant returns in the evening and eats two more of the men,
Odysseus offers Polyphemus some strong and undiluted wine given to him
earlier on his journey. Drunk and unwary, the giant asks Odysseus his
name, promising him a guest-gift if he answers. Odysseus tells him
&quot;Οὖτις&quot;, which means &quot;nobody&quot; and Polyphemus promises to eat this
&quot;Nobody&quot; last of all. With that, he falls into a drunken sleep. Odysseus
had meanwhile hardened a wooden stake in the fire and now drives it into
Polyphemus&#39; eye. When Polyphemus shouts for help from his fellow giants,
saying that &quot;Nobody&quot; has hurt him, they think Polyphemus is being
afflicted by divine power and recommend prayer as the answer.
&quot;&quot;&quot;

(source: https://en.wikipedia.org/wiki/Polyphemus)

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">config.def.h</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">config.mk</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">slock.c</a></td><td> | </td><td class="num">30</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d">-----</span></td></tr>
</table></pre><pre>3 files changed, 30 insertions(+), 6 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config.def.h.html">config.def.h</a> b/<a href="../file/config.def.h.html">config.def.h</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,3 +1,7 @@
</a><a href="#h0-0-0" id="h0-0-0" class="i">+/* user and group to drop privileges to */
</a><a href="#h0-0-1" id="h0-0-1" class="i">+static const char *user  = &quot;nobody&quot;;
</a><a href="#h0-0-2" id="h0-0-2" class="i">+static const char *group = &quot;nogroup&quot;;
</a><a href="#h0-0-3" id="h0-0-3" class="i">+
</a> static const char *colorname[NUMCOLS] = {
 	&quot;black&quot;,     /* after initialization */
 	&quot;#005577&quot;,   /* during input */
<b>diff --git a/<a id="h1" href="../file/config.mk.html">config.mk</a> b/<a href="../file/config.mk.html">config.mk</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -15,7 +15,7 @@ INCS = -I. -I/usr/include -I${X11INC}
</a> LIBS = -L/usr/lib -lc -lcrypt -L${X11LIB} -lX11 -lXext -lXrandr
 
 # flags
<a href="#h1-0-3" id="h1-0-3" class="d">-CPPFLAGS = -DVERSION=\&quot;${VERSION}\&quot; -DHAVE_SHADOW_H
</a><a href="#h1-0-4" id="h1-0-4" class="i">+CPPFLAGS = -DVERSION=\&quot;${VERSION}\&quot; -D_DEFAULT_SOURCE -DHAVE_SHADOW_H
</a> CFLAGS = -std=c99 -pedantic -Wall -Os ${INCS} ${CPPFLAGS}
 LDFLAGS = -s ${LIBS}
 COMPATSRC = explicit_bzero.c
<b>diff --git a/<a id="h2" href="../file/slock.c.html">slock.c</a> b/<a href="../file/slock.c.html">slock.c</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -6,6 +6,7 @@
</a> 
 #include &lt;ctype.h&gt;
 #include &lt;errno.h&gt;
<a href="#h2-0-3" id="h2-0-3" class="i">+#include &lt;grp.h&gt;
</a> #include &lt;pwd.h&gt;
 #include &lt;stdarg.h&gt;
 #include &lt;stdlib.h&gt;
<a href="#h2-1" id="h2-1" class="h">@@ -83,7 +84,6 @@ dontkillme(void)
</a> }
 #endif
 
<a href="#h2-1-3" id="h2-1-3" class="d">-/* only run as root */
</a> static const char *
 getpw(void)
 {
<a href="#h2-2" id="h2-2" class="h">@@ -119,10 +119,6 @@ getpw(void)
</a> 	}
 #endif /* HAVE_SHADOW_H */
 
<a href="#h2-2-3" id="h2-2-3" class="d">-	/* drop privileges */
</a><a href="#h2-2-4" id="h2-2-4" class="d">-	if (geteuid() == 0 &amp;&amp;
</a><a href="#h2-2-5" id="h2-2-5" class="d">-	    ((getegid() != pw-&gt;pw_gid &amp;&amp; setgid(pw-&gt;pw_gid) &lt; 0) || setuid(pw-&gt;pw_uid) &lt; 0))
</a><a href="#h2-2-6" id="h2-2-6" class="d">-		die(&quot;slock: cannot drop privileges\n&quot;);
</a> 	return rval;
 }
 
<a href="#h2-3" id="h2-3" class="h">@@ -316,6 +312,10 @@ usage(void)
</a> 
 int
 main(int argc, char **argv) {
<a href="#h2-3-3" id="h2-3-3" class="i">+	struct passwd *pwd;
</a><a href="#h2-3-4" id="h2-3-4" class="i">+	struct group *grp;
</a><a href="#h2-3-5" id="h2-3-5" class="i">+	uid_t duid;
</a><a href="#h2-3-6" id="h2-3-6" class="i">+	gid_t dgid;
</a> 	const char *pws;
 	Display *dpy;
 	int s, nlocks;
<a href="#h2-4" id="h2-4" class="h">@@ -328,6 +328,18 @@ main(int argc, char **argv) {
</a> 		usage();
 	} ARGEND
 
<a href="#h2-4-3" id="h2-4-3" class="i">+	/* validate drop-user and -group */
</a><a href="#h2-4-4" id="h2-4-4" class="i">+	errno = 0;
</a><a href="#h2-4-5" id="h2-4-5" class="i">+	if (!(pwd = getpwnam(user)))
</a><a href="#h2-4-6" id="h2-4-6" class="i">+		die(&quot;slock: getpwnam %s: %s\n&quot;, user, errno ?
</a><a href="#h2-4-7" id="h2-4-7" class="i">+		    strerror(errno) : &quot;user entry not found&quot;);
</a><a href="#h2-4-8" id="h2-4-8" class="i">+	duid = pwd-&gt;pw_uid;
</a><a href="#h2-4-9" id="h2-4-9" class="i">+	errno = 0;
</a><a href="#h2-4-10" id="h2-4-10" class="i">+	if (!(grp = getgrnam(group)))
</a><a href="#h2-4-11" id="h2-4-11" class="i">+		die(&quot;slock: getgrnam %s: %s\n&quot;, group, errno ?
</a><a href="#h2-4-12" id="h2-4-12" class="i">+		    strerror(errno) : &quot;group entry not found&quot;);
</a><a href="#h2-4-13" id="h2-4-13" class="i">+	dgid = grp-&gt;gr_gid;
</a><a href="#h2-4-14" id="h2-4-14" class="i">+
</a> #ifdef __linux__
 	dontkillme();
 #endif
<a href="#h2-5" id="h2-5" class="h">@@ -339,6 +351,14 @@ main(int argc, char **argv) {
</a> 	if (!(dpy = XOpenDisplay(NULL)))
 		die(&quot;slock: cannot open display\n&quot;);
 
<a href="#h2-5-3" id="h2-5-3" class="i">+	/* drop privileges */
</a><a href="#h2-5-4" id="h2-5-4" class="i">+	if (setgroups(0, NULL) &lt; 0)
</a><a href="#h2-5-5" id="h2-5-5" class="i">+		die(&quot;slock: setgroups: %s\n&quot;, strerror(errno));
</a><a href="#h2-5-6" id="h2-5-6" class="i">+	if (setgid(dgid) &lt; 0)
</a><a href="#h2-5-7" id="h2-5-7" class="i">+		die(&quot;slock: setgid: %s\n&quot;, strerror(errno));
</a><a href="#h2-5-8" id="h2-5-8" class="i">+	if (setuid(duid) &lt; 0)
</a><a href="#h2-5-9" id="h2-5-9" class="i">+		die(&quot;slock: setuid: %s\n&quot;, strerror(errno));
</a><a href="#h2-5-10" id="h2-5-10" class="i">+
</a> 	/* check for Xrandr support */
 	rr = XRRQueryExtension(dpy, &amp;rrevbase, &amp;rrerrbase);
 
</pre>
</div>
</body>
</html>
