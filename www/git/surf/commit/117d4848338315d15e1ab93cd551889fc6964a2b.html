<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Adding disk cache support for soup. - surf - surf browser, a WebKit based browser
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="surf Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>surf</h1><span class="desc">surf browser, a WebKit based browser
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/117d4848338315d15e1ab93cd551889fc6964a2b.html">117d4848338315d15e1ab93cd551889fc6964a2b</a>
<b>parent</b> <a href="../commit/24ec46fc241b655bf91a4529fa164ae9703d4eb6.html">24ec46fc241b655bf91a4529fa164ae9703d4eb6</a>
<b>Author:</b> Christoph Lohmann &lt;<a href="mailto:20h@r-36.net">20h@r-36.net</a>&gt;
<b>Date:</b>   Sat, 17 Jan 2015 20:50:21 +0100

Adding disk cache support for soup.

This is a merge of the patch of Ben Woolley &lt;tautolog@gmail.com&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">config.def.h</a></td><td> | </td><td class="num">19</td><td><span class="i">+++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">surf.c</a></td><td> | </td><td class="num">30</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">-</span></td></tr>
</table></pre><pre>2 files changed, 40 insertions(+), 9 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config.def.h.html">config.def.h</a> b/<a href="../file/config.def.h.html">config.def.h</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -4,6 +4,7 @@ static char *useragent      = &quot;Mozilla/5.0 (X11; U; Unix; en-US) &quot;
</a> 	&quot;Safari/537.15 Surf/&quot;VERSION;
 static char *scriptfile     = &quot;~/.surf/script.js&quot;;
 static char *styledir       = &quot;~/.surf/styles/&quot;;
<a href="#h0-0-3" id="h0-0-3" class="i">+static char *cachefolder    = &quot;~/.surf/cache/&quot;;
</a> 
 static Bool kioskmode       = FALSE; /* Ignore shortcuts */
 static Bool showindicators  = TRUE;  /* Show indicators in window title */
<a href="#h0-1" id="h0-1" class="h">@@ -22,15 +23,17 @@ static char *strictssl      = FALSE; /* Refuse untrusted SSL connections */
</a> static time_t sessiontime   = 3600;
 
 /* Webkit default features */
<a href="#h0-1-3" id="h0-1-3" class="d">-static Bool enablescrollbars = TRUE;
</a><a href="#h0-1-4" id="h0-1-4" class="i">+static Bool enablescrollbars      = TRUE;
</a> static Bool enablespatialbrowsing = TRUE;
<a href="#h0-1-6" id="h0-1-6" class="d">-static Bool enableplugins = TRUE;
</a><a href="#h0-1-7" id="h0-1-7" class="d">-static Bool enablescripts = TRUE;
</a><a href="#h0-1-8" id="h0-1-8" class="d">-static Bool enableinspector = TRUE;
</a><a href="#h0-1-9" id="h0-1-9" class="d">-static Bool enablestyles = TRUE;
</a><a href="#h0-1-10" id="h0-1-10" class="d">-static Bool loadimages = TRUE;
</a><a href="#h0-1-11" id="h0-1-11" class="d">-static Bool hidebackground  = FALSE;
</a><a href="#h0-1-12" id="h0-1-12" class="d">-static Bool allowgeolocation = TRUE;
</a><a href="#h0-1-13" id="h0-1-13" class="i">+static Bool enablediskcache       = TRUE;
</a><a href="#h0-1-14" id="h0-1-14" class="i">+static int diskcachebytes         = 5 * 1024 * 1024;
</a><a href="#h0-1-15" id="h0-1-15" class="i">+static Bool enableplugins         = TRUE;
</a><a href="#h0-1-16" id="h0-1-16" class="i">+static Bool enablescripts         = TRUE;
</a><a href="#h0-1-17" id="h0-1-17" class="i">+static Bool enableinspector       = TRUE;
</a><a href="#h0-1-18" id="h0-1-18" class="i">+static Bool enablestyles          = TRUE;
</a><a href="#h0-1-19" id="h0-1-19" class="i">+static Bool loadimages            = TRUE;
</a><a href="#h0-1-20" id="h0-1-20" class="i">+static Bool hidebackground        = FALSE;
</a><a href="#h0-1-21" id="h0-1-21" class="i">+static Bool allowgeolocation      = TRUE;
</a> 
 #define SETPROP(p, q) { \
 	.v = (char *[]){ &quot;/bin/sh&quot;, &quot;-c&quot;, \
<b>diff --git a/<a id="h1" href="../file/surf.c.html">surf.c</a> b/<a href="../file/surf.c.html">surf.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -85,11 +85,12 @@ static GdkNativeWindow embed = 0;
</a> static gboolean showxid = FALSE;
 static char winid[64];
 static gboolean usingproxy = 0;
<a href="#h1-0-3" id="h1-0-3" class="d">-static char togglestat[8];
</a><a href="#h1-0-4" id="h1-0-4" class="i">+static char togglestat[9];
</a> static char pagestat[3];
 static GTlsDatabase *tlsdb;
 static int policysel = 0;
 static char *stylefile = NULL;
<a href="#h1-0-9" id="h1-0-9" class="i">+static SoupCache *diskcache = NULL;
</a> 
 static void addaccelgroup(Client *c);
 static void beforerequest(WebKitWebView *w, WebKitWebFrame *f,
<a href="#h1-1" id="h1-1" class="h">@@ -270,6 +271,10 @@ buttonrelease(WebKitWebView *web, GdkEventButton *e, GList *gl) {
</a> 
 static void
 cleanup(void) {
<a href="#h1-1-3" id="h1-1-3" class="i">+	if (diskcache) {
</a><a href="#h1-1-4" id="h1-1-4" class="i">+		soup_cache_flush(diskcache);
</a><a href="#h1-1-5" id="h1-1-5" class="i">+		soup_cache_dump(diskcache);
</a><a href="#h1-1-6" id="h1-1-6" class="i">+	}
</a> 	while(clients)
 		destroyclient(clients);
 	g_free(cookiefile);
<a href="#h1-2" id="h1-2" class="h">@@ -677,6 +682,10 @@ loadstatuschange(WebKitWebView *view, GParamSpec *pspec, Client *c) {
</a> 	case WEBKIT_LOAD_FINISHED:
 		c-&gt;progress = 100;
 		updatetitle(c);
<a href="#h1-2-3" id="h1-2-3" class="i">+		if (diskcache) {
</a><a href="#h1-2-4" id="h1-2-4" class="i">+			soup_cache_flush(diskcache);
</a><a href="#h1-2-5" id="h1-2-5" class="i">+			soup_cache_dump(diskcache);
</a><a href="#h1-2-6" id="h1-2-6" class="i">+		}
</a> 		break;
 	default:
 		break;
<a href="#h1-3" id="h1-3" class="h">@@ -972,6 +981,8 @@ newwindow(Client *c, const Arg *arg, gboolean noembed) {
</a> 		cmd[i++] = &quot;-s&quot;;
 	if(showxid)
 		cmd[i++] = &quot;-x&quot;;
<a href="#h1-3-3" id="h1-3-3" class="i">+	if(enablediskcache)
</a><a href="#h1-3-4" id="h1-3-4" class="i">+		cmd[i++] = &quot;-D&quot;;
</a> 	cmd[i++] = &quot;-c&quot;;
 	cmd[i++] = cookiefile;
 	cmd[i++] = &quot;--&quot;;
<a href="#h1-4" id="h1-4" class="h">@@ -1149,6 +1160,7 @@ setup(void) {
</a> 	/* dirs and files */
 	cookiefile = buildpath(cookiefile);
 	scriptfile = buildpath(scriptfile);
<a href="#h1-4-3" id="h1-4-3" class="i">+	cachefolder = buildpath(cachefolder);
</a> 	styledir = buildpath(styledir);
 	if(stylefile == NULL &amp;&amp; enablestyles) {
 		for(i = 0; i &lt; LENGTH(styles); i++) {
<a href="#h1-5" id="h1-5" class="h">@@ -1175,6 +1187,14 @@ setup(void) {
</a> 			SOUP_SESSION_FEATURE(cookiejar_new(cookiefile, FALSE,
 					cookiepolicy_get())));
 
<a href="#h1-5-3" id="h1-5-3" class="i">+	/* disk cache */
</a><a href="#h1-5-4" id="h1-5-4" class="i">+	if(enablediskcache) {
</a><a href="#h1-5-5" id="h1-5-5" class="i">+		diskcache = soup_cache_new(cachefolder, SOUP_CACHE_SINGLE_USER);
</a><a href="#h1-5-6" id="h1-5-6" class="i">+		soup_cache_set_max_size(diskcache, diskcachebytes);
</a><a href="#h1-5-7" id="h1-5-7" class="i">+		soup_cache_load(diskcache);
</a><a href="#h1-5-8" id="h1-5-8" class="i">+		soup_session_add_feature(s, SOUP_SESSION_FEATURE(diskcache));
</a><a href="#h1-5-9" id="h1-5-9" class="i">+	}
</a><a href="#h1-5-10" id="h1-5-10" class="i">+
</a> 	/* ssl */
 	tlsdb = g_tls_file_database_new(cafile, &amp;error);
 
<a href="#h1-6" id="h1-6" class="h">@@ -1363,6 +1383,8 @@ gettogglestat(Client *c){
</a> 
 	togglestat[p++] = allowgeolocation? &#39;G&#39;: &#39;g&#39;;
 
<a href="#h1-6-3" id="h1-6-3" class="i">+	togglestat[p++] = enablediskcache? &#39;D&#39;: &#39;d&#39;;
</a><a href="#h1-6-4" id="h1-6-4" class="i">+
</a> 	g_object_get(G_OBJECT(settings), &quot;auto-load-images&quot;, &amp;value, NULL);
 	togglestat[p++] = value? &#39;I&#39;: &#39;i&#39;;
 
<a href="#h1-7" id="h1-7" class="h">@@ -1479,6 +1501,12 @@ main(int argc, char *argv[]) {
</a> 	case &#39;c&#39;:
 		cookiefile = EARGF(usage());
 		break;
<a href="#h1-7-3" id="h1-7-3" class="i">+	case &#39;d&#39;:
</a><a href="#h1-7-4" id="h1-7-4" class="i">+		enablediskcache = 0;
</a><a href="#h1-7-5" id="h1-7-5" class="i">+		break;
</a><a href="#h1-7-6" id="h1-7-6" class="i">+	case &#39;D&#39;:
</a><a href="#h1-7-7" id="h1-7-7" class="i">+		enablediskcache = 1;
</a><a href="#h1-7-8" id="h1-7-8" class="i">+		break;
</a> 	case &#39;e&#39;:
 		embed = strtol(EARGF(usage()), NULL, 0);
 		break;
</pre>
</div>
</body>
</html>
