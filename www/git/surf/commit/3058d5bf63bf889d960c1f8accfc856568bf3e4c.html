<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Applying the cookie patch of Carlos Pita. Thank you! - surf - surf browser, a WebKit based browser
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="surf Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>surf</h1><span class="desc">surf browser, a WebKit based browser
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/3058d5bf63bf889d960c1f8accfc856568bf3e4c.html">3058d5bf63bf889d960c1f8accfc856568bf3e4c</a>
<b>parent</b> <a href="../commit/5703683638bba566029f4061c1c057b33f5c47c9.html">5703683638bba566029f4061c1c057b33f5c47c9</a>
<b>Author:</b> Christoph Lohmann &lt;<a href="mailto:20h@r-36.net">20h@r-36.net</a>&gt;
<b>Date:</b>   Tue, 16 Oct 2012 21:54:37 +0200

Applying the cookie patch of Carlos Pita. Thank you!
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">surf.c</a></td><td> | </td><td class="num">122</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------------</span></td></tr>
</table></pre><pre>1 file changed, 63 insertions(+), 59 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/surf.c.html">surf.c</a> b/<a href="../file/surf.c.html">surf.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -21,6 +21,8 @@
</a> #include &lt;sys/file.h&gt;
 
 #define LENGTH(x)               (sizeof x / sizeof x[0])
<a href="#h0-0-3" id="h0-0-3" class="i">+#define COOKIEJAR_TYPE          (cookiejar_get_type ())
</a><a href="#h0-0-4" id="h0-0-4" class="i">+#define COOKIEJAR(obj)          (G_TYPE_CHECK_INSTANCE_CAST ((obj), COOKIEJAR_TYPE, CookieJar))
</a> 
 enum { AtomFind, AtomGo, AtomUri, AtomLast };
 
<a href="#h0-1" id="h0-1" class="h">@@ -55,6 +57,17 @@ typedef struct {
</a> 	const Arg arg;
 } Key;
 
<a href="#h0-1-3" id="h0-1-3" class="i">+typedef struct {
</a><a href="#h0-1-4" id="h0-1-4" class="i">+	SoupCookieJarText parent_instance;
</a><a href="#h0-1-5" id="h0-1-5" class="i">+	int lock;
</a><a href="#h0-1-6" id="h0-1-6" class="i">+} CookieJar;
</a><a href="#h0-1-7" id="h0-1-7" class="i">+
</a><a href="#h0-1-8" id="h0-1-8" class="i">+typedef struct {
</a><a href="#h0-1-9" id="h0-1-9" class="i">+	SoupCookieJarTextClass parent_class;
</a><a href="#h0-1-10" id="h0-1-10" class="i">+} CookieJarClass;
</a><a href="#h0-1-11" id="h0-1-11" class="i">+
</a><a href="#h0-1-12" id="h0-1-12" class="i">+G_DEFINE_TYPE(CookieJar, cookiejar, SOUP_TYPE_COOKIE_JAR_TEXT)
</a><a href="#h0-1-13" id="h0-1-13" class="i">+
</a> static Display *dpy;
 static Atom atoms[AtomLast];
 static Client *clients = NULL;
<a href="#h0-2" id="h0-2" class="h">@@ -68,6 +81,10 @@ static char *buildpath(const char *path);
</a> static gboolean buttonrelease(WebKitWebView *web, GdkEventButton *e, GList *gl);
 static void cleanup(void);
 static void clipboard(Client *c, const Arg *arg);
<a href="#h0-2-3" id="h0-2-3" class="i">+static void cookiejar_changed(SoupCookieJar *self, SoupCookie *old_cookie, SoupCookie *new_cookie);
</a><a href="#h0-2-4" id="h0-2-4" class="i">+static void cookiejar_finalize(GObject *self);
</a><a href="#h0-2-5" id="h0-2-5" class="i">+static SoupCookieJar *cookiejar_new(const char *filename, gboolean read_only);
</a><a href="#h0-2-6" id="h0-2-6" class="i">+static void cookiejar_set_property(GObject *self, guint prop_id, const GValue *value, GParamSpec *pspec);
</a> static char *copystr(char **str, const char *src);
 static WebKitWebView *createwindow(WebKitWebView *v, WebKitWebFrame *f, Client *c);
 static gboolean decidedownload(WebKitWebView *v, WebKitWebFrame *f, WebKitNetworkRequest *r, gchar *m,  WebKitWebPolicyDecision *p, Client *c);
<a href="#h0-3" id="h0-3" class="h">@@ -79,9 +96,7 @@ static void drawindicator(Client *c);
</a> static gboolean exposeindicator(GtkWidget *w, GdkEventExpose *e, Client *c);
 static void find(Client *c, const Arg *arg);
 static const char *getatom(Client *c, int a);
<a href="#h0-3-3" id="h0-3-3" class="d">-static const char *getcookies(SoupURI *uri);
</a> static char *geturi(Client *c);
<a href="#h0-3-5" id="h0-3-5" class="d">-void gotheaders(SoupMessage *msg, gpointer user_data);
</a> static gboolean initdownload(WebKitWebView *v, WebKitDownload *o, Client *c);
 static gboolean keypress(GtkWidget *w, GdkEventKey *ev, Client *c);
 static void linkhover(WebKitWebView *v, const char* t, const char* l, Client *c);
<a href="#h0-4" id="h0-4" class="h">@@ -90,7 +105,6 @@ static void loaduri(Client *c, const Arg *arg);
</a> static void navigate(Client *c, const Arg *arg);
 static Client *newclient(void);
 static void newwindow(Client *c, const Arg *arg, gboolean noembed);
<a href="#h0-4-3" id="h0-4-3" class="d">-static void newrequest(SoupSession *s, SoupMessage *msg, gpointer v);
</a> static void pasteuri(GtkClipboard *clipboard, const char *text, gpointer d);
 static void populatepopup(WebKitWebView *web, GtkMenu *menu, Client *c);
 static void popupactivate(GtkMenuItem *menu, Client *);
<a href="#h0-5" id="h0-5" class="h">@@ -102,7 +116,6 @@ static void scroll_h(Client *c, const Arg *arg);
</a> static void scroll_v(Client *c, const Arg *arg);
 static void scroll(GtkAdjustment *a, const Arg *arg);
 static void setatom(Client *c, int a, const char *v);
<a href="#h0-5-3" id="h0-5-3" class="d">-static void setcookie(SoupCookie *c);
</a> static void setup(void);
 static void sigchld(int unused);
 static void source(Client *c, const Arg *arg);
<a href="#h0-6" id="h0-6" class="h">@@ -169,6 +182,49 @@ cleanup(void) {
</a> 	g_free(stylefile);
 }
 
<a href="#h0-6-3" id="h0-6-3" class="i">+static void
</a><a href="#h0-6-4" id="h0-6-4" class="i">+cookiejar_changed(SoupCookieJar *self, SoupCookie *old_cookie, SoupCookie *new_cookie) {
</a><a href="#h0-6-5" id="h0-6-5" class="i">+	flock(COOKIEJAR(self)-&gt;lock, LOCK_EX);
</a><a href="#h0-6-6" id="h0-6-6" class="i">+	if(new_cookie &amp;&amp; !new_cookie-&gt;expires &amp;&amp; sessiontime)
</a><a href="#h0-6-7" id="h0-6-7" class="i">+		soup_cookie_set_expires(new_cookie, soup_date_new_from_now(sessiontime));
</a><a href="#h0-6-8" id="h0-6-8" class="i">+	SOUP_COOKIE_JAR_CLASS(cookiejar_parent_class)-&gt;changed(self, old_cookie, new_cookie);
</a><a href="#h0-6-9" id="h0-6-9" class="i">+	flock(COOKIEJAR(self)-&gt;lock, LOCK_UN);
</a><a href="#h0-6-10" id="h0-6-10" class="i">+}
</a><a href="#h0-6-11" id="h0-6-11" class="i">+
</a><a href="#h0-6-12" id="h0-6-12" class="i">+static void
</a><a href="#h0-6-13" id="h0-6-13" class="i">+cookiejar_class_init(CookieJarClass *klass) {
</a><a href="#h0-6-14" id="h0-6-14" class="i">+	SOUP_COOKIE_JAR_CLASS(klass)-&gt;changed = cookiejar_changed;
</a><a href="#h0-6-15" id="h0-6-15" class="i">+	G_OBJECT_CLASS(klass)-&gt;get_property = G_OBJECT_CLASS(cookiejar_parent_class)-&gt;get_property;
</a><a href="#h0-6-16" id="h0-6-16" class="i">+	G_OBJECT_CLASS(klass)-&gt;set_property = cookiejar_set_property;
</a><a href="#h0-6-17" id="h0-6-17" class="i">+	G_OBJECT_CLASS(klass)-&gt;finalize = cookiejar_finalize;
</a><a href="#h0-6-18" id="h0-6-18" class="i">+	g_object_class_override_property(G_OBJECT_CLASS(klass), 1, &quot;filename&quot;);
</a><a href="#h0-6-19" id="h0-6-19" class="i">+}
</a><a href="#h0-6-20" id="h0-6-20" class="i">+
</a><a href="#h0-6-21" id="h0-6-21" class="i">+static void
</a><a href="#h0-6-22" id="h0-6-22" class="i">+cookiejar_finalize(GObject *self) {
</a><a href="#h0-6-23" id="h0-6-23" class="i">+	close(COOKIEJAR(self)-&gt;lock);
</a><a href="#h0-6-24" id="h0-6-24" class="i">+	G_OBJECT_CLASS(cookiejar_parent_class)-&gt;finalize(self);
</a><a href="#h0-6-25" id="h0-6-25" class="i">+}
</a><a href="#h0-6-26" id="h0-6-26" class="i">+
</a><a href="#h0-6-27" id="h0-6-27" class="i">+static void
</a><a href="#h0-6-28" id="h0-6-28" class="i">+cookiejar_init(CookieJar *self) {
</a><a href="#h0-6-29" id="h0-6-29" class="i">+	self-&gt;lock = open(cookiefile, 0);
</a><a href="#h0-6-30" id="h0-6-30" class="i">+}
</a><a href="#h0-6-31" id="h0-6-31" class="i">+
</a><a href="#h0-6-32" id="h0-6-32" class="i">+static SoupCookieJar *
</a><a href="#h0-6-33" id="h0-6-33" class="i">+cookiejar_new(const char *filename, gboolean read_only) {
</a><a href="#h0-6-34" id="h0-6-34" class="i">+	return g_object_new(COOKIEJAR_TYPE,
</a><a href="#h0-6-35" id="h0-6-35" class="i">+	                    SOUP_COOKIE_JAR_TEXT_FILENAME, filename,
</a><a href="#h0-6-36" id="h0-6-36" class="i">+	                    SOUP_COOKIE_JAR_READ_ONLY, read_only, NULL);
</a><a href="#h0-6-37" id="h0-6-37" class="i">+} 
</a><a href="#h0-6-38" id="h0-6-38" class="i">+
</a><a href="#h0-6-39" id="h0-6-39" class="i">+static void
</a><a href="#h0-6-40" id="h0-6-40" class="i">+cookiejar_set_property(GObject *self, guint prop_id, const GValue *value, GParamSpec *pspec) {
</a><a href="#h0-6-41" id="h0-6-41" class="i">+	flock(COOKIEJAR(self)-&gt;lock, LOCK_SH);
</a><a href="#h0-6-42" id="h0-6-42" class="i">+	G_OBJECT_CLASS(cookiejar_parent_class)-&gt;set_property(self, prop_id, value, pspec);
</a><a href="#h0-6-43" id="h0-6-43" class="i">+	flock(COOKIEJAR(self)-&gt;lock, LOCK_UN);
</a><a href="#h0-6-44" id="h0-6-44" class="i">+}
</a><a href="#h0-6-45" id="h0-6-45" class="i">+
</a> void
 evalscript(JSContextRef js, char *script, char* scriptname) {
 	JSStringRef jsscript, jsscriptname;
<a href="#h0-7" id="h0-7" class="h">@@ -315,15 +371,6 @@ find(Client *c, const Arg *arg) {
</a> }
 
 const char *
<a href="#h0-7-3" id="h0-7-3" class="d">-getcookies(SoupURI *uri) {
</a><a href="#h0-7-4" id="h0-7-4" class="d">-	const char *c;
</a><a href="#h0-7-5" id="h0-7-5" class="d">-	SoupCookieJar *j = soup_cookie_jar_text_new(cookiefile, TRUE);
</a><a href="#h0-7-6" id="h0-7-6" class="d">-	c = soup_cookie_jar_get_cookies(j, uri, TRUE);
</a><a href="#h0-7-7" id="h0-7-7" class="d">-	g_object_unref(j);
</a><a href="#h0-7-8" id="h0-7-8" class="d">-	return c;
</a><a href="#h0-7-9" id="h0-7-9" class="d">-}
</a><a href="#h0-7-10" id="h0-7-10" class="d">-
</a><a href="#h0-7-11" id="h0-7-11" class="d">-const char *
</a> getatom(Client *c, int a) {
 	static char buf[BUFSIZ];
 	Atom adummy;
<a href="#h0-8" id="h0-8" class="h">@@ -351,17 +398,6 @@ geturi(Client *c) {
</a> 	return uri;
 }
 
<a href="#h0-8-3" id="h0-8-3" class="d">-void
</a><a href="#h0-8-4" id="h0-8-4" class="d">-gotheaders(SoupMessage *msg, gpointer v) {
</a><a href="#h0-8-5" id="h0-8-5" class="d">-	GSList *l, *p;
</a><a href="#h0-8-6" id="h0-8-6" class="d">-
</a><a href="#h0-8-7" id="h0-8-7" class="d">-	for(p = l = soup_cookies_from_response(msg); p;
</a><a href="#h0-8-8" id="h0-8-8" class="d">-		p = g_slist_next(p))  {
</a><a href="#h0-8-9" id="h0-8-9" class="d">-		setcookie((SoupCookie *)p-&gt;data);
</a><a href="#h0-8-10" id="h0-8-10" class="d">-	}
</a><a href="#h0-8-11" id="h0-8-11" class="d">-	soup_cookies_free(l);
</a><a href="#h0-8-12" id="h0-8-12" class="d">-}
</a><a href="#h0-8-13" id="h0-8-13" class="d">-
</a> gboolean
 initdownload(WebKitWebView *view, WebKitDownload *o, Client *c) {
 	Arg arg;
<a href="#h0-9" id="h0-9" class="h">@@ -576,19 +612,6 @@ newclient(void) {
</a> }
 
 void
<a href="#h0-9-3" id="h0-9-3" class="d">-newrequest(SoupSession *s, SoupMessage *msg, gpointer v) {
</a><a href="#h0-9-4" id="h0-9-4" class="d">-	SoupMessageHeaders *h = msg-&gt;request_headers;
</a><a href="#h0-9-5" id="h0-9-5" class="d">-	SoupURI *uri;
</a><a href="#h0-9-6" id="h0-9-6" class="d">-	const char *c;
</a><a href="#h0-9-7" id="h0-9-7" class="d">-
</a><a href="#h0-9-8" id="h0-9-8" class="d">-	soup_message_headers_remove(h, &quot;Cookie&quot;);
</a><a href="#h0-9-9" id="h0-9-9" class="d">-	uri = soup_message_get_uri(msg);
</a><a href="#h0-9-10" id="h0-9-10" class="d">-	if((c = getcookies(uri)))
</a><a href="#h0-9-11" id="h0-9-11" class="d">-		soup_message_headers_append(h, &quot;Cookie&quot;, c);
</a><a href="#h0-9-12" id="h0-9-12" class="d">-	g_signal_connect_after(G_OBJECT(msg), &quot;got-headers&quot;, G_CALLBACK(gotheaders), NULL);
</a><a href="#h0-9-13" id="h0-9-13" class="d">-}
</a><a href="#h0-9-14" id="h0-9-14" class="d">-
</a><a href="#h0-9-15" id="h0-9-15" class="d">-void
</a> newwindow(Client *c, const Arg *arg, gboolean noembed) {
 	guint i = 0;
 	const char *cmd[10], *uri;
<a href="#h0-10" id="h0-10" class="h">@@ -743,25 +766,6 @@ scroll(GtkAdjustment *a, const Arg *arg) {
</a> }
 
 void
<a href="#h0-10-3" id="h0-10-3" class="d">-setcookie(SoupCookie *c) {
</a><a href="#h0-10-4" id="h0-10-4" class="d">-	int lock;
</a><a href="#h0-10-5" id="h0-10-5" class="d">-
</a><a href="#h0-10-6" id="h0-10-6" class="d">-	lock = open(cookiefile, 0);
</a><a href="#h0-10-7" id="h0-10-7" class="d">-	flock(lock, LOCK_EX);
</a><a href="#h0-10-8" id="h0-10-8" class="d">-	SoupDate *e;
</a><a href="#h0-10-9" id="h0-10-9" class="d">-	SoupCookieJar *j = soup_cookie_jar_text_new(cookiefile, FALSE);
</a><a href="#h0-10-10" id="h0-10-10" class="d">-	c = soup_cookie_copy(c);
</a><a href="#h0-10-11" id="h0-10-11" class="d">-	if(c-&gt;expires == NULL &amp;&amp; sessiontime) {
</a><a href="#h0-10-12" id="h0-10-12" class="d">-		e = soup_date_new_from_time_t(time(NULL) + sessiontime);
</a><a href="#h0-10-13" id="h0-10-13" class="d">-		soup_cookie_set_expires(c, e);
</a><a href="#h0-10-14" id="h0-10-14" class="d">-	}
</a><a href="#h0-10-15" id="h0-10-15" class="d">-	soup_cookie_jar_add_cookie(j, c);
</a><a href="#h0-10-16" id="h0-10-16" class="d">-	g_object_unref(j);
</a><a href="#h0-10-17" id="h0-10-17" class="d">-	flock(lock, LOCK_UN);
</a><a href="#h0-10-18" id="h0-10-18" class="d">-	close(lock);
</a><a href="#h0-10-19" id="h0-10-19" class="d">-}
</a><a href="#h0-10-20" id="h0-10-20" class="d">-
</a><a href="#h0-10-21" id="h0-10-21" class="d">-void
</a> setatom(Client *c, int a, const char *v) {
 	XSync(dpy, False);
 	XChangeProperty(dpy, GDK_WINDOW_XID(GTK_WIDGET(c-&gt;win)-&gt;window), atoms[a],
<a href="#h0-11" id="h0-11" class="h">@@ -796,9 +800,9 @@ setup(void) {
</a> 
 	/* request handler */
 	s = webkit_get_default_session();
<a href="#h0-11-3" id="h0-11-3" class="d">-	soup_session_remove_feature_by_type(s, soup_cookie_get_type());
</a><a href="#h0-11-4" id="h0-11-4" class="d">-	soup_session_remove_feature_by_type(s, soup_cookie_jar_get_type());
</a><a href="#h0-11-5" id="h0-11-5" class="d">-	g_signal_connect_after(G_OBJECT(s), &quot;request-started&quot;, G_CALLBACK(newrequest), NULL);
</a><a href="#h0-11-6" id="h0-11-6" class="i">+
</a><a href="#h0-11-7" id="h0-11-7" class="i">+	/* cookie jar */
</a><a href="#h0-11-8" id="h0-11-8" class="i">+	soup_session_add_feature(s, SOUP_SESSION_FEATURE(cookiejar_new(cookiefile, FALSE)));
</a> 
 	/* ssl */
 	g_object_set(G_OBJECT(s), &quot;ssl-ca-file&quot;, cafile, NULL);
</pre>
</div>
</body>
</html>
