<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Fixed keys handling for multilayout environments. - surf - surf browser, a WebKit based browser
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="surf Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>surf</h1><span class="desc">surf browser, a WebKit based browser
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/bccfe2a9a553784aa0b50fb63aa198be906d8cae.html">bccfe2a9a553784aa0b50fb63aa198be906d8cae</a>
<b>parent</b> <a href="../commit/dcb4f81ad22ed7fbaa4df391814307feb700f18e.html">dcb4f81ad22ed7fbaa4df391814307feb700f18e</a>
<b>Author:</b> Alexander Sedov &lt;<a href="mailto:alex0player@gmail.com">alex0player@gmail.com</a>&gt;
<b>Date:</b>   Fri, 15 Mar 2013 19:12:15 +0400

Fixed keys handling for multilayout environments.

There is a bug in GTK+ that does not allow capturing shortcuts using
letter keys on layouts other than &quot;us&quot;. The bug is there for ages and
there is probably no hope that it will get fixed. This patch switches
shortcut handling method to GtkAccelGroup, which handles this case
correctly. Enjoy!

Signed-off-by: Christoph Lohmann &lt;20h@r-36.net&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">surf.c</a></td><td> | </td><td class="num">30</td><td><span class="i">+++++++++++++++++++++++</span><span class="d">-------</span></td></tr>
</table></pre><pre>1 file changed, 23 insertions(+), 7 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/surf.c.html">surf.c</a> b/<a href="../file/surf.c.html">surf.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -80,6 +80,7 @@ static gboolean usingproxy = 0;
</a> static char togglestat[6];
 static char pagestat[3];
 
<a href="#h0-0-3" id="h0-0-3" class="i">+static void add_accels(Client *c);
</a> static void beforerequest(WebKitWebView *w, WebKitWebFrame *f,
 		WebKitWebResource *r, WebKitNetworkRequest *req,
 		WebKitNetworkResponse *resp, gpointer d);
<a href="#h0-1" id="h0-1" class="h">@@ -124,7 +125,9 @@ static gboolean inspector_show(WebKitWebInspector *i, Client *c);
</a> static gboolean inspector_close(WebKitWebInspector *i, Client *c);
 static void inspector_finished(WebKitWebInspector *i, Client *c);
 
<a href="#h0-1-3" id="h0-1-3" class="d">-static gboolean keypress(GtkWidget *w, GdkEventKey *ev, Client *c);
</a><a href="#h0-1-4" id="h0-1-4" class="i">+static gboolean keypress(GtkAccelGroup *group,
</a><a href="#h0-1-5" id="h0-1-5" class="i">+		GObject *obj, guint key, GdkModifierType mods,
</a><a href="#h0-1-6" id="h0-1-6" class="i">+		Client *c);
</a> static void linkhover(WebKitWebView *v, const char* t, const char* l,
 		Client *c);
 static void loadstatuschange(WebKitWebView *view, GParamSpec *pspec,
<a href="#h0-2" id="h0-2" class="h">@@ -166,6 +169,18 @@ static void zoom(Client *c, const Arg *arg);
</a> #include &quot;config.h&quot;
 
 static void
<a href="#h0-2-3" id="h0-2-3" class="i">+add_accels(Client *c) {
</a><a href="#h0-2-4" id="h0-2-4" class="i">+	int i;
</a><a href="#h0-2-5" id="h0-2-5" class="i">+	GtkAccelGroup *group = gtk_accel_group_new();
</a><a href="#h0-2-6" id="h0-2-6" class="i">+	for(i = 0; i &lt; LENGTH(keys); i++) {
</a><a href="#h0-2-7" id="h0-2-7" class="i">+		GClosure *closure = g_cclosure_new(G_CALLBACK(keypress), c, NULL);
</a><a href="#h0-2-8" id="h0-2-8" class="i">+		gtk_accel_group_connect(group, keys[i].keyval, keys[i].mod,
</a><a href="#h0-2-9" id="h0-2-9" class="i">+				0, closure);
</a><a href="#h0-2-10" id="h0-2-10" class="i">+	}
</a><a href="#h0-2-11" id="h0-2-11" class="i">+	gtk_window_add_accel_group(GTK_WINDOW(c-&gt;win), group);
</a><a href="#h0-2-12" id="h0-2-12" class="i">+}
</a><a href="#h0-2-13" id="h0-2-13" class="i">+
</a><a href="#h0-2-14" id="h0-2-14" class="i">+static void
</a> beforerequest(WebKitWebView *w, WebKitWebFrame *f, WebKitWebResource *r,
 		WebKitNetworkRequest *req, WebKitNetworkResponse *resp,
 		gpointer d) {
<a href="#h0-3" id="h0-3" class="h">@@ -514,14 +529,17 @@ inspector_finished(WebKitWebInspector *i, Client *c) {
</a> }
 
 static gboolean
<a href="#h0-3-3" id="h0-3-3" class="d">-keypress(GtkWidget* w, GdkEventKey *ev, Client *c) {
</a><a href="#h0-3-4" id="h0-3-4" class="i">+keypress(GtkAccelGroup *group, GObject *obj,
</a><a href="#h0-3-5" id="h0-3-5" class="i">+		guint key, GdkModifierType mods, Client *c) {
</a> 	guint i;
 	gboolean processed = FALSE;
 
<a href="#h0-3-9" id="h0-3-9" class="i">+	mods = CLEANMASK(mods);
</a><a href="#h0-3-10" id="h0-3-10" class="i">+	key = gdk_keyval_to_lower(key);
</a> 	updatewinid(c);
 	for(i = 0; i &lt; LENGTH(keys); i++) {
<a href="#h0-3-13" id="h0-3-13" class="d">-		if(gdk_keyval_to_lower(ev-&gt;keyval) == keys[i].keyval
</a><a href="#h0-3-14" id="h0-3-14" class="d">-				&amp;&amp; CLEANMASK(ev-&gt;state) == keys[i].mod
</a><a href="#h0-3-15" id="h0-3-15" class="i">+		if(key == keys[i].keyval
</a><a href="#h0-3-16" id="h0-3-16" class="i">+				&amp;&amp; mods == keys[i].mod
</a> 				&amp;&amp; keys[i].func) {
 			keys[i].func(c, &amp;(keys[i].arg));
 			processed = TRUE;
<a href="#h0-4" id="h0-4" class="h">@@ -646,9 +664,7 @@ newclient(void) {
</a> 			&quot;destroy&quot;,
 			G_CALLBACK(destroywin), c);
 	if(!kioskmode) {
<a href="#h0-4-3" id="h0-4-3" class="d">-		g_signal_connect(G_OBJECT(c-&gt;win),
</a><a href="#h0-4-4" id="h0-4-4" class="d">-				&quot;key-press-event&quot;,
</a><a href="#h0-4-5" id="h0-4-5" class="d">-				G_CALLBACK(keypress), c);
</a><a href="#h0-4-6" id="h0-4-6" class="i">+		add_accels(c);
</a> 	}
 
 	/* Pane */
</pre>
</div>
</body>
</html>
