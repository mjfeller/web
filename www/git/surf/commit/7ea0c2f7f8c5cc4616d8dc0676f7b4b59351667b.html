<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Communicate with webextension via a pipe - surf - surf browser, a WebKit based browser
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="surf Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>surf</h1><span class="desc">surf browser, a WebKit based browser
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/7ea0c2f7f8c5cc4616d8dc0676f7b4b59351667b.html">7ea0c2f7f8c5cc4616d8dc0676f7b4b59351667b</a>
<b>parent</b> <a href="../commit/1bd6d201020f67160872c28534edff532b5198b9.html">1bd6d201020f67160872c28534edff532b5198b9</a>
<b>Author:</b> Quentin Rameau &lt;<a href="mailto:quinq@fifth.space">quinq@fifth.space</a>&gt;
<b>Date:</b>   Mon,  7 Dec 2015 15:50:00 +0100

Communicate with webextension via a pipe

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">Makefile</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">config.def.h</a></td><td> | </td><td class="num">16</td><td><span class="i">+++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">libsurf-webext.c</a></td><td> | </td><td class="num">128</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">surf.c</a></td><td> | </td><td class="num">114</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------</span></td></tr>
</table></pre><pre>4 files changed, 213 insertions(+), 47 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/Makefile.html">Makefile</a> b/<a href="../file/Makefile.html">Makefile</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -29,7 +29,7 @@ options:
</a> 	@$(LIBTOOL) --mode compile --tag CC $(CC) $(LIBCFLAGS) -c $&lt;
 
 $(OBJ): config.h config.mk
<a href="#h0-0-3" id="h0-0-3" class="d">-$(LIBOBJ): config.mk
</a><a href="#h0-0-4" id="h0-0-4" class="i">+$(LIBOBJ): config.h config.mk
</a> 
 config.h:
 	@echo creating $@ from config.def.h
<b>diff --git a/<a id="h1" href="../file/config.def.h.html">config.def.h</a> b/<a href="../file/config.def.h.html">config.def.h</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -143,15 +143,13 @@ static Key keys[] = {
</a> 	{ MODKEY,                GDK_KEY_l,      navigate,   { .i = +1 } },
 	{ MODKEY,                GDK_KEY_h,      navigate,   { .i = -1 } },
 
<a href="#h1-0-3" id="h1-0-3" class="d">-	/* Currently we have to use scrolling steps that WebKit2GTK+ gives us
</a><a href="#h1-0-4" id="h1-0-4" class="d">-	 * d: step down, u: step up, r: step right, l:step left
</a><a href="#h1-0-5" id="h1-0-5" class="d">-	 * D: page down, U: page up */
</a><a href="#h1-0-6" id="h1-0-6" class="d">-	{ MODKEY,                GDK_KEY_j,      scroll,     { .i = &#39;d&#39; } },
</a><a href="#h1-0-7" id="h1-0-7" class="d">-	{ MODKEY,                GDK_KEY_k,      scroll,     { .i = &#39;u&#39; } },
</a><a href="#h1-0-8" id="h1-0-8" class="d">-	{ MODKEY,                GDK_KEY_b,      scroll,     { .i = &#39;U&#39; } },
</a><a href="#h1-0-9" id="h1-0-9" class="d">-	{ MODKEY,                GDK_KEY_space,  scroll,     { .i = &#39;D&#39; } },
</a><a href="#h1-0-10" id="h1-0-10" class="d">-	{ MODKEY,                GDK_KEY_i,      scroll,     { .i = &#39;r&#39; } },
</a><a href="#h1-0-11" id="h1-0-11" class="d">-	{ MODKEY,                GDK_KEY_u,      scroll,     { .i = &#39;l&#39; } },
</a><a href="#h1-0-12" id="h1-0-12" class="i">+	/* vertical and horizontal scrolling, in viewport percentage */
</a><a href="#h1-0-13" id="h1-0-13" class="i">+	{ MODKEY,                GDK_KEY_j,      scrollv,    { .i = +10 } },
</a><a href="#h1-0-14" id="h1-0-14" class="i">+	{ MODKEY,                GDK_KEY_k,      scrollv,    { .i = -10 } },
</a><a href="#h1-0-15" id="h1-0-15" class="i">+	{ MODKEY,                GDK_KEY_b,      scrollv,    { .i = +50 } },
</a><a href="#h1-0-16" id="h1-0-16" class="i">+	{ MODKEY,                GDK_KEY_space,  scrollv,    { .i = -50 } },
</a><a href="#h1-0-17" id="h1-0-17" class="i">+	{ MODKEY,                GDK_KEY_i,      scrollh,    { .i = +10 } },
</a><a href="#h1-0-18" id="h1-0-18" class="i">+	{ MODKEY,                GDK_KEY_u,      scrollh,    { .i = -10 } },
</a> 
 
 	{ MODKEY|GDK_SHIFT_MASK, GDK_KEY_j,      zoom,       { .i = -1 } },
<b>diff --git a/<a id="h2" href="../file/libsurf-webext.c.html">libsurf-webext.c</a> b/<a href="../file/libsurf-webext.c.html">libsurf-webext.c</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,7 +1,131 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+#include &lt;sys/stat.h&gt;
</a><a href="#h2-0-1" id="h2-0-1" class="i">+#include &lt;fcntl.h&gt;
</a><a href="#h2-0-2" id="h2-0-2" class="i">+#include &lt;limits.h&gt;
</a><a href="#h2-0-3" id="h2-0-3" class="i">+#include &lt;stdlib.h&gt;
</a><a href="#h2-0-4" id="h2-0-4" class="i">+
</a><a href="#h2-0-5" id="h2-0-5" class="i">+#include &lt;gio/gio.h&gt;
</a> #include &lt;webkit2/webkit-web-extension.h&gt;
<a href="#h2-0-7" id="h2-0-7" class="i">+#include &lt;webkitdom/webkitdom.h&gt;
</a><a href="#h2-0-8" id="h2-0-8" class="i">+#include &lt;webkitdom/WebKitDOMDOMWindowUnstable.h&gt;
</a><a href="#h2-0-9" id="h2-0-9" class="i">+
</a><a href="#h2-0-10" id="h2-0-10" class="i">+#define LENGTH(x)   (sizeof(x) / sizeof(x[0]))
</a><a href="#h2-0-11" id="h2-0-11" class="i">+
</a><a href="#h2-0-12" id="h2-0-12" class="i">+#define MSGBUFSZ 32
</a><a href="#h2-0-13" id="h2-0-13" class="i">+
</a><a href="#h2-0-14" id="h2-0-14" class="i">+typedef struct Page {
</a><a href="#h2-0-15" id="h2-0-15" class="i">+	guint64 id;
</a><a href="#h2-0-16" id="h2-0-16" class="i">+	WebKitWebPage *webpage;
</a><a href="#h2-0-17" id="h2-0-17" class="i">+	WebKitDOMDOMWindow *view;
</a><a href="#h2-0-18" id="h2-0-18" class="i">+	struct Page *next;
</a><a href="#h2-0-19" id="h2-0-19" class="i">+} Page;
</a><a href="#h2-0-20" id="h2-0-20" class="i">+
</a><a href="#h2-0-21" id="h2-0-21" class="i">+static int pipein, pipeout;
</a><a href="#h2-0-22" id="h2-0-22" class="i">+static Page *pages;
</a><a href="#h2-0-23" id="h2-0-23" class="i">+
</a><a href="#h2-0-24" id="h2-0-24" class="i">+Page *
</a><a href="#h2-0-25" id="h2-0-25" class="i">+newpage(WebKitWebPage *page)
</a><a href="#h2-0-26" id="h2-0-26" class="i">+{
</a><a href="#h2-0-27" id="h2-0-27" class="i">+	Page *p;
</a><a href="#h2-0-28" id="h2-0-28" class="i">+
</a><a href="#h2-0-29" id="h2-0-29" class="i">+	if (!(p = calloc(1, sizeof(Page))))
</a><a href="#h2-0-30" id="h2-0-30" class="i">+		die(&quot;Cannot malloc!\n&quot;);
</a><a href="#h2-0-31" id="h2-0-31" class="i">+
</a><a href="#h2-0-32" id="h2-0-32" class="i">+	p-&gt;next = pages;
</a><a href="#h2-0-33" id="h2-0-33" class="i">+	pages = p;
</a><a href="#h2-0-34" id="h2-0-34" class="i">+
</a><a href="#h2-0-35" id="h2-0-35" class="i">+	p-&gt;id = webkit_web_page_get_id(page);
</a><a href="#h2-0-36" id="h2-0-36" class="i">+	p-&gt;webpage = page;
</a><a href="#h2-0-37" id="h2-0-37" class="i">+
</a><a href="#h2-0-38" id="h2-0-38" class="i">+	return p;
</a><a href="#h2-0-39" id="h2-0-39" class="i">+}
</a><a href="#h2-0-40" id="h2-0-40" class="i">+
</a><a href="#h2-0-41" id="h2-0-41" class="i">+static void
</a><a href="#h2-0-42" id="h2-0-42" class="i">+msgsurf(Page *p, const char *s)
</a><a href="#h2-0-43" id="h2-0-43" class="i">+{
</a><a href="#h2-0-44" id="h2-0-44" class="i">+	char msg[MSGBUFSZ];
</a><a href="#h2-0-45" id="h2-0-45" class="i">+	int ret;
</a><a href="#h2-0-46" id="h2-0-46" class="i">+
</a><a href="#h2-0-47" id="h2-0-47" class="i">+	msg[0] = p ? p-&gt;id : 0;
</a><a href="#h2-0-48" id="h2-0-48" class="i">+	ret = snprintf(&amp;msg[1], sizeof(msg) - 1, &quot;%s&quot;, s);
</a><a href="#h2-0-49" id="h2-0-49" class="i">+	if (ret &gt;= sizeof(msg)) {
</a><a href="#h2-0-50" id="h2-0-50" class="i">+		fprintf(stderr, &quot;webext: message too long: %d\n&quot;, ret);
</a><a href="#h2-0-51" id="h2-0-51" class="i">+		return;
</a><a href="#h2-0-52" id="h2-0-52" class="i">+	}
</a><a href="#h2-0-53" id="h2-0-53" class="i">+
</a><a href="#h2-0-54" id="h2-0-54" class="i">+	if (pipeout) {
</a><a href="#h2-0-55" id="h2-0-55" class="i">+		if (write(pipeout, msg, sizeof(msg)) &lt; 0)
</a><a href="#h2-0-56" id="h2-0-56" class="i">+			fprintf(stderr, &quot;webext: error sending: %s\n&quot;, msg);
</a><a href="#h2-0-57" id="h2-0-57" class="i">+	}
</a><a href="#h2-0-58" id="h2-0-58" class="i">+}
</a><a href="#h2-0-59" id="h2-0-59" class="i">+
</a><a href="#h2-0-60" id="h2-0-60" class="i">+static gboolean
</a><a href="#h2-0-61" id="h2-0-61" class="i">+readpipe(GIOChannel *s, GIOCondition c, gpointer unused)
</a><a href="#h2-0-62" id="h2-0-62" class="i">+{
</a><a href="#h2-0-63" id="h2-0-63" class="i">+	char msg[MSGBUFSZ];
</a><a href="#h2-0-64" id="h2-0-64" class="i">+	gsize msgsz;
</a><a href="#h2-0-65" id="h2-0-65" class="i">+	GError *gerr = NULL;
</a><a href="#h2-0-66" id="h2-0-66" class="i">+	glong wh, ww;
</a><a href="#h2-0-67" id="h2-0-67" class="i">+	Page *p;
</a><a href="#h2-0-68" id="h2-0-68" class="i">+
</a><a href="#h2-0-69" id="h2-0-69" class="i">+	if (g_io_channel_read_chars(s, msg, LENGTH(msg), &amp;msgsz, &amp;gerr) !=
</a><a href="#h2-0-70" id="h2-0-70" class="i">+	    G_IO_STATUS_NORMAL) {
</a><a href="#h2-0-71" id="h2-0-71" class="i">+		fprintf(stderr, &quot;webext: error reading pipe: %s\n&quot;,
</a><a href="#h2-0-72" id="h2-0-72" class="i">+		        gerr-&gt;message);
</a><a href="#h2-0-73" id="h2-0-73" class="i">+		g_error_free(gerr);
</a><a href="#h2-0-74" id="h2-0-74" class="i">+		return TRUE;
</a><a href="#h2-0-75" id="h2-0-75" class="i">+	}
</a><a href="#h2-0-76" id="h2-0-76" class="i">+	msg[msgsz] = &#39;\0&#39;;
</a><a href="#h2-0-77" id="h2-0-77" class="i">+
</a><a href="#h2-0-78" id="h2-0-78" class="i">+	for (p = pages; p; p = p-&gt;next) {
</a><a href="#h2-0-79" id="h2-0-79" class="i">+		if (p-&gt;id == msg[0])
</a><a href="#h2-0-80" id="h2-0-80" class="i">+			break;
</a><a href="#h2-0-81" id="h2-0-81" class="i">+	}
</a><a href="#h2-0-82" id="h2-0-82" class="i">+	if (!p || !p-&gt;view)
</a><a href="#h2-0-83" id="h2-0-83" class="i">+		return TRUE;
</a><a href="#h2-0-84" id="h2-0-84" class="i">+
</a><a href="#h2-0-85" id="h2-0-85" class="i">+	switch (msg[1]) {
</a><a href="#h2-0-86" id="h2-0-86" class="i">+	case &#39;h&#39;:
</a><a href="#h2-0-87" id="h2-0-87" class="i">+		ww = webkit_dom_dom_window_get_inner_width(p-&gt;view);
</a><a href="#h2-0-88" id="h2-0-88" class="i">+		webkit_dom_dom_window_scroll_by(p-&gt;view,
</a><a href="#h2-0-89" id="h2-0-89" class="i">+		                                (ww / 100) * msg[2], 0);
</a><a href="#h2-0-90" id="h2-0-90" class="i">+		break;
</a><a href="#h2-0-91" id="h2-0-91" class="i">+	case &#39;v&#39;:
</a><a href="#h2-0-92" id="h2-0-92" class="i">+		wh = webkit_dom_dom_window_get_inner_height(p-&gt;view);
</a><a href="#h2-0-93" id="h2-0-93" class="i">+		webkit_dom_dom_window_scroll_by(p-&gt;view,
</a><a href="#h2-0-94" id="h2-0-94" class="i">+		                                0, (wh / 100) * msg[2]);
</a><a href="#h2-0-95" id="h2-0-95" class="i">+		break;
</a><a href="#h2-0-96" id="h2-0-96" class="i">+	}
</a><a href="#h2-0-97" id="h2-0-97" class="i">+
</a><a href="#h2-0-98" id="h2-0-98" class="i">+	return TRUE;
</a><a href="#h2-0-99" id="h2-0-99" class="i">+}
</a><a href="#h2-0-100" id="h2-0-100" class="i">+
</a><a href="#h2-0-101" id="h2-0-101" class="i">+static void
</a><a href="#h2-0-102" id="h2-0-102" class="i">+documentloaded(WebKitWebPage *wp, Page *p)
</a><a href="#h2-0-103" id="h2-0-103" class="i">+{
</a><a href="#h2-0-104" id="h2-0-104" class="i">+	p-&gt;view = webkit_dom_document_get_default_view(
</a><a href="#h2-0-105" id="h2-0-105" class="i">+	          webkit_web_page_get_dom_document(wp));
</a><a href="#h2-0-106" id="h2-0-106" class="i">+}
</a><a href="#h2-0-107" id="h2-0-107" class="i">+
</a><a href="#h2-0-108" id="h2-0-108" class="i">+static void
</a><a href="#h2-0-109" id="h2-0-109" class="i">+webpagecreated(WebKitWebExtension *e, WebKitWebPage *wp, gpointer unused)
</a><a href="#h2-0-110" id="h2-0-110" class="i">+{
</a><a href="#h2-0-111" id="h2-0-111" class="i">+	Page *p = newpage(wp);
</a><a href="#h2-0-112" id="h2-0-112" class="i">+
</a><a href="#h2-0-113" id="h2-0-113" class="i">+	g_signal_connect(wp, &quot;document-loaded&quot;, G_CALLBACK(documentloaded), p);
</a><a href="#h2-0-114" id="h2-0-114" class="i">+}
</a> 
 G_MODULE_EXPORT void
<a href="#h2-0-117" id="h2-0-117" class="d">-webkit_web_extension_initialize(WebKitWebExtension *e)
</a><a href="#h2-0-118" id="h2-0-118" class="i">+webkit_web_extension_initialize_with_user_data(WebKitWebExtension *e, GVariant *gv)
</a> {
<a href="#h2-0-120" id="h2-0-120" class="d">-	return;
</a><a href="#h2-0-121" id="h2-0-121" class="i">+	GIOChannel *gchanpipe;
</a><a href="#h2-0-122" id="h2-0-122" class="i">+
</a><a href="#h2-0-123" id="h2-0-123" class="i">+	g_signal_connect(e, &quot;page-created&quot;, G_CALLBACK(webpagecreated), NULL);
</a><a href="#h2-0-124" id="h2-0-124" class="i">+
</a><a href="#h2-0-125" id="h2-0-125" class="i">+	g_variant_get(gv, &quot;(ii)&quot;, &amp;pipein, &amp;pipeout);
</a><a href="#h2-0-126" id="h2-0-126" class="i">+	msgsurf(NULL, &quot;i&quot;);
</a><a href="#h2-0-127" id="h2-0-127" class="i">+
</a><a href="#h2-0-128" id="h2-0-128" class="i">+	gchanpipe = g_io_channel_unix_new(pipein);
</a><a href="#h2-0-129" id="h2-0-129" class="i">+	g_io_channel_set_encoding(gchanpipe, NULL, NULL);
</a><a href="#h2-0-130" id="h2-0-130" class="i">+	g_io_channel_set_close_on_unref(gchanpipe, TRUE);
</a><a href="#h2-0-131" id="h2-0-131" class="i">+	g_io_add_watch(gchanpipe, G_IO_IN, readpipe, NULL);
</a> }
<b>diff --git a/<a id="h3" href="../file/surf.c.html">surf.c</a> b/<a href="../file/surf.c.html">surf.c</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -11,7 +11,6 @@
</a> #include &lt;pwd.h&gt;
 #include &lt;regex.h&gt;
 #include &lt;signal.h&gt;
<a href="#h3-0-3" id="h3-0-3" class="d">-#include &lt;stdarg.h&gt;
</a> #include &lt;stdio.h&gt;
 #include &lt;stdlib.h&gt;
 #include &lt;string.h&gt;
<a href="#h3-1" id="h3-1" class="h">@@ -28,11 +27,13 @@
</a> #include &lt;webkit2/webkit2.h&gt;
 #include &lt;X11/X.h&gt;
 #include &lt;X11/Xatom.h&gt;
<a href="#h3-1-3" id="h3-1-3" class="i">+#include &lt;glib.h&gt;
</a> 
 #include &quot;arg.h&quot;
 
 #define LENGTH(x)               (sizeof(x) / sizeof(x[0]))
 #define CLEANMASK(mask)         (mask &amp; (MODKEY|GDK_SHIFT_MASK))
<a href="#h3-1-9" id="h3-1-9" class="i">+#define MSGBUFSZ 32
</a> 
 enum { AtomFind, AtomGo, AtomUri, AtomLast };
 
<a href="#h3-2" id="h3-2" class="h">@@ -104,6 +105,7 @@ typedef struct Client {
</a> 	GTlsCertificate *cert, *failedcert;
 	GTlsCertificateFlags tlserr;
 	Window xid;
<a href="#h3-2-3" id="h3-2-3" class="i">+	unsigned long pageid;
</a> 	int progress, fullscreen, https, insecure, errorpage;
 	const char *title, *overtitle, *targeturi;
 	const char *needle;
<a href="#h3-3" id="h3-3" class="h">@@ -171,6 +173,7 @@ static void updatewinid(Client *c);
</a> static void handleplumb(Client *c, const char *uri);
 static void newwindow(Client *c, const Arg *a, int noembed);
 static void spawn(Client *c, const Arg *a);
<a href="#h3-3-3" id="h3-3-3" class="i">+static void msgext(Client *c, char type, const Arg *a);
</a> static void destroyclient(Client *c);
 static void cleanup(void);
 
<a href="#h3-4" id="h3-4" class="h">@@ -183,6 +186,7 @@ static gboolean buttonreleased(GtkWidget *w, GdkEvent *e, Client *c);
</a> static GdkFilterReturn processx(GdkXEvent *xevent, GdkEvent *event,
                                 gpointer d);
 static gboolean winevent(GtkWidget *w, GdkEvent *e, Client *c);
<a href="#h3-4-3" id="h3-4-3" class="i">+static gboolean readpipe(GIOChannel *s, GIOCondition ioc, gpointer unused);
</a> static void showview(WebKitWebView *v, Client *c);
 static GtkWidget *createwindow(Client *c);
 static gboolean loadfailedtls(WebKitWebView *v, gchar *uri,
<a href="#h3-5" id="h3-5" class="h">@@ -219,7 +223,8 @@ static void print(Client *c, const Arg *a);
</a> static void showcert(Client *c, const Arg *a);
 static void clipboard(Client *c, const Arg *a);
 static void zoom(Client *c, const Arg *a);
<a href="#h3-5-3" id="h3-5-3" class="d">-static void scroll(Client *c, const Arg *a);
</a><a href="#h3-5-4" id="h3-5-4" class="i">+static void scrollv(Client *c, const Arg *a);
</a><a href="#h3-5-5" id="h3-5-5" class="i">+static void scrollh(Client *c, const Arg *a);
</a> static void navigate(Client *c, const Arg *a);
 static void stop(Client *c, const Arg *a);
 static void toggle(Client *c, const Arg *a);
<a href="#h3-6" id="h3-6" class="h">@@ -247,6 +252,7 @@ static char *stylefile;
</a> static const char *useragent;
 static Parameter *curconfig;
 static int modparams[ParameterLast];
<a href="#h3-6-3" id="h3-6-3" class="i">+static int pipein[2], pipeout[2];
</a> char *argv0;
 
 static ParamName loadtransient[] = {
<a href="#h3-7" id="h3-7" class="h">@@ -318,6 +324,7 @@ die(const char *errstr, ...)
</a> void
 setup(void)
 {
<a href="#h3-7-3" id="h3-7-3" class="i">+	GIOChannel *gchanin;
</a> 	GdkDisplay *gdpy;
 	int i, j;
 
<a href="#h3-8" id="h3-8" class="h">@@ -348,6 +355,16 @@ setup(void)
</a> 
 	gdkkb = gdk_seat_get_keyboard(gdk_display_get_default_seat(gdpy));
 
<a href="#h3-8-3" id="h3-8-3" class="i">+	if (pipe(pipeout) &lt; 0 || pipe(pipein) &lt; 0) {
</a><a href="#h3-8-4" id="h3-8-4" class="i">+		fputs(&quot;Unable to create pipes\n&quot;, stderr);
</a><a href="#h3-8-5" id="h3-8-5" class="i">+	} else {
</a><a href="#h3-8-6" id="h3-8-6" class="i">+		gchanin = g_io_channel_unix_new(pipein[0]);
</a><a href="#h3-8-7" id="h3-8-7" class="i">+		g_io_channel_set_encoding(gchanin, NULL, NULL);
</a><a href="#h3-8-8" id="h3-8-8" class="i">+		g_io_channel_set_close_on_unref(gchanin, TRUE);
</a><a href="#h3-8-9" id="h3-8-9" class="i">+		g_io_add_watch(gchanin, G_IO_IN, readpipe, NULL);
</a><a href="#h3-8-10" id="h3-8-10" class="i">+	}
</a><a href="#h3-8-11" id="h3-8-11" class="i">+
</a><a href="#h3-8-12" id="h3-8-12" class="i">+
</a> 	for (i = 0; i &lt; LENGTH(certs); ++i) {
 		if (!regcomp(&amp;(certs[i].re), certs[i].regex, REG_EXTENDED)) {
 			certs[i].file = g_strconcat(certdir, &quot;/&quot;, certs[i].file,
<a href="#h3-9" id="h3-9" class="h">@@ -1033,6 +1050,8 @@ spawn(Client *c, const Arg *a)
</a> 	if (fork() == 0) {
 		if (dpy)
 			close(ConnectionNumber(dpy));
<a href="#h3-9-3" id="h3-9-3" class="i">+		close(pipein[0]);
</a><a href="#h3-9-4" id="h3-9-4" class="i">+		close(pipeout[1]);
</a> 		setsid();
 		execvp(((char **)a-&gt;v)[0], (char **)a-&gt;v);
 		fprintf(stderr, &quot;%s: execvp %s&quot;, argv0, ((char **)a-&gt;v)[0]);
<a href="#h3-10" id="h3-10" class="h">@@ -1065,6 +1084,9 @@ cleanup(void)
</a> {
 	while (clients)
 		destroyclient(clients);
<a href="#h3-10-3" id="h3-10-3" class="i">+
</a><a href="#h3-10-4" id="h3-10-4" class="i">+	close(pipein[0]);
</a><a href="#h3-10-5" id="h3-10-5" class="i">+	close(pipeout[1]);
</a> 	g_free(cookiefile);
 	g_free(scriptfile);
 	g_free(stylefile);
<a href="#h3-11" id="h3-11" class="h">@@ -1077,14 +1099,13 @@ newview(Client *c, WebKitWebView *rv)
</a> {
 	WebKitWebView *v;
 	WebKitSettings *settings;
<a href="#h3-11-3" id="h3-11-3" class="d">-	WebKitUserContentManager *contentmanager;
</a> 	WebKitWebContext *context;
 	WebKitCookieManager *cookiemanager;
<a href="#h3-11-6" id="h3-11-6" class="i">+	WebKitUserContentManager *contentmanager;
</a> 
 	/* Webview */
 	if (rv) {
<a href="#h3-11-10" id="h3-11-10" class="d">-		v = WEBKIT_WEB_VIEW(
</a><a href="#h3-11-11" id="h3-11-11" class="d">-		    webkit_web_view_new_with_related_view(rv));
</a><a href="#h3-11-12" id="h3-11-12" class="i">+		v = WEBKIT_WEB_VIEW(webkit_web_view_new_with_related_view(rv));
</a> 	} else {
 		settings = webkit_settings_new_with_settings(
 		   &quot;allow-file-access-from-file-urls&quot;, curconfig[FileURLsCrossAccess].val.i,
<a href="#h3-12" id="h3-12" class="h">@@ -1197,9 +1218,43 @@ newview(Client *c, WebKitWebView *rv)
</a> 	return v;
 }
 
<a href="#h3-12-3" id="h3-12-3" class="i">+static gboolean
</a><a href="#h3-12-4" id="h3-12-4" class="i">+readpipe(GIOChannel *s, GIOCondition ioc, gpointer unused)
</a><a href="#h3-12-5" id="h3-12-5" class="i">+{
</a><a href="#h3-12-6" id="h3-12-6" class="i">+	char msg[MSGBUFSZ];
</a><a href="#h3-12-7" id="h3-12-7" class="i">+	gsize msgsz;
</a><a href="#h3-12-8" id="h3-12-8" class="i">+	GError *gerr = NULL;
</a><a href="#h3-12-9" id="h3-12-9" class="i">+
</a><a href="#h3-12-10" id="h3-12-10" class="i">+	if (g_io_channel_read_chars(s, msg, sizeof(msg), &amp;msgsz, &amp;gerr) !=
</a><a href="#h3-12-11" id="h3-12-11" class="i">+	    G_IO_STATUS_NORMAL) {
</a><a href="#h3-12-12" id="h3-12-12" class="i">+		fprintf(stderr, &quot;surf: error reading pipe: %s\n&quot;,
</a><a href="#h3-12-13" id="h3-12-13" class="i">+		        gerr-&gt;message);
</a><a href="#h3-12-14" id="h3-12-14" class="i">+		g_error_free(gerr);
</a><a href="#h3-12-15" id="h3-12-15" class="i">+		return TRUE;
</a><a href="#h3-12-16" id="h3-12-16" class="i">+	}
</a><a href="#h3-12-17" id="h3-12-17" class="i">+	msg[msgsz] = &#39;\0&#39;;
</a><a href="#h3-12-18" id="h3-12-18" class="i">+
</a><a href="#h3-12-19" id="h3-12-19" class="i">+	switch (msg[1]) {
</a><a href="#h3-12-20" id="h3-12-20" class="i">+	case &#39;i&#39;:
</a><a href="#h3-12-21" id="h3-12-21" class="i">+		close(pipein[1]);
</a><a href="#h3-12-22" id="h3-12-22" class="i">+		close(pipeout[0]);
</a><a href="#h3-12-23" id="h3-12-23" class="i">+		break;
</a><a href="#h3-12-24" id="h3-12-24" class="i">+	}
</a><a href="#h3-12-25" id="h3-12-25" class="i">+
</a><a href="#h3-12-26" id="h3-12-26" class="i">+	return TRUE;
</a><a href="#h3-12-27" id="h3-12-27" class="i">+}
</a><a href="#h3-12-28" id="h3-12-28" class="i">+
</a> void
 initwebextensions(WebKitWebContext *wc, Client *c)
 {
<a href="#h3-12-32" id="h3-12-32" class="i">+	GVariant *gv;
</a><a href="#h3-12-33" id="h3-12-33" class="i">+
</a><a href="#h3-12-34" id="h3-12-34" class="i">+	if (!pipeout[0] || !pipein[1])
</a><a href="#h3-12-35" id="h3-12-35" class="i">+		return;
</a><a href="#h3-12-36" id="h3-12-36" class="i">+
</a><a href="#h3-12-37" id="h3-12-37" class="i">+	gv = g_variant_new(&quot;(ii)&quot;, pipeout[0], pipein[1]);
</a><a href="#h3-12-38" id="h3-12-38" class="i">+
</a><a href="#h3-12-39" id="h3-12-39" class="i">+	webkit_web_context_set_web_extensions_initialization_user_data(wc, gv);
</a> 	webkit_web_context_set_web_extensions_directory(wc, WEBEXTDIR);
 }
 
<a href="#h3-13" id="h3-13" class="h">@@ -1326,6 +1381,7 @@ showview(WebKitWebView *v, Client *c)
</a> 	c-&gt;finder = webkit_web_view_get_find_controller(c-&gt;view);
 	c-&gt;inspector = webkit_web_view_get_inspector(c-&gt;view);
 
<a href="#h3-13-3" id="h3-13-3" class="i">+	c-&gt;pageid = webkit_web_view_get_page_id(c-&gt;view);
</a> 	c-&gt;win = createwindow(c);
 
 	gtk_container_add(GTK_CONTAINER(c-&gt;win), GTK_WIDGET(c-&gt;view));
<a href="#h3-14" id="h3-14" class="h">@@ -1375,8 +1431,7 @@ createwindow(Client *c)
</a> 		gtk_window_set_wmclass(GTK_WINDOW(w), wmstr, &quot;Surf&quot;);
 		g_free(wmstr);
 
<a href="#h3-14-3" id="h3-14-3" class="d">-		wmstr = g_strdup_printf(&quot;%s[%lu]&quot;, &quot;Surf&quot;,
</a><a href="#h3-14-4" id="h3-14-4" class="d">-		        webkit_web_view_get_page_id(c-&gt;view));
</a><a href="#h3-14-5" id="h3-14-5" class="i">+		wmstr = g_strdup_printf(&quot;%s[%lu]&quot;, &quot;Surf&quot;, c-&gt;pageid);
</a> 		gtk_window_set_role(GTK_WINDOW(w), wmstr);
 		g_free(wmstr);
 
<a href="#h3-15" id="h3-15" class="h">@@ -1797,38 +1852,27 @@ zoom(Client *c, const Arg *a)
</a> 	curconfig[ZoomLevel].val.f = webkit_web_view_get_zoom_level(c-&gt;view);
 }
 
<a href="#h3-15-3" id="h3-15-3" class="d">-void
</a><a href="#h3-15-4" id="h3-15-4" class="d">-scroll(Client *c, const Arg *a)
</a><a href="#h3-15-5" id="h3-15-5" class="i">+static void
</a><a href="#h3-15-6" id="h3-15-6" class="i">+msgext(Client *c, char type, const Arg *a)
</a> {
<a href="#h3-15-8" id="h3-15-8" class="d">-	GdkEvent *ev = gdk_event_new(GDK_KEY_PRESS);
</a><a href="#h3-15-9" id="h3-15-9" class="i">+	char msg[MSGBUFSZ] = { c-&gt;pageid, type, a-&gt;i, &#39;\0&#39; };
</a> 
<a href="#h3-15-11" id="h3-15-11" class="d">-	gdk_event_set_device(ev, gdkkb);
</a><a href="#h3-15-12" id="h3-15-12" class="d">-	ev-&gt;key.window = gtk_widget_get_window(GTK_WIDGET(c-&gt;win));
</a><a href="#h3-15-13" id="h3-15-13" class="d">-	ev-&gt;key.state = GDK_CONTROL_MASK;
</a><a href="#h3-15-14" id="h3-15-14" class="d">-	ev-&gt;key.time = GDK_CURRENT_TIME;
</a><a href="#h3-15-15" id="h3-15-15" class="d">-
</a><a href="#h3-15-16" id="h3-15-16" class="d">-	switch (a-&gt;i) {
</a><a href="#h3-15-17" id="h3-15-17" class="d">-	case &#39;d&#39;:
</a><a href="#h3-15-18" id="h3-15-18" class="d">-		ev-&gt;key.keyval = GDK_KEY_Down;
</a><a href="#h3-15-19" id="h3-15-19" class="d">-		break;
</a><a href="#h3-15-20" id="h3-15-20" class="d">-	case &#39;D&#39;:
</a><a href="#h3-15-21" id="h3-15-21" class="d">-		ev-&gt;key.keyval = GDK_KEY_Page_Down;
</a><a href="#h3-15-22" id="h3-15-22" class="d">-		break;
</a><a href="#h3-15-23" id="h3-15-23" class="d">-	case &#39;l&#39;:
</a><a href="#h3-15-24" id="h3-15-24" class="d">-		ev-&gt;key.keyval = GDK_KEY_Left;
</a><a href="#h3-15-25" id="h3-15-25" class="d">-		break;
</a><a href="#h3-15-26" id="h3-15-26" class="d">-	case &#39;r&#39;:
</a><a href="#h3-15-27" id="h3-15-27" class="d">-		ev-&gt;key.keyval = GDK_KEY_Right;
</a><a href="#h3-15-28" id="h3-15-28" class="d">-		break;
</a><a href="#h3-15-29" id="h3-15-29" class="d">-	case &#39;U&#39;:
</a><a href="#h3-15-30" id="h3-15-30" class="d">-		ev-&gt;key.keyval = GDK_KEY_Page_Up;
</a><a href="#h3-15-31" id="h3-15-31" class="d">-		break;
</a><a href="#h3-15-32" id="h3-15-32" class="d">-	case &#39;u&#39;:
</a><a href="#h3-15-33" id="h3-15-33" class="d">-		ev-&gt;key.keyval = GDK_KEY_Up;
</a><a href="#h3-15-34" id="h3-15-34" class="d">-		break;
</a><a href="#h3-15-35" id="h3-15-35" class="i">+	if (pipeout[1]) {
</a><a href="#h3-15-36" id="h3-15-36" class="i">+		if (write(pipeout[1], msg, sizeof(msg)) &lt; 0)
</a><a href="#h3-15-37" id="h3-15-37" class="i">+			fprintf(stderr, &quot;surf: error sending: %s\n&quot;, msg);
</a> 	}
<a href="#h3-15-39" id="h3-15-39" class="i">+}
</a><a href="#h3-15-40" id="h3-15-40" class="i">+
</a><a href="#h3-15-41" id="h3-15-41" class="i">+void
</a><a href="#h3-15-42" id="h3-15-42" class="i">+scrollv(Client *c, const Arg *a)
</a><a href="#h3-15-43" id="h3-15-43" class="i">+{
</a><a href="#h3-15-44" id="h3-15-44" class="i">+	msgext(c, &#39;v&#39;, a);
</a><a href="#h3-15-45" id="h3-15-45" class="i">+}
</a> 
<a href="#h3-15-47" id="h3-15-47" class="d">-	gdk_event_put(ev);
</a><a href="#h3-15-48" id="h3-15-48" class="i">+void
</a><a href="#h3-15-49" id="h3-15-49" class="i">+scrollh(Client *c, const Arg *a)
</a><a href="#h3-15-50" id="h3-15-50" class="i">+{
</a><a href="#h3-15-51" id="h3-15-51" class="i">+	msgext(c, &#39;h&#39;, a);
</a> }
 
 void
</pre>
</div>
</body>
</html>
