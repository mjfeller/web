<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>merge - surf - surf browser, a WebKit based browser
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="surf Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>surf</h1><span class="desc">surf browser, a WebKit based browser
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/80d33d696d73c14c81da6e35ab06ee97517c9852.html">80d33d696d73c14c81da6e35ab06ee97517c9852</a>
<b>parent</b> <a href="../commit/2448c967f6fed9cc8f570ec2df3f1d59b714e33e.html">2448c967f6fed9cc8f570ec2df3f1d59b714e33e</a>
<b>Author:</b> Enno Boland (tox) &lt;<a href="mailto:tox@s01.de">tox@s01.de</a>&gt;
<b>Date:</b>   Sun,  6 Sep 2009 13:49:17 +0200

merge
<b>Diffstat:</b>
<table><tr><td class="A">A</td><td><a href="#h0">config.h</a></td><td> | </td><td class="num">46</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">surf.c</a></td><td> | </td><td class="num">252</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------</span></td></tr>
</table></pre><pre>2 files changed, 191 insertions(+), 107 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config.h.html">config.h</a> b/<a href="../file/config.h.html">config.h</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -0,0 +1,46 @@
</a><a href="#h0-0-0" id="h0-0-0" class="i">+/* modifier 0 means no modifier */
</a><a href="#h0-0-1" id="h0-0-1" class="i">+static Key searchbar_keys[] = {
</a><a href="#h0-0-2" id="h0-0-2" class="i">+    /* modifier	            keyval      function        arg         stop event */
</a><a href="#h0-0-3" id="h0-0-3" class="i">+    { 0,                    GDK_Escape, hidesearch,     {0},            TRUE },
</a><a href="#h0-0-4" id="h0-0-4" class="i">+    { 0,                    GDK_Return, searchtext,     {.b = TRUE},    TRUE },
</a><a href="#h0-0-5" id="h0-0-5" class="i">+    { GDK_SHIFT_MASK,       GDK_Return, searchtext,     {.b = FALSE},   TRUE },
</a><a href="#h0-0-6" id="h0-0-6" class="i">+    { GDK_SHIFT_MASK,       GDK_Left,   NULL,           {0},            FALSE },
</a><a href="#h0-0-7" id="h0-0-7" class="i">+    { GDK_SHIFT_MASK,       GDK_Right,  NULL,           {0},            FALSE },
</a><a href="#h0-0-8" id="h0-0-8" class="i">+};
</a><a href="#h0-0-9" id="h0-0-9" class="i">+
</a><a href="#h0-0-10" id="h0-0-10" class="i">+static Key urlbar_keys[] = {
</a><a href="#h0-0-11" id="h0-0-11" class="i">+    /* modifier	            keyval      function        arg         stop event */
</a><a href="#h0-0-12" id="h0-0-12" class="i">+    { 0,                    GDK_Escape, hideurl,        {0},            TRUE },
</a><a href="#h0-0-13" id="h0-0-13" class="i">+        /* able to &quot;chain&quot; commands; by setting stop event to FALSE */
</a><a href="#h0-0-14" id="h0-0-14" class="i">+    { 0,                    GDK_Return, loaduri,        {.v = NULL},    FALSE },
</a><a href="#h0-0-15" id="h0-0-15" class="i">+    { 0,                    GDK_Return, hideurl,        {0},            TRUE },
</a><a href="#h0-0-16" id="h0-0-16" class="i">+    { GDK_SHIFT_MASK,       GDK_Left,   NULL,           {0},            FALSE },
</a><a href="#h0-0-17" id="h0-0-17" class="i">+    { GDK_SHIFT_MASK,       GDK_Right,  NULL,           {0},            FALSE },
</a><a href="#h0-0-18" id="h0-0-18" class="i">+};
</a><a href="#h0-0-19" id="h0-0-19" class="i">+
</a><a href="#h0-0-20" id="h0-0-20" class="i">+static Key general_keys[] = {
</a><a href="#h0-0-21" id="h0-0-21" class="i">+    /* modifier	            keyval      function        arg         stop event */
</a><a href="#h0-0-22" id="h0-0-22" class="i">+    { GDK_CONTROL_MASK,     GDK_p,      clipboard,      {.b = TRUE },   TRUE },
</a><a href="#h0-0-23" id="h0-0-23" class="i">+    { GDK_CONTROL_MASK,     GDK_y,      clipboard,      {.b = FALSE},   TRUE },
</a><a href="#h0-0-24" id="h0-0-24" class="i">+    { GDK_CONTROL_MASK,     GDK_R,      reload,         {.b = TRUE},    TRUE },
</a><a href="#h0-0-25" id="h0-0-25" class="i">+    { GDK_CONTROL_MASK,     GDK_r,      reload,         {.b = FALSE},   TRUE },
</a><a href="#h0-0-26" id="h0-0-26" class="i">+    { GDK_CONTROL_MASK,     GDK_b,      NULL,           {0},            TRUE },
</a><a href="#h0-0-27" id="h0-0-27" class="i">+    { GDK_CONTROL_MASK,     GDK_g,      showurl,        {0},            TRUE },
</a><a href="#h0-0-28" id="h0-0-28" class="i">+    { GDK_CONTROL_MASK,     GDK_slash,  showsearch,     {0},            TRUE },
</a><a href="#h0-0-29" id="h0-0-29" class="i">+    { GDK_CONTROL_MASK,     GDK_plus,   zoompage,       {0},            TRUE },
</a><a href="#h0-0-30" id="h0-0-30" class="i">+    { GDK_CONTROL_MASK,     GDK_minus,  zoompage,       {.f = -1.0 },   TRUE },
</a><a href="#h0-0-31" id="h0-0-31" class="i">+    { GDK_CONTROL_MASK,     GDK_0,      zoompage,       {.f = +1.0 },   TRUE },
</a><a href="#h0-0-32" id="h0-0-32" class="i">+    { GDK_CONTROL_MASK,     GDK_n,      searchtext,     {.b = TRUE},    TRUE },
</a><a href="#h0-0-33" id="h0-0-33" class="i">+    { GDK_CONTROL_MASK,     GDK_N,      searchtext,     {.b = FALSE},   TRUE },
</a><a href="#h0-0-34" id="h0-0-34" class="i">+    { GDK_CONTROL_MASK,     GDK_Right,  navigate,       {.b = TRUE},    TRUE },
</a><a href="#h0-0-35" id="h0-0-35" class="i">+    { GDK_CONTROL_MASK,     GDK_Left,   navigate,       {.b = FALSE},   TRUE },
</a><a href="#h0-0-36" id="h0-0-36" class="i">+    { 0,                    GDK_Escape, stop,           {0},            TRUE },
</a><a href="#h0-0-37" id="h0-0-37" class="i">+};
</a><a href="#h0-0-38" id="h0-0-38" class="i">+
</a><a href="#h0-0-39" id="h0-0-39" class="i">+/* Sequence of Keys to match against a keypress */
</a><a href="#h0-0-40" id="h0-0-40" class="i">+static KeySet keysets[] = {
</a><a href="#h0-0-41" id="h0-0-41" class="i">+    /* keyset (Key[])   numkeys                     focusedwidget/mode */
</a><a href="#h0-0-42" id="h0-0-42" class="i">+    { searchbar_keys,   LENGTH(searchbar_keys),     SEARCHBAR },
</a><a href="#h0-0-43" id="h0-0-43" class="i">+    { urlbar_keys,      LENGTH(urlbar_keys),        URLBAR },
</a><a href="#h0-0-44" id="h0-0-44" class="i">+    { general_keys,     LENGTH(general_keys),       NONE },
</a><a href="#h0-0-45" id="h0-0-45" class="i">+};
</a><b>diff --git a/<a id="h1" href="../file/surf.c.html">surf.c</a> b/<a href="../file/surf.c.html">surf.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -20,6 +20,15 @@
</a> 
 Display *dpy;
 Atom urlprop;
<a href="#h1-0-3" id="h1-0-3" class="i">+typedef union Arg Arg;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+union Arg {
</a><a href="#h1-0-5" id="h1-0-5" class="i">+	const gboolean b;
</a><a href="#h1-0-6" id="h1-0-6" class="i">+	const int i;
</a><a href="#h1-0-7" id="h1-0-7" class="i">+	const unsigned int ui;
</a><a href="#h1-0-8" id="h1-0-8" class="i">+	const float f;
</a><a href="#h1-0-9" id="h1-0-9" class="i">+	const void *v;
</a><a href="#h1-0-10" id="h1-0-10" class="i">+} ;
</a><a href="#h1-0-11" id="h1-0-11" class="i">+
</a> typedef struct Client {
 	GtkWidget *win, *scroll, *vbox, *urlbar, *searchbar;
 	WebKitWebView *view;
<a href="#h1-1" id="h1-1" class="h">@@ -37,6 +46,26 @@ typedef struct Cookie {
</a> 	struct Cookie *next;
 } Cookie;
 
<a href="#h1-1-3" id="h1-1-3" class="i">+typedef struct {
</a><a href="#h1-1-4" id="h1-1-4" class="i">+	guint mod;
</a><a href="#h1-1-5" id="h1-1-5" class="i">+	guint keyval;
</a><a href="#h1-1-6" id="h1-1-6" class="i">+	void (*func)(Client *c, const Arg *arg);
</a><a href="#h1-1-7" id="h1-1-7" class="i">+	const Arg arg;
</a><a href="#h1-1-8" id="h1-1-8" class="i">+	gboolean stop; /* do not propagate keypress event/stop matching keys */
</a><a href="#h1-1-9" id="h1-1-9" class="i">+} Key;
</a><a href="#h1-1-10" id="h1-1-10" class="i">+
</a><a href="#h1-1-11" id="h1-1-11" class="i">+typedef enum {
</a><a href="#h1-1-12" id="h1-1-12" class="i">+    NONE,
</a><a href="#h1-1-13" id="h1-1-13" class="i">+    SEARCHBAR,
</a><a href="#h1-1-14" id="h1-1-14" class="i">+    URLBAR,
</a><a href="#h1-1-15" id="h1-1-15" class="i">+} Keypressmode;
</a><a href="#h1-1-16" id="h1-1-16" class="i">+
</a><a href="#h1-1-17" id="h1-1-17" class="i">+typedef struct {
</a><a href="#h1-1-18" id="h1-1-18" class="i">+	Key *keys;
</a><a href="#h1-1-19" id="h1-1-19" class="i">+	unsigned int numkeys;
</a><a href="#h1-1-20" id="h1-1-20" class="i">+	Keypressmode mode;
</a><a href="#h1-1-21" id="h1-1-21" class="i">+} KeySet;
</a><a href="#h1-1-22" id="h1-1-22" class="i">+
</a> SoupCookieJar *cookiejar;
 SoupSession *session;
 Client *clients = NULL;
<a href="#h1-2" id="h1-2" class="h">@@ -49,20 +78,22 @@ extern int optind;
</a> 
 static void cleanup(void);
 static void proccookies(SoupMessage *m, Client *c);
<a href="#h1-2-3" id="h1-2-3" class="i">+static void clipboard(Client *c, const Arg *arg);
</a> static void destroyclient(Client *c);
 static void destroywin(GtkWidget* w, Client *c);
 static void die(char *str);
 static void download(WebKitDownload *o, GParamSpec *pspec, Client *c);
 static gboolean initdownload(WebKitWebView *view, WebKitDownload *o, Client *c);
 static gchar *geturi(Client *c);
<a href="#h1-2-10" id="h1-2-10" class="d">-static void hidesearch(Client *c);
</a><a href="#h1-2-11" id="h1-2-11" class="d">-static void hideurl(Client *c);
</a><a href="#h1-2-12" id="h1-2-12" class="i">+static void hidesearch(Client *c, const Arg *arg);
</a><a href="#h1-2-13" id="h1-2-13" class="i">+static void hideurl(Client *c, const Arg *arg);
</a> static gboolean keypress(GtkWidget* w, GdkEventKey *ev, Client *c);
 static void linkhover(WebKitWebView* page, const gchar* t, const gchar* l, Client *c);
 static void loadcommit(WebKitWebView *view, WebKitWebFrame *f, Client *c);
 static void loadstart(WebKitWebView *view, WebKitWebFrame *f, Client *c);
 static void loadfile(Client *c, const gchar *f);
<a href="#h1-2-19" id="h1-2-19" class="d">-static void loaduri(Client *c, const gchar *uri);
</a><a href="#h1-2-20" id="h1-2-20" class="i">+static void loaduri(Client *c, const Arg *arg);
</a><a href="#h1-2-21" id="h1-2-21" class="i">+static void navigate(Client *c, const Arg *arg);
</a> static Client *newclient();
 static WebKitWebView *newwindow(WebKitWebView  *v, WebKitWebFrame *f, Client *c);
 static void pasteurl(GtkClipboard *clipboard, const gchar *text, gpointer d);
<a href="#h1-3" id="h1-3" class="h">@@ -70,14 +101,20 @@ static GdkFilterReturn processx(GdkXEvent *xevent, GdkEvent *event, gpointer d);
</a> static void progresschange(WebKitWebView *view, gint p, Client *c);
 static void request(SoupSession *s, SoupMessage *m, Client *c);
 static void setcookie(char *name, char *val, char *dom, char *path, long exp);
<a href="#h1-3-3" id="h1-3-3" class="i">+static void reload(Client *c, const Arg *arg);
</a> static void setup(void);
<a href="#h1-3-5" id="h1-3-5" class="d">-static void showsearch(Client *c);
</a><a href="#h1-3-6" id="h1-3-6" class="d">-static void showurl(Client *c);
</a><a href="#h1-3-7" id="h1-3-7" class="d">-static void stop(Client *c);
</a> static void titlechange(WebKitWebView* view, WebKitWebFrame* frame,
 		const gchar* title, Client *c);
<a href="#h1-3-10" id="h1-3-10" class="i">+static void searchtext(Client *c, const Arg *arg);
</a><a href="#h1-3-11" id="h1-3-11" class="i">+static void showsearch(Client *c, const Arg *arg);
</a><a href="#h1-3-12" id="h1-3-12" class="i">+static void showurl(Client *c, const Arg *arg);
</a><a href="#h1-3-13" id="h1-3-13" class="i">+static void stop(Client *c, const Arg *arg);
</a><a href="#h1-3-14" id="h1-3-14" class="i">+static void titlechange(WebKitWebView* view, WebKitWebFrame* frame, const gchar* title, Client *c);
</a> static void usage();
 static void updatetitle(Client *c, const gchar *title);
<a href="#h1-3-17" id="h1-3-17" class="i">+static void zoompage(Client *c, const Arg *arg);
</a><a href="#h1-3-18" id="h1-3-18" class="i">+
</a><a href="#h1-3-19" id="h1-3-19" class="i">+#include &quot;config.h&quot;
</a> 
 void
 cleanup(void) {
<a href="#h1-4" id="h1-4" class="h">@@ -100,6 +137,15 @@ proccookies(SoupMessage *m, Client *c) {
</a> }
 
 void
<a href="#h1-4-3" id="h1-4-3" class="i">+clipboard(Client *c, const Arg *arg) {
</a><a href="#h1-4-4" id="h1-4-4" class="i">+	gboolean paste = *(gboolean *)arg;
</a><a href="#h1-4-5" id="h1-4-5" class="i">+	if(paste)
</a><a href="#h1-4-6" id="h1-4-6" class="i">+		gtk_clipboard_request_text(gtk_clipboard_get(GDK_SELECTION_PRIMARY), pasteurl, c);
</a><a href="#h1-4-7" id="h1-4-7" class="i">+	else
</a><a href="#h1-4-8" id="h1-4-8" class="i">+		gtk_clipboard_set_text(gtk_clipboard_get(GDK_SELECTION_PRIMARY), webkit_web_view_get_uri(c-&gt;view), -1);
</a><a href="#h1-4-9" id="h1-4-9" class="i">+}
</a><a href="#h1-4-10" id="h1-4-10" class="i">+
</a><a href="#h1-4-11" id="h1-4-11" class="i">+void
</a> destroyclient(Client *c) {
 	Client *p;
 
<a href="#h1-5" id="h1-5" class="h">@@ -146,7 +192,7 @@ initdownload(WebKitWebView *view, WebKitDownload *o, Client *c) {
</a> 	const gchar *home, *filename;
 	gchar *uri, *path, *html;
 
<a href="#h1-5-3" id="h1-5-3" class="d">-	stop(c);
</a><a href="#h1-5-4" id="h1-5-4" class="i">+	stop(c, NULL);
</a> 	c-&gt;download = o;
 	home = g_get_home_dir();
 	filename = webkit_download_get_suggested_filename(o);
<a href="#h1-6" id="h1-6" class="h">@@ -177,107 +223,52 @@ geturi(Client *c) {
</a> }
 
 void
<a href="#h1-6-3" id="h1-6-3" class="d">-hidesearch(Client *c) {
</a><a href="#h1-6-4" id="h1-6-4" class="i">+hidesearch(Client *c, const Arg *arg) {
</a> 	gtk_widget_hide(c-&gt;searchbar);
 	gtk_widget_grab_focus(GTK_WIDGET(c-&gt;view));
 }
 
 void
<a href="#h1-6-10" id="h1-6-10" class="d">-hideurl(Client *c) {
</a><a href="#h1-6-11" id="h1-6-11" class="i">+hideurl(Client *c, const Arg *arg) {
</a> 	gtk_widget_hide(c-&gt;urlbar);
 	gtk_widget_grab_focus(GTK_WIDGET(c-&gt;view));
 }
 
 gboolean
 keypress(GtkWidget* w, GdkEventKey *ev, Client *c) {
<a href="#h1-6-18" id="h1-6-18" class="i">+	unsigned int n, m;
</a><a href="#h1-6-19" id="h1-6-19" class="i">+
</a> 	if(ev-&gt;type != GDK_KEY_PRESS)
 		return FALSE;
<a href="#h1-6-22" id="h1-6-22" class="d">-	if(GTK_WIDGET_HAS_FOCUS(c-&gt;searchbar)) {
</a><a href="#h1-6-23" id="h1-6-23" class="d">-		switch(ev-&gt;keyval) {
</a><a href="#h1-6-24" id="h1-6-24" class="d">-		case GDK_Escape:
</a><a href="#h1-6-25" id="h1-6-25" class="d">-			hidesearch(c);
</a><a href="#h1-6-26" id="h1-6-26" class="d">-			return TRUE;
</a><a href="#h1-6-27" id="h1-6-27" class="d">-		case GDK_Return:
</a><a href="#h1-6-28" id="h1-6-28" class="d">-			webkit_web_view_search_text(c-&gt;view,
</a><a href="#h1-6-29" id="h1-6-29" class="d">-					gtk_entry_get_text(GTK_ENTRY(c-&gt;searchbar)),
</a><a href="#h1-6-30" id="h1-6-30" class="d">-					FALSE,
</a><a href="#h1-6-31" id="h1-6-31" class="d">-					!(ev-&gt;state &amp; GDK_SHIFT_MASK),
</a><a href="#h1-6-32" id="h1-6-32" class="d">-					TRUE);
</a><a href="#h1-6-33" id="h1-6-33" class="d">-			return TRUE;
</a><a href="#h1-6-34" id="h1-6-34" class="d">-		case GDK_Left:
</a><a href="#h1-6-35" id="h1-6-35" class="d">-		case GDK_Right:
</a><a href="#h1-6-36" id="h1-6-36" class="d">-			return FALSE;
</a><a href="#h1-6-37" id="h1-6-37" class="d">-		}
</a><a href="#h1-6-38" id="h1-6-38" class="d">-	}
</a><a href="#h1-6-39" id="h1-6-39" class="d">-	else if(GTK_WIDGET_HAS_FOCUS(c-&gt;urlbar)) {
</a><a href="#h1-6-40" id="h1-6-40" class="d">-		switch(ev-&gt;keyval) {
</a><a href="#h1-6-41" id="h1-6-41" class="d">-		case GDK_Escape:
</a><a href="#h1-6-42" id="h1-6-42" class="d">-			hideurl(c);
</a><a href="#h1-6-43" id="h1-6-43" class="d">-			return TRUE;
</a><a href="#h1-6-44" id="h1-6-44" class="d">-		case GDK_Return:
</a><a href="#h1-6-45" id="h1-6-45" class="d">-			loaduri(c, gtk_entry_get_text(GTK_ENTRY(c-&gt;urlbar)));
</a><a href="#h1-6-46" id="h1-6-46" class="d">-			hideurl(c);
</a><a href="#h1-6-47" id="h1-6-47" class="d">-			return TRUE;
</a><a href="#h1-6-48" id="h1-6-48" class="d">-		case GDK_Left:
</a><a href="#h1-6-49" id="h1-6-49" class="d">-		case GDK_Right:
</a><a href="#h1-6-50" id="h1-6-50" class="d">-			return FALSE;
</a><a href="#h1-6-51" id="h1-6-51" class="d">-		}
</a><a href="#h1-6-52" id="h1-6-52" class="d">-	}
</a><a href="#h1-6-53" id="h1-6-53" class="d">-	if(ev-&gt;state &amp; GDK_CONTROL_MASK) {
</a><a href="#h1-6-54" id="h1-6-54" class="d">-		switch(ev-&gt;keyval) {
</a><a href="#h1-6-55" id="h1-6-55" class="d">-		case GDK_P:
</a><a href="#h1-6-56" id="h1-6-56" class="d">-			webkit_web_frame_print(webkit_web_view_get_main_frame(c-&gt;view));
</a><a href="#h1-6-57" id="h1-6-57" class="d">-			return TRUE;
</a><a href="#h1-6-58" id="h1-6-58" class="d">-		case GDK_p:
</a><a href="#h1-6-59" id="h1-6-59" class="d">-			gtk_clipboard_request_text(gtk_clipboard_get(GDK_SELECTION_PRIMARY), pasteurl, c);
</a><a href="#h1-6-60" id="h1-6-60" class="d">-		case GDK_y:
</a><a href="#h1-6-61" id="h1-6-61" class="d">-			gtk_clipboard_set_text(gtk_clipboard_get(GDK_SELECTION_PRIMARY), webkit_web_view_get_uri(c-&gt;view), -1);
</a><a href="#h1-6-62" id="h1-6-62" class="d">-			return TRUE;
</a><a href="#h1-6-63" id="h1-6-63" class="d">-		case GDK_r:
</a><a href="#h1-6-64" id="h1-6-64" class="d">-			webkit_web_view_reload(c-&gt;view);
</a><a href="#h1-6-65" id="h1-6-65" class="d">-			return TRUE;
</a><a href="#h1-6-66" id="h1-6-66" class="d">-		case GDK_R:
</a><a href="#h1-6-67" id="h1-6-67" class="d">-			webkit_web_view_reload_bypass_cache(c-&gt;view);
</a><a href="#h1-6-68" id="h1-6-68" class="d">-			return TRUE;
</a><a href="#h1-6-69" id="h1-6-69" class="d">-		case GDK_b:
</a><a href="#h1-6-70" id="h1-6-70" class="d">-			return TRUE;
</a><a href="#h1-6-71" id="h1-6-71" class="d">-		case GDK_g:
</a><a href="#h1-6-72" id="h1-6-72" class="d">-			showurl(c);
</a><a href="#h1-6-73" id="h1-6-73" class="d">-			return TRUE;
</a><a href="#h1-6-74" id="h1-6-74" class="d">-		case GDK_slash:
</a><a href="#h1-6-75" id="h1-6-75" class="d">-			showsearch(c);
</a><a href="#h1-6-76" id="h1-6-76" class="d">-			return TRUE;
</a><a href="#h1-6-77" id="h1-6-77" class="d">-		case GDK_plus:
</a><a href="#h1-6-78" id="h1-6-78" class="d">-		case GDK_equal:
</a><a href="#h1-6-79" id="h1-6-79" class="d">-			webkit_web_view_zoom_in(c-&gt;view);
</a><a href="#h1-6-80" id="h1-6-80" class="d">-			return TRUE;
</a><a href="#h1-6-81" id="h1-6-81" class="d">-		case GDK_minus:
</a><a href="#h1-6-82" id="h1-6-82" class="d">-			webkit_web_view_zoom_out(c-&gt;view);
</a><a href="#h1-6-83" id="h1-6-83" class="d">-			return TRUE;
</a><a href="#h1-6-84" id="h1-6-84" class="d">-		case GDK_0:
</a><a href="#h1-6-85" id="h1-6-85" class="d">-			webkit_web_view_set_zoom_level(c-&gt;view, 1.0);
</a><a href="#h1-6-86" id="h1-6-86" class="d">-			return TRUE;
</a><a href="#h1-6-87" id="h1-6-87" class="d">-		case GDK_n:
</a><a href="#h1-6-88" id="h1-6-88" class="d">-		case GDK_N:
</a><a href="#h1-6-89" id="h1-6-89" class="d">-			webkit_web_view_search_text(c-&gt;view,
</a><a href="#h1-6-90" id="h1-6-90" class="d">-					gtk_entry_get_text(GTK_ENTRY(c-&gt;searchbar)),
</a><a href="#h1-6-91" id="h1-6-91" class="d">-					FALSE,
</a><a href="#h1-6-92" id="h1-6-92" class="d">-					!(ev-&gt;state &amp; GDK_SHIFT_MASK),
</a><a href="#h1-6-93" id="h1-6-93" class="d">-					TRUE);
</a><a href="#h1-6-94" id="h1-6-94" class="d">-			return TRUE;
</a><a href="#h1-6-95" id="h1-6-95" class="d">-		case GDK_h:
</a><a href="#h1-6-96" id="h1-6-96" class="d">-			webkit_web_view_go_back(c-&gt;view);
</a><a href="#h1-6-97" id="h1-6-97" class="d">-			return TRUE;
</a><a href="#h1-6-98" id="h1-6-98" class="d">-		case GDK_l:
</a><a href="#h1-6-99" id="h1-6-99" class="d">-			webkit_web_view_go_forward(c-&gt;view);
</a><a href="#h1-6-100" id="h1-6-100" class="d">-			return TRUE;
</a><a href="#h1-6-101" id="h1-6-101" class="i">+
</a><a href="#h1-6-102" id="h1-6-102" class="i">+	for(n = 0; n &lt; LENGTH(keysets); n++)
</a><a href="#h1-6-103" id="h1-6-103" class="i">+		switch(keysets[n].mode) {
</a><a href="#h1-6-104" id="h1-6-104" class="i">+		case SEARCHBAR:
</a><a href="#h1-6-105" id="h1-6-105" class="i">+			if(GTK_WIDGET_HAS_FOCUS(c-&gt;searchbar))
</a><a href="#h1-6-106" id="h1-6-106" class="i">+				goto matchkeys;
</a><a href="#h1-6-107" id="h1-6-107" class="i">+			break;
</a><a href="#h1-6-108" id="h1-6-108" class="i">+		case URLBAR:
</a><a href="#h1-6-109" id="h1-6-109" class="i">+			if(GTK_WIDGET_HAS_FOCUS(c-&gt;urlbar))
</a><a href="#h1-6-110" id="h1-6-110" class="i">+				goto matchkeys;
</a><a href="#h1-6-111" id="h1-6-111" class="i">+			break;
</a><a href="#h1-6-112" id="h1-6-112" class="i">+		case NONE:
</a><a href="#h1-6-113" id="h1-6-113" class="i">+			goto matchkeys;
</a><a href="#h1-6-114" id="h1-6-114" class="i">+		default:
</a><a href="#h1-6-115" id="h1-6-115" class="i">+			fprintf(stderr, &quot;keypress(): Unknown Keypressmode\n&quot;);
</a><a href="#h1-6-116" id="h1-6-116" class="i">+			break;
</a> 		}
<a href="#h1-6-118" id="h1-6-118" class="d">-	}
</a><a href="#h1-6-119" id="h1-6-119" class="d">-	else {
</a><a href="#h1-6-120" id="h1-6-120" class="d">-		switch(ev-&gt;keyval) {
</a><a href="#h1-6-121" id="h1-6-121" class="d">-		case GDK_Escape:
</a><a href="#h1-6-122" id="h1-6-122" class="d">-			stop(c);
</a><a href="#h1-6-123" id="h1-6-123" class="d">-			return TRUE;
</a><a href="#h1-6-124" id="h1-6-124" class="i">+	if(n &lt; LENGTH(keysets)) {
</a><a href="#h1-6-125" id="h1-6-125" class="i">+matchkeys:
</a><a href="#h1-6-126" id="h1-6-126" class="i">+		for(m = 0; m &lt; keysets[n].numkeys; m++) {
</a><a href="#h1-6-127" id="h1-6-127" class="i">+			Key *keys = keysets[n].keys;
</a><a href="#h1-6-128" id="h1-6-128" class="i">+			if(ev-&gt;keyval == keys[m].keyval
</a><a href="#h1-6-129" id="h1-6-129" class="i">+			   &amp;&amp; (ev-&gt;state == keys[m].mod
</a><a href="#h1-6-130" id="h1-6-130" class="i">+			       || (ev-&gt;state &amp; keys[m].mod))
</a><a href="#h1-6-131" id="h1-6-131" class="i">+			   &amp;&amp; keys[m].func) {
</a><a href="#h1-6-132" id="h1-6-132" class="i">+				keys[m].func(c, &amp;(keys[m].arg));
</a><a href="#h1-6-133" id="h1-6-133" class="i">+				if(keys[m].stop)
</a><a href="#h1-6-134" id="h1-6-134" class="i">+					return TRUE;
</a><a href="#h1-6-135" id="h1-6-135" class="i">+			}
</a> 		}
 	}
 	return FALSE;
<a href="#h1-7" id="h1-7" class="h">@@ -314,6 +305,7 @@ loadfile(Client *c, const gchar *f) {
</a> 	GError *e = NULL;
 	GString *code;
 	gchar *line, *uri;
<a href="#h1-7-3" id="h1-7-3" class="i">+	Arg arg;
</a> 
 	if(strcmp(f, &quot;-&quot;) == 0) {
 		chan = g_io_channel_unix_new(STDIN_FILENO);
<a href="#h1-8" id="h1-8" class="h">@@ -329,19 +321,22 @@ loadfile(Client *c, const gchar *f) {
</a> 			g_io_channel_shutdown(chan, FALSE, NULL);
 			g_string_free(code, TRUE);
 		}
<a href="#h1-8-3" id="h1-8-3" class="d">-		uri = g_strdup(&quot;stdin&quot;);
</a><a href="#h1-8-4" id="h1-8-4" class="i">+		arg.v = uri = g_strdup(&quot;stdin&quot;);
</a> 	}
 	else {
<a href="#h1-8-7" id="h1-8-7" class="d">-		uri = g_strdup_printf(&quot;file://%s&quot;, f);
</a><a href="#h1-8-8" id="h1-8-8" class="d">-		loaduri(c, uri);
</a><a href="#h1-8-9" id="h1-8-9" class="i">+		arg.v = uri = g_strdup_printf(&quot;file://%s&quot;, f);
</a><a href="#h1-8-10" id="h1-8-10" class="i">+		loaduri(c, &amp;arg);
</a> 	}
 	updatetitle(c, uri);
 	g_free(uri);
 }
 
 void
<a href="#h1-8-17" id="h1-8-17" class="d">-loaduri(Client *c, const gchar *uri) {
</a><a href="#h1-8-18" id="h1-8-18" class="i">+loaduri(Client *c, const Arg *arg) {
</a> 	gchar *u;
<a href="#h1-8-20" id="h1-8-20" class="i">+	const gchar *uri = (gchar *)arg-&gt;v;
</a><a href="#h1-8-21" id="h1-8-21" class="i">+	if(!uri)
</a><a href="#h1-8-22" id="h1-8-22" class="i">+		uri = gtk_entry_get_text(GTK_ENTRY(c-&gt;urlbar));
</a> 	u = g_strrstr(uri, &quot;://&quot;) ? g_strdup(uri)
 		: g_strdup_printf(&quot;http://%s&quot;, uri);
 	webkit_web_view_load_uri(c-&gt;view, u);
<a href="#h1-9" id="h1-9" class="h">@@ -350,6 +345,15 @@ loaduri(Client *c, const gchar *uri) {
</a> 	g_free(u);
 }
 
<a href="#h1-9-3" id="h1-9-3" class="i">+void
</a><a href="#h1-9-4" id="h1-9-4" class="i">+navigate(Client *c, const Arg *arg) {
</a><a href="#h1-9-5" id="h1-9-5" class="i">+	gboolean forward = *(gboolean *)arg;
</a><a href="#h1-9-6" id="h1-9-6" class="i">+	if(forward)
</a><a href="#h1-9-7" id="h1-9-7" class="i">+		webkit_web_view_go_forward(c-&gt;view);
</a><a href="#h1-9-8" id="h1-9-8" class="i">+	else
</a><a href="#h1-9-9" id="h1-9-9" class="i">+		webkit_web_view_go_back(c-&gt;view);
</a><a href="#h1-9-10" id="h1-9-10" class="i">+}
</a><a href="#h1-9-11" id="h1-9-11" class="i">+
</a> Client *
 newclient(void) {
 	Client *c;
<a href="#h1-10" id="h1-10" class="h">@@ -435,8 +439,9 @@ newwindow(WebKitWebView  *v, WebKitWebFrame *f, Client *c) {
</a>  
 void
 pasteurl(GtkClipboard *clipboard, const gchar *text, gpointer d) {
<a href="#h1-10-3" id="h1-10-3" class="i">+	Arg arg = {.v = text };
</a> 	if(text != NULL)
<a href="#h1-10-5" id="h1-10-5" class="d">-		loaduri((Client *) d, text);
</a><a href="#h1-10-6" id="h1-10-6" class="i">+		loaduri((Client *) d, &amp;arg);
</a> }
 
 GdkFilterReturn
<a href="#h1-11" id="h1-11" class="h">@@ -447,6 +452,7 @@ processx(GdkXEvent *e, GdkEvent *event, gpointer d) {
</a> 	int idummy;
 	unsigned long ldummy;
 	unsigned char *buf = NULL;
<a href="#h1-11-3" id="h1-11-3" class="i">+	Arg arg;
</a> 
 	if(((XEvent *)e)-&gt;type == PropertyNotify) {
 		ev = &amp;((XEvent *)e)-&gt;xproperty;
<a href="#h1-12" id="h1-12" class="h">@@ -456,7 +462,8 @@ processx(GdkXEvent *e, GdkEvent *event, gpointer d) {
</a> 			else {
 				XGetWindowProperty(dpy, ev-&gt;window, urlprop, 0L, BUFSIZ, False, XA_STRING,
 					&amp;adummy, &amp;idummy, &amp;ldummy, &amp;ldummy, &amp;buf);
<a href="#h1-12-3" id="h1-12-3" class="d">-				loaduri(c, (gchar *)buf);
</a><a href="#h1-12-4" id="h1-12-4" class="i">+				arg.v = buf;
</a><a href="#h1-12-5" id="h1-12-5" class="i">+				loaduri(c, &amp;arg);
</a> 				XFree(buf);
 			}
 			return GDK_FILTER_REMOVE;
<a href="#h1-13" id="h1-13" class="h">@@ -478,29 +485,48 @@ request(SoupSession *s, SoupMessage *m, Client *c) {
</a> }
 
 void
<a href="#h1-13-3" id="h1-13-3" class="i">+reload(Client *c, const Arg *arg) {
</a><a href="#h1-13-4" id="h1-13-4" class="i">+	gboolean nocache = *(gboolean *)arg;
</a><a href="#h1-13-5" id="h1-13-5" class="i">+	if(nocache)
</a><a href="#h1-13-6" id="h1-13-6" class="i">+		 webkit_web_view_reload_bypass_cache(c-&gt;view);
</a><a href="#h1-13-7" id="h1-13-7" class="i">+	else
</a><a href="#h1-13-8" id="h1-13-8" class="i">+		 webkit_web_view_reload(c-&gt;view);
</a><a href="#h1-13-9" id="h1-13-9" class="i">+}
</a><a href="#h1-13-10" id="h1-13-10" class="i">+
</a><a href="#h1-13-11" id="h1-13-11" class="i">+void
</a> setcookie(char *name, char *val, char *dom, char *path, long exp) {
 	printf(&quot;%s %s %s %s %li\n&quot;, name, val, dom, path, exp);
 }
 
 void
<a href="#h1-13-17" id="h1-13-17" class="d">-setup(void) {
</a><a href="#h1-13-18" id="h1-13-18" class="i">+setup() {
</a> 	dpy = GDK_DISPLAY();
 	session = webkit_get_default_session();
 	urlprop = XInternAtom(dpy, &quot;_SURF_URL&quot;, False);
 }
 
 void
<a href="#h1-13-25" id="h1-13-25" class="d">-showsearch(Client *c) {
</a><a href="#h1-13-26" id="h1-13-26" class="d">-	hideurl(c);
</a><a href="#h1-13-27" id="h1-13-27" class="i">+showsearch(Client *c, const Arg *arg) {
</a><a href="#h1-13-28" id="h1-13-28" class="i">+	hideurl(c, NULL);
</a> 	gtk_widget_show(c-&gt;searchbar);
 	gtk_widget_grab_focus(c-&gt;searchbar);
 }
 
 void
<a href="#h1-13-34" id="h1-13-34" class="d">-showurl(Client *c) {
</a><a href="#h1-13-35" id="h1-13-35" class="i">+searchtext(Client *c, const Arg *arg) {
</a><a href="#h1-13-36" id="h1-13-36" class="i">+	gboolean forward = *(gboolean *)arg;
</a><a href="#h1-13-37" id="h1-13-37" class="i">+	webkit_web_view_search_text(c-&gt;view,
</a><a href="#h1-13-38" id="h1-13-38" class="i">+			gtk_entry_get_text(GTK_ENTRY(c-&gt;searchbar)),
</a><a href="#h1-13-39" id="h1-13-39" class="i">+			FALSE,
</a><a href="#h1-13-40" id="h1-13-40" class="i">+			forward,
</a><a href="#h1-13-41" id="h1-13-41" class="i">+			TRUE);
</a><a href="#h1-13-42" id="h1-13-42" class="i">+}
</a><a href="#h1-13-43" id="h1-13-43" class="i">+
</a><a href="#h1-13-44" id="h1-13-44" class="i">+void
</a><a href="#h1-13-45" id="h1-13-45" class="i">+showurl(Client *c, const Arg *arg) {
</a> 	gchar *uri;
 
<a href="#h1-13-48" id="h1-13-48" class="d">-	hidesearch(c);
</a><a href="#h1-13-49" id="h1-13-49" class="i">+	hidesearch(c, NULL);
</a> 	uri = geturi(c);
 	gtk_entry_set_text(GTK_ENTRY(c-&gt;urlbar), uri);
 	gtk_widget_show(c-&gt;urlbar);
<a href="#h1-14" id="h1-14" class="h">@@ -508,7 +534,7 @@ showurl(Client *c) {
</a> }
 
 void
<a href="#h1-14-3" id="h1-14-3" class="d">-stop(Client *c) {
</a><a href="#h1-14-4" id="h1-14-4" class="i">+stop(Client *c, const Arg *arg) {
</a> 	if(c-&gt;download)
 		webkit_download_cancel(c-&gt;download);
 	else
<a href="#h1-15" id="h1-15" class="h">@@ -545,11 +571,22 @@ updatetitle(Client *c, const char *title) {
</a> 
 }
 
<a href="#h1-15-3" id="h1-15-3" class="i">+void
</a><a href="#h1-15-4" id="h1-15-4" class="i">+zoompage(Client *c, const Arg *arg) {
</a><a href="#h1-15-5" id="h1-15-5" class="i">+	if(*(float *)arg &lt; 0)		/* zoom out */
</a><a href="#h1-15-6" id="h1-15-6" class="i">+		webkit_web_view_zoom_out(c-&gt;view);
</a><a href="#h1-15-7" id="h1-15-7" class="i">+	else if(*(float *)arg == 0)	/* zoom in */
</a><a href="#h1-15-8" id="h1-15-8" class="i">+		webkit_web_view_zoom_in(c-&gt;view);
</a><a href="#h1-15-9" id="h1-15-9" class="i">+	else				/* absolute level */
</a><a href="#h1-15-10" id="h1-15-10" class="i">+		webkit_web_view_set_zoom_level(c-&gt;view, *(float *)arg);
</a><a href="#h1-15-11" id="h1-15-11" class="i">+}
</a><a href="#h1-15-12" id="h1-15-12" class="i">+
</a> int main(int argc, char *argv[]) {
 	SoupSession *s;
 	Client *c;
 	int o;
 	const gchar *home, *filename;
<a href="#h1-15-18" id="h1-15-18" class="i">+	Arg arg;
</a> 
 	gtk_init(NULL, NULL);
 	if (!g_thread_supported())
<a href="#h1-16" id="h1-16" class="h">@@ -572,10 +609,11 @@ int main(int argc, char *argv[]) {
</a> 		}
 	if(optind + 1 == argc) {
 		c = newclient();
<a href="#h1-16-3" id="h1-16-3" class="i">+		arg.v = argv[optind];
</a> 		if(strchr(&quot;./&quot;, argv[optind][0]) || strcmp(&quot;-&quot;, argv[optind]) == 0)
 			loadfile(c, argv[optind]);
 		else
<a href="#h1-16-7" id="h1-16-7" class="d">-			loaduri(c, argv[optind]);
</a><a href="#h1-16-8" id="h1-16-8" class="i">+			loaduri(c, &amp;arg);
</a> 
 	}
 	else if(optind != argc)
</pre>
</div>
</body>
</html>
