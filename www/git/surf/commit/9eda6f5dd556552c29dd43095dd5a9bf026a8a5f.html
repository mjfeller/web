<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Add a keybinding to show current TLS certificate - surf - surf browser, a WebKit based browser
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="surf Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>surf</h1><span class="desc">surf browser, a WebKit based browser
</span></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/9eda6f5dd556552c29dd43095dd5a9bf026a8a5f.html">9eda6f5dd556552c29dd43095dd5a9bf026a8a5f</a>
<b>parent</b> <a href="../commit/1dc3cd513a75570cc2fc33a86d4af565ecf9255e.html">1dc3cd513a75570cc2fc33a86d4af565ecf9255e</a>
<b>Author:</b> Quentin Rameau &lt;<a href="mailto:quinq@fifth.space">quinq@fifth.space</a>&gt;
<b>Date:</b>   Sat, 29 Apr 2017 14:56:02 +0200

Add a keybinding to show current TLS certificate

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">config.def.h</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">surf.1</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">surf.c</a></td><td> | </td><td class="num">41</td><td><span class="i">++++++++++++++++++++++++++++++++++++++</span><span class="d">---</span></td></tr>
</table></pre><pre>3 files changed, 42 insertions(+), 3 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config.def.h.html">config.def.h</a> b/<a href="../file/config.def.h.html">config.def.h</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -152,6 +152,7 @@ static Key keys[] = {
</a> 	{ MODKEY|GDK_SHIFT_MASK, GDK_KEY_n,      find,       { .i = -1 } },
 
 	{ MODKEY|GDK_SHIFT_MASK, GDK_KEY_p,      print,      { 0 } },
<a href="#h0-0-3" id="h0-0-3" class="i">+	{ MODKEY,                GDK_KEY_x,      showcert,   { 0 } },
</a> 
 	{ MODKEY|GDK_SHIFT_MASK, GDK_KEY_a,      togglecookiepolicy, { 0 } },
 	{ 0,                     GDK_KEY_F11,    togglefullscreen, { 0 } },
<b>diff --git a/<a id="h1" href="../file/surf.1.html">surf.1</a> b/<a href="../file/surf.1.html">surf.1</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -198,6 +198,9 @@ Copies current URI to primary selection.
</a> .B Ctrl\-o
 Show the sourcecode of the current page.
 .TP
<a href="#h1-0-3" id="h1-0-3" class="i">+.B Ctrl\-x
</a><a href="#h1-0-4" id="h1-0-4" class="i">+Display the current TLS certificate in a popup window.
</a><a href="#h1-0-5" id="h1-0-5" class="i">+.TP
</a> .B Ctrl\-Shift\-a
 Toggle through the the
 .I cookie policies.
<b>diff --git a/<a id="h2" href="../file/surf.c.html">surf.c</a> b/<a href="../file/surf.c.html">surf.c</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -5,6 +5,7 @@
</a> #include &lt;sys/file.h&gt;
 #include &lt;sys/types.h&gt;
 #include &lt;sys/wait.h&gt;
<a href="#h2-0-3" id="h2-0-3" class="i">+#include &lt;glib.h&gt;
</a> #include &lt;libgen.h&gt;
 #include &lt;limits.h&gt;
 #include &lt;pwd.h&gt;
<a href="#h2-1" id="h2-1" class="h">@@ -106,9 +107,10 @@ typedef struct Client {
</a> 	WebKitWebInspector *inspector;
 	WebKitFindController *finder;
 	WebKitHitTestResult *mousepos;
<a href="#h2-1-3" id="h2-1-3" class="i">+	GTlsCertificate *cert, *failedcert;
</a> 	GTlsCertificateFlags tlserr;
 	Window xid;
<a href="#h2-1-6" id="h2-1-6" class="d">-	int progress, fullscreen, https, insecure;
</a><a href="#h2-1-7" id="h2-1-7" class="i">+	int progress, fullscreen, https, insecure, errorpage;
</a> 	const char *title, *overtitle, *targeturi;
 	const char *needle;
 	struct Client *next;
<a href="#h2-2" id="h2-2" class="h">@@ -216,6 +218,7 @@ static void destroywin(GtkWidget* w, Client *c);
</a> static void pasteuri(GtkClipboard *clipboard, const char *text, gpointer d);
 static void reload(Client *c, const Arg *a);
 static void print(Client *c, const Arg *a);
<a href="#h2-2-3" id="h2-2-3" class="i">+static void showcert(Client *c, const Arg *a);
</a> static void clipboard(Client *c, const Arg *a);
 static void zoom(Client *c, const Arg *a);
 static void scroll(Client *c, const Arg *a);
<a href="#h2-3" id="h2-3" class="h">@@ -1294,7 +1297,9 @@ loadfailedtls(WebKitWebView *v, gchar *uri, GTlsCertificate *cert,
</a> 	GString *errmsg = g_string_new(NULL);
 	gchar *html, *pem;
 
<a href="#h2-3-3" id="h2-3-3" class="i">+	c-&gt;failedcert = g_object_ref(cert);
</a> 	c-&gt;tlserr = err;
<a href="#h2-3-5" id="h2-3-5" class="i">+	c-&gt;errorpage = 1;
</a> 
 	if (err &amp; G_TLS_CERTIFICATE_UNKNOWN_CA)
 		g_string_append(errmsg,
<a href="#h2-4" id="h2-4" class="h">@@ -1322,7 +1327,9 @@ loadfailedtls(WebKitWebView *v, gchar *uri, GTlsCertificate *cert,
</a> 
 	g_object_get(cert, &quot;certificate-pem&quot;, &amp;pem, NULL);
 	html = g_strdup_printf(&quot;&lt;p&gt;Could not validate TLS for “%s”&lt;br&gt;%s&lt;/p&gt;&quot;
<a href="#h2-4-3" id="h2-4-3" class="d">-	                       &quot;&lt;p&gt;&lt;pre&gt;%s&lt;/pre&gt;&lt;p&gt;&quot;, uri, errmsg-&gt;str, pem);
</a><a href="#h2-4-4" id="h2-4-4" class="i">+	                       &quot;&lt;p&gt;You can inspect the following certificate &quot;
</a><a href="#h2-4-5" id="h2-4-5" class="i">+	                       &quot;with Ctrl+Shift+x (default keybinding).&lt;/p&gt;&quot;
</a><a href="#h2-4-6" id="h2-4-6" class="i">+	                       &quot;&lt;p&gt;&lt;pre&gt;%s&lt;/pre&gt;&lt;/p&gt;&quot;, uri, errmsg-&gt;str, pem);
</a> 	g_free(pem);
 	g_string_free(errmsg, TRUE);
 
<a href="#h2-5" id="h2-5" class="h">@@ -1344,6 +1351,10 @@ loadchanged(WebKitWebView *v, WebKitLoadEvent e, Client *c)
</a> 		c-&gt;title = title;
 		c-&gt;https = c-&gt;insecure = 0;
 		seturiparameters(c, geturi(c));
<a href="#h2-5-3" id="h2-5-3" class="i">+		if (c-&gt;errorpage)
</a><a href="#h2-5-4" id="h2-5-4" class="i">+			c-&gt;errorpage = 0;
</a><a href="#h2-5-5" id="h2-5-5" class="i">+		else
</a><a href="#h2-5-6" id="h2-5-6" class="i">+			g_clear_object(&amp;c-&gt;failedcert);
</a> 		break;
 	case WEBKIT_LOAD_REDIRECTED:
 		setatom(c, AtomUri, title);
<a href="#h2-6" id="h2-6" class="h">@@ -1351,7 +1362,7 @@ loadchanged(WebKitWebView *v, WebKitLoadEvent e, Client *c)
</a> 		seturiparameters(c, geturi(c));
 		break;
 	case WEBKIT_LOAD_COMMITTED:
<a href="#h2-6-3" id="h2-6-3" class="d">-		c-&gt;https = webkit_web_view_get_tls_info(c-&gt;view, NULL,
</a><a href="#h2-6-4" id="h2-6-4" class="i">+		c-&gt;https = webkit_web_view_get_tls_info(c-&gt;view, &amp;c-&gt;cert,
</a> 		                                        &amp;c-&gt;tlserr);
 		break;
 	case WEBKIT_LOAD_FINISHED:
<a href="#h2-7" id="h2-7" class="h">@@ -1605,6 +1616,30 @@ print(Client *c, const Arg *a)
</a> }
 
 void
<a href="#h2-7-3" id="h2-7-3" class="i">+showcert(Client *c, const Arg *a)
</a><a href="#h2-7-4" id="h2-7-4" class="i">+{
</a><a href="#h2-7-5" id="h2-7-5" class="i">+	GTlsCertificate *cert = c-&gt;failedcert ? c-&gt;failedcert : c-&gt;cert;
</a><a href="#h2-7-6" id="h2-7-6" class="i">+	GcrCertificate *gcrt;
</a><a href="#h2-7-7" id="h2-7-7" class="i">+	GByteArray *crt;
</a><a href="#h2-7-8" id="h2-7-8" class="i">+	GtkWidget *win;
</a><a href="#h2-7-9" id="h2-7-9" class="i">+	GcrCertificateWidget *wcert;
</a><a href="#h2-7-10" id="h2-7-10" class="i">+
</a><a href="#h2-7-11" id="h2-7-11" class="i">+	if (!cert)
</a><a href="#h2-7-12" id="h2-7-12" class="i">+		return;
</a><a href="#h2-7-13" id="h2-7-13" class="i">+
</a><a href="#h2-7-14" id="h2-7-14" class="i">+	g_object_get(cert, &quot;certificate&quot;, &amp;crt, NULL);
</a><a href="#h2-7-15" id="h2-7-15" class="i">+	gcrt = gcr_simple_certificate_new(crt-&gt;data, crt-&gt;len);
</a><a href="#h2-7-16" id="h2-7-16" class="i">+	g_byte_array_unref(crt);
</a><a href="#h2-7-17" id="h2-7-17" class="i">+
</a><a href="#h2-7-18" id="h2-7-18" class="i">+	win = gtk_window_new(GTK_WINDOW_TOPLEVEL);
</a><a href="#h2-7-19" id="h2-7-19" class="i">+	wcert = gcr_certificate_widget_new(gcrt);
</a><a href="#h2-7-20" id="h2-7-20" class="i">+	g_object_unref(gcrt);
</a><a href="#h2-7-21" id="h2-7-21" class="i">+
</a><a href="#h2-7-22" id="h2-7-22" class="i">+	gtk_container_add(GTK_CONTAINER(win), GTK_WIDGET(wcert));
</a><a href="#h2-7-23" id="h2-7-23" class="i">+	gtk_widget_show_all(win);
</a><a href="#h2-7-24" id="h2-7-24" class="i">+}
</a><a href="#h2-7-25" id="h2-7-25" class="i">+
</a><a href="#h2-7-26" id="h2-7-26" class="i">+void
</a> clipboard(Client *c, const Arg *a)
 {
 	if (a-&gt;b) { /* load clipboard uri */
</pre>
</div>
</body>
</html>
